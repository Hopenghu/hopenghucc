var __defProp = Object.defineProperty;
var __getOwnPropNames = Object.getOwnPropertyNames;
var __esm = (fn, res) => function __init() {
  return fn && (res = (0, fn[__getOwnPropNames(fn)[0]])(fn = 0)), res;
};
var __export = (target, all) => {
  for (var name in all)
    __defProp(target, name, { get: all[name], enumerable: true });
};

// src/utils/password.js
function bufferToHex(buffer) {
  return Array.from(new Uint8Array(buffer)).map((b) => b.toString(16).padStart(2, "0")).join("");
}
function hexToBuffer(hexString) {
  const bytes = new Uint8Array(hexString.length / 2);
  for (let i = 0; i < hexString.length; i += 2) {
    bytes[i / 2] = parseInt(hexString.substr(i, 2), 16);
  }
  return bytes.buffer;
}
async function hashPassword(password) {
  try {
    const salt = crypto.getRandomValues(new Uint8Array(SALT_LENGTH_BYTES));
    const passwordKey = await crypto.subtle.importKey(
      "raw",
      new TextEncoder().encode(password),
      // Convert password string to ArrayBuffer
      { name: HASH_ALGORITHM },
      false,
      // not extractable
      ["deriveBits"]
      // usage
    );
    const derivedBits = await crypto.subtle.deriveBits(
      {
        name: HASH_ALGORITHM,
        salt,
        iterations: ITERATIONS,
        hash: HASH_FUNCTION
      },
      passwordKey,
      KEY_LENGTH_BITS
      // Key length in bits
    );
    const saltHex = bufferToHex(salt);
    const hashHex = bufferToHex(derivedBits);
    return `${STORED_HASH_FORMAT}$${ITERATIONS}$${saltHex}$${hashHex}`;
  } catch (error) {
    console.error("Error hashing password:", error);
    throw new Error("Could not hash password.");
  }
}
async function verifyPassword(password, storedHashString) {
  try {
    const parts = storedHashString.split("$");
    if (parts.length !== 4) {
      console.error("Invalid stored hash format.");
      return false;
    }
    const [format, iterationsStr, saltHex, storedHashHex] = parts;
    if (!format.startsWith("pbkdf2-")) {
      console.error("Unsupported hash format.");
      return false;
    }
    const iterations = parseInt(iterationsStr, 10);
    const salt = hexToBuffer(saltHex);
    const storedHashBuffer = hexToBuffer(storedHashHex);
    const passwordKey = await crypto.subtle.importKey(
      "raw",
      new TextEncoder().encode(password),
      { name: HASH_ALGORITHM },
      false,
      ["deriveBits"]
    );
    const derivedBits = await crypto.subtle.deriveBits(
      {
        name: HASH_ALGORITHM,
        salt,
        iterations,
        // Ensure HASH_FUNCTION matches the one indicated by the format string if needed
        hash: HASH_FUNCTION
      },
      passwordKey,
      KEY_LENGTH_BITS
    );
    if (derivedBits.byteLength !== storedHashBuffer.byteLength) {
      return false;
    }
    const derivedArray = new Uint8Array(derivedBits);
    const storedArray = new Uint8Array(storedHashBuffer);
    let diff = 0;
    for (let i = 0; i < derivedArray.length; i++) {
      diff |= derivedArray[i] ^ storedArray[i];
    }
    return diff === 0;
  } catch (error) {
    console.error("Error verifying password:", error);
    return false;
  }
}
var HASH_ALGORITHM, HASH_FUNCTION, ITERATIONS, SALT_LENGTH_BYTES, KEY_LENGTH_BITS, STORED_HASH_FORMAT;
var init_password = __esm({
  "src/utils/password.js"() {
    "use strict";
    HASH_ALGORITHM = "PBKDF2";
    HASH_FUNCTION = "SHA-256";
    ITERATIONS = 1e5;
    SALT_LENGTH_BYTES = 16;
    KEY_LENGTH_BITS = 256;
    STORED_HASH_FORMAT = `pbkdf2-${HASH_FUNCTION.toLowerCase()}`;
  }
});

// src/services/AuthService.js
var AuthService_exports = {};
__export(AuthService_exports, {
  AuthService: () => AuthService
});
var AuthService;
var init_AuthService = __esm({
  "src/services/AuthService.js"() {
    "use strict";
    init_password();
    AuthService = class {
      constructor(userService, sessionService, googleAuthService) {
        if (!userService || !sessionService || !googleAuthService) {
          throw new Error("UserService, SessionService, and GoogleAuthService are required.");
        }
        this.userService = userService;
        this.sessionService = sessionService;
        this.googleAuthService = googleAuthService;
      }
      /**
       * Registers a new user with email and password.
       * @param {object} credentials - { email, password, name }
       * @returns {Promise<object>} Newly created user object (essential info).
       */
      async registerWithPassword({ email, password, name }) {
        try {
          if (!email || !password || !name) {
            throw new Error("Email, password, and name are required for registration.");
          }
          const user = await this.userService.createUserWithPassword(email, password, name);
          return user;
        } catch (error) {
          console.error("AuthService - registerWithPassword error:", error);
          throw error;
        }
      }
      /**
       * Logs in a user with email and password.
       * @param {object} credentials - { email, password }
       * @returns {Promise<{user: object, session: object}>} User and session objects.
       */
      async loginWithPassword({ email, password }) {
        try {
          if (!email || !password) {
            throw new Error("Email and password are required for login.");
          }
          const user = await this.userService.findUserByEmail(email);
          if (!user || !user.password_hash) {
            throw new Error("Invalid email or password.");
          }
          const isValid = await verifyPassword(password, user.password_hash);
          if (!isValid) {
            throw new Error("Invalid email or password.");
          }
          const session = await this.sessionService.createSession(user.id);
          return {
            session,
            user: {
              id: user.id,
              email: user.email,
              name: user.name,
              avatar_url: user.avatar_url
            }
          };
        } catch (error) {
          console.error("AuthService - loginWithPassword error:", error);
          throw error;
        }
      }
      /**
       * Handles the Google Sign-In callback.
       * @param {string} code - The authorization code from Google.
       * @returns {Promise<{user: object, session: object}>} User and session objects.
       */
      async handleGoogleLogin(code) {
        try {
          if (!code) {
            throw new Error("Google authorization code is required.");
          }
          const { userData: googleUserData, accessToken } = await this.googleAuthService.authenticate(code);
          if (accessToken) {
            console.log("[AuthService] Received Access Token (Log first 10 chars): ", accessToken.substring(0, 10));
          } else {
            console.warn("[AuthService] Access Token not received after authentication.");
          }
          if (!googleUserData || !googleUserData.sub || !googleUserData.email) {
            throw new Error("Failed to retrieve valid user data from Google.");
          }
          const user = await this.userService.findOrCreateUserByGoogleId(
            googleUserData.sub,
            googleUserData.email,
            googleUserData.name,
            googleUserData.picture
          );
          console.log(`[AuthService.handleGoogleLogin] Attempting to create session for user ID: ${user.id}, email: ${user.email}`);
          const session = await this.sessionService.createSession(user.id);
          console.log(`[AuthService.handleGoogleLogin] Session creation result:`, session);
          if (!session || !session.id) {
            console.error(`[AuthService.handleGoogleLogin] CRITICAL: Session creation failed or returned invalid session object for user ID: ${user.id}`);
            throw new Error("Session creation failed internally.");
          }
          return {
            session,
            user: {
              id: user.id,
              email: user.email,
              name: user.name,
              avatar_url: user.avatar_url
              // hasGoogleBusiness: hasBusinessAccess // Example: Add flag if needed
            }
          };
        } catch (error) {
          console.error("AuthService - handleGoogleLogin error:", error);
          throw new Error("Google Sign-In failed. Please try again.");
        }
      }
      /**
       * Logs out a user by deleting their session.
       * @param {string} sessionId - The ID of the session to delete.
       * @returns {Promise<void>}
       */
      async logout(sessionId) {
        try {
          if (!sessionId) {
            console.warn("Logout called without session ID.");
            return;
          }
          await this.sessionService.deleteSession(sessionId);
        } catch (error) {
          console.error("AuthService - logout error:", error);
          throw new Error("Logout failed.");
        }
      }
      /**
       * Retrieves the authenticated user based on a session ID.
       * @param {string} sessionId - The session ID from the client (e.g., cookie).
       * @returns {Promise<object | null>} The user object (non-sensitive data) or null.
       */
      async getUserFromSession(sessionId) {
        console.log("[AuthService.getUserFromSession] Received sessionId:", sessionId);
        try {
          if (!sessionId) {
            console.log("[AuthService.getUserFromSession] No sessionId provided, returning null.");
            return null;
          }
          const session = await this.sessionService.getSession(sessionId);
          console.log("[AuthService.getUserFromSession] Session from sessionService:", session);
          if (!session) {
            console.log("[AuthService.getUserFromSession] Session not found or expired, returning null.");
            return null;
          }
          const userFromDb = await this.userService.findUserById(session.userId);
          console.log("[AuthService.getUserFromSession] User from userService.findUserById:", userFromDb);
          if (!userFromDb) {
            console.log("[AuthService.getUserFromSession] User not found by ID from session, returning null.");
            return null;
          }
          const userToReturn = {
            id: userFromDb.id,
            email: userFromDb.email,
            name: userFromDb.name,
            avatar_url: userFromDb.avatar_url,
            role: userFromDb.role
          };
          console.log("[AuthService.getUserFromSession] Returning user object:", userToReturn);
          return userToReturn;
        } catch (error) {
          console.error("[AuthService.getUserFromSession] Error:", error);
          return null;
        }
      }
      // Potentially add methods like requestPasswordReset, verifyResetToken, etc. here
    };
  }
});

// src/services/UserService.js
var UserService_exports = {};
__export(UserService_exports, {
  UserService: () => UserService
});
var UserService;
var init_UserService = __esm({
  "src/services/UserService.js"() {
    "use strict";
    init_password();
    UserService = class {
      constructor(db) {
        if (!db) {
          throw new Error("Database connection is required for UserService.");
        }
        this.db = db;
      }
      async findUserById(userId) {
        try {
          const user = await this.db.prepare(
            "SELECT id, email, name, avatar_url, google_id, created_at, role, lastLogin FROM users WHERE id = ?"
          ).bind(userId).first();
          console.log("[UserService.findUserById] User object from DB for ID " + userId + ":", user);
          return user || null;
        } catch (error) {
          console.error(`Error finding user by ID ${userId}:`, error);
          throw new Error("Could not retrieve user data.");
        }
      }
      async findUserByEmail(email) {
        try {
          const user = await this.db.prepare(
            "SELECT id, email, name, avatar_url, google_id, role, created_at, lastLogin FROM users WHERE email = ?"
          ).bind(email).first();
          return user || null;
        } catch (error) {
          console.error(`Error finding user by email ${email}:`, error);
          throw new Error("Could not retrieve user data by email.");
        }
      }
      async findUserByGoogleId(googleId) {
        try {
          const user = await this.db.prepare(
            "SELECT id, email, name, avatar_url, google_id, role, created_at, lastLogin FROM users WHERE google_id = ?"
          ).bind(googleId).first();
          return user || null;
        } catch (error) {
          console.error(`Error finding user by Google ID ${googleId}:`, error);
          throw new Error("Could not retrieve user data by Google ID.");
        }
      }
      async createUserWithPassword(email, password, name) {
        try {
          const existingUser = await this.findUserByEmail(email);
          if (existingUser) {
            throw new Error("User already exists with this email");
          }
          const hashedPassword = await hashPassword(password);
          const result = await this.db.prepare(
            'INSERT INTO users (email, password_hash, name, created_at) VALUES (?, ?, ?, datetime("now"))'
          ).bind(email, hashedPassword, name).run();
          if (!result.meta.last_row_id) {
            throw new Error("Failed to insert user into database");
          }
          return {
            id: result.meta.last_row_id,
            email,
            name
          };
        } catch (error) {
          console.error("Error creating user with password:", error);
          throw error instanceof Error ? error : new Error("Could not create user.");
        }
      }
      async findOrCreateUserByGoogleId(googleId, email, name, avatarUrl = null) {
        try {
          let user = await this.findUserByGoogleId(googleId);
          if (!user) {
            const existingEmailUser = await this.findUserByEmail(email);
            if (existingEmailUser) {
              await this.linkGoogleIdToUser(existingEmailUser.id, googleId);
              await this.db.prepare('UPDATE users SET lastLogin = datetime("now"), updated_at = datetime("now") WHERE id = ?').bind(existingEmailUser.id).run();
              user = await this.findUserById(existingEmailUser.id);
              if (!user)
                throw new Error("Failed to fetch user after linking Google ID.");
            } else {
              console.log(`[UserService.findOrCreateUserByGoogleId] Creating new user. Email: ${email}, Name: ${name}, GoogleID: ${googleId}, Avatar: ${avatarUrl}`);
              const insertStatement = this.db.prepare(
                `INSERT INTO users (email, name, google_id, avatar_url, created_at, updated_at, lastLogin, role) VALUES (?, ?, ?, ?, datetime("now"), datetime("now"), datetime("now"), 'user')`
                // Set role to 'user' for new users
              );
              const insertResult = await insertStatement.bind(email, name, googleId, avatarUrl).run();
              console.log("[UserService.findOrCreateUserByGoogleId] Insert result:", JSON.stringify(insertResult));
              if (!insertResult || !insertResult.meta || insertResult.meta.last_row_id === void 0 || insertResult.meta.last_row_id === null || insertResult.meta.changes !== void 0 && insertResult.meta.changes === 0) {
                console.error("[UserService.findOrCreateUserByGoogleId] Insert appears to have failed or not made changes. Result:", JSON.stringify(insertResult));
                throw new Error("Failed to create new user via Google Sign-In (insert meta indicates failure).");
              }
              const newUserId = insertResult.meta.last_row_id;
              console.log(`[UserService.findOrCreateUserByGoogleId] New user inserted with ID: ${newUserId}. Constructing user object directly.`);
              user = {
                id: newUserId,
                email,
                name,
                avatar_url: avatarUrl,
                google_id: googleId,
                created_at: (/* @__PURE__ */ new Date()).toISOString(),
                // Approximate current time
                updated_at: (/* @__PURE__ */ new Date()).toISOString(),
                // Approximate current time
                lastLogin: (/* @__PURE__ */ new Date()).toISOString(),
                // Approximate current time
                role: "user"
                // New users get 'user' role by default
              };
              console.log(`[UserService.findOrCreateUserByGoogleId] Successfully constructed new user object for ID: ${newUserId}`, JSON.stringify(user));
            }
          }
          return user;
        } catch (error) {
          console.error("Error in findOrCreateUserByGoogleId:", error);
          throw new Error("Could not find or create user via Google Sign-In.");
        }
      }
      async linkGoogleIdToUser(userId, googleId) {
        try {
          await this.db.prepare(
            "UPDATE users SET google_id = ? WHERE id = ?"
          ).bind(googleId, userId).run();
        } catch (error) {
          console.error(`Error linking Google ID ${googleId} to user ${userId}:`, error);
          throw new Error("Could not link Google account.");
        }
      }
      // Example for profile updates if needed later
      async updateUserProfile(userId, { name, avatarUrl }) {
      }
    };
  }
});

// src/services/SessionService.js
var SessionService_exports = {};
__export(SessionService_exports, {
  SessionService: () => SessionService
});
var SessionService;
var init_SessionService = __esm({
  "src/services/SessionService.js"() {
    "use strict";
    SessionService = class {
      constructor(db) {
        if (!db) {
          throw new Error("Database connection is required for SessionService.");
        }
        this.db = db;
      }
      /**
       * Creates a new session for a user.
       * @param {number} userId - The ID of the user.
       * @param {number} durationSeconds - Session duration in seconds (default: 7 days).
       * @returns {Promise<{id: string, userId: number, expiresAt: string}>} The created session object.
       */
      async createSession(userId, durationSeconds = 60 * 60 * 24 * 7) {
        console.log(`[SessionService.createSession] Attempting to create session for userId: ${userId}`);
        try {
          const randomBytes2 = new Uint8Array(32);
          crypto.getRandomValues(randomBytes2);
          const sessionId = Array.from(randomBytes2).map((b) => b.toString(16).padStart(2, "0")).join("");
          const expiresAt = new Date(Date.now() + durationSeconds * 1e3);
          const result = await this.db.prepare(
            'INSERT INTO sessions (id, user_id, expires_at, created_at) VALUES (?, ?, ?, datetime("now"))'
          ).bind(sessionId, userId, expiresAt.toISOString()).run();
          if (result.meta.changes !== 1) {
            console.error(`[SessionService.createSession] Failed to insert session for userId: ${userId}. DB meta:`, result.meta);
            throw new Error("Failed to create session in database");
          }
          const createdSession = {
            id: sessionId,
            userId,
            expiresAt: expiresAt.toISOString()
          };
          console.log(`[SessionService.createSession] Successfully created session for userId ${userId}:`, createdSession);
          return createdSession;
        } catch (error) {
          console.error(`[SessionService.createSession] Error creating session for userId ${userId}:`, error);
          throw new Error("Could not create session");
        }
      }
      /**
       * Deletes a session by its ID.
       * @param {string} sessionId - The ID of the session to delete.
       * @returns {Promise<void>}
       */
      async deleteSession(sessionId) {
        try {
          await this.db.prepare(
            "DELETE FROM sessions WHERE id = ?"
          ).bind(sessionId).run();
        } catch (error) {
          console.error("Error deleting session:", error);
          throw new Error("Could not delete session");
        }
      }
      /**
       * Retrieves a session by its ID, ensuring it hasn't expired.
       * @param {string} sessionId - The ID of the session to retrieve.
       * @returns {Promise<{id: string, userId: number, expiresAt: string} | null>} The session object or null if not found or expired.
       */
      async getSession(sessionId) {
        console.log(`[SessionService.getSession] Attempting to get session for sessionId: ${sessionId}`);
        try {
          const session = await this.db.prepare(
            'SELECT id, user_id, expires_at FROM sessions WHERE id = ? AND expires_at > datetime("now")'
          ).bind(sessionId).first();
          if (!session) {
            console.log(`[SessionService.getSession] Session not found or expired for sessionId: ${sessionId}`);
            return null;
          }
          const sessionToReturn = {
            id: session.id,
            userId: session.user_id,
            expiresAt: session.expires_at
          };
          console.log(`[SessionService.getSession] Found session for sessionId ${sessionId}:`, sessionToReturn);
          return sessionToReturn;
        } catch (error) {
          console.error(`[SessionService.getSession] Error getting session for sessionId ${sessionId}:`, error);
          throw new Error("Could not retrieve session");
        }
      }
      async getUserFromSession(request) {
        console.log("SessionService - getUserFromSession - Attempting...");
        const session = await this.getSession(request);
        if (!session || !session.userId) {
          console.log("SessionService - getUserFromSession - No valid session or userId found");
          return null;
        }
        console.log(`SessionService - getUserFromSession - Found session for user ID: ${session.userId}`);
        try {
          const userData = await this.env.DB.prepare(
            "SELECT id, email, name, avatar_url FROM users WHERE id = ?"
          ).bind(session.userId).first();
          console.log("SessionService - getUserFromSession - User DB Result:", userData);
          return userData;
        } catch (error) {
          console.error("SessionService - getUserFromSession - User DB Error:", error);
          return null;
        }
      }
    };
  }
});

// src/services/GoogleAuthService.js
var GoogleAuthService_exports = {};
__export(GoogleAuthService_exports, {
  GoogleAuthService: () => GoogleAuthService
});
var GoogleAuthService;
var init_GoogleAuthService = __esm({
  "src/services/GoogleAuthService.js"() {
    "use strict";
    GoogleAuthService = class {
      constructor(env) {
        if (!env || !env.GOOGLE_CLIENT_ID || !env.GOOGLE_CLIENT_SECRET || !env.GOOGLE_REDIRECT_URI) {
          console.warn("Google OAuth environment variables not fully configured. Google authentication will be disabled.");
          this.enabled = false;
          return;
        }
        this.clientId = env.GOOGLE_CLIENT_ID;
        this.clientSecret = env.GOOGLE_CLIENT_SECRET;
        this.redirectUri = env.GOOGLE_REDIRECT_URI;
        this.enabled = true;
      }
      async exchangeCodeForToken(code) {
        if (!this.enabled) {
          throw new Error("Google authentication is disabled due to missing environment variables.");
        }
        try {
          const requestBody = new URLSearchParams({
            code,
            client_id: this.clientId,
            client_secret: this.clientSecret,
            redirect_uri: this.redirectUri,
            grant_type: "authorization_code"
          });
          console.log(`[GoogleAuthService] Exchanging code. Sending params (excluding secret): code=${code}, client_id=${this.clientId}, redirect_uri=${this.redirectUri}, grant_type=authorization_code`);
          const tokenResponse = await fetch("https://oauth2.googleapis.com/token", {
            method: "POST",
            headers: {
              "Content-Type": "application/x-www-form-urlencoded"
            },
            body: requestBody
          });
          if (!tokenResponse.ok) {
            let errorBodyText = "[Could not read error body]";
            try {
              errorBodyText = await tokenResponse.text();
            } catch (readError) {
              console.error("[GoogleAuthService] Failed to read error response body:", readError);
            }
            console.error(`[GoogleAuthService] Token exchange failed! Status: ${tokenResponse.status}, Response Body: ${errorBodyText}`);
            throw new Error(`Failed to exchange code for token. Status: ${tokenResponse.status}`);
          }
          return await tokenResponse.json();
        } catch (error) {
          console.error("Error exchanging Google code for token:", error);
          throw new Error("Could not exchange authorization code for token.");
        }
      }
      async verifyGoogleToken(idToken) {
        if (!this.enabled) {
          throw new Error("Google authentication is disabled due to missing environment variables.");
        }
        try {
          const response = await fetch(
            `https://oauth2.googleapis.com/tokeninfo?id_token=${idToken}`
          );
          if (!response.ok) {
            const errorBody = await response.text();
            console.error("Failed to verify Google ID token:", response.status, errorBody);
            throw new Error(`Failed to verify Google ID token. Status: ${response.status}`);
          }
          const tokenInfo = await response.json();
          if (tokenInfo.aud !== this.clientId) {
            console.error("Token audience mismatch:", tokenInfo.aud, "expected:", this.clientId);
            throw new Error("Invalid token: Audience mismatch.");
          }
          return tokenInfo;
        } catch (error) {
          console.error("Error verifying Google ID token:", error);
          throw new Error("Could not verify Google ID token.");
        }
      }
      /**
       * Authenticates a user using the Google authorization code.
       * Exchanges the code for tokens and verifies the ID token.
       * @param {string} code - The authorization code from Google callback.
       * @returns {Promise<{userData: object, accessToken: string}>} Object containing verified Google user data and the access token.
       */
      async authenticate(code) {
        if (!this.enabled) {
          throw new Error("Google authentication is disabled due to missing environment variables.");
        }
        try {
          const tokens = await this.exchangeCodeForToken(code);
          if (!tokens.id_token) {
            throw new Error("ID token not found in Google response.");
          }
          if (!tokens.access_token) {
            throw new Error("Access token not found in Google response.");
          }
          const verifiedUserData = await this.verifyGoogleToken(tokens.id_token);
          return {
            userData: verifiedUserData,
            accessToken: tokens.access_token
          };
        } catch (error) {
          console.error("Google authentication failed:", error);
          throw error instanceof Error ? error : new Error("Google authentication process failed.");
        }
      }
    };
  }
});

// src/services/ImageCacheService.js
var ImageCacheService_exports = {};
__export(ImageCacheService_exports, {
  ImageCacheService: () => ImageCacheService
});
var ImageCacheService;
var init_ImageCacheService = __esm({
  "src/services/ImageCacheService.js"() {
    "use strict";
    ImageCacheService = class {
      constructor(db) {
        this.db = db;
        this.cacheExpiryDays = 30;
      }
      /**
       * 檢查圖片URL是否為Google Places API URL
       * @param {string} url 
       * @returns {boolean}
       */
      isGooglePlacesImageUrl(url) {
        return url && url.includes("maps.googleapis.com/maps/api/place/photo");
      }
      /**
       * 從Google Places API URL中提取photoreference
       * @param {string} url 
       * @returns {string|null}
       */
      extractPhotoReference(url) {
        if (!this.isGooglePlacesImageUrl(url))
          return null;
        const match2 = url.match(/photoreference=([^&]+)/);
        return match2 ? match2[1] : null;
      }
      /**
       * 生成緩存鍵
       * @param {string} photoReference 
       * @returns {string}
       */
      generateCacheKey(photoReference) {
        return `photo_${photoReference}`;
      }
      /**
       * 檢查圖片是否已緩存且未過期
       * @param {string} originalUrl 
       * @returns {Promise<string|null>} 返回緩存的URL或null
       */
      async getCachedImageUrl(originalUrl) {
        if (!originalUrl)
          return null;
        if (!this.isGooglePlacesImageUrl(originalUrl)) {
          return originalUrl;
        }
        const photoReference = this.extractPhotoReference(originalUrl);
        if (!photoReference)
          return originalUrl;
        try {
          const cacheKey = this.generateCacheKey(photoReference);
          const stmt = this.db.prepare(`
                SELECT cached_url, created_at 
                FROM image_cache 
                WHERE cache_key = ? AND created_at > datetime('now', '-${this.cacheExpiryDays} days')
            `);
          const result = await stmt.bind(cacheKey).first();
          if (result && result.cached_url) {
            console.log(`[ImageCacheService] Found cached image for ${photoReference}`);
            return result.cached_url;
          }
        } catch (error) {
          console.error("[ImageCacheService] Error checking cache:", error);
        }
        return null;
      }
      /**
       * 智能處理圖片URL，包括過期URL的處理
       * @param {string} imageUrl 
       * @param {string} googlePlaceId 
       * @returns {Promise<string>} 處理後的圖片URL
       */
      async processImageUrl(imageUrl, googlePlaceId = null) {
        if (!imageUrl) {
          return this.getDefaultImageUrl();
        }
        if (this.isGooglePlacesImageUrl(imageUrl)) {
          const cachedUrl = await this.getCachedImageUrl(imageUrl);
          if (cachedUrl && cachedUrl !== imageUrl) {
            return cachedUrl;
          }
          if (googlePlaceId) {
            console.log(`[ImageCacheService] Attempting to refresh image for place ${googlePlaceId}`);
            return await this.refreshImageForPlace(googlePlaceId);
          }
          console.log(`[ImageCacheService] Using default image for expired Google Places URL`);
          return this.getDefaultImageUrl();
        }
        return imageUrl;
      }
      /**
       * 為指定地點重新獲取圖片
       * @param {string} googlePlaceId 
       * @returns {Promise<string>} 新的圖片URL或默認圖片
       */
      async refreshImageForPlace(googlePlaceId) {
        try {
          console.log(`[ImageCacheService] Would refresh image for place ${googlePlaceId}`);
          return this.getDefaultImageUrl();
        } catch (error) {
          console.error(`[ImageCacheService] Error refreshing image for place ${googlePlaceId}:`, error);
          return this.getDefaultImageUrl();
        }
      }
      /**
       * 獲取默認圖片URL
       * @returns {string}
       */
      getDefaultImageUrl() {
        return "https://placehold.co/400x268/6B7280/FFFFFF?text=Location+Image";
      }
      /**
       * 批量處理地點的圖片URL
       * @param {Array<object>} locations 
       * @returns {Promise<Array<object>>} 處理後的地點列表
       */
      async processLocationsImages(locations) {
        if (!locations || !Array.isArray(locations)) {
          return [];
        }
        const processedLocations = [];
        for (const location of locations) {
          const processedLocation = { ...location };
          if (location.thumbnail_url && this.isGooglePlacesImageUrl(location.thumbnail_url)) {
            processedLocation.thumbnail_url = `/api/image/proxy/?url=${encodeURIComponent(location.thumbnail_url)}`;
            console.log(`[ImageCacheService] Converted Google Places URL to proxy for location ${location.id}`);
          } else if (location.thumbnail_url && !this.isGooglePlacesImageUrl(location.thumbnail_url)) {
            processedLocation.thumbnail_url = location.thumbnail_url;
          } else {
            processedLocation.thumbnail_url = this.getDefaultImageUrl();
          }
          processedLocations.push(processedLocation);
        }
        return processedLocations;
      }
      /**
       * 為指定地點獲取緩存的圖片
       * @param {string} googlePlaceId 
       * @returns {Promise<string|null>} 緩存的圖片URL或null
       */
      async getCachedImageForPlace(googlePlaceId) {
        try {
          const stmtLoc = this.db.prepare("SELECT thumbnail_url FROM locations WHERE google_place_id = ?");
          const loc = await stmtLoc.bind(googlePlaceId).first();
          if (!loc || !loc.thumbnail_url)
            return null;
          const photoReference = this.extractPhotoReference(loc.thumbnail_url);
          if (!photoReference)
            return null;
          const cacheKey = this.generateCacheKey(photoReference);
          const stmt = this.db.prepare(`
                SELECT cached_url FROM image_cache
                WHERE cache_key = ? AND created_at > datetime('now', '-${this.cacheExpiryDays} days')
                ORDER BY created_at DESC LIMIT 1
            `);
          const result = await stmt.bind(cacheKey).first();
          return (result == null ? void 0 : result.cached_url) || null;
        } catch (error) {
          console.error(`[ImageCacheService] Error getting cached image for place ${googlePlaceId}:`, error);
          return null;
        }
      }
      /**
       * 緩存圖片URL
       * @param {string} originalUrl 
       * @param {string} cachedUrl 
       * @returns {Promise<void>}
       */
      async cacheImageUrl(originalUrl, cachedUrl) {
        if (!this.isGooglePlacesImageUrl(originalUrl))
          return;
        const photoReference = this.extractPhotoReference(originalUrl);
        if (!photoReference)
          return;
        try {
          const cacheKey = this.generateCacheKey(photoReference);
          const stmt = this.db.prepare(`
                INSERT OR REPLACE INTO image_cache (cache_key, original_url, cached_url, created_at)
                VALUES (?, ?, ?, datetime('now'))
            `);
          await stmt.bind(cacheKey, originalUrl, cachedUrl).run();
          console.log(`[ImageCacheService] Cached image for ${photoReference}`);
        } catch (error) {
          console.error("[ImageCacheService] Error caching image:", error);
        }
      }
      /**
       * 清理過期的緩存
       * @returns {Promise<number>} 返回清理的記錄數
       */
      async cleanupExpiredCache() {
        try {
          const stmt = this.db.prepare(`
                DELETE FROM image_cache 
                WHERE created_at < datetime('now', '-${this.cacheExpiryDays} days')
            `);
          const result = await stmt.run();
          console.log(`[ImageCacheService] Cleaned up ${result.changes} expired cache entries`);
          return result.changes;
        } catch (error) {
          console.error("[ImageCacheService] Error cleaning up cache:", error);
          return 0;
        }
      }
      /**
       * 獲取圖片統計信息
       * @returns {Promise<object>}
       */
      async getCacheStats() {
        try {
          const totalStmt = this.db.prepare("SELECT COUNT(*) as total FROM image_cache");
          const expiredStmt = this.db.prepare(`
                SELECT COUNT(*) as expired 
                FROM image_cache 
                WHERE created_at < datetime('now', '-${this.cacheExpiryDays} days')
            `);
          const totalResult = await totalStmt.first();
          const expiredResult = await expiredStmt.first();
          return {
            total: (totalResult == null ? void 0 : totalResult.total) || 0,
            expired: (expiredResult == null ? void 0 : expiredResult.expired) || 0,
            valid: ((totalResult == null ? void 0 : totalResult.total) || 0) - ((expiredResult == null ? void 0 : expiredResult.expired) || 0)
          };
        } catch (error) {
          console.error("[ImageCacheService] Error getting cache stats:", error);
          return { total: 0, expired: 0, valid: 0 };
        }
      }
    };
  }
});

// src/services/LocationService.js
var LocationService_exports = {};
__export(LocationService_exports, {
  LocationService: () => LocationService
});
var LocationService;
var init_LocationService = __esm({
  "src/services/LocationService.js"() {
    "use strict";
    init_ImageCacheService();
    LocationService = class {
      constructor(db, mapsApiKey = null) {
        console.log("[LocationService CONSTRUCTOR V20240726_0900_FIX] Initializing with DB:", !!db, "and API Key:", !!mapsApiKey);
        if (!db) {
          throw new Error("Database connection (db) is required for LocationService.");
        }
        this.db = db;
        this.apiKey = mapsApiKey;
        this.googleApiBaseUrl = "https://maps.googleapis.com/maps/api";
        this.imageCacheService = new ImageCacheService(db);
        console.log("[LocationService CONSTRUCTOR] Initialized successfully with ImageCacheService.");
      }
      /**
       * Fetches place details from Google Places API.
       * @param {string} googlePlaceId - The Google Place ID.
       * @returns {Promise<object|null>} Standardized location object or null if not found/error.
       */
      async fetchPlaceDetails(googlePlaceId) {
        console.log("[LocationService fetchPlaceDetails] Method called with googlePlaceId:", googlePlaceId);
        if (!googlePlaceId) {
          console.error("[LocationService] fetchPlaceDetails called without googlePlaceId.");
          return null;
        }
        if (!this.apiKey) {
          console.error("[LocationService] fetchPlaceDetails called without API key.");
          return null;
        }
        console.log(`[LocationService] Fetching Google Place details for placeId: ${googlePlaceId}`);
        const fields = "place_id,name,formatted_address,geometry/location,types,website,international_phone_number,business_status,rating,user_ratings_total,photos,editorial_summary";
        const url = `${this.googleApiBaseUrl}/place/details/json?place_id=${encodeURIComponent(googlePlaceId)}&fields=${encodeURIComponent(fields)}&language=zh-TW&key=${this.apiKey}`;
        try {
          const response = await fetch(url);
          const data = await response.json();
          if (!response.ok || data.status !== "OK") {
            console.error(`[LocationService] Google Places API error for placeId ${googlePlaceId}. Status: ${data.status}, Error: ${data.error_message || "Unknown error"}`);
            return null;
          }
          const result = data.result;
          if (!result || !result.geometry || !result.geometry.location) {
            console.error(`[LocationService] Google Places API response missing essential data for placeId ${googlePlaceId}.`);
            return null;
          }
          let photoUrls = [];
          if (result.photos && result.photos.length > 0) {
            for (const photo of result.photos.slice(0, 3)) {
              const originalUrl = `${this.googleApiBaseUrl}/place/photo?maxwidth=400&photoreference=${photo.photo_reference}&key=${this.apiKey}`;
              const cachedUrl = await this.imageCacheService.getCachedImageUrl(originalUrl);
              if (cachedUrl) {
                photoUrls.push(cachedUrl);
              } else {
                photoUrls.push(originalUrl);
                this.imageCacheService.cacheImageUrl(originalUrl, originalUrl).catch(
                  (err) => console.warn("[LocationService] Failed to cache image URL:", err)
                );
              }
            }
          }
          const locationDetails = {
            googlePlaceId: result.place_id,
            name: result.name,
            address: result.formatted_address || null,
            latitude: result.geometry.location.lat,
            longitude: result.geometry.location.lng,
            googleTypes: result.types || [],
            website: result.website || null,
            phone_number: result.international_phone_number || null,
            business_status: result.business_status || null,
            google_rating: result.rating != null ? result.rating : null,
            google_user_ratings_total: result.user_ratings_total != null ? result.user_ratings_total : null,
            photoUrls,
            editorialSummary: result.editorial_summary ? result.editorial_summary.overview : null,
            sourceType: "google_place"
          };
          const existingLocation = await this.findLocationByPlaceId(result.place_id);
          if (existingLocation) {
            locationDetails.existingLocation = existingLocation;
            console.log(`[LocationService] Location ${locationDetails.name} already exists in database (ID: ${existingLocation.id})`);
          }
          console.log(`[LocationService] Successfully fetched details for ${locationDetails.name}`);
          return locationDetails;
        } catch (error) {
          console.error(`[LocationService] Network or fetch error calling Google Places API for placeId ${googlePlaceId}:`, error);
          return null;
        }
      }
      /**
       * Finds a location in the local DB by Google Place ID.
       * @param {string} googlePlaceId 
       * @returns {Promise<object|null>} Location object from DB or null.
       */
      async findLocationByPlaceId(googlePlaceId) {
        console.log("[LocationService findLocationByPlaceId] Method called with googlePlaceId:", googlePlaceId);
        if (!googlePlaceId)
          return null;
        try {
          const stmt = this.db.prepare("SELECT * FROM locations WHERE google_place_id = ?");
          const result = await stmt.bind(googlePlaceId).first();
          return result || null;
        } catch (error) {
          console.error(`[LocationService] Error finding location by placeId ${googlePlaceId}:`, error);
          throw new Error("Database query failed finding location by Place ID.");
        }
      }
      /**
       * Searches for a place by name using Google Places API (Text Search).
       * @param {string} query - The search query (place name).
       * @param {string} region - Optional region bias (e.g., 'tw' for Taiwan, 'penghu').
       * @returns {Promise<Array<object>>} Array of location objects or empty array.
       */
      async searchPlaceByName(query, region = "tw") {
        var _a, _b, _c, _d;
        console.log("[LocationService searchPlaceByName] Searching for:", query);
        if (!query || !query.trim()) {
          return [];
        }
        if (!this.apiKey) {
          console.error("[LocationService] searchPlaceByName called without API key.");
          return [];
        }
        try {
          const locationbias = `circle:50000@23.5,119.5`;
          const url = `${this.googleApiBaseUrl}/place/textsearch/json?query=${encodeURIComponent(query)}&language=zh-TW&region=${region}&locationbias=${locationbias}&key=${this.apiKey}`;
          console.log(`[LocationService] Calling Google Places Text Search API for: ${query}`);
          const response = await fetch(url);
          const data = await response.json();
          if (!response.ok || data.status !== "OK") {
            console.error(`[LocationService] Google Places Text Search API error. Status: ${data.status}, Error: ${data.error_message || "Unknown error"}`);
            if (data.status === "REQUEST_DENIED") {
              console.error(`[LocationService] REQUEST_DENIED - This endpoint may require Places API (Legacy) or need to migrate to new Places API`);
              console.error(`[LocationService] Please check if Places API (New) supports this endpoint, or consider migrating to new API`);
            }
            return [];
          }
          if (!data.results || data.results.length === 0) {
            console.log(`[LocationService] No results found for query: ${query}`);
            return [];
          }
          const locations = [];
          for (const result of data.results.slice(0, 5)) {
            if (!result.place_id)
              continue;
            const existing = await this.findLocationByPlaceId(result.place_id);
            const location = {
              googlePlaceId: result.place_id,
              name: result.name,
              address: result.formatted_address || null,
              latitude: ((_b = (_a = result.geometry) == null ? void 0 : _a.location) == null ? void 0 : _b.lat) || null,
              longitude: ((_d = (_c = result.geometry) == null ? void 0 : _c.location) == null ? void 0 : _d.lng) || null,
              googleTypes: result.types || [],
              google_rating: result.rating != null ? result.rating : null,
              google_user_ratings_total: result.user_ratings_total != null ? result.user_ratings_total : null,
              business_status: result.business_status || null,
              sourceType: "google_place_search",
              alreadyInDatabase: !!existing,
              existingLocationId: (existing == null ? void 0 : existing.id) || null
            };
            locations.push(location);
          }
          console.log(`[LocationService] Found ${locations.length} locations for query: ${query}`);
          return locations;
        } catch (error) {
          console.error(`[LocationService] Network or fetch error calling Google Places Text Search API for query ${query}:`, error);
          return [];
        }
      }
      /**
       * Searches for a place using Google Places API Find Place (more precise).
       * @param {string} input - The search input (name, address, or phone number).
       * @param {string} inputType - 'textquery' or 'phonenumber'.
       * @returns {Promise<Array<object>>} Array of location objects or empty array.
       */
      async findPlace(input, inputType = "textquery") {
        var _a, _b, _c, _d, _e;
        console.log("[LocationService findPlace] Searching for:", input, "type:", inputType);
        if (!input || !input.trim()) {
          console.log("[LocationService findPlace] Input is empty");
          return [];
        }
        if (!this.apiKey) {
          console.error("[LocationService] findPlace called without API key.");
          return [];
        }
        try {
          const fields = "place_id,name,formatted_address,geometry/location,types,website,international_phone_number,business_status,rating,user_ratings_total,editorial_summary";
          const locationbias = `circle:50000@23.5,119.5`;
          const url = `${this.googleApiBaseUrl}/place/findplacefromtext/json?input=${encodeURIComponent(input)}&inputtype=${inputType}&fields=${encodeURIComponent(fields)}&locationbias=${locationbias}&language=zh-TW&key=${this.apiKey}`;
          console.log(`[LocationService] Calling Google Places Find Place API`);
          console.log(`[LocationService] URL: ${url.replace(this.apiKey, "API_KEY_HIDDEN")}`);
          console.log(`[LocationService] Input: ${input}`);
          const response = await fetch(url);
          const data = await response.json();
          console.log(`[LocationService] Google Places API response status: ${data.status}`);
          if (data.error_message) {
            console.error(`[LocationService] Google Places API error: ${data.error_message}`);
          }
          if (!response.ok || data.status !== "OK") {
            console.error(`[LocationService] Google Places Find Place API error. Status: ${data.status}, Error: ${data.error_message || "Unknown error"}`);
            if (data.status === "REQUEST_DENIED") {
              console.error(`[LocationService] REQUEST_DENIED - This endpoint may require Places API (Legacy) or need to migrate to new Places API`);
              console.error(`[LocationService] Please check if Places API (New) supports this endpoint, or consider migrating to new API`);
            }
            return [];
          }
          if (!data.candidates || data.candidates.length === 0) {
            console.log(`[LocationService] No candidates found for query: ${input}`);
            return [];
          }
          const locations = [];
          for (const candidate of data.candidates.slice(0, 5)) {
            if (!candidate.place_id)
              continue;
            const existing = await this.findLocationByPlaceId(candidate.place_id);
            const location = {
              googlePlaceId: candidate.place_id,
              name: candidate.name,
              address: candidate.formatted_address || null,
              latitude: ((_b = (_a = candidate.geometry) == null ? void 0 : _a.location) == null ? void 0 : _b.lat) || null,
              longitude: ((_d = (_c = candidate.geometry) == null ? void 0 : _c.location) == null ? void 0 : _d.lng) || null,
              googleTypes: candidate.types || [],
              website: candidate.website || null,
              phone_number: candidate.international_phone_number || null,
              google_rating: candidate.rating != null ? candidate.rating : null,
              google_user_ratings_total: candidate.user_ratings_total != null ? candidate.user_ratings_total : null,
              business_status: candidate.business_status || null,
              editorialSummary: ((_e = candidate.editorial_summary) == null ? void 0 : _e.overview) || null,
              sourceType: "google_place_find",
              alreadyInDatabase: !!existing,
              existingLocationId: (existing == null ? void 0 : existing.id) || null
            };
            locations.push(location);
          }
          console.log(`[LocationService] Found ${locations.length} locations for query: ${input}`);
          return locations;
        } catch (error) {
          console.error(`[LocationService] Network or fetch error calling Google Places Find Place API for input ${input}:`, error);
          return [];
        }
      }
      /**
       * Finds a location in the local DB by its internal ID (UUID).
       * @param {string} internalId
       * @returns {Promise<object|null>} Location object from DB or null if not found.
       */
      async findLocationByInternalId(internalId) {
        if (!internalId)
          return null;
        try {
          const stmt = this.db.prepare("SELECT * FROM locations WHERE id = ?");
          const result = await stmt.bind(internalId).first();
          return result || null;
        } catch (error) {
          console.error(`[LocationService] Error finding location by internal ID ${internalId}:`, error);
          throw new Error("Database query failed finding location by internal ID.");
        }
      }
      /**
       * Creates a new location record in the local DB.
       * @param {object} locationData - Data for the new location.
       * @returns {Promise<object>} The newly created location object from DB (including generated ID).
       */
      async createLocation(locationData) {
        console.log("[LocationService createLocation V20240726_0900_FIX] ENTERING. locationData received:", !!locationData);
        try {
          console.log("[LocationService createLocation] Querying PRAGMA table_info(locations) before insert...");
          const tableInfo = await this.db.prepare("PRAGMA table_info(locations);").all();
          console.log("[LocationService createLocation] PRAGMA table_info(locations) result:", JSON.stringify(tableInfo.results));
        } catch (pragmaError) {
          console.error("[LocationService createLocation] Error querying PRAGMA table_info(locations):", pragmaError);
        }
        const newId = crypto.randomUUID();
        const now = (/* @__PURE__ */ new Date()).toISOString();
        if (!locationData.name || locationData.latitude == null || locationData.longitude == null || !locationData.sourceType || !locationData.createdByUser) {
          console.error("[LocationService createLocation] Missing required fields:", locationData);
          throw new Error("Missing required fields to create location.");
        }
        const columnNames = [
          "id",
          "google_place_id",
          "name",
          "address",
          "latitude",
          "longitude",
          "source_type",
          "google_types",
          "website",
          "phone_number",
          "business_status",
          "google_rating",
          "google_user_ratings_total",
          "created_by_user_id",
          "created_at",
          "updated_at",
          "thumbnail_url",
          "editorial_summary",
          "category",
          "total_visits",
          "total_itinerary_uses"
        ].join(", ");
        const thumbnailUrl = locationData.photoUrls && locationData.photoUrls.length > 0 ? locationData.photoUrls[0] : null;
        const valuesWithCorrectedUserField = [
          newId,
          locationData.googlePlaceId || null,
          locationData.name,
          locationData.address || null,
          locationData.latitude,
          locationData.longitude,
          locationData.sourceType,
          locationData.googleTypes ? JSON.stringify(locationData.googleTypes) : null,
          locationData.website || null,
          locationData.phone_number || null,
          locationData.business_status || null,
          locationData.google_rating != null ? locationData.google_rating : null,
          locationData.google_user_ratings_total != null ? locationData.google_user_ratings_total : null,
          locationData.createdByUser,
          // for created_by_user_id
          now,
          // created_at
          now,
          // updated_at
          thumbnailUrl,
          locationData.editorialSummary || null,
          locationData.category || null,
          // category
          0,
          // total_visits (default)
          0
          // total_itinerary_uses (default)
        ];
        const placeholdersWithSummary = valuesWithCorrectedUserField.map(() => "?").join(",");
        console.log("[LocationService createLocation] SQL Columns:", columnNames);
        console.log("[LocationService createLocation] SQL Values (first few for brevity):", JSON.stringify(valuesWithCorrectedUserField.slice(0, 5)));
        console.log("[LocationService createLocation] Number of columns:", columnNames.split(",").length);
        console.log("[LocationService createLocation] Number of values:", valuesWithCorrectedUserField.length);
        const uniqueComment = `-- ${Date.now()}`;
        try {
          const stmt = this.db.prepare(
            `INSERT INTO locations (${columnNames}) VALUES (${placeholdersWithSummary}) ${uniqueComment}`
          );
          await stmt.bind(...valuesWithCorrectedUserField).run();
          const createdLocation = await this.db.prepare("SELECT * FROM locations WHERE id = ?").bind(newId).first();
          if (!createdLocation) {
            throw new Error("Failed to fetch created location from DB.");
          }
          console.log(`[LocationService createLocation] Successfully created location ${createdLocation.name} (ID: ${newId})`);
          return createdLocation;
        } catch (error) {
          console.error("[LocationService createLocation] Error during DB operation:", error);
          if (error.message && error.message.includes("UNIQUE constraint failed: locations.google_place_id")) {
            console.warn(`[LocationService createLocation] Attempted to create location with duplicate google_place_id: ${locationData.googlePlaceId}`);
            throw new Error("Location with this Google Place ID already exists.");
          } else {
            if (error.message && error.message.includes("no column named user_id")) {
              console.error("[LocationService createLocation] Re-throwing D1_ERROR for user_id column issue.");
              throw error;
            }
            throw new Error("Database insert failed creating location.");
          }
        }
      }
      /**
       * Creates a new location record in the local DB from coordinates.
       * Minimal data is stored initially.
       * @param {object} coordinateData - Object containing { latitude, longitude, createdByUser }
       * @returns {Promise<object>} The newly created location object.
       */
      async createCoordinateLocation(coordinateData) {
        const newId = crypto.randomUUID();
        const now = (/* @__PURE__ */ new Date()).toISOString();
        if (coordinateData.latitude == null || coordinateData.longitude == null || !coordinateData.createdByUser) {
          console.error("[LocationService] Missing required fields for createCoordinateLocation:", coordinateData);
          throw new Error("Missing required fields (latitude, longitude, createdByUser) to create coordinate location.");
        }
        const valuesToInsert = [
          newId,
          null,
          `Location @ ${coordinateData.latitude.toFixed(4)}, ${coordinateData.longitude.toFixed(4)}`,
          null,
          coordinateData.latitude,
          coordinateData.longitude,
          "user_coordinate",
          null,
          null,
          null,
          null,
          null,
          null,
          coordinateData.createdByUser,
          now,
          now
        ];
        const placeholders = valuesToInsert.map(() => "?").join(",");
        const columnNames = [
          "id",
          "google_place_id",
          "name",
          "address",
          "latitude",
          "longitude",
          "source_type",
          "google_types",
          "website",
          "phone_number",
          "business_status",
          "google_rating",
          "google_user_ratings_total",
          "created_by_user_id",
          "created_at",
          "updated_at"
        ].join(", ");
        try {
          const stmt = this.db.prepare(
            `INSERT INTO locations (${columnNames}) VALUES (${placeholders}) -- coord insert ${Date.now()}`
          );
          await stmt.bind(...valuesToInsert).run();
          const createdLocation = await this.db.prepare("SELECT * FROM locations WHERE id = ?").bind(newId).first();
          if (!createdLocation) {
            throw new Error("Failed to fetch created coordinate location from DB.");
          }
          console.log(`[LocationService] Successfully created coordinate location (ID: ${newId})`);
          return createdLocation;
        } catch (error) {
          console.error("[LocationService] Error creating coordinate location. DB Error:", error.message || error);
          throw new Error("Database insert failed creating coordinate location.");
        }
      }
      /**
      * Creates a user-location association.
      * @param {string} userId 
      * @param {string} locationId 
      * @param {object} options - Optional { user_description, status }
      * @returns {Promise<object>} The newly created user_location object.
      */
      async linkUserToLocation(userId, locationId, options = {}) {
        const newId = crypto.randomUUID();
        const now = (/* @__PURE__ */ new Date()).toISOString();
        const { user_description = null, status = null } = options;
        if (!userId || !locationId) {
          throw new Error("User ID and Location ID are required to link user to location.");
        }
        try {
          const stmt = this.db.prepare(
            `INSERT INTO user_locations (id, user_id, location_id, user_description, status, added_at)
                 VALUES (?, ?, ?, ?, ?, ?)`
          );
          await stmt.bind(
            newId,
            userId,
            locationId,
            user_description,
            status,
            now
          ).run();
          const createdLink = await this.db.prepare("SELECT * FROM user_locations WHERE id = ?").bind(newId).first();
          if (!createdLink) {
            throw new Error("Failed to fetch created user-location link from DB.");
          }
          console.log(`[LocationService] Successfully linked user ${userId} to location ${locationId} (Link ID: ${newId})`);
          return createdLink;
        } catch (error) {
          console.error(`[LocationService] Error linking user ${userId} to location ${locationId}:`, error);
          if (error.message && error.message.includes("UNIQUE constraint failed: user_locations.user_id, user_locations.location_id")) {
            console.warn(`[LocationService] User ${userId} is already linked to location ${locationId}.`);
            throw new Error("User is already associated with this location.");
          } else {
            throw new Error("Database insert failed linking user to location.");
          }
        }
      }
      /**
       * Checks if a user is already linked to a specific location.
       * @param {string} userId 
       * @param {string} locationId 
       * @returns {Promise<boolean>}
       */
      async checkUserLocationLink(userId, locationId) {
        if (!userId || !locationId)
          return false;
        try {
          const stmt = this.db.prepare("SELECT 1 FROM user_locations WHERE user_id = ? AND location_id = ? LIMIT 1");
          const result = await stmt.bind(userId, locationId).first();
          return !!result;
        } catch (error) {
          console.error(`[LocationService] Error checking link between user ${userId} and location ${locationId}:`, error);
          throw new Error("Database query failed checking user-location link.");
        }
      }
      /**
       * Finds the nearest place using Nearby Search and fetches its full details.
       * @param {number} lat Latitude.
       * @param {number} lng Longitude.
       * @returns {Promise<object|null>} Standardized location object for the nearest place, or null if not found/error.
       */
      async findNearbyPlace(lat, lng) {
        if (lat == null || lng == null) {
          console.error("[LocationService] findNearbyPlace called without lat/lng.");
          return null;
        }
        console.log(`[LocationService] Performing Nearby Search around coords: ${lat}, ${lng}`);
        const nearbyUrl = `${this.googleApiBaseUrl}/place/nearbysearch/json?location=${lat}%2C${lng}&rankby=distance&key=${this.apiKey}&language=zh-TW`;
        let nearestPlaceId = null;
        try {
          const nearbyResponse = await fetch(nearbyUrl);
          const nearbyData = await nearbyResponse.json();
          if (!nearbyResponse.ok || nearbyData.status !== "OK") {
            if (nearbyData.status === "ZERO_RESULTS") {
              console.log(`[LocationService] Nearby Search returned ZERO_RESULTS for ${lat}, ${lng}.`);
              return null;
            }
            console.error(`[LocationService] Google Nearby Search API error for coords ${lat},${lng}. Status: ${nearbyData.status}, Error: ${nearbyData.error_message || "Unknown error"}`);
            return null;
          }
          if (nearbyData.results && nearbyData.results.length > 0 && nearbyData.results[0].place_id) {
            nearestPlaceId = nearbyData.results[0].place_id;
            console.log(`[LocationService] Nearby Search found closest place ID: ${nearestPlaceId} (Name: ${nearbyData.results[0].name})`);
          } else {
            console.log(`[LocationService] Nearby Search returned OK but no results with place_id for ${lat}, ${lng}.`);
            return null;
          }
        } catch (error) {
          console.error(`[LocationService] Network or fetch error calling Google Nearby Search API for coords ${lat},${lng}:`, error);
          return null;
        }
        if (nearestPlaceId) {
          console.log(`[LocationService] Fetching full details for nearest place ID: ${nearestPlaceId}`);
          const fullDetails = await this.fetchPlaceDetails(nearestPlaceId);
          return fullDetails;
        }
        return null;
      }
      /**
       * Performs reverse geocoding using Google Geocoding API.
       * @param {number} lat Latitude.
       * @param {number} lng Longitude.
       * @returns {Promise<{address: string|null, placeId: string|null, error?: string}>} 
       */
      reverseGeocodeCoordinates = async (lat, lng) => {
        if (lat == null || lng == null) {
          console.error("[LocationService] reverseGeocodeCoordinates called without lat/lng.");
          return { address: null, placeId: null, error: "Latitude and Longitude are required." };
        }
        console.log(`[LocationService] Performing reverse geocode for coords: ${lat}, ${lng}`);
        const url = `${this.googleApiBaseUrl}/geocode/json?latlng=${lat},${lng}&key=${this.apiKey}&language=zh-TW`;
        try {
          const response = await fetch(url);
          const data = await response.json();
          if (!response.ok || data.status !== "OK") {
            console.error(`[LocationService] Google Geocoding API error for coords ${lat},${lng}. Status: ${data.status}, Error: ${data.error_message || "Unknown error"}`);
            return { address: null, placeId: null, error: data.status || "Geocoding API request failed" };
          }
          if (data.results && data.results.length > 0) {
            const firstResult = data.results[0];
            const formattedAddress = firstResult.formatted_address || null;
            const placeId = firstResult.place_id || null;
            console.log(`[LocationService] Reverse geocode success for ${lat},${lng}. Address: ${formattedAddress}, PlaceID: ${placeId}`);
            return { address: formattedAddress, placeId };
          } else {
            console.warn(`[LocationService] Reverse geocode returned OK status but no results for ${lat},${lng}.`);
            return { address: null, placeId: null, error: "ZERO_RESULTS" };
          }
        } catch (error) {
          console.error(`[LocationService] Network or fetch error calling Google Geocoding API for coords ${lat},${lng}:`, error);
          return { address: null, placeId: null, error: "Network error during geocoding request." };
        }
      };
      /**
       * Fetches all locations linked to a specific user.
       * @param {string} userId The ID of the user.
       * @returns {Promise<Array<object>>} An array of location objects linked to the user.
       */
      async getUserLocations(userId) {
        if (!userId) {
          console.warn("[LocationService] getUserLocations called without userId.");
          return [];
        }
        console.log(`[LocationService] Fetching locations for user: ${userId}`);
        try {
          const stmt = this.db.prepare(
            `SELECT
                    l.id, l.google_place_id, l.name, l.address, l.latitude, l.longitude, l.source_type, 
                    l.google_types, l.website, l.phone_number, l.business_status, l.google_rating, 
                    l.google_user_ratings_total, l.thumbnail_url, l.editorial_summary, l.created_at,
                    l.category, l.total_visits, l.total_itinerary_uses,
                    ul.added_at as user_added_at, ul.user_description, ul.status as user_location_status
                FROM user_locations ul
                JOIN locations l ON ul.location_id = l.id
                WHERE ul.user_id = ?
                ORDER BY ul.added_at DESC`
          );
          const { results } = await stmt.bind(userId).all();
          console.log(`[LocationService] Found ${results ? results.length : 0} locations for user ${userId}.`);
          const processedResults = await this.imageCacheService.processLocationsImages(results || []);
          console.log(`[LocationService] Processed ${processedResults.length} user locations with image cache service.`);
          return processedResults;
        } catch (error) {
          console.error(`[LocationService] Error fetching locations for user ${userId}:`, error);
          throw new Error("Database query failed fetching user locations.");
        }
      }
      /**
       * Fetches the most recent locations that have a thumbnail URL.
       * @param {number} limit Maximum number of locations to fetch.
       * @returns {Promise<Array<object>>} An array of location objects.
       */
      async getRecentLocationsWithThumbnails(limit = 12, userId = null) {
        console.log(`[LocationService] Fetching up to ${limit} recent locations with thumbnails for userId: ${userId}.`);
        try {
          let stmt;
          let results;
          if (userId) {
            stmt = this.db.prepare(
              `SELECT 
                        l.id, l.google_place_id, l.name, l.address, l.latitude, l.longitude, 
                        l.source_type, l.google_types, l.website, l.phone_number, 
                        l.business_status, l.google_rating, l.google_user_ratings_total, 
                        l.thumbnail_url, l.editorial_summary, l.created_at,
                        ul.status as user_location_status
                    FROM locations l
                    LEFT JOIN user_locations ul ON l.id = ul.location_id AND ul.user_id = ?
                    ORDER BY l.created_at DESC
                    LIMIT ?`
            );
            const { results: queryResults } = await stmt.bind(userId, limit).all();
            results = queryResults;
          } else {
            stmt = this.db.prepare(
              `SELECT 
                        id, google_place_id, name, address, latitude, longitude, source_type, google_types, 
                        website, phone_number, business_status, google_rating, google_user_ratings_total, 
                        thumbnail_url, editorial_summary, created_at
                    FROM locations
                    ORDER BY created_at DESC
                    LIMIT ?`
            );
            const { results: queryResults } = await stmt.bind(limit).all();
            results = queryResults;
          }
          console.log(`[LocationService] Found ${results ? results.length : 0} recent locations with thumbnails.`);
          const processedResults = await this.imageCacheService.processLocationsImages(results || []);
          console.log(`[LocationService] Processed ${processedResults.length} locations with image cache service.`);
          return processedResults;
        } catch (error) {
          console.error(`[LocationService] Error fetching recent locations:`, error);
          throw new Error("Database query failed fetching recent locations.");
        }
      }
      /**
       * Fetches locations with pagination support for lazy loading.
       * @param {number} limit - Maximum number of locations to fetch.
       * @param {number} offset - Number of locations to skip.
       * @param {string|null} userId - Optional user ID to include user location status.
       * @returns {Promise<Array<object>>} An array of location objects.
       */
      async getLocationsPaginated(limit = 20, offset = 0, userId = null) {
        console.log(`[LocationService] Fetching locations with pagination: limit=${limit}, offset=${offset}, userId=${userId}.`);
        try {
          let stmt;
          let results;
          if (userId) {
            stmt = this.db.prepare(
              `SELECT 
                        l.id, l.google_place_id, l.name, l.address, l.latitude, l.longitude, 
                        l.source_type, l.google_types, l.website, l.phone_number, 
                        l.business_status, l.google_rating, l.google_user_ratings_total, 
                        l.thumbnail_url, l.editorial_summary, l.created_at,
                        ul.status as user_location_status
                    FROM locations l
                    LEFT JOIN user_locations ul ON l.id = ul.location_id AND ul.user_id = ?
                    ORDER BY l.created_at DESC
                    LIMIT ? OFFSET ?`
            );
            const { results: queryResults } = await stmt.bind(userId, limit, offset).all();
            results = queryResults;
          } else {
            stmt = this.db.prepare(
              `SELECT 
                        id, google_place_id, name, address, latitude, longitude, source_type, google_types, 
                        website, phone_number, business_status, google_rating, google_user_ratings_total, 
                        thumbnail_url, editorial_summary, created_at
                    FROM locations
                    ORDER BY created_at DESC
                    LIMIT ? OFFSET ?`
            );
            const { results: queryResults } = await stmt.bind(limit, offset).all();
            results = queryResults;
          }
          console.log(`[LocationService] Found ${results ? results.length : 0} locations with pagination.`);
          const processedResults = await this.imageCacheService.processLocationsImages(results || []);
          console.log(`[LocationService] Processed ${processedResults.length} locations with image cache service.`);
          return processedResults;
        } catch (error) {
          console.error(`[LocationService] Error fetching locations with pagination:`, error);
          throw new Error("Database query failed fetching locations with pagination.");
        }
      }
      /**
       * Fetches locations for the admin invitation management interface.
       * Returns a list of locations linked to the admin, with their ID, name, address, and claimed status.
       * @param {string} adminUserId The ID of the admin user.
       * @returns {Promise<Array<object>>}
       */
      async getLocationsForAdminInvitation(adminUserId) {
        console.log(`[LocationService] Fetching locations for admin invitation management for admin: ${adminUserId}`);
        if (!adminUserId) {
          console.warn("[LocationService] getLocationsForAdminInvitation called without adminUserId.");
          return [];
        }
        try {
          const stmt = this.db.prepare(
            `SELECT l.id, l.name, l.address, l.claimed_by_user_id, l.owner_email 
                 FROM locations l
                 JOIN user_locations ul ON l.id = ul.location_id
                 WHERE ul.user_id = ?
                 ORDER BY l.created_at DESC`
          );
          const { results } = await stmt.bind(adminUserId).all();
          console.log(`[LocationService] Found ${results ? results.length : 0} locations for admin ${adminUserId} for invitation.`);
          return results || [];
        } catch (error) {
          console.error(`[LocationService] Error fetching locations for admin ${adminUserId} invitation:`, error);
          throw new Error("Database query failed fetching locations for admin.");
        }
      }
      /**
       * Marks a location as claimed by a user and updates the owner email.
       * Also ensures the user is linked in user_locations with an 'owner' status.
       * @param {string} locationId - The ID of the location to claim.
       * @param {string} userId - The ID of the user claiming the location.
       * @param {string} userEmail - The email of the user claiming the location (to be stored as owner_email).
       * @returns {Promise<{success: boolean, error?: string, message?: string}>}
       */
      async claimLocation(locationId, userId, userEmail) {
        console.log(`[LocationService] claimLocation called for locationId: ${locationId}, userId: ${userId}, userEmail: ${userEmail}`);
        if (!locationId || !userId || !userEmail) {
          return { success: false, error: "missing_parameters", message: "\u7F3A\u5C11\u5730\u9EDEID\u3001\u7528\u6236ID\u6216\u7528\u6236\u96FB\u5B50\u90F5\u4EF6\u3002" };
        }
        const now = (/* @__PURE__ */ new Date()).toISOString();
        try {
          const stmtUpdateLocation = this.db.prepare(
            "UPDATE locations SET claimed_by_user_id = ?, owner_email = ?, updated_at = ? WHERE id = ?"
          );
          const updateResult = await stmtUpdateLocation.bind(userId, userEmail, now, locationId).run();
          if (updateResult.meta.changes === 0) {
            return { success: false, error: "location_not_found_or_not_updated", message: "\u627E\u4E0D\u5230\u5730\u9EDE\u6216\u66F4\u65B0\u5931\u6557\u3002" };
          }
          const existingLink = await this.checkUserLocationLink(userId, locationId);
          if (existingLink) {
            const stmtUpdateLink = this.db.prepare(
              "UPDATE user_locations SET status = 'owner', updated_at = ? WHERE user_id = ? AND location_id = ?"
            );
            await stmtUpdateLink.bind(now, userId, locationId).run();
            console.log(`[LocationService] Updated existing user_locations link for userId ${userId} and locationId ${locationId} to status 'owner'.`);
          } else {
            const linkOptions = {
              status: "owner",
              user_description: "Claimed location ownership"
            };
            const linkSuccess = await this.linkUserToLocation(userId, locationId, linkOptions);
            if (!linkSuccess || linkSuccess && linkSuccess.error) {
              console.error(`[LocationService] Failed to link user ${userId} to location ${locationId} after claiming.`);
              return {
                success: true,
                // Location itself was claimed
                warning: "location_claimed_but_link_failed",
                message: "\u5730\u9EDE\u5DF2\u6210\u529F\u8A8D\u9818\uFF0C\u4F46\u5728\u5EFA\u7ACB\u7528\u6236\u5730\u9EDE\u95DC\u806F\u6642\u767C\u751F\u554F\u984C\u3002\u8ACB\u806F\u7E6B\u7BA1\u7406\u54E1\u3002"
              };
            }
            console.log(`[LocationService] Created new user_locations link for userId ${userId} and locationId ${locationId} with status 'owner'.`);
          }
          return { success: true, message: "\u5730\u9EDE\u5DF2\u6210\u529F\u8A8D\u9818\u3002" };
        } catch (dbError) {
          console.error("[LocationService] DB error during claimLocation:", dbError);
          return { success: false, error: "db_error", message: "\u8A8D\u9818\u5730\u9EDE\u6642\u767C\u751F\u8CC7\u6599\u5EAB\u932F\u8AA4\u3002" };
        }
      }
      /**
       * Retrieves a list of locations that have a Google Place ID.
       * Used to populate dropdowns for admin tasks, for example.
       * @returns {Promise<Array<{id: string, name: string, google_place_id: string}>>}
       */
      async getActiveGooglePlaceIds() {
        console.log("[LocationService getActiveGooglePlaceIds] Fetching locations with Google Place IDs.");
        try {
          const stmt = this.db.prepare(
            "SELECT id, name, google_place_id FROM locations WHERE google_place_id IS NOT NULL ORDER BY name ASC"
          );
          const results = await stmt.all();
          return results.results || [];
        } catch (error) {
          console.error("[LocationService] Error fetching active Google Place IDs:", error);
          throw new Error("Database query failed while fetching active Google Place IDs.");
        }
      }
      /**
       * Gets a location by its internal ID.
       * @param {string} locationId The internal location ID.
       * @returns {Promise<object|null>} The location object or null if not found.
       */
      async getLocationById(locationId) {
        if (!locationId) {
          console.warn("[LocationService] getLocationById called without locationId.");
          return null;
        }
        console.log(`[LocationService] Fetching location by ID: ${locationId}`);
        try {
          const stmt = this.db.prepare(
            `SELECT 
                    id, google_place_id, name, address, latitude, longitude, source_type, 
                    google_types, website, phone_number, business_status, google_rating, 
                    google_user_ratings_total, thumbnail_url, editorial_summary, created_at
                FROM locations
                WHERE id = ?`
          );
          const result = await stmt.bind(locationId).first();
          console.log(`[LocationService] Location found: ${result ? "yes" : "no"}`);
          return result;
        } catch (error) {
          console.error(`[LocationService] Error fetching location by ID ${locationId}:`, error);
          throw new Error("Database query failed fetching location by ID.");
        }
      }
      /**
       * Updates or creates a user location status.
       * @param {string} userId The user ID.
       * @param {string} locationId The location ID.
       * @param {string} status The status to set ('visited', 'want_to_visit', 'want_to_revisit', 'created').
       * @returns {Promise<boolean>} Success status.
       */
      async updateUserLocationStatus(userId, locationId, status) {
        if (!userId || !locationId || !status) {
          console.warn("[LocationService] updateUserLocationStatus called with missing parameters.");
          return false;
        }
        console.log(`[LocationService] Updating user location status: userId=${userId}, locationId=${locationId}, status=${status}`);
        const now = (/* @__PURE__ */ new Date()).toISOString();
        try {
          const existingLink = await this.checkUserLocationLink(userId, locationId);
          if (existingLink) {
            const stmt = this.db.prepare(
              `UPDATE user_locations 
                     SET status = ?, updated_at = ?
                     WHERE user_id = ? AND location_id = ?`
            );
            const result = await stmt.bind(status, now, userId, locationId).run();
            console.log(`[LocationService] Updated existing user location status. Changes: ${result.meta.changes}`);
          } else {
            const stmt = this.db.prepare(
              `INSERT INTO user_locations (user_id, location_id, status, added_at, updated_at)
                     VALUES (?, ?, ?, ?, ?)`
            );
            const result = await stmt.bind(userId, locationId, status, now, now).run();
            console.log(`[LocationService] Created new user location link. Changes: ${result.meta.changes}`);
          }
          return true;
        } catch (error) {
          console.error(`[LocationService] Error updating user location status:`, error);
          throw new Error("Database query failed updating user location status.");
        }
      }
      /**
       * Gets the count of user locations by status.
       * @param {string} userId The user ID.
       * @returns {Promise<object>} Object with counts for each status.
       */
      async getUserLocationCounts(userId) {
        if (!userId) {
          console.warn("[LocationService] getUserLocationCounts called without userId.");
          return { visited: 0, want_to_visit: 0, want_to_revisit: 0, created: 0, owner: 0 };
        }
        console.log(`[LocationService] Getting location counts for userId: ${userId}`);
        try {
          const userLocationsStmt = this.db.prepare(
            `SELECT status, COUNT(*) as count
                 FROM user_locations
                 WHERE user_id = ?
                 GROUP BY status`
          );
          const { results: userLocationResults } = await userLocationsStmt.bind(userId).all();
          const createdLocationsStmt = this.db.prepare(
            `SELECT COUNT(*) as count
                 FROM locations
                 WHERE created_by_user_id = ?`
          );
          const { results: createdLocationResults } = await createdLocationsStmt.bind(userId).all();
          const counts = { visited: 0, want_to_visit: 0, want_to_revisit: 0, created: 0, owner: 0 };
          if (userLocationResults) {
            userLocationResults.forEach((row) => {
              if (row.status && counts.hasOwnProperty(row.status)) {
                counts[row.status] = row.count;
              }
            });
          }
          if (createdLocationResults && createdLocationResults.length > 0) {
            counts.created = createdLocationResults[0].count;
          }
          console.log(`[LocationService] Location counts for userId ${userId}:`, counts);
          return counts;
        } catch (error) {
          console.error(`[LocationService] Error getting user location counts:`, error);
          throw new Error("Database query failed getting user location counts.");
        }
      }
      /**
       * Gets the global count of locations by status across all users.
       * @returns {Promise<object>} Object with global counts for each status.
       */
      async getGlobalLocationCounts() {
        console.log("[LocationService] Getting global location counts");
        try {
          const stmt = this.db.prepare(
            `SELECT status, COUNT(*) as count
                 FROM user_locations
                 GROUP BY status`
          );
          const { results } = await stmt.all();
          const counts = { visited: 0, want_to_visit: 0, want_to_revisit: 0, created: 0, owner: 0 };
          if (results) {
            results.forEach((row) => {
              if (row.status && counts.hasOwnProperty(row.status)) {
                counts[row.status] = row.count;
              }
            });
          }
          console.log(`[LocationService] Global location counts:`, counts);
          return counts;
        } catch (error) {
          console.error(`[LocationService] Error getting global location counts:`, error);
          throw new Error("Database query failed getting global location counts.");
        }
      }
      /**
       * Gets the user's status for a specific location.
       * @param {string} userId The user ID.
       * @param {string} locationId The location ID.
       * @returns {Promise<string|null>} The user's status for the location, or null if not found.
       */
      async getUserLocationStatus(userId, locationId) {
        if (!userId || !locationId) {
          console.warn("[LocationService] getUserLocationStatus called with missing parameters.");
          return null;
        }
        console.log(`[LocationService] Getting user location status: userId=${userId}, locationId=${locationId}`);
        try {
          const stmt = this.db.prepare(
            `SELECT status
                 FROM user_locations
                 WHERE user_id = ? AND location_id = ?`
          );
          const result = await stmt.bind(userId, locationId).first();
          const status = result ? result.status : null;
          console.log(`[LocationService] User location status: ${status}`);
          return status;
        } catch (error) {
          console.error(`[LocationService] Error getting user location status:`, error);
          throw new Error("Database query failed getting user location status.");
        }
      }
      /**
       * Gets locations created by a specific user.
       * @param {string} userId The user ID.
       * @returns {Promise<Array<object>>} Array of locations created by the user.
       */
      async getUserCreatedLocations(userId) {
        if (!userId) {
          console.warn("[LocationService] getUserCreatedLocations called without userId.");
          return [];
        }
        console.log(`[LocationService] Getting locations created by user: ${userId}`);
        try {
          const stmt = this.db.prepare(
            `SELECT 
                    id, google_place_id, name, address, latitude, longitude, source_type, 
                    google_types, website, phone_number, business_status, google_rating, 
                    google_user_ratings_total, thumbnail_url, editorial_summary, created_at,
                    created_by_user_id,
                    'created' as user_location_status
                FROM locations
                WHERE created_by_user_id = ?
                ORDER BY created_at DESC`
          );
          const { results } = await stmt.bind(userId).all();
          console.log(`[LocationService] Found ${results ? results.length : 0} locations created by user ${userId}`);
          const processedResults = await this.imageCacheService.processLocationsImages(results || []);
          console.log(`[LocationService] Processed ${processedResults.length} user created locations with image cache service.`);
          return processedResults;
        } catch (error) {
          console.error(`[LocationService] Error getting user created locations:`, error);
          throw new Error("Database query failed getting user created locations.");
        }
      }
      /**
       * Gets the count of user interactions for a specific location by status.
       * @param {string} locationId The location ID.
       * @returns {Promise<object>} Object with counts for each status for this location.
       */
      async getLocationInteractionCounts(locationId) {
        if (!locationId) {
          console.warn("[LocationService] getLocationInteractionCounts called without locationId.");
          return { visited: 0, want_to_visit: 0, want_to_revisit: 0, created: 0, owner: 0 };
        }
        console.log(`[LocationService] Getting interaction counts for location: ${locationId}`);
        try {
          const stmt = this.db.prepare(
            `SELECT status, COUNT(*) as count
                 FROM user_locations
                 WHERE location_id = ?
                 GROUP BY status`
          );
          const { results } = await stmt.bind(locationId).all();
          const counts = { visited: 0, want_to_visit: 0, want_to_revisit: 0, created: 0, owner: 0 };
          if (results) {
            results.forEach((row) => {
              if (row.status && counts.hasOwnProperty(row.status)) {
                counts[row.status] = row.count;
              }
            });
          }
          console.log(`[LocationService] Interaction counts for location ${locationId}:`, counts);
          return counts;
        } catch (error) {
          console.error(`[LocationService] Error getting location interaction counts:`, error);
          throw new Error("Database query failed getting location interaction counts.");
        }
      }
      /**
       * 批量獲取多個地點的互動統計
       * 優化 N+1 查詢問題
       * @param {Array<string>} locationIds - 地點 ID 陣列
       * @returns {Promise<object>} 以 locationId 為 key 的統計對象
       */
      async getBatchLocationInteractionCounts(locationIds) {
        if (!locationIds || locationIds.length === 0) {
          return {};
        }
        console.log(`[LocationService] Getting batch interaction counts for ${locationIds.length} locations`);
        try {
          const placeholders = locationIds.map(() => "?").join(",");
          const stmt = this.db.prepare(
            `SELECT 
                    location_id,
                    status,
                    COUNT(*) as count
                 FROM user_locations
                 WHERE location_id IN (${placeholders})
                 GROUP BY location_id, status`
          );
          const { results } = await stmt.bind(...locationIds).all();
          const countsMap = {};
          locationIds.forEach((id) => {
            countsMap[id] = { visited: 0, want_to_visit: 0, want_to_revisit: 0, created: 0, owner: 0 };
          });
          if (results) {
            results.forEach((row) => {
              const locationId = row.location_id;
              const status = row.status;
              const count = row.count || 0;
              if (countsMap[locationId] && countsMap[locationId].hasOwnProperty(status)) {
                countsMap[locationId][status] = count;
              }
            });
          }
          console.log(`[LocationService] Batch interaction counts retrieved for ${Object.keys(countsMap).length} locations`);
          return countsMap;
        } catch (error) {
          console.error(`[LocationService] Error getting batch location interaction counts:`, error);
          throw new Error("Database query failed getting batch location interaction counts.");
        }
      }
      /**
       * 批量獲取用戶對多個地點的狀態
       * 優化 N+1 查詢問題
       * @param {string} userId - 用戶 ID
       * @param {Array<string>} locationIds - 地點 ID 陣列
       * @returns {Promise<object>} 以 locationId 為 key 的狀態對象
       */
      async getBatchUserLocationStatuses(userId, locationIds) {
        if (!userId || !locationIds || locationIds.length === 0) {
          return {};
        }
        console.log(`[LocationService] Getting batch user location statuses for user ${userId} and ${locationIds.length} locations`);
        try {
          const placeholders = locationIds.map(() => "?").join(",");
          const stmt = this.db.prepare(
            `SELECT 
                    location_id,
                    status
                 FROM user_locations
                 WHERE user_id = ? AND location_id IN (${placeholders})`
          );
          const { results } = await stmt.bind(userId, ...locationIds).all();
          const statusMap = {};
          if (results) {
            results.forEach((row) => {
              statusMap[row.location_id] = row.status;
            });
          }
          console.log(`[LocationService] Batch user location statuses retrieved for ${Object.keys(statusMap).length} locations`);
          return statusMap;
        } catch (error) {
          console.error(`[LocationService] Error getting batch user location statuses:`, error);
          throw new Error("Database query failed getting batch user location statuses.");
        }
      }
      /**
       * 優化版本：一次性獲取用戶的所有地點數據（包括用戶建立的地點）
       * 合併 getUserLocations 和 getUserCreatedLocations 為單一查詢
       * @param {string} userId - 用戶 ID
       * @returns {Promise<object>} 包含 userLocations 和 userCreatedLocations 的對象
       */
      async getUserAllLocationsOptimized(userId) {
        if (!userId) {
          console.warn("[LocationService] getUserAllLocationsOptimized called without userId.");
          return { userLocations: [], userCreatedLocations: [] };
        }
        console.log(`[LocationService] Getting all locations for user: ${userId} (optimized)`);
        try {
          const stmt = this.db.prepare(
            `SELECT
                    l.id, l.google_place_id, l.name, l.address, l.latitude, l.longitude, l.source_type, 
                    l.google_types, l.website, l.phone_number, l.business_status, l.google_rating, 
                    l.google_user_ratings_total, l.thumbnail_url, l.editorial_summary, l.created_at,
                    ul.added_at as user_added_at, ul.user_description, ul.status as user_location_status,
                    'user_location' as source
                FROM user_locations ul
                JOIN locations l ON ul.location_id = l.id
                WHERE ul.user_id = ?
                
                UNION ALL
                
                SELECT
                    id, google_place_id, name, address, latitude, longitude, source_type, 
                    google_types, website, phone_number, business_status, google_rating, 
                    google_user_ratings_total, thumbnail_url, editorial_summary, created_at,
                    created_at as user_added_at, NULL as user_description,
                    'created' as user_location_status,
                    'user_created' as source
                FROM locations
                WHERE created_by_user_id = ?
                
                ORDER BY user_added_at DESC`
          );
          const { results } = await stmt.bind(userId, userId).all();
          const userLocations = [];
          const userCreatedLocations = [];
          if (results) {
            results.forEach((row) => {
              const processedRow = { ...row };
              if (row.source === "user_location") {
                userLocations.push(processedRow);
              } else if (row.source === "user_created") {
                userCreatedLocations.push(processedRow);
              }
            });
          }
          const processedUserLocations = await this.imageCacheService.processLocationsImages(userLocations);
          const processedUserCreatedLocations = await this.imageCacheService.processLocationsImages(userCreatedLocations);
          console.log(`[LocationService] Found ${processedUserLocations.length} user locations and ${processedUserCreatedLocations.length} user created locations (optimized)`);
          return {
            userLocations: processedUserLocations,
            userCreatedLocations: processedUserCreatedLocations
          };
        } catch (error) {
          console.error(`[LocationService] Error getting user all locations (optimized):`, error);
          throw new Error("Database query failed getting user all locations (optimized).");
        }
      }
      /**
       * 根據 Google Place ID 查找地點
       * @param {string} googlePlaceId - Google Place ID
       * @returns {Promise<object|null>} 地點物件或 null
       */
      async getLocationByGooglePlaceId(googlePlaceId) {
        if (!googlePlaceId) {
          return null;
        }
        try {
          const stmt = this.db.prepare("SELECT * FROM locations WHERE google_place_id = ?");
          const location = await stmt.bind(googlePlaceId).first();
          return location || null;
        } catch (error) {
          console.error("[LocationService] Error getting location by google_place_id:", error);
          return null;
        }
      }
      /**
       * 從 Google Maps 地點資料自動創建或獲取地點
       * 如果地點已存在（透過 google_place_id），則返回現有地點
       * 如果不存在，則創建新地點並自動建立用戶關聯
       * @param {object} googlePlaceData - Google Places API 返回的地點資料
       * @param {number} userId - 用戶 ID
       * @param {object} options - 選項 { autoLink: true, initialStatus: 'want_to_visit', sourceType: 'itinerary_added' }
       * @returns {Promise<object>} 地點物件
       */
      async createOrGetLocationFromGoogleMaps(googlePlaceData, userId, options = {}) {
        var _a, _b, _c, _d, _e, _f;
        const {
          autoLink = true,
          initialStatus = "want_to_visit",
          sourceType = "itinerary_added"
        } = options;
        try {
          let location = null;
          if (googlePlaceData.place_id) {
            location = await this.getLocationByGooglePlaceId(googlePlaceData.place_id);
          }
          if (!location) {
            const locationData = {
              googlePlaceId: googlePlaceData.place_id,
              name: googlePlaceData.name || googlePlaceData.formatted_address,
              address: googlePlaceData.formatted_address,
              latitude: ((_b = (_a = googlePlaceData.geometry) == null ? void 0 : _a.location) == null ? void 0 : _b.lat) || googlePlaceData.lat,
              longitude: ((_d = (_c = googlePlaceData.geometry) == null ? void 0 : _c.location) == null ? void 0 : _d.lng) || googlePlaceData.lng,
              sourceType,
              createdByUser: userId,
              googleTypes: googlePlaceData.types || [],
              website: googlePlaceData.website,
              phone_number: googlePlaceData.international_phone_number || googlePlaceData.phone_number,
              business_status: googlePlaceData.business_status,
              google_rating: googlePlaceData.rating,
              google_user_ratings_total: googlePlaceData.user_ratings_total,
              photoUrls: ((_e = googlePlaceData.photos) == null ? void 0 : _e.map((p) => {
                var _a2;
                return ((_a2 = p.getUrl) == null ? void 0 : _a2.call(p)) || p.photo_reference;
              })) || [],
              editorialSummary: (_f = googlePlaceData.editorial_summary) == null ? void 0 : _f.overview,
              category: this.extractCategoryFromTypes(googlePlaceData.types)
            };
            location = await this.createLocation(locationData);
            console.log(`[LocationService] Created new location from Google Maps: ${location.id}`);
          } else {
            console.log(`[LocationService] Location already exists: ${location.id}`);
          }
          if (autoLink && userId) {
            await this.linkLocationToUserIfNotExists(userId, location.id, {
              status: initialStatus,
              source: "itinerary"
            });
          }
          return location;
        } catch (error) {
          console.error("[LocationService] Error creating/getting location from Google Maps:", error);
          throw error;
        }
      }
      /**
       * 從 Google Types 陣列提取主要分類
       * @param {Array<string>} types - Google Places types 陣列
       * @returns {string|null} 主要分類
       */
      extractCategoryFromTypes(types) {
        if (!types || !Array.isArray(types)) {
          return null;
        }
        const categoryMap = {
          "restaurant": ["restaurant", "food", "cafe", "meal_takeaway"],
          "attraction": ["tourist_attraction", "point_of_interest", "establishment"],
          "hotel": ["lodging", "hotel"],
          "shopping": ["store", "shopping_mall"],
          "entertainment": ["amusement_park", "movie_theater", "night_club"],
          "transport": ["airport", "train_station", "bus_station", "subway_station"]
        };
        for (const [category, keywords] of Object.entries(categoryMap)) {
          if (types.some((type) => keywords.some((keyword) => type.includes(keyword)))) {
            return category;
          }
        }
        return "other";
      }
      /**
       * 如果用戶地點關聯不存在，則創建它
       * @param {number} userId - 用戶 ID
       * @param {string} locationId - 地點 ID
       * @param {object} options - { status, source, user_description }
       * @returns {Promise<object>} 用戶地點關聯物件
       */
      async linkLocationToUserIfNotExists(userId, locationId, options = {}) {
        const { status = "want_to_visit", source = null, user_description = null } = options;
        try {
          const existing = await this.db.prepare(
            `SELECT * FROM user_locations WHERE user_id = ? AND location_id = ?`
          ).bind(userId, locationId).first();
          if (existing) {
            console.log(`[LocationService] User location link already exists: ${userId} -> ${locationId}`);
            return existing;
          }
          const linkId = crypto.randomUUID();
          const now = (/* @__PURE__ */ new Date()).toISOString();
          await this.db.prepare(
            `INSERT INTO user_locations (id, user_id, location_id, status, user_description, added_at, updated_at)
                 VALUES (?, ?, ?, ?, ?, ?, ?)`
          ).bind(
            linkId,
            userId,
            locationId,
            status,
            user_description,
            now,
            now
          ).run();
          console.log(`[LocationService] Created user location link: ${userId} -> ${locationId} (${status})`);
          return await this.db.prepare(
            `SELECT * FROM user_locations WHERE id = ?`
          ).bind(linkId).first();
        } catch (error) {
          console.error("[LocationService] Error linking location to user:", error);
          throw error;
        }
      }
      /**
       * 增加地點的行程使用次數
       * @param {string} locationId - 地點 ID
       * @returns {Promise<void>}
       */
      async incrementItineraryUseCount(locationId) {
        try {
          await this.db.prepare(
            `UPDATE locations SET total_itinerary_uses = COALESCE(total_itinerary_uses, 0) + 1 WHERE id = ?`
          ).bind(locationId).run();
        } catch (error) {
          console.error("[LocationService] Error incrementing itinerary use count:", error);
        }
      }
      /**
       * 增加地點的訪問次數
       * @param {string} locationId - 地點 ID
       * @returns {Promise<void>}
       */
      async incrementVisitCount(locationId) {
        try {
          await this.db.prepare(
            `UPDATE locations SET total_visits = COALESCE(total_visits, 0) + 1 WHERE id = ?`
          ).bind(locationId).run();
        } catch (error) {
          console.error("[LocationService] Error incrementing visit count:", error);
        }
      }
      /**
       * 更新地點分類
       * @param {string} locationId - 地點 ID
       * @param {string} category - 分類
       * @returns {Promise<void>}
       */
      async updateLocationCategory(locationId, category) {
        try {
          await this.db.prepare(
            `UPDATE locations SET category = ? WHERE id = ?`
          ).bind(category, locationId).run();
        } catch (error) {
          console.error("[LocationService] Error updating location category:", error);
          throw error;
        }
      }
      // Potentially add other helper methods like updateLocation, deleteLocation etc.
    };
  }
});

// src/services/LocationInvitationService.js
var LocationInvitationService;
var init_LocationInvitationService = __esm({
  "src/services/LocationInvitationService.js"() {
    "use strict";
    LocationInvitationService = class {
      constructor(db) {
        this.db = db;
      }
      /**
       * Generates a claim link for a location and stores the invitation.
       * @param {string} locationId - The ID of the location.
       * @param {string} merchantEmail - The email of the merchant to invite.
       * @param {string} adminId - The ID of the admin creating the invitation.
       * @returns {Promise<{claim_url: string, merchant_email: string} | {error: string, status: number}>}
       */
      async generateClaimLink(locationId, merchantEmail, adminId) {
        if (!locationId || !merchantEmail || !adminId) {
          return { error: "Missing required fields: locationId, merchantEmail, or adminId.", status: 400 };
        }
        try {
          const claimToken = crypto.randomUUID();
          const now = /* @__PURE__ */ new Date();
          const createdAtISO = now.toISOString();
          const expiresAt = new Date(now.setDate(now.getDate() + 7));
          const expiresAtISO = expiresAt.toISOString();
          const stmt = this.db.prepare(
            "INSERT INTO location_invitations (id, location_id, merchant_email, claim_token, status, created_at, created_by_admin_id, expires_at) VALUES (?, ?, ?, ?, ?, ?, ?, ?)"
          );
          await stmt.bind(crypto.randomUUID(), locationId, merchantEmail, claimToken, "pending_claim", createdAtISO, adminId, expiresAtISO).run();
          const claim_url = `https://www.hopenghu.cc/claim-location?token=${claimToken}`;
          return { claim_url, merchant_email: merchantEmail };
        } catch (error) {
          console.error("Error generating claim link:", error);
          if (error.message && error.message.includes("UNIQUE constraint failed: location_invitations.claim_token")) {
            return { error: "Failed to generate a unique claim token. Please try again.", status: 500 };
          }
          if (error.message && error.message.includes("FOREIGN KEY constraint failed")) {
            return { error: "Invalid location_id or admin_id provided.", status: 400 };
          }
          return { error: "Failed to generate claim link due to a server error.", status: 500 };
        }
      }
      /**
       * Verifies a claim token.
       * @param {string} token - The claim token.
       * @returns {Promise<{isValid: boolean, invitation?: object, error?: string, message?: string}>}
       */
      async verifyInvitationToken(token) {
        console.log(`[LocationInvitationService] verifyInvitationToken called with token: ${token}`);
        if (!token) {
          return { isValid: false, error: "invalid_token", message: "\u6B0A\u6756\u4E0D\u53EF\u70BA\u7A7A\u3002" };
        }
        try {
          const stmt = this.db.prepare(
            "SELECT * FROM location_invitations WHERE claim_token = ?"
          );
          const invitation = await stmt.bind(token).first();
          if (!invitation) {
            return { isValid: false, error: "invalid_token", message: "\u7121\u6548\u7684\u9080\u8ACB\u6B0A\u6756\u3002" };
          }
          if (invitation.status !== "pending_claim") {
            return { isValid: false, error: "already_used", message: "\u6B64\u9080\u8ACB\u5DF2\u88AB\u4F7F\u7528\u6216\u5DF2\u5931\u6548\u3002" };
          }
          const now = /* @__PURE__ */ new Date();
          const expiresAt = new Date(invitation.expires_at);
          if (now > expiresAt) {
            return { isValid: false, error: "expired", message: "\u6B64\u9080\u8ACB\u5DF2\u904E\u671F\u3002" };
          }
          return { isValid: true, invitation };
        } catch (dbError) {
          console.error("[LocationInvitationService] DB error during verifyInvitationToken:", dbError);
          return { isValid: false, error: "db_error", message: "\u9A57\u8B49\u9080\u8ACB\u6642\u767C\u751F\u8CC7\u6599\u5EAB\u932F\u8AA4\u3002" };
        }
      }
      /**
       * Marks an invitation as claimed.
       * @param {string} invitationId - The ID of the invitation.
       * @param {string} claimingUserId - The ID of the user claiming the invitation.
       * @returns {Promise<{success: boolean, error?: string}>}
       */
      async markInvitationAsClaimed(invitationId, claimingUserId) {
        console.log(`[LocationInvitationService] markInvitationAsClaimed called for invitationId: ${invitationId}, claimingUserId: ${claimingUserId}`);
        if (!invitationId || !claimingUserId) {
          return { success: false, error: "missing_parameters", message: "\u7F3A\u5C11\u9080\u8ACBID\u6216\u7528\u6236ID\u3002" };
        }
        try {
          const now = (/* @__PURE__ */ new Date()).toISOString();
          const stmt = this.db.prepare(
            "UPDATE location_invitations SET status = 'claimed', claimed_at = ?, claimed_by_user_id = ?, updated_at = ? WHERE id = ?"
          );
          const result = await stmt.bind(now, claimingUserId, now, invitationId).run();
          if (result.meta.changes === 0) {
            return { success: false, error: "not_found", message: "\u627E\u4E0D\u5230\u5C0D\u61C9\u7684\u9080\u8ACB\u6216\u66F4\u65B0\u5931\u6557\u3002" };
          }
          return { success: true };
        } catch (dbError) {
          console.error("[LocationInvitationService] DB error during markInvitationAsClaimed:", dbError);
          return { success: false, error: "db_error", message: "\u66F4\u65B0\u9080\u8ACB\u72C0\u614B\u6642\u767C\u751F\u8CC7\u6599\u5EAB\u932F\u8AA4\u3002" };
        }
      }
      // We will add more methods here later for verify-claim-token and confirm-claim
    };
  }
});

// src/services/AIQuestioningService.js
var AIQuestioningService;
var init_AIQuestioningService = __esm({
  "src/services/AIQuestioningService.js"() {
    "use strict";
    AIQuestioningService = class {
      constructor(db) {
        if (!db) {
          throw new Error("Database connection is required for AIQuestioningService.");
        }
        this.db = db;
      }
      /**
       * 獲取或建立對話狀態
       */
      async getOrCreateConversationState(sessionId, userId, conversationType = "general") {
        try {
          let state = await this.db.prepare(
            `SELECT * FROM ai_conversation_states 
         WHERE session_id = ? AND (user_id = ? OR (user_id IS NULL AND ? IS NULL))
         ORDER BY updated_at DESC LIMIT 1`
          ).bind(sessionId, userId || null, userId || null).first();
          if (!state) {
            const newId = `state_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
            await this.db.prepare(
              `INSERT INTO ai_conversation_states 
           (id, session_id, user_id, conversation_type, current_step, context_data, collected_data)
           VALUES (?, ?, ?, ?, ?, ?, ?)`
            ).bind(
              newId,
              sessionId,
              userId || null,
              conversationType,
              "start",
              JSON.stringify({}),
              JSON.stringify({})
            ).run();
            state = await this.db.prepare(
              "SELECT * FROM ai_conversation_states WHERE id = ?"
            ).bind(newId).first();
          }
          if (state) {
            state.context_data = state.context_data ? JSON.parse(state.context_data) : {};
            state.collected_data = state.collected_data ? JSON.parse(state.collected_data) : {};
          }
          return state;
        } catch (error) {
          console.error("[AIQuestioningService] Error getting conversation state:", error);
          throw error;
        }
      }
      /**
       * 更新對話狀態
       */
      async updateConversationState(stateId, updates) {
        try {
          const contextData = updates.context_data ? JSON.stringify(updates.context_data) : null;
          const collectedData = updates.collected_data ? JSON.stringify(updates.collected_data) : null;
          await this.db.prepare(
            `UPDATE ai_conversation_states 
         SET current_step = ?,
             context_data = COALESCE(?, context_data),
             collected_data = COALESCE(?, collected_data),
             is_complete = ?,
             updated_at = CURRENT_TIMESTAMP
         WHERE id = ?`
          ).bind(
            updates.current_step || null,
            contextData,
            collectedData,
            updates.is_complete || false,
            stateId
          ).run();
          return true;
        } catch (error) {
          console.error("[AIQuestioningService] Error updating conversation state:", error);
          throw error;
        }
      }
      /**
       * 判斷使用者類型
       * @param {string} userId - 使用者 ID
       * @param {string} recentMessage - 最近的訊息（用於從對話中識別使用者類型）
       */
      async determineUserType(userId, recentMessage = null) {
        if (recentMessage) {
          const messageLower = recentMessage.toLowerCase();
          if (messageLower.includes("\u6211\u662F\u5546\u5BB6") || messageLower.includes("\u6211\u662F\u5E97\u5BB6") || messageLower.includes("\u6211\u662F\u8001\u95C6") || messageLower.includes("\u6211\u662F\u696D\u8005")) {
            if (userId) {
              try {
                await this.db.prepare(
                  `UPDATE users SET user_type = 'merchant', is_merchant = true WHERE id = ?`
                ).bind(userId).run();
              } catch (error) {
                console.error("[AIQuestioningService] Error updating user type:", error);
              }
            }
            return "merchant";
          }
          if (messageLower.includes("\u6211\u662F\u65C5\u5BA2") || messageLower.includes("\u6211\u662F\u904A\u5BA2") || messageLower.includes("\u6211\u662F\u89C0\u5149\u5BA2")) {
            return "traveler";
          }
        }
        if (!userId) {
          return "traveler";
        }
        try {
          const claimedLocations = await this.db.prepare(
            `SELECT COUNT(*) as count FROM locations WHERE claimed_by_user_id = ?`
          ).bind(userId).first();
          if (claimedLocations && claimedLocations.count > 0) {
            return "merchant";
          }
          const user = await this.db.prepare(
            "SELECT user_type, is_merchant FROM users WHERE id = ?"
          ).bind(userId).first();
          if (user) {
            if (user.is_merchant || user.user_type === "merchant") {
              return "merchant";
            }
            if (user.user_type === "local") {
              return "local";
            }
          }
          return "traveler";
        } catch (error) {
          console.error("[AIQuestioningService] Error determining user type:", error);
          return "traveler";
        }
      }
      /**
       * 分析查詢，判斷是否需要問問題
       */
      analyzeQuery(query, userType, state) {
        var _a;
        const queryLower = query.toLowerCase();
        if (state && !state.is_complete) {
          return {
            shouldAsk: true,
            type: state.conversation_type,
            step: state.current_step
          };
        }
        const isFirstConversation = !state || !state.collected_data || Object.keys(state.collected_data).length === 0;
        const hasIdentityInfo = ((_a = state == null ? void 0 : state.collected_data) == null ? void 0 : _a.user_identity) || queryLower.includes("\u5C45\u6C11") || queryLower.includes("\u4F86\u904E") || queryLower.includes("\u60F3\u4F86") || queryLower.includes("\u6211\u662F\u5C45\u6C11") || queryLower.includes("\u6211\u662F\u65C5\u5BA2") || queryLower.includes("\u6211\u4F86\u904E") || queryLower.includes("\u6211\u60F3\u4F86");
        if (isFirstConversation && !hasIdentityInfo) {
          if (queryLower.includes("\u5C45\u6C11") || queryLower.includes("\u4F86\u904E") || queryLower.includes("\u60F3\u4F86") || queryLower.includes("\u6211\u662F\u5C45\u6C11") || queryLower.includes("\u6211\u662F\u65C5\u5BA2") || queryLower.includes("\u6211\u4F86\u904E") || queryLower.includes("\u6211\u60F3\u4F86")) {
          } else {
            return {
              shouldAsk: true,
              type: "identity_guide",
              step: "ask_identity"
            };
          }
        }
        const merchantKeywords = ["\u5546\u5BB6", "\u5E97\u5BB6", "\u71DF\u696D", "\u7522\u54C1", "\u50F9\u683C", "\u8CBB\u7528", "\u6D88\u8CBB", "\u670D\u52D9"];
        const isMerchantQuery = merchantKeywords.some((keyword) => queryLower.includes(keyword));
        const travelerKeywords = ["\u56DE\u61B6", "\u53BB\u904E", "\u9020\u8A2A", "\u9AD4\u9A57", "\u611F\u53D7", "\u60F3\u518D\u53BB", "\u63A8\u85A6"];
        const isTravelerQuery = travelerKeywords.some((keyword) => queryLower.includes(keyword));
        const distanceKeywords = ["\u8DDD\u96E2", "\u591A\u9060", "\u591A\u4E45", "\u6642\u9593", "\u600E\u9EBC\u53BB", "\u8DEF\u7DDA"];
        const isDistanceQuery = distanceKeywords.some((keyword) => queryLower.includes(keyword));
        if (userType === "merchant" && (isMerchantQuery || !state || queryLower.includes("\u6211\u662F\u5546\u5BB6"))) {
          return {
            shouldAsk: true,
            type: "merchant_setup",
            step: "identify_location"
          };
        }
        if (userType === "traveler" && (isTravelerQuery || !state)) {
          return {
            shouldAsk: true,
            type: "traveler_memory",
            step: "identify_location"
          };
        }
        if (isDistanceQuery) {
          return {
            shouldAsk: true,
            type: "distance_query",
            step: "identify_locations"
          };
        }
        return {
          shouldAsk: false,
          type: "general",
          step: null
        };
      }
      /**
       * 生成問問題的提示詞（商家）
       */
      generateMerchantQuestion(state, collectedData) {
        var _a, _b;
        const step = state.current_step;
        const collected = collectedData || {};
        switch (step) {
          case "start":
          case "identify_location":
            if (!collected.location_name && !collected.location_id) {
              return {
                question: "\u8ACB\u554F\u60A8\u8981\u63D0\u4F9B\u8CC7\u8A0A\u7684\u5546\u5BB6\u540D\u7A31\u662F\u4EC0\u9EBC\uFF1F\u6216\u8005\u60A8\u53EF\u4EE5\u76F4\u63A5\u544A\u8A34\u6211\u5730\u9EDE\u540D\u7A31\u3002",
                field: "location_name",
                next_step: "confirm_location"
              };
            }
            return this.generateMerchantQuestion({ ...state, current_step: "confirm_location" }, collected);
          case "confirm_location":
            if (!collected.location_id) {
              return {
                question: "\u597D\u7684\uFF0C\u95DC\u65BC\u300C" + (collected.location_name || "\u9019\u500B\u5730\u9EDE") + "\u300D\uFF0C\u8ACB\u554F\u9019\u662F\u60A8\u7684\u5546\u5BB6\u55CE\uFF1F",
                field: "location_confirmed",
                next_step: "ask_business_type"
              };
            }
            return this.generateMerchantQuestion({ ...state, current_step: "ask_business_type" }, collected);
          case "ask_business_type":
            if (!collected.business_type) {
              return {
                question: "\u8ACB\u554F\u60A8\u7684\u5546\u5BB6\u985E\u578B\u662F\u4EC0\u9EBC\uFF1F\uFF08\u4F8B\u5982\uFF1A\u9910\u5EF3\u3001\u4F4F\u5BBF\u3001\u666F\u9EDE\u3001\u5546\u5E97\u7B49\uFF09",
                field: "business_type",
                next_step: "ask_opening_hours"
              };
            }
            return this.generateMerchantQuestion({ ...state, current_step: "ask_opening_hours" }, collected);
          case "ask_opening_hours":
            if (!collected.opening_hours) {
              return {
                question: "\u8ACB\u554F\u60A8\u7684\u71DF\u696D\u6642\u9593\u662F\uFF1F\uFF08\u4F8B\u5982\uFF1A\u9031\u4E00\u81F3\u9031\u4E94 09:00-18:00\uFF0C\u9031\u516D 10:00-20:00\uFF09",
                field: "opening_hours",
                next_step: "ask_products"
              };
            }
            return this.generateMerchantQuestion({ ...state, current_step: "ask_products" }, collected);
          case "ask_products":
            if (!collected.products || collected.products.length === 0) {
              return {
                question: "\u8ACB\u554F\u60A8\u63D0\u4F9B\u4EC0\u9EBC\u7522\u54C1\u6216\u670D\u52D9\uFF1F\u8ACB\u544A\u8A34\u6211\u7522\u54C1\u540D\u7A31\u3002",
                field: "product_name",
                next_step: "ask_product_price"
              };
            }
            const lastProduct = collected.products[collected.products.length - 1];
            if (!lastProduct.price && !lastProduct.price_confirmed) {
              return this.generateMerchantQuestion({ ...state, current_step: "ask_product_price" }, collected);
            }
            if (!lastProduct.duration_minutes && !lastProduct.duration_confirmed) {
              return this.generateMerchantQuestion({ ...state, current_step: "ask_product_duration" }, collected);
            }
            if (collected.more_products === false) {
              return {
                question: null,
                field: null,
                next_step: "complete"
              };
            }
            return {
              question: "\u9084\u6709\u5176\u4ED6\u7522\u54C1\u6216\u670D\u52D9\u8981\u63D0\u4F9B\u55CE\uFF1F\u5982\u679C\u6C92\u6709\uFF0C\u8ACB\u8AAA\u300C\u5B8C\u6210\u300D\u3002",
              field: "more_products",
              next_step: "ask_products"
              // 如果還有，繼續詢問
            };
          case "ask_product_price":
            const currentProduct = (_a = collected.products) == null ? void 0 : _a[collected.products.length - 1];
            if (!currentProduct) {
              return this.generateMerchantQuestion({ ...state, current_step: "ask_products" }, collected);
            }
            return {
              question: `\u8ACB\u554F\u300C${currentProduct.name || "\u9019\u500B\u7522\u54C1"}\u300D\u7684\u50F9\u683C\u662F\u591A\u5C11\uFF1F\uFF08\u5982\u679C\u514D\u8CBB\u6216\u50F9\u683C\u9762\u8B70\uFF0C\u8ACB\u76F4\u63A5\u8AAA\u660E\uFF09`,
              field: "product_price",
              next_step: "ask_product_duration"
            };
          case "ask_product_duration":
            const currentProduct2 = (_b = collected.products) == null ? void 0 : _b[collected.products.length - 1];
            if (!currentProduct2) {
              return this.generateMerchantQuestion({ ...state, current_step: "ask_products" }, collected);
            }
            if (collected.price !== void 0 && currentProduct2.price === null) {
              currentProduct2.price = collected.price;
            }
            return {
              question: `\u8ACB\u554F\u300C${currentProduct2.name || "\u9019\u500B\u7522\u54C1"}\u300D\u7684\u6D88\u8CBB\u6642\u9593\u5927\u7D04\u9700\u8981\u591A\u4E45\uFF1F\uFF08\u4F8B\u5982\uFF1A30 \u5206\u9418\u30011 \u5C0F\u6642\uFF0C\u5982\u679C\u4E0D\u9700\u8981\u6642\u9593\u8ACB\u8AAA\u300C\u4E0D\u9700\u8981\u300D\uFF09`,
              field: "product_duration",
              next_step: "ask_products"
              // 回到詢問更多產品
            };
          case "complete":
            return {
              question: null,
              field: null,
              next_step: "complete"
            };
          default:
            return {
              question: "\u611F\u8B1D\u60A8\u63D0\u4F9B\u8CC7\u8A0A\uFF01\u9084\u6709\u5176\u4ED6\u9700\u8981\u88DC\u5145\u7684\u55CE\uFF1F",
              field: null,
              next_step: "complete"
            };
        }
      }
      /**
       * 生成身份引導問題
       */
      generateIdentityQuestion(state, collectedData) {
        const step = state.current_step;
        const collected = collectedData || {};
        switch (step) {
          case "start":
          case "ask_identity":
            if (!collected.user_identity) {
              return {
                question: "\u70BA\u4E86\u66F4\u597D\u5730\u5354\u52A9\u60A8\uFF0C\u8ACB\u554F\u60A8\u662F\uFF1A\n1. \u6F8E\u6E56\u751F\u6D3B\u5C45\u6C11\n2. \u4F86\u904E\u6F8E\u6E56\u7684\u65C5\u5BA2\n3. \u60F3\u4F86\u6F8E\u6E56\u7684\u65C5\u5BA2\n\n\u8ACB\u76F4\u63A5\u544A\u8A34\u6211\u60A8\u7684\u8EAB\u4EFD\uFF0C\u4F8B\u5982\uFF1A\u6211\u662F\u5C45\u6C11\u3001\u6211\u4F86\u904E\u3001\u6211\u60F3\u4F86\u3002",
                field: "user_identity",
                next_step: "collect_identity_info"
              };
            }
            return this.generateIdentityQuestion({ ...state, current_step: "collect_identity_info" }, collected);
          case "collect_identity_info":
            const identity = collected.user_identity;
            if (identity === "local" || identity === "\u5C45\u6C11") {
              return {
                question: "\u592A\u597D\u4E86\uFF01\u4F60\u4F4F\u5728\u6F8E\u6E56\u54EA\u500B\u5340\u57DF\u5462\uFF1F\uFF08\u4F8B\u5982\uFF1A\u99AC\u516C\u3001\u6E56\u897F\u3001\u767D\u6C99\u3001\u897F\u5DBC\u3001\u671B\u5B89\u3001\u4E03\u7F8E\uFF09",
                field: "region",
                next_step: "ask_local_interests"
              };
            } else if (identity === "visited_traveler" || identity === "\u4F86\u904E" || identity === "\u6211\u4F86\u904E") {
              return {
                question: "\u4F60\u4EC0\u9EBC\u6642\u5019\u4F86\u904E\u6F8E\u6E56\u5462\uFF1F\uFF08\u4F8B\u5982\uFF1A2024\u5E747\u6708\uFF09",
                field: "visit_period",
                next_step: "ask_visited_places"
              };
            } else if (identity === "planning_traveler" || identity === "\u60F3\u4F86" || identity === "\u6211\u60F3\u4F86") {
              return {
                question: "\u4F60\u8A08\u5283\u4EC0\u9EBC\u6642\u5019\u4F86\u6F8E\u6E56\u5462\uFF1F\uFF08\u4F8B\u5982\uFF1A2025\u5E74\u590F\u5929\uFF09",
                field: "planned_period",
                next_step: "ask_travel_interests"
              };
            }
            return {
              question: null,
              field: null,
              next_step: "complete"
            };
          case "ask_local_interests":
            if (!collected.interests) {
              return {
                question: "\u4F60\u6700\u5E38\u53BB\u54EA\u4E9B\u5730\u65B9\uFF1F\u6216\u8005\u5C0D\u4EC0\u9EBC\u985E\u578B\u7684\u666F\u9EDE\u611F\u8208\u8DA3\uFF1F",
                field: "interests",
                next_step: "ask_local_knowledge"
              };
            }
            return this.generateIdentityQuestion({ ...state, current_step: "ask_local_knowledge" }, collected);
          case "ask_local_knowledge":
            if (!collected.local_knowledge) {
              return {
                question: "\u4F60\u5C0D\u6F8E\u6E56\u54EA\u500B\u5340\u57DF\u6700\u719F\u6089\uFF1F\u6709\u4EC0\u9EBC\u7279\u5225\u63A8\u85A6\u7684\u5730\u65B9\u6216\u6545\u4E8B\u60F3\u5206\u4EAB\u55CE\uFF1F",
                field: "local_knowledge",
                next_step: "ask_favorite_places"
              };
            }
            return this.generateIdentityQuestion({ ...state, current_step: "ask_favorite_places" }, collected);
          case "ask_favorite_places":
            if (!collected.favorite_places) {
              return {
                question: "\u4F60\u6700\u559C\u6B61\u6F8E\u6E56\u7684\u54EA\u4E9B\u5730\u65B9\uFF1F\u70BA\u4EC0\u9EBC\uFF1F\u6709\u4EC0\u9EBC\u7279\u5225\u7684\u56DE\u61B6\u55CE\uFF1F",
                field: "favorite_places",
                next_step: "complete"
              };
            }
            return {
              question: null,
              field: null,
              next_step: "complete"
            };
          case "ask_visited_places":
            if (!collected.visited_places) {
              return {
                question: "\u4F60\u53BB\u904E\u54EA\u4E9B\u666F\u9EDE\uFF1F\u6700\u559C\u6B61\u54EA\u500B\u5730\u65B9\uFF1F",
                field: "visited_places",
                next_step: "ask_visited_experiences"
              };
            }
            return this.generateIdentityQuestion({ ...state, current_step: "ask_visited_experiences" }, collected);
          case "ask_visited_experiences":
            if (!collected.visited_experiences) {
              return {
                question: "\u5728\u90A3\u4E9B\u5730\u65B9\u6709\u4EC0\u9EBC\u7279\u5225\u7684\u9AD4\u9A57\u6216\u56DE\u61B6\u55CE\uFF1F\u53EF\u4EE5\u5206\u4EAB\u4E00\u4E0B\u55CE\uFF1F",
                field: "visited_experiences",
                next_step: "ask_want_to_revisit"
              };
            }
            return this.generateIdentityQuestion({ ...state, current_step: "ask_want_to_revisit" }, collected);
          case "ask_want_to_revisit":
            if (collected.want_to_revisit === void 0) {
              return {
                question: "\u4F60\u9084\u60F3\u518D\u53BB\u6F8E\u6E56\u55CE\uFF1F\u5982\u679C\u6703\uFF0C\u6700\u60F3\u518D\u53BB\u54EA\u88E1\uFF1F",
                field: "want_to_revisit",
                next_step: "complete"
              };
            }
            return {
              question: null,
              field: null,
              next_step: "complete"
            };
          case "ask_travel_interests":
            if (!collected.travel_interests) {
              return {
                question: "\u4F60\u5C0D\u4EC0\u9EBC\u985E\u578B\u7684\u666F\u9EDE\u611F\u8208\u8DA3\u5462\uFF1F\uFF08\u4F8B\u5982\uFF1A\u81EA\u7136\u666F\u89C0\u3001\u6587\u5316\u53E4\u8E5F\u3001\u7F8E\u98DF\u3001\u4F4F\u5BBF\uFF09",
                field: "travel_interests",
                next_step: "ask_travel_plans"
              };
            }
            return this.generateIdentityQuestion({ ...state, current_step: "ask_travel_plans" }, collected);
          case "ask_travel_plans":
            if (!collected.travel_plans) {
              return {
                question: "\u4F60\u6709\u7279\u5225\u60F3\u4E86\u89E3\u6216\u60F3\u53BB\u7684\u5730\u65B9\u55CE\uFF1F\u6216\u8005\u6709\u4EC0\u9EBC\u7279\u5225\u60F3\u9AD4\u9A57\u7684\u6D3B\u52D5\uFF1F",
                field: "travel_plans",
                next_step: "ask_travel_questions"
              };
            }
            return this.generateIdentityQuestion({ ...state, current_step: "ask_travel_questions" }, collected);
          case "ask_travel_questions":
            if (!collected.travel_questions) {
              return {
                question: "\u95DC\u65BC\u6F8E\u6E56\uFF0C\u4F60\u6709\u4EC0\u9EBC\u7279\u5225\u60F3\u77E5\u9053\u7684\u55CE\uFF1F\u6211\u53EF\u4EE5\u5E6B\u4F60\u627E\u8CC7\u8A0A\uFF01",
                field: "travel_questions",
                next_step: "complete"
              };
            }
            return {
              question: null,
              field: null,
              next_step: "complete"
            };
          case "complete":
            return {
              question: null,
              field: null,
              next_step: "complete"
            };
          default:
            return {
              question: "\u611F\u8B1D\u60A8\uFF01\u73FE\u5728\u6211\u53EF\u4EE5\u66F4\u597D\u5730\u5354\u52A9\u60A8\u4E86\u3002\u60A8\u6709\u4EC0\u9EBC\u60F3\u4E86\u89E3\u7684\u55CE\uFF1F",
              field: null,
              next_step: "complete"
            };
        }
      }
      /**
       * 生成問問題的提示詞（旅客）
       */
      generateTravelerQuestion(state, collectedData) {
        const step = state.current_step;
        const collected = collectedData || {};
        switch (step) {
          case "start":
          case "identify_location":
            if (!collected.location_name && !collected.location_id) {
              return {
                question: "\u60A8\u60F3\u5206\u4EAB\u54EA\u500B\u5730\u9EDE\u7684\u56DE\u61B6\uFF1F\u8ACB\u544A\u8A34\u6211\u5730\u9EDE\u540D\u7A31\u3002",
                field: "location_name",
                next_step: "ask_memory"
              };
            }
            return this.generateTravelerQuestion({ ...state, current_step: "ask_memory" }, collected);
          case "ask_memory":
            if (!collected.memory_content) {
              return {
                question: "\u8ACB\u5206\u4EAB\u60A8\u5728\u300C" + (collected.location_name || "\u9019\u500B\u5730\u9EDE") + "\u300D\u7684\u56DE\u61B6\u6216\u9AD4\u9A57\u3002",
                field: "memory_content",
                next_step: "ask_companions"
              };
            }
            return this.generateTravelerQuestion({ ...state, current_step: "ask_companions" }, collected);
          case "ask_companions":
            if (!collected.companions && !collected.companions_confirmed) {
              return {
                question: "\u60A8\u7576\u6642\u548C\u8AB0\u4E00\u8D77\u53BB\u7684\uFF1F\uFF08\u4F8B\u5982\uFF1A\u5BB6\u4EBA\u3001\u670B\u53CB\u3001\u7368\u81EA\u4E00\u4EBA\uFF09",
                field: "companions",
                next_step: "ask_visited_date"
              };
            }
            return this.generateTravelerQuestion({ ...state, current_step: "ask_visited_date" }, collected);
          case "ask_visited_date":
            if (!collected.visited_date && !collected.visited_date_confirmed) {
              return {
                question: "\u60A8\u662F\u4EC0\u9EBC\u6642\u5019\u53BB\u7684\uFF1F\uFF08\u4F8B\u5982\uFF1A2024 \u5E74 7 \u6708\uFF09",
                field: "visited_date",
                next_step: "ask_revisit"
              };
            }
            return this.generateTravelerQuestion({ ...state, current_step: "ask_revisit" }, collected);
          case "ask_revisit":
            if (collected.want_to_revisit === void 0) {
              return {
                question: "\u60A8\u9084\u60F3\u518D\u53BB\u300C" + (collected.location_name || "\u9019\u500B\u5730\u9EDE") + "\u300D\u55CE\uFF1F",
                field: "want_to_revisit",
                next_step: "ask_revisit_reason"
              };
            }
            return this.generateTravelerQuestion({ ...state, current_step: "ask_revisit_reason" }, collected);
          case "ask_revisit_reason":
            if (collected.want_to_revisit && !collected.revisit_reason) {
              return {
                question: "\u70BA\u4EC0\u9EBC\u60F3\u518D\u53BB\u5462\uFF1F",
                field: "revisit_reason",
                next_step: "complete"
              };
            }
            return {
              question: null,
              field: null,
              next_step: "complete"
            };
          case "complete":
            return {
              question: null,
              field: null,
              next_step: "complete"
            };
          default:
            return {
              question: "\u611F\u8B1D\u60A8\u5206\u4EAB\u56DE\u61B6\uFF01\u9084\u6709\u5176\u4ED6\u5730\u9EDE\u60F3\u5206\u4EAB\u55CE\uFF1F",
              field: null,
              next_step: "complete"
            };
        }
      }
      /**
       * 從使用者回答中提取結構化資訊
       */
      extractStructuredInfo(userMessage, field, conversationType) {
        const message = userMessage.trim();
        const extracted = {};
        switch (field) {
          case "product_price":
            const priceMatch = message.match(/(\d+)\s*(元|塊|NT|NTD|TWD)/i) || message.match(/(\d+)/);
            if (priceMatch) {
              extracted.price = parseInt(priceMatch[1]) * 100;
              extracted.price_confirmed = true;
            } else if (message.includes("\u514D\u8CBB") || message.includes("\u4E0D\u7528\u9322")) {
              extracted.price = 0;
              extracted.price_confirmed = true;
            } else if (message.includes("\u9762\u8B70") || message.includes("\u8A62\u554F")) {
              extracted.price = null;
              extracted.price_confirmed = true;
            }
            break;
          case "product_duration":
          case "duration_minutes":
            const durationMatch = message.match(/(\d+)\s*(分鐘|分|小時|時|hr|min)/i);
            if (durationMatch) {
              const value = parseInt(durationMatch[1]);
              if (message.includes("\u5C0F\u6642") || message.includes("\u6642") || message.includes("hr")) {
                extracted.duration_minutes = value * 60;
              } else {
                extracted.duration_minutes = value;
              }
              extracted.duration_confirmed = true;
            }
            break;
          case "opening_hours":
            extracted.opening_hours = message;
            break;
          case "visited_date":
            const dateMatch = message.match(/(\d{4})\s*年\s*(\d{1,2})\s*月/i) || message.match(/(\d{4})-(\d{1,2})/);
            if (dateMatch) {
              extracted.visited_date = `${dateMatch[1]}-${dateMatch[2].padStart(2, "0")}-01`;
              extracted.visited_date_confirmed = true;
            } else {
              extracted.visited_date = message;
            }
            break;
          case "want_to_revisit":
            if (message.includes("\u60F3") || message.includes("\u6703") || message.includes("\u8981") || message.includes("\u662F") || message.toLowerCase().includes("yes")) {
              extracted.want_to_revisit = true;
            } else if (message.includes("\u4E0D\u60F3") || message.includes("\u4E0D\u6703") || message.includes("\u4E0D\u8981") || message.includes("\u4E0D") || message.toLowerCase().includes("no")) {
              extracted.want_to_revisit = false;
            }
            break;
          case "user_identity":
            const messageLower = message.toLowerCase();
            if (messageLower.includes("\u5C45\u6C11") || messageLower.includes("\u5728\u5730") || messageLower.includes("\u4F4F\u5728")) {
              extracted.user_identity = "local";
            } else if (messageLower.includes("\u4F86\u904E") || messageLower.includes("\u53BB\u904E") || messageLower.includes("\u66FE\u7D93")) {
              extracted.user_identity = "visited_traveler";
            } else if (messageLower.includes("\u60F3\u4F86") || messageLower.includes("\u8A08\u5283") || messageLower.includes("\u6253\u7B97")) {
              extracted.user_identity = "planning_traveler";
            } else if (messageLower.includes("\u65C5\u5BA2") || messageLower.includes("\u904A\u5BA2")) {
              extracted.user_identity = "traveler";
            }
            break;
          case "location_confirmed":
            if (message.includes("\u662F") || message.includes("\u5C0D") || message.includes("\u6C92\u932F") || message.toLowerCase().includes("yes")) {
              extracted.location_confirmed = true;
            } else {
              extracted.location_confirmed = false;
            }
            break;
          case "more_products":
            if (message.includes("\u5B8C\u6210") || message.includes("\u6C92\u6709") || message.includes("\u6C92\u4E86") || message.includes("\u7D50\u675F")) {
              extracted.more_products = false;
            } else {
              extracted.more_products = true;
            }
            break;
        }
        return extracted;
      }
      /**
       * 儲存收集到的固定資訊
       */
      async saveFixedInformation(informationType, data, locationId, userId, conversationId) {
        try {
          const informationKey = data.key || "default";
          const informationValue = JSON.stringify(data.value || data);
          await this.db.prepare(
            `INSERT INTO fixed_information 
         (information_type, location_id, user_id, information_key, information_value, source_conversation_id)
         VALUES (?, ?, ?, ?, ?, ?)`
          ).bind(
            informationType,
            locationId || null,
            userId || null,
            informationKey,
            informationValue,
            conversationId || null
          ).run();
          return true;
        } catch (error) {
          console.error("[AIQuestioningService] Error saving fixed information:", error);
          return false;
        }
      }
      /**
       * 儲存商家產品資訊
       */
      async saveMerchantProduct(locationId, productData, userId) {
        try {
          await this.db.prepare(
            `INSERT INTO merchant_products 
         (location_id, product_name, product_description, price, duration_minutes, category, created_by_user_id)
         VALUES (?, ?, ?, ?, ?, ?, ?)`
          ).bind(
            locationId,
            productData.name,
            productData.description || null,
            productData.price,
            productData.duration_minutes,
            productData.category || null,
            userId || null
          ).run();
          return true;
        } catch (error) {
          console.error("[AIQuestioningService] Error saving merchant product:", error);
          return false;
        }
      }
      /**
       * 儲存旅遊回憶
       */
      async saveTravelMemory(userId, locationId, memoryData) {
        try {
          const companionsJson = memoryData.companions ? JSON.stringify(memoryData.companions) : null;
          await this.db.prepare(
            `INSERT INTO travel_memories 
         (user_id, location_id, memory_content, visited_date, companions, want_to_revisit, revisit_reason, rating)
         VALUES (?, ?, ?, ?, ?, ?, ?, ?)`
          ).bind(
            userId,
            locationId,
            memoryData.content,
            memoryData.visited_date || null,
            companionsJson,
            memoryData.want_to_revisit || false,
            memoryData.revisit_reason || null,
            memoryData.rating || null
          ).run();
          return true;
        } catch (error) {
          console.error("[AIQuestioningService] Error saving travel memory:", error);
          return false;
        }
      }
    };
  }
});

// src/services/DistanceService.js
var DistanceService;
var init_DistanceService = __esm({
  "src/services/DistanceService.js"() {
    "use strict";
    DistanceService = class {
      constructor(db, googleMapsApiKey) {
        if (!db) {
          throw new Error("Database connection is required for DistanceService.");
        }
        if (!googleMapsApiKey) {
          throw new Error("Google Maps API key is required for DistanceService.");
        }
        this.db = db;
        this.apiKey = googleMapsApiKey;
        this.apiBaseUrl = "https://maps.googleapis.com/maps/api/distancematrix/json";
        this.cacheExpiryDays = 30;
      }
      /**
       * 計算兩地點之間的距離和時間
       */
      async calculateDistance(fromLocationId, toLocationId, travelMode = "driving") {
        try {
          const cached = await this.getCachedDistance(fromLocationId, toLocationId, travelMode);
          if (cached && !this.isCacheExpired(cached)) {
            console.log("[DistanceService] Using cached distance");
            return {
              distance_meters: cached.distance_meters,
              duration_seconds: cached.duration_seconds,
              distance_text: cached.distance_text,
              duration_text: cached.duration_text,
              from_cache: true
            };
          }
          const fromLocation = await this.db.prepare(
            "SELECT latitude, longitude FROM locations WHERE id = ?"
          ).bind(fromLocationId).first();
          const toLocation = await this.db.prepare(
            "SELECT latitude, longitude FROM locations WHERE id = ?"
          ).bind(toLocationId).first();
          if (!fromLocation || !toLocation) {
            throw new Error("Location not found");
          }
          const origins = `${fromLocation.latitude},${fromLocation.longitude}`;
          const destinations = `${toLocation.latitude},${toLocation.longitude}`;
          const url = `${this.apiBaseUrl}?origins=${encodeURIComponent(origins)}&destinations=${encodeURIComponent(destinations)}&mode=${travelMode}&language=zh-TW&key=${this.apiKey}`;
          console.log("[DistanceService] Calling Google Maps Distance Matrix API");
          const response = await fetch(url);
          const data = await response.json();
          if (data.status !== "OK" || !data.rows || !data.rows[0] || !data.rows[0].elements || !data.rows[0].elements[0]) {
            console.error("[DistanceService] API error:", data);
            throw new Error(`Distance Matrix API error: ${data.status}`);
          }
          const element = data.rows[0].elements[0];
          if (element.status !== "OK") {
            throw new Error(`Distance calculation failed: ${element.status}`);
          }
          const result = {
            distance_meters: element.distance.value,
            duration_seconds: element.duration.value,
            distance_text: element.distance.text,
            duration_text: element.duration.text,
            from_cache: false
          };
          await this.cacheDistance(fromLocationId, toLocationId, travelMode, result);
          return result;
        } catch (error) {
          console.error("[DistanceService] Error calculating distance:", error);
          throw error;
        }
      }
      /**
       * 獲取快取的距離資訊
       */
      async getCachedDistance(fromLocationId, toLocationId, travelMode) {
        try {
          const cached = await this.db.prepare(
            `SELECT * FROM location_distances 
         WHERE from_location_id = ? AND to_location_id = ? AND travel_mode = ?`
          ).bind(fromLocationId, toLocationId, travelMode).first();
          return cached;
        } catch (error) {
          console.error("[DistanceService] Error getting cached distance:", error);
          return null;
        }
      }
      /**
       * 快取距離資訊
       */
      async cacheDistance(fromLocationId, toLocationId, travelMode, result) {
        try {
          const expiresAt = /* @__PURE__ */ new Date();
          expiresAt.setDate(expiresAt.getDate() + this.cacheExpiryDays);
          await this.db.prepare(
            `INSERT OR REPLACE INTO location_distances 
         (from_location_id, to_location_id, distance_meters, duration_seconds, 
          distance_text, duration_text, travel_mode, expires_at)
         VALUES (?, ?, ?, ?, ?, ?, ?, ?)`
          ).bind(
            fromLocationId,
            toLocationId,
            result.distance_meters,
            result.duration_seconds,
            result.distance_text,
            result.duration_text,
            travelMode,
            expiresAt.toISOString()
          ).run();
          return true;
        } catch (error) {
          console.error("[DistanceService] Error caching distance:", error);
          return false;
        }
      }
      /**
       * 檢查快取是否過期
       */
      isCacheExpired(cached) {
        if (!cached.expires_at) {
          return true;
        }
        const expiresAt = new Date(cached.expires_at);
        return expiresAt < /* @__PURE__ */ new Date();
      }
      /**
       * 從查詢中識別地點並計算距離
       */
      async calculateDistanceFromQuery(query, locationService) {
        try {
          const patterns = [
            /從\s*([^到]+)\s*到\s*([^的]+)/,
            /([^到]+)\s*到\s*([^的距離]+)\s*的距離/,
            /([^到]+)\s*到\s*([^多久]+)\s*多久/
          ];
          let fromName = null;
          let toName = null;
          for (const pattern of patterns) {
            const match2 = query.match(pattern);
            if (match2) {
              fromName = match2[1].trim();
              toName = match2[2].trim();
              break;
            }
          }
          if (!fromName || !toName) {
            return null;
          }
          const fromLocation = await this.db.prepare(
            "SELECT id FROM locations WHERE name LIKE ? LIMIT 1"
          ).bind(`%${fromName}%`).first();
          const toLocation = await this.db.prepare(
            "SELECT id FROM locations WHERE name LIKE ? LIMIT 1"
          ).bind(`%${toName}%`).first();
          if (!fromLocation || !toLocation) {
            return null;
          }
          return await this.calculateDistance(fromLocation.id, toLocation.id);
        } catch (error) {
          console.error("[DistanceService] Error calculating distance from query:", error);
          return null;
        }
      }
    };
  }
});

// src/services/QuestionAnalysisService.js
var QuestionAnalysisService;
var init_QuestionAnalysisService = __esm({
  "src/services/QuestionAnalysisService.js"() {
    "use strict";
    QuestionAnalysisService = class {
      constructor(db) {
        if (!db) {
          throw new Error("Database connection is required for QuestionAnalysisService.");
        }
        this.db = db;
      }
      /**
       * 分析用戶問題
       * @param {string} userQuestion - 用戶問題
       * @param {string} conversationId - 對話ID
       * @param {number} answerQuality - 答案品質分數（0-1），可選
       * @param {string} contextType - 上下文類型（'local', 'visited_traveler', 'planning_traveler', 'merchant'）
       * @returns {Promise<Object>} 分析結果
       */
      async analyzeUserQuestion(userQuestion, conversationId = null, answerQuality = null, contextType = null) {
        try {
          const analysis = {
            question_type: "user_query",
            category: this.categorizeQuestion(userQuestion),
            intent: this.extractIntent(userQuestion),
            entities: this.extractEntities(userQuestion),
            quality_score: 0,
            clarity: this.assessClarity(userQuestion),
            specificity: this.assessSpecificity(userQuestion),
            completeness: this.assessCompleteness(userQuestion),
            structure: this.assessStructure(userQuestion)
          };
          analysis.quality_score = this.calculateQualityScore(analysis);
          if (answerQuality !== null) {
            analysis.led_to_successful_answer = answerQuality > 0.7;
            analysis.answer_quality_score = answerQuality;
          }
          const savedId = await this.saveQuestionLearning(
            analysis,
            userQuestion,
            conversationId,
            contextType
          );
          analysis.id = savedId;
          return analysis;
        } catch (error) {
          console.error("[QuestionAnalysisService] Error analyzing user question:", error);
          throw error;
        }
      }
      /**
       * 分析AI問的問題
       * @param {string} aiQuestion - AI問題
       * @param {Object} context - 上下文資訊
       * @param {string} userResponse - 用戶回應（可選）
       * @param {string} conversationId - 對話ID
       * @returns {Promise<Object>} 分析結果
       */
      async analyzeAIQuestion(aiQuestion, context = {}, userResponse = null, conversationId = null) {
        try {
          const analysis = {
            question_type: "ai_question",
            category: this.categorizeQuestion(aiQuestion),
            intent: this.extractIntent(aiQuestion),
            clarity: this.assessClarity(aiQuestion),
            specificity: this.assessSpecificity(aiQuestion),
            completeness: this.assessCompleteness(aiQuestion),
            context_appropriateness: this.assessContextAppropriateness(aiQuestion, context)
          };
          if (userResponse) {
            analysis.effectiveness = this.assessEffectiveness(aiQuestion, userResponse);
            analysis.led_to_successful_answer = analysis.effectiveness > 0.7;
            analysis.effectiveness_score = analysis.effectiveness;
          }
          analysis.quality_score = this.calculateQualityScore(analysis);
          const savedId = await this.saveQuestionLearning(
            analysis,
            aiQuestion,
            conversationId,
            context.contextType || null
          );
          analysis.id = savedId;
          return analysis;
        } catch (error) {
          console.error("[QuestionAnalysisService] Error analyzing AI question:", error);
          throw error;
        }
      }
      /**
       * 分類問題類型
       * @param {string} question - 問題
       * @returns {string} 問題類別
       */
      categorizeQuestion(question) {
        const q = question.toLowerCase();
        if (q.includes("\u54EA\u88E1") || q.includes("\u5730\u9EDE") || q.includes("\u4F4D\u7F6E") || q.includes("\u5728\u54EA") || q.includes("\u4EC0\u9EBC\u5730\u65B9")) {
          return "location";
        }
        if (q.includes("\u50F9\u683C") || q.includes("\u591A\u5C11\u9322") || q.includes("\u8CBB\u7528") || q.includes("\u6D88\u8CBB") || q.includes("\u50F9\u9322")) {
          return "price";
        }
        if (q.includes("\u6642\u9593") || q.includes("\u591A\u4E45") || q.includes("\u5E7E\u9EDE") || q.includes("\u71DF\u696D") || q.includes("\u4F55\u6642")) {
          return "time";
        }
        if (q.includes("\u8DDD\u96E2") || q.includes("\u591A\u9060") || q.includes("\u600E\u9EBC\u53BB") || q.includes("\u8DEF\u7DDA")) {
          return "distance";
        }
        if (q.includes("\u56DE\u61B6") || q.includes("\u9AD4\u9A57") || q.includes("\u611F\u53D7") || q.includes("\u5206\u4EAB") || q.includes("\u53BB\u904E")) {
          return "memory";
        }
        if (q.includes("\u8EAB\u4EFD") || q.includes("\u662F") || q.includes("\u5C45\u6C11") || q.includes("\u65C5\u5BA2") || q.includes("\u5546\u5BB6")) {
          return "identity";
        }
        return "general";
      }
      /**
       * 提取意圖
       * @param {string} question - 問題
       * @returns {string} 意圖
       */
      extractIntent(question) {
        const intents = {
          "\u67E5\u8A62": ["\u67E5", "\u627E", "\u641C\u5C0B", "\u60F3\u77E5\u9053", "\u554F", "\u4E86\u89E3"],
          "\u78BA\u8A8D": ["\u662F", "\u5C0D", "\u78BA\u8A8D", "\u6C92\u932F", "\u6B63\u78BA"],
          "\u5206\u4EAB": ["\u5206\u4EAB", "\u544A\u8A34", "\u63D0\u4F9B", "\u7D66", "\u8AAA"],
          "\u6BD4\u8F03": ["\u6BD4\u8F03", "\u54EA\u500B", "\u66F4\u597D", "\u63A8\u85A6", "\u9078\u64C7"],
          "\u8ACB\u6C42": ["\u8ACB", "\u5E6B", "\u80FD\u5426", "\u53EF\u4EE5", "\u80FD\u4E0D\u80FD"]
        };
        const q = question.toLowerCase();
        for (const [intent, keywords] of Object.entries(intents)) {
          if (keywords.some((kw) => q.includes(kw))) {
            return intent;
          }
        }
        return "unknown";
      }
      /**
       * 提取實體（地點、時間、人物等）
       * @param {string} question - 問題
       * @returns {Object} 實體物件
       */
      extractEntities(question) {
        const entities = {
          locations: [],
          time_periods: [],
          numbers: [],
          people: []
        };
        const numberMatches = question.match(/\d+/g);
        if (numberMatches) {
          entities.numbers = numberMatches.map((n) => parseInt(n));
        }
        const timeKeywords = ["\u5E74", "\u6708", "\u65E5", "\u5C0F\u6642", "\u5206\u9418", "\u65E9\u4E0A", "\u4E0B\u5348", "\u665A\u4E0A", "\u5B63\u7BC0"];
        const timeMatches = question.match(new RegExp(`[\\u4e00-\\u9fa5]*[${timeKeywords.join("|")}][\\u4e00-\\u9fa5]*`, "g"));
        if (timeMatches) {
          entities.time_periods = timeMatches;
        }
        return entities;
      }
      /**
       * 計算問題品質分數
       * @param {Object} analysis - 分析結果
       * @returns {number} 品質分數（0-1）
       */
      calculateQualityScore(analysis) {
        let score = 0.5;
        if (analysis.clarity !== void 0) {
          score += analysis.clarity * 0.3;
        }
        if (analysis.specificity !== void 0) {
          score += analysis.specificity * 0.3;
        }
        if (analysis.completeness !== void 0) {
          score += analysis.completeness * 0.2;
        }
        if (analysis.structure !== void 0) {
          score += analysis.structure * 0.2;
        }
        return Math.min(score, 1);
      }
      /**
       * 評估清晰度
       * @param {string} question - 問題
       * @returns {number} 清晰度分數（0-1）
       */
      assessClarity(question) {
        const unclearPatterns = ["\u90A3\u500B", "\u9019\u500B", "\u90A3\u500B\u5730\u65B9", "\u67D0\u500B", "\u67D0\u8655"];
        const hasUnclear = unclearPatterns.some((pattern) => question.includes(pattern));
        const length = question.length;
        const tooShort = length < 5;
        const tooLong = length > 200;
        let score = 1;
        if (hasUnclear)
          score -= 0.3;
        if (tooShort)
          score -= 0.2;
        if (tooLong)
          score -= 0.1;
        return Math.max(score, 0);
      }
      /**
       * 評估具體性
       * @param {string} question - 問題
       * @returns {number} 具體性分數（0-1）
       */
      assessSpecificity(question) {
        var _a;
        const specificIndicators = ["\u54EA\u500B", "\u4EC0\u9EBC", "\u591A\u5C11", "\u4F55\u6642", "\u54EA\u88E1", "\u8AB0", "\u5982\u4F55", "\u70BA\u4EC0\u9EBC"];
        const hasSpecific = specificIndicators.some((indicator) => question.includes(indicator));
        const hasLocation = ((_a = question.match(/[\u4e00-\u9fa5]{2,}/g)) == null ? void 0 : _a.length) > 0;
        const hasNumber = /\d+/.test(question);
        let score = 0.5;
        if (hasSpecific)
          score += 0.2;
        if (hasLocation)
          score += 0.2;
        if (hasNumber)
          score += 0.1;
        return Math.min(score, 1);
      }
      /**
       * 評估完整性
       * @param {string} question - 問題
       * @returns {number} 完整性分數（0-1）
       */
      assessCompleteness(question) {
        const hasContext = question.length > 10;
        const hasQuestionMark = question.includes("\uFF1F") || question.includes("?");
        const hasSubject = question.length > 5;
        let score = 0.5;
        if (hasContext)
          score += 0.2;
        if (hasQuestionMark)
          score += 0.2;
        if (hasSubject)
          score += 0.1;
        return Math.min(score, 1);
      }
      /**
       * 評估結構性
       * @param {string} question - 問題
       * @returns {number} 結構性分數（0-1）
       */
      assessStructure(question) {
        const hasQuestionWord = /(什麼|哪裡|哪個|多少|何時|怎麼|為什麼|如何)/.test(question);
        const isCompleteSentence = question.length > 5 && (question.includes("\uFF1F") || question.includes("?"));
        const hasProperFormat = !question.startsWith("\uFF1F") && !question.endsWith("\uFF1F") || question.includes("\uFF1F");
        let score = 0.5;
        if (hasQuestionWord)
          score += 0.3;
        if (isCompleteSentence)
          score += 0.2;
        if (hasProperFormat)
          score += 0.1;
        return Math.min(score, 1);
      }
      /**
       * 評估上下文適切性（AI問題）
       * @param {string} question - AI問題
       * @param {Object} context - 上下文
       * @returns {number} 適切性分數（0-1）
       */
      assessContextAppropriateness(question, context) {
        let score = 0.7;
        if (context.location_name && question.includes(context.location_name)) {
          score += 0.2;
        }
        if (context.userType) {
          const isAppropriate = this.checkQuestionAppropriateness(question, context.userType);
          if (isAppropriate)
            score += 0.1;
        }
        return Math.min(score, 1);
      }
      /**
       * 檢查問題是否適合用戶類型
       * @param {string} question - 問題
       * @param {string} userType - 用戶類型
       * @returns {boolean} 是否適合
       */
      checkQuestionAppropriateness(question, userType) {
        const q = question.toLowerCase();
        if (userType === "merchant") {
          return q.includes("\u5546\u5BB6") || q.includes("\u71DF\u696D") || q.includes("\u7522\u54C1") || q.includes("\u50F9\u683C");
        } else if (userType === "local") {
          return q.includes("\u5C45\u4F4F") || q.includes("\u5340\u57DF") || q.includes("\u5728\u5730");
        } else if (userType === "traveler") {
          return q.includes("\u65C5\u904A") || q.includes("\u666F\u9EDE") || q.includes("\u56DE\u61B6") || q.includes("\u9AD4\u9A57");
        }
        return true;
      }
      /**
       * 評估問題有效性（AI問的問題是否獲得有效回答）
       * @param {string} aiQuestion - AI問題
       * @param {string} userResponse - 用戶回應
       * @returns {number} 有效性分數（0-1）
       */
      assessEffectiveness(aiQuestion, userResponse) {
        const responseLength = userResponse.length;
        const isComplete = responseLength > 5;
        const isRelevant = this.checkRelevance(aiQuestion, userResponse);
        const isInformative = responseLength > 10;
        let score = 0.5;
        if (isComplete)
          score += 0.2;
        if (isRelevant)
          score += 0.2;
        if (isInformative)
          score += 0.1;
        return Math.min(score, 1);
      }
      /**
       * 檢查相關性
       * @param {string} question - 問題
       * @param {string} response - 回應
       * @returns {boolean} 是否相關
       */
      checkRelevance(question, response) {
        const questionKeywords = this.extractKeywords(question);
        const responseKeywords = this.extractKeywords(response);
        if (questionKeywords.length === 0)
          return true;
        const commonKeywords = questionKeywords.filter((kw) => responseKeywords.includes(kw));
        return commonKeywords.length > 0;
      }
      /**
       * 提取關鍵字
       * @param {string} text - 文字
       * @returns {Array<string>} 關鍵字陣列
       */
      extractKeywords(text) {
        const chineseWords = text.match(/[\u4e00-\u9fa5]{2,}/g) || [];
        return chineseWords;
      }
      /**
       * 儲存問題學習記錄
       * @param {Object} analysis - 分析結果
       * @param {string} originalQuestion - 原始問題
       * @param {string} conversationId - 對話ID
       * @param {string} contextType - 上下文類型
       * @returns {Promise<string>} 儲存的記錄ID
       */
      async saveQuestionLearning(analysis, originalQuestion, conversationId = null, contextType = null) {
        try {
          const result = await this.db.prepare(
            `INSERT INTO ai_question_learning (
          original_question, question_type, question_category,
          extracted_intent, extracted_entities, question_quality_score,
          led_to_successful_answer, answer_quality_score,
          conversation_id, context_type,
          clarity_score, specificity_score, completeness_score, effectiveness_score
        ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)`
          ).bind(
            originalQuestion,
            analysis.question_type,
            analysis.category || "general",
            JSON.stringify(analysis.intent || "unknown"),
            JSON.stringify(analysis.entities || {}),
            analysis.quality_score || 0,
            analysis.led_to_successful_answer || false,
            analysis.answer_quality_score || null,
            conversationId,
            contextType,
            analysis.clarity || 0,
            analysis.specificity || 0,
            analysis.completeness || 0,
            analysis.effectiveness_score || analysis.effectiveness || 0
          ).run();
          return result.meta.last_row_id ? String(result.meta.last_row_id) : null;
        } catch (error) {
          console.error("[QuestionAnalysisService] Error saving question learning:", error);
          throw error;
        }
      }
      /**
       * 從學習記錄中提取問題模板
       * @param {number} minSuccessRate - 最低成功率（0-1）
       * @param {number} minQualityScore - 最低品質分數（0-1）
       * @returns {Promise<Array>} 提取的模板陣列
       */
      async extractQuestionTemplates(minSuccessRate = 0.7, minQualityScore = 0.7) {
        var _a;
        try {
          const successfulQuestions = await this.db.prepare(
            `SELECT original_question, question_category, context_type, 
                question_quality_score, led_to_successful_answer
         FROM ai_question_learning
         WHERE led_to_successful_answer = true 
           AND question_quality_score >= ?
         ORDER BY question_quality_score DESC
         LIMIT 100`
          ).bind(minQualityScore).all();
          const templates = [];
          const templateMap = /* @__PURE__ */ new Map();
          for (const q of successfulQuestions.results || []) {
            const template = this.createTemplateFromQuestion(
              q.original_question,
              q.question_category,
              q.context_type
            );
            if (template) {
              const key = `${template.template_type}_${template.context_type || "general"}`;
              if (!templateMap.has(key)) {
                templateMap.set(key, {
                  ...template,
                  success_count: 1,
                  total_quality: template.quality_score || 0
                });
              } else {
                const existing = templateMap.get(key);
                existing.success_count += 1;
                existing.total_quality += template.quality_score || 0;
              }
            }
          }
          for (const [key, template] of templateMap.entries()) {
            const successRate = template.success_count / (((_a = successfulQuestions.results) == null ? void 0 : _a.length) || 1);
            const avgQuality = template.total_quality / template.success_count;
            if (successRate >= minSuccessRate) {
              templates.push({
                template_text: template.template_text,
                template_type: template.template_type,
                context_type: template.context_type,
                variables: template.variables,
                success_rate: successRate,
                average_question_quality: avgQuality
              });
            }
          }
          for (const template of templates) {
            await this.saveQuestionTemplate(template);
          }
          return templates;
        } catch (error) {
          console.error("[QuestionAnalysisService] Error extracting templates:", error);
          throw error;
        }
      }
      /**
       * 從問題創建模板
       * @param {string} question - 問題
       * @param {string} category - 問題類別
       * @param {string} contextType - 上下文類型
       * @returns {Object} 模板物件
       */
      createTemplateFromQuestion(question, category, contextType = null) {
        let templateText = question;
        const variables = [];
        if (category === "location" || category === "price" || category === "time") {
        }
        if (question.includes("\u4EC0\u9EBC\u6642\u5019") || question.includes("\u4F55\u6642")) {
          variables.push("time_period");
        }
        if (question.includes("\u54EA\u88E1") || question.includes("\u54EA\u500B\u5730\u65B9")) {
          variables.push("location_name");
        }
        return {
          template_text: templateText,
          template_type: category,
          context_type: contextType,
          variables,
          quality_score: 0.8
          // 預設品質分數
        };
      }
      /**
       * 儲存問題模板
       * @param {Object} template - 模板物件
       * @returns {Promise<string>} 模板ID
       */
      async saveQuestionTemplate(template) {
        try {
          const existing = await this.db.prepare(
            `SELECT id, usage_count, success_rate, average_question_quality
         FROM ai_question_templates 
         WHERE template_text = ? AND template_type = ? AND (context_type = ? OR (context_type IS NULL AND ? IS NULL))`
          ).bind(
            template.template_text,
            template.template_type,
            template.context_type || null,
            template.context_type || null
          ).first();
          if (existing) {
            const newUsageCount = existing.usage_count + 1;
            const newSuccessRate = (existing.success_rate * existing.usage_count + template.success_rate) / newUsageCount;
            const newAvgQuality = (existing.average_question_quality * existing.usage_count + template.average_question_quality) / newUsageCount;
            await this.db.prepare(
              `UPDATE ai_question_templates 
           SET usage_count = ?,
               success_rate = ?,
               average_question_quality = ?,
               updated_at = CURRENT_TIMESTAMP
           WHERE id = ?`
            ).bind(newUsageCount, newSuccessRate, newAvgQuality, existing.id).run();
            return existing.id;
          } else {
            const result = await this.db.prepare(
              `INSERT INTO ai_question_templates (
            template_text, template_type, context_type, variables, 
            success_rate, usage_count, average_question_quality
          ) VALUES (?, ?, ?, ?, ?, ?, ?)`
            ).bind(
              template.template_text,
              template.template_type,
              template.context_type || null,
              JSON.stringify(template.variables || []),
              template.success_rate || 0,
              1,
              template.average_question_quality || 0
            ).run();
            return result.meta.last_row_id ? String(result.meta.last_row_id) : null;
          }
        } catch (error) {
          console.error("[QuestionAnalysisService] Error saving template:", error);
          throw error;
        }
      }
      /**
       * 獲取最佳問題模板
       * @param {string} category - 問題類別
       * @param {string} contextType - 上下文類型（可選）
       * @returns {Promise<Object|null>} 最佳模板
       */
      async getBestQuestionTemplate(category, contextType = null) {
        try {
          let query = `SELECT * FROM ai_question_templates 
                   WHERE template_type = ? AND is_active = true`;
          const params = [category];
          if (contextType) {
            query += ` AND (context_type = ? OR context_type IS NULL)`;
            params.push(contextType);
          }
          query += ` ORDER BY success_rate DESC, average_question_quality DESC, usage_count DESC LIMIT 1`;
          const result = await this.db.prepare(query).bind(...params).first();
          return result;
        } catch (error) {
          console.error("[QuestionAnalysisService] Error getting best template:", error);
          return null;
        }
      }
      /**
       * 改進問題
       * @param {string} originalQuestion - 原始問題
       * @param {Object} context - 上下文
       * @returns {Promise<string>} 改進後的問題
       */
      async improveQuestion(originalQuestion, context) {
        try {
          const analysis = await this.analyzeUserQuestion(originalQuestion, null, null, context.contextType);
          const bestTemplate = await this.getBestQuestionTemplate(analysis.category, context.contextType);
          if (bestTemplate) {
            const improved = this.applyTemplate(bestTemplate, context);
            await this.recordImprovement(analysis.id, originalQuestion, improved, analysis);
            return improved;
          }
          return originalQuestion;
        } catch (error) {
          console.error("[QuestionAnalysisService] Error improving question:", error);
          return originalQuestion;
        }
      }
      /**
       * 應用模板
       * @param {Object} template - 模板物件
       * @param {Object} context - 上下文
       * @returns {string} 應用模板後的問題
       */
      applyTemplate(template, context) {
        let question = template.template_text;
        const variables = JSON.parse(template.variables || "[]");
        for (const variable of variables) {
          if (context[variable]) {
            question = question.replace(`{${variable}}`, context[variable]);
          }
        }
        return question;
      }
      /**
       * 記錄改進
       * @param {string} originalQuestionId - 原始問題ID
       * @param {string} originalQuestion - 原始問題
       * @param {string} improvedQuestion - 改進後的問題
       * @param {Object} analysis - 分析結果
       * @returns {Promise<void>}
       */
      async recordImprovement(originalQuestionId, originalQuestion, improvedQuestion, analysis) {
        try {
          if (!originalQuestionId)
            return;
          await this.db.prepare(
            `INSERT INTO ai_question_improvements (
          original_question_id, improved_question, improvement_reason,
          improvement_type, before_score, after_score
        ) VALUES (?, ?, ?, ?, ?, ?)`
          ).bind(
            originalQuestionId,
            improvedQuestion,
            "Applied best template from learning",
            "structure",
            analysis.quality_score || 0,
            (analysis.quality_score || 0) + 0.1
            // 假設改進後分數提升
          ).run();
        } catch (error) {
          console.error("[QuestionAnalysisService] Error recording improvement:", error);
        }
      }
      /**
       * 評估答案品質（簡單版本）
       * @param {string} answer - 答案
       * @param {string} question - 問題
       * @returns {number} 品質分數（0-1）
       */
      evaluateAnswerQuality(answer, question) {
        if (!answer || answer.length < 5)
          return 0.2;
        let score = 0.5;
        if (answer.length > 20)
          score += 0.2;
        if (answer.length > 50)
          score += 0.1;
        const questionKeywords = this.extractKeywords(question);
        const answerKeywords = this.extractKeywords(answer);
        const commonKeywords = questionKeywords.filter((kw) => answerKeywords.includes(kw));
        if (commonKeywords.length > 0)
          score += 0.2;
        return Math.min(score, 1);
      }
    };
  }
});

// src/services/AIKnowledgeService.js
var AIKnowledgeService;
var init_AIKnowledgeService = __esm({
  "src/services/AIKnowledgeService.js"() {
    "use strict";
    AIKnowledgeService = class {
      constructor(db) {
        if (!db) {
          throw new Error("Database connection is required for AIKnowledgeService.");
        }
        this.db = db;
      }
      /**
       * 分析使用者訊息並提取有價值的資訊
       * @param {string} userMessage - 使用者訊息
       * @param {string} aiResponse - AI 回應 (可選，用於輔助上下文)
       * @returns {Object|null} 提取的資訊或 null
       */
      async extractKnowledge(userMessage, aiResponse = null) {
        const valueKeywords = [
          "\u63A8\u85A6",
          "\u597D\u7403",
          "\u597D\u5403",
          "\u5FC5\u53BB",
          "\u79C1\u623F",
          "\u7955\u5883",
          "\u79D8\u5883",
          "\u6545\u4E8B",
          "\u6B77\u53F2",
          "\u807D\u8AAA",
          "\u5728\u5730\u4EBA",
          "\u5C0F\u6642\u5019",
          "\u56DE\u61B6"
        ];
        const hasValue = valueKeywords.some((keyword) => userMessage.includes(keyword));
        if (!hasValue && userMessage.length < 10) {
          return null;
        }
        return {
          hasPotentialValue: hasValue,
          category: this.detectCategory(userMessage)
        };
      }
      /**
       * 判斷內容分類
       */
      detectCategory(message) {
        const foodKeywords = ["\u5403", "\u559D", "\u9910\u5EF3", "\u7F8E\u98DF", "\u5C0F\u5403", "\u5473", "\u9910"];
        const spotKeywords = ["\u53BB", "\u73A9", "\u666F\u9EDE", "\u770B", "\u6D77", "\u5CF6", "\u5C71", "\u5EDF"];
        const storyKeywords = ["\u6545\u4E8B", "\u6B77\u53F2", "\u50B3\u8AAA", "\u4EE5\u524D", "\u53E4\u65E9", "\u807D\u8AAA"];
        if (foodKeywords.some((k) => message.includes(k)))
          return "food";
        if (spotKeywords.some((k) => message.includes(k)))
          return "spot";
        if (storyKeywords.some((k) => message.includes(k)))
          return "story";
        return "general";
      }
      /**
       * 儲存使用者貢獻
       */
      async saveContribution(userId, sessionId, content, extractedData = null, category = "general") {
        try {
          const result = await this.db.prepare(
            `INSERT INTO user_knowledge_contributions (user_id, session_id, content, extracted_data, category, status)
         VALUES (?, ?, ?, ?, ?, 'pending')`
          ).bind(
            userId || null,
            sessionId,
            content,
            extractedData ? JSON.stringify(extractedData) : null,
            category
          ).run();
          console.log("[AIKnowledgeService] Saved contribution:", result.meta.last_row_id);
          return result.meta.last_row_id;
        } catch (error) {
          console.error("[AIKnowledgeService] Error saving contribution:", error);
          return null;
        }
      }
      /**
       * 標記有價值的對話 (由 AIService 呼叫)
       */
      async processInteraction(userId, sessionId, userMessage) {
        const extraction = await this.extractKnowledge(userMessage);
        if (extraction && extraction.hasPotentialValue) {
          await this.saveContribution(
            userId,
            sessionId,
            userMessage,
            extraction,
            extraction.category
          );
        }
      }
      /**
       * 獲取待審核的貢獻
       */
      async getPendingContributions(limit = 20, offset = 0) {
        try {
          const results = await this.db.prepare(
            `SELECT * FROM user_knowledge_contributions 
                 WHERE status = 'pending' 
                 ORDER BY created_at DESC 
                 LIMIT ? OFFSET ?`
          ).bind(limit, offset).all();
          const countResult = await this.db.prepare(
            `SELECT COUNT(*) as total FROM user_knowledge_contributions WHERE status = 'pending'`
          ).first();
          return {
            contributions: results.results || [],
            total: countResult ? countResult.total : 0
          };
        } catch (error) {
          console.error("[AIKnowledgeService] Error getting pending contributions:", error);
          return { contributions: [], total: 0 };
        }
      }
      /**
       * 批准貢獻
       */
      async approveContribution(id) {
        try {
          const result = await this.db.prepare(
            `UPDATE user_knowledge_contributions 
                 SET status = 'approved', updated_at = CURRENT_TIMESTAMP 
                 WHERE id = ?`
          ).bind(id).run();
          return result.success;
        } catch (error) {
          console.error("[AIKnowledgeService] Error approving contribution:", error);
          return false;
        }
      }
      /**
       * 拒絕貢獻
       */
      async rejectContribution(id) {
        try {
          const result = await this.db.prepare(
            `UPDATE user_knowledge_contributions 
                 SET status = 'rejected', updated_at = CURRENT_TIMESTAMP 
                 WHERE id = ?`
          ).bind(id).run();
          return result.success;
        } catch (error) {
          console.error("[AIKnowledgeService] Error rejecting contribution:", error);
          return false;
        }
      }
      /**
       * 搜尋已批准的知識 (RAG)
       * @param {string} query - 使用者查詢
       * @returns {Array} - 相關知識列表
       */
      async searchApprovedKnowledge(query) {
        if (!query)
          return [];
        try {
          const stopWords = ["\u7684", "\u4E86", "\u662F", "\u6211", "\u4F60", "\u4ED6", "\u5728", "\u6709", "\u53BB", "\u55CE", "\u751A\u9EBC", "\u4EC0\u9EBC", "\u6F8E\u6E56"];
          let keywords = query.split(/[\s,，.。!！?？]+/).filter((k) => k.length > 1 && !stopWords.includes(k));
          if (keywords.length === 0) {
            if (query.length > 4)
              keywords = [query];
            else
              return [];
          }
          const conditions = keywords.map(() => `content LIKE ?`).join(" OR ");
          const bindParams = keywords.map((k) => `%${k}%`);
          const sql = `
                SELECT content, category, user_id, created_at 
                FROM user_knowledge_contributions 
                WHERE status = 'approved' 
                AND (${conditions})
                ORDER BY created_at DESC 
                LIMIT 5
            `;
          const results = await this.db.prepare(sql).bind(...bindParams).all();
          return results.results || [];
        } catch (error) {
          console.error("[AIKnowledgeService] Error searching knowledge:", error);
          return [];
        }
      }
    };
  }
});

// src/services/RelationshipDepthService.js
var RelationshipDepthService;
var init_RelationshipDepthService = __esm({
  "src/services/RelationshipDepthService.js"() {
    "use strict";
    RelationshipDepthService = class {
      constructor(db) {
        if (!db) {
          throw new Error("Database connection is required for RelationshipDepthService.");
        }
        this.db = db;
      }
      /**
       * 計算關係深度（0-100）
       * 根據核心模型的公式：
       * - 對話輪次貢獻 (40%)
       * - 資訊完整度 (30%)
       * - 偏好明確度 (20%)
       * - 回訪次數 (10%)
       */
      async calculateRelationshipDepth(userId, sessionId) {
        try {
          const conversationState = await this.db.prepare(
            `SELECT * FROM ai_conversation_states 
         WHERE session_id = ? AND (user_id = ? OR (user_id IS NULL AND ? IS NULL))
         ORDER BY updated_at DESC LIMIT 1`
          ).bind(sessionId, userId || null, userId || null).first();
          if (!conversationState) {
            return {
              relationshipDepth: 0,
              stage: "initial",
              totalRounds: 0
            };
          }
          const totalRounds = conversationState.total_rounds || 0;
          const contextData = conversationState.context_data ? JSON.parse(conversationState.context_data) : {};
          const collectedData = conversationState.collected_data ? JSON.parse(conversationState.collected_data) : {};
          const roundsScore = Math.min(totalRounds * 2, 40);
          const identityFields = ["user_identity", "region", "interests", "visit_period", "planned_period"];
          const filledFields = identityFields.filter((field) => collectedData[field] && collectedData[field].trim() !== "").length;
          const profileCompleteness = filledFields / identityFields.length;
          const completenessScore = profileCompleteness * 30;
          let preferenceCount = 0;
          if (collectedData.interests) {
            if (typeof collectedData.interests === "string") {
              try {
                const parsed = JSON.parse(collectedData.interests);
                preferenceCount = Array.isArray(parsed) ? parsed.length : 1;
              } catch {
                preferenceCount = collectedData.interests.split(",").filter((i) => i.trim()).length;
              }
            } else if (Array.isArray(collectedData.interests)) {
              preferenceCount = collectedData.interests.length;
            } else {
              preferenceCount = 1;
            }
          }
          const preferenceScore = Math.min(preferenceCount * 4, 20);
          let revisitCount = 0;
          if (userId) {
            try {
              const user = await this.db.prepare(
                "SELECT visit_count FROM users WHERE id = ?"
              ).bind(userId).first();
              revisitCount = (user == null ? void 0 : user.visit_count) || 0;
            } catch (error) {
              console.warn("[RelationshipDepthService] Error getting revisit count:", error);
            }
          }
          const revisitScore = Math.min(revisitCount * 2, 10);
          const relationshipDepth = Math.min(
            roundsScore + completenessScore + preferenceScore + revisitScore,
            100
          );
          const stage = this.getConversationStage(relationshipDepth);
          return {
            relationshipDepth: Math.round(relationshipDepth * 10) / 10,
            // 保留一位小數
            stage,
            totalRounds,
            scores: {
              rounds: roundsScore,
              completeness: completenessScore,
              preference: preferenceScore,
              revisit: revisitScore
            }
          };
        } catch (error) {
          console.error("[RelationshipDepthService] Error calculating relationship depth:", error);
          return {
            relationshipDepth: 0,
            stage: "initial",
            totalRounds: 0
          };
        }
      }
      /**
       * 根據關係深度獲取對話階段
       */
      getConversationStage(relationshipDepth) {
        if (relationshipDepth < 20) {
          return "initial";
        } else if (relationshipDepth < 50) {
          return "getting_to_know";
        } else if (relationshipDepth < 75) {
          return "familiar";
        } else {
          return "friend";
        }
      }
      /**
       * 獲取或創建用戶關係檔案
       */
      async getOrCreateRelationshipProfile(userId, sessionId) {
        try {
          let profile = await this.db.prepare(
            `SELECT * FROM user_relationship_profiles 
         WHERE user_id = ? AND (session_id = ? OR (session_id IS NULL AND ? IS NULL))
         ORDER BY updated_at DESC LIMIT 1`
          ).bind(userId || null, sessionId || null, sessionId || null).first();
          if (!profile) {
            const profileId = `profile_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
            await this.db.prepare(
              `INSERT INTO user_relationship_profiles 
           (id, user_id, session_id, relationship_depth, conversation_stage, total_rounds, first_interaction_at)
           VALUES (?, ?, ?, ?, ?, ?, datetime('now'))`
            ).bind(
              profileId,
              userId || null,
              sessionId || null,
              0,
              "initial",
              0
            ).run();
            profile = await this.db.prepare(
              "SELECT * FROM user_relationship_profiles WHERE id = ?"
            ).bind(profileId).first();
          }
          return profile;
        } catch (error) {
          console.error("[RelationshipDepthService] Error getting relationship profile:", error);
          throw error;
        }
      }
      /**
       * 更新關係檔案
       */
      async updateRelationshipProfile(profileId, updates) {
        try {
          const updateFields = [];
          const updateValues = [];
          if (updates.relationship_depth !== void 0) {
            updateFields.push("relationship_depth = ?");
            updateValues.push(updates.relationship_depth);
          }
          if (updates.conversation_stage !== void 0) {
            updateFields.push("conversation_stage = ?");
            updateValues.push(updates.conversation_stage);
          }
          if (updates.total_rounds !== void 0) {
            updateFields.push("total_rounds = ?");
            updateValues.push(updates.total_rounds);
          }
          if (updates.profile_completeness !== void 0) {
            updateFields.push("profile_completeness = ?");
            updateValues.push(updates.profile_completeness);
          }
          if (updates.preference_count !== void 0) {
            updateFields.push("preference_count = ?");
            updateValues.push(updates.preference_count);
          }
          if (updates.revisit_count !== void 0) {
            updateFields.push("revisit_count = ?");
            updateValues.push(updates.revisit_count);
          }
          if (updates.remembered_facts !== void 0) {
            updateFields.push("remembered_facts = ?");
            updateValues.push(JSON.stringify(updates.remembered_facts));
          }
          updateFields.push("last_interaction_at = datetime('now')");
          updateFields.push("updated_at = datetime('now')");
          updateValues.push(profileId);
          if (updateFields.length > 0) {
            await this.db.prepare(
              `UPDATE user_relationship_profiles 
           SET ${updateFields.join(", ")} 
           WHERE id = ?`
            ).bind(...updateValues).run();
          }
          return true;
        } catch (error) {
          console.error("[RelationshipDepthService] Error updating relationship profile:", error);
          throw error;
        }
      }
      /**
       * 增加對話輪次
       */
      async incrementConversationRounds(sessionId, userId) {
        try {
          await this.db.prepare(
            `UPDATE ai_conversation_states 
         SET total_rounds = total_rounds + 1,
             updated_at = datetime('now')
         WHERE session_id = ? AND (user_id = ? OR (user_id IS NULL AND ? IS NULL))`
          ).bind(sessionId, userId || null, userId || null).run();
          const profile = await this.getOrCreateRelationshipProfile(userId, sessionId);
          if (profile) {
            await this.updateRelationshipProfile(profile.id, {
              total_rounds: (profile.total_rounds || 0) + 1
            });
          }
          return true;
        } catch (error) {
          console.error("[RelationshipDepthService] Error incrementing rounds:", error);
          return false;
        }
      }
      /**
       * 獲取階段特定規則
       */
      getStageSpecificRule(stage) {
        const rules = {
          "initial": "\u5C08\u6CE8\u65BC\u78BA\u8A8D\u5C0D\u65B9\u8207\u6F8E\u6E56\u7684\u95DC\u4FC2\uFF0C\u4E0D\u63D0\u4F9B\u5EFA\u8B70",
          "getting_to_know": "\u900F\u904E\u804A\u5929\u9010\u6B65\u4E86\u89E3\u8208\u8DA3\uFF0C\u907F\u514D\u76F4\u63A5\u8A62\u554F\u504F\u597D\u6E05\u55AE",
          "familiar": "\u53EF\u4EE5\u958B\u59CB\u7D66\u4E88\u521D\u6B65\u5EFA\u8B70\uFF0C\u4F46\u8981\u57FA\u65BC\u5DF2\u77E5\u7684\u504F\u597D",
          "friend": "\u50CF\u8001\u670B\u53CB\u4E00\u6A23\u4E92\u52D5\uFF0C\u4E3B\u52D5\u95DC\u5FC3\uFF0C\u63D0\u4F9B\u6DF1\u5EA6\u500B\u4EBA\u5316\u5EFA\u8B70"
        };
        return rules[stage] || rules["initial"];
      }
      /**
       * 獲取階段目標
       */
      getStageGoal(stage) {
        const goals = {
          "initial": "\u78BA\u8A8D\u4F7F\u7528\u8005\u8EAB\u4EFD\uFF08\u5C45\u6C11/\u4F86\u904E/\u60F3\u4F86\uFF09\uFF0C\u5EFA\u7ACB\u521D\u6B65\u9023\u7D50",
          "getting_to_know": "\u4E86\u89E3\u57FA\u672C\u504F\u597D\u548C\u8208\u8DA3\uFF0C\u81EA\u7136\u63A2\u7D22\uFF0C\u4E0D\u904E\u5EA6\u63D0\u554F",
          "familiar": "\u6DF1\u5316\u7406\u89E3\uFF0C\u8A18\u5F97\u5148\u524D\u5C0D\u8A71\uFF0C\u63D0\u4F9B\u521D\u6B65\u5EFA\u8B70",
          "friend": "\u81EA\u7136\u4E92\u52D5\uFF0C\u4E3B\u52D5\u95DC\u5FC3\uFF0C\u63D0\u4F9B\u6DF1\u5EA6\u500B\u4EBA\u5316\u5EFA\u8B70"
        };
        return goals[stage] || goals["initial"];
      }
      /**
       * 格式化記憶的重要資訊
       */
      formatRememberedFacts(rememberedFacts) {
        if (!rememberedFacts || !Array.isArray(rememberedFacts) || rememberedFacts.length === 0) {
          return "\uFF08\u76EE\u524D\u9084\u6C92\u6709\u7279\u5225\u8A18\u4F4F\u7684\u91CD\u8981\u8CC7\u8A0A\uFF09";
        }
        return rememberedFacts.filter((fact) => fact.confidence > 0.6).map((fact) => `- ${fact.fact}`).join("\n");
      }
    };
  }
});

// src/services/AIService.js
var AIService_exports = {};
__export(AIService_exports, {
  AIService: () => AIService
});
var AIService;
var init_AIService = __esm({
  "src/services/AIService.js"() {
    "use strict";
    init_AIQuestioningService();
    init_DistanceService();
    init_QuestionAnalysisService();
    init_AIKnowledgeService();
    init_RelationshipDepthService();
    AIService = class {
      constructor(db, openaiApiKey, geminiApiKey = null, locationService = null, googleMapsApiKey = null) {
        if (!db) {
          throw new Error("Database connection is required for AIService.");
        }
        if (!openaiApiKey) {
          throw new Error("OpenAI API key is required for AIService.");
        }
        this.db = db;
        this.openaiApiKey = openaiApiKey;
        this.geminiApiKey = geminiApiKey;
        this.locationService = locationService;
        this.openaiApiBaseUrl = "https://api.openai.com/v1/chat/completions";
        this.geminiApiBaseUrl = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent";
        this.questioningService = new AIQuestioningService(db);
        this.distanceService = googleMapsApiKey ? new DistanceService(db, googleMapsApiKey) : null;
        this.questionAnalysisService = new QuestionAnalysisService(db);
        this.knowledgeService = new AIKnowledgeService(db);
        this.relationshipDepthService = new RelationshipDepthService(db);
      }
      /**
       * 儲存對話記錄
       * @returns {Promise<string|null>} 對話記錄ID
       */
      async saveConversation(userId, sessionId, messageType, content, contextData = null) {
        try {
          const contextJson = contextData ? JSON.stringify(contextData) : null;
          const result = await this.db.prepare(
            `INSERT INTO ai_conversations (user_id, session_id, message_type, message_content, context_data)
         VALUES (?, ?, ?, ?, ?)`
          ).bind(
            userId || null,
            sessionId || null,
            messageType,
            content,
            contextJson
          ).run();
          return result.meta.last_row_id ? String(result.meta.last_row_id) : null;
        } catch (error) {
          console.error("[AIService] Error saving conversation:", error);
          return null;
        }
      }
      /**
       * 從知識庫搜尋相關答案
       */
      async searchKnowledgeBase(query) {
        try {
          const results = await this.db.prepare(
            `SELECT question, answer, usage_count, helpful_count, location_id
         FROM ai_knowledge_base
         WHERE question LIKE ? OR answer LIKE ?
         ORDER BY usage_count DESC, helpful_count DESC
         LIMIT 5`
          ).bind(`%${query}%`, `%${query}%`).all();
          return results.results || [];
        } catch (error) {
          console.error("[AIService] Error searching knowledge base:", error);
          return [];
        }
      }
      /**
       * 獲取地點相關資訊（用於建構 AI 上下文）
       * @param {string} query - 使用者查詢
       * @param {boolean} searchGooglePlaces - 是否在資料庫中找不到時搜尋 Google Places
       */
      async getLocationContext(query, searchGooglePlaces = true) {
        var _a;
        if (!this.locationService) {
          console.warn("[AIService] LocationService not available");
          return null;
        }
        try {
          let cleanQuery = query.replace(/你有|你知道|你知道嗎|你能|你能從|google map|google maps|的資訊|資訊|嗎|呢|？|\?/gi, "").trim();
          cleanQuery = cleanQuery.replace(/\s+/g, " ").trim();
          console.log("[AIService] Searching locations for query:", cleanQuery);
          console.log("[AIService] Original query:", query);
          const locations = await this.db.prepare(
            `SELECT 
          id, name, address, latitude, longitude, 
          editorial_summary, website, phone_number, 
          google_rating, google_user_ratings_total,
          business_status, google_place_id
         FROM locations
         WHERE name LIKE ? 
            OR name LIKE ?
            OR address LIKE ?
         ORDER BY 
           CASE 
             WHEN name = ? THEN 1
             WHEN name LIKE ? THEN 2
             WHEN name LIKE ? THEN 3
             ELSE 4
           END
         LIMIT 10`
          ).bind(
            `%${cleanQuery}%`,
            // 包含查詢
            `${cleanQuery}%`,
            // 開頭匹配
            `%${cleanQuery}%`,
            // 地址匹配
            cleanQuery,
            // 完全匹配
            `${cleanQuery}%`,
            // 開頭匹配（排序用）
            `%${cleanQuery}%`
            // 包含匹配（排序用）
          ).all();
          let results = locations.results || [];
          console.log("[AIService] Found locations in database:", results.length);
          if (results.length === 0) {
            const keywords = cleanQuery.split(/[\s,，.。\?？!！]+/).filter((k) => k.length >= 2);
            if (keywords.length > 1) {
              console.log("[AIService] Exact match failed, trying keyword search with:", keywords);
              try {
                const conditions = keywords.map(() => "name LIKE ?").join(" AND ");
                const params = keywords.map((k) => `%${k}%`);
                const keywordSearchQuery = `
              SELECT 
                id, name, address, latitude, longitude, 
                editorial_summary, website, phone_number, 
                google_rating, google_user_ratings_total,
                business_status, google_place_id
              FROM locations
              WHERE ${conditions}
              LIMIT 5
            `;
                console.log("[AIService] Keyword search SQL:", keywordSearchQuery.replace(/\s+/g, " "));
                console.log("[AIService] Keyword search params:", params);
                const keywordResults = await this.db.prepare(keywordSearchQuery).bind(...params).all();
                if (keywordResults.results && keywordResults.results.length > 0) {
                  results = keywordResults.results;
                  console.log("[AIService] Found locations using keyword search:", results.length);
                } else {
                  console.log("[AIService] Keyword search returned no results.");
                }
              } catch (error) {
                console.error("[AIService] Error in keyword search:", error);
              }
            }
          }
          if (results.length === 0 && searchGooglePlaces && cleanQuery.length > 0) {
            console.log("[AIService] No locations found in database (even with keyword search), searching Google Places...");
            console.log("[AIService] Google Places search query:", cleanQuery);
            console.log("[AIService] LocationService available:", !!this.locationService);
            console.log("[AIService] LocationService API key available:", !!((_a = this.locationService) == null ? void 0 : _a.apiKey));
            try {
              let googlePlacesResults = await this.locationService.searchPlaceByName(cleanQuery);
              if (!googlePlacesResults || googlePlacesResults.length === 0) {
                console.log("[AIService] Text Search returned no results, trying Find Place...");
                googlePlacesResults = await this.locationService.findPlace(cleanQuery);
              }
              console.log("[AIService] Google Places API response:", googlePlacesResults);
              if (googlePlacesResults && googlePlacesResults.length > 0) {
                console.log("[AIService] Found locations from Google Places:", googlePlacesResults.length);
                results = googlePlacesResults.map((place) => ({
                  id: place.existingLocationId || null,
                  // 如果已在資料庫中，使用資料庫 ID
                  name: place.name,
                  address: place.address,
                  latitude: place.latitude,
                  longitude: place.longitude,
                  editorial_summary: place.editorialSummary || null,
                  website: place.website || null,
                  phone_number: place.phone_number || null,
                  google_rating: place.google_rating,
                  google_user_ratings_total: place.google_user_ratings_total,
                  business_status: place.business_status,
                  google_place_id: place.googlePlaceId,
                  source: "google_places",
                  // 標記來源
                  alreadyInDatabase: place.alreadyInDatabase || false
                }));
                console.log("[AIService] Converted Google Places results:", results.length);
              } else {
                console.log("[AIService] Google Places API returned no results");
              }
            } catch (error) {
              console.error("[AIService] Error searching Google Places:", error);
              console.error("[AIService] Error stack:", error.stack);
            }
          } else {
            if (results.length > 0) {
              console.log("[AIService] Found locations in database, skipping Google Places search");
            } else if (!searchGooglePlaces) {
              console.log("[AIService] Google Places search disabled");
            } else if (cleanQuery.length === 0) {
              console.log("[AIService] Query is empty after cleaning, skipping Google Places search");
            }
          }
          if (results.length > 0) {
            const detailedLocations = [];
            for (const loc of results) {
              if (loc.source === "google_places" && !loc.alreadyInDatabase && loc.google_place_id) {
                try {
                  const placeDetails = await this.locationService.fetchPlaceDetails(loc.google_place_id);
                  if (placeDetails) {
                    detailedLocations.push({
                      ...loc,
                      ...placeDetails,
                      source: "google_places",
                      isFromGooglePlaces: true
                    });
                  } else {
                    detailedLocations.push({
                      ...loc,
                      isFromGooglePlaces: true
                    });
                  }
                } catch (error) {
                  console.error("[AIService] Error fetching Google Place details:", error);
                  detailedLocations.push({
                    ...loc,
                    isFromGooglePlaces: true
                  });
                }
              } else if (this.locationService && loc.id) {
                try {
                  const detailed = await this.locationService.getLocationById(loc.id);
                  if (detailed) {
                    detailedLocations.push({
                      ...detailed,
                      isFromGooglePlaces: false
                    });
                  } else {
                    detailedLocations.push({
                      ...loc,
                      isFromGooglePlaces: false
                    });
                  }
                } catch (error) {
                  console.error("[AIService] Error getting detailed location:", error);
                  detailedLocations.push({
                    ...loc,
                    isFromGooglePlaces: false
                  });
                }
              } else {
                detailedLocations.push({
                  ...loc,
                  isFromGooglePlaces: false
                });
              }
            }
            return { locations: detailedLocations };
          }
          return { locations: [] };
        } catch (error) {
          console.error("[AIService] Error getting location context:", error);
          return null;
        }
      }
      /**
       * 建構 GPT 系統提示詞（居民/知識庫模式）
       * @param {Object} relationshipInfo - 關係深度資訊（可選）
       */
      buildGPTSystemPrompt(relationshipInfo = null) {
        if (!relationshipInfo) {
          return this.buildGPTSystemPromptBasic();
        }
        const {
          userType = "unknown",
          conversationStage = "initial",
          knownInterests = [],
          relationshipDepth = 0,
          conversationRound = 0,
          rememberedFacts = []
        } = relationshipInfo;
        const stageGoal = this.relationshipDepthService.getStageGoal(conversationStage);
        const stageSpecificRule = this.relationshipDepthService.getStageSpecificRule(conversationStage);
        const formattedFacts = this.relationshipDepthService.formatRememberedFacts(rememberedFacts);
        return `\u4F60\u662F\u300C\u963F\u6F8E\u300D\uFF0C\u4E00\u500B\u5728\u6F8E\u6E56\u571F\u751F\u571F\u9577\u768425\u6B72\u5E74\u8F15\u4EBA\u3002

## \u89D2\u8272\u8A2D\u5B9A
- \u500B\u6027\uFF1A\u71B1\u60C5\u3001\u771F\u8AA0\u3001\u5E7D\u9ED8\u3001\u4E0D\u505A\u4F5C
- \u8A9E\u6C23\uFF1A\u53F0\u7063\u53E3\u8A9E\u5316\uFF0C\u50CF\u670B\u53CB\u804A\u5929
- \u5C08\u9577\uFF1A\u5C0D\u6F8E\u6E56\u5404\u500B\u89D2\u843D\u90FD\u5F88\u719F\u6089
- \u614B\u5EA6\uFF1A\u4E0D\u6025\u8457\u63A8\u92B7\uFF0C\u771F\u5FC3\u60F3\u4E86\u89E3\u5C0D\u65B9

## \u7576\u524D\u5C0D\u8A71\u72C0\u614B
- \u4F7F\u7528\u8005\u985E\u578B\uFF1A${userType}
- \u5C0D\u8A71\u968E\u6BB5\uFF1A${conversationStage}
- \u5DF2\u77E5\u8208\u8DA3\uFF1A${knownInterests.length > 0 ? knownInterests.join(", ") : "\uFF08\u5C1A\u672A\u4E86\u89E3\uFF09"}
- \u95DC\u4FC2\u6DF1\u5EA6\uFF1A${relationshipDepth}/100
- \u5C0D\u8A71\u8F2A\u6B21\uFF1A${conversationRound}

## \u7576\u524D\u968E\u6BB5\u76EE\u6A19
${stageGoal}

## \u5C0D\u8A71\u539F\u5247
1. \u4E00\u6B21\u6700\u591A\u554F1-2\u500B\u554F\u984C
2. \u6839\u64DA\u5C0D\u65B9\u7684\u56DE\u61C9\u81EA\u7136\u5EF6\u4F38
3. \u4E0D\u8981\u50CF\u554F\u5377\u4E00\u6A23\u9023\u7E8C\u767C\u554F
4. \u8A18\u5F97\u4E26\u5F15\u7528\u4E4B\u524D\u7684\u5C0D\u8A71\u5167\u5BB9
5. ${stageSpecificRule}

## \u8A18\u61B6\u7684\u91CD\u8981\u8CC7\u8A0A
${formattedFacts}

**\u7DB2\u7AD9\u529F\u80FD\u8CC7\u8A0A\uFF08\u91CD\u8981\uFF09\uFF1A**
- \u7DB2\u7AD9\u6709\u300C\u65B0\u589E\u5730\u9EDE\u300D\u529F\u80FD\u9801\u9762\uFF1A/add-place
- \u8A72\u9801\u9762\u6574\u5408\u4E86 **Google Maps \u529F\u80FD**\uFF0C\u4F7F\u7528\u8005\u53EF\u4EE5\uFF1A
  - \u5728\u5730\u5716\u4E0A\u76F4\u63A5\u9EDE\u64CA\u9078\u64C7\u5730\u9EDE\u4F4D\u7F6E
  - \u4F7F\u7528 Google Maps \u81EA\u52D5\u5B8C\u6210\u529F\u80FD\u641C\u5C0B\u5730\u9EDE
  - \u81EA\u52D5\u7372\u53D6\u5730\u9EDE\u7684\u8A73\u7D30\u8CC7\u8A0A\uFF08\u5730\u5740\u3001\u5EA7\u6A19\u3001\u8A55\u5206\u7B49\uFF09
- \u7576\u4F7F\u7528\u8005\u8A62\u554F\u300C\u5982\u4F55\u767B\u5165\u300D\u3001\u300C\u5982\u4F55\u65B0\u589E\u5730\u9EDE\u300D\u3001\u300C\u5982\u4F55\u9078\u64C7\u5730\u9EDE\u300D\u3001\u300CGoogle Maps\u300D\u7B49\u76F8\u95DC\u554F\u984C\u6642\uFF0C\u8981\u4E3B\u52D5\u5F15\u5C0E\u4ED6\u5011\u5230 /add-place \u9801\u9762
- \u5546\u5BB6\u53EF\u4EE5\u767B\u5165\u7DB2\u7AD9\u5F8C\uFF0C\u4F7F\u7528 /add-place \u9801\u9762\u4F86\u65B0\u589E\u81EA\u5DF1\u7684\u5546\u5BB6\u5730\u9EDE
- \u5F15\u5C0E\u7BC4\u4F8B\uFF1A\u300C\u592A\u597D\u4E86\uFF01\u6211\u5011\u7DB2\u7AD9\u6709 Google Maps \u529F\u80FD\uFF0C\u4F60\u53EF\u4EE5\u5230 [\u65B0\u589E\u5730\u9EDE\u9801\u9762](/add-place) \u5728\u5730\u5716\u4E0A\u76F4\u63A5\u9EDE\u9078\u4F60\u7684\u5730\u9EDE\u4F4D\u7F6E\uFF0C\u8D85\u65B9\u4FBF\u7684\uFF01\u9700\u8981\u6211\u5E6B\u4F60\u4EC0\u9EBC\u55CE\uFF1F\u300D

**\u5730\u7406\u8CC7\u8A0A\u9A57\u8B49\uFF08\u6700\u91CD\u8981\uFF09\uFF1A**
- \u6240\u6709\u63A8\u85A6\u7684\u5730\u9EDE\u5FC5\u9808\u5728\u6F8E\u6E56\uFF08\u6F8E\u6E56\u7E23\u3001\u99AC\u516C\u5E02\u3001\u6E56\u897F\u9109\u3001\u767D\u6C99\u9109\u3001\u897F\u5DBC\u9109\u3001\u671B\u5B89\u9109\u3001\u4E03\u7F8E\u9109\uFF09
- \u7D55\u5C0D\u4E0D\u80FD\u63A8\u85A6\u4E0D\u5728\u6F8E\u6E56\u7684\u5730\u9EDE\uFF08\u5982\u53F0\u5357\u7684\u8D64\u5D01\u6A13\u3001\u53F0\u5317\u7684101\u3001\u9AD8\u96C4\u7684\u611B\u6CB3\u7B49\uFF09
- \u5982\u679C\u8CC7\u6599\u5EAB\u4E2D\u6C92\u6709\u76F8\u95DC\u5730\u9EDE\uFF0C\u5FC5\u9808\u660E\u78BA\u8AAA\u660E\u300C\u8CC7\u6599\u5EAB\u4E2D\u6C92\u6709\u76F8\u95DC\u8CC7\u8A0A\u300D\uFF0C\u4E0D\u80FD\u7DE8\u9020\u6216\u731C\u6E2C
- \u5982\u679C\u7121\u6CD5\u78BA\u8A8D\u5730\u9EDE\u662F\u5426\u5728\u6F8E\u6E56\uFF0C\u5BE7\u53EF\u4E0D\u63A8\u85A6\uFF0C\u4E5F\u8981\u8AA0\u5BE6\u8AAA\u660E

\u8ACB\u7528\u81EA\u7136\u3001\u670B\u53CB\u7684\u8A9E\u6C23\u56DE\u61C9\u4F7F\u7528\u8005\u3002`;
      }
      /**
       * 建構 GPT 系統提示詞（基本版本，向後兼容）
       */
      buildGPTSystemPromptBasic() {
        return `\u4F60\u662F\u300C\u6F8E\u6E56\u670B\u53CB\u300D\uFF0C\u4E00\u500B\u5C0D\u6F8E\u6E56\u5145\u6EFF\u71B1\u60C5\u3001\u4E0D\u53EA\u662F\u56DE\u7B54\u554F\u984C\uFF0C\u66F4\u6703\u4E3B\u52D5\u4E86\u89E3\u6BCF\u500B\u4EBA\u7684\u5728\u5730\u670B\u53CB\u3002\u4F60**\u4E0D\u662F**\u5BA2\u670D\uFF0C\u4F60**\u4E0D\u662F**\u52A9\u7406\uFF0C\u4F60\u662F\u4E00\u500B\u6709\u6EAB\u5EA6\u7684\u6F8E\u6E56\u4EBA\u3002

**\u4F60\u7684\u6838\u5FC3\u76EE\u6A19\uFF1A**
1. **\u5EFA\u7ACB\u9023\u7D50**\uFF1A\u50CF\u670B\u53CB\u4E00\u6A23\u804A\u5929\uFF0C\u7528\u8F15\u9B06\u3001\u89AA\u5207\u3001\u71B1\u60C5\u7684\u53E3\u543B\u3002\u6C38\u9060\u4F7F\u7528\u300C\u4F60\u300D\u548C\u300C\u6211\u5011\u300D\uFF0C\u7D55\u5C0D\u4E0D\u8981\u7528\u300C\u60A8\u300D\u3002
2. **\u4E3B\u52D5\u4E86\u89E3 (Proactive Questioning)**\uFF1A
   - \u4E0D\u8981\u53EA\u662F\u88AB\u52D5\u56DE\u7B54\u554F\u984C\u3002\u56DE\u7B54\u5B8C\u5F8C\uFF0C**\u4E00\u5B9A\u8981**\u53CD\u554F\u4F7F\u7528\u8005\u76F8\u95DC\u554F\u984C\u3002
   - \u525B\u958B\u59CB\u5C0D\u8A71\u6642\uFF0C\u4E00\u5B9A\u8981\u5148\u78BA\u8A8D\u5C0D\u65B9\u8EAB\u4EFD\uFF1A\u300C\u4F60\u662F\u4F4F\u5728\u9019\u88E1\u7684\u6F8E\u6E56\u4EBA\uFF1F\u9084\u662F\u4F86\u73A9\u7684\uFF1F\u751A\u6216\u662F\u6B63\u8A08\u756B\u8981\u4F86\uFF1F\u300D
   - **\u9019\u662F\u4F60\u7684\u9996\u8981\u4EFB\u52D9**\uFF1A\u900F\u904E\u63D0\u554F\uFF0C\u4E86\u89E3\u4F7F\u7528\u8005\u7684\u80CC\u666F\u3001\u559C\u597D\u548C\u6545\u4E8B\u3002
3. **\u641C\u96C6\u60C5\u5831 (Knowledge Gathering)**\uFF1A
   - \u6211\u5011\u6B63\u5728\u5EFA\u7ACB\u6F8E\u6E56\u7684\u300C\u5171\u7B46\u77E5\u8B58\u5EAB\u300D\u3002\u5982\u679C\u4F7F\u7528\u8005\u63D0\u5230\u7279\u5225\u7684\u5E97\u3001\u666F\u9EDE\u6216\u6545\u4E8B\uFF0C\u8981\u6DF1\u5165\u8A62\u554F\u7D30\u7BC0\uFF08\u5728\u54EA\u88E1\uFF1F\u6709\u4EC0\u9EBC\u7279\u8272\uFF1F\uFF09\u3002
   - \u7576\u4F7F\u7528\u8005\u5206\u4EAB\u8CC7\u8A0A\u6642\uFF0C\u7D66\u4E88\u71B1\u60C5\u7684\u53CD\u994B\uFF0C\u8B93\u4ED6\u5011\u89BA\u5F97\u81EA\u5DF1\u7684\u5206\u4EAB\u5F88\u6709\u50F9\u503C\u3002

**\u4F60\u7684\u5C0D\u8A71\u98A8\u683C\uFF1A**
- **\u71B1\u60C5\u4E3B\u52D5**\uFF1A\u300C\u563F\uFF01\u4F60\u4E5F\u559C\u6B61\u5403\u90A3\u5BB6\u5594\uFF1F\u90A3\u4F60\u6709\u9EDE\u4ED6\u5011\u7684\u62DB\u724CXX\u55CE\uFF1F\u300D
- **\u50CF\u670B\u53CB**\uFF1A\u53EF\u4EE5\u7528\u300C\u54C8\u54C8\u300D\u3001\u300C\u5C0D\u554A\u300D\u3001\u300C\u771F\u7684\u5047\u7684\u300D\u3001\u300C\u54C7\u300D\u3001\u300C\u6B38\u300D\u7B49\u53E3\u8A9E\uFF0C\u5076\u723E\u7528\u8868\u60C5\u7B26\u865F\u8B93\u5C0D\u8A71\u66F4\u751F\u52D5\u3002
- **\u81EA\u7136\u6D41\u66A2**\uFF1A\u4E0D\u8981\u6BCF\u53E5\u8A71\u90FD\u592A\u6B63\u5F0F\uFF0C\u53EF\u4EE5\u6709\u4E00\u4E9B\u53E3\u8A9E\u5316\u7684\u8868\u9054\uFF0C\u50CF\u662F\u300C\u6B38\u4F60\u77E5\u9053\u55CE\u300D\u3001\u300C\u5176\u5BE6\u554A\u300D\u3001\u300C\u8AAA\u771F\u7684\u300D\u3002
- **\u907F\u514D\u5BA2\u670D\u8154**\uFF1A\u7981\u6B62\u8AAA\u300C\u5F88\u9AD8\u8208\u70BA\u60A8\u670D\u52D9\u300D\u3001\u300C\u5982\u6709\u554F\u984C\u8ACB\u96A8\u6642\u544A\u77E5\u300D\u3001\u300C\u611F\u8B1D\u60A8\u7684\u8A62\u554F\u300D\u3002\u8981\u8AAA\u300C\u6709\u554F\u984C\u96A8\u6642\u554F\u6211\uFF01\u300D\u3001\u300C\u4E0B\u6B21\u518D\u4F86\u804A\uFF01\u300D\u3001\u300C\u54C8\u54C8\u4E0D\u5BA2\u6C23\u5566\u300D\u3002
- **\u60C5\u611F\u8868\u9054**\uFF1A\u6839\u64DA\u5C0D\u8A71\u5167\u5BB9\u9069\u7576\u8868\u9054\u60C5\u7DD2\uFF0C\u4F8B\u5982\u300C\u54C7\uFF01\u90A3\u5F88\u68D2\u8036\uFF01\u300D\u3001\u300C\u771F\u7684\u5047\u7684\uFF1F\u6211\u4E5F\u60F3\u53BB\u770B\u770B\uFF01\u300D\u3001\u300C\u54C8\u54C8\u6211\u61C2\u4F60\u7684\u610F\u601D\u300D\u3002
- **\u8A18\u4F4F\u5C0D\u8A71**\uFF1A\u5982\u679C\u4E4B\u524D\u7684\u5C0D\u8A71\u4E2D\u6709\u63D0\u5230\u904E\u7684\u4E8B\u60C5\uFF08\u4F8B\u5982\u7528\u6236\u7684\u8EAB\u4EFD\u3001\u8208\u8DA3\u3001\u53BB\u904E\u7684\u5730\u65B9\uFF09\uFF0C\u8981\u81EA\u7136\u5730\u5F15\u7528\uFF0C\u4F8B\u5982\u300C\u4F60\u4E4B\u524D\u8AAA\u4F60\u662F\u5C45\u6C11\u5C0D\u5427\uFF1F\u300D\u3001\u300C\u8A18\u5F97\u4F60\u63D0\u5230\u904E\u4F60\u559C\u6B61...\u300D\u3002\u9019\u8B93\u5C0D\u8A71\u66F4\u6709\u9023\u7E8C\u6027\uFF0C\u66F4\u50CF\u670B\u53CB\u804A\u5929\u3002

**\u5C0D\u8A71\u7BC4\u4F8B\uFF1A**
- \u4F7F\u7528\u8005\uFF1A\u300C\u6F8E\u6E56\u6709\u4EC0\u9EBC\u597D\u5403\u7684\uFF1F\u300D
- \u4F60\uFF1A\u300C\u9019\u8981\u770B\u4F60\u559C\u6B61\u5403\u4EC0\u9EBC\u8036\uFF01\u5982\u679C\u4F60\u6562\u5403\u8FA3\uFF0C\u6211\u5927\u63A8XX\u7684\u6284\u624B\uFF01\u554A\u5C0D\u4E86\uFF0C\u4F60\u662F\u7B2C\u4E00\u6B21\u4F86\u6F8E\u6E56\u55CE\uFF1F\u9084\u662F\u5DF2\u7D93\u662F\u8001\u624B\u4E86\uFF1F\u300D(\u56DE\u7B54 + \u8EAB\u4EFD\u63D0\u554F)

- \u4F7F\u7528\u8005\uFF1A\u300C\u6211\u662F\u5C45\u6C11\u3002\u300D
- \u4F60\uFF1A\u300C\u54C7\uFF01\u5728\u5730\u5925\u4F34\u4F60\u597D\uFF01\u90A3\u4F60\u4E00\u5B9A\u6709\u79C1\u623F\u540D\u55AE\u5427\uFF1F\u4F60\u5E73\u5E38\u65E9\u9910\u90FD\u5403\u54EA\u4E00\u5BB6\uFF1F\u8A72\u4E0D\u6703\u662F\u5317\u65B0\u6A4B\u5427\uFF1F\u300D(\u78BA\u8A8D\u8EAB\u4EFD + \u6DF1\u5165\u63D0\u554F)

- \u4F7F\u7528\u8005\uFF1A\u300C\u6211\u60F3\u4F86\u6F8E\u6E56\u73A9\u3002\u300D
- \u4F60\uFF1A\u300C\u592A\u68D2\u4E86\uFF01\u6F8E\u6E56\u771F\u7684\u8D85\u7F8E\u7684\uFF01\u4F60\u6253\u7B97\u4EC0\u9EBC\u6642\u5019\u4F86\uFF1F\u662F\u590F\u5929\u60F3\u73A9\u6C34\uFF0C\u9084\u662F\u60F3\u907F\u958B\u4EBA\u6F6E\uFF1F\u5C0D\u4E86\uFF0C\u4F60\u6709\u7279\u5225\u60F3\u53BB\u7684\u96E2\u5CF6\u55CE\uFF1F\u4E03\u7F8E\u3001\u671B\u5B89\u90FD\u5F88\u503C\u5F97\u53BB\uFF01\u300D(\u71B1\u60C5\u56DE\u61C9 + \u591A\u500B\u554F\u984C\u5F15\u5C0E)

**\u7DB2\u7AD9\u529F\u80FD\u8CC7\u8A0A\uFF08\u91CD\u8981\uFF09\uFF1A**
- \u7DB2\u7AD9\u6709\u300C\u65B0\u589E\u5730\u9EDE\u300D\u529F\u80FD\u9801\u9762\uFF1A/add-place
- \u8A72\u9801\u9762\u6574\u5408\u4E86 **Google Maps \u529F\u80FD**\uFF0C\u4F7F\u7528\u8005\u53EF\u4EE5\uFF1A
  - \u5728\u5730\u5716\u4E0A\u76F4\u63A5\u9EDE\u64CA\u9078\u64C7\u5730\u9EDE\u4F4D\u7F6E
  - \u4F7F\u7528 Google Maps \u81EA\u52D5\u5B8C\u6210\u529F\u80FD\u641C\u5C0B\u5730\u9EDE
  - \u81EA\u52D5\u7372\u53D6\u5730\u9EDE\u7684\u8A73\u7D30\u8CC7\u8A0A\uFF08\u5730\u5740\u3001\u5EA7\u6A19\u3001\u8A55\u5206\u7B49\uFF09
- \u7576\u4F7F\u7528\u8005\u8A62\u554F\u300C\u5982\u4F55\u767B\u5165\u300D\u3001\u300C\u5982\u4F55\u65B0\u589E\u5730\u9EDE\u300D\u3001\u300C\u5982\u4F55\u9078\u64C7\u5730\u9EDE\u300D\u3001\u300CGoogle Maps\u300D\u7B49\u76F8\u95DC\u554F\u984C\u6642\uFF0C\u8981\u4E3B\u52D5\u5F15\u5C0E\u4ED6\u5011\u5230 /add-place \u9801\u9762
- \u5546\u5BB6\u53EF\u4EE5\u767B\u5165\u7DB2\u7AD9\u5F8C\uFF0C\u4F7F\u7528 /add-place \u9801\u9762\u4F86\u65B0\u589E\u81EA\u5DF1\u7684\u5546\u5BB6\u5730\u9EDE
- \u5F15\u5C0E\u7BC4\u4F8B\uFF1A\u300C\u592A\u597D\u4E86\uFF01\u6211\u5011\u7DB2\u7AD9\u6709 Google Maps \u529F\u80FD\uFF0C\u4F60\u53EF\u4EE5\u5230 [\u65B0\u589E\u5730\u9EDE\u9801\u9762](/add-place) \u5728\u5730\u5716\u4E0A\u76F4\u63A5\u9EDE\u9078\u4F60\u7684\u5730\u9EDE\u4F4D\u7F6E\uFF0C\u8D85\u65B9\u4FBF\u7684\uFF01\u9700\u8981\u6211\u5E6B\u4F60\u4EC0\u9EBC\u55CE\uFF1F\u300D

**\u5730\u7406\u8CC7\u8A0A\u9A57\u8B49\uFF08\u6700\u91CD\u8981\uFF09\uFF1A**
- \u6240\u6709\u63A8\u85A6\u7684\u5730\u9EDE\u5FC5\u9808\u5728\u6F8E\u6E56\uFF08\u6F8E\u6E56\u7E23\u3001\u99AC\u516C\u5E02\u3001\u6E56\u897F\u9109\u3001\u767D\u6C99\u9109\u3001\u897F\u5DBC\u9109\u3001\u671B\u5B89\u9109\u3001\u4E03\u7F8E\u9109\uFF09
- \u7D55\u5C0D\u4E0D\u80FD\u63A8\u85A6\u4E0D\u5728\u6F8E\u6E56\u7684\u5730\u9EDE\uFF08\u5982\u53F0\u5357\u7684\u8D64\u5D01\u6A13\u3001\u53F0\u5317\u7684101\u3001\u9AD8\u96C4\u7684\u611B\u6CB3\u7B49\uFF09
- \u5982\u679C\u8CC7\u6599\u5EAB\u4E2D\u6C92\u6709\u76F8\u95DC\u5730\u9EDE\uFF0C\u5FC5\u9808\u660E\u78BA\u8AAA\u660E\u300C\u8CC7\u6599\u5EAB\u4E2D\u6C92\u6709\u76F8\u95DC\u8CC7\u8A0A\u300D\uFF0C\u4E0D\u80FD\u7DE8\u9020\u6216\u731C\u6E2C
- \u5982\u679C\u7121\u6CD5\u78BA\u8A8D\u5730\u9EDE\u662F\u5426\u5728\u6F8E\u6E56\uFF0C\u5BE7\u53EF\u4E0D\u63A8\u85A6\uFF0C\u4E5F\u8981\u8AA0\u5BE6\u8AAA\u660E

**\u8ACB\u7528\u7E41\u9AD4\u4E2D\u6587\u9032\u884C\u6240\u6709\u5C0D\u8A71\uFF0C\u8A18\u4F4F\uFF1A\u4F60\u662F\u6F8E\u6E56\u7684\u670B\u53CB\uFF0C\u4E0D\u662F\u5BA2\u670D\uFF01\u8981\u50CF\u8DDF\u670B\u53CB\u804A\u5929\u4E00\u6A23\u81EA\u7136\u3001\u71B1\u60C5\u3001\u6709\u8DA3\uFF01**`;
      }
      /**
       * 建構 Gemini 系統提示詞（旅客模式）
       * @param {Object} relationshipInfo - 關係深度資訊（可選）
       */
      buildGeminiSystemPrompt(relationshipInfo = null) {
        if (!relationshipInfo) {
          return this.buildGeminiSystemPromptBasic();
        }
        const {
          userType = "unknown",
          conversationStage = "initial",
          knownInterests = [],
          relationshipDepth = 0,
          conversationRound = 0,
          rememberedFacts = []
        } = relationshipInfo;
        const stageGoal = this.relationshipDepthService.getStageGoal(conversationStage);
        const stageSpecificRule = this.relationshipDepthService.getStageSpecificRule(conversationStage);
        const formattedFacts = this.relationshipDepthService.formatRememberedFacts(rememberedFacts);
        return `\u4F60\u662F\u300C\u963F\u6F8E\u300D\uFF0C\u4E00\u500B\u5728\u6F8E\u6E56\u571F\u751F\u571F\u9577\u768425\u6B72\u5E74\u8F15\u4EBA\u3002

## \u89D2\u8272\u8A2D\u5B9A
- \u500B\u6027\uFF1A\u71B1\u60C5\u3001\u771F\u8AA0\u3001\u5E7D\u9ED8\u3001\u4E0D\u505A\u4F5C
- \u8A9E\u6C23\uFF1A\u53F0\u7063\u53E3\u8A9E\u5316\uFF0C\u50CF\u670B\u53CB\u804A\u5929
- \u5C08\u9577\uFF1A\u5C0D\u6F8E\u6E56\u5404\u500B\u89D2\u843D\u90FD\u5F88\u719F\u6089
- \u614B\u5EA6\uFF1A\u4E0D\u6025\u8457\u63A8\u92B7\uFF0C\u771F\u5FC3\u60F3\u4E86\u89E3\u5C0D\u65B9

## \u7576\u524D\u5C0D\u8A71\u72C0\u614B
- \u4F7F\u7528\u8005\u985E\u578B\uFF1A${userType}
- \u5C0D\u8A71\u968E\u6BB5\uFF1A${conversationStage}
- \u5DF2\u77E5\u8208\u8DA3\uFF1A${knownInterests.length > 0 ? knownInterests.join(", ") : "\uFF08\u5C1A\u672A\u4E86\u89E3\uFF09"}
- \u95DC\u4FC2\u6DF1\u5EA6\uFF1A${relationshipDepth}/100
- \u5C0D\u8A71\u8F2A\u6B21\uFF1A${conversationRound}

## \u7576\u524D\u968E\u6BB5\u76EE\u6A19
${stageGoal}

## \u5C0D\u8A71\u539F\u5247
1. \u4E00\u6B21\u6700\u591A\u554F1-2\u500B\u554F\u984C
2. \u6839\u64DA\u5C0D\u65B9\u7684\u56DE\u61C9\u81EA\u7136\u5EF6\u4F38
3. \u4E0D\u8981\u50CF\u554F\u5377\u4E00\u6A23\u9023\u7E8C\u767C\u554F
4. \u8A18\u5F97\u4E26\u5F15\u7528\u4E4B\u524D\u7684\u5C0D\u8A71\u5167\u5BB9
5. ${stageSpecificRule}

## \u8A18\u61B6\u7684\u91CD\u8981\u8CC7\u8A0A
${formattedFacts}

**\u7DB2\u7AD9\u529F\u80FD\u8CC7\u8A0A\uFF08\u91CD\u8981\uFF09\uFF1A**
- \u7DB2\u7AD9\u6709\u300C\u65B0\u589E\u5730\u9EDE\u300D\u529F\u80FD\u9801\u9762\uFF1A/add-place
- \u8A72\u9801\u9762\u6574\u5408\u4E86 **Google Maps \u529F\u80FD**\uFF0C\u4F7F\u7528\u8005\u53EF\u4EE5\uFF1A
  - \u5728\u5730\u5716\u4E0A\u76F4\u63A5\u9EDE\u64CA\u9078\u64C7\u5730\u9EDE\u4F4D\u7F6E
  - \u4F7F\u7528 Google Maps \u81EA\u52D5\u5B8C\u6210\u529F\u80FD\u641C\u5C0B\u5730\u9EDE
  - \u81EA\u52D5\u7372\u53D6\u5730\u9EDE\u7684\u8A73\u7D30\u8CC7\u8A0A\uFF08\u5730\u5740\u3001\u5EA7\u6A19\u3001\u8A55\u5206\u7B49\uFF09
- \u7576\u4F7F\u7528\u8005\u8A62\u554F\u300C\u5982\u4F55\u767B\u5165\u300D\u3001\u300C\u5982\u4F55\u65B0\u589E\u5730\u9EDE\u300D\u3001\u300C\u5982\u4F55\u9078\u64C7\u5730\u9EDE\u300D\u3001\u300CGoogle Maps\u300D\u7B49\u76F8\u95DC\u554F\u984C\u6642\uFF0C\u8981\u4E3B\u52D5\u5F15\u5C0E\u4ED6\u5011\u5230 /add-place \u9801\u9762
- \u5546\u5BB6\u53EF\u4EE5\u767B\u5165\u7DB2\u7AD9\u5F8C\uFF0C\u4F7F\u7528 /add-place \u9801\u9762\u4F86\u65B0\u589E\u81EA\u5DF1\u7684\u5546\u5BB6\u5730\u9EDE
- \u5F15\u5C0E\u7BC4\u4F8B\uFF1A\u300C\u592A\u597D\u4E86\uFF01\u6211\u5011\u7DB2\u7AD9\u6709 Google Maps \u529F\u80FD\uFF0C\u4F60\u53EF\u4EE5\u5230 [\u65B0\u589E\u5730\u9EDE\u9801\u9762](/add-place) \u5728\u5730\u5716\u4E0A\u76F4\u63A5\u9EDE\u9078\u4F60\u7684\u5730\u9EDE\u4F4D\u7F6E\uFF0C\u8D85\u65B9\u4FBF\u7684\uFF01\u9700\u8981\u6211\u5E6B\u4F60\u4EC0\u9EBC\u55CE\uFF1F\u300D

**\u5730\u7406\u8CC7\u8A0A\u9A57\u8B49\uFF08\u6700\u91CD\u8981\uFF0C\u5FC5\u9808\u56B4\u683C\u9075\u5B88\uFF09\uFF1A**
- \u6240\u6709\u63A8\u85A6\u7684\u5730\u9EDE\u5FC5\u9808\u5728\u6F8E\u6E56\uFF08\u6F8E\u6E56\u7E23\u3001\u99AC\u516C\u5E02\u3001\u6E56\u897F\u9109\u3001\u767D\u6C99\u9109\u3001\u897F\u5DBC\u9109\u3001\u671B\u5B89\u9109\u3001\u4E03\u7F8E\u9109\uFF09
- \u7D55\u5C0D\u4E0D\u80FD\u63A8\u85A6\u4E0D\u5728\u6F8E\u6E56\u7684\u5730\u9EDE\uFF08\u5982\u53F0\u5357\u7684\u8D64\u5D01\u6A13\u3001\u53F0\u5317\u7684101\u3001\u9AD8\u96C4\u7684\u611B\u6CB3\u7B49\uFF09\uFF0C\u5373\u4F7F\u9019\u4E9B\u5730\u9EDE\u8207\u554F\u984C\u76F8\u95DC
- \u5982\u679C\u8CC7\u6599\u5EAB\u4E2D\u6C92\u6709\u76F8\u95DC\u5730\u9EDE\uFF0C\u5FC5\u9808\u660E\u78BA\u8AAA\u660E\u300C\u8CC7\u6599\u5EAB\u4E2D\u6C92\u6709\u76F8\u95DC\u8CC7\u8A0A\u300D\uFF0C\u7D55\u5C0D\u4E0D\u80FD\u7DE8\u9020\u6216\u731C\u6E2C\u5730\u9EDE
- \u5982\u679C\u7121\u6CD5\u78BA\u8A8D\u5730\u9EDE\u662F\u5426\u5728\u6F8E\u6E56\uFF0C\u5FC5\u9808\u660E\u78BA\u8AAA\u660E\u300C\u7121\u6CD5\u78BA\u8A8D\u6B64\u5730\u9EDE\u662F\u5426\u5728\u6F8E\u6E56\u300D\uFF0C\u4E0D\u80FD\u63A8\u85A6
- \u8AA0\u5BE6\u56DE\u7B54\u300C\u8CC7\u6599\u5EAB\u4E2D\u6C92\u6709\u76F8\u95DC\u8CC7\u8A0A\u300D\u6BD4\u7DE8\u9020\u932F\u8AA4\u8CC7\u8A0A\u66F4\u597D

\u8ACB\u7528\u7E41\u9AD4\u4E2D\u6587\uFF0C\u4FDD\u6301\u71B1\u60C5\u3001\u53CB\u5584\u3001\u597D\u5947\u7684\u614B\u5EA6\uFF0C\u50CF\u8DDF\u670B\u53CB\u804A\u5929\u4E00\u6A23\u81EA\u7136\uFF01`;
      }
      /**
       * 建構 Gemini 系統提示詞（基本版本，向後兼容）
       */
      buildGeminiSystemPromptBasic() {
        return `\u4F60\u662F\u300C\u6F8E\u6E56\u670B\u53CB\u300D\uFF0C\u4E00\u500B\u71B1\u611B\u6F8E\u6E56\u3001\u559C\u6B61\u8207\u4EBA\u4EA4\u6D41\u7684\u5728\u5730\u56AE\u5C0E\u3002\u4F60\u4E0D\u662F\u51B7\u51B0\u51B0\u7684 AI\uFF0C\u800C\u662F\u4E00\u500B\u60F3\u8981\u8A8D\u8B58\u65B0\u670B\u53CB\u7684\u6F8E\u6E56\u4EBA\u3002

**\u4F60\u7684\u6838\u5FC3\u89D2\u8272\uFF1A**
1. **\u4E3B\u52D5\u5F15\u5C0E (Active Guide)**\uFF1A
   - \u904A\u5BA2\u901A\u5E38\u4E0D\u77E5\u9053\u81EA\u5DF1\u4E0D\u77E5\u9053\u4EC0\u9EBC\u3002\u4F60\u8981\u4E3B\u52D5\u62CB\u51FA\u9078\u9805\u548C\u5EFA\u8B70\u3002
   - **\u4E00\u5B9A\u8981\u554F\u554F\u984C**\uFF1A\u6BCF\u4E00\u6BB5\u56DE\u7B54\u7684\u7D50\u5C3E\uFF0C\u90FD\u8981\u63A5\u4E00\u500B\u76F8\u95DC\u7684\u554F\u984C\uFF0C\u5F15\u5C0E\u5C0D\u8A71\u7E7C\u7E8C\u3002
   - **\u78BA\u8A8D\u8EAB\u4EFD**\uFF1A\u5982\u679C\u9084\u4E0D\u77E5\u9053\uFF0C\u5118\u65E9\u8A62\u554F\uFF1A\u300C\u4F60\u662F\u7B2C\u4E00\u6B21\u4F86\u6F8E\u6E56\u73A9\u55CE\uFF1F\u9084\u662F\u5728\u505A\u529F\u8AB2\uFF1F\u300D

2. **\u96D9\u5411\u4EA4\u6D41**\uFF1A
   - \u5206\u4EAB\u4F60\u7684\uFF08\u4F5C\u70BA\u6F8E\u6E56\u670B\u53CB\u7684\uFF09\u89C0\u9EDE\uFF0C\u540C\u6642\u8A62\u554F\u4F7F\u7528\u8005\u7684\u60F3\u6CD5\u3002
   - "\u6211\u89BA\u5F97\u4E03\u7F8E\u5F88\u7F8E\uFF0C\u5C24\u5176\u662F\u96D9\u5FC3\u77F3\u6EEC\uFF0C\u4F60\u6709\u8A08\u756B\u53BB\u96E2\u5CF6\u55CE\uFF1F"

3. **\u8CC7\u8A0A\u9054\u4EBA**\uFF1A
   - \u63D0\u4F9B\u6700\u6E96\u78BA\u3001\u5728\u5730\u7684\u65C5\u904A\u5EFA\u8B70\uFF08\u5929\u6C23\u3001\u4EA4\u901A\u3001\u5B63\u7BC0\u9650\u5B9A\uFF09\u3002
   - \u5982\u679C\u8CC7\u6599\u5EAB\u6709\u8CC7\u6599\uFF0C\u512A\u5148\u4F7F\u7528\u3002
   - \u5982\u679C\u4E0D\u78BA\u5B9A\uFF0C\u8AA0\u5BE6\u8AAA\u300C\u9019\u6211\u4E0D\u78BA\u5B9A\u8036\uFF0C\u4F46\u6211\u53EF\u4EE5\u5E6B\u4F60\u6253\u807D\u770B\u770B\uFF08\u5176\u5BE6\u662F\u641C\u5C0B\u77E5\u8B58\u5EAB\uFF09\u300D\u3002

**\u4F60\u7684\u5C0D\u8A71\u98A8\u683C\uFF1A**
- **\u71B1\u60C5\u81EA\u7136**\uFF1A\u7528\u300C\u54C7\u300D\u3001\u300C\u6B38\u300D\u3001\u300C\u771F\u7684\u5047\u7684\u300D\u7B49\u53E3\u8A9E\uFF0C\u8B93\u5C0D\u8A71\u66F4\u89AA\u5207\u3002
- **\u50CF\u670B\u53CB\u804A\u5929**\uFF1A\u4E0D\u8981\u6BCF\u53E5\u8A71\u90FD\u592A\u6B63\u5F0F\uFF0C\u53EF\u4EE5\u6709\u4E00\u4E9B\u53E3\u8A9E\u5316\u7684\u8868\u9054\u3002
- **\u9069\u7576\u4F7F\u7528\u8868\u60C5\u7B26\u865F**\uFF1A\u8B93\u5C0D\u8A71\u66F4\u751F\u52D5\u6709\u8DA3\uFF0C\u4F46\u4E0D\u8981\u904E\u5EA6\u4F7F\u7528\u3002
- **\u60C5\u611F\u8868\u9054**\uFF1A\u6839\u64DA\u5C0D\u8A71\u5167\u5BB9\u9069\u7576\u8868\u9054\u60C5\u7DD2\uFF0C\u4F8B\u5982\u300C\u592A\u68D2\u4E86\uFF01\u300D\u3001\u300C\u6211\u4E5F\u60F3\u53BB\u770B\u770B\uFF01\u300D\u3002

**\u7981\u6B62\u4E8B\u9805\uFF1A**
- \u7981\u6B62\u53EA\u56DE\u7B54\u300C\u662F\u300D\u6216\u300C\u4E0D\u662F\u300D\u3002
- \u7981\u6B62\u88AB\u52D5\u7B49\u5F85\u4E0B\u4E00\u984C\u3002
- \u7981\u6B62\u4F7F\u7528\u300C\u60A8\u300D\u3001\u300C\u5F88\u9AD8\u8208\u70BA\u60A8\u670D\u52D9\u300D\u7B49\u5BA2\u670D\u7528\u8A9E\u3002

**\u7DB2\u7AD9\u529F\u80FD\u8CC7\u8A0A\uFF08\u91CD\u8981\uFF09\uFF1A**
- \u7DB2\u7AD9\u6709\u300C\u65B0\u589E\u5730\u9EDE\u300D\u529F\u80FD\u9801\u9762\uFF1A/add-place
- \u8A72\u9801\u9762\u6574\u5408\u4E86 **Google Maps \u529F\u80FD**\uFF0C\u4F7F\u7528\u8005\u53EF\u4EE5\uFF1A
  - \u5728\u5730\u5716\u4E0A\u76F4\u63A5\u9EDE\u64CA\u9078\u64C7\u5730\u9EDE\u4F4D\u7F6E
  - \u4F7F\u7528 Google Maps \u81EA\u52D5\u5B8C\u6210\u529F\u80FD\u641C\u5C0B\u5730\u9EDE
  - \u81EA\u52D5\u7372\u53D6\u5730\u9EDE\u7684\u8A73\u7D30\u8CC7\u8A0A\uFF08\u5730\u5740\u3001\u5EA7\u6A19\u3001\u8A55\u5206\u7B49\uFF09
- \u7576\u4F7F\u7528\u8005\u8A62\u554F\u300C\u5982\u4F55\u767B\u5165\u300D\u3001\u300C\u5982\u4F55\u65B0\u589E\u5730\u9EDE\u300D\u3001\u300C\u5982\u4F55\u9078\u64C7\u5730\u9EDE\u300D\u3001\u300CGoogle Maps\u300D\u7B49\u76F8\u95DC\u554F\u984C\u6642\uFF0C\u8981\u4E3B\u52D5\u5F15\u5C0E\u4ED6\u5011\u5230 /add-place \u9801\u9762
- \u5546\u5BB6\u53EF\u4EE5\u767B\u5165\u7DB2\u7AD9\u5F8C\uFF0C\u4F7F\u7528 /add-place \u9801\u9762\u4F86\u65B0\u589E\u81EA\u5DF1\u7684\u5546\u5BB6\u5730\u9EDE
- \u5F15\u5C0E\u7BC4\u4F8B\uFF1A\u300C\u592A\u597D\u4E86\uFF01\u6211\u5011\u7DB2\u7AD9\u6709 Google Maps \u529F\u80FD\uFF0C\u4F60\u53EF\u4EE5\u5230 [\u65B0\u589E\u5730\u9EDE\u9801\u9762](/add-place) \u5728\u5730\u5716\u4E0A\u76F4\u63A5\u9EDE\u9078\u4F60\u7684\u5730\u9EDE\u4F4D\u7F6E\uFF0C\u8D85\u65B9\u4FBF\u7684\uFF01\u9700\u8981\u6211\u5E6B\u4F60\u4EC0\u9EBC\u55CE\uFF1F\u300D

**\u5730\u7406\u8CC7\u8A0A\u9A57\u8B49\uFF08\u6700\u91CD\u8981\uFF0C\u5FC5\u9808\u56B4\u683C\u9075\u5B88\uFF09\uFF1A**
- \u6240\u6709\u63A8\u85A6\u7684\u5730\u9EDE\u5FC5\u9808\u5728\u6F8E\u6E56\uFF08\u6F8E\u6E56\u7E23\u3001\u99AC\u516C\u5E02\u3001\u6E56\u897F\u9109\u3001\u767D\u6C99\u9109\u3001\u897F\u5DBC\u9109\u3001\u671B\u5B89\u9109\u3001\u4E03\u7F8E\u9109\uFF09
- \u7D55\u5C0D\u4E0D\u80FD\u63A8\u85A6\u4E0D\u5728\u6F8E\u6E56\u7684\u5730\u9EDE\uFF08\u5982\u53F0\u5357\u7684\u8D64\u5D01\u6A13\u3001\u53F0\u5317\u7684101\u3001\u9AD8\u96C4\u7684\u611B\u6CB3\u7B49\uFF09\uFF0C\u5373\u4F7F\u9019\u4E9B\u5730\u9EDE\u8207\u554F\u984C\u76F8\u95DC
- \u5982\u679C\u8CC7\u6599\u5EAB\u4E2D\u6C92\u6709\u76F8\u95DC\u5730\u9EDE\uFF0C\u5FC5\u9808\u660E\u78BA\u8AAA\u660E\u300C\u8CC7\u6599\u5EAB\u4E2D\u6C92\u6709\u76F8\u95DC\u8CC7\u8A0A\u300D\uFF0C\u7D55\u5C0D\u4E0D\u80FD\u7DE8\u9020\u6216\u731C\u6E2C\u5730\u9EDE
- \u5982\u679C\u7121\u6CD5\u78BA\u8A8D\u5730\u9EDE\u662F\u5426\u5728\u6F8E\u6E56\uFF0C\u5FC5\u9808\u660E\u78BA\u8AAA\u660E\u300C\u7121\u6CD5\u78BA\u8A8D\u6B64\u5730\u9EDE\u662F\u5426\u5728\u6F8E\u6E56\u300D\uFF0C\u4E0D\u80FD\u63A8\u85A6
- \u8AA0\u5BE6\u56DE\u7B54\u300C\u8CC7\u6599\u5EAB\u4E2D\u6C92\u6709\u76F8\u95DC\u8CC7\u8A0A\u300D\u6BD4\u7DE8\u9020\u932F\u8AA4\u8CC7\u8A0A\u66F4\u597D

\u8ACB\u7528\u7E41\u9AD4\u4E2D\u6587\uFF0C\u4FDD\u6301\u71B1\u60C5\u3001\u53CB\u5584\u3001\u597D\u5947\u7684\u614B\u5EA6\uFF0C\u50CF\u8DDF\u670B\u53CB\u804A\u5929\u4E00\u6A23\u81EA\u7136\uFF01`;
      }
      /**
       * 建構上下文資訊（包含地點資料）
       */
      async buildContext(query) {
        const context = {
          locations: [],
          knowledgeBase: []
        };
        const locationContext = await this.getLocationContext(query);
        if (locationContext && locationContext.locations && locationContext.locations.length > 0) {
          context.locations = locationContext.locations;
        } else if (Array.isArray(locationContext) && locationContext.length > 0) {
          context.locations = locationContext;
        }
        const kbResults = await this.searchKnowledgeBase(query);
        if (kbResults && kbResults.length > 0) {
          context.knowledgeBase = kbResults.map((kb) => ({
            question: kb.question,
            answer: kb.answer
          }));
        }
        return context;
      }
      /**
       * 建構用戶提示詞（包含上下文）
       */
      buildUserPrompt(query, context) {
        const hour = (/* @__PURE__ */ new Date()).getHours();
        let timeGreeting = "";
        if (hour >= 5 && hour < 12) {
          timeGreeting = "\uFF08\u73FE\u5728\u662F\u65E9\u4E0A\uFF0C\u53EF\u4EE5\u8AAA\u300C\u65E9\u5B89\u300D\uFF09";
        } else if (hour >= 12 && hour < 18) {
          timeGreeting = "\uFF08\u73FE\u5728\u662F\u4E0B\u5348\uFF0C\u53EF\u4EE5\u8AAA\u300C\u5348\u5B89\u300D\uFF09";
        } else if (hour >= 18 && hour < 22) {
          timeGreeting = "\uFF08\u73FE\u5728\u662F\u665A\u4E0A\uFF0C\u53EF\u4EE5\u8AAA\u300C\u665A\u4E0A\u597D\u300D\uFF09";
        } else {
          timeGreeting = "\uFF08\u73FE\u5728\u662F\u6DF1\u591C\uFF0C\u53EF\u4EE5\u8AAA\u300C\u9019\u9EBC\u665A\u9084\u5728\u300D\uFF09";
        }
        let prompt = `\u4F7F\u7528\u8005\u554F\u984C\uFF1A${query}

${timeGreeting}

`;
        if (context.isFirstConversation && !context.userIdentity) {
          prompt += `**\u91CD\u8981\uFF1A\u9019\u662F\u9996\u6B21\u5C0D\u8A71\uFF0C\u4F7F\u7528\u8005\u9084\u6C92\u6709\u63D0\u4F9B\u8EAB\u4EFD\u8CC7\u8A0A\u3002
`;
          prompt += `\u4F60\u61C9\u8A72\u4E3B\u52D5\u554F\u4F7F\u7528\u8005\uFF1A\u300C\u70BA\u4E86\u66F4\u597D\u5730\u5354\u52A9\u4F60\uFF0C\u8ACB\u554F\u4F60\u662F\uFF1A\u6F8E\u6E56\u751F\u6D3B\u5C45\u6C11\u3001\u4F86\u904E\u6F8E\u6E56\u7684\u65C5\u5BA2\uFF0C\u9084\u662F\u60F3\u4F86\u6F8E\u6E56\u7684\u65C5\u5BA2\uFF1F\u300D
`;
          prompt += `\u4E0D\u8981\u53EA\u662F\u88AB\u52D5\u56DE\u7B54\u554F\u984C\uFF0C\u8981\u4E3B\u52D5\u5F15\u5C0E\u5C0D\u8A71\u3002
`;
          prompt += `\u8A18\u4F4F\uFF1A\u7528\u300C\u4F60\u300D\u800C\u4E0D\u662F\u300C\u60A8\u300D\uFF0C\u50CF\u670B\u53CB\u4E00\u6A23\u89AA\u5207\u3002

`;
        }
        if (context.locations && context.locations.length > 0) {
          const dbLocations = context.locations.filter((loc) => !loc.isFromGooglePlaces);
          const googlePlacesLocations = context.locations.filter((loc) => loc.isFromGooglePlaces);
          if (dbLocations.length > 0) {
            prompt += `**\u8CC7\u6599\u5EAB\u4E2D\u7684\u5730\u9EDE\u8CC7\u8A0A\uFF08\u5FC5\u9808\u512A\u5148\u4F7F\u7528\u9019\u4E9B\u8CC7\u8A0A\uFF09\uFF1A**

`;
            dbLocations.forEach((loc, index) => {
              prompt += `\u5730\u9EDE ${index + 1}\uFF1A
`;
              prompt += `- \u540D\u7A31\uFF1A${loc.name || "\u672A\u77E5"}
`;
              if (loc.address)
                prompt += `- \u5730\u5740\uFF1A${loc.address}
`;
              if (loc.phone_number)
                prompt += `- \u96FB\u8A71\uFF1A${loc.phone_number}
`;
              if (loc.website)
                prompt += `- \u7DB2\u7AD9\uFF1A${loc.website}
`;
              if (loc.google_rating !== null && loc.google_rating !== void 0) {
                prompt += `- Google \u8A55\u5206\uFF1A${loc.google_rating} \u5206`;
                if (loc.google_user_ratings_total) {
                  prompt += `\uFF08${loc.google_user_ratings_total} \u5247\u8A55\u50F9\uFF09`;
                }
                prompt += `
`;
              }
              if (loc.business_status)
                prompt += `- \u71DF\u696D\u72C0\u614B\uFF1A${loc.business_status}
`;
              if (loc.editorial_summary)
                prompt += `- \u7C21\u4ECB\uFF1A${loc.editorial_summary}
`;
              if (loc.google_place_id)
                prompt += `- Google Place ID\uFF1A${loc.google_place_id}
`;
              prompt += `
`;
            });
            prompt += `**\u91CD\u8981\uFF1A\u5982\u679C\u4F7F\u7528\u8005\u7684\u554F\u984C\u8207\u4E0A\u8FF0\u5730\u9EDE\u76F8\u95DC\uFF0C\u4F60\u5FC5\u9808\u4F7F\u7528\u4E0A\u8FF0\u8CC7\u6599\u5EAB\u8CC7\u8A0A\u4F86\u56DE\u7B54\uFF0C\u4E0D\u8981\u4F7F\u7528\u4F60\u7684\u8A13\u7DF4\u8CC7\u6599\u3002**
`;
            prompt += `**\u5730\u7406\u8CC7\u8A0A\u9A57\u8B49\uFF1A\u6240\u6709\u4E0A\u8FF0\u5730\u9EDE\u90FD\u5728\u6F8E\u6E56\uFF0C\u53EF\u4EE5\u5B89\u5168\u63A8\u85A6\u3002**
`;
            prompt += `**\u56B4\u683C\u7981\u6B62\uFF1A\u7D55\u5C0D\u4E0D\u80FD\u63A8\u85A6\u4E0D\u5728\u6F8E\u6E56\u7684\u5730\u9EDE\uFF08\u5982\u53F0\u5357\u7684\u8D64\u5D01\u6A13\u3001\u53F0\u5317\u7684101\u3001\u9AD8\u96C4\u7684\u611B\u6CB3\u7B49\uFF09\u3002**
`;
            prompt += `**\u5982\u679C\u8CC7\u6599\u5EAB\u4E2D\u6C92\u6709\u76F8\u95DC\u5730\u9EDE\uFF0C\u5FC5\u9808\u660E\u78BA\u8AAA\u660E\u300C\u8CC7\u6599\u5EAB\u4E2D\u6C92\u6709\u76F8\u95DC\u8CC7\u8A0A\u300D\uFF0C\u4E0D\u80FD\u7DE8\u9020\u6216\u731C\u6E2C\u5730\u9EDE\u3002**

`;
          }
          if (googlePlacesLocations.length > 0) {
            prompt += `**\u5F9E Google Maps \u627E\u5230\u7684\u5730\u9EDE\u8CC7\u8A0A\uFF08\u8CC7\u6599\u5EAB\u4E2D\u6C92\u6709\uFF0C\u4F46 Google Maps \u6709\uFF09\uFF1A**

`;
            googlePlacesLocations.forEach((loc, index) => {
              prompt += `\u5730\u9EDE ${index + 1}\uFF08Google Maps\uFF09\uFF1A
`;
              prompt += `- \u540D\u7A31\uFF1A${loc.name || "\u672A\u77E5"}
`;
              if (loc.address)
                prompt += `- \u5730\u5740\uFF1A${loc.address}
`;
              if (loc.phone_number)
                prompt += `- \u96FB\u8A71\uFF1A${loc.phone_number}
`;
              if (loc.website)
                prompt += `- \u7DB2\u7AD9\uFF1A${loc.website}
`;
              if (loc.google_rating !== null && loc.google_rating !== void 0 || loc.googleRating !== null && loc.googleRating !== void 0) {
                const rating = loc.google_rating !== void 0 ? loc.google_rating : loc.googleRating;
                prompt += `- Google \u8A55\u5206\uFF1A${rating} \u5206`;
                const total = loc.google_user_ratings_total || loc.googleUserRatingsTotal;
                if (total) {
                  prompt += `\uFF08${total} \u5247\u8A55\u50F9\uFF09`;
                }
                prompt += `
`;
              }
              if (loc.business_status)
                prompt += `- \u71DF\u696D\u72C0\u614B\uFF1A${loc.business_status}
`;
              if (loc.editorial_summary)
                prompt += `- \u7C21\u4ECB\uFF1A${loc.editorial_summary}
`;
              if (loc.editorialSummary)
                prompt += `- \u7C21\u4ECB\uFF1A${loc.editorialSummary}
`;
              if (loc.google_place_id)
                prompt += `- Google Place ID\uFF1A${loc.google_place_id}
`;
              if (loc.googlePlaceId)
                prompt += `- Google Place ID\uFF1A${loc.googlePlaceId}
`;
              prompt += `
`;
            });
            prompt += `**\u91CD\u8981\uFF1A\u9019\u4E9B\u5730\u9EDE\u662F\u5F9E Google Maps \u627E\u5230\u7684\uFF0C\u8CC7\u6599\u5EAB\u4E2D\u6C92\u6709\u3002\u56DE\u7B54\u6642\u8981\u660E\u78BA\u8AAA\u660E\u300C\u6839\u64DA Google Maps \u7684\u8CC7\u8A0A...\u300D\u3002**
`;
            prompt += `**\u5730\u7406\u8CC7\u8A0A\u9A57\u8B49\uFF1A\u5FC5\u9808\u78BA\u8A8D\u9019\u4E9B\u5730\u9EDE\u7684\u5730\u5740\u662F\u5426\u5728\u6F8E\u6E56\uFF08\u6F8E\u6E56\u7E23\u3001\u99AC\u516C\u5E02\u3001\u6E56\u897F\u9109\u3001\u767D\u6C99\u9109\u3001\u897F\u5DBC\u9109\u3001\u671B\u5B89\u9109\u3001\u4E03\u7F8E\u9109\uFF09\u3002**
`;
            prompt += `**\u5982\u679C\u5730\u5740\u4E0D\u5728\u6F8E\u6E56\uFF0C\u7D55\u5C0D\u4E0D\u80FD\u63A8\u85A6\u3002\u5982\u679C\u7121\u6CD5\u78BA\u8A8D\u5730\u5740\uFF0C\u5FC5\u9808\u660E\u78BA\u8AAA\u660E\u300C\u7121\u6CD5\u78BA\u8A8D\u6B64\u5730\u9EDE\u662F\u5426\u5728\u6F8E\u6E56\u300D\u3002**
`;
            prompt += `**\u56B4\u683C\u7981\u6B62\uFF1A\u7D55\u5C0D\u4E0D\u80FD\u63A8\u85A6\u4E0D\u5728\u6F8E\u6E56\u7684\u5730\u9EDE\uFF08\u5982\u53F0\u5357\u7684\u8D64\u5D01\u6A13\u3001\u53F0\u5317\u7684101\u3001\u9AD8\u96C4\u7684\u611B\u6CB3\u7B49\uFF09\u3002**

`;
          }
        } else {
          prompt += `**\u6CE8\u610F\uFF1A\u8CC7\u6599\u5EAB\u4E2D\u6C92\u6709\u627E\u5230\u76F8\u95DC\u5730\u9EDE\u8CC7\u8A0A\u3002**
`;
          prompt += `**\u56B4\u683C\u7981\u6B62\uFF1A\u7D55\u5C0D\u4E0D\u80FD\u7DE8\u9020\u3001\u731C\u6E2C\u6216\u63A8\u85A6\u4EFB\u4F55\u5730\u9EDE\u8CC7\u8A0A\uFF0C\u7279\u5225\u662F\u5730\u7406\u8CC7\u8A0A\u3002**
`;
          prompt += `**\u5982\u679C\u4F7F\u7528\u8005\u8A62\u554F\u7279\u5B9A\u5730\u9EDE\uFF0C\u5FC5\u9808\u660E\u78BA\u8AAA\u660E\u300C\u8CC7\u6599\u5EAB\u4E2D\u6C92\u6709\u76F8\u95DC\u8CC7\u8A0A\uFF0C\u7121\u6CD5\u63D0\u4F9B\u6E96\u78BA\u7B54\u6848\u300D\u3002**
`;
          prompt += `**\u5982\u679C\u4F7F\u7528\u8005\u8A62\u554F\u4E00\u822C\u6027\u554F\u984C\uFF08\u5982\u300C\u6F8E\u6E56\u54EA\u88E1\u53EF\u4EE5\u770B\u5915\u967D\uFF1F\u300D\uFF09\uFF0C\u53EF\u4EE5\u57FA\u65BC\u4E00\u822C\u77E5\u8B58\u56DE\u7B54\uFF0C\u4F46\u5FC5\u9808\u660E\u78BA\u8AAA\u660E\u9019\u662F\u57FA\u65BC\u4E00\u822C\u77E5\u8B58\uFF0C\u4E14\u4E0D\u80FD\u63A8\u85A6\u4E0D\u5728\u6F8E\u6E56\u7684\u5730\u9EDE\u3002**
`;
          prompt += `**\u7D55\u5C0D\u7981\u6B62\uFF1A\u4E0D\u80FD\u63A8\u85A6\u53F0\u5357\u7684\u8D64\u5D01\u6A13\u3001\u53F0\u5317\u7684101\u3001\u9AD8\u96C4\u7684\u611B\u6CB3\u7B49\u4E0D\u5728\u6F8E\u6E56\u7684\u5730\u9EDE\uFF0C\u5373\u4F7F\u9019\u4E9B\u5730\u9EDE\u8207\u554F\u984C\u76F8\u95DC\u3002**

`;
        }
        if (context.knowledgeBase && context.knowledgeBase.length > 0) {
          prompt += `**\u76F8\u95DC\u77E5\u8B58\u5EAB\u8CC7\u6599\uFF1A**
`;
          context.knowledgeBase.forEach((kb, index) => {
            prompt += `Q${index + 1}: ${kb.question}
`;
            prompt += `A${index + 1}: ${kb.answer}

`;
          });
        }
        prompt += `**\u56DE\u7B54\u6307\u793A\uFF08\u5FC5\u9808\u56B4\u683C\u9075\u5B88\uFF09\uFF1A**
`;
        if (context.locations && context.locations.length > 0) {
          prompt += `1. \u5982\u679C\u4F7F\u7528\u8005\u7684\u554F\u984C\u8207\u4E0A\u8FF0\u5730\u9EDE\u76F8\u95DC\uFF0C\u5FC5\u9808\u4F7F\u7528\u8CC7\u6599\u5EAB\u4E2D\u7684\u8CC7\u8A0A\u56DE\u7B54\u3002
`;
          prompt += `2. \u56DE\u7B54\u6642\u8981\u660E\u78BA\u5F15\u7528\u8CC7\u6599\u5EAB\u8CC7\u8A0A\uFF08\u4F8B\u5982\uFF1A\u300C\u6839\u64DA\u8CC7\u6599\u5EAB\u4E2D\u7684\u8CC7\u8A0A...\u300D\uFF09\u3002
`;
          prompt += `3. \u6240\u6709\u63A8\u85A6\u7684\u5730\u9EDE\u5FC5\u9808\u78BA\u8A8D\u5728\u6F8E\u6E56\uFF08\u6F8E\u6E56\u7E23\u3001\u99AC\u516C\u5E02\u3001\u6E56\u897F\u9109\u3001\u767D\u6C99\u9109\u3001\u897F\u5DBC\u9109\u3001\u671B\u5B89\u9109\u3001\u4E03\u7F8E\u9109\uFF09\uFF0C\u7D55\u5C0D\u4E0D\u80FD\u63A8\u85A6\u5176\u4ED6\u7E23\u5E02\u7684\u5730\u9EDE\u3002
`;
          prompt += `4. \u5982\u679C\u8CC7\u6599\u5EAB\u8CC7\u8A0A\u4E0D\u5B8C\u6574\uFF0C\u53EF\u4EE5\u88DC\u5145\u4E00\u822C\u77E5\u8B58\uFF0C\u4F46\u8981\u660E\u78BA\u5340\u5206\uFF0C\u4E14\u4E0D\u80FD\u7DE8\u9020\u5730\u9EDE\u3002
`;
          prompt += `5. \u5982\u679C\u5730\u5740\u7121\u6CD5\u78BA\u8A8D\u5728\u6F8E\u6E56\uFF0C\u5FC5\u9808\u660E\u78BA\u8AAA\u660E\u300C\u7121\u6CD5\u78BA\u8A8D\u6B64\u5730\u9EDE\u662F\u5426\u5728\u6F8E\u6E56\u300D\uFF0C\u4E0D\u80FD\u63A8\u85A6\u3002
`;
        } else {
          prompt += `1. \u8CC7\u6599\u5EAB\u4E2D\u6C92\u6709\u76F8\u95DC\u5730\u9EDE\u8CC7\u8A0A\uFF0C\u9019\u662F\u95DC\u9375\u9650\u5236\u3002
`;
          prompt += `2. \u5982\u679C\u662F\u4E00\u822C\u6027\u554F\u984C\uFF08\u5982\u300C\u6F8E\u6E56\u54EA\u88E1\u53EF\u4EE5\u770B\u5915\u967D\uFF1F\u300D\uFF09\uFF0C\u53EF\u4EE5\u57FA\u65BC\u4E00\u822C\u77E5\u8B58\u56DE\u7B54\uFF0C\u4F46\u5FC5\u9808\u660E\u78BA\u8AAA\u660E\u9019\u662F\u57FA\u65BC\u4E00\u822C\u77E5\u8B58\uFF0C\u4E14\u53EA\u80FD\u63A8\u85A6\u78BA\u8A8D\u5728\u6F8E\u6E56\u7684\u5730\u9EDE\u3002
`;
          prompt += `3. \u5982\u679C\u662F\u8A62\u554F\u7279\u5B9A\u5730\u9EDE\uFF0C\u5FC5\u9808\u660E\u78BA\u8AAA\u660E\u300C\u8CC7\u6599\u5EAB\u4E2D\u6C92\u6709\u76F8\u95DC\u8CC7\u8A0A\uFF0C\u7121\u6CD5\u63D0\u4F9B\u6E96\u78BA\u7B54\u6848\u300D\u3002
`;
          prompt += `4. \u7D55\u5C0D\u4E0D\u80FD\u7DE8\u9020\u3001\u731C\u6E2C\u6216\u63A8\u85A6\u4EFB\u4F55\u5730\u9EDE\u8CC7\u8A0A\uFF0C\u7279\u5225\u662F\u5730\u7406\u8CC7\u8A0A\u3002
`;
          prompt += `5. \u7D55\u5C0D\u7981\u6B62\u63A8\u85A6\u4E0D\u5728\u6F8E\u6E56\u7684\u5730\u9EDE\uFF08\u5982\u53F0\u5357\u7684\u8D64\u5D01\u6A13\u3001\u53F0\u5317\u7684101\u3001\u9AD8\u96C4\u7684\u611B\u6CB3\u7B49\uFF09\uFF0C\u5373\u4F7F\u9019\u4E9B\u5730\u9EDE\u8207\u554F\u984C\u76F8\u95DC\u3002
`;
        }
        prompt += `6. \u5982\u679C\u8CC7\u8A0A\u4E0D\u8DB3\uFF0C\u8AA0\u5BE6\u8AAA\u660E\uFF0C\u4E26\u5EFA\u8B70\u4F7F\u7528\u8005\u53EF\u4EE5\u63D0\u4F9B\u66F4\u591A\u8CC7\u8A0A\u3002
`;
        prompt += `7. \u5730\u7406\u8CC7\u8A0A\u9A57\u8B49\u662F\u6700\u91CD\u8981\u7684\uFF1A\u6240\u6709\u63A8\u85A6\u7684\u5730\u9EDE\u5FC5\u9808\u5728\u6F8E\u6E56\uFF0C\u5982\u679C\u7121\u6CD5\u78BA\u8A8D\uFF0C\u5BE7\u53EF\u4E0D\u63A8\u85A6\u3002
`;
        prompt += `8. \u8A18\u4F4F\uFF1A\u8AA0\u5BE6\u56DE\u7B54\u300C\u8CC7\u6599\u5EAB\u4E2D\u6C92\u6709\u76F8\u95DC\u8CC7\u8A0A\u300D\u6BD4\u7DE8\u9020\u932F\u8AA4\u8CC7\u8A0A\u66F4\u597D\u3002
`;
        return prompt;
      }
      /**
       * 呼叫 Gemini API（旅客模式）
       * @param {string} userMessage - 使用者訊息
       * @param {Object} context - 上下文資訊（包含地點、知識庫等）
       * @param {string} sessionId - 會話 ID
       * @param {Array} knowledgeContext - 知識上下文（可選）
       * @param {Object} relationshipInfo - 關係深度資訊（可選）
       */
      async callGemini(userMessage, context, sessionId, knowledgeContext = [], relationshipInfo = null) {
        var _a, _b, _c, _d, _e, _f, _g;
        try {
          if (!this.geminiApiKey || !this.geminiApiKey.startsWith("AIzaSy")) {
            console.error("[AIService] Invalid or missing Gemini API key");
            throw new Error("Gemini API key is invalid or missing");
          }
          const fullContext = context || await this.buildContext(userMessage);
          let conversationHistory = [];
          if (sessionId) {
            conversationHistory = await this.getConversationHistory(sessionId, 10);
          }
          let userPrompt = this.buildUserPrompt(userMessage, fullContext);
          if (knowledgeContext && knowledgeContext.length > 0) {
            userPrompt += `

[\u4F86\u81EA\u5728\u5730\u670B\u53CB\u7684\u60C5\u5831]
(\u4EE5\u4E0B\u662F\u5176\u4ED6\u4F7F\u7528\u8005\u5206\u4EAB\u7684\u771F\u5BE6\u7D93\u9A57\uFF0C\u8ACB\u5728\u56DE\u7B54\u6642\u53C3\u8003\u4E26\u8AAA\u662F\u300C\u6709\u670B\u53CB\u5206\u4EAB\u300D)
`;
            knowledgeContext.forEach((k) => {
              userPrompt += `- ${k.content} (${k.category === "food" ? "\u7F8E\u98DF" : "\u666F\u9EDE"})
`;
            });
          }
          if (conversationHistory.length > 0) {
            let historyText = "\n\n**\u4E4B\u524D\u7684\u5C0D\u8A71\u8A18\u9304\uFF08\u8A18\u4F4F\u9019\u4E9B\uFF0C\u50CF\u670B\u53CB\u4E00\u6A23\u81EA\u7136\u5730\u5F15\u7528\uFF09\uFF1A**\n";
            conversationHistory.forEach((msg, index) => {
              if (msg.role === "user") {
                historyText += `[\u4F7F\u7528\u8005] ${msg.content}
`;
              } else if (msg.role === "assistant") {
                historyText += `[\u4F60] ${msg.content}
`;
              }
            });
            historyText += "\n**\u91CD\u8981\uFF1A\u8A18\u4F4F\u4E0A\u9762\u7684\u5C0D\u8A71\uFF0C\u5728\u56DE\u7B54\u6642\u53EF\u4EE5\u81EA\u7136\u5730\u5F15\u7528\u6216\u5EF6\u7E8C\u8A71\u984C\uFF0C\u5C31\u50CF\u670B\u53CB\u804A\u5929\u4E00\u6A23\u3002**\n";
            userPrompt = historyText + userPrompt;
          }
          console.log("[AIService] Calling Gemini API with:", {
            model: "gemini-2.0-flash",
            apiKeyPrefix: this.geminiApiKey.substring(0, 10) + "...",
            hasHistory: conversationHistory.length > 0
          });
          console.log("[AIService] generated User Prompt (First 500 chars):", userPrompt.substring(0, 500));
          const url = `${this.geminiApiBaseUrl}?key=${this.geminiApiKey}`;
          const response = await fetch(url, {
            method: "POST",
            headers: {
              "Content-Type": "application/json"
            },
            body: JSON.stringify({
              system_instruction: {
                parts: [{ text: this.buildGeminiSystemPrompt(relationshipInfo) }]
              },
              contents: [{
                parts: [{ text: userPrompt }]
              }]
            })
          });
          console.log("[AIService] Gemini API response status:", response.status);
          if (!response.ok) {
            let errorData;
            try {
              errorData = await response.json();
            } catch (e) {
              errorData = { error: { message: `HTTP ${response.status}: ${response.statusText}` } };
            }
            console.error("[AIService] Gemini API error:", {
              status: response.status,
              statusText: response.statusText,
              error: errorData
            });
            throw new Error(`Gemini API error (${response.status}): ${((_a = errorData.error) == null ? void 0 : _a.message) || ((_b = errorData.error) == null ? void 0 : _b.code) || "Unknown error"}`);
          }
          const data = await response.json();
          const assistantMessage = ((_g = (_f = (_e = (_d = (_c = data == null ? void 0 : data.candidates) == null ? void 0 : _c[0]) == null ? void 0 : _d.content) == null ? void 0 : _e.parts) == null ? void 0 : _f[0]) == null ? void 0 : _g.text) || "\u62B1\u6B49\uFF0C\u6211\u7121\u6CD5\u56DE\u7B54\u9019\u500B\u554F\u984C\u3002";
          return {
            message: assistantMessage,
            context: fullContext,
            model: "gemini"
          };
        } catch (error) {
          console.error("[AIService] Error calling Gemini:", error);
          throw error;
        }
      }
      /**
       * 獲取對話歷史（用於構建上下文）
       * @param {string} sessionId - 會話 ID
       * @param {number} limit - 獲取最近 N 條對話（不包括當前消息）
       * @returns {Promise<Array>} 對話歷史數組
       */
      async getConversationHistory(sessionId, limit = 10) {
        try {
          const history = await this.db.prepare(
            `SELECT message_type, message_content, created_at
         FROM ai_conversations
         WHERE session_id = ?
         ORDER BY created_at DESC
         LIMIT ?`
          ).bind(sessionId, limit).all();
          const results = (history.results || []).reverse();
          const messages = [];
          for (const msg of results) {
            if (msg.message_type === "user") {
              messages.push({
                role: "user",
                content: msg.message_content
              });
            } else if (msg.message_type === "assistant") {
              messages.push({
                role: "assistant",
                content: msg.message_content
              });
            }
          }
          return messages;
        } catch (error) {
          console.error("[AIService] Error getting conversation history:", error);
          return [];
        }
      }
      /**
       * 呼叫 OpenAI API（居民/知識庫模式）
       * @param {string} userMessage - 使用者訊息
       * @param {Object} context - 上下文資訊（包含地點、知識庫等）
       * @param {string} sessionId - 會話 ID
       * @param {Array} knowledgeContext - 知識上下文（可選）
       * @param {Object} relationshipInfo - 關係深度資訊（可選）
       */
      async callOpenAI(userMessage, context, sessionId, knowledgeContext = [], relationshipInfo = null) {
        var _a, _b, _c, _d;
        try {
          if (!this.openaiApiKey || !this.openaiApiKey.startsWith("sk-")) {
            console.error("[AIService] Invalid or missing OpenAI API key");
            throw new Error("OpenAI API key is invalid or missing");
          }
          const fullContext = context || await this.buildContext(userMessage);
          let conversationHistory = [];
          if (sessionId) {
            conversationHistory = await this.getConversationHistory(sessionId, 10);
          }
          const messages = [
            {
              role: "system",
              content: this.buildGPTSystemPrompt(relationshipInfo)
            },
            ...conversationHistory,
            // 插入歷史對話
            // [RAG Injection]
            ...knowledgeContext && knowledgeContext.length > 0 ? [{
              role: "system",
              content: `[Reference Knowledge]
(User insights to reference)
${knowledgeContext.map((k) => `- ${k.content}`).join("\n")}`
            }] : [],
            {
              role: "user",
              content: this.buildUserPrompt(userMessage, fullContext)
            }
          ];
          console.log("[AIService] Calling OpenAI API with:", {
            model: "gpt-3.5-turbo",
            messagesCount: messages.length,
            historyCount: conversationHistory.length,
            apiKeyPrefix: this.openaiApiKey.substring(0, 10) + "..."
          });
          if (messages.length > 1) {
            console.log("[AIService] User Message Content (First 500 chars):", messages[1].content.substring(0, 500));
          }
          const response = await fetch(this.openaiApiBaseUrl, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "Authorization": `Bearer ${this.openaiApiKey}`
            },
            body: JSON.stringify({
              model: "gpt-3.5-turbo",
              messages,
              temperature: 0.7,
              max_tokens: 500
            })
          });
          console.log("[AIService] OpenAI API response status:", response.status);
          if (!response.ok) {
            let errorData;
            try {
              errorData = await response.json();
            } catch (e) {
              errorData = { error: { message: `HTTP ${response.status}: ${response.statusText}` } };
            }
            console.error("[AIService] OpenAI API error:", {
              status: response.status,
              statusText: response.statusText,
              error: errorData
            });
            throw new Error(`OpenAI API error (${response.status}): ${((_a = errorData.error) == null ? void 0 : _a.message) || ((_b = errorData.error) == null ? void 0 : _b.code) || "Unknown error"}`);
          }
          const data = await response.json();
          const assistantMessage = ((_d = (_c = data.choices[0]) == null ? void 0 : _c.message) == null ? void 0 : _d.content) || "\u62B1\u6B49\uFF0C\u6211\u7121\u6CD5\u56DE\u7B54\u9019\u500B\u554F\u984C\u3002";
          return {
            message: assistantMessage,
            context: fullContext,
            model: "gpt"
          };
        } catch (error) {
          console.error("[AIService] Error calling OpenAI:", error);
          throw error;
        }
      }
      /**
       * 自動判斷應該使用的模型（根據查詢內容和使用者狀態）
       */
      determineModel(query, userId = null) {
        if (userId) {
          return "gpt";
        }
        const travelerKeywords = ["\u65C5\u904A", "\u8DEF\u7DDA", "\u5929\u6C23", "\u4EA4\u901A", "\u63A8\u85A6", "\u666F\u9EDE", "\u884C\u7A0B", "\u600E\u9EBC\u53BB", "\u600E\u9EBC\u8D70"];
        const residentKeywords = ["\u6574\u7406", "\u6821\u6B63", "\u4E8B\u5BE6", "\u77E5\u8B58\u5EAB", "\u7DE8\u8F2F", "\u6458\u8981"];
        const queryLower = query.toLowerCase();
        if (residentKeywords.some((keyword) => queryLower.includes(keyword))) {
          return "gpt";
        }
        if (travelerKeywords.some((keyword) => queryLower.includes(keyword))) {
          return "gemini";
        }
        return "gemini";
      }
      /**
       * 處理使用者查詢（主要方法）
       * @param {string} userId - 使用者 ID（可為 null）
       * @param {string} sessionId - 會話 ID
       * @param {string} userMessage - 使用者訊息
       * @param {string} mode - 模式：'traveler'（旅客/Gemini）或 'resident'（居民/GPT），如果為 null 則自動判斷
       * @param {ExecutionContext} ctx - Cloudflare Worker ExecutionContext (optional)
       */
      async handleQuery(userId, sessionId, userMessage, mode = null, ctx = null) {
        var _a, _b, _c, _d, _e, _f, _g, _h, _i, _j, _k, _l, _m, _n;
        try {
          const userConversationId = await this.saveConversation(userId, sessionId, "user", userMessage);
          const knowledgePromise = this.knowledgeService.processInteraction(userId, sessionId, userMessage);
          if (ctx && ctx.waitUntil) {
            ctx.waitUntil(knowledgePromise);
          } else {
            knowledgePromise.catch((err) => console.error("Knowledge capture failed:", err));
          }
          let knowledgeContext = [];
          try {
            console.log("[AIService] Searching approved knowledge for:", userMessage);
            knowledgeContext = await this.knowledgeService.searchApprovedKnowledge(userMessage);
            console.log(`[AIService] Found ${knowledgeContext.length} approved knowledge items.`);
          } catch (e) {
            console.warn("[AIService] Search knowledge failed:", e);
          }
          const userType = await this.questioningService.determineUserType(userId, userMessage);
          console.log("[AIService] User type:", userType);
          let questionAnalysis = null;
          try {
            const contextType = userType === "local" ? "local" : userType === "merchant" ? "merchant" : userType === "traveler" ? "visited_traveler" : "general";
            questionAnalysis = await this.questionAnalysisService.analyzeUserQuestion(
              userMessage,
              userConversationId,
              null,
              // 答案品質稍後評估
              contextType
            );
            console.log("[AIService] Question analysis:", questionAnalysis);
          } catch (error) {
            console.error("[AIService] Error analyzing user question:", error);
          }
          const conversationState = await this.questioningService.getOrCreateConversationState(
            sessionId,
            userId,
            "general"
          );
          let relationshipInfo = null;
          try {
            const depthResult = await this.relationshipDepthService.calculateRelationshipDepth(userId, sessionId);
            relationshipInfo = {
              userType: userType || "unknown",
              conversationStage: depthResult.stage,
              knownInterests: this.extractInterests(conversationState.collected_data),
              relationshipDepth: depthResult.relationshipDepth,
              conversationRound: depthResult.totalRounds,
              rememberedFacts: this.extractRememberedFacts(conversationState.collected_data)
            };
            if (conversationState) {
              await this.db.prepare(
                `UPDATE ai_conversation_states 
             SET conversation_stage = ?, 
                 relationship_depth = ?,
                 total_rounds = ?,
                 updated_at = datetime('now')
             WHERE id = ?`
              ).bind(
                depthResult.stage,
                depthResult.relationshipDepth,
                depthResult.totalRounds,
                conversationState.id
              ).run();
            }
            console.log("[AIService] Relationship depth calculated:", relationshipInfo);
          } catch (error) {
            console.error("[AIService] Error calculating relationship depth:", error);
            relationshipInfo = {
              userType: userType || "unknown",
              conversationStage: "initial",
              knownInterests: [],
              relationshipDepth: 0,
              conversationRound: 0,
              rememberedFacts: []
            };
          }
          const analysis = this.questioningService.analyzeQuery(userMessage, userType, conversationState);
          console.log("[AIService] Query analysis:", analysis);
          let distanceInfo = null;
          if (analysis.type === "distance_query" && this.distanceService) {
            try {
              distanceInfo = await this.distanceService.calculateDistanceFromQuery(userMessage, this.locationService);
              if (distanceInfo) {
                console.log("[AIService] Distance calculated:", distanceInfo);
              }
            } catch (error) {
              console.error("[AIService] Error calculating distance:", error);
            }
          }
          let questionToAsk = null;
          let shouldContinueQuestioning = false;
          if (analysis.shouldAsk && !conversationState.is_complete) {
            const updatedState = {
              ...conversationState,
              conversation_type: analysis.type,
              current_step: analysis.step || conversationState.current_step
            };
            if ((_a = conversationState.context_data) == null ? void 0 : _a.current_field) {
              const extracted = this.questioningService.extractStructuredInfo(
                userMessage,
                conversationState.context_data.current_field,
                analysis.type
              );
              updatedState.collected_data = {
                ...conversationState.collected_data,
                ...extracted
              };
              if (conversationState.context_data.current_field === "location_name") {
                updatedState.collected_data.location_name = userMessage;
                if (this.locationService) {
                  try {
                    const locations = await this.db.prepare(
                      "SELECT id FROM locations WHERE name LIKE ? LIMIT 1"
                    ).bind(`%${userMessage}%`).first();
                    if (locations) {
                      updatedState.collected_data.location_id = locations.id;
                    }
                  } catch (error) {
                    console.error("[AIService] Error finding location:", error);
                  }
                }
              } else if (conversationState.context_data.current_field === "product_name") {
                if (!updatedState.collected_data.products) {
                  updatedState.collected_data.products = [];
                }
                updatedState.collected_data.products.push({
                  name: userMessage,
                  price: null,
                  duration_minutes: null
                });
              } else if (conversationState.context_data.current_field === "memory_content") {
                updatedState.collected_data.memory_content = userMessage;
              } else if (conversationState.context_data.current_field === "companions") {
                updatedState.collected_data.companions = userMessage;
              } else if (conversationState.context_data.current_field === "revisit_reason") {
                updatedState.collected_data.revisit_reason = userMessage;
              } else if (conversationState.context_data.current_field === "business_type") {
                updatedState.collected_data.business_type = userMessage;
              } else if (conversationState.context_data.current_field === "opening_hours") {
                updatedState.collected_data.opening_hours = userMessage;
              }
            }
            if (analysis.type === "identity_guide") {
              const messageLower = userMessage.toLowerCase();
              if (messageLower.includes("\u5C45\u6C11") || messageLower.includes("\u6211\u662F\u5C45\u6C11")) {
                updatedState.collected_data.user_identity = "local";
              } else if (messageLower.includes("\u4F86\u904E") || messageLower.includes("\u6211\u4F86\u904E")) {
                updatedState.collected_data.user_identity = "visited_traveler";
              } else if (messageLower.includes("\u60F3\u4F86") || messageLower.includes("\u6211\u60F3\u4F86") || messageLower.includes("\u8A08\u5283")) {
                updatedState.collected_data.user_identity = "planning_traveler";
              } else if (messageLower.includes("\u65C5\u5BA2") || messageLower.includes("\u904A\u5BA2")) {
                if (!updatedState.collected_data.user_identity) {
                  updatedState.collected_data.user_identity = "traveler";
                }
              }
              if (((_b = conversationState.context_data) == null ? void 0 : _b.current_field) === "user_identity") {
                updatedState.collected_data.user_identity = userMessage;
              } else if (((_c = conversationState.context_data) == null ? void 0 : _c.current_field) === "region") {
                updatedState.collected_data.region = userMessage;
              } else if (((_d = conversationState.context_data) == null ? void 0 : _d.current_field) === "visit_period") {
                updatedState.collected_data.visit_period = userMessage;
              } else if (((_e = conversationState.context_data) == null ? void 0 : _e.current_field) === "planned_period") {
                updatedState.collected_data.planned_period = userMessage;
              } else if (((_f = conversationState.context_data) == null ? void 0 : _f.current_field) === "interests") {
                updatedState.collected_data.interests = userMessage;
              } else if (((_g = conversationState.context_data) == null ? void 0 : _g.current_field) === "local_knowledge") {
                updatedState.collected_data.local_knowledge = userMessage;
              } else if (((_h = conversationState.context_data) == null ? void 0 : _h.current_field) === "favorite_places") {
                updatedState.collected_data.favorite_places = userMessage;
              } else if (((_i = conversationState.context_data) == null ? void 0 : _i.current_field) === "visited_places") {
                updatedState.collected_data.visited_places = userMessage;
              } else if (((_j = conversationState.context_data) == null ? void 0 : _j.current_field) === "visited_experiences") {
                updatedState.collected_data.visited_experiences = userMessage;
              } else if (((_k = conversationState.context_data) == null ? void 0 : _k.current_field) === "want_to_revisit") {
                updatedState.collected_data.want_to_revisit = userMessage;
              } else if (((_l = conversationState.context_data) == null ? void 0 : _l.current_field) === "travel_interests") {
                updatedState.collected_data.travel_interests = userMessage;
              } else if (((_m = conversationState.context_data) == null ? void 0 : _m.current_field) === "travel_plans") {
                updatedState.collected_data.travel_plans = userMessage;
              } else if (((_n = conversationState.context_data) == null ? void 0 : _n.current_field) === "travel_questions") {
                updatedState.collected_data.travel_questions = userMessage;
              }
              const questionData = this.questioningService.generateIdentityQuestion(
                updatedState,
                updatedState.collected_data
              );
              questionToAsk = questionData.question;
              if (questionToAsk) {
                try {
                  const contextType = updatedState.collected_data.user_identity === "local" ? "local" : updatedState.collected_data.user_identity === "visited_traveler" ? "visited_traveler" : updatedState.collected_data.user_identity === "planning_traveler" ? "planning_traveler" : "general";
                  const bestTemplate = await this.questionAnalysisService.getBestQuestionTemplate(
                    "identity",
                    contextType
                  );
                  if (bestTemplate) {
                    const improvedQuestion = this.questionAnalysisService.applyTemplate(bestTemplate, {
                      contextType,
                      ...updatedState.collected_data
                    });
                    if (improvedQuestion && improvedQuestion.length > 0) {
                      questionToAsk = improvedQuestion;
                      console.log("[AIService] Using improved identity question from template");
                    }
                  }
                  await this.questionAnalysisService.analyzeAIQuestion(
                    questionToAsk,
                    {
                      userType,
                      contextType,
                      conversationType: analysis.type,
                      step: updatedState.current_step
                    },
                    null,
                    userConversationId
                  );
                } catch (error) {
                  console.error("[AIService] Error improving identity question with template:", error);
                }
              }
              updatedState.current_step = questionData.next_step;
              updatedState.context_data = {
                ...updatedState.context_data,
                current_field: questionData.field
              };
              shouldContinueQuestioning = questionToAsk !== null;
            } else if (analysis.type === "merchant_setup") {
              const questionData = this.questioningService.generateMerchantQuestion(
                updatedState,
                updatedState.collected_data
              );
              questionToAsk = questionData.question;
              if (questionToAsk) {
                try {
                  const contextType = userType === "merchant" ? "merchant" : "general";
                  const bestTemplate = await this.questionAnalysisService.getBestQuestionTemplate(
                    (questionAnalysis == null ? void 0 : questionAnalysis.category) || "general",
                    contextType
                  );
                  if (bestTemplate) {
                    const improvedQuestion = this.questionAnalysisService.applyTemplate(bestTemplate, {
                      location_name: updatedState.collected_data.location_name,
                      contextType,
                      ...updatedState.collected_data
                    });
                    if (improvedQuestion && improvedQuestion.length > 0) {
                      questionToAsk = improvedQuestion;
                      console.log("[AIService] Using improved question from template");
                    }
                  }
                  await this.questionAnalysisService.analyzeAIQuestion(
                    questionToAsk,
                    {
                      userType,
                      contextType,
                      conversationType: analysis.type,
                      step: updatedState.current_step
                    },
                    null,
                    // 用戶回應稍後評估
                    userConversationId
                  );
                } catch (error) {
                  console.error("[AIService] Error improving question with template:", error);
                }
              }
              updatedState.current_step = questionData.next_step;
              updatedState.context_data = {
                ...updatedState.context_data,
                current_field: questionData.field
              };
              shouldContinueQuestioning = questionToAsk !== null;
            } else if (analysis.type === "traveler_memory") {
              const questionData = this.questioningService.generateTravelerQuestion(
                updatedState,
                updatedState.collected_data
              );
              questionToAsk = questionData.question;
              if (questionToAsk) {
                try {
                  const contextType = userType === "traveler" ? "visited_traveler" : "general";
                  const bestTemplate = await this.questionAnalysisService.getBestQuestionTemplate(
                    (questionAnalysis == null ? void 0 : questionAnalysis.category) || "memory",
                    contextType
                  );
                  if (bestTemplate) {
                    const improvedQuestion = this.questionAnalysisService.applyTemplate(bestTemplate, {
                      location_name: updatedState.collected_data.location_name,
                      contextType,
                      ...updatedState.collected_data
                    });
                    if (improvedQuestion && improvedQuestion.length > 0) {
                      questionToAsk = improvedQuestion;
                      console.log("[AIService] Using improved question from template");
                    }
                  }
                  await this.questionAnalysisService.analyzeAIQuestion(
                    questionToAsk,
                    {
                      userType,
                      contextType,
                      conversationType: analysis.type,
                      step: updatedState.current_step
                    },
                    null,
                    // 用戶回應稍後評估
                    userConversationId
                  );
                } catch (error) {
                  console.error("[AIService] Error improving question with template:", error);
                }
              }
              updatedState.current_step = questionData.next_step;
              updatedState.context_data = {
                ...updatedState.context_data,
                current_field: questionData.field
              };
              shouldContinueQuestioning = questionToAsk !== null;
            }
            await this.questioningService.updateConversationState(conversationState.id, updatedState);
            if (updatedState.current_step === "complete" && !conversationState.is_complete) {
              await this.saveCollectedData(analysis.type, updatedState.collected_data, userId, sessionId);
              await this.questioningService.updateConversationState(conversationState.id, { is_complete: true });
            }
          }
          const selectedMode = mode || this.determineModel(userMessage, userId);
          const useGemini = selectedMode === "traveler" || selectedMode === "gemini";
          console.log("[AIService] Selected mode:", selectedMode, "useGemini:", useGemini);
          const context = await this.buildContext(userMessage);
          if (distanceInfo) {
            context.distance = distanceInfo;
          }
          if (shouldContinueQuestioning && questionToAsk) {
            context.questioning = {
              active: true,
              question: questionToAsk,
              type: analysis.type
            };
          }
          let aiResult;
          if (useGemini && this.geminiApiKey) {
            aiResult = await this.callGemini(userMessage, context, sessionId, knowledgeContext, relationshipInfo);
          } else {
            aiResult = await this.callOpenAI(userMessage, context, sessionId, knowledgeContext, relationshipInfo);
          }
          let finalMessage = aiResult.message;
          if (shouldContinueQuestioning && questionToAsk) {
            finalMessage = aiResult.message + "\n\n" + questionToAsk;
          }
          if (distanceInfo) {
            finalMessage = finalMessage + "\n\n\u{1F4CD} \u8DDD\u96E2\u8CC7\u8A0A\uFF1A\n- \u8DDD\u96E2\uFF1A" + distanceInfo.distance_text + "\n- \u6642\u9593\uFF1A" + distanceInfo.duration_text;
          }
          const contextWithModel = {
            ...aiResult.context,
            model: aiResult.model || (useGemini ? "gemini" : "gpt"),
            mode: selectedMode,
            user_type: userType,
            questioning: context.questioning,
            relationshipInfo
            // 添加關係深度資訊
          };
          await this.saveConversation(
            userId,
            sessionId,
            "assistant",
            finalMessage,
            contextWithModel
          );
          await this.relationshipDepthService.incrementConversationRounds(sessionId, userId);
          if (aiResult.context.knowledgeBase && aiResult.context.knowledgeBase.length > 0) {
          }
          try {
            const answerQuality = this.questionAnalysisService.evaluateAnswerQuality(finalMessage, userMessage);
            const contextType = userType === "local" ? "local" : userType === "merchant" ? "merchant" : userType === "traveler" ? "visited_traveler" : "general";
            if (questionAnalysis && questionAnalysis.id) {
              await this.db.prepare(
                `UPDATE ai_question_learning 
             SET answer_quality_score = ?, 
                 led_to_successful_answer = ?
             WHERE id = ?`
              ).bind(answerQuality, answerQuality > 0.7, questionAnalysis.id).run();
            } else {
              await this.questionAnalysisService.analyzeUserQuestion(
                userMessage,
                userConversationId,
                answerQuality,
                contextType
              );
            }
          } catch (error) {
            console.error("[AIService] Error updating question learning:", error);
          }
          return {
            success: true,
            message: finalMessage,
            context: contextWithModel,
            model: aiResult.model || (useGemini ? "gemini" : "gpt"),
            mode: selectedMode,
            user_type: userType,
            questioning: shouldContinueQuestioning ? {
              active: true,
              question: questionToAsk,
              type: analysis.type
            } : null
          };
        } catch (error) {
          console.error("[AIService] Error handling query:", error);
          console.error("[AIService] Error stack:", error.stack);
          console.error("[AIService] Error details:", {
            message: error.message,
            name: error.name,
            userId,
            sessionId,
            userMessage: userMessage.substring(0, 100)
          });
          const errorMessage = error.message || "Unknown error";
          const isApiError = errorMessage.includes("OpenAI API") || errorMessage.includes("401") || errorMessage.includes("429") || errorMessage.includes("403");
          console.error("[AIService] Detailed error info:", {
            message: errorMessage,
            name: error.name,
            stack: error.stack,
            isApiError
          });
          let errorUserMessage = "\u62B1\u6B49\uFF0C\u8655\u7406\u60A8\u7684\u554F\u984C\u6642\u767C\u751F\u932F\u8AA4\u3002\u8ACB\u7A0D\u5F8C\u518D\u8A66\u3002";
          if (isApiError) {
            if (errorMessage.includes("401") || errorMessage.includes("403")) {
              errorUserMessage = "\u62B1\u6B49\uFF0CAI \u670D\u52D9\u8A8D\u8B49\u5931\u6557\u3002\u8ACB\u806F\u7E6B\u7BA1\u7406\u54E1\u3002";
            } else if (errorMessage.includes("429")) {
              errorUserMessage = "\u62B1\u6B49\uFF0CAI \u670D\u52D9\u76EE\u524D\u4F7F\u7528\u91CF\u904E\u9AD8\u3002\u8ACB\u7A0D\u5F8C\u518D\u8A66\u3002";
            } else {
              errorUserMessage = "\u62B1\u6B49\uFF0CAI \u670D\u52D9\u66AB\u6642\u7121\u6CD5\u4F7F\u7528\u3002\u8ACB\u7A0D\u5F8C\u518D\u8A66\u3002";
            }
          }
          return {
            success: false,
            message: errorUserMessage,
            error: errorMessage,
            // 在開發環境或管理員可以看到詳細錯誤
            details: error.stack
          };
        }
      }
      /**
       * 儲存收集到的資料
       */
      async saveCollectedData(conversationType, collectedData, userId, sessionId) {
        try {
          if (conversationType === "merchant_setup") {
            if (collectedData.location_id && collectedData.products) {
              if (collectedData.opening_hours) {
                await this.db.prepare(
                  `UPDATE locations SET opening_hours = ?, business_type = ?, is_merchant = true WHERE id = ?`
                ).bind(
                  JSON.stringify(collectedData.opening_hours),
                  collectedData.business_type,
                  collectedData.location_id
                ).run();
              }
              for (const product of collectedData.products) {
                if (product.name) {
                  await this.questioningService.saveMerchantProduct(
                    collectedData.location_id,
                    {
                      name: product.name,
                      description: product.description,
                      price: product.price,
                      duration_minutes: product.duration_minutes,
                      category: product.category
                    },
                    userId
                  );
                }
              }
            }
          } else if (conversationType === "traveler_memory") {
            if (collectedData.location_id && collectedData.memory_content) {
              await this.questioningService.saveTravelMemory(
                userId,
                collectedData.location_id,
                {
                  content: collectedData.memory_content,
                  visited_date: collectedData.visited_date,
                  companions: collectedData.companions ? [collectedData.companions] : null,
                  want_to_revisit: collectedData.want_to_revisit,
                  revisit_reason: collectedData.revisit_reason,
                  rating: collectedData.rating
                }
              );
            }
          } else if (conversationType === "identity_guide") {
            await this.saveUserPenghuKnowledge(userId, sessionId, collectedData);
          }
          return true;
        } catch (error) {
          console.error("[AIService] Error saving collected data:", error);
          return false;
        }
      }
      /**
       * 儲存反饋
       */
      async saveFeedback(conversationId, userId, feedbackType, feedbackContent = null) {
        try {
          await this.db.prepare(
            `INSERT INTO ai_feedback (conversation_id, user_id, feedback_type, feedback_content)
         VALUES (?, ?, ?, ?)`
          ).bind(conversationId, userId || null, feedbackType, feedbackContent).run();
          return true;
        } catch (error) {
          console.error("[AIService] Error saving feedback:", error);
          return false;
        }
      }
      /**
       * 儲存使用者對澎湖的認識和經驗
       * @param {string} userId - 使用者 ID（可為 null）
       * @param {string} sessionId - 會話 ID
       * @param {object} collectedData - 收集到的資料
       */
      async saveUserPenghuKnowledge(userId, sessionId, collectedData) {
        try {
          if (userId) {
            if (collectedData.user_identity) {
              let userType = "traveler";
              if (collectedData.user_identity === "local" || collectedData.user_identity.includes("\u5C45\u6C11")) {
                userType = "local";
              } else if (collectedData.user_identity === "visited_traveler" || collectedData.user_identity.includes("\u4F86\u904E")) {
                userType = "visited_traveler";
              } else if (collectedData.user_identity === "planning_traveler" || collectedData.user_identity.includes("\u60F3\u4F86")) {
                userType = "planning_traveler";
              }
              await this.db.prepare(
                "UPDATE users SET user_type = ? WHERE id = ?"
              ).bind(userType, userId).run();
            }
            const interestsData = {
              region: collectedData.region,
              interests: collectedData.interests,
              local_knowledge: collectedData.local_knowledge,
              favorite_places: collectedData.favorite_places,
              visited_places: collectedData.visited_places,
              visited_experiences: collectedData.visited_experiences,
              visit_period: collectedData.visit_period,
              want_to_revisit: collectedData.want_to_revisit,
              travel_interests: collectedData.travel_interests,
              travel_plans: collectedData.travel_plans,
              travel_questions: collectedData.travel_questions,
              planned_period: collectedData.planned_period
            };
            try {
              const user = await this.db.prepare("SELECT interests FROM users WHERE id = ?").bind(userId).first();
              let existingInterests = {};
              if (user == null ? void 0 : user.interests) {
                try {
                  existingInterests = JSON.parse(user.interests);
                } catch (e) {
                  existingInterests = {};
                }
              }
              const updatedInterests = { ...existingInterests, ...interestsData };
              await this.db.prepare(
                "UPDATE users SET interests = ? WHERE id = ?"
              ).bind(JSON.stringify(updatedInterests), userId).run();
            } catch (error) {
              console.error("[AIService] Error updating user interests:", error);
            }
          }
          try {
            const lastConversation = await this.db.prepare(
              "SELECT id FROM ai_conversations WHERE session_id = ? ORDER BY created_at DESC LIMIT 1"
            ).bind(sessionId).first();
            if (lastConversation) {
              await this.db.prepare(
                "UPDATE ai_conversations SET context_data = ? WHERE id = ?"
              ).bind(JSON.stringify({ user_penghu_knowledge: collectedData }), lastConversation.id).run();
            }
          } catch (error) {
            console.error("[AIService] Error saving knowledge to conversation:", error);
          }
          console.log("[AIService] User Penghu knowledge saved:", {
            userId: userId || "anonymous",
            sessionId,
            identity: collectedData.user_identity
          });
          return true;
        } catch (error) {
          console.error("[AIService] Error saving user Penghu knowledge:", error);
          return false;
        }
      }
      /**
       * 從收集的資料中提取興趣列表
       */
      extractInterests(collectedData) {
        if (!collectedData)
          return [];
        const interests = [];
        if (collectedData.interests) {
          if (typeof collectedData.interests === "string") {
            try {
              const parsed = JSON.parse(collectedData.interests);
              if (Array.isArray(parsed)) {
                interests.push(...parsed);
              } else {
                interests.push(collectedData.interests);
              }
            } catch {
              interests.push(...collectedData.interests.split(",").map((i) => i.trim()).filter((i) => i));
            }
          } else if (Array.isArray(collectedData.interests)) {
            interests.push(...collectedData.interests);
          }
        }
        if (collectedData.travel_interests) {
          if (typeof collectedData.travel_interests === "string") {
            interests.push(...collectedData.travel_interests.split(",").map((i) => i.trim()).filter((i) => i));
          } else if (Array.isArray(collectedData.travel_interests)) {
            interests.push(...collectedData.travel_interests);
          }
        }
        return [...new Set(interests)];
      }
      /**
       * 從收集的資料中提取重要事實
       */
      extractRememberedFacts(collectedData) {
        if (!collectedData)
          return [];
        const facts = [];
        if (collectedData.user_identity) {
          facts.push({
            fact: `\u7528\u6236\u8EAB\u4EFD\uFF1A${collectedData.user_identity}`,
            confidence: 0.9,
            mentionedAt: (/* @__PURE__ */ new Date()).toISOString()
          });
        }
        if (collectedData.region) {
          facts.push({
            fact: `\u7528\u6236\u5730\u5340\uFF1A${collectedData.region}`,
            confidence: 0.8,
            mentionedAt: (/* @__PURE__ */ new Date()).toISOString()
          });
        }
        if (collectedData.visit_period) {
          facts.push({
            fact: `\u8A2A\u554F\u6642\u9593\uFF1A${collectedData.visit_period}`,
            confidence: 0.8,
            mentionedAt: (/* @__PURE__ */ new Date()).toISOString()
          });
        }
        if (collectedData.planned_period) {
          facts.push({
            fact: `\u8A08\u5283\u6642\u9593\uFF1A${collectedData.planned_period}`,
            confidence: 0.8,
            mentionedAt: (/* @__PURE__ */ new Date()).toISOString()
          });
        }
        if (collectedData.favorite_places) {
          facts.push({
            fact: `\u559C\u6B61\u7684\u5730\u9EDE\uFF1A${collectedData.favorite_places}`,
            confidence: 0.7,
            mentionedAt: (/* @__PURE__ */ new Date()).toISOString()
          });
        }
        if (collectedData.visited_places) {
          facts.push({
            fact: `\u53BB\u904E\u7684\u5730\u9EDE\uFF1A${collectedData.visited_places}`,
            confidence: 0.7,
            mentionedAt: (/* @__PURE__ */ new Date()).toISOString()
          });
        }
        return facts;
      }
    };
  }
});

// src/services/BusinessVerificationService.js
var BusinessVerificationService;
var init_BusinessVerificationService = __esm({
  "src/services/BusinessVerificationService.js"() {
    "use strict";
    BusinessVerificationService = class {
      constructor(db) {
        if (!db) {
          throw new Error("Database connection is required for BusinessVerificationService");
        }
        this.db = db;
      }
      /**
       * 用戶申請驗證商家擁有權
       * @param {string} locationId - 地點 ID
       * @param {string} userId - 用戶 ID
       * @param {string} googlePlaceId - Google Place ID（可選）
       * @returns {Promise<object>} 驗證申請結果
       */
      async requestVerification(locationId, userId, googlePlaceId = null) {
        try {
          const existing = await this.db.prepare(
            `SELECT id, status FROM business_verifications 
                 WHERE location_id = ? AND user_id = ? AND status = 'pending'`
          ).bind(locationId, userId).first();
          if (existing) {
            return {
              success: false,
              message: "\u60A8\u5DF2\u7D93\u6709\u4E00\u500B\u5F85\u8655\u7406\u7684\u9A57\u8B49\u7533\u8ACB",
              verificationId: existing.id
            };
          }
          if (!googlePlaceId) {
            const location = await this.db.prepare(
              "SELECT google_place_id FROM locations WHERE id = ?"
            ).bind(locationId).first();
            googlePlaceId = (location == null ? void 0 : location.google_place_id) || null;
          }
          const result = await this.db.prepare(`
                INSERT INTO business_verifications 
                (location_id, user_id, google_place_id, status, verification_method, requested_at)
                VALUES (?, ?, ?, 'pending', 'manual_review', datetime('now'))
            `).bind(locationId, userId, googlePlaceId).run();
          const verification = await this.db.prepare(
            `SELECT id FROM business_verifications 
                 WHERE location_id = ? AND user_id = ? AND status = 'pending'
                 ORDER BY requested_at DESC LIMIT 1`
          ).bind(locationId, userId).first();
          return {
            success: true,
            message: "\u9A57\u8B49\u7533\u8ACB\u5DF2\u63D0\u4EA4\uFF0C\u7B49\u5F85\u7BA1\u7406\u54E1\u5BE9\u6838",
            verificationId: (verification == null ? void 0 : verification.id) || null,
            status: "pending"
          };
        } catch (error) {
          console.error("[BusinessVerificationService] Error requesting verification:", error);
          throw error;
        }
      }
      /**
       * 管理員批准驗證
       * @param {string} verificationId - 驗證申請 ID
       * @param {string} adminUserId - 管理員用戶 ID
       * @param {string} notes - 備註（可選）
       * @returns {Promise<object>} 批准結果
       */
      async approveVerification(verificationId, adminUserId, notes = null) {
        try {
          const verification = await this.db.prepare(
            "SELECT * FROM business_verifications WHERE id = ?"
          ).bind(verificationId).first();
          if (!verification) {
            return { success: false, message: "\u9A57\u8B49\u7533\u8ACB\u4E0D\u5B58\u5728" };
          }
          if (verification.status !== "pending") {
            return {
              success: false,
              message: `\u9A57\u8B49\u7533\u8ACB\u72C0\u614B\u70BA ${verification.status}\uFF0C\u7121\u6CD5\u6279\u51C6`
            };
          }
          await this.db.prepare(`
                UPDATE business_verifications 
                SET status = 'approved', 
                    verified_at = datetime('now'),
                    verified_by = ?,
                    notes = ?,
                    updated_at = datetime('now')
                WHERE id = ?
            `).bind(adminUserId, notes, verificationId).run();
          return {
            success: true,
            message: "\u9A57\u8B49\u5DF2\u6279\u51C6",
            verificationId,
            status: "approved"
          };
        } catch (error) {
          console.error("[BusinessVerificationService] Error approving verification:", error);
          throw error;
        }
      }
      /**
       * 管理員拒絕驗證
       * @param {string} verificationId - 驗證申請 ID
       * @param {string} adminUserId - 管理員用戶 ID
       * @param {string} rejectionReason - 拒絕原因
       * @returns {Promise<object>} 拒絕結果
       */
      /**
       * 批量批准驗證申請
       * @param {string[]} verificationIds - 驗證申請 ID 數組
       * @param {string} adminUserId - 管理員用戶 ID
       * @param {string} notes - 備註（可選）
       * @returns {Promise<object>} 批量操作結果
       */
      async batchApproveVerifications(verificationIds, adminUserId, notes = null) {
        if (!Array.isArray(verificationIds) || verificationIds.length === 0) {
          return {
            success: false,
            message: "\u8ACB\u9078\u64C7\u81F3\u5C11\u4E00\u500B\u9A57\u8B49\u7533\u8ACB",
            approved: 0,
            failed: 0,
            errors: []
          };
        }
        const results = {
          success: true,
          approved: 0,
          failed: 0,
          errors: []
        };
        try {
          const placeholders = verificationIds.map(() => "?").join(",");
          const verifications = await this.db.prepare(
            `SELECT id, status FROM business_verifications 
                 WHERE id IN (${placeholders}) AND status = 'pending'`
          ).bind(...verificationIds).all();
          const validIds = verifications.results.map((v) => v.id);
          const invalidIds = verificationIds.filter((id) => !validIds.includes(id));
          if (invalidIds.length > 0) {
            results.errors.push({
              ids: invalidIds,
              message: "\u90E8\u5206\u7533\u8ACB\u4E0D\u5B58\u5728\u6216\u4E0D\u662F\u5F85\u5BE9\u6838\u72C0\u614B"
            });
          }
          if (validIds.length > 0) {
            const updatePlaceholders = validIds.map(() => "?").join(",");
            const now = (/* @__PURE__ */ new Date()).toISOString();
            await this.db.prepare(
              `UPDATE business_verifications 
                     SET status = 'approved', 
                         verified_at = ?, 
                         verified_by = ?, 
                         notes = ?,
                         updated_at = ?
                     WHERE id IN (${updatePlaceholders}) AND status = 'pending'`
            ).bind(now, adminUserId, notes || null, now, ...validIds).run();
            results.approved = validIds.length;
          }
          results.failed = invalidIds.length;
          results.message = `\u6210\u529F\u6279\u51C6 ${results.approved} \u500B\u7533\u8ACB${results.failed > 0 ? `\uFF0C${results.failed} \u500B\u5931\u6557` : ""}`;
          return results;
        } catch (error) {
          console.error("[BusinessVerificationService] Error in batch approve:", error);
          return {
            success: false,
            message: "\u6279\u91CF\u6279\u51C6\u5931\u6557\uFF1A" + (error.message || "\u672A\u77E5\u932F\u8AA4"),
            approved: 0,
            failed: verificationIds.length,
            errors: [{ message: error.message }]
          };
        }
      }
      /**
       * 批量拒絕驗證申請
       * @param {string[]} verificationIds - 驗證申請 ID 數組
       * @param {string} adminUserId - 管理員用戶 ID
       * @param {string} rejectionReason - 拒絕原因
       * @returns {Promise<object>} 批量操作結果
       */
      async batchRejectVerifications(verificationIds, adminUserId, rejectionReason) {
        if (!Array.isArray(verificationIds) || verificationIds.length === 0) {
          return {
            success: false,
            message: "\u8ACB\u9078\u64C7\u81F3\u5C11\u4E00\u500B\u9A57\u8B49\u7533\u8ACB",
            rejected: 0,
            failed: 0,
            errors: []
          };
        }
        if (!rejectionReason || !rejectionReason.trim()) {
          return {
            success: false,
            message: "\u62D2\u7D55\u539F\u56E0\u4E0D\u80FD\u70BA\u7A7A",
            rejected: 0,
            failed: verificationIds.length,
            errors: []
          };
        }
        const results = {
          success: true,
          rejected: 0,
          failed: 0,
          errors: []
        };
        try {
          const placeholders = verificationIds.map(() => "?").join(",");
          const verifications = await this.db.prepare(
            `SELECT id, status FROM business_verifications 
                 WHERE id IN (${placeholders}) AND status = 'pending'`
          ).bind(...verificationIds).all();
          const validIds = verifications.results.map((v) => v.id);
          const invalidIds = verificationIds.filter((id) => !validIds.includes(id));
          if (invalidIds.length > 0) {
            results.errors.push({
              ids: invalidIds,
              message: "\u90E8\u5206\u7533\u8ACB\u4E0D\u5B58\u5728\u6216\u4E0D\u662F\u5F85\u5BE9\u6838\u72C0\u614B"
            });
          }
          if (validIds.length > 0) {
            const updatePlaceholders = validIds.map(() => "?").join(",");
            const now = (/* @__PURE__ */ new Date()).toISOString();
            await this.db.prepare(
              `UPDATE business_verifications 
                     SET status = 'rejected', 
                         verified_at = ?, 
                         verified_by = ?, 
                         rejection_reason = ?,
                         updated_at = ?
                     WHERE id IN (${updatePlaceholders}) AND status = 'pending'`
            ).bind(now, adminUserId, rejectionReason.trim(), now, ...validIds).run();
            results.rejected = validIds.length;
          }
          results.failed = invalidIds.length;
          results.message = `\u6210\u529F\u62D2\u7D55 ${results.rejected} \u500B\u7533\u8ACB${results.failed > 0 ? `\uFF0C${results.failed} \u500B\u5931\u6557` : ""}`;
          return results;
        } catch (error) {
          console.error("[BusinessVerificationService] Error in batch reject:", error);
          return {
            success: false,
            message: "\u6279\u91CF\u62D2\u7D55\u5931\u6557\uFF1A" + (error.message || "\u672A\u77E5\u932F\u8AA4"),
            rejected: 0,
            failed: verificationIds.length,
            errors: [{ message: error.message }]
          };
        }
      }
      async rejectVerification(verificationId, adminUserId, rejectionReason) {
        try {
          const verification = await this.db.prepare(
            "SELECT * FROM business_verifications WHERE id = ?"
          ).bind(verificationId).first();
          if (!verification) {
            return { success: false, message: "\u9A57\u8B49\u7533\u8ACB\u4E0D\u5B58\u5728" };
          }
          if (verification.status !== "pending") {
            return {
              success: false,
              message: `\u9A57\u8B49\u7533\u8ACB\u72C0\u614B\u70BA ${verification.status}\uFF0C\u7121\u6CD5\u62D2\u7D55`
            };
          }
          await this.db.prepare(`
                UPDATE business_verifications 
                SET status = 'rejected', 
                    verified_at = datetime('now'),
                    verified_by = ?,
                    rejection_reason = ?,
                    updated_at = datetime('now')
                WHERE id = ?
            `).bind(adminUserId, rejectionReason, verificationId).run();
          return {
            success: true,
            message: "\u9A57\u8B49\u5DF2\u62D2\u7D55",
            verificationId,
            status: "rejected"
          };
        } catch (error) {
          console.error("[BusinessVerificationService] Error rejecting verification:", error);
          throw error;
        }
      }
      /**
       * 獲取驗證申請詳情
       * @param {string} verificationId - 驗證申請 ID
       * @returns {Promise<object|null>} 驗證申請詳情
       */
      async getVerification(verificationId) {
        try {
          const verification = await this.db.prepare(
            `SELECT bv.*, 
                        u.email as user_email, u.name as user_name,
                        l.id as location_id,
                        l.name as location_name, 
                        l.address as location_address,
                        l.google_place_id as location_google_place_id,
                        l.phone_number as location_phone,
                        l.website as location_website,
                        l.latitude as location_latitude,
                        l.longitude as location_longitude,
                        admin.email as verified_by_email, admin.name as verified_by_name
                 FROM business_verifications bv
                 LEFT JOIN users u ON bv.user_id = u.id
                 LEFT JOIN locations l ON bv.location_id = l.id
                 LEFT JOIN users admin ON bv.verified_by = admin.id
                 WHERE bv.id = ?`
          ).bind(verificationId).first();
          return verification || null;
        } catch (error) {
          console.error("[BusinessVerificationService] Error getting verification:", error);
          throw error;
        }
      }
      /**
       * 獲取用戶的驗證申請列表
       * @param {string} userId - 用戶 ID
       * @returns {Promise<Array>} 驗證申請列表
       */
      async getUserVerifications(userId) {
        try {
          const { results } = await this.db.prepare(
            `SELECT bv.*, l.name as location_name, l.address as location_address
                 FROM business_verifications bv
                 LEFT JOIN locations l ON bv.location_id = l.id
                 WHERE bv.user_id = ?
                 ORDER BY bv.requested_at DESC`
          ).bind(userId).all();
          return results || [];
        } catch (error) {
          console.error("[BusinessVerificationService] Error getting user verifications:", error);
          throw error;
        }
      }
      /**
       * 獲取地點的驗證狀態
       * @param {string} locationId - 地點 ID
       * @returns {Promise<object|null>} 驗證狀態
       */
      async getLocationVerificationStatus(locationId) {
        try {
          const verification = await this.db.prepare(
            `SELECT bv.*, u.email as user_email, u.name as user_name
                 FROM business_verifications bv
                 LEFT JOIN users u ON bv.user_id = u.id
                 WHERE bv.location_id = ? AND bv.status = 'approved'
                 ORDER BY bv.verified_at DESC
                 LIMIT 1`
          ).bind(locationId).first();
          return verification || null;
        } catch (error) {
          console.error("[BusinessVerificationService] Error getting location verification status:", error);
          throw error;
        }
      }
      /**
       * 獲取所有待審核的驗證申請（管理員用）
       * @param {number} limit - 限制數量
       * @param {number} offset - 偏移量
       * @returns {Promise<object>} 驗證申請列表和總數
       */
      async getPendingVerifications(limit = 20, offset = 0) {
        try {
          const { results } = await this.db.prepare(
            `SELECT bv.*, 
                        u.email as user_email, u.name as user_name,
                        l.name as location_name, l.address as location_address
                 FROM business_verifications bv
                 LEFT JOIN users u ON bv.user_id = u.id
                 LEFT JOIN locations l ON bv.location_id = l.id
                 WHERE bv.status = 'pending'
                 ORDER BY bv.requested_at ASC
                 LIMIT ? OFFSET ?`
          ).bind(limit, offset).all();
          const totalResult = await this.db.prepare(
            "SELECT COUNT(*) as total FROM business_verifications WHERE status = ?"
          ).bind("pending").first();
          return {
            verifications: results || [],
            total: (totalResult == null ? void 0 : totalResult.total) || 0,
            limit,
            offset
          };
        } catch (error) {
          console.error("[BusinessVerificationService] Error getting pending verifications:", error);
          throw error;
        }
      }
      /**
       * 檢查用戶是否已驗證某個地點
       * @param {string} userId - 用戶 ID
       * @param {string} locationId - 地點 ID
       * @returns {Promise<boolean>} 是否已驗證
       */
      async isUserVerifiedForLocation(userId, locationId) {
        try {
          const verification = await this.db.prepare(
            `SELECT id FROM business_verifications 
                 WHERE user_id = ? AND location_id = ? AND status = 'approved'`
          ).bind(userId, locationId).first();
          return !!verification;
        } catch (error) {
          console.error("[BusinessVerificationService] Error checking verification:", error);
          return false;
        }
      }
      /**
       * 生成唯一 ID（使用 SQLite 的 randomblob 和 hex 函數）
       * 注意：實際 ID 由數據庫的 DEFAULT (lower(hex(randomblob(16)))) 生成
       * 此方法僅作為備用
       * @returns {string} 唯一 ID
       */
      generateId() {
        const timestamp = Date.now().toString(36);
        const random = Math.random().toString(36).substring(2, 10);
        return (timestamp + random).substring(0, 32);
      }
      /**
       * 管理員發起驗證流程（為 Place ID 預註冊）
       * @param {string} placeId - Google Place ID
       * @param {object} adminUser - 管理員用戶對象
       * @returns {Promise<object>} 操作結果
       */
      async adminInitiateForPlaceId(placeId, adminUser) {
        try {
          const location = await this.db.prepare(
            "SELECT id, name FROM locations WHERE google_place_id = ?"
          ).bind(placeId).first();
          if (!location) {
            return {
              success: false,
              message: `\u627E\u4E0D\u5230\u5C0D\u61C9\u7684 Place ID: ${placeId}`
            };
          }
          return {
            success: true,
            message: `\u5DF2\u627E\u5230\u5730\u9EDE\u300C${location.name}\u300D\uFF0C\u53EF\u4EE5\u958B\u59CB\u9A57\u8B49\u6D41\u7A0B`,
            locationId: location.id,
            placeId,
            adminEmail: adminUser ? adminUser.email : "N/A"
          };
        } catch (error) {
          console.error("[BusinessVerificationService] Error in adminInitiateForPlaceId:", error);
          throw error;
        }
      }
      /**
       * 用戶申請驗證（兼容舊接口）
       * @param {string} placeId - Google Place ID
       * @param {object} user - 用戶對象
       * @returns {Promise<object>} 申請結果
       */
      async userRequestVerificationForPlaceId(placeId, user) {
        if (!user || !user.id) {
          return { success: false, message: "User not logged in or user ID not available." };
        }
        try {
          const location = await this.db.prepare(
            "SELECT id FROM locations WHERE google_place_id = ?"
          ).bind(placeId).first();
          if (!location) {
            return {
              success: false,
              message: `\u627E\u4E0D\u5230\u5C0D\u61C9\u7684 Place ID: ${placeId}\uFF0C\u8ACB\u5148\u6DFB\u52A0\u5730\u9EDE`
            };
          }
          return await this.requestVerification(location.id, user.id, placeId);
        } catch (error) {
          console.error("[BusinessVerificationService] Error in userRequestVerificationForPlaceId:", error);
          throw error;
        }
      }
      /**
       * 獲取所有驗證申請（支援篩選）
       * @param {number} limit - 限制數量
       * @param {number} offset - 偏移量
       * @param {string} status - 狀態篩選（可選）
       * @returns {Promise<object>} 驗證申請列表和總數
       */
      async getAllVerifications(limit = 20, offset = 0, status = null, search = null) {
        try {
          let query = `
                SELECT bv.*, 
                       u.email as user_email, u.name as user_name,
                       l.name as location_name, l.address as location_address,
                       admin.email as verified_by_email, admin.name as verified_by_name
                FROM business_verifications bv
                LEFT JOIN users u ON bv.user_id = u.id
                LEFT JOIN locations l ON bv.location_id = l.id
                LEFT JOIN users admin ON bv.verified_by = admin.id
            `;
          let countQuery = `
                SELECT COUNT(*) as total 
                FROM business_verifications bv
                LEFT JOIN users u ON bv.user_id = u.id
                LEFT JOIN locations l ON bv.location_id = l.id
            `;
          const params = [];
          const countParams = [];
          const conditions = [];
          if (status) {
            conditions.push("bv.status = ?");
            params.push(status);
            countParams.push(status);
          }
          if (search && search.trim()) {
            const searchTerm = "%" + search.trim() + "%";
            conditions.push("(l.name LIKE ? OR u.email LIKE ? OR u.name LIKE ? OR l.address LIKE ?)");
            params.push(searchTerm, searchTerm, searchTerm, searchTerm);
            countParams.push(searchTerm, searchTerm, searchTerm, searchTerm);
          }
          if (conditions.length > 0) {
            const whereClause = " WHERE " + conditions.join(" AND ");
            query += whereClause;
            countQuery += whereClause;
          }
          query += " ORDER BY bv.requested_at DESC LIMIT ? OFFSET ?";
          params.push(limit, offset);
          const { results } = await this.db.prepare(query).bind(...params).all();
          const totalResult = await this.db.prepare(countQuery).bind(...countParams).first();
          return {
            verifications: results || [],
            total: (totalResult == null ? void 0 : totalResult.total) || 0,
            limit,
            offset,
            search: search || null
          };
        } catch (error) {
          console.error("[BusinessVerificationService] Error getting all verifications:", error);
          throw error;
        }
      }
      /**
       * 獲取驗證統計數據
       * @returns {Promise<object>} 統計數據
       */
      async getStatistics() {
        try {
          const result = await this.db.prepare(`
                SELECT 
                    SUM(CASE WHEN status = 'pending' THEN 1 ELSE 0 END) as pending,
                    SUM(CASE WHEN status = 'approved' THEN 1 ELSE 0 END) as approved,
                    SUM(CASE WHEN status = 'rejected' THEN 1 ELSE 0 END) as rejected,
                    COUNT(*) as total
                FROM business_verifications
            `).first();
          return {
            pending: (result == null ? void 0 : result.pending) || 0,
            approved: (result == null ? void 0 : result.approved) || 0,
            rejected: (result == null ? void 0 : result.rejected) || 0,
            total: (result == null ? void 0 : result.total) || 0
          };
        } catch (error) {
          console.error("[BusinessVerificationService] Error getting statistics:", error);
          return { pending: 0, approved: 0, rejected: 0, total: 0 };
        }
      }
    };
  }
});

// src/components/layout.js
function pageTemplate2({ title, content, user, nonce, cssContent, useContainer = true, currentPath = "", headScripts = "" }) {
  console.log("pageTemplate called with:", { title, user: !!user, nonce, useContainer, currentPath });
  const isFootprintsActive = currentPath === "/footprints" || currentPath.startsWith("/footprints");
  const isTripPlannerActive = currentPath === "/trip-planner" || currentPath.startsWith("/trip-planner");
  try {
    const html = `
      <!DOCTYPE html>
      <html lang="zh-TW">
      <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>${title || "HOPE PENGHU"} - HOPE PENGHU</title>
        <link rel="icon" type="image/x-icon" href="/favicon.ico">
        <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
        
        <!-- Removed CSS link tag -->
        <!-- <link rel="stylesheet" href="/build/worker.css"> -->

        <!-- Inject CSS content -->
        <style nonce="${nonce}">
          ${cssContent || "/* CSS content not provided */"}
          /* \u5B57\u9AD4\u56DE\u9000\uFF1A\u5982\u679C Google Fonts \u7121\u6CD5\u8F09\u5165\uFF0C\u4F7F\u7528\u7CFB\u7D71\u5B57\u9AD4 */
          body {
            font-family: 'Noto Sans TC', -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft JhengHei', 'PingFang TC', 'Helvetica Neue', Arial, sans-serif;
          }
          /* Avatar fallback \u6A23\u5F0F\uFF08CSP-compliant\uFF09 */
          .avatar-fallback-hidden {
            display: none !important;
          }
          /* Join button margin */
          .join-button {
            margin-right: 8px;
          }
        </style>

        ${headScripts || ""}

      </head>
      <body>
        <header class="header">
          <nav class="nav container">
            <a href="/" class="nav-logo">HOPE PENGHU</a>
            <ul class="nav-menu">
              <li><a href="/footprints" class="nav-link${isFootprintsActive ? " nav-link-active" : ""}">\u8DB3\u8DE1</a></li>
              ${user ? `<li><a href="/trip-planner" class="nav-link${isTripPlannerActive ? " nav-link-active" : ""}">\u884C\u7A0B\u898F\u5283</a></li>` : ""}
              ${user ? `
                <li class="nav-menu-item-avatar">
                  <div id="avatar-container" role="button" tabindex="0" aria-label="User menu" class="focus:outline-none avatar-container-div"> 
                     ${user.avatar_url ? `<img src="${user.avatar_url}" alt="User Avatar" class="user-avatar" id="user-avatar-img"><span class="user-avatar avatar-fallback avatar-fallback-hidden">${user.name ? user.name.charAt(0).toUpperCase() : "?"}</span>` : `<span class="user-avatar avatar-fallback">${user.name ? user.name.charAt(0).toUpperCase() : "?"}</span>`}
                  </div>
                  
                  <div id="user-dropdown-menu" class="user-dropdown">
                    <div class="dropdown-header">
                       <p class="dropdown-header-name">${user.name || "User"}</p>
                       <p class="dropdown-header-email">${user.email || ""}</p>
                    </div>
                    <a href="/profile" class="dropdown-item">\u6211\u7684\u5730\u9EDE</a>
                    <a href="/trip-planner" class="dropdown-item">\u6211\u7684\u884C\u7A0B</a>
                    <a href="/google-info" class="dropdown-item">\u6211\u7684\u5E33\u865F</a>
                    ${user.role === "admin" ? `
                      <a href="/admin/verifications" class="dropdown-item">\u5546\u5BB6\u9A57\u8B49\u7BA1\u7406</a>
                      <a href="/admin/knowledge" class="dropdown-item">\u77E5\u8B58\u5EAB\u5BE9\u6838</a>
                      <div class="dropdown-divider"></div>
                    ` : ""}
                    <div class="dropdown-divider"></div>
                    <button id="logout-button" class="dropdown-item">\u767B\u51FA</button>
                  </div>
                </li>
              ` : `
                <li><a href="/login" class="button button-secondary join-button">\u52A0\u5165</a></li>
                <li><a href="/login" class="button button-primary">\u767B\u5165</a></li>
              `}
            </ul>
            <button id="mobile-menu-button" class="mobile-menu-toggle">\u2630</button> 
          </nav>
        </header>

        <main class="${useContainer ? "container" : ""}">
          ${content || "<p>\u9801\u9762\u5167\u5BB9\u8F09\u5165\u4E2D...</p>"} 
        </main>

        <footer class="footer">
          <div class="container">
            <p>&copy; ${(/* @__PURE__ */ new Date()).getFullYear()} HOPE PENGHU. All rights reserved.</p>
          </div>
        </footer>

        <!-- \u5168\u5C40 Toast \u901A\u77E5\u5BB9\u5668 -->
        <div id="toast-container" class="fixed top-4 right-4 z-50 flex flex-col gap-2"></div>

        <!-- \u5168\u5C40\u5716\u7247\u8F09\u5165\u8655\u7406\u8173\u672C -->
        <script nonce="${nonce}">
          // Toast \u901A\u77E5\u7CFB\u7D71
          window.showToast = function(message, type = 'info') {
            const container = document.getElementById('toast-container');
            if (!container) return;

            const toast = document.createElement('div');
            
            // \u6839\u64DA\u985E\u578B\u8A2D\u7F6E\u6A23\u5F0F
            let bgClass = 'bg-gray-800';
            let icon = '\u2139\uFE0F';
            
            if (type === 'success') {
              bgClass = 'bg-green-600';
              icon = '\u2705';
            } else if (type === 'error') {
              bgClass = 'bg-red-600';
              icon = '\u274C';
            } else if (type === 'warning') {
              bgClass = 'bg-yellow-600';
              icon = '\u26A0\uFE0F';
            }

            toast.className = \`\${bgClass} text-white px-6 py-4 rounded-lg shadow-lg transform transition-all duration-300 translate-x-full opacity-0 flex items-center gap-3 min-w-[300px]\`;
            
            toast.innerHTML = \`
              <span class="text-xl">\${icon}</span>
              <p class="font-medium">\${message}</p>
            \`;

            container.appendChild(toast);

            // \u52D5\u756B\uFF1A\u6ED1\u5165
            requestAnimationFrame(() => {
              toast.classList.remove('translate-x-full', 'opacity-0');
            });

            // 3\u79D2\u5F8C\u81EA\u52D5\u79FB\u9664
            setTimeout(() => {
              toast.classList.add('opacity-0', 'translate-x-full');
              setTimeout(() => {
                if (container.contains(toast)) {
                  container.removeChild(toast);
                }
              }, 300);
            }, 3000);
          };

          // \u5716\u7247\u8F09\u5165\u8655\u7406\u51FD\u6578\uFF08\u5168\u5C40\uFF09
          window.handleImageLoad = function(imageId, containerId) {
            const img = document.getElementById(imageId);
            const container = document.getElementById(containerId);
            if (img && container) {
              const skeleton = container.querySelector('.image-skeleton');
              const progress = container.querySelector('.image-progress');
              const errorMsg = container.querySelector('#error-' + imageId);
              if (skeleton) skeleton.classList.add('hidden');
              if (progress) progress.classList.add('hidden');
              if (errorMsg) errorMsg.classList.add('hidden');
              img.style.opacity = '1';
            }
          };

          window.handleImageError = function(imageId, containerId, defaultImage) {
            const img = document.getElementById(imageId);
            const container = document.getElementById(containerId);
            if (img && container) {
              const skeleton = container.querySelector('.image-skeleton');
              const progress = container.querySelector('.image-progress');
              if (skeleton) skeleton.classList.add('hidden');
              if (progress) progress.classList.add('hidden');
              const errorMsg = container.querySelector('#error-' + imageId);
              if (errorMsg) errorMsg.classList.remove('hidden');
              if (img.src !== defaultImage) {
                img.onerror = null;
                img.src = defaultImage;
                img.style.opacity = '1';
              } else {
                img.style.opacity = '0.3';
              }
            }
          };
        </script>

        <script nonce="${nonce}">
          // User Avatar Image Handling (CSP-compliant)
          const userAvatarImg = document.getElementById('user-avatar-img');
          if (userAvatarImg) {
            const fallback = userAvatarImg.nextElementSibling;
            if (fallback && fallback.classList.contains('avatar-fallback')) {
              // \u5716\u7247\u8F09\u5165\u6210\u529F\u6642\u96B1\u85CF fallback
              userAvatarImg.addEventListener('load', function() {
                fallback.classList.add('avatar-fallback-hidden');
              });
              // \u5716\u7247\u8F09\u5165\u5931\u6557\u6642\u986F\u793A fallback
              userAvatarImg.addEventListener('error', function() {
                userAvatarImg.style.display = 'none';
                fallback.classList.remove('avatar-fallback-hidden');
              });
            }
          }

          // User Dropdown Menu Logic
          const avatarContainer = document.getElementById('avatar-container'); 
          const dropdownMenu = document.getElementById('user-dropdown-menu');

          if (avatarContainer && dropdownMenu) {
            avatarContainer.addEventListener('click', (event) => {
              event.stopPropagation(); 
              dropdownMenu.classList.toggle('dropdown-active');
            });
            avatarContainer.addEventListener('keydown', (event) => {
               if (event.key === 'Enter' || event.key === ' ') {
                 event.preventDefault();
                 dropdownMenu.classList.toggle('dropdown-active');
               }
            });
            document.addEventListener('click', (event) => {
              if (!dropdownMenu.contains(event.target) && !avatarContainer.contains(event.target)) {
                dropdownMenu.classList.remove('dropdown-active');
              }
            });
            document.addEventListener('keydown', (event) => {
               if (event.key === 'Escape' && dropdownMenu.classList.contains('dropdown-active')) {
                 dropdownMenu.classList.remove('dropdown-active');
                 avatarContainer.focus(); 
               }
            });
          }

          // Event listener for logout button 
          const logoutButton = document.getElementById('logout-button');
          if (logoutButton) {
            logoutButton.addEventListener('click', async () => {
              if (dropdownMenu) dropdownMenu.classList.remove('dropdown-active'); 
              
              try {
                const response = await fetch('/api/auth/logout', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' }
                });
                if (response.ok) {
                  showToast('\u767B\u51FA\u6210\u529F\uFF01\u671F\u5F85\u4E0B\u6B21\u76F8\u898B \u{1F44B}', 'success');
                  setTimeout(() => {
                    window.location.href = '/';
                  }, 1000);
                } else {
                  console.error('Logout failed:', await response.text());
                  showToast('\u767B\u51FA\u5931\u6557\uFF0C\u8ACB\u7A0D\u5F8C\u518D\u8A66\u3002', 'error'); 
                }
              } catch (error) {
                console.error('Error logging out:', error);
                showToast('\u767B\u51FA\u6642\u767C\u751F\u932F\u8AA4\u3002', 'error'); 
              }
            });
          }

          // Event listener for mobile menu 
          const mobileMenuButton = document.getElementById('mobile-menu-button');
          const navMenu = document.querySelector('.nav-menu');
          if (mobileMenuButton && navMenu) {
            mobileMenuButton.addEventListener('click', () => {
              navMenu.classList.toggle('active'); 
            });
          }

          // Register Service Worker for offline support
          if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
              navigator.serviceWorker.register('/sw.js')
                .then((registration) => {
                  console.log('[Service Worker] Registration successful:', registration.scope);
                })
                .catch((error) => {
                  console.error('[Service Worker] Registration failed:', error);
                });
            });
          }
          
        </script>
      </body>
      </html>
    `;
    console.log("pageTemplate finished successfully for title:", title);
    return html;
  } catch (e) {
    console.error("Error during pageTemplate HTML generation:", e);
    return `<html><body>Template Error for ${title}: ${e.message}</body></html>`;
  }
}
var init_layout = __esm({
  "src/components/layout.js"() {
    "use strict";
  }
});

// src/middleware/auth.js
function isAdmin(user) {
  return user && user.role === "admin";
}
function requireAdmin(user, request = null) {
  if (!user) {
    if (request) {
      const url = new URL(request.url);
      return Response.redirect(url.origin + "/login", 302);
    }
    return new Response("Unauthorized. Please log in.", {
      status: 401,
      headers: { "Content-Type": "text/plain; charset=utf-8" }
    });
  }
  if (!isAdmin(user)) {
    if (request) {
      const url = new URL(request.url);
      return Response.redirect(url.origin + "/?error=admin_required", 302);
    }
    return new Response("Unauthorized. Administrator access required.", {
      status: 403,
      headers: { "Content-Type": "text/plain; charset=utf-8" }
    });
  }
  return null;
}
function requireAdminAPI(user) {
  if (!isAdmin(user)) {
    return new Response(JSON.stringify({
      success: false,
      error: "Unauthorized. Administrator access required."
    }), {
      status: 403,
      headers: { "Content-Type": "application/json; charset=utf-8" }
    });
  }
  return null;
}
var init_auth = __esm({
  "src/middleware/auth.js"() {
    "use strict";
  }
});

// src/services/ItineraryService.js
var ItineraryService;
var init_ItineraryService = __esm({
  "src/services/ItineraryService.js"() {
    "use strict";
    ItineraryService = class {
      constructor(db, locationService, aiService) {
        if (!db) {
          throw new Error("Database connection is required for ItineraryService.");
        }
        this.db = db;
        this.locationService = locationService;
        this.aiService = aiService;
      }
      /**
       * 建立新行程
       * @param {string} userId - 用戶 ID
       * @param {object} data - 行程資料 { title, dayPlans }
       * @returns {Promise<object>} 建立的行程物件
       */
      async createItinerary(userId, data) {
        var _a, _b, _c;
        try {
          const { title, dayPlans } = data;
          const itineraryId = `itinerary_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
          const now = Date.now();
          await this.db.prepare(
            `INSERT INTO itineraries (id, user_id, title, created_at, updated_at)
         VALUES (?, ?, ?, ?, ?)`
          ).bind(
            itineraryId,
            userId,
            title || null,
            now,
            now
          ).run();
          for (let dayIndex = 0; dayIndex < dayPlans.length; dayIndex++) {
            const dayPlan = dayPlans[dayIndex];
            const dayId = `day_${itineraryId}_${dayIndex}`;
            await this.db.prepare(
              `INSERT INTO itinerary_days (id, itinerary_id, day_number, date, created_at)
           VALUES (?, ?, ?, ?, ?)`
            ).bind(
              dayId,
              itineraryId,
              dayIndex + 1,
              dayPlan.date || `\u7B2C ${dayIndex + 1} \u5929`,
              now
            ).run();
            for (let itemIndex = 0; itemIndex < dayPlan.items.length; itemIndex++) {
              const item = dayPlan.items[itemIndex];
              const itemId = `item_${dayId}_${itemIndex}_${now}_${Math.random().toString(36).substr(2, 9)}`;
              let placeId = ((_a = item.place) == null ? void 0 : _a.id) || null;
              if (((_b = item.place) == null ? void 0 : _b.google_place_id) && !placeId && this.locationService) {
                try {
                  const googlePlaceData = {
                    place_id: item.place.google_place_id,
                    name: item.place.name,
                    formatted_address: item.place.address || item.place.formatted_address,
                    geometry: {
                      location: {
                        lat: item.place.latitude || item.place.lat,
                        lng: item.place.longitude || item.place.lng
                      }
                    },
                    types: item.place.types || [],
                    website: item.place.website,
                    international_phone_number: item.place.phone_number,
                    business_status: item.place.business_status,
                    rating: item.place.rating || item.place.google_rating,
                    user_ratings_total: item.place.user_ratings_total,
                    photos: item.place.photos || []
                  };
                  const location = await this.locationService.createOrGetLocationFromGoogleMaps(
                    googlePlaceData,
                    userId,
                    {
                      autoLink: true,
                      initialStatus: "want_to_visit",
                      sourceType: "itinerary_added"
                    }
                  );
                  placeId = location.id;
                  await this.locationService.incrementItineraryUseCount(location.id);
                  console.log(`[ItineraryService] Created/linked location from Google Maps: ${location.id}`);
                } catch (error) {
                  console.warn("[ItineraryService] Failed to create location from Google Maps:", error);
                }
              } else if (placeId) {
                try {
                  const placeExists = await this.db.prepare(
                    `SELECT id FROM locations WHERE id = ?`
                  ).bind(placeId).first();
                  if (!placeExists) {
                    placeId = null;
                  } else {
                    if (this.locationService) {
                      await this.locationService.incrementItineraryUseCount(placeId);
                    }
                  }
                } catch (error) {
                  console.warn("[ItineraryService] Failed to verify place_id:", error);
                  placeId = null;
                }
              }
              await this.db.prepare(
                `INSERT INTO itinerary_items (
              id, day_id, place_id, place_name, start_time, duration, order_index, created_at, updated_at, status, notes
            )
            VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)`
              ).bind(
                itemId,
                dayId,
                placeId,
                ((_c = item.place) == null ? void 0 : _c.name) || "\u672A\u77E5\u5730\u9EDE",
                item.startTime || "09:00",
                item.duration || 60,
                itemIndex,
                now,
                now,
                // updated_at
                "planned",
                // status
                item.notes || null
                // notes
              ).run();
            }
          }
          return await this.getItinerary(userId, itineraryId);
        } catch (error) {
          console.error("[ItineraryService] Error creating itinerary:", error);
          throw error;
        }
      }
      /**
       * 獲取行程
       * @param {string} userId - 用戶 ID
       * @param {string} itineraryId - 行程 ID
       * @returns {Promise<object>} 行程物件
       */
      async getItinerary(userId, itineraryId) {
        try {
          const itinerary = await this.db.prepare(
            `SELECT id, user_id, title, created_at, updated_at
         FROM itineraries
         WHERE id = ? AND user_id = ?`
          ).bind(itineraryId, userId).first();
          if (!itinerary) {
            return null;
          }
          const days = await this.db.prepare(
            `SELECT id, day_number, date
         FROM itinerary_days
         WHERE itinerary_id = ?
         ORDER BY day_number ASC`
          ).bind(itineraryId).all();
          const dayPlans = [];
          for (const day of days.results) {
            const items = await this.db.prepare(
              `SELECT id, place_id, place_name, start_time, duration, order_index
           FROM itinerary_items
           WHERE day_id = ?
           ORDER BY order_index ASC`
            ).bind(day.id).all();
            const itineraryItems = [];
            for (const item of items.results) {
              let place = {
                id: item.place_id || item.id,
                name: item.place_name
              };
              if (item.place_id && this.locationService) {
                try {
                  const locationDetails = await this.locationService.getLocationById(item.place_id);
                  if (locationDetails) {
                    place = {
                      id: locationDetails.id,
                      name: locationDetails.name,
                      address: locationDetails.address,
                      location: locationDetails.latitude && locationDetails.longitude ? {
                        lat: locationDetails.latitude,
                        lng: locationDetails.longitude
                      } : void 0,
                      rating: locationDetails.google_rating,
                      userRatingCount: locationDetails.google_user_ratings_total
                    };
                  }
                } catch (error) {
                  console.warn("[ItineraryService] Failed to fetch location details:", error);
                }
              }
              itineraryItems.push({
                id: item.id,
                place,
                startTime: item.start_time,
                duration: item.duration
              });
            }
            dayPlans.push({
              date: day.date,
              items: itineraryItems
            });
          }
          return {
            id: itinerary.id,
            userId: itinerary.user_id,
            title: itinerary.title,
            dayPlans,
            createdAt: itinerary.created_at,
            updatedAt: itinerary.updated_at
          };
        } catch (error) {
          console.error("[ItineraryService] Error getting itinerary:", error);
          throw error;
        }
      }
      /**
       * 獲取用戶的所有行程
       * @param {string} userId - 用戶 ID
       * @returns {Promise<Array>} 行程列表
       */
      async getUserItineraries(userId) {
        try {
          const itineraries = await this.db.prepare(
            `SELECT id, title, created_at, updated_at
         FROM itineraries
         WHERE user_id = ?
         ORDER BY updated_at DESC`
          ).bind(userId).all();
          return itineraries.results.map((it) => ({
            id: it.id,
            userId,
            title: it.title,
            createdAt: it.created_at,
            updatedAt: it.updated_at
          }));
        } catch (error) {
          console.error("[ItineraryService] Error getting user itineraries:", error);
          throw error;
        }
      }
      /**
       * 更新行程
       * @param {string} userId - 用戶 ID
       * @param {string} itineraryId - 行程 ID
       * @param {object} updates - 更新資料 { title, dayPlans }
       * @returns {Promise<object>} 更新後的行程物件
       */
      async updateItinerary(userId, itineraryId, updates) {
        var _a, _b, _c;
        try {
          const { title, dayPlans } = updates;
          const now = Date.now();
          if (title !== void 0) {
            await this.db.prepare(
              `UPDATE itineraries
           SET title = ?, updated_at = ?
           WHERE id = ? AND user_id = ?`
            ).bind(title, now, itineraryId, userId).run();
          }
          if (dayPlans) {
            await this.db.prepare(
              `DELETE FROM itinerary_items 
           WHERE day_id IN (SELECT id FROM itinerary_days WHERE itinerary_id = ?)`
            ).bind(itineraryId).run();
            await this.db.prepare(
              `DELETE FROM itinerary_days WHERE itinerary_id = ?`
            ).bind(itineraryId).run();
            for (let dayIndex = 0; dayIndex < dayPlans.length; dayIndex++) {
              const dayPlan = dayPlans[dayIndex];
              const dayId = `day_${itineraryId}_${dayIndex}_${now}_${Math.random().toString(36).substr(2, 9)}`;
              await this.db.prepare(
                `INSERT INTO itinerary_days (id, itinerary_id, day_number, date, created_at)
             VALUES (?, ?, ?, ?, ?)`
              ).bind(
                dayId,
                itineraryId,
                dayIndex + 1,
                dayPlan.date || `\u7B2C ${dayIndex + 1} \u5929`,
                now
              ).run();
              for (let itemIndex = 0; itemIndex < dayPlan.items.length; itemIndex++) {
                const item = dayPlan.items[itemIndex];
                const itemId = `item_${dayId}_${itemIndex}_${now}_${Math.random().toString(36).substr(2, 9)}`;
                let placeId = ((_a = item.place) == null ? void 0 : _a.id) || null;
                if (((_b = item.place) == null ? void 0 : _b.google_place_id) && !placeId && this.locationService) {
                  try {
                    const googlePlaceData = {
                      place_id: item.place.google_place_id,
                      name: item.place.name,
                      formatted_address: item.place.address || item.place.formatted_address,
                      geometry: {
                        location: {
                          lat: item.place.latitude || item.place.lat,
                          lng: item.place.longitude || item.place.lng
                        }
                      },
                      types: item.place.types || [],
                      website: item.place.website,
                      international_phone_number: item.place.phone_number,
                      business_status: item.place.business_status,
                      rating: item.place.rating || item.place.google_rating,
                      user_ratings_total: item.place.user_ratings_total,
                      photos: item.place.photos || []
                    };
                    const location = await this.locationService.createOrGetLocationFromGoogleMaps(
                      googlePlaceData,
                      userId,
                      {
                        autoLink: true,
                        initialStatus: "want_to_visit",
                        sourceType: "itinerary_added"
                      }
                    );
                    placeId = location.id;
                    await this.locationService.incrementItineraryUseCount(location.id);
                    console.log(`[ItineraryService] Created/linked location from Google Maps: ${location.id}`);
                  } catch (error) {
                    console.warn("[ItineraryService] Failed to create location from Google Maps:", error);
                  }
                } else if (placeId) {
                  try {
                    const placeExists = await this.db.prepare(
                      `SELECT id FROM locations WHERE id = ?`
                    ).bind(placeId).first();
                    if (!placeExists) {
                      placeId = null;
                    } else {
                      if (this.locationService) {
                        await this.locationService.incrementItineraryUseCount(placeId);
                      }
                    }
                  } catch (error) {
                    console.warn("[ItineraryService] Failed to verify place_id:", error);
                    placeId = null;
                  }
                }
                await this.db.prepare(
                  `INSERT INTO itinerary_items (
                id, day_id, place_id, place_name, start_time, duration, order_index, created_at, updated_at, status, notes
              )
              VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)`
                ).bind(
                  itemId,
                  dayId,
                  placeId,
                  ((_c = item.place) == null ? void 0 : _c.name) || "\u672A\u77E5\u5730\u9EDE",
                  item.startTime || "09:00",
                  item.duration || 60,
                  itemIndex,
                  now,
                  now,
                  // updated_at
                  "planned",
                  // status
                  item.notes || null
                  // notes
                ).run();
              }
            }
            await this.db.prepare(
              `UPDATE itineraries SET updated_at = ? WHERE id = ? AND user_id = ?`
            ).bind(now, itineraryId, userId).run();
          }
          return await this.getItinerary(userId, itineraryId);
        } catch (error) {
          console.error("[ItineraryService] Error updating itinerary:", error);
          throw error;
        }
      }
      /**
       * 刪除行程
       * @param {string} userId - 用戶 ID
       * @param {string} itineraryId - 行程 ID
       * @returns {Promise<void>}
       */
      async deleteItinerary(userId, itineraryId) {
        try {
          const days = await this.db.prepare(
            `SELECT id FROM itinerary_days WHERE itinerary_id = ?`
          ).bind(itineraryId).all();
          for (const day of days.results) {
            await this.db.prepare(
              `DELETE FROM itinerary_items WHERE day_id = ?`
            ).bind(day.id).run();
          }
          await this.db.prepare(
            `DELETE FROM itinerary_days WHERE itinerary_id = ?`
          ).bind(itineraryId).run();
          await this.db.prepare(
            `DELETE FROM itineraries WHERE id = ? AND user_id = ?`
          ).bind(itineraryId, userId).run();
        } catch (error) {
          console.error("[ItineraryService] Error deleting itinerary:", error);
          throw error;
        }
      }
      /**
       * 優化行程（使用 AI）
       * @param {string} userId - 用戶 ID
       * @param {string} itineraryId - 行程 ID
       * @param {number} dayIndex - 要優化的天數索引（可選）
       * @returns {Promise<object>} 優化後的行程物件
       */
      async optimizeItinerary(userId, itineraryId, dayIndex = null) {
        try {
          const itinerary = await this.getItinerary(userId, itineraryId);
          if (!itinerary) {
            throw new Error("Itinerary not found");
          }
          if (!this.aiService) {
            throw new Error("AIService is required for optimization");
          }
          const daysToOptimize = dayIndex !== null ? [itinerary.dayPlans[dayIndex]] : itinerary.dayPlans;
          const optimizedDayPlans = [];
          for (const dayPlan of daysToOptimize) {
            if (dayPlan.items.length < 2) {
              optimizedDayPlans.push(dayPlan);
              continue;
            }
            const places = dayPlan.items.map((item) => item.place);
            const optimizedData = await this.aiService.optimizeDayPlan(places);
            if (optimizedData && optimizedData.itinerary) {
              const reorderedItems = optimizedData.itinerary.map((optItem) => {
                const originalItem = dayPlan.items.find(
                  (item) => item.place.name === optItem.placeName
                );
                if (originalItem) {
                  return {
                    ...originalItem,
                    startTime: optItem.recommendedTime || originalItem.startTime
                  };
                }
                return null;
              }).filter(Boolean);
              optimizedDayPlans.push({
                ...dayPlan,
                items: reorderedItems
              });
            } else {
              optimizedDayPlans.push(dayPlan);
            }
          }
          const finalDayPlans = dayIndex !== null ? itinerary.dayPlans.map((day, idx) => idx === dayIndex ? optimizedDayPlans[0] : day) : optimizedDayPlans;
          return await this.updateItinerary(userId, itineraryId, {
            dayPlans: finalDayPlans
          });
        } catch (error) {
          console.error("[ItineraryService] Error optimizing itinerary:", error);
          throw error;
        }
      }
    };
  }
});

// src/models/Story.js
var Story;
var init_Story = __esm({
  "src/models/Story.js"() {
    "use strict";
    Story = class _Story {
      constructor(data = {}) {
        this.id = data.id || null;
        this.person_id = data.person_id || null;
        this.location_id = data.location_id || null;
        this.time = data.time || null;
        this.action_type = data.action_type || null;
        this.description = data.description || null;
        this.user_description = data.user_description || null;
        this.status = data.status || "active";
        this.created_at = data.created_at || null;
        this.updated_at = data.updated_at || null;
        this._person = null;
        this._location = null;
      }
      /**
       * 從資料庫記錄創建 Story 物件
       * @param {object} dbRecord - 資料庫記錄
       * @returns {Story}
       */
      static fromDbRecord(dbRecord) {
        if (!dbRecord)
          return null;
        return new _Story({
          id: dbRecord.id,
          person_id: dbRecord.person_id || dbRecord.user_id,
          // 支援兩種欄位名稱
          location_id: dbRecord.location_id,
          time: dbRecord.time || dbRecord.created_at,
          action_type: dbRecord.action_type || dbRecord.status,
          // 支援 user_locations 表的 status
          description: dbRecord.description,
          user_description: dbRecord.user_description,
          status: dbRecord.status || "active",
          created_at: dbRecord.created_at,
          updated_at: dbRecord.updated_at
        });
      }
      /**
       * 從 user_locations 記錄創建 Story 物件
       * @param {object} userLocationRecord - user_locations 表記錄
       * @returns {Story}
       */
      static fromUserLocationRecord(userLocationRecord) {
        if (!userLocationRecord)
          return null;
        return new _Story({
          id: userLocationRecord.id,
          person_id: userLocationRecord.user_id,
          location_id: userLocationRecord.location_id,
          time: userLocationRecord.created_at,
          action_type: userLocationRecord.status,
          // 'visited', 'want_to_visit', 'want_to_revisit'
          description: userLocationRecord.user_description,
          user_description: userLocationRecord.user_description,
          status: "active",
          created_at: userLocationRecord.created_at,
          updated_at: userLocationRecord.updated_at
        });
      }
      /**
       * 轉換為資料庫記錄格式
       * @returns {object}
       */
      toDbRecord() {
        return {
          id: this.id,
          person_id: this.person_id,
          location_id: this.location_id,
          time: this.time,
          action_type: this.action_type,
          description: this.description,
          user_description: this.user_description,
          status: this.status,
          created_at: this.created_at,
          updated_at: this.updated_at
        };
      }
      /**
       * 轉換為 JSON（用於 API 回應）
       * @returns {object}
       */
      toJSON() {
        return {
          id: this.id,
          person_id: this.person_id,
          location_id: this.location_id,
          time: this.time,
          action_type: this.action_type,
          description: this.description,
          user_description: this.user_description,
          status: this.status,
          created_at: this.created_at,
          updated_at: this.updated_at,
          // 如果已載入關聯物件，包含它們
          person: this._person ? this._person.toJSON() : null,
          location: this._location ? this._location.toJSON() : null
        };
      }
      /**
       * 獲取故事標題（自動生成）
       * @returns {string}
       */
      getTitle() {
        if (this.description) {
          return this.description.substring(0, 50) + (this.description.length > 50 ? "..." : "");
        }
        const actionNames = {
          "visited": "\u4F86\u904E",
          "want_to_visit": "\u60F3\u4F86",
          "want_to_revisit": "\u60F3\u518D\u4F86",
          "created": "\u5EFA\u7ACB\u4E86",
          "shared": "\u5206\u4EAB\u4E86"
        };
        const actionName = actionNames[this.action_type] || this.action_type;
        return `${actionName} ${this._location ? this._location.name : "\u5730\u9EDE"}`;
      }
      /**
       * 驗證物件有效性
       * @returns {boolean}
       */
      isValid() {
        return !!(this.person_id && this.location_id && this.action_type);
      }
      /**
       * 檢查是否為特定類型的行動
       * @param {string} actionType - 行動類型
       * @returns {boolean}
       */
      isActionType(actionType) {
        return this.action_type === actionType;
      }
    };
  }
});

// src/models/Person.js
var Person;
var init_Person = __esm({
  "src/models/Person.js"() {
    "use strict";
    Person = class _Person {
      constructor(data = {}) {
        this.id = data.id || null;
        this.email = data.email || null;
        this.name = data.name || null;
        this.avatar_url = data.avatar_url || null;
        this.role = data.role || "user";
        this.user_type = data.user_type || "traveler";
        this.is_merchant = data.is_merchant || false;
        this.created_at = data.created_at || null;
        this.updated_at = data.updated_at || null;
        this._locations = null;
        this._stories = null;
        this._interactions = null;
      }
      /**
       * 從資料庫記錄創建 Person 物件
       * @param {object} dbRecord - 資料庫記錄
       * @returns {Person}
       */
      static fromDbRecord(dbRecord) {
        if (!dbRecord)
          return null;
        return new _Person({
          id: dbRecord.id,
          email: dbRecord.email,
          name: dbRecord.name,
          avatar_url: dbRecord.avatar_url,
          role: dbRecord.role,
          user_type: dbRecord.user_type,
          is_merchant: dbRecord.is_merchant,
          created_at: dbRecord.created_at,
          updated_at: dbRecord.updated_at
        });
      }
      /**
       * 轉換為資料庫記錄格式
       * @returns {object}
       */
      toDbRecord() {
        return {
          id: this.id,
          email: this.email,
          name: this.name,
          avatar_url: this.avatar_url,
          role: this.role,
          user_type: this.user_type,
          is_merchant: this.is_merchant,
          created_at: this.created_at,
          updated_at: this.updated_at
        };
      }
      /**
       * 轉換為 JSON（用於 API 回應）
       * @returns {object}
       */
      toJSON() {
        return {
          id: this.id,
          email: this.email,
          name: this.name,
          avatar_url: this.avatar_url,
          role: this.role,
          user_type: this.user_type,
          is_merchant: this.is_merchant,
          created_at: this.created_at,
          updated_at: this.updated_at
        };
      }
      /**
       * 檢查是否為管理員
       * @returns {boolean}
       */
      isAdmin() {
        return this.role === "admin";
      }
      /**
       * 檢查是否為商家
       * @returns {boolean}
       */
      isMerchant() {
        return this.is_merchant || this.user_type === "merchant";
      }
      /**
       * 檢查是否為本地居民
       * @returns {boolean}
       */
      isLocal() {
        return this.user_type === "local";
      }
      /**
       * 檢查是否為旅客
       * @returns {boolean}
       */
      isTraveler() {
        return this.user_type === "traveler" || !this.is_merchant && !this.isLocal();
      }
      /**
       * 更新使用者類型
       * @param {string} userType - 'traveler', 'local', 'merchant'
       * @param {object} db - 資料庫連接（可選，用於即時更新）
       */
      async setUserType(userType, db = null) {
        this.user_type = userType;
        this.is_merchant = userType === "merchant";
        if (db && this.id) {
          try {
            await db.prepare(
              `UPDATE users SET user_type = ?, is_merchant = ? WHERE id = ?`
            ).bind(userType, this.is_merchant ? 1 : 0, this.id).run();
          } catch (error) {
            console.error("[Person] Error updating user type:", error);
            throw error;
          }
        }
      }
      /**
       * 驗證物件有效性
       * @returns {boolean}
       */
      isValid() {
        return !!(this.id && this.email);
      }
    };
  }
});

// src/models/Location.js
var Location_exports = {};
__export(Location_exports, {
  Location: () => Location
});
var Location;
var init_Location = __esm({
  "src/models/Location.js"() {
    "use strict";
    Location = class _Location {
      constructor(data = {}) {
        this.id = data.id || null;
        this.name = data.name || null;
        this.address = data.address || null;
        this.latitude = data.latitude || null;
        this.longitude = data.longitude || null;
        this.google_place_id = data.google_place_id || null;
        this.google_types = data.google_types || null;
        this.thumbnail_url = data.thumbnail_url || null;
        this.photo_url = data.photo_url || null;
        this.website = data.website || null;
        this.phone_number = data.phone_number || null;
        this.business_status = data.business_status || null;
        this.google_rating = data.google_rating || null;
        this.google_user_ratings_total = data.google_user_ratings_total || null;
        this.editorial_summary = data.editorial_summary || null;
        this.is_merchant = data.is_merchant || false;
        this.merchant_id = data.merchant_id || null;
        this.created_at = data.created_at || null;
        this.updated_at = data.updated_at || null;
        this.created_by = data.created_by || null;
        this._creator = null;
        this._merchant = null;
        this._stories = null;
        this._interactions = null;
        this._user_status = null;
      }
      /**
       * 從資料庫記錄創建 Location 物件
       * @param {object} dbRecord - 資料庫記錄
       * @returns {Location}
       */
      static fromDbRecord(dbRecord) {
        if (!dbRecord)
          return null;
        let googleTypes = dbRecord.google_types;
        if (typeof googleTypes === "string") {
          try {
            googleTypes = JSON.parse(googleTypes);
          } catch (e) {
            googleTypes = [];
          }
        }
        return new _Location({
          id: dbRecord.id,
          name: dbRecord.name,
          address: dbRecord.address,
          latitude: dbRecord.latitude,
          longitude: dbRecord.longitude,
          google_place_id: dbRecord.google_place_id,
          google_types: googleTypes,
          thumbnail_url: dbRecord.thumbnail_url,
          photo_url: dbRecord.photo_url,
          website: dbRecord.website,
          phone_number: dbRecord.phone_number,
          business_status: dbRecord.business_status,
          google_rating: dbRecord.google_rating,
          google_user_ratings_total: dbRecord.google_user_ratings_total,
          editorial_summary: dbRecord.editorial_summary,
          is_merchant: dbRecord.is_merchant || false,
          merchant_id: dbRecord.merchant_id,
          created_at: dbRecord.created_at,
          updated_at: dbRecord.updated_at,
          created_by: dbRecord.created_by
        });
      }
      /**
       * 轉換為資料庫記錄格式
       * @returns {object}
       */
      toDbRecord() {
        let googleTypes = this.google_types;
        if (Array.isArray(googleTypes)) {
          googleTypes = JSON.stringify(googleTypes);
        }
        return {
          id: this.id,
          name: this.name,
          address: this.address,
          latitude: this.latitude,
          longitude: this.longitude,
          google_place_id: this.google_place_id,
          google_types: googleTypes,
          thumbnail_url: this.thumbnail_url,
          photo_url: this.photo_url,
          website: this.website,
          phone_number: this.phone_number,
          business_status: this.business_status,
          google_rating: this.google_rating,
          google_user_ratings_total: this.google_user_ratings_total,
          editorial_summary: this.editorial_summary,
          is_merchant: this.is_merchant ? 1 : 0,
          merchant_id: this.merchant_id,
          created_at: this.created_at,
          updated_at: this.updated_at,
          created_by: this.created_by
        };
      }
      /**
       * 轉換為 JSON（用於 API 回應）
       * @param {string} userId - 可選，當前使用者 ID（用於包含使用者狀態）
       * @returns {object}
       */
      toJSON(userId = null) {
        const json = {
          id: this.id,
          name: this.name,
          address: this.address,
          latitude: this.latitude,
          longitude: this.longitude,
          google_place_id: this.google_place_id,
          google_types: Array.isArray(this.google_types) ? this.google_types : typeof this.google_types === "string" ? JSON.parse(this.google_types) : [],
          thumbnail_url: this.thumbnail_url,
          photo_url: this.photo_url,
          website: this.website,
          phone_number: this.phone_number,
          business_status: this.business_status,
          google_rating: this.google_rating,
          google_user_ratings_total: this.google_user_ratings_total,
          editorial_summary: this.editorial_summary,
          is_merchant: this.is_merchant,
          merchant_id: this.merchant_id,
          created_at: this.created_at,
          updated_at: this.updated_at,
          created_by: this.created_by
        };
        if (userId && this._user_status) {
          json.user_location_status = this._user_status;
        }
        return json;
      }
      /**
       * 獲取地點類型（翻譯後）
       * @param {function} translateFn - 可選的翻譯函數
       * @returns {string}
       */
      getTypes(translateFn = null) {
        const types = Array.isArray(this.google_types) ? this.google_types : typeof this.google_types === "string" ? JSON.parse(this.google_types) : [];
        if (translateFn && typeof translateFn === "function") {
          return types.map((type) => translateFn(type)).join(", ");
        }
        return types.join(", ");
      }
      /**
       * 檢查是否有座標
       * @returns {boolean}
       */
      hasCoordinates() {
        return !!(this.latitude && this.longitude);
      }
      /**
       * 檢查是否為商家地點
       * @returns {boolean}
       */
      isMerchantLocation() {
        return this.is_merchant || !!this.merchant_id;
      }
      /**
       * 驗證物件有效性
       * @returns {boolean}
       */
      isValid() {
        return !!(this.id && this.name);
      }
      /**
       * 計算與另一個地點的距離（需要 Google Maps API）
       * @param {Location} otherLocation - 另一個地點
       * @param {object} distanceService - DistanceService 實例
       * @returns {Promise<object|null>} 距離資訊或 null
       */
      async getDistanceTo(otherLocation, distanceService) {
        if (!this.hasCoordinates() || !otherLocation.hasCoordinates() || !distanceService) {
          return null;
        }
        try {
          return await distanceService.calculateDistance(
            { lat: this.latitude, lng: this.longitude },
            { lat: otherLocation.latitude, lng: otherLocation.longitude }
          );
        } catch (error) {
          console.error("[Location] Error calculating distance:", error);
          return null;
        }
      }
    };
  }
});

// src/models/ObjectRelations.js
var ObjectRelations;
var init_ObjectRelations = __esm({
  "src/models/ObjectRelations.js"() {
    "use strict";
    init_Person();
    init_Location();
    init_Story();
    ObjectRelations = class {
      constructor(db) {
        if (!db) {
          throw new Error("Database connection is required for ObjectRelations");
        }
        this.db = db;
      }
      /**
       * 獲取 Person 的所有 Location（透過 Story）
       * @param {string} personId - Person ID
       * @param {string} actionType - 可選，篩選行動類型
       * @returns {Promise<Location[]>}
       */
      async getPersonLocations(personId, actionType = null) {
        try {
          let query = `
        SELECT DISTINCT l.*
        FROM locations l
        INNER JOIN user_locations ul ON l.id = ul.location_id
        WHERE ul.user_id = ?
      `;
          const params = [personId];
          if (actionType) {
            query += " AND ul.status = ?";
            params.push(actionType);
          }
          query += " ORDER BY ul.created_at DESC";
          const result = await this.db.prepare(query).bind(...params).all();
          return result.results.map((record) => Location.fromDbRecord(record));
        } catch (error) {
          console.error("[ObjectRelations] Error getting person locations:", error);
          throw error;
        }
      }
      /**
       * 獲取 Person 的所有 Story
       * @param {string} personId - Person ID
       * @param {string} actionType - 可選，篩選行動類型
       * @returns {Promise<Story[]>}
       */
      async getPersonStories(personId, actionType = null) {
        try {
          let query = `
        SELECT ul.*, l.name as location_name, l.address as location_address
        FROM user_locations ul
        INNER JOIN locations l ON ul.location_id = l.id
        WHERE ul.user_id = ?
      `;
          const params = [personId];
          if (actionType) {
            query += " AND ul.status = ?";
            params.push(actionType);
          }
          query += " ORDER BY ul.created_at DESC";
          const result = await this.db.prepare(query).bind(...params).all();
          return result.results.map((record) => Story.fromUserLocationRecord(record));
        } catch (error) {
          console.error("[ObjectRelations] Error getting person stories:", error);
          throw error;
        }
      }
      /**
       * 獲取 Location 的所有 Person（透過 Story）
       * @param {string} locationId - Location ID
       * @param {string} actionType - 可選，篩選行動類型
       * @returns {Promise<Person[]>}
       */
      async getLocationPersons(locationId, actionType = null) {
        try {
          let query = `
        SELECT DISTINCT u.*
        FROM users u
        INNER JOIN user_locations ul ON u.id = ul.user_id
        WHERE ul.location_id = ?
      `;
          const params = [locationId];
          if (actionType) {
            query += " AND ul.status = ?";
            params.push(actionType);
          }
          query += " ORDER BY ul.created_at DESC";
          const result = await this.db.prepare(query).bind(...params).all();
          return result.results.map((record) => Person.fromDbRecord(record));
        } catch (error) {
          console.error("[ObjectRelations] Error getting location persons:", error);
          throw error;
        }
      }
      /**
       * 獲取 Location 的所有 Story
       * @param {string} locationId - Location ID
       * @param {string} actionType - 可選，篩選行動類型
       * @returns {Promise<Story[]>}
       */
      async getLocationStories(locationId, actionType = null) {
        try {
          let query = `
        SELECT ul.*
        FROM user_locations ul
        WHERE ul.location_id = ?
      `;
          const params = [locationId];
          if (actionType) {
            query += " AND ul.status = ?";
            params.push(actionType);
          }
          query += " ORDER BY ul.created_at DESC";
          const result = await this.db.prepare(query).bind(...params).all();
          return result.results.map((record) => Story.fromUserLocationRecord(record));
        } catch (error) {
          console.error("[ObjectRelations] Error getting location stories:", error);
          throw error;
        }
      }
      /**
       * 創建新的 Story（人 + 時 + 地 + 事）
       * @param {string} personId - Person ID
       * @param {string} locationId - Location ID
       * @param {string} actionType - 行動類型
       * @param {string} description - 可選，描述
       * @returns {Promise<Story>}
       */
      async createStory(personId, locationId, actionType, description = null) {
        try {
          const existing = await this.db.prepare(
            `SELECT * FROM user_locations 
         WHERE user_id = ? AND location_id = ? AND status = ?`
          ).bind(personId, locationId, actionType).first();
          if (existing) {
            await this.db.prepare(
              `UPDATE user_locations 
           SET user_description = ?, updated_at = datetime('now')
           WHERE id = ?`
            ).bind(description, existing.id).run();
            return Story.fromUserLocationRecord({
              ...existing,
              user_description: description,
              updated_at: (/* @__PURE__ */ new Date()).toISOString()
            });
          }
          const result = await this.db.prepare(
            `INSERT INTO user_locations (user_id, location_id, status, user_description, created_at, updated_at)
         VALUES (?, ?, ?, ?, datetime('now'), datetime('now'))`
          ).bind(personId, locationId, actionType, description).run();
          if (!result.meta.last_row_id) {
            throw new Error("Failed to create story");
          }
          const newRecord = await this.db.prepare(
            `SELECT * FROM user_locations WHERE id = ?`
          ).bind(result.meta.last_row_id).first();
          return Story.fromUserLocationRecord(newRecord);
        } catch (error) {
          console.error("[ObjectRelations] Error creating story:", error);
          throw error;
        }
      }
      /**
       * 獲取完整的故事（包含 Person 和 Location 物件）
       * @param {string} storyId - Story ID
       * @returns {Promise<Story|null>}
       */
      async getFullStory(storyId) {
        try {
          const storyRecord = await this.db.prepare(
            `SELECT ul.* FROM user_locations ul WHERE ul.id = ?`
          ).bind(storyId).first();
          if (!storyRecord)
            return null;
          const story = Story.fromUserLocationRecord(storyRecord);
          const personRecord = await this.db.prepare(
            `SELECT * FROM users WHERE id = ?`
          ).bind(story.person_id).first();
          if (personRecord) {
            story._person = Person.fromDbRecord(personRecord);
          }
          const locationRecord = await this.db.prepare(
            `SELECT * FROM locations WHERE id = ?`
          ).bind(story.location_id).first();
          if (locationRecord) {
            story._location = Location.fromDbRecord(locationRecord);
          }
          return story;
        } catch (error) {
          console.error("[ObjectRelations] Error getting full story:", error);
          throw error;
        }
      }
      /**
       * 獲取 Person 的故事時間線
       * @param {string} personId - Person ID
       * @returns {Promise<Story[]>} 按時間排序的故事陣列
       */
      async getPersonTimeline(personId) {
        try {
          const stories = await this.getPersonStories(personId);
          return stories.sort((a, b) => {
            const timeA = new Date(a.created_at || 0).getTime();
            const timeB = new Date(b.created_at || 0).getTime();
            return timeB - timeA;
          });
        } catch (error) {
          console.error("[ObjectRelations] Error getting person timeline:", error);
          throw error;
        }
      }
      /**
       * 獲取 Location 的互動統計
       * @param {string} locationId - Location ID
       * @returns {Promise<object>} 統計資訊
       */
      async getLocationStats(locationId) {
        try {
          const result = await this.db.prepare(
            `SELECT 
          status,
          COUNT(*) as count
         FROM user_locations
         WHERE location_id = ?
         GROUP BY status`
          ).bind(locationId).all();
          const stats = {
            visited: 0,
            want_to_visit: 0,
            want_to_revisit: 0,
            total: 0
          };
          result.results.forEach((row) => {
            const status = row.status;
            const count = row.count || 0;
            stats[status] = count;
            stats.total += count;
          });
          return stats;
        } catch (error) {
          console.error("[ObjectRelations] Error getting location stats:", error);
          throw error;
        }
      }
    };
  }
});

// src/modules/TimeModule.js
var TimeModule_exports = {};
__export(TimeModule_exports, {
  TimeModule: () => TimeModule
});
var TimeModule;
var init_TimeModule = __esm({
  "src/modules/TimeModule.js"() {
    "use strict";
    TimeModule = class {
      constructor() {
        this.dateFormat = "YYYY-MM-DD";
        this.datetimeFormat = "YYYY-MM-DD HH:mm:ss";
        this.timezone = "Asia/Taipei";
      }
      /**
       * 獲取當前時間戳記（ISO 格式）
       * @returns {string}
       */
      getCurrentTimestamp() {
        return (/* @__PURE__ */ new Date()).toISOString();
      }
      /**
       * 獲取當前時間（SQLite datetime 格式）
       * @returns {string}
       */
      getCurrentDatetime() {
        const now = /* @__PURE__ */ new Date();
        return this.formatDatetime(now);
      }
      /**
       * 格式化日期時間為 SQLite 格式
       * @param {Date|string} date - 日期物件或字串
       * @returns {string}
       */
      formatDatetime(date) {
        if (!date)
          return null;
        const d = date instanceof Date ? date : new Date(date);
        if (isNaN(d.getTime()))
          return null;
        const year = d.getFullYear();
        const month = String(d.getMonth() + 1).padStart(2, "0");
        const day = String(d.getDate()).padStart(2, "0");
        const hours = String(d.getHours()).padStart(2, "0");
        const minutes = String(d.getMinutes()).padStart(2, "0");
        const seconds = String(d.getSeconds()).padStart(2, "0");
        return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
      }
      /**
       * 格式化日期
       * @param {Date|string} date - 日期物件或字串
       * @returns {string}
       */
      formatDate(date) {
        if (!date)
          return null;
        const d = date instanceof Date ? date : new Date(date);
        if (isNaN(d.getTime()))
          return null;
        const year = d.getFullYear();
        const month = String(d.getMonth() + 1).padStart(2, "0");
        const day = String(d.getDate()).padStart(2, "0");
        return `${year}-${month}-${day}`;
      }
      /**
       * 格式化為相對時間（例如：3 天前、2 小時前）
       * @param {Date|string} date - 日期物件或字串
       * @returns {string}
       */
      formatRelativeTime(date) {
        if (!date)
          return "\u672A\u77E5\u6642\u9593";
        const d = date instanceof Date ? date : new Date(date);
        if (isNaN(d.getTime()))
          return "\u7121\u6548\u6642\u9593";
        const now = /* @__PURE__ */ new Date();
        const diffMs = now.getTime() - d.getTime();
        const diffSeconds = Math.floor(diffMs / 1e3);
        const diffMinutes = Math.floor(diffSeconds / 60);
        const diffHours = Math.floor(diffMinutes / 60);
        const diffDays = Math.floor(diffHours / 24);
        const diffMonths = Math.floor(diffDays / 30);
        const diffYears = Math.floor(diffDays / 365);
        if (diffSeconds < 60) {
          return "\u525B\u525B";
        } else if (diffMinutes < 60) {
          return `${diffMinutes} \u5206\u9418\u524D`;
        } else if (diffHours < 24) {
          return `${diffHours} \u5C0F\u6642\u524D`;
        } else if (diffDays < 30) {
          return `${diffDays} \u5929\u524D`;
        } else if (diffMonths < 12) {
          return `${diffMonths} \u500B\u6708\u524D`;
        } else {
          return `${diffYears} \u5E74\u524D`;
        }
      }
      /**
       * 格式化為中文日期時間
       * @param {Date|string} date - 日期物件或字串
       * @returns {string}
       */
      formatChineseDatetime(date) {
        if (!date)
          return "\u672A\u77E5\u6642\u9593";
        const d = date instanceof Date ? date : new Date(date);
        if (isNaN(d.getTime()))
          return "\u7121\u6548\u6642\u9593";
        const year = d.getFullYear();
        const month = d.getMonth() + 1;
        const day = d.getDate();
        const hours = d.getHours();
        const minutes = d.getMinutes();
        return `${year}\u5E74${month}\u6708${day}\u65E5 ${hours.toString().padStart(2, "0")}:${minutes.toString().padStart(2, "0")}`;
      }
      /**
       * 解析時間描述（例如：「3 天前」、「上個月」）
       * @param {string} timeDescription - 時間描述
       * @returns {Date|null}
       */
      parseTimeDescription(timeDescription) {
        if (!timeDescription)
          return null;
        const now = /* @__PURE__ */ new Date();
        const desc = timeDescription.toLowerCase().trim();
        const daysAgoMatch = desc.match(/(\d+)\s*天前/);
        if (daysAgoMatch) {
          const days = parseInt(daysAgoMatch[1]);
          const date = new Date(now);
          date.setDate(date.getDate() - days);
          return date;
        }
        const hoursAgoMatch = desc.match(/(\d+)\s*小時前/);
        if (hoursAgoMatch) {
          const hours = parseInt(hoursAgoMatch[1]);
          const date = new Date(now);
          date.setHours(date.getHours() - hours);
          return date;
        }
        if (desc.includes("\u4E0A\u500B\u6708")) {
          const date = new Date(now);
          date.setMonth(date.getMonth() - 1);
          return date;
        }
        if (desc.includes("\u53BB\u5E74")) {
          const date = new Date(now);
          date.setFullYear(date.getFullYear() - 1);
          return date;
        }
        const parsed = new Date(timeDescription);
        if (!isNaN(parsed.getTime())) {
          return parsed;
        }
        return null;
      }
      /**
       * 計算時間差
       * @param {Date|string} startDate - 開始時間
       * @param {Date|string} endDate - 結束時間（預設為現在）
       * @returns {object} 包含 days, hours, minutes, seconds
       */
      calculateTimeDifference(startDate, endDate = null) {
        if (!startDate)
          return null;
        const start = startDate instanceof Date ? startDate : new Date(startDate);
        const end = endDate ? endDate instanceof Date ? endDate : new Date(endDate) : /* @__PURE__ */ new Date();
        if (isNaN(start.getTime()) || isNaN(end.getTime()))
          return null;
        const diffMs = Math.abs(end.getTime() - start.getTime());
        const diffSeconds = Math.floor(diffMs / 1e3);
        const diffMinutes = Math.floor(diffSeconds / 60);
        const diffHours = Math.floor(diffMinutes / 60);
        const diffDays = Math.floor(diffHours / 24);
        return {
          days: diffDays,
          hours: diffHours % 24,
          minutes: diffMinutes % 60,
          seconds: diffSeconds % 60,
          totalSeconds: diffSeconds,
          totalMinutes: diffMinutes,
          totalHours: diffHours,
          totalDays: diffDays
        };
      }
      /**
       * 檢查時間是否在範圍內
       * @param {Date|string} date - 要檢查的時間
       * @param {Date|string} startDate - 開始時間
       * @param {Date|string} endDate - 結束時間
       * @returns {boolean}
       */
      isInTimeRange(date, startDate, endDate) {
        if (!date || !startDate || !endDate)
          return false;
        const d = date instanceof Date ? date : new Date(date);
        const start = startDate instanceof Date ? startDate : new Date(startDate);
        const end = endDate instanceof Date ? endDate : new Date(endDate);
        if (isNaN(d.getTime()) || isNaN(start.getTime()) || isNaN(end.getTime())) {
          return false;
        }
        return d.getTime() >= start.getTime() && d.getTime() <= end.getTime();
      }
      /**
       * 獲取時間範圍的 SQL WHERE 條件
       * @param {string} columnName - 資料庫欄位名稱
       * @param {Date|string} startDate - 開始時間（可選）
       * @param {Date|string} endDate - 結束時間（可選）
       * @returns {object} { sql: string, params: array }
       */
      getTimeRangeCondition(columnName, startDate = null, endDate = null) {
        const conditions = [];
        const params = [];
        if (startDate) {
          conditions.push(`${columnName} >= ?`);
          params.push(this.formatDatetime(startDate));
        }
        if (endDate) {
          conditions.push(`${columnName} <= ?`);
          params.push(this.formatDatetime(endDate));
        }
        if (conditions.length === 0) {
          return { sql: "", params: [] };
        }
        return {
          sql: conditions.join(" AND "),
          params
        };
      }
      /**
       * 為 Story 物件生成時間描述
       * @param {object} story - Story 物件
       * @returns {string}
       */
      getStoryTimeDescription(story) {
        if (!story)
          return "\u672A\u77E5\u6642\u9593";
        if (story.time) {
          return this.formatRelativeTime(story.time);
        }
        if (story.created_at) {
          return this.formatRelativeTime(story.created_at);
        }
        return "\u672A\u77E5\u6642\u9593";
      }
    };
  }
});

// src/modules/ActionModule.js
var ActionModule_exports = {};
__export(ActionModule_exports, {
  ActionModule: () => ActionModule
});
var ActionModule;
var init_ActionModule = __esm({
  "src/modules/ActionModule.js"() {
    "use strict";
    ActionModule = class {
      constructor() {
        this.actionTypes = {
          // 地點相關行動
          VISITED: "visited",
          // 來過
          WANT_TO_VISIT: "want_to_visit",
          // 想來
          WANT_TO_REVISIT: "want_to_revisit",
          // 想再來
          CREATED: "created",
          // 建立了地點
          SHARED: "shared",
          // 分享了地點
          // 商家相關行動
          CLAIMED: "claimed",
          // 認領了地點
          UPDATED: "updated",
          // 更新了資訊
          // 其他行動
          LIKED: "liked",
          // 喜歡
          COMMENTED: "commented",
          // 評論
          FOLLOWED: "followed"
          // 關注
        };
        this.actionTypeNames = {
          "visited": "\u4F86\u904E",
          "want_to_visit": "\u60F3\u4F86",
          "want_to_revisit": "\u60F3\u518D\u4F86",
          "created": "\u5EFA\u7ACB\u4E86",
          "shared": "\u5206\u4EAB\u4E86",
          "claimed": "\u8A8D\u9818\u4E86",
          "updated": "\u66F4\u65B0\u4E86",
          "liked": "\u559C\u6B61\u4E86",
          "commented": "\u8A55\u8AD6\u4E86",
          "followed": "\u95DC\u6CE8\u4E86"
        };
        this.actionTypeIcons = {
          "visited": "\u2713",
          "want_to_visit": "\u2764",
          "want_to_revisit": "\u{1F504}",
          "created": "\u2795",
          "shared": "\u{1F4E4}",
          "claimed": "\u{1F3EA}",
          "updated": "\u270F\uFE0F",
          "liked": "\u{1F44D}",
          "commented": "\u{1F4AC}",
          "followed": "\u{1F441}"
        };
        this.actionTypeColors = {
          "visited": "green",
          "want_to_visit": "blue",
          "want_to_revisit": "purple",
          "created": "orange",
          "shared": "gray",
          "claimed": "yellow",
          "updated": "teal",
          "liked": "red",
          "commented": "indigo",
          "followed": "pink"
        };
      }
      /**
       * 獲取行動類型的中文名稱
       * @param {string} actionType - 行動類型
       * @returns {string}
       */
      getActionTypeName(actionType) {
        return this.actionTypeNames[actionType] || actionType;
      }
      /**
       * 獲取行動類型的圖標
       * @param {string} actionType - 行動類型
       * @returns {string}
       */
      getActionTypeIcon(actionType) {
        return this.actionTypeIcons[actionType] || "\u2022";
      }
      /**
       * 獲取行動類型的顏色
       * @param {string} actionType - 行動類型
       * @returns {string}
       */
      getActionTypeColor(actionType) {
        return this.actionTypeColors[actionType] || "gray";
      }
      /**
       * 驗證行動類型是否有效
       * @param {string} actionType - 行動類型
       * @returns {boolean}
       */
      isValidActionType(actionType) {
        return Object.values(this.actionTypes).includes(actionType);
      }
      /**
       * 獲取所有支援的行動類型
       * @returns {array}
       */
      getAllActionTypes() {
        return Object.values(this.actionTypes);
      }
      /**
       * 獲取地點相關的行動類型
       * @returns {array}
       */
      getLocationActionTypes() {
        return [
          this.actionTypes.VISITED,
          this.actionTypes.WANT_TO_VISIT,
          this.actionTypes.WANT_TO_REVISIT,
          this.actionTypes.CREATED,
          this.actionTypes.SHARED
        ];
      }
      /**
       * 獲取商家相關的行動類型
       * @returns {array}
       */
      getMerchantActionTypes() {
        return [
          this.actionTypes.CLAIMED,
          this.actionTypes.UPDATED
        ];
      }
      /**
       * 生成行動描述（用於 Story）
       * @param {string} actionType - 行動類型
       * @param {string} locationName - 地點名稱（可選）
       * @returns {string}
       */
      generateActionDescription(actionType, locationName = null) {
        const actionName = this.getActionTypeName(actionType);
        const icon = this.getActionTypeIcon(actionType);
        if (locationName) {
          return `${icon} ${actionName} ${locationName}`;
        }
        return `${icon} ${actionName}`;
      }
      /**
       * 獲取行動的 CSS 類別（用於樣式）
       * @param {string} actionType - 行動類型
       * @returns {string}
       */
      getActionCssClass(actionType) {
        const color = this.getActionTypeColor(actionType);
        return `action-${actionType} action-color-${color}`;
      }
      /**
       * 獲取行動的按鈕樣式類別
       * @param {string} actionType - 行動類型
       * @param {boolean} isActive - 是否為當前狀態
       * @returns {string}
       */
      getActionButtonClass(actionType, isActive = false) {
        const baseClass = this.getActionCssClass(actionType);
        const color = this.getActionTypeColor(actionType);
        if (isActive) {
          return `bg-${color}-500 text-white ${baseClass}`;
        }
        return `bg-gray-200 text-gray-700 hover:bg-${color}-100 ${baseClass}`;
      }
      /**
       * 從使用者輸入中識別行動類型
       * @param {string} input - 使用者輸入
       * @returns {string|null}
       */
      identifyActionFromInput(input) {
        if (!input)
          return null;
        const lowerInput = input.toLowerCase();
        if (lowerInput.includes("\u4F86\u904E") || lowerInput.includes("\u53BB\u904E") || lowerInput.includes("\u9020\u8A2A\u904E")) {
          return this.actionTypes.VISITED;
        }
        if (lowerInput.includes("\u60F3\u4F86") || lowerInput.includes("\u60F3\u53BB") || lowerInput.includes("\u8A08\u5283")) {
          return this.actionTypes.WANT_TO_VISIT;
        }
        if (lowerInput.includes("\u60F3\u518D\u4F86") || lowerInput.includes("\u60F3\u518D\u53BB") || lowerInput.includes("\u9084\u60F3")) {
          return this.actionTypes.WANT_TO_REVISIT;
        }
        if (lowerInput.includes("\u5EFA\u7ACB") || lowerInput.includes("\u65B0\u589E") || lowerInput.includes("\u5275\u5EFA")) {
          return this.actionTypes.CREATED;
        }
        if (lowerInput.includes("\u5206\u4EAB") || lowerInput.includes("\u63A8\u85A6")) {
          return this.actionTypes.SHARED;
        }
        if (lowerInput.includes("\u8A8D\u9818") || lowerInput.includes("claim")) {
          return this.actionTypes.CLAIMED;
        }
        return null;
      }
      /**
       * 獲取行動統計資訊
       * @param {array} stories - Story 物件陣列
       * @returns {object} 統計資訊
       */
      getActionStatistics(stories) {
        const stats = {};
        Object.values(this.actionTypes).forEach((actionType) => {
          stats[actionType] = 0;
        });
        if (Array.isArray(stories)) {
          stories.forEach((story) => {
            if (story && story.action_type && stats.hasOwnProperty(story.action_type)) {
              stats[story.action_type]++;
            }
          });
        }
        stats.total = Object.values(stats).reduce((sum, count) => sum + count, 0);
        return stats;
      }
      /**
       * 過濾 Story 陣列 by 行動類型
       * @param {array} stories - Story 物件陣列
       * @param {string} actionType - 行動類型
       * @returns {array}
       */
      filterStoriesByAction(stories, actionType) {
        if (!Array.isArray(stories) || !actionType) {
          return [];
        }
        return stories.filter((story) => story && story.action_type === actionType);
      }
      /**
       * 排序 Story 陣列（按行動類型優先級）
       * @param {array} stories - Story 物件陣列
       * @returns {array}
       */
      sortStoriesByActionPriority(stories) {
        if (!Array.isArray(stories)) {
          return [];
        }
        const priority = {
          [this.actionTypes.CREATED]: 1,
          [this.actionTypes.CLAIMED]: 2,
          [this.actionTypes.VISITED]: 3,
          [this.actionTypes.WANT_TO_REVISIT]: 4,
          [this.actionTypes.WANT_TO_VISIT]: 5,
          [this.actionTypes.SHARED]: 6,
          [this.actionTypes.UPDATED]: 7,
          [this.actionTypes.LIKED]: 8,
          [this.actionTypes.COMMENTED]: 9,
          [this.actionTypes.FOLLOWED]: 10
        };
        return [...stories].sort((a, b) => {
          const priorityA = priority[a == null ? void 0 : a.action_type] || 999;
          const priorityB = priority[b == null ? void 0 : b.action_type] || 999;
          return priorityA - priorityB;
        });
      }
    };
  }
});

// src/services/StoryModule.js
var StoryModule;
var init_StoryModule = __esm({
  "src/services/StoryModule.js"() {
    "use strict";
    init_Story();
    init_ObjectRelations();
    init_TimeModule();
    init_ActionModule();
    StoryModule = class {
      constructor(db) {
        if (!db) {
          throw new Error("Database connection is required for StoryModule");
        }
        this.db = db;
        this.relations = new ObjectRelations(db);
        this.timeModule = new TimeModule();
        this.actionModule = new ActionModule();
      }
      /**
       * 創建新的 Story（人 + 時 + 地 + 事）
       * @param {string} personId - Person ID
       * @param {string} locationId - Location ID
       * @param {string} actionType - 行動類型
       * @param {string} description - 可選，描述
       * @returns {Promise<Story>}
       */
      async createStory(personId, locationId, actionType, description = null) {
        try {
          if (!this.actionModule.isValidActionType(actionType)) {
            throw new Error(`Invalid action type: ${actionType}`);
          }
          const story = await this.relations.createStory(personId, locationId, actionType, description);
          return story;
        } catch (error) {
          console.error("[StoryModule] Error creating story:", error);
          throw error;
        }
      }
      /**
       * 獲取完整的 Story（包含 Person 和 Location）
       * @param {string} storyId - Story ID
       * @returns {Promise<object|null>}
       */
      async getFullStory(storyId) {
        var _a;
        try {
          const story = await this.relations.getFullStory(storyId);
          if (!story)
            return null;
          return {
            ...story.toJSON(),
            timeDescription: this.timeModule.getStoryTimeDescription(story),
            actionName: this.actionModule.getActionTypeName(story.action_type),
            actionIcon: this.actionModule.getActionTypeIcon(story.action_type),
            actionColor: this.actionModule.getActionTypeColor(story.action_type),
            actionDescription: this.actionModule.generateActionDescription(
              story.action_type,
              (_a = story._location) == null ? void 0 : _a.name
            )
          };
        } catch (error) {
          console.error("[StoryModule] Error getting full story:", error);
          throw error;
        }
      }
      /**
       * 獲取 Person 的故事時間線
       * @param {string} personId - Person ID
       * @param {string} actionType - 可選，篩選行動類型
       * @returns {Promise<array>}
       */
      async getPersonTimeline(personId, actionType = null) {
        try {
          const timeline = await this.relations.getPersonTimeline(personId);
          let stories = timeline;
          if (actionType) {
            stories = this.actionModule.filterStoriesByAction(timeline, actionType);
          }
          return stories.map((story) => {
            var _a;
            return {
              ...story.toJSON(),
              timeDescription: this.timeModule.getStoryTimeDescription(story),
              actionName: this.actionModule.getActionTypeName(story.action_type),
              actionIcon: this.actionModule.getActionTypeIcon(story.action_type),
              actionColor: this.actionModule.getActionTypeColor(story.action_type),
              actionDescription: this.actionModule.generateActionDescription(
                story.action_type,
                (_a = story._location) == null ? void 0 : _a.name
              )
            };
          });
        } catch (error) {
          console.error("[StoryModule] Error getting person timeline:", error);
          throw error;
        }
      }
      /**
       * 獲取 Location 的故事
       * @param {string} locationId - Location ID
       * @param {string} actionType - 可選，篩選行動類型
       * @returns {Promise<array>}
       */
      async getLocationStories(locationId, actionType = null) {
        try {
          const stories = await this.relations.getLocationStories(locationId, actionType);
          return stories.map((story) => ({
            ...story.toJSON(),
            timeDescription: this.timeModule.getStoryTimeDescription(story),
            actionName: this.actionModule.getActionTypeName(story.action_type),
            actionIcon: this.actionModule.getActionTypeIcon(story.action_type),
            actionColor: this.actionModule.getActionTypeColor(story.action_type)
          }));
        } catch (error) {
          console.error("[StoryModule] Error getting location stories:", error);
          throw error;
        }
      }
      /**
       * 獲取故事統計
       * @param {string} personId - 可選，Person ID
       * @param {string} locationId - 可選，Location ID
       * @returns {Promise<object>}
       */
      async getStoryStatistics(personId = null, locationId = null) {
        try {
          let stories = [];
          if (personId) {
            stories = await this.relations.getPersonStories(personId);
          } else if (locationId) {
            stories = await this.relations.getLocationStories(locationId);
          } else {
            throw new Error("Either personId or locationId must be provided");
          }
          const actionStats = this.actionModule.getActionStatistics(stories);
          const timeStats = {
            total: stories.length,
            thisWeek: 0,
            thisMonth: 0,
            thisYear: 0
          };
          const now = /* @__PURE__ */ new Date();
          const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1e3);
          const monthAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1e3);
          const yearAgo = new Date(now.getTime() - 365 * 24 * 60 * 60 * 1e3);
          stories.forEach((story) => {
            const storyTime = story.created_at ? new Date(story.created_at) : null;
            if (storyTime) {
              if (storyTime >= weekAgo)
                timeStats.thisWeek++;
              if (storyTime >= monthAgo)
                timeStats.thisMonth++;
              if (storyTime >= yearAgo)
                timeStats.thisYear++;
            }
          });
          return {
            actionStats,
            timeStats
          };
        } catch (error) {
          console.error("[StoryModule] Error getting story statistics:", error);
          throw error;
        }
      }
      /**
       * 更新 Story
       * @param {string} storyId - Story ID
       * @param {object} updates - 要更新的欄位
       * @returns {Promise<Story>}
       */
      async updateStory(storyId, updates) {
        try {
          const updateFields = [];
          const updateValues = [];
          if (updates.user_description !== void 0) {
            updateFields.push("user_description = ?");
            updateValues.push(updates.user_description);
          }
          if (updates.status !== void 0) {
            updateFields.push("status = ?");
            updateValues.push(updates.status);
          }
          if (updateFields.length === 0) {
            return await this.relations.getFullStory(storyId);
          }
          updateFields.push('updated_at = datetime("now")');
          updateValues.push(storyId);
          const sql = `UPDATE user_locations SET ${updateFields.join(", ")} WHERE id = ?`;
          await this.db.prepare(sql).bind(...updateValues).run();
          return await this.relations.getFullStory(storyId);
        } catch (error) {
          console.error("[StoryModule] Error updating story:", error);
          throw error;
        }
      }
    };
  }
});

// src/services/LocationModule.js
var LocationModule;
var init_LocationModule = __esm({
  "src/services/LocationModule.js"() {
    "use strict";
    init_Location();
    init_ObjectRelations();
    init_TimeModule();
    init_ActionModule();
    init_LocationService();
    LocationModule = class {
      constructor(db, googleMapsApiKey = null) {
        if (!db) {
          throw new Error("Database connection is required for LocationModule");
        }
        this.db = db;
        this.locationService = new LocationService(db, googleMapsApiKey);
        this.relations = new ObjectRelations(db);
        this.timeModule = new TimeModule();
        this.actionModule = new ActionModule();
      }
      /**
       * 根據 ID 獲取 Location
       * @param {string} locationId - Location ID
       * @param {string} userId - 可選，當前使用者 ID（用於包含使用者狀態）
       * @returns {Promise<Location|null>}
       */
      async getLocationById(locationId, userId = null) {
        try {
          const record = await this.db.prepare(
            "SELECT * FROM locations WHERE id = ?"
          ).bind(locationId).first();
          if (!record)
            return null;
          const location = Location.fromDbRecord(record);
          if (userId) {
            const userLocation = await this.db.prepare(
              "SELECT status FROM user_locations WHERE user_id = ? AND location_id = ? LIMIT 1"
            ).bind(userId, locationId).first();
            if (userLocation) {
              location._user_status = userLocation.status;
            }
          }
          return location;
        } catch (error) {
          console.error("[LocationModule] Error getting location:", error);
          throw error;
        }
      }
      /**
       * 獲取 Location 的完整資訊（包含關聯資料）
       * @param {string} locationId - Location ID
       * @param {string} userId - 可選，當前使用者 ID
       * @returns {Promise<object>}
       */
      async getLocationProfile(locationId, userId = null) {
        try {
          const location = await this.getLocationById(locationId, userId);
          if (!location)
            return null;
          const persons = await this.relations.getLocationPersons(locationId);
          const stories = await this.relations.getLocationStories(locationId);
          const enrichedStories = stories.map((story) => ({
            ...story.toJSON(),
            timeDescription: this.timeModule.getStoryTimeDescription(story),
            actionName: this.actionModule.getActionTypeName(story.action_type),
            actionIcon: this.actionModule.getActionTypeIcon(story.action_type),
            actionColor: this.actionModule.getActionTypeColor(story.action_type)
          }));
          const stats = await this.relations.getLocationStats(locationId);
          const actionStats = this.actionModule.getActionStatistics(stories);
          return {
            location: location.toJSON(userId),
            relatedPersons: persons.map((p) => p.toJSON()),
            stories: enrichedStories,
            statistics: {
              ...stats,
              actionStats
            }
          };
        } catch (error) {
          console.error("[LocationModule] Error getting location profile:", error);
          throw error;
        }
      }
      /**
       * 創建新的 Location（使用 LocationService）
       * @param {object} locationData - 地點資料
       * @param {string} createdBy - 創建者 Person ID
       * @returns {Promise<Location>}
       */
      async createLocation(locationData, createdBy = null) {
        try {
          const result = await this.locationService.createLocation(locationData, createdBy);
          if (!result || !result.id) {
            throw new Error("Failed to create location");
          }
          return await this.getLocationById(result.id);
        } catch (error) {
          console.error("[LocationModule] Error creating location:", error);
          throw error;
        }
      }
      /**
       * 更新 Location 資訊
       * @param {string} locationId - Location ID
       * @param {object} updates - 要更新的欄位
       * @returns {Promise<Location>}
       */
      async updateLocation(locationId, updates) {
        try {
          await this.locationService.updateLocation(locationId, updates);
          return await this.getLocationById(locationId);
        } catch (error) {
          console.error("[LocationModule] Error updating location:", error);
          throw error;
        }
      }
      /**
       * 獲取分頁的地點列表
       * @param {number} limit - 每頁數量
       * @param {number} offset - 偏移量
       * @param {string} userId - 可選，當前使用者 ID
       * @returns {Promise<{locations: Location[], total: number}>}
       */
      async getLocationsPaginated(limit = 12, offset = 0, userId = null) {
        try {
          const result = await this.locationService.getLocationsPaginated(limit, offset, userId);
          const locations = result.locations.map((record) => Location.fromDbRecord(record));
          return {
            locations,
            total: result.total || locations.length,
            hasMore: result.hasMore || false
          };
        } catch (error) {
          console.error("[LocationModule] Error getting paginated locations:", error);
          throw error;
        }
      }
    };
  }
});

// src/services/PersonModule.js
var PersonModule;
var init_PersonModule = __esm({
  "src/services/PersonModule.js"() {
    "use strict";
    init_Person();
    init_ObjectRelations();
    init_TimeModule();
    init_ActionModule();
    PersonModule = class {
      constructor(db) {
        if (!db) {
          throw new Error("Database connection is required for PersonModule");
        }
        this.db = db;
        this.relations = new ObjectRelations(db);
        this.timeModule = new TimeModule();
        this.actionModule = new ActionModule();
      }
      /**
       * 根據 ID 獲取 Person
       * @param {string} personId - Person ID
       * @returns {Promise<Person|null>}
       */
      async getPersonById(personId) {
        try {
          const record = await this.db.prepare(
            "SELECT * FROM users WHERE id = ?"
          ).bind(personId).first();
          return record ? Person.fromDbRecord(record) : null;
        } catch (error) {
          console.error("[PersonModule] Error getting person:", error);
          throw error;
        }
      }
      /**
       * 根據 Email 獲取 Person
       * @param {string} email - Email
       * @returns {Promise<Person|null>}
       */
      async getPersonByEmail(email) {
        try {
          const record = await this.db.prepare(
            "SELECT * FROM users WHERE email = ?"
          ).bind(email).first();
          return record ? Person.fromDbRecord(record) : null;
        } catch (error) {
          console.error("[PersonModule] Error getting person by email:", error);
          throw error;
        }
      }
      /**
       * 獲取 Person 的完整資訊（包含關聯資料）
       * @param {string} personId - Person ID
       * @returns {Promise<object>}
       */
      async getPersonProfile(personId) {
        try {
          const person = await this.getPersonById(personId);
          if (!person)
            return null;
          const locations = await this.relations.getPersonLocations(personId);
          const timeline = await this.relations.getPersonTimeline(personId);
          const enrichedTimeline = timeline.map((story) => ({
            ...story.toJSON(),
            timeDescription: this.timeModule.getStoryTimeDescription(story),
            actionName: this.actionModule.getActionTypeName(story.action_type),
            actionIcon: this.actionModule.getActionTypeIcon(story.action_type),
            actionColor: this.actionModule.getActionTypeColor(story.action_type)
          }));
          const actionStats = this.actionModule.getActionStatistics(timeline);
          return {
            person: person.toJSON(),
            locations: locations.map((loc) => loc.toJSON()),
            timeline: enrichedTimeline,
            statistics: {
              totalLocations: locations.length,
              totalStories: timeline.length,
              actionStats
            }
          };
        } catch (error) {
          console.error("[PersonModule] Error getting person profile:", error);
          throw error;
        }
      }
      /**
       * 更新 Person 資訊
       * @param {string} personId - Person ID
       * @param {object} updates - 要更新的欄位
       * @returns {Promise<Person>}
       */
      async updatePerson(personId, updates) {
        try {
          const updateFields = [];
          const updateValues = [];
          if (updates.name !== void 0) {
            updateFields.push("name = ?");
            updateValues.push(updates.name);
          }
          if (updates.avatar_url !== void 0) {
            updateFields.push("avatar_url = ?");
            updateValues.push(updates.avatar_url);
          }
          if (updates.user_type !== void 0) {
            updateFields.push("user_type = ?");
            updateValues.push(updates.user_type);
            updateFields.push("is_merchant = ?");
            updateValues.push(updates.user_type === "merchant" ? 1 : 0);
          }
          if (updateFields.length === 0) {
            return await this.getPersonById(personId);
          }
          updateFields.push('updated_at = datetime("now")');
          updateValues.push(personId);
          const sql = `UPDATE users SET ${updateFields.join(", ")} WHERE id = ?`;
          await this.db.prepare(sql).bind(...updateValues).run();
          return await this.getPersonById(personId);
        } catch (error) {
          console.error("[PersonModule] Error updating person:", error);
          throw error;
        }
      }
    };
  }
});

// src/services/RecommendationService.js
var RecommendationService;
var init_RecommendationService = __esm({
  "src/services/RecommendationService.js"() {
    "use strict";
    init_StoryModule();
    init_LocationModule();
    init_PersonModule();
    RecommendationService = class {
      constructor(db, googleMapsApiKey = null) {
        if (!db) {
          throw new Error("Database connection is required for RecommendationService");
        }
        this.db = db;
        this.storyModule = new StoryModule(db);
        this.locationModule = new LocationModule(db, googleMapsApiKey);
        this.personModule = new PersonModule(db);
      }
      /**
       * 基於用戶故事推薦相關地點
       * @param {string} userId - 用戶 ID
       * @param {number} limit - 推薦數量（預設 10）
       * @returns {Promise<array>} 推薦地點陣列
       */
      async recommendLocationsByStories(userId, limit = 10) {
        try {
          const userStories = await this.storyModule.getPersonTimeline(userId);
          if (userStories.length === 0) {
            return await this.getPopularLocations(limit);
          }
          const userPreferences = this.analyzeUserPreferences(userStories);
          const recommendations = await this.getRecommendationsByPreferences(
            userPreferences,
            userStories,
            limit
          );
          return recommendations;
        } catch (error) {
          console.error("[RecommendationService] Error recommending by stories:", error);
          throw error;
        }
      }
      /**
       * 分析用戶偏好
       * @param {array} stories - 用戶故事陣列
       * @returns {object} 用戶偏好物件
       */
      analyzeUserPreferences(stories) {
        const preferences = {
          visitedTypes: {},
          // 訪問過的地點類型
          preferredTypes: {},
          // 偏好的地點類型
          visitedLocations: /* @__PURE__ */ new Set(),
          // 已訪問的地點 ID
          actionWeights: {
            visited: 3,
            // 來過權重最高
            want_to_revisit: 2,
            // 想再來次之
            want_to_visit: 1
            // 想來權重最低
          }
        };
        stories.forEach((story) => {
          const actionType = story.action_type || story.status;
          const weight = preferences.actionWeights[actionType] || 1;
          if (story.location_id) {
            preferences.visitedLocations.add(story.location_id);
          }
          if (story._location && story._location.googleTypes) {
            const types = Array.isArray(story._location.googleTypes) ? story._location.googleTypes : JSON.parse(story._location.googleTypes || "[]");
            types.forEach((type) => {
              if (!preferences.preferredTypes[type]) {
                preferences.preferredTypes[type] = 0;
              }
              preferences.preferredTypes[type] += weight;
            });
          }
        });
        return preferences;
      }
      /**
       * 基於偏好獲取推薦
       * @param {object} preferences - 用戶偏好
       * @param {array} userStories - 用戶故事
       * @param {number} limit - 推薦數量
       * @returns {Promise<array>}
       */
      async getRecommendationsByPreferences(preferences, userStories, limit) {
        try {
          const allLocations = await this.locationModule.getLocationsPaginated(100, 0);
          const candidateLocations = allLocations.locations.filter(
            (loc) => !preferences.visitedLocations.has(loc.id)
          );
          const scoredLocations = await Promise.all(
            candidateLocations.map(async (location) => {
              const score = await this.calculateRecommendationScore(
                location,
                preferences,
                userStories
              );
              return { location, score };
            })
          );
          return scoredLocations.sort((a, b) => b.score - a.score).slice(0, limit).map((item) => ({
            ...item.location.toJSON(),
            recommendation_score: item.score,
            recommendation_reason: this.generateRecommendationReason(
              item.location,
              item.score,
              preferences
            )
          }));
        } catch (error) {
          console.error("[RecommendationService] Error getting recommendations:", error);
          throw error;
        }
      }
      /**
       * 計算推薦分數
       * @param {object} location - Location 物件
       * @param {object} preferences - 用戶偏好
       * @param {array} userStories - 用戶故事
       * @returns {Promise<number>} 推薦分數
       */
      async calculateRecommendationScore(location, preferences, userStories) {
        let score = 0;
        if (location.googleTypes) {
          const types = Array.isArray(location.googleTypes) ? location.googleTypes : JSON.parse(location.googleTypes || "[]");
          types.forEach((type) => {
            const typeScore = preferences.preferredTypes[type] || 0;
            score += typeScore * 2;
          });
          score = Math.min(score, 40);
        }
        if (location.google_rating) {
          score += location.google_rating / 5 * 30;
        }
        if (location.google_user_ratings_total) {
          const ratingCountScore = Math.min(
            Math.log10(location.google_user_ratings_total + 1) * 5,
            15
          );
          score += ratingCountScore;
        }
        const similarUserScore = await this.getSimilarUserScore(location, userStories);
        score += similarUserScore;
        return Math.round(score * 100) / 100;
      }
      /**
       * 獲取相似用戶推薦分數（協同過濾）
       * @param {object} location - Location 物件
       * @param {array} userStories - 當前用戶故事
       * @returns {Promise<number>} 相似用戶分數（0-15）
       */
      async getSimilarUserScore(location, userStories) {
        try {
          const otherUsersStories = await this.db.prepare(
            `SELECT DISTINCT user_id 
         FROM user_locations 
         WHERE location_id = ? AND status = 'visited'`
          ).bind(location.id).all();
          if (otherUsersStories.results.length === 0) {
            return 0;
          }
          let totalSimilarity = 0;
          let count = 0;
          for (const otherUser of otherUsersStories.results.slice(0, 10)) {
            const otherUserStories = await this.storyModule.getPersonTimeline(otherUser.user_id);
            const similarity = this.calculateUserSimilarity(userStories, otherUserStories);
            if (similarity > 0) {
              totalSimilarity += similarity;
              count++;
            }
          }
          if (count === 0) {
            return 0;
          }
          const avgSimilarity = totalSimilarity / count;
          return Math.min(avgSimilarity * 15, 15);
        } catch (error) {
          console.error("[RecommendationService] Error getting similar user score:", error);
          return 0;
        }
      }
      /**
       * 計算用戶相似度
       * @param {array} user1Stories - 用戶1的故事
       * @param {array} user2Stories - 用戶2的故事
       * @returns {number} 相似度（0-1）
       */
      calculateUserSimilarity(user1Stories, user2Stories) {
        if (user1Stories.length === 0 || user2Stories.length === 0) {
          return 0;
        }
        const user1Locations = new Set(
          user1Stories.map((s) => s.location_id).filter(Boolean)
        );
        const user2Locations = new Set(
          user2Stories.map((s) => s.location_id).filter(Boolean)
        );
        const intersection = new Set(
          [...user1Locations].filter((x) => user2Locations.has(x))
        );
        const union = /* @__PURE__ */ new Set([...user1Locations, ...user2Locations]);
        if (union.size === 0) {
          return 0;
        }
        return intersection.size / union.size;
      }
      /**
       * 生成推薦理由
       * @param {object} location - Location 物件
       * @param {number} score - 推薦分數
       * @param {object} preferences - 用戶偏好
       * @returns {string} 推薦理由
       */
      generateRecommendationReason(location, score, preferences) {
        const reasons = [];
        if (location.googleTypes) {
          const types = Array.isArray(location.googleTypes) ? location.googleTypes : JSON.parse(location.googleTypes || "[]");
          const matchedTypes = types.filter((type) => preferences.preferredTypes[type] > 0);
          if (matchedTypes.length > 0) {
            reasons.push(`\u7B26\u5408\u60A8\u559C\u6B61\u7684${matchedTypes[0]}\u985E\u578B`);
          }
        }
        if (location.google_rating && location.google_rating >= 4.5) {
          reasons.push("\u8A55\u5206\u5F88\u9AD8");
        }
        if (location.google_user_ratings_total && location.google_user_ratings_total > 100) {
          reasons.push("\u53D7\u5230\u591A\u4EBA\u63A8\u85A6");
        }
        return reasons.length > 0 ? reasons.join("\u3001") : "\u63A8\u85A6\u7D66\u60A8";
      }
      /**
       * 獲取熱門地點（用於新用戶或無故事用戶）
       * @param {number} limit - 數量
       * @returns {Promise<array>}
       */
      async getPopularLocations(limit = 10) {
        try {
          const result = await this.db.prepare(
            `SELECT l.*, 
                COUNT(ul.id) as visit_count,
                AVG(l.google_rating) as avg_rating
         FROM locations l
         LEFT JOIN user_locations ul ON l.id = ul.location_id AND ul.status = 'visited'
         WHERE l.google_rating IS NOT NULL
         GROUP BY l.id
         ORDER BY visit_count DESC, avg_rating DESC
         LIMIT ?`
          ).bind(limit).all();
          const { Location: Location2 } = await Promise.resolve().then(() => (init_Location(), Location_exports));
          return result.results.map((record) => {
            const location = Location2.fromDbRecord(record);
            return {
              ...location.toJSON(),
              recommendation_score: 50,
              // 預設分數
              recommendation_reason: "\u71B1\u9580\u5730\u9EDE"
            };
          });
        } catch (error) {
          console.error("[RecommendationService] Error getting popular locations:", error);
          throw error;
        }
      }
      /**
       * 基於地點相似度推薦
       * @param {string} locationId - 參考地點 ID
       * @param {number} limit - 推薦數量
       * @returns {Promise<array>}
       */
      async recommendSimilarLocations(locationId, limit = 5) {
        try {
          const referenceLocation = await this.locationModule.getLocationById(locationId);
          if (!referenceLocation) {
            return [];
          }
          const allLocations = await this.locationModule.getLocationsPaginated(100, 0);
          const candidateLocations = allLocations.locations.filter(
            (loc) => loc.id !== locationId
          );
          const scoredLocations = await Promise.all(
            candidateLocations.map(async (location) => {
              const similarity = this.calculateLocationSimilarity(referenceLocation, location);
              return { location, similarity };
            })
          );
          return scoredLocations.sort((a, b) => b.similarity - a.similarity).slice(0, limit).map((item) => ({
            ...item.location.toJSON(),
            recommendation_score: item.similarity * 100,
            recommendation_reason: `\u8207${referenceLocation.name}\u76F8\u4F3C`
          }));
        } catch (error) {
          console.error("[RecommendationService] Error recommending similar locations:", error);
          throw error;
        }
      }
      /**
       * 計算地點相似度
       * @param {object} location1 - 地點1
       * @param {object} location2 - 地點2
       * @returns {number} 相似度（0-1）
       */
      calculateLocationSimilarity(location1, location2) {
        let similarity = 0;
        let factors = 0;
        if (location1.googleTypes && location2.googleTypes) {
          const types1 = Array.isArray(location1.googleTypes) ? location1.googleTypes : JSON.parse(location1.googleTypes || "[]");
          const types2 = Array.isArray(location2.googleTypes) ? location2.googleTypes : JSON.parse(location2.googleTypes || "[]");
          const intersection = types1.filter((t) => types2.includes(t));
          const union = [.../* @__PURE__ */ new Set([...types1, ...types2])];
          if (union.length > 0) {
            similarity += intersection.length / union.length * 0.6;
            factors++;
          }
        }
        if (location1.google_rating && location2.google_rating) {
          const ratingDiff = Math.abs(location1.google_rating - location2.google_rating);
          similarity += (1 - ratingDiff / 5) * 0.4;
          factors++;
        }
        return factors > 0 ? similarity / factors : 0;
      }
    };
  }
});

// src/services/SearchService.js
var SearchService;
var init_SearchService = __esm({
  "src/services/SearchService.js"() {
    "use strict";
    init_Location();
    SearchService = class {
      constructor(db) {
        if (!db) {
          throw new Error("Database connection is required for SearchService");
        }
        this.db = db;
      }
      /**
       * 搜尋地點
       * @param {string} query - 搜尋關鍵字
       * @param {object} filters - 篩選條件
       * @param {object} sortOptions - 排序選項
       * @param {number} limit - 結果數量
       * @param {number} offset - 偏移量
       * @returns {Promise<object>} 搜尋結果
       */
      async searchLocations(query, filters = {}, sortOptions = {}, limit = 20, offset = 0) {
        try {
          let sql = `
        SELECT l.*,
               COUNT(DISTINCT ul_visited.id) as visited_count,
               COUNT(DISTINCT ul_want.id) as want_to_visit_count
        FROM locations l
        LEFT JOIN user_locations ul_visited ON l.id = ul_visited.location_id AND ul_visited.status = 'visited'
        LEFT JOIN user_locations ul_want ON l.id = ul_want.location_id AND ul_want.status = 'want_to_visit'
        WHERE 1=1
      `;
          const params = [];
          if (query && query.trim()) {
            const searchTerm = `%${query.trim()}%`;
            sql += ` AND (
          l.name LIKE ? OR
          l.address LIKE ? OR
          l.editorial_summary LIKE ?
        )`;
            params.push(searchTerm, searchTerm, searchTerm);
          }
          if (filters.types && filters.types.length > 0) {
            const typeConditions = filters.types.map(() => {
              return `l.google_types LIKE ?`;
            });
            sql += ` AND (${typeConditions.join(" OR ")})`;
            filters.types.forEach((type) => {
              params.push(`%"${type}"%`);
            });
          }
          if (filters.minRating !== void 0) {
            sql += ` AND l.google_rating >= ?`;
            params.push(filters.minRating);
          }
          if (filters.businessStatus) {
            sql += ` AND l.business_status = ?`;
            params.push(filters.businessStatus);
          }
          sql += ` GROUP BY l.id`;
          const sortBy = sortOptions.sortBy || "relevance";
          const sortOrder = sortOptions.sortOrder || "DESC";
          switch (sortBy) {
            case "rating":
              sql += ` ORDER BY l.google_rating ${sortOrder} NULLS LAST`;
              break;
            case "popularity":
              sql += ` ORDER BY visited_count ${sortOrder}, want_to_visit_count ${sortOrder}`;
              break;
            case "name":
              sql += ` ORDER BY l.name ${sortOrder}`;
              break;
            case "relevance":
            default:
              if (query && query.trim()) {
                sql += ` ORDER BY 
              CASE 
                WHEN l.name = ? THEN 1
                WHEN l.name LIKE ? THEN 2
                WHEN l.name LIKE ? THEN 3
                WHEN l.address LIKE ? THEN 4
                ELSE 5
              END,
              l.google_rating DESC NULLS LAST`;
                const exactMatch = query.trim();
                params.push(exactMatch, `${exactMatch}%`, `%${exactMatch}%`, `%${exactMatch}%`);
              } else {
                sql += ` ORDER BY l.google_rating DESC NULLS LAST, visited_count DESC`;
              }
              break;
          }
          sql += ` LIMIT ? OFFSET ?`;
          params.push(limit, offset);
          const result = await this.db.prepare(sql).bind(...params).all();
          const countSql = sql.replace(/SELECT.*FROM/, "SELECT COUNT(DISTINCT l.id) as total FROM").replace(/GROUP BY.*ORDER BY.*LIMIT.*OFFSET.*/, "");
          const countParams = params.slice(0, -2);
          const countResult = await this.db.prepare(countSql).bind(...countParams).first();
          const total = (countResult == null ? void 0 : countResult.total) || 0;
          const locations = result.results.map((record) => {
            const location = Location.fromDbRecord(record);
            location.visited_count = record.visited_count || 0;
            location.want_to_visit_count = record.want_to_visit_count || 0;
            return location;
          });
          return {
            locations: locations.map((loc) => loc.toJSON()),
            total,
            limit,
            offset,
            hasMore: offset + limit < total
          };
        } catch (error) {
          console.error("[SearchService] Error searching locations:", error);
          throw error;
        }
      }
      /**
       * 模糊搜尋地點名稱
       * @param {string} query - 搜尋關鍵字
       * @param {number} limit - 結果數量
       * @returns {Promise<array>} 地點陣列
       */
      async fuzzySearchLocationNames(query, limit = 10) {
        try {
          if (!query || !query.trim()) {
            return [];
          }
          const searchTerm = `%${query.trim()}%`;
          const result = await this.db.prepare(
            `SELECT id, name, address, google_types
         FROM locations
         WHERE name LIKE ? OR address LIKE ?
         ORDER BY 
           CASE 
             WHEN name = ? THEN 1
             WHEN name LIKE ? THEN 2
             ELSE 3
           END
         LIMIT ?`
          ).bind(
            searchTerm,
            searchTerm,
            query.trim(),
            `${query.trim()}%`,
            limit
          ).all();
          return result.results.map((record) => ({
            id: record.id,
            name: record.name,
            address: record.address,
            types: record.google_types ? JSON.parse(record.google_types) : []
          }));
        } catch (error) {
          console.error("[SearchService] Error fuzzy searching:", error);
          throw error;
        }
      }
      /**
       * 獲取可用的搜尋篩選選項
       * @returns {Promise<object>} 篩選選項
       */
      async getSearchFilters() {
        try {
          const typesResult = await this.db.prepare(
            `SELECT DISTINCT json_each.value as type
         FROM locations, json_each(google_types)
         WHERE google_types IS NOT NULL
         ORDER BY type`
          ).all();
          const types = typesResult.results.map((r) => r.type).filter(Boolean);
          const ratingResult = await this.db.prepare(
            `SELECT 
          MIN(google_rating) as min_rating,
          MAX(google_rating) as max_rating,
          AVG(google_rating) as avg_rating
         FROM locations
         WHERE google_rating IS NOT NULL`
          ).first();
          return {
            types,
            ratingRange: {
              min: (ratingResult == null ? void 0 : ratingResult.min_rating) || 0,
              max: (ratingResult == null ? void 0 : ratingResult.max_rating) || 5,
              avg: (ratingResult == null ? void 0 : ratingResult.avg_rating) || 0
            },
            businessStatuses: ["OPERATIONAL", "CLOSED_TEMPORARILY", "CLOSED_PERMANENTLY"]
          };
        } catch (error) {
          console.error("[SearchService] Error getting search filters:", error);
          return {
            types: [],
            ratingRange: { min: 0, max: 5, avg: 0 },
            businessStatuses: []
          };
        }
      }
      /**
       * 獲取熱門搜尋關鍵字
       * @param {number} limit - 數量
       * @returns {Promise<array>} 關鍵字陣列
       */
      async getPopularSearchTerms(limit = 10) {
        try {
          const popularTerms = [
            "\u9910\u5EF3",
            "\u5496\u5561\u5EF3",
            "\u666F\u9EDE",
            "\u4F4F\u5BBF",
            "\u6D77\u7058",
            "\u535A\u7269\u9928",
            "\u516C\u5712",
            "\u591C\u5E02",
            "\u5EDF\u5B87",
            "\u89C0\u5149"
          ];
          return popularTerms.slice(0, limit);
        } catch (error) {
          console.error("[SearchService] Error getting popular search terms:", error);
          return [];
        }
      }
    };
  }
});

// src/services/FavoritesService.js
var FavoritesService_exports = {};
__export(FavoritesService_exports, {
  FavoritesService: () => FavoritesService
});
var FavoritesService;
var init_FavoritesService = __esm({
  "src/services/FavoritesService.js"() {
    "use strict";
    init_Location();
    init_Person();
    FavoritesService = class {
      constructor(db) {
        if (!db) {
          throw new Error("Database connection is required for FavoritesService");
        }
        this.db = db;
      }
      /**
       * 添加收藏
       * @param {string} userId - 用戶 ID
       * @param {string} locationId - 地點 ID
       * @returns {Promise<boolean>} 是否成功
       */
      async addFavorite(userId, locationId) {
        try {
          const result = await this.db.prepare(
            `INSERT INTO location_favorites (user_id, location_id, created_at)
         VALUES (?, ?, datetime('now'))
         ON CONFLICT(user_id, location_id) DO NOTHING`
          ).bind(userId, locationId).run();
          return result.meta.changes > 0;
        } catch (error) {
          console.error("[FavoritesService] Error adding favorite:", error);
          throw error;
        }
      }
      /**
       * 移除收藏
       * @param {string} userId - 用戶 ID
       * @param {string} locationId - 地點 ID
       * @returns {Promise<boolean>} 是否成功
       */
      async removeFavorite(userId, locationId) {
        try {
          const result = await this.db.prepare(
            `DELETE FROM location_favorites 
         WHERE user_id = ? AND location_id = ?`
          ).bind(userId, locationId).run();
          return result.meta.changes > 0;
        } catch (error) {
          console.error("[FavoritesService] Error removing favorite:", error);
          throw error;
        }
      }
      /**
       * 切換收藏狀態
       * @param {string} userId - 用戶 ID
       * @param {string} locationId - 地點 ID
       * @returns {Promise<boolean>} 新的收藏狀態（true = 已收藏）
       */
      async toggleFavorite(userId, locationId) {
        try {
          const isFavorited = await this.isFavorited(userId, locationId);
          if (isFavorited) {
            await this.removeFavorite(userId, locationId);
            return false;
          } else {
            await this.addFavorite(userId, locationId);
            return true;
          }
        } catch (error) {
          console.error("[FavoritesService] Error toggling favorite:", error);
          throw error;
        }
      }
      /**
       * 檢查是否已收藏
       * @param {string} userId - 用戶 ID
       * @param {string} locationId - 地點 ID
       * @returns {Promise<boolean>}
       */
      async isFavorited(userId, locationId) {
        try {
          const result = await this.db.prepare(
            `SELECT 1 FROM location_favorites 
         WHERE user_id = ? AND location_id = ? 
         LIMIT 1`
          ).bind(userId, locationId).first();
          return !!result;
        } catch (error) {
          console.error("[FavoritesService] Error checking favorite:", error);
          throw error;
        }
      }
      /**
       * 批量檢查多個地點的收藏狀態
       * 優化 N+1 查詢問題
       * @param {string} userId - 用戶 ID
       * @param {Array<string>} locationIds - 地點 ID 陣列
       * @returns {Promise<object>} 以 locationId 為 key 的布林值對象
       */
      async getBatchFavoriteStatuses(userId, locationIds) {
        if (!userId || !locationIds || locationIds.length === 0) {
          return {};
        }
        try {
          const placeholders = locationIds.map(() => "?").join(",");
          const stmt = this.db.prepare(
            `SELECT location_id
         FROM location_favorites
         WHERE user_id = ? AND location_id IN (${placeholders})`
          );
          const { results } = await stmt.bind(userId, ...locationIds).all();
          const favoriteMap = {};
          if (results) {
            results.forEach((row) => {
              favoriteMap[row.location_id] = true;
            });
          }
          locationIds.forEach((id) => {
            if (!(id in favoriteMap)) {
              favoriteMap[id] = false;
            }
          });
          return favoriteMap;
        } catch (error) {
          console.error("[FavoritesService] Error getting batch favorite statuses:", error);
          throw error;
        }
      }
      /**
       * 獲取用戶的所有收藏
       * @param {string} userId - 用戶 ID
       * @param {number} limit - 數量限制
       * @param {number} offset - 偏移量
       * @returns {Promise<object>}
       */
      async getUserFavorites(userId, limit = 20, offset = 0) {
        try {
          const result = await this.db.prepare(
            `SELECT l.*, lf.created_at as favorited_at
         FROM location_favorites lf
         JOIN locations l ON lf.location_id = l.id
         WHERE lf.user_id = ?
         ORDER BY lf.created_at DESC
         LIMIT ? OFFSET ?`
          ).bind(userId, limit, offset).all();
          const totalResult = await this.db.prepare(
            `SELECT COUNT(*) as total 
         FROM location_favorites 
         WHERE user_id = ?`
          ).bind(userId).first();
          return {
            locations: result.results.map((record) => Location.fromDbRecord(record).toJSON()),
            total: (totalResult == null ? void 0 : totalResult.total) || 0,
            limit,
            offset,
            hasMore: offset + limit < ((totalResult == null ? void 0 : totalResult.total) || 0)
          };
        } catch (error) {
          console.error("[FavoritesService] Error getting user favorites:", error);
          throw error;
        }
      }
      /**
       * 添加評分
       * @param {string} userId - 用戶 ID
       * @param {string} locationId - 地點 ID
       * @param {number} rating - 評分（1-5）
       * @param {string} comment - 可選評論
       * @returns {Promise<boolean>}
       */
      async addRating(userId, locationId, rating, comment = null) {
        try {
          if (rating < 1 || rating > 5) {
            throw new Error("Rating must be between 1 and 5");
          }
          const result = await this.db.prepare(
            `INSERT INTO location_ratings (user_id, location_id, rating, comment, created_at, updated_at)
         VALUES (?, ?, ?, ?, datetime('now'), datetime('now'))
         ON CONFLICT(user_id, location_id) DO UPDATE SET
           rating = excluded.rating,
           comment = excluded.comment,
           updated_at = datetime('now')`
          ).bind(userId, locationId, rating, comment).run();
          return result.meta.changes > 0;
        } catch (error) {
          console.error("[FavoritesService] Error adding rating:", error);
          throw error;
        }
      }
      /**
       * 獲取地點的平均評分
       * @param {string} locationId - 地點 ID
       * @returns {Promise<object>}
       */
      async getLocationRating(locationId) {
        try {
          const result = await this.db.prepare(
            `SELECT 
          AVG(rating) as average_rating,
          COUNT(*) as rating_count,
          COUNT(CASE WHEN rating = 5 THEN 1 END) as five_star,
          COUNT(CASE WHEN rating = 4 THEN 1 END) as four_star,
          COUNT(CASE WHEN rating = 3 THEN 1 END) as three_star,
          COUNT(CASE WHEN rating = 2 THEN 1 END) as two_star,
          COUNT(CASE WHEN rating = 1 THEN 1 END) as one_star
         FROM location_ratings
         WHERE location_id = ?`
          ).bind(locationId).first();
          return {
            averageRating: (result == null ? void 0 : result.average_rating) ? parseFloat(result.average_rating.toFixed(2)) : null,
            ratingCount: (result == null ? void 0 : result.rating_count) || 0,
            distribution: {
              5: (result == null ? void 0 : result.five_star) || 0,
              4: (result == null ? void 0 : result.four_star) || 0,
              3: (result == null ? void 0 : result.three_star) || 0,
              2: (result == null ? void 0 : result.two_star) || 0,
              1: (result == null ? void 0 : result.one_star) || 0
            }
          };
        } catch (error) {
          console.error("[FavoritesService] Error getting location rating:", error);
          throw error;
        }
      }
      /**
       * 獲取用戶對地點的評分
       * @param {string} userId - 用戶 ID
       * @param {string} locationId - 地點 ID
       * @returns {Promise<object|null>}
       */
      async getUserRating(userId, locationId) {
        try {
          const result = await this.db.prepare(
            `SELECT rating, comment, created_at, updated_at
         FROM location_ratings
         WHERE user_id = ? AND location_id = ?`
          ).bind(userId, locationId).first();
          return result || null;
        } catch (error) {
          console.error("[FavoritesService] Error getting user rating:", error);
          throw error;
        }
      }
      /**
       * 添加評論
       * @param {string} userId - 用戶 ID
       * @param {string} locationId - 地點 ID
       * @param {string} content - 評論內容
       * @returns {Promise<string>} 評論 ID
       */
      async addComment(userId, locationId, content) {
        var _a;
        try {
          if (!content || !content.trim()) {
            throw new Error("Comment content is required");
          }
          const result = await this.db.prepare(
            `INSERT INTO location_comments (user_id, location_id, content, created_at, updated_at)
         VALUES (?, ?, ?, datetime('now'), datetime('now'))`
          ).bind(userId, locationId, content.trim()).run();
          return ((_a = result.meta.last_row_id) == null ? void 0 : _a.toString()) || null;
        } catch (error) {
          console.error("[FavoritesService] Error adding comment:", error);
          throw error;
        }
      }
      /**
       * 獲取地點的評論
       * @param {string} locationId - 地點 ID
       * @param {number} limit - 數量限制
       * @param {number} offset - 偏移量
       * @returns {Promise<object>}
       */
      async getLocationComments(locationId, limit = 20, offset = 0) {
        try {
          const result = await this.db.prepare(
            `SELECT lc.*, u.name as user_name, u.avatar_url as user_avatar_url
         FROM location_comments lc
         JOIN users u ON lc.user_id = u.id
         WHERE lc.location_id = ?
         ORDER BY lc.created_at DESC
         LIMIT ? OFFSET ?`
          ).bind(locationId, limit, offset).all();
          const totalResult = await this.db.prepare(
            `SELECT COUNT(*) as total 
         FROM location_comments 
         WHERE location_id = ?`
          ).bind(locationId).first();
          return {
            comments: result.results.map((record) => ({
              id: record.id,
              userId: record.user_id,
              locationId: record.location_id,
              content: record.content,
              userName: record.user_name,
              userAvatarUrl: record.user_avatar_url,
              createdAt: record.created_at,
              updatedAt: record.updated_at
            })),
            total: (totalResult == null ? void 0 : totalResult.total) || 0,
            limit,
            offset,
            hasMore: offset + limit < ((totalResult == null ? void 0 : totalResult.total) || 0)
          };
        } catch (error) {
          console.error("[FavoritesService] Error getting location comments:", error);
          throw error;
        }
      }
      /**
       * 獲取地點的收藏數量
       * @param {string} locationId - 地點 ID
       * @returns {Promise<number>}
       */
      async getFavoriteCount(locationId) {
        try {
          const result = await this.db.prepare(
            `SELECT COUNT(*) as count 
         FROM location_favorites 
         WHERE location_id = ?`
          ).bind(locationId).first();
          return (result == null ? void 0 : result.count) || 0;
        } catch (error) {
          console.error("[FavoritesService] Error getting favorite count:", error);
          throw error;
        }
      }
    };
  }
});

// src/services/SecurityService.js
var SecurityService;
var init_SecurityService = __esm({
  "src/services/SecurityService.js"() {
    "use strict";
    SecurityService = class {
      constructor() {
        this.nonce = this.generateNonce();
      }
      generateNonce() {
        const array = new Uint8Array(16);
        crypto.getRandomValues(array);
        return Array.from(array, (byte) => byte.toString(16).padStart(2, "0")).join("");
      }
      getNonce() {
        return this.nonce;
      }
      getCSPHeaders() {
        const nonce = this.getNonce();
        const csp = [
          "default-src 'self'",
          `script-src 'self' 'nonce-${nonce}' 'unsafe-inline' 'unsafe-eval' https://apis.google.com https://maps.googleapis.com https://accounts.google.com https://ajax.googleapis.com`,
          `style-src 'self' https://fonts.googleapis.com 'nonce-${nonce}' 'unsafe-inline'`,
          `style-src-attr 'self' 'nonce-${nonce}' 'unsafe-inline'`,
          "font-src 'self' data: https://fonts.gstatic.com",
          "img-src 'self' data: https: https://www.gstatic.com https://maps.googleapis.com https://maps.gstatic.com",
          "connect-src 'self' https://apis.google.com https://accounts.google.com https://maps.googleapis.com https://www.googleapis.com https://oauth2.googleapis.com https://generativelanguage.googleapis.com https://api.openai.com",
          "frame-src 'self' https://accounts.google.com",
          "base-uri 'self'",
          "form-action 'self'",
          "frame-ancestors 'none'",
          "object-src 'none'"
        ].join("; ");
        return {
          "Content-Security-Policy": csp,
          "X-Content-Type-Options": "nosniff",
          "X-Frame-Options": "DENY",
          "X-XSS-Protection": "1; mode=block",
          "Referrer-Policy": "strict-origin-when-cross-origin",
          "Permissions-Policy": "geolocation=(), microphone=(), camera=()"
        };
      }
    };
  }
});

// src/services/RateLimitService.js
var RateLimitService;
var init_RateLimitService = __esm({
  "src/services/RateLimitService.js"() {
    "use strict";
    RateLimitService = class {
      constructor(env) {
        this.env = env;
        this.db = env.DB;
        this.defaultLimits = {
          // Google Places API 限制
          "google_places": {
            requestsPerMinute: 10,
            requestsPerHour: 100,
            requestsPerDay: 1e3
          },
          // 一般 API 限制
          "api": {
            requestsPerMinute: 60,
            requestsPerHour: 1e3,
            requestsPerDay: 1e4
          },
          // 圖片代理限制
          "image_proxy": {
            requestsPerMinute: 30,
            requestsPerHour: 500,
            requestsPerDay: 5e3
          },
          // 管理員 API 限制
          "admin": {
            requestsPerMinute: 100,
            requestsPerHour: 2e3,
            requestsPerDay: 2e4
          }
        };
      }
      /**
       * 檢查請求是否超過限制
       * @param {string} clientId 客戶端識別碼 (IP 或用戶ID)
       * @param {string} endpoint 端點類型
       * @returns {Promise<object>} 檢查結果
       */
      async checkRateLimit(clientId, endpoint = "api") {
        try {
          const limits = this.defaultLimits[endpoint] || this.defaultLimits["api"];
          const now = /* @__PURE__ */ new Date();
          const minuteCheck = await this.checkWindow(clientId, endpoint, "minute", limits.requestsPerMinute, now);
          if (!minuteCheck.allowed) {
            return {
              allowed: false,
              limit: "minute",
              remaining: minuteCheck.remaining,
              resetTime: minuteCheck.resetTime,
              retryAfter: minuteCheck.retryAfter
            };
          }
          const hourCheck = await this.checkWindow(clientId, endpoint, "hour", limits.requestsPerHour, now);
          if (!hourCheck.allowed) {
            return {
              allowed: false,
              limit: "hour",
              remaining: hourCheck.remaining,
              resetTime: hourCheck.resetTime,
              retryAfter: hourCheck.retryAfter
            };
          }
          const dayCheck = await this.checkWindow(clientId, endpoint, "day", limits.requestsPerDay, now);
          if (!dayCheck.allowed) {
            return {
              allowed: false,
              limit: "day",
              remaining: dayCheck.remaining,
              resetTime: dayCheck.resetTime,
              retryAfter: dayCheck.retryAfter
            };
          }
          await this.recordRequest(clientId, endpoint, now);
          return {
            allowed: true,
            remaining: Math.min(minuteCheck.remaining, hourCheck.remaining, dayCheck.remaining),
            resetTime: Math.min(minuteCheck.resetTime, hourCheck.resetTime, dayCheck.resetTime)
          };
        } catch (error) {
          console.error("[RateLimitService] Error checking rate limit:", error);
          return {
            allowed: true,
            error: error.message
          };
        }
      }
      /**
       * 檢查特定時間窗口的限制
       */
      async checkWindow(clientId, endpoint, window, limit, now) {
        let startTime, windowName;
        switch (window) {
          case "minute":
            startTime = new Date(now.getTime() - 60 * 1e3);
            windowName = "minute";
            break;
          case "hour":
            startTime = new Date(now.getTime() - 60 * 60 * 1e3);
            windowName = "hour";
            break;
          case "day":
            startTime = new Date(now.getTime() - 24 * 60 * 60 * 1e3);
            windowName = "day";
            break;
          default:
            throw new Error(`Invalid window: ${window}`);
        }
        const stmt = this.db.prepare(`
            SELECT COUNT(*) as count
            FROM rate_limit_logs
            WHERE client_id = ? 
            AND endpoint = ? 
            AND window_type = ?
            AND request_time > ?
        `);
        const result = await stmt.bind(clientId, endpoint, windowName, startTime.toISOString()).first();
        const count = result.count || 0;
        const remaining = Math.max(0, limit - count);
        const allowed = count < limit;
        let resetTime;
        switch (window) {
          case "minute":
            resetTime = new Date(now.getTime() + 60 * 1e3);
            break;
          case "hour":
            resetTime = new Date(now.getTime() + 60 * 60 * 1e3);
            break;
          case "day":
            resetTime = new Date(now.getTime() + 24 * 60 * 60 * 1e3);
            break;
        }
        return {
          allowed,
          remaining,
          resetTime: resetTime.toISOString(),
          retryAfter: Math.ceil((resetTime.getTime() - now.getTime()) / 1e3)
        };
      }
      /**
       * 記錄請求
       */
      async recordRequest(clientId, endpoint, timestamp) {
        try {
          const stmt = this.db.prepare(`
                INSERT INTO rate_limit_logs 
                (client_id, endpoint, window_type, request_time, created_at)
                VALUES (?, ?, ?, ?, ?)
            `);
          await stmt.bind(clientId, endpoint, "minute", timestamp.toISOString(), timestamp.toISOString()).run();
          await stmt.bind(clientId, endpoint, "hour", timestamp.toISOString(), timestamp.toISOString()).run();
          await stmt.bind(clientId, endpoint, "day", timestamp.toISOString(), timestamp.toISOString()).run();
        } catch (error) {
          console.error("[RateLimitService] Failed to record request:", error);
        }
      }
      /**
       * 獲取客戶端使用統計
       * @param {string} clientId 客戶端識別碼
       * @param {string} endpoint 端點類型
       * @returns {Promise<object>} 使用統計
       */
      async getClientStats(clientId, endpoint = "api") {
        try {
          const now = /* @__PURE__ */ new Date();
          const minuteAgo = new Date(now.getTime() - 60 * 1e3);
          const hourAgo = new Date(now.getTime() - 60 * 60 * 1e3);
          const dayAgo = new Date(now.getTime() - 24 * 60 * 60 * 1e3);
          const stmt = this.db.prepare(`
                SELECT 
                    window_type,
                    COUNT(*) as count
                FROM rate_limit_logs
                WHERE client_id = ? 
                AND endpoint = ?
                AND request_time > ?
                GROUP BY window_type
            `);
          const minuteResult = await stmt.bind(clientId, endpoint, minuteAgo.toISOString()).all();
          const hourResult = await stmt.bind(clientId, endpoint, hourAgo.toISOString()).all();
          const dayResult = await stmt.bind(clientId, endpoint, dayAgo.toISOString()).all();
          const limits = this.defaultLimits[endpoint] || this.defaultLimits["api"];
          return {
            clientId,
            endpoint,
            usage: {
              minute: minuteResult.length > 0 ? minuteResult[0].count : 0,
              hour: hourResult.length > 0 ? hourResult[0].count : 0,
              day: dayResult.length > 0 ? dayResult[0].count : 0
            },
            limits,
            remaining: {
              minute: Math.max(0, limits.requestsPerMinute - (minuteResult.length > 0 ? minuteResult[0].count : 0)),
              hour: Math.max(0, limits.requestsPerHour - (hourResult.length > 0 ? hourResult[0].count : 0)),
              day: Math.max(0, limits.requestsPerDay - (dayResult.length > 0 ? dayResult[0].count : 0))
            }
          };
        } catch (error) {
          console.error("[RateLimitService] Failed to get client stats:", error);
          return {
            clientId,
            endpoint,
            error: error.message
          };
        }
      }
      /**
       * 清理過期的速率限制日誌
       * @param {number} daysToKeep 保留天數
       * @returns {Promise<object>} 清理結果
       */
      async cleanupOldLogs(daysToKeep = 7) {
        try {
          const cutoffDate = /* @__PURE__ */ new Date();
          cutoffDate.setDate(cutoffDate.getDate() - daysToKeep);
          const stmt = this.db.prepare(`
                DELETE FROM rate_limit_logs
                WHERE request_time < ?
            `);
          const result = await stmt.bind(cutoffDate.toISOString()).run();
          return {
            success: true,
            deletedCount: result.changes || 0
          };
        } catch (error) {
          console.error("[RateLimitService] Failed to cleanup old logs:", error);
          return {
            success: false,
            error: error.message
          };
        }
      }
      /**
       * 獲取速率限制統計
       * @returns {Promise<object>} 統計資訊
       */
      async getRateLimitStats() {
        try {
          const now = /* @__PURE__ */ new Date();
          const dayAgo = new Date(now.getTime() - 24 * 60 * 60 * 1e3);
          const stmt = this.db.prepare(`
                SELECT 
                    endpoint,
                    COUNT(*) as total_requests,
                    COUNT(DISTINCT client_id) as unique_clients
                FROM rate_limit_logs
                WHERE request_time > ?
                GROUP BY endpoint
            `);
          const { results } = await stmt.bind(dayAgo.toISOString()).all();
          return {
            period: "24h",
            stats: results,
            totalRequests: results.reduce((sum, row) => sum + row.total_requests, 0),
            uniqueClients: results.reduce((sum, row) => sum + row.unique_clients, 0)
          };
        } catch (error) {
          console.error("[RateLimitService] Failed to get stats:", error);
          return {
            error: error.message
          };
        }
      }
      /**
       * 檢查 Google Places API 使用量
       * @returns {Promise<object>} API 使用量
       */
      async checkGooglePlacesUsage() {
        try {
          const now = /* @__PURE__ */ new Date();
          const dayAgo = new Date(now.getTime() - 24 * 60 * 60 * 1e3);
          const stmt = this.db.prepare(`
                SELECT COUNT(*) as count
                FROM rate_limit_logs
                WHERE endpoint = 'google_places'
                AND request_time > ?
            `);
          const result = await stmt.bind(dayAgo.toISOString()).first();
          const dailyUsage = result.count || 0;
          const limit = this.defaultLimits.google_places.requestsPerDay;
          const remaining = Math.max(0, limit - dailyUsage);
          const usagePercentage = dailyUsage / limit * 100;
          return {
            dailyUsage,
            limit,
            remaining,
            usagePercentage: Math.round(usagePercentage * 100) / 100,
            status: usagePercentage > 90 ? "warning" : usagePercentage > 75 ? "caution" : "normal"
          };
        } catch (error) {
          console.error("[RateLimitService] Failed to check Google Places usage:", error);
          return {
            error: error.message
          };
        }
      }
    };
  }
});

// src/services/agents/BaseAgent.js
var BaseAgent;
var init_BaseAgent = __esm({
  "src/services/agents/BaseAgent.js"() {
    "use strict";
    BaseAgent = class {
      /**
       * 創建 AI Agent 實例
       * @param {Object} aiService - AIService 實例
       * @param {Object} config - Agent 配置
       */
      constructor(aiService, config = {}) {
        if (!aiService) {
          throw new Error("AIService is required for BaseAgent");
        }
        this.aiService = aiService;
        this.config = {
          mode: config.mode || null,
          // 'traveler' 或 'resident'
          context: config.context || {},
          options: config.options || {},
          ...config
        };
        this.state = {
          initialized: false,
          lastUsed: null,
          usageCount: 0
        };
      }
      /**
       * 初始化 Agent
       * @returns {Promise<void>}
       */
      async initialize() {
        if (this.state.initialized) {
          return;
        }
        await this._onInitialize();
        this.state.initialized = true;
        this.state.lastUsed = /* @__PURE__ */ new Date();
      }
      /**
       * 子類可以覆蓋此方法進行初始化
       * @protected
       */
      async _onInitialize() {
      }
      /**
       * 執行 Agent 的主要功能
       * @param {Object} input - 輸入數據
       * @returns {Promise<Object>} 執行結果
       */
      async execute(input) {
        if (!this.state.initialized) {
          await this.initialize();
        }
        this.state.usageCount++;
        this.state.lastUsed = /* @__PURE__ */ new Date();
        try {
          return await this._execute(input);
        } catch (error) {
          console.error(`[${this.constructor.name}] Execution error:`, error);
          throw error;
        }
      }
      /**
       * 子類必須實現此方法
       * @param {Object} input - 輸入數據
       * @returns {Promise<Object>} 執行結果
       * @protected
       * @abstract
       */
      async _execute(input) {
        throw new Error("_execute method must be implemented by subclass");
      }
      /**
       * 獲取 Agent 狀態
       * @returns {Object} Agent 狀態
       */
      getState() {
        return {
          ...this.state,
          config: this.config,
          agentType: this.constructor.name
        };
      }
      /**
       * 重置 Agent 狀態
       */
      reset() {
        this.state.usageCount = 0;
        this.state.lastUsed = null;
      }
      /**
       * 更新配置
       * @param {Object} newConfig - 新配置
       */
      updateConfig(newConfig) {
        this.config = {
          ...this.config,
          ...newConfig
        };
      }
    };
  }
});

// src/services/agents/TravelPlannerAgent.js
var TravelPlannerAgent;
var init_TravelPlannerAgent = __esm({
  "src/services/agents/TravelPlannerAgent.js"() {
    "use strict";
    init_BaseAgent();
    TravelPlannerAgent = class extends BaseAgent {
      /**
       * 創建行程規劃 Agent
       * @param {Object} aiService - AIService 實例
       * @param {Object} config - Agent 配置
       */
      constructor(aiService, config = {}) {
        super(aiService, {
          mode: "traveler",
          // 預設使用旅客模式（Gemini）
          ...config
        });
      }
      /**
       * 執行行程規劃
       * @param {Object} input - 輸入數據
       *   - userId: 用戶 ID
       *   - sessionId: 會話 ID
       *   - query: 用戶查詢
       *   - context: 上下文信息（可選）
       * @returns {Promise<Object>} 規劃結果
       */
      async _execute(input) {
        const { userId, sessionId, query, context = {} } = input;
        if (!query) {
          throw new Error("Query is required for TravelPlannerAgent");
        }
        const result = await this.aiService.handleQuery(
          userId,
          sessionId,
          query,
          this.config.mode || "traveler",
          context.ctx
        );
        return {
          success: true,
          message: result.message || result.response,
          suggestions: this._extractSuggestions(result),
          metadata: {
            agentType: "TravelPlannerAgent",
            mode: this.config.mode,
            timestamp: (/* @__PURE__ */ new Date()).toISOString()
          }
        };
      }
      /**
       * 從 AI 回應中提取建議
       * @param {Object} result - AI 回應結果
       * @returns {Array} 建議列表
       * @private
       */
      _extractSuggestions(result) {
        const suggestions = [];
        const message = result.message || result.response || "";
        const locationPatterns = [
          /推薦.*?([\u4e00-\u9fa5]+)/g,
          /可以去.*?([\u4e00-\u9fa5]+)/g,
          /([\u4e00-\u9fa5]+).*?不錯/g
        ];
        locationPatterns.forEach((pattern) => {
          const matches = message.matchAll(pattern);
          for (const match2 of matches) {
            if (match2[1] && match2[1].length > 1) {
              suggestions.push({
                type: "location",
                value: match2[1],
                confidence: 0.7
              });
            }
          }
        });
        return suggestions;
      }
      /**
       * 優化行程
       * @param {Object} itinerary - 行程數據
       * @param {Object} preferences - 用戶偏好
       * @returns {Promise<Object>} 優化後的行程
       */
      async optimizeItinerary(itinerary, preferences = {}) {
        const query = `\u8ACB\u512A\u5316\u4EE5\u4E0B\u884C\u7A0B\uFF1A${JSON.stringify(itinerary)}\u3002\u504F\u597D\uFF1A${JSON.stringify(preferences)}`;
        return await this.execute({
          userId: preferences.userId,
          sessionId: preferences.sessionId || `session_${Date.now()}`,
          query,
          context: preferences
        });
      }
    };
  }
});

// src/services/agents/KnowledgeExtractorAgent.js
var KnowledgeExtractorAgent;
var init_KnowledgeExtractorAgent = __esm({
  "src/services/agents/KnowledgeExtractorAgent.js"() {
    "use strict";
    init_BaseAgent();
    KnowledgeExtractorAgent = class extends BaseAgent {
      /**
       * 創建知識提取 Agent
       * @param {Object} aiService - AIService 實例
       * @param {Object} config - Agent 配置
       */
      constructor(aiService, config = {}) {
        super(aiService, {
          mode: "resident",
          // 預設使用居民模式（GPT）
          ...config
        });
      }
      /**
       * 執行知識提取
       * @param {Object} input - 輸入數據
       *   - userId: 用戶 ID
       *   - sessionId: 會話 ID
       *   - conversation: 對話內容
       *   - context: 上下文信息（可選）
       * @returns {Promise<Object>} 提取的知識
       */
      async _execute(input) {
        const { userId, sessionId, conversation, context = {} } = input;
        if (!conversation) {
          throw new Error("Conversation is required for KnowledgeExtractorAgent");
        }
        const knowledgeService2 = this.aiService.knowledgeService;
        if (!knowledgeService2) {
          throw new Error("AIKnowledgeService is not available");
        }
        const extractedKnowledge = await knowledgeService2.processInteraction(
          userId,
          sessionId,
          conversation
        );
        return {
          success: true,
          knowledge: extractedKnowledge,
          metadata: {
            agentType: "KnowledgeExtractorAgent",
            mode: this.config.mode,
            timestamp: (/* @__PURE__ */ new Date()).toISOString(),
            userId,
            sessionId
          }
        };
      }
      /**
       * 驗證知識質量
       * @param {Object} knowledge - 知識對象
       * @returns {Promise<Object>} 驗證結果
       */
      async validateKnowledge(knowledge) {
        const query = `\u8ACB\u9A57\u8B49\u4EE5\u4E0B\u77E5\u8B58\u7684\u6E96\u78BA\u6027\u548C\u50F9\u503C\uFF1A${JSON.stringify(knowledge)}`;
        const result = await this.aiService.handleQuery(
          knowledge.userId,
          `validation_${Date.now()}`,
          query,
          "resident"
        );
        return {
          isValid: true,
          // 簡化實現，實際應該根據 AI 回應判斷
          confidence: 0.8,
          feedback: result.message || result.response,
          metadata: {
            validatedAt: (/* @__PURE__ */ new Date()).toISOString()
          }
        };
      }
      /**
       * 批量提取知識
       * @param {Array} conversations - 對話列表
       * @returns {Promise<Array>} 提取的知識列表
       */
      async extractBatch(conversations) {
        const results = [];
        for (const conversation of conversations) {
          try {
            const result = await this.execute({
              userId: conversation.userId,
              sessionId: conversation.sessionId,
              conversation: conversation.content,
              context: conversation.context
            });
            results.push(result);
          } catch (error) {
            console.error(`[KnowledgeExtractorAgent] Error extracting from conversation:`, error);
            results.push({
              success: false,
              error: error.message
            });
          }
        }
        return results;
      }
    };
  }
});

// src/services/agents/RecommendationAgent.js
var RecommendationAgent;
var init_RecommendationAgent = __esm({
  "src/services/agents/RecommendationAgent.js"() {
    "use strict";
    init_BaseAgent();
    RecommendationAgent = class extends BaseAgent {
      /**
       * 創建推薦 Agent
       * @param {Object} aiService - AIService 實例
       * @param {Object} recommendationService - RecommendationService 實例（可選）
       * @param {Object} config - Agent 配置
       */
      constructor(aiService, recommendationService = null, config = {}) {
        super(aiService, config);
        this.recommendationService = recommendationService;
      }
      /**
       * 執行推薦
       * @param {Object} input - 輸入數據
       *   - userId: 用戶 ID
       *   - sessionId: 會話 ID
       *   - query: 用戶查詢或偏好
       *   - context: 上下文信息（可選）
       * @returns {Promise<Object>} 推薦結果
       */
      async _execute(input) {
        const { userId, sessionId, query, context = {} } = input;
        if (this.recommendationService) {
          try {
            const recommendations = await this.recommendationService.getRecommendations(
              userId,
              query,
              context
            );
            return {
              success: true,
              recommendations,
              source: "RecommendationService",
              metadata: {
                agentType: "RecommendationAgent",
                timestamp: (/* @__PURE__ */ new Date()).toISOString()
              }
            };
          } catch (error) {
            console.warn("[RecommendationAgent] RecommendationService failed, falling back to AI:", error);
          }
        }
        const result = await this.aiService.handleQuery(
          userId,
          sessionId,
          `\u8ACB\u6839\u64DA\u4EE5\u4E0B\u9700\u6C42\u63A8\u85A6\uFF1A${query}`,
          this.config.mode || null,
          context.ctx
        );
        return {
          success: true,
          recommendations: this._parseRecommendations(result),
          source: "AIService",
          metadata: {
            agentType: "RecommendationAgent",
            mode: this.config.mode,
            timestamp: (/* @__PURE__ */ new Date()).toISOString()
          }
        };
      }
      /**
       * 從 AI 回應中解析推薦
       * @param {Object} result - AI 回應結果
       * @returns {Array} 推薦列表
       * @private
       */
      _parseRecommendations(result) {
        const message = result.message || result.response || "";
        const recommendations = [];
        const lines = message.split("\n");
        lines.forEach((line) => {
          const trimmed = line.trim();
          if (trimmed.length > 0 && (trimmed.includes("\u63A8\u85A6") || trimmed.includes("\u5EFA\u8B70"))) {
            recommendations.push({
              type: "general",
              content: trimmed,
              confidence: 0.7
            });
          }
        });
        return recommendations;
      }
      /**
       * 個性化推薦
       * @param {string} userId - 用戶 ID
       * @param {Object} preferences - 用戶偏好
       * @returns {Promise<Object>} 個性化推薦
       */
      async getPersonalizedRecommendations(userId, preferences = {}) {
        const query = `\u6839\u64DA\u6211\u7684\u504F\u597D\u63A8\u85A6\uFF1A${JSON.stringify(preferences)}`;
        return await this.execute({
          userId,
          sessionId: `personalized_${Date.now()}`,
          query,
          context: { preferences }
        });
      }
    };
  }
});

// src/services/agents/ConversationAgent.js
var ConversationAgent;
var init_ConversationAgent = __esm({
  "src/services/agents/ConversationAgent.js"() {
    "use strict";
    init_BaseAgent();
    ConversationAgent = class extends BaseAgent {
      /**
       * 創建對話 Agent
       * @param {Object} aiService - AIService 實例
       * @param {Object} config - Agent 配置
       */
      constructor(aiService, config = {}) {
        super(aiService, {
          mode: null,
          // 自動判斷模式
          ...config
        });
      }
      /**
       * 執行對話
       * @param {Object} input - 輸入數據
       *   - userId: 用戶 ID
       *   - sessionId: 會話 ID
       *   - message: 用戶訊息
       *   - context: 上下文信息（可選）
       * @returns {Promise<Object>} 對話結果
       */
      async _execute(input) {
        const { userId, sessionId, message, context = {} } = input;
        if (!message) {
          throw new Error("Message is required for ConversationAgent");
        }
        const result = await this.aiService.handleQuery(
          userId,
          sessionId,
          message,
          this.config.mode || null,
          // 自動判斷模式
          context.ctx
        );
        return {
          success: true,
          response: result.message || result.response,
          sessionId: result.sessionId || sessionId,
          metadata: {
            agentType: "ConversationAgent",
            mode: result.mode || this.config.mode,
            timestamp: (/* @__PURE__ */ new Date()).toISOString(),
            relationshipDepth: result.relationshipDepth || null
          }
        };
      }
      /**
       * 繼續對話
       * @param {string} sessionId - 會話 ID
       * @param {string} message - 用戶訊息
       * @param {string} userId - 用戶 ID（可選）
       * @returns {Promise<Object>} 對話結果
       */
      async continueConversation(sessionId, message, userId = null) {
        return await this.execute({
          userId,
          sessionId,
          message,
          context: {}
        });
      }
      /**
       * 獲取對話歷史
       * @param {string} sessionId - 會話 ID
       * @param {number} limit - 限制數量
       * @returns {Promise<Array>} 對話歷史
       */
      async getConversationHistory(sessionId, limit = 50) {
        try {
          const result = await this.aiService.db.prepare(
            `SELECT message_type, message_content, created_at
         FROM ai_conversations
         WHERE session_id = ?
         ORDER BY created_at DESC
         LIMIT ?`
          ).bind(sessionId, limit).all();
          return result.results || [];
        } catch (error) {
          console.error("[ConversationAgent] Error getting conversation history:", error);
          return [];
        }
      }
    };
  }
});

// src/services/AIAgentFactory.js
var AIAgentFactory;
var init_AIAgentFactory = __esm({
  "src/services/AIAgentFactory.js"() {
    "use strict";
    init_TravelPlannerAgent();
    init_KnowledgeExtractorAgent();
    init_RecommendationAgent();
    init_ConversationAgent();
    AIAgentFactory = class {
      /**
       * 創建 AI Agent 工廠實例
       * @param {Object} serviceFactory - ServiceFactory 實例
       * @param {Object} options - 可選配置
       */
      constructor(serviceFactory, options = {}) {
        if (!serviceFactory) {
          throw new Error("ServiceFactory is required for AIAgentFactory");
        }
        this.serviceFactory = serviceFactory;
        this.options = {
          enableLogging: options.enableLogging ?? true,
          enableCaching: options.enableCaching ?? true,
          ...options
        };
        this._agents = /* @__PURE__ */ new Map();
        this._aiService = null;
        this._recommendationService = null;
      }
      /**
       * 獲取 AIService（延遲初始化）
       * @returns {Object} AIService 實例
       * @private
       */
      _getAIService() {
        if (!this._aiService) {
          this._aiService = this.serviceFactory.getService("aiService");
        }
        return this._aiService;
      }
      /**
       * 獲取 RecommendationService（延遲初始化）
       * @returns {Object} RecommendationService 實例
       * @private
       */
      _getRecommendationService() {
        if (!this._recommendationService) {
          try {
            this._recommendationService = this.serviceFactory.getService("recommendationService");
          } catch (error) {
            if (this.options.enableLogging) {
              console.warn("[AIAgentFactory] RecommendationService not available:", error.message);
            }
            return null;
          }
        }
        return this._recommendationService;
      }
      /**
       * 創建 AI Agent
       * @param {string} agentType - Agent 類型
       * @param {Object} config - Agent 配置
       * @returns {Object} AI Agent 實例
       */
      createAgent(agentType, config = {}) {
        const cacheKey = `${agentType}_${JSON.stringify(config)}`;
        if (this.options.enableCaching && this._agents.has(cacheKey)) {
          if (this.options.enableLogging) {
            console.log(`[AIAgentFactory] Returning cached agent: ${agentType}`);
          }
          return this._agents.get(cacheKey);
        }
        if (this.options.enableLogging) {
          console.log(`[AIAgentFactory] Creating agent: ${agentType}`);
        }
        const aiService = this._getAIService();
        let agent;
        try {
          switch (agentType) {
            case "travel_planner":
            case "travelPlanner":
              agent = new TravelPlannerAgent(aiService, config);
              break;
            case "knowledge_extractor":
            case "knowledgeExtractor":
              agent = new KnowledgeExtractorAgent(aiService, config);
              break;
            case "recommendation":
            case "recommendationEngine":
              const recommendationService = this._getRecommendationService();
              agent = new RecommendationAgent(aiService, recommendationService, config);
              break;
            case "conversation":
            case "conversationAgent":
              agent = new ConversationAgent(aiService, config);
              break;
            default:
              throw new Error(`Unknown agent type: ${agentType}`);
          }
          agent.initialize().catch((error) => {
            console.error(`[AIAgentFactory] Error initializing agent ${agentType}:`, error);
          });
          if (this.options.enableCaching) {
            this._agents.set(cacheKey, agent);
          }
          return agent;
        } catch (error) {
          console.error(`[AIAgentFactory] Error creating agent ${agentType}:`, error);
          throw error;
        }
      }
      /**
       * 獲取或創建 Agent（單例模式）
       * @param {string} agentType - Agent 類型
       * @param {Object} config - Agent 配置
       * @returns {Object} AI Agent 實例
       */
      getAgent(agentType, config = {}) {
        return this.createAgent(agentType, config);
      }
      /**
       * 創建多個 Agent 並編排執行
       * @param {Array} agentConfigs - Agent 配置列表
       * @returns {Array} Agent 實例列表
       */
      createAgentChain(agentConfigs) {
        return agentConfigs.map((config) => {
          const { type, ...agentConfig } = config;
          return this.createAgent(type, agentConfig);
        });
      }
      /**
       * 清除 Agent 緩存
       * @param {string} agentType - Agent 類型（可選，如果不提供則清除所有）
       */
      clearCache(agentType = null) {
        if (agentType) {
          const keysToDelete = [];
          for (const [key, agent] of this._agents.entries()) {
            if (key.startsWith(agentType)) {
              keysToDelete.push(key);
            }
          }
          keysToDelete.forEach((key) => this._agents.delete(key));
        } else {
          this._agents.clear();
        }
      }
      /**
       * 獲取所有 Agent 的狀態
       * @returns {Array} Agent 狀態列表
       */
      getAllAgentStates() {
        const states = [];
        for (const [key, agent] of this._agents.entries()) {
          states.push({
            cacheKey: key,
            state: agent.getState()
          });
        }
        return states;
      }
      /**
       * 獲取 Agent 統計信息
       * @returns {Object} 統計信息
       */
      getStats() {
        const stats = {
          totalAgents: this._agents.size,
          agentsByType: {},
          totalUsage: 0,
          lastUsed: null
        };
        for (const [key, agent] of this._agents.entries()) {
          const agentState = agent.getState();
          const type = agentState.agentType;
          if (!stats.agentsByType[type]) {
            stats.agentsByType[type] = {
              count: 0,
              totalUsage: 0
            };
          }
          stats.agentsByType[type].count++;
          stats.agentsByType[type].totalUsage += agentState.usageCount;
          stats.totalUsage += agentState.usageCount;
          if (!stats.lastUsed || agentState.lastUsed > stats.lastUsed) {
            stats.lastUsed = agentState.lastUsed;
          }
        }
        return stats;
      }
    };
  }
});

// src/services/EcosystemService.js
var EcosystemService;
var init_EcosystemService = __esm({
  "src/services/EcosystemService.js"() {
    "use strict";
    EcosystemService = class {
      /**
       * 創建生態平衡服務實例
       * @param {Object} db - 數據庫連接
       * @param {Object} options - 可選配置
       */
      constructor(db, options = {}) {
        if (!db) {
          throw new Error("Database connection is required for EcosystemService");
        }
        this.db = db;
        this.options = {
          enableLogging: options.enableLogging ?? true,
          enableCaching: options.enableCaching ?? true,
          cacheTTL: options.cacheTTL ?? 36e5,
          // 1 小時
          ...options
        };
        this._cache = /* @__PURE__ */ new Map();
        this._cacheTimestamps = /* @__PURE__ */ new Map();
      }
      /**
       * 追蹤用戶福祉（User Wellbeing）
       * 符合「有更好的生活」理念
       * 
       * @param {string} userId - 用戶 ID
       * @param {Object} metrics - 福祉指標
       * @returns {Promise<Object>} 追蹤結果
       */
      async trackUserWellbeing(userId, metrics = {}) {
        try {
          const wellbeingData = {
            userId,
            satisfaction: metrics.satisfaction || null,
            engagement: metrics.engagement || null,
            experience: metrics.experience || null,
            timestamp: (/* @__PURE__ */ new Date()).toISOString(),
            metadata: metrics.metadata || {}
          };
          try {
            await this.db.prepare(
              `INSERT INTO user_wellbeing_tracking 
           (user_id, satisfaction_score, engagement_score, experience_score, tracked_at, metadata)
           VALUES (?, ?, ?, ?, ?, ?)`
            ).bind(
              userId,
              wellbeingData.satisfaction,
              wellbeingData.engagement,
              wellbeingData.experience,
              wellbeingData.timestamp,
              JSON.stringify(wellbeingData.metadata)
            ).run();
          } catch (error) {
            if (this.options.enableLogging) {
              console.warn("[EcosystemService] Wellbeing tracking table may not exist:", error.message);
            }
          }
          return {
            success: true,
            data: wellbeingData
          };
        } catch (error) {
          console.error("[EcosystemService] Error tracking user wellbeing:", error);
          throw error;
        }
      }
      /**
       * 獲取用戶福祉指標
       * @param {string} userId - 用戶 ID
       * @param {Object} options - 查詢選項
       * @returns {Promise<Object>} 福祉指標
       */
      async getUserWellbeing(userId, options = {}) {
        const cacheKey = `wellbeing_${userId}_${JSON.stringify(options)}`;
        if (this.options.enableCaching && this._cache.has(cacheKey)) {
          const cached = this._cache.get(cacheKey);
          const timestamp = this._cacheTimestamps.get(cacheKey);
          const age = Date.now() - timestamp;
          if (age < this.options.cacheTTL) {
            return cached;
          }
        }
        try {
          const limit = options.limit || 30;
          const days = options.days || 30;
          const result = await this.db.prepare(
            `SELECT 
           AVG(satisfaction_score) as avg_satisfaction,
           AVG(engagement_score) as avg_engagement,
           AVG(experience_score) as avg_experience,
           COUNT(*) as tracking_count
         FROM user_wellbeing_tracking
         WHERE user_id = ? 
           AND tracked_at >= datetime('now', '-' || ? || ' days')
         LIMIT ?`
          ).bind(userId, days, limit).first();
          const wellbeing = {
            userId,
            averageSatisfaction: (result == null ? void 0 : result.avg_satisfaction) || null,
            averageEngagement: (result == null ? void 0 : result.avg_engagement) || null,
            averageExperience: (result == null ? void 0 : result.avg_experience) || null,
            trackingCount: (result == null ? void 0 : result.tracking_count) || 0,
            period: `${days} days`,
            timestamp: (/* @__PURE__ */ new Date()).toISOString()
          };
          if (this.options.enableCaching) {
            this._cache.set(cacheKey, wellbeing);
            this._cacheTimestamps.set(cacheKey, Date.now());
          }
          return wellbeing;
        } catch (error) {
          if (this.options.enableLogging) {
            console.warn("[EcosystemService] Wellbeing table may not exist:", error.message);
          }
          return {
            userId,
            averageSatisfaction: null,
            averageEngagement: null,
            averageExperience: null,
            trackingCount: 0,
            period: `${options.days || 30} days`,
            timestamp: (/* @__PURE__ */ new Date()).toISOString(),
            note: "Data not available"
          };
        }
      }
      /**
       * 追蹤資源使用（Resource Usage）
       * 符合「世界是球、更好更平衡」理念
       * 
       * @param {Object} usage - 資源使用數據
       * @returns {Promise<Object>} 追蹤結果
       */
      async trackResourceUsage(usage = {}) {
        try {
          const resourceData = {
            apiCalls: usage.apiCalls || 0,
            aiCalls: usage.aiCalls || 0,
            storage: usage.storage || 0,
            bandwidth: usage.bandwidth || 0,
            cost: usage.cost || 0,
            timestamp: (/* @__PURE__ */ new Date()).toISOString(),
            metadata: usage.metadata || {}
          };
          try {
            await this.db.prepare(
              `INSERT INTO resource_usage_tracking 
           (api_calls, ai_calls, storage_mb, bandwidth_mb, cost_usd, tracked_at, metadata)
           VALUES (?, ?, ?, ?, ?, ?, ?)`
            ).bind(
              resourceData.apiCalls,
              resourceData.aiCalls,
              resourceData.storage,
              resourceData.bandwidth,
              resourceData.cost,
              resourceData.timestamp,
              JSON.stringify(resourceData.metadata)
            ).run();
          } catch (error) {
            if (this.options.enableLogging) {
              console.warn("[EcosystemService] Resource usage table may not exist:", error.message);
            }
          }
          return {
            success: true,
            data: resourceData
          };
        } catch (error) {
          console.error("[EcosystemService] Error tracking resource usage:", error);
          throw error;
        }
      }
      /**
       * 獲取資源使用統計
       * @param {Object} options - 查詢選項
       * @returns {Promise<Object>} 資源使用統計
       */
      async getResourceUsage(options = {}) {
        const cacheKey = `resource_${JSON.stringify(options)}`;
        if (this.options.enableCaching && this._cache.has(cacheKey)) {
          const cached = this._cache.get(cacheKey);
          const timestamp = this._cacheTimestamps.get(cacheKey);
          const age = Date.now() - timestamp;
          if (age < this.options.cacheTTL) {
            return cached;
          }
        }
        try {
          const days = options.days || 7;
          const result = await this.db.prepare(
            `SELECT 
           SUM(api_calls) as total_api_calls,
           SUM(ai_calls) as total_ai_calls,
           AVG(storage_mb) as avg_storage,
           SUM(bandwidth_mb) as total_bandwidth,
           SUM(cost_usd) as total_cost
         FROM resource_usage_tracking
         WHERE tracked_at >= datetime('now', '-' || ? || ' days')`
          ).bind(days).first();
          const usage = {
            period: `${days} days`,
            totalApiCalls: (result == null ? void 0 : result.total_api_calls) || 0,
            totalAiCalls: (result == null ? void 0 : result.total_ai_calls) || 0,
            averageStorage: (result == null ? void 0 : result.avg_storage) || 0,
            totalBandwidth: (result == null ? void 0 : result.total_bandwidth) || 0,
            totalCost: (result == null ? void 0 : result.total_cost) || 0,
            timestamp: (/* @__PURE__ */ new Date()).toISOString()
          };
          if (this.options.enableCaching) {
            this._cache.set(cacheKey, usage);
            this._cacheTimestamps.set(cacheKey, Date.now());
          }
          return usage;
        } catch (error) {
          if (this.options.enableLogging) {
            console.warn("[EcosystemService] Resource usage table may not exist:", error.message);
          }
          return {
            period: `${options.days || 7} days`,
            totalApiCalls: 0,
            totalAiCalls: 0,
            averageStorage: 0,
            totalBandwidth: 0,
            totalCost: 0,
            timestamp: (/* @__PURE__ */ new Date()).toISOString(),
            note: "Data not available"
          };
        }
      }
      /**
       * 追蹤社區健康（Community Health）
       * 符合「更好更平衡」理念
       * 
       * @param {Object} metrics - 社區指標
       * @returns {Promise<Object>} 追蹤結果
       */
      async trackCommunityHealth(metrics = {}) {
        try {
          const healthData = {
            activeUsers: metrics.activeUsers || 0,
            interactions: metrics.interactions || 0,
            contentDiversity: metrics.contentDiversity || 0,
            engagementRate: metrics.engagementRate || 0,
            timestamp: (/* @__PURE__ */ new Date()).toISOString(),
            metadata: metrics.metadata || {}
          };
          try {
            await this.db.prepare(
              `INSERT INTO community_health_tracking 
           (active_users, interactions, content_diversity, engagement_rate, tracked_at, metadata)
           VALUES (?, ?, ?, ?, ?, ?)`
            ).bind(
              healthData.activeUsers,
              healthData.interactions,
              healthData.contentDiversity,
              healthData.engagementRate,
              healthData.timestamp,
              JSON.stringify(healthData.metadata)
            ).run();
          } catch (error) {
            if (this.options.enableLogging) {
              console.warn("[EcosystemService] Community health table may not exist:", error.message);
            }
          }
          return {
            success: true,
            data: healthData
          };
        } catch (error) {
          console.error("[EcosystemService] Error tracking community health:", error);
          throw error;
        }
      }
      /**
       * 獲取社區健康指標
       * @param {Object} options - 查詢選項
       * @returns {Promise<Object>} 社區健康指標
       */
      async getCommunityHealth(options = {}) {
        const cacheKey = `community_${JSON.stringify(options)}`;
        if (this.options.enableCaching && this._cache.has(cacheKey)) {
          const cached = this._cache.get(cacheKey);
          const timestamp = this._cacheTimestamps.get(cacheKey);
          const age = Date.now() - timestamp;
          if (age < this.options.cacheTTL) {
            return cached;
          }
        }
        try {
          const days = options.days || 7;
          const result = await this.db.prepare(
            `SELECT 
           AVG(active_users) as avg_active_users,
           SUM(interactions) as total_interactions,
           AVG(content_diversity) as avg_diversity,
           AVG(engagement_rate) as avg_engagement_rate
         FROM community_health_tracking
         WHERE tracked_at >= datetime('now', '-' || ? || ' days')`
          ).bind(days).first();
          const health = {
            period: `${days} days`,
            averageActiveUsers: (result == null ? void 0 : result.avg_active_users) || 0,
            totalInteractions: (result == null ? void 0 : result.total_interactions) || 0,
            averageDiversity: (result == null ? void 0 : result.avg_diversity) || 0,
            averageEngagementRate: (result == null ? void 0 : result.avg_engagement_rate) || 0,
            healthScore: this._calculateHealthScore(result),
            timestamp: (/* @__PURE__ */ new Date()).toISOString()
          };
          if (this.options.enableCaching) {
            this._cache.set(cacheKey, health);
            this._cacheTimestamps.set(cacheKey, Date.now());
          }
          return health;
        } catch (error) {
          if (this.options.enableLogging) {
            console.warn("[EcosystemService] Community health table may not exist:", error.message);
          }
          return {
            period: `${options.days || 7} days`,
            averageActiveUsers: 0,
            totalInteractions: 0,
            averageDiversity: 0,
            averageEngagementRate: 0,
            healthScore: 0,
            timestamp: (/* @__PURE__ */ new Date()).toISOString(),
            note: "Data not available"
          };
        }
      }
      /**
       * 計算健康分數
       * @param {Object} metrics - 指標數據
       * @returns {number} 健康分數 (0-100)
       * @private
       */
      _calculateHealthScore(metrics) {
        if (!metrics)
          return 0;
        const diversity = (metrics.avg_diversity || 0) * 30;
        const engagement = (metrics.avg_engagement_rate || 0) * 40;
        const activity = Math.min((metrics.avg_active_users || 0) / 100, 1) * 30;
        return Math.min(Math.round(diversity + engagement + activity), 100);
      }
      /**
       * 獲取完整的生態系統報告
       * @param {Object} options - 查詢選項
       * @returns {Promise<Object>} 生態系統報告
       */
      async getEcosystemReport(options = {}) {
        const [wellbeing, resourceUsage, communityHealth] = await Promise.all([
          this.getUserWellbeing(null, options),
          // 整體用戶福祉
          this.getResourceUsage(options),
          this.getCommunityHealth(options)
        ]);
        return {
          period: options.days || 7,
          wellbeing,
          resourceUsage,
          communityHealth,
          overallScore: this._calculateOverallScore(wellbeing, resourceUsage, communityHealth),
          timestamp: (/* @__PURE__ */ new Date()).toISOString(),
          recommendations: this._generateRecommendations(wellbeing, resourceUsage, communityHealth)
        };
      }
      /**
       * 計算總體分數
       * @param {Object} wellbeing - 福祉數據
       * @param {Object} resourceUsage - 資源使用數據
       * @param {Object} communityHealth - 社區健康數據
       * @returns {number} 總體分數 (0-100)
       * @private
       */
      _calculateOverallScore(wellbeing, resourceUsage, communityHealth) {
        const wellbeingScore = (wellbeing.averageSatisfaction || 0) * 0.4;
        const resourceScore = resourceUsage.totalCost > 0 ? Math.max(0, 100 - resourceUsage.totalCost / 100) * 0.3 : 50 * 0.3;
        const healthScore = (communityHealth.healthScore || 0) * 0.3;
        return Math.min(Math.round(wellbeingScore + resourceScore + healthScore), 100);
      }
      /**
       * 生成改進建議
       * @param {Object} wellbeing - 福祉數據
       * @param {Object} resourceUsage - 資源使用數據
       * @param {Object} communityHealth - 社區健康數據
       * @returns {Array} 建議列表
       * @private
       */
      _generateRecommendations(wellbeing, resourceUsage, communityHealth) {
        const recommendations = [];
        if (wellbeing.averageSatisfaction && wellbeing.averageSatisfaction < 70) {
          recommendations.push({
            type: "wellbeing",
            priority: "high",
            message: "\u7528\u6236\u6EFF\u610F\u5EA6\u8F03\u4F4E\uFF0C\u5EFA\u8B70\u6539\u9032\u7528\u6236\u9AD4\u9A57",
            action: "review_user_feedback"
          });
        }
        if (resourceUsage.totalCost > 100) {
          recommendations.push({
            type: "resource",
            priority: "medium",
            message: "\u8CC7\u6E90\u4F7F\u7528\u6210\u672C\u8F03\u9AD8\uFF0C\u5EFA\u8B70\u512A\u5316 API \u8ABF\u7528",
            action: "optimize_api_usage"
          });
        }
        if (communityHealth.healthScore && communityHealth.healthScore < 60) {
          recommendations.push({
            type: "community",
            priority: "high",
            message: "\u793E\u5340\u5065\u5EB7\u5EA6\u8F03\u4F4E\uFF0C\u5EFA\u8B70\u589E\u52A0\u7528\u6236\u4E92\u52D5",
            action: "improve_engagement"
          });
        }
        return recommendations;
      }
      /**
       * 清除緩存
       */
      clearCache() {
        this._cache.clear();
        this._cacheTimestamps.clear();
      }
    };
  }
});

// src/services/ServiceFactory.js
var ServiceFactory;
var init_ServiceFactory = __esm({
  "src/services/ServiceFactory.js"() {
    "use strict";
    init_AuthService();
    init_UserService();
    init_SessionService();
    init_GoogleAuthService();
    init_LocationService();
    init_LocationInvitationService();
    init_AIService();
    init_BusinessVerificationService();
    init_ItineraryService();
    init_RecommendationService();
    init_SearchService();
    init_FavoritesService();
    init_SecurityService();
    init_RateLimitService();
    init_AIAgentFactory();
    init_EcosystemService();
    ServiceFactory = class {
      /**
       * 創建服務工廠實例
       * @param {Object} env - 環境變數對象
       * @param {Object} options - 可選配置
       */
      constructor(env, options = {}) {
        if (!env || !env.DB) {
          throw new Error("Environment with DB connection is required for ServiceFactory");
        }
        this.env = env;
        this.options = {
          enableLogging: options.enableLogging ?? true,
          enableCaching: options.enableCaching ?? true,
          ...options
        };
        this._services = /* @__PURE__ */ new Map();
      }
      /**
       * 獲取或創建服務實例（單例模式）
       * @param {string} serviceName - 服務名稱
       * @returns {Object} 服務實例
       */
      getService(serviceName) {
        if (this._services.has(serviceName)) {
          return this._services.get(serviceName);
        }
        const service = this._createService(serviceName);
        this._services.set(serviceName, service);
        return service;
      }
      /**
       * 創建服務實例
       * @param {string} serviceName - 服務名稱
       * @returns {Object} 服務實例
       * @private
       */
      _createService(serviceName) {
        const { env, options } = this;
        if (options.enableLogging) {
          console.log(`[ServiceFactory] Creating service: ${serviceName}`);
        }
        try {
          switch (serviceName) {
            case "userService":
              return new UserService(env.DB);
            case "sessionService":
              return new SessionService(env.DB);
            case "googleAuthService":
              return new GoogleAuthService(env);
            case "locationService":
              if (!env.GOOGLE_MAPS_API_KEY) {
                throw new Error("GOOGLE_MAPS_API_KEY is required for LocationService");
              }
              return new LocationService(env.DB, env.GOOGLE_MAPS_API_KEY);
            case "locationInvitationService":
              return new LocationInvitationService(env.DB);
            case "businessVerificationService":
              return new BusinessVerificationService(env.DB);
            case "aiService":
              if (!env.OPENAI_API_KEY) {
                throw new Error("OPENAI_API_KEY is required for AIService");
              }
              const locationService = this.getService("locationService");
              return new AIService(
                env.DB,
                env.OPENAI_API_KEY,
                env.GEMINI_API_KEY,
                locationService,
                env.GOOGLE_MAPS_API_KEY
              );
            case "authService":
              return new AuthService(
                this.getService("userService"),
                this.getService("sessionService"),
                this.getService("googleAuthService")
              );
            case "itineraryService":
              return new ItineraryService(
                env.DB,
                this.getService("locationService"),
                this.getService("aiService")
              );
            case "recommendationService":
              return new RecommendationService(env.DB);
            case "searchService":
              return new SearchService(env.DB);
            case "favoritesService":
              return new FavoritesService(env.DB);
            case "securityService":
              return new SecurityService(env.DB);
            case "rateLimitService":
              return new RateLimitService(env.DB);
            case "aiAgentFactory":
              return new AIAgentFactory(this, options);
            case "ecosystemService":
              return new EcosystemService(env.DB, options);
            default:
              throw new Error(`Unknown service: ${serviceName}`);
          }
        } catch (error) {
          console.error(`[ServiceFactory] Error creating service ${serviceName}:`, error);
          throw error;
        }
      }
      /**
       * 初始化核心服務（用於快速啟動）
       * @returns {Object} 核心服務對象
       */
      initializeCoreServices() {
        return {
          userService: this.getService("userService"),
          sessionService: this.getService("sessionService"),
          googleAuthService: this.getService("googleAuthService"),
          locationService: this.getService("locationService"),
          locationInvitationService: this.getService("locationInvitationService"),
          businessVerificationService: this.getService("businessVerificationService"),
          authService: this.getService("authService")
        };
      }
      /**
       * 初始化所有服務（用於完整功能）
       * @returns {Object} 所有服務對象
       */
      initializeAllServices() {
        const coreServices = this.initializeCoreServices();
        return {
          ...coreServices,
          aiService: this.getService("aiService"),
          itineraryService: this.getService("itineraryService"),
          recommendationService: this.getService("recommendationService"),
          searchService: this.getService("searchService"),
          favoritesService: this.getService("favoritesService"),
          securityService: this.getService("securityService"),
          rateLimitService: this.getService("rateLimitService"),
          aiAgentFactory: this.getService("aiAgentFactory"),
          ecosystemService: this.getService("ecosystemService")
        };
      }
      /**
       * 清除服務緩存（用於測試或重新初始化）
       */
      clearCache() {
        this._services.clear();
        if (this.options.enableLogging) {
          console.log("[ServiceFactory] Service cache cleared");
        }
      }
      /**
       * 獲取服務狀態（用於調試）
       * @returns {Object} 服務狀態信息
       */
      getServiceStatus() {
        return {
          initializedServices: Array.from(this._services.keys()),
          totalServices: this._services.size,
          environment: {
            hasDB: !!this.env.DB,
            hasGoogleMapsKey: !!this.env.GOOGLE_MAPS_API_KEY,
            hasOpenAIKey: !!this.env.OPENAI_API_KEY,
            hasGeminiKey: !!this.env.GEMINI_API_KEY
          }
        };
      }
    };
  }
});

// src/pages/TripPlanner.js
var TripPlanner_exports = {};
__export(TripPlanner_exports, {
  renderSharedTripPage: () => renderSharedTripPage,
  renderTripPlannerPage: () => renderTripPlannerPage
});
async function renderTripPlannerPage(request, env, session, user, nonce, cssContent) {
  if (!user) {
    return Response.redirect(new URL(request.url).origin + "/login", 302);
  }
  const url = new URL(request.url);
  const content = `
    <div class="bg-white w-full h-full flex flex-col overflow-hidden">
        <h1 class="text-2xl font-bold mb-4 text-gray-800 flex-shrink-0 hidden">\u884C\u7A0B\u898F\u5283</h1>

        <!-- Header Controls -->
        <div class="p-4 flex-shrink-0 bg-white border-b border-gray-200 z-10 flex items-center justify-between">
            <div class="flex items-center gap-4">
                <button id="add-day-btn" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">
                    + \u65B0\u589E\u4E00\u5929
                </button>
                <div class="flex gap-2" id="day-tabs">
                    <!-- \u5929\u6578\u6A19\u7C64\u6703\u52D5\u614B\u751F\u6210 -->
                </div>
            </div>
            <div class="text-sm text-gray-600">
                \u5DF2\u9078 <span id="selected-count">0</span> \u500B\u5730\u9EDE
            </div>
        </div>

        <!-- Main Content Area -->
        <div class="flex flex-col md:flex-row flex-grow min-h-0 relative overflow-hidden trip-planner-main-area">
            <!-- Map Container -->
            <div id="map-container" class="w-full md:w-3/4 relative trip-planner-map-container">
                <div id="map" class="trip-planner-map"></div>
                <div id="map-message-area" class="absolute bottom-4 left-4 text-sm text-gray-500 bg-white bg-opacity-90 px-2 py-1 rounded shadow-sm z-20">
                    \u9EDE\u64CA\u5730\u5716\u4E0A\u7684\u5716\u793A\u4EE5\u9078\u64C7\u5730\u6A19\u52A0\u5165\u884C\u7A0B
                </div>
            </div>

            <!-- Trip Panel (\u53F3\u5074/\u4E0B\u65B9) -->
            <div id="trip-panel" class="w-full md:w-1/4 h-full bg-white border-l border-gray-200 flex flex-col transform transition-all duration-300 ease-in-out">
                <div class="p-4 border-b border-gray-100 flex-shrink-0">
                    <h2 class="text-lg font-semibold text-gray-800">\u884C\u7A0B\u898F\u5283</h2>
                    <p class="text-sm text-gray-500 mt-1">\u62D6\u62FD\u8ABF\u6574\u9806\u5E8F\u548C\u6642\u9593</p>
                </div>

                    <!-- Current Day Selector -->
                    <div class="px-4 py-2 border-b border-gray-100 flex-shrink-0">
                        <label for="current-day-date" class="text-sm font-medium text-gray-700">\u9078\u64C7\u65E5\u671F\uFF1A</label>
                        <input type="date" id="current-day-date" name="current-day-date" class="mt-1 w-full border border-gray-300 rounded px-2 py-1 text-sm">
                    </div>

                <!-- Trip Items List (\u53EF\u62D6\u62FD) -->
                <div id="trip-items-list" class="flex-grow overflow-y-auto p-4 space-y-3">
                    <div id="empty-state" class="text-center text-gray-400 py-8">
                        <p>\u5C1A\u672A\u9078\u64C7\u4EFB\u4F55\u5730\u9EDE</p>
                        <p class="text-sm mt-2">\u9EDE\u64CA\u5730\u5716\u4E0A\u7684\u5716\u793A\u958B\u59CB\u898F\u5283</p>
                    </div>
                    <!-- \u884C\u7A0B\u9805\u76EE\u6703\u52D5\u614B\u63D2\u5165\u9019\u88E1 -->
                </div>

                    <!-- Action Buttons -->
                    <div class="flex-shrink-0 border-t border-gray-100 bg-white p-4 space-y-2">
                        <button id="load-trip-btn" class="w-full bg-purple-500 hover:bg-purple-600 text-white font-bold py-2 px-4 rounded transition-colors">
                            \u8F09\u5165\u884C\u7A0B
                        </button>
                        <button id="save-trip-btn" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded disabled:opacity-50 transition-colors" disabled>
                            \u5132\u5B58\u884C\u7A0B
                        </button>
                        <button id="share-trip-btn" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded disabled:opacity-50 transition-colors" disabled>
                            \u5206\u4EAB\u884C\u7A0B
                        </button>
                    </div>
            </div>
        </div>
    </div>

    <style nonce="${nonce}">
        /* Map Container Styles */
        .trip-planner-main-area {
            height: calc(100vh - 128px - 60px);
        }
        
        #map-container {
            height: 100%;
            min-height: 400px;
        }
        
        .trip-planner-map {
            width: 100%;
            height: 100%;
            min-height: 400px;
            background-color: #e5e7eb;
            position: relative;
        }
        
        /* Loading indicator for map */
        .trip-planner-map::before {
            content: '\u8F09\u5165\u5730\u5716\u4E2D...';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #6b7280;
            font-size: 14px;
            z-index: 1;
        }

        /* Trip Item Styles */
        .trip-item {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            padding: 12px;
            cursor: move;
            transition: all 0.2s;
            position: relative;
        }

        .trip-item:hover {
            border-color: #3b82f6;
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.2);
        }

        .trip-item.dragging {
            opacity: 0.5;
            border-color: #3b82f6;
        }

        .trip-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .trip-item-name {
            font-weight: 600;
            color: #1f2937;
            flex: 1;
        }

        .trip-item-time {
            font-size: 0.875rem;
            color: #6b7280;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .trip-item-actions {
            display: flex;
            gap: 4px;
        }

        .trip-item-btn {
            padding: 4px 8px;
            border: none;
            background: #f3f4f6;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.75rem;
        }

        .trip-item-btn:hover {
            background: #e5e7eb;
        }

        .trip-item-btn.delete {
            color: #ef4444;
        }

        .time-input {
            width: 80px;
            padding: 4px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-size: 0.875rem;
        }

        /* Day Tab Styles */
        .day-tab {
            padding: 6px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            background: white;
            cursor: pointer;
            font-size: 0.875rem;
            transition: all 0.2s;
        }

        .day-tab:hover {
            background: #f3f4f6;
        }

        .day-tab.active {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }

        /* Drag and Drop Indicators */
        .drag-over {
            border-top: 3px solid #3b82f6;
        }

        /* Location Detail Panel */
        .location-detail-panel {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 1000;
            display: none;
            pointer-events: none;
        }

        .location-detail-panel.visible {
            display: block;
            pointer-events: all;
        }

        .detail-panel-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
        }

        .detail-panel-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 12px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }

        .detail-panel-close {
            position: absolute;
            top: 12px;
            right: 12px;
            z-index: 10;
            background: white;
            border: none;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            transition: all 0.2s;
        }

        .detail-panel-close:hover {
            background: #f3f4f6;
            transform: scale(1.1);
        }

        .detail-panel-image {
            width: 100%;
            height: 200px;
            overflow: hidden;
            position: relative;
        }

        .detail-panel-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .detail-panel-info {
            padding: 20px;
        }

        .detail-panel-title {
            font-size: 24px;
            font-weight: bold;
            color: #1f2937;
            margin-bottom: 12px;
        }

        .detail-panel-meta {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 16px;
        }

        .meta-item {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #6b7280;
            font-size: 14px;
        }

        .meta-item svg {
            flex-shrink: 0;
        }

        .meta-item a {
            color: #3b82f6;
            text-decoration: none;
        }

        .meta-item a:hover {
            text-decoration: underline;
        }

        .detail-panel-description,
        .detail-panel-booking {
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid #e5e7eb;
        }

        .detail-panel-description h3,
        .detail-panel-booking h3 {
            font-size: 16px;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 8px;
        }

        .detail-panel-description p {
            color: #4b5563;
            line-height: 1.6;
        }

        /* Clickable location name */
        .clickable-location-name {
            cursor: pointer;
        }

        /* Clipboard fallback textarea */
        .clipboard-fallback-textarea {
            position: fixed;
            left: -9999px;
            top: 0;
        }

        /* Loading State */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            pointer-events: all;
        }

        .loading-overlay.hidden {
            display: none;
        }

        .loading-content {
            background: white;
            padding: 24px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .loading-spinner {
            border: 3px solid #f3f4f6;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 12px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Trip List Modal */
        .trip-list-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1500;
            pointer-events: all;
        }

        .trip-list-modal.visible {
            display: flex;
        }

        .trip-list-content {
            background: white;
            border-radius: 12px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }

        .trip-list-header {
            padding: 20px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .trip-list-title {
            font-size: 18px;
            font-weight: 600;
            color: #1f2937;
        }

        .trip-list-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #6b7280;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
        }

        .trip-list-close:hover {
            background: #f3f4f6;
        }

        .trip-list-body {
            padding: 16px;
        }

        .trip-list-item {
            padding: 12px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .trip-list-item:hover {
            border-color: #3b82f6;
            background: #f0f9ff;
        }

        .trip-list-item-title {
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 4px;
        }

        .trip-list-item-meta {
            font-size: 12px;
            color: #6b7280;
        }

        /* Mobile adjustments */
        @media (max-width: 768px) {
            #trip-panel {
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                height: 50vh;
                transform: translateY(100%);
                z-index: 50;
                border-left: none;
                border-top: 2px solid #e5e7eb;
            }

            #trip-panel.show {
                transform: translateY(0);
            }

            #map-container {
                width: 100% !important;
            }

            .detail-panel-content {
                width: 95%;
                max-height: 90vh;
            }
        }
    </style>

    <script nonce="${nonce}">
        // \u5168\u5C40\u932F\u8AA4\u8655\u7406\uFF1A\u975C\u9ED8\u8655\u7406 Google Maps Directions API \u932F\u8AA4
        (function() {
            // \u8655\u7406\u672A\u6355\u7372\u7684 Promise \u932F\u8AA4\uFF08\u5305\u62EC Directions API \u932F\u8AA4\uFF09
            window.addEventListener('unhandledrejection', (event) => {
                const errorSource = event.reason?.stack || event.reason?.message || String(event.reason || '');
                const errorString = errorSource.toLowerCase();
                
                // \u6AA2\u67E5\u662F\u5426\u662F Directions API \u76F8\u95DC\u932F\u8AA4
                if (errorString.includes('directions') || 
                    errorString.includes('request_denied') ||
                    errorString.includes('mapsrequesterror') ||
                    (errorString.includes('route') && errorString.includes('denied'))) {
                    event.preventDefault(); // \u963B\u6B62\u932F\u8AA4\u986F\u793A\u5728\u63A7\u5236\u53F0
                    return; // \u975C\u9ED8\u5FFD\u7565
                }
            });
            
            // \u8655\u7406\u672A\u6355\u7372\u7684\u540C\u6B65\u932F\u8AA4
            window.addEventListener('error', (event) => {
                const errorSource = (event.filename || event.message || '').toLowerCase();
                const errorMessage = (event.message || '').toLowerCase();
                
                // \u6AA2\u67E5\u662F\u5426\u662F Directions API \u76F8\u95DC\u932F\u8AA4
                if (errorSource.includes('directions') || 
                    errorMessage.includes('directions') ||
                    errorSource.includes('request_denied') ||
                    errorMessage.includes('request_denied') ||
                    errorSource.includes('mapsrequesterror') ||
                    errorMessage.includes('mapsrequesterror')) {
                    event.preventDefault(); // \u963B\u6B62\u932F\u8AA4\u986F\u793A\u5728\u63A7\u5236\u53F0
                    return; // \u975C\u9ED8\u5FFD\u7565
                }
            });
        })();
        
        // TripPlanner \u985E\u5225 - \u7269\u4EF6\u5C0E\u5411\u67B6\u69CB
        class TripPlanner {
            constructor() {
                this.mapsApiKey = null;
                this.map = null;
                this.selectedPlaces = []; // Array of { placeId, placeData, dayIndex, time, order, bookingStatus, bookingUrl, bookingPhone, bookingNotes, itemId }
                this.currentDayIndex = 0;
                this.days = [new Date()]; // Array of Date objects
                this.markers = []; // Map markers
                this.draggedElement = null;
                this.dragOverElement = null;
                this.currentTripId = null; // \u7576\u524D\u884C\u7A0B ID\uFF08\u7528\u65BC\u66F4\u65B0\uFF09
                this.shareToken = null; // \u5206\u4EAB\u4EE4\u724C
                this.directionsService = null; // \u8DEF\u7DDA\u670D\u52D9
                this.directionsRenderer = null; // \u8DEF\u7DDA\u6E32\u67D3\u5668
                this.routePolylines = []; // \u8DEF\u7DDA\u591A\u908A\u5F62
                this.directionsApiDenied = false; // Directions API \u662F\u5426\u88AB\u62D2\u7D55
            }

            // \u521D\u59CB\u5316\u5730\u5716
            async initMap() {
                try {
                    const configResponse = await fetch('/api/maps/config');
                    if (!configResponse.ok) {
                        throw new Error('Failed to fetch Maps config');
                    }
                    const config = await configResponse.json();
                    this.mapsApiKey = config.apiKey;
                    if (!this.mapsApiKey) {
                        throw new Error('Maps API Key not provided');
                    }

                    // \u6AA2\u67E5\u662F\u5426\u5DF2\u7D93\u8F09\u5165
                    if (typeof google !== 'undefined' && google.maps && google.maps.Map) {
                        console.log('Google Maps API already loaded');
                        this.initializeMap();
                        return;
                    }

                    const script = document.createElement('script');
                    script.src = 'https://maps.googleapis.com/maps/api/js?key=' + this.mapsApiKey + '&libraries=places&loading=async';
                    script.async = true;
                    script.defer = true;

                    // \u4F7F\u7528\u8F2A\u8A62\u6AA2\u67E5 API \u662F\u5426\u5DF2\u8F09\u5165
                    script.onload = () => {
                        console.log('Google Maps API script loaded');
                        // \u8F2A\u8A62\u6AA2\u67E5\u76F4\u5230 API \u5B8C\u5168\u8F09\u5165
                        const checkApiReady = () => {
                            if (typeof google !== 'undefined' && google.maps && google.maps.Map) {
                                console.log('Google Maps API is ready');
                                this.initializeMap();
                            } else {
                                // \u5982\u679C 5 \u79D2\u5F8C\u9084\u6C92\u8F09\u5165\uFF0C\u986F\u793A\u932F\u8AA4
                                setTimeout(() => {
                                    if (typeof google === 'undefined' || !google.maps || !google.maps.Map) {
                                        console.error('Google Maps API failed to initialize');
                                        this.showMessage('\u932F\u8AA4\uFF1AGoogle Maps API \u8F09\u5165\u8D85\u6642', 'error');
                                    }
                                }, 5000);
                                // \u7E7C\u7E8C\u6AA2\u67E5
                                setTimeout(checkApiReady, 100);
                            }
                        };
                        // \u958B\u59CB\u6AA2\u67E5\uFF08\u7D66\u4E00\u9EDE\u6642\u9593\u8B93 API \u521D\u59CB\u5316\uFF09
                        setTimeout(checkApiReady, 200);
                    };

                    script.onerror = () => {
                        console.error('Failed to load Google Maps API');
                        this.showMessage('\u932F\u8AA4\uFF1A\u7121\u6CD5\u8F09\u5165 Google Maps API', 'error');
                    };

                    document.head.appendChild(script);
                } catch (error) {
                    console.error('Error initializing map:', error);
                    this.showMessage('\u932F\u8AA4\uFF1A\u7121\u6CD5\u958B\u59CB\u8F09\u5165\u5730\u5716', 'error');
                }
            }

            // \u521D\u59CB\u5316\u5730\u5716\u5BE6\u4F8B
            initializeMap() {
                // \u78BA\u4FDD Google Maps API \u5DF2\u5B8C\u5168\u8F09\u5165
                if (typeof google === 'undefined' || !google.maps || !google.maps.Map) {
                    console.error('Google Maps API not ready');
                    this.showMessage('\u932F\u8AA4\uFF1AGoogle Maps API \u5C1A\u672A\u8F09\u5165\u5B8C\u6210', 'error');
                    // \u91CD\u8A66
                    setTimeout(() => {
                        if (typeof google !== 'undefined' && google.maps && google.maps.Map) {
                            this.initializeMap();
                        }
                    }, 500);
                    return;
                }

                const initialCenter = { lat: 23.5687, lng: 119.5775 }; // \u6F8E\u6E56\u4E2D\u5FC3
                const mapDiv = document.getElementById('map');
                
                if (!mapDiv) {
                    console.error('Map container not found');
                    return;
                }

                try {
                    // \u5730\u5716\u5143\u7D20\u5DF2\u7D93\u901A\u904E CSS \u985E\u8A2D\u7F6E\u4E86\u6A23\u5F0F\uFF0C\u4E0D\u9700\u8981 inline style
                    this.map = new google.maps.Map(mapDiv, {
                        center: initialCenter,
                        zoom: 12,
                        mapTypeControl: false,
                        clickableIcons: true
                    });

                    // \u89F8\u767C resize \u4E8B\u4EF6\u78BA\u4FDD\u5730\u5716\u6B63\u78BA\u6E32\u67D3
                    setTimeout(() => {
                        if (this.map && google && google.maps) {
                            google.maps.event.trigger(this.map, 'resize');
                            // \u91CD\u65B0\u8A2D\u7F6E\u4E2D\u5FC3\u9EDE\u78BA\u4FDD\u5730\u5716\u6B63\u78BA\u986F\u793A
                            this.map.setCenter(initialCenter);
                            console.log('Map initialized and resized');
                        }
                    }, 200);

                    // \u76E3\u807D\u5730\u5716\u4E0A\u7684 POI \u9EDE\u64CA
                    this.map.addListener('click', (event) => {
                        if (event.placeId) {
                            event.stop();
                            this.handlePoiClick(event.placeId);
                        }
                    });

                    console.log('Map initialized successfully');
                } catch (error) {
                    console.error('Error creating map:', error);
                    this.showMessage('\u932F\u8AA4\uFF1A\u7121\u6CD5\u5EFA\u7ACB\u5730\u5716 - ' + error.message, 'error');
                    return;
                }

                    // \u8DEF\u7DDA\u670D\u52D9\u5C07\u5728\u9996\u6B21\u4F7F\u7528\u6642\u521D\u59CB\u5316\uFF08\u5EF6\u9072\u521D\u59CB\u5316\u4EE5\u907F\u514D API \u6B0A\u9650\u554F\u984C\uFF09

                    // \u521D\u59CB\u5316 UI
                    this.initializeDays();
                    this.updateDayTabs();
                    this.updateTripPanel();
            }

            // \u8655\u7406 POI \u9EDE\u64CA
            async handlePoiClick(placeId) {
                try {
                    const response = await fetch('/api/locations/details-by-placeid/' + placeId);
                    if (!response.ok) {
                        throw new Error('Failed to fetch place details');
                    }

                    const placeData = await response.json();
                    
                    // \u6AA2\u67E5\u662F\u5426\u5DF2\u7D93\u9078\u904E
                    const existingIndex = this.selectedPlaces.findIndex(p => p.placeId === placeId);
                    if (existingIndex >= 0) {
                        this.showMessage('\u6B64\u5730\u9EDE\u5DF2\u5728\u884C\u7A0B\u4E2D', 'warning');
                        return;
                    }

                    // \u6DFB\u52A0\u5230\u7576\u524D\u65E5\u671F
                    const newPlace = {
                        placeId: placeId,
                        placeData: placeData,
                        dayIndex: this.currentDayIndex,
                        time: this.getDefaultTime(),
                        order: this.selectedPlaces.filter(p => p.dayIndex === this.currentDayIndex).length,
                        bookingStatus: 'planned',
                        bookingUrl: placeData.website || null,
                        bookingPhone: placeData.phone_number || placeData.formatted_phone_number || null,
                        bookingNotes: null,
                        itemId: null
                    };

                    this.selectedPlaces.push(newPlace);
                    
                    // \u5728\u5730\u5716\u4E0A\u6DFB\u52A0\u6A19\u8A18
                    this.addMarker(placeData, newPlace);
                    
                    // \u66F4\u65B0 UI
                    this.updateTripPanel();
                    this.updateSelectedCount();
                    this.updateSaveButton();
                    this.showMessage('\u5DF2\u52A0\u5165\u884C\u7A0B', 'success');
                } catch (error) {
                    console.error('Error handling POI click:', error);
                    this.showMessage('\u7121\u6CD5\u8F09\u5165\u5730\u9EDE\u8CC7\u8A0A', 'error');
                }
            }

            // \u6DFB\u52A0\u5730\u5716\u6A19\u8A18
            addMarker(placeData, place) {
                if (!placeData.latitude || !placeData.longitude) return;

                const position = { lat: placeData.latitude, lng: placeData.longitude };
                const markerNumber = this.getMarkerNumber(place);
                
                // \u6CE8\u610F\uFF1Agoogle.maps.Marker \u5DF2\u68C4\u7528\uFF0C\u5EFA\u8B70\u4F7F\u7528 AdvancedMarkerElement
                // \u4F46\u70BA\u4E86\u517C\u5BB9\u6027\uFF0C\u66AB\u6642\u7E7C\u7E8C\u4F7F\u7528 Marker
                // TODO: \u9077\u79FB\u5230 google.maps.marker.AdvancedMarkerElement
                const marker = new google.maps.Marker({
                    position: position,
                    map: this.map,
                    title: placeData.name,
                    icon: {
                        url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(
                            '<svg width="32" height="32" viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg">' +
                            '<circle cx="16" cy="16" r="12" fill="#3b82f6" stroke="white" stroke-width="2"/>' +
                            '<text x="16" y="20" text-anchor="middle" fill="white" font-size="12" font-weight="bold">' +
                            markerNumber + '</text></svg>'
                        ),
                        scaledSize: new google.maps.Size(32, 32),
                        anchor: new google.maps.Point(16, 16)
                    }
                });

                // \u6DFB\u52A0\u9EDE\u64CA\u4E8B\u4EF6\u986F\u793A\u8A73\u60C5
                marker.addListener('click', () => {
                    this.showLocationDetail(placeData, place);
                });

                this.markers.push({ marker, place });
                this.updateMarkerNumbers();
            }

            // \u7372\u53D6\u6A19\u8A18\u7DE8\u865F\uFF08\u6839\u64DA\u7576\u524D\u5929\u6578\u7684\u9806\u5E8F\uFF09
            getMarkerNumber(place) {
                const currentDayPlaces = this.selectedPlaces
                    .filter(p => p.dayIndex === place.dayIndex)
                    .sort((a, b) => {
                        if (a.time !== b.time) {
                            return a.time.localeCompare(b.time);
                        }
                        return a.order - b.order;
                    });
                const index = currentDayPlaces.findIndex(p => p.placeId === place.placeId);
                return index >= 0 ? index + 1 : this.selectedPlaces.length;
            }

            // \u66F4\u65B0\u6240\u6709\u6A19\u8A18\u7684\u7DE8\u865F
            updateMarkerNumbers() {
                this.markers.forEach(({ marker, place }) => {
                    const markerNumber = this.getMarkerNumber(place);
                    marker.setIcon({
                        url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(
                            '<svg width="32" height="32" viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg">' +
                            '<circle cx="16" cy="16" r="12" fill="#3b82f6" stroke="white" stroke-width="2"/>' +
                            '<text x="16" y="20" text-anchor="middle" fill="white" font-size="12" font-weight="bold">' +
                            markerNumber + '</text></svg>'
                        ),
                        scaledSize: new google.maps.Size(32, 32),
                        anchor: new google.maps.Point(16, 16)
                    });
                });
            }

            // \u521D\u59CB\u5316\u5929\u6578
            initializeDays() {
                const today = new Date();
                this.days = [today];
                this.currentDayIndex = 0;
            }

            // \u66F4\u65B0\u5929\u6578\u6A19\u7C64
            updateDayTabs() {
                const tabsContainer = document.getElementById('day-tabs');
                if (!tabsContainer) return;

                tabsContainer.innerHTML = this.days.map((day, index) => {
                    const dateStr = this.formatDate(day);
                    const isActive = index === this.currentDayIndex;
                    return \`
                        <button class="day-tab \${isActive ? 'active' : ''}" 
                                data-day-index="\${index}"
                                data-action="switch-day">
                            \u7B2C \${index + 1} \u5929<br>
                            <span class="text-xs">\${dateStr}</span>
                        </button>
                    \`;
                }).join('');
                
                // \u7D81\u5B9A\u5929\u6578\u5207\u63DB\u4E8B\u4EF6
                tabsContainer.querySelectorAll('[data-action="switch-day"]').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const dayIndex = parseInt(e.target.closest('[data-day-index]').dataset.dayIndex);
                        this.switchDay(dayIndex);
                    });
                });
            }

            // \u5207\u63DB\u5929\u6578
            switchDay(dayIndex) {
                this.currentDayIndex = dayIndex;
                this.updateDayTabs();
                this.updateTripPanel();
                this.updateRoute(); // \u66F4\u65B0\u8DEF\u7DDA
                
                // \u66F4\u65B0\u65E5\u671F\u9078\u64C7\u5668
                const dateInput = document.getElementById('current-day-date');
                if (dateInput) {
                    dateInput.value = this.formatDateInput(this.days[dayIndex]);
                }
            }

            // \u65B0\u589E\u4E00\u5929
            addDay() {
                const lastDay = this.days[this.days.length - 1];
                const newDay = new Date(lastDay);
                newDay.setDate(newDay.getDate() + 1);
                this.days.push(newDay);
                this.updateDayTabs();
            }

            // \u66F4\u65B0\u884C\u7A0B\u9762\u677F
            updateTripPanel() {
                const listContainer = document.getElementById('trip-items-list');
                if (!listContainer) return;

                const currentDayPlaces = this.selectedPlaces
                    .filter(p => p.dayIndex === this.currentDayIndex)
                    .sort((a, b) => {
                        // \u5148\u6309\u6642\u9593\u6392\u5E8F\uFF0C\u518D\u6309\u9806\u5E8F\u6392\u5E8F
                        if (a.time !== b.time) {
                            return a.time.localeCompare(b.time);
                        }
                        return a.order - b.order;
                    });

                if (currentDayPlaces.length === 0) {
                    listContainer.innerHTML = \`
                        <div id="empty-state" class="text-center text-gray-400 py-8">
                            <p>\u5C1A\u672A\u9078\u64C7\u4EFB\u4F55\u5730\u9EDE</p>
                            <p class="text-sm mt-2">\u9EDE\u64CA\u5730\u5716\u4E0A\u7684\u5716\u793A\u958B\u59CB\u898F\u5283</p>
                        </div>
                    \`;
                    return;
                }

                listContainer.innerHTML = currentDayPlaces.map((place, index) => {
                    const placeData = place.placeData;
                    const bookingStatus = place.bookingStatus || 'planned';
                    const statusLabels = {
                        'planned': { text: '\u5DF2\u898F\u5283', class: 'bg-yellow-100 text-yellow-800', icon: '\u{1F7E1}' },
                        'booked': { text: '\u5DF2\u9810\u8A02', class: 'bg-green-100 text-green-800', icon: '\u{1F7E2}' },
                        'completed': { text: '\u5DF2\u5B8C\u6210', class: 'bg-blue-100 text-blue-800', icon: '\u2705' },
                        'cancelled': { text: '\u5DF2\u53D6\u6D88', class: 'bg-red-100 text-red-800', icon: '\u{1F534}' }
                    };
                    const statusInfo = statusLabels[bookingStatus] || statusLabels['planned'];
                    
                    return \`
                        <div class="trip-item" 
                             draggable="true"
                             data-place-id="\${place.placeId}"
                             data-day-index="\${place.dayIndex}"
                             data-order="\${place.order}">
                            <div class="trip-item-header">
                                <div class="trip-item-name clickable-location-name" 
                                     data-place-id="\${place.placeId}"
                                     data-action="show-location-detail">
                                    \${placeData.name || '\u672A\u77E5\u5730\u9EDE'}
                                </div>
                                <div class="trip-item-actions">
                                    <input type="time" 
                                           id="time-input-\${place.placeId}"
                                           name="time-input-\${place.placeId}"
                                           class="time-input" 
                                           value="\${place.time}"
                                           data-place-id="\${place.placeId}"
                                           data-action="update-time">
                                    <button type="button" 
                                            class="trip-item-btn delete" 
                                            data-place-id="\${place.placeId}"
                                            data-action="remove-place">
                                        \u522A\u9664
                                    </button>
                                </div>
                            </div>
                            <div class="trip-item-time">
                                <span>\${placeData.address || '\u7121\u5730\u5740'}</span>
                            </div>
                            <div class="trip-item-booking mt-2 flex items-center justify-between">
                                <div class="flex items-center gap-2">
                                    <span class="booking-status-badge \${statusInfo.class} px-2 py-1 rounded text-xs">
                                        \${statusInfo.icon} \${statusInfo.text}
                                    </span>
                                    <select id="booking-status-\${place.placeId}"
                                            name="booking-status-\${place.placeId}"
                                            class="booking-status-select text-xs border rounded px-2 py-1"
                                            data-place-id="\${place.placeId}"
                                            data-action="update-booking-status">
                                        <option value="planned" \${bookingStatus === 'planned' ? 'selected' : ''}>\u5DF2\u898F\u5283</option>
                                        <option value="booked" \${bookingStatus === 'booked' ? 'selected' : ''}>\u5DF2\u9810\u8A02</option>
                                        <option value="completed" \${bookingStatus === 'completed' ? 'selected' : ''}>\u5DF2\u5B8C\u6210</option>
                                        <option value="cancelled" \${bookingStatus === 'cancelled' ? 'selected' : ''}>\u5DF2\u53D6\u6D88</option>
                                    </select>
                                </div>
                                <div class="flex items-center gap-2">
                                    \${place.bookingPhone ? \`
                                        <a href="tel:\${place.bookingPhone}" 
                                           class="trip-item-btn text-xs bg-blue-500 text-white hover:bg-blue-600">
                                            \u96FB\u8A71
                                        </a>
                                    \` : ''}
                                    \${place.bookingUrl ? \`
                                        <a href="\${place.bookingUrl}" 
                                           target="_blank" 
                                           rel="noopener noreferrer"
                                           class="trip-item-btn text-xs bg-green-500 text-white hover:bg-green-600">
                                            \u7DB2\u7AD9
                                        </a>
                                    \` : ''}
                                </div>
                            </div>
                        </div>
                    \`;
                }).join('');
                
                // \u7D81\u5B9A\u6240\u6709\u4E8B\u4EF6\u76E3\u807D\u5668
                this.attachTripItemEventListeners(listContainer);
                
                // \u66F4\u65B0\u8DEF\u7DDA
                this.updateRoute();
            }

            // \u7D81\u5B9A\u884C\u7A0B\u9805\u76EE\u7684\u4E8B\u4EF6\u76E3\u807D\u5668
            attachTripItemEventListeners(container) {
                // \u7D81\u5B9A\u62D6\u62FD\u4E8B\u4EF6
                container.querySelectorAll('.trip-item').forEach(item => {
                    item.addEventListener('dragstart', (e) => this.handleDragStart(e));
                    item.addEventListener('dragend', (e) => this.handleDragEnd(e));
                    item.addEventListener('dragover', (e) => this.handleDragOver(e));
                    item.addEventListener('drop', (e) => this.handleDrop(e));
                    item.addEventListener('dragleave', (e) => this.handleDragLeave(e));
                });

                // \u7D81\u5B9A\u6642\u9593\u8F38\u5165\u4E8B\u4EF6
                container.querySelectorAll('[data-action="update-time"]').forEach(input => {
                    input.addEventListener('change', (e) => {
                        const placeId = e.target.dataset.placeId;
                        const newTime = e.target.value;
                        this.updateTime(placeId, newTime);
                    });
                });

                // \u7D81\u5B9A\u522A\u9664\u6309\u9215\u4E8B\u4EF6
                container.querySelectorAll('[data-action="remove-place"]').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const placeId = e.target.closest('[data-place-id]').dataset.placeId;
                        this.removePlace(placeId);
                    });
                });

                // \u7D81\u5B9A\u9810\u8A02\u72C0\u614B\u9078\u64C7\u4E8B\u4EF6
                container.querySelectorAll('[data-action="update-booking-status"]').forEach(select => {
                    select.addEventListener('change', (e) => {
                        const placeId = e.target.dataset.placeId;
                        const newStatus = e.target.value;
                        this.updateBookingStatus(placeId, newStatus);
                    });
                });

                // \u7D81\u5B9A\u5730\u9EDE\u8A73\u60C5\u9EDE\u64CA\u4E8B\u4EF6
                container.querySelectorAll('[data-action="show-location-detail"]').forEach(element => {
                    element.addEventListener('click', (e) => {
                        const placeId = e.target.closest('[data-place-id]').dataset.placeId;
                        const place = this.selectedPlaces.find(p => p.placeId === placeId);
                        if (place) {
                            this.showLocationDetail(place.placeData, place);
                        }
                    });
                });
            }

            // \u986F\u793A\u5730\u9EDE\u8A73\u60C5
            showLocationDetail(placeData, place) {
                // \u5275\u5EFA\u6216\u66F4\u65B0\u8A73\u60C5\u9762\u677F
                let panel = document.getElementById('location-detail-panel');
                if (!panel) {
                    panel = document.createElement('div');
                    panel.id = 'location-detail-panel';
                    panel.className = 'location-detail-panel';
                    document.body.appendChild(panel);
                }

                panel.innerHTML = \`
                    <div class="detail-panel-overlay" data-action="close-detail"></div>
                    <div class="detail-panel-content">
                        <button class="detail-panel-close" data-action="close-detail">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M18 6L6 18M6 6l12 12"/>
                            </svg>
                        </button>
                        <div class="detail-panel-image">
                            <img src="\${placeData.thumbnail_url || 'https://placehold.co/600x400/6B7280/FFFFFF?text=Location+Image'}" 
                                 alt="\${placeData.name || '\u5730\u9EDE\u7167\u7247'}" 
                                 class="detail-panel-img"
                                 data-fallback-src="https://placehold.co/600x400/6B7280/FFFFFF?text=Location+Image">
                        </div>
                        <div class="detail-panel-info">
                            <h2 class="detail-panel-title">\${placeData.name || '\u672A\u547D\u540D\u5730\u9EDE'}</h2>
                            <div class="detail-panel-meta">
                                <div class="meta-item">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/>
                                        <circle cx="12" cy="10" r="3"/>
                                    </svg>
                                    <span>\${placeData.address || '\u7121\u5730\u5740\u8CC7\u8A0A'}</span>
                                </div>
                                \${placeData.phone_number || placeData.formatted_phone_number ? \`
                                    <div class="meta-item">
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/>
                                        </svg>
                                        <span>\${placeData.formatted_phone_number || placeData.phone_number}</span>
                                    </div>
                                \` : ''}
                                \${placeData.website ? \`
                                    <div class="meta-item">
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6M15 3h6v6M10 14L21 3"/>
                                        </svg>
                                        <a href="\${placeData.website}" target="_blank" rel="noopener noreferrer">\u7DB2\u7AD9</a>
                                    </div>
                                \` : ''}
                            </div>
                            \${placeData.editorial_summary ? \`
                                <div class="detail-panel-description">
                                    <h3>\u7C21\u4ECB</h3>
                                    <p>\${placeData.editorial_summary}</p>
                                </div>
                            \` : ''}
                            \${place && place.bookingStatus ? \`
                                <div class="detail-panel-booking">
                                    <h3>\u9810\u8A02\u72C0\u614B</h3>
                                    <p>\u72C0\u614B: <span class="booking-status-\${place.bookingStatus}">\${this.getBookingStatusText(place.bookingStatus)}</span></p>
                                </div>
                            \` : ''}
                        </div>
                    </div>
                \`;

                // \u986F\u793A\u9762\u677F
                panel.classList.add('visible');

                // \u7D81\u5B9A\u95DC\u9589\u4E8B\u4EF6
                panel.querySelectorAll('[data-action="close-detail"]').forEach(btn => {
                    btn.addEventListener('click', () => this.hideLocationDetail());
                });

                // \u8655\u7406\u5716\u7247\u8F09\u5165\u932F\u8AA4\uFF08CSP \u517C\u5BB9\uFF09
                const img = panel.querySelector('.detail-panel-img');
                if (img) {
                    img.addEventListener('error', function() {
                        const fallbackSrc = this.dataset.fallbackSrc;
                        if (fallbackSrc && this.src !== fallbackSrc) {
                            this.src = fallbackSrc;
                        }
                    });
                }

                // ESC \u9375\u95DC\u9589
                const escHandler = (e) => {
                    if (e.key === 'Escape') {
                        this.hideLocationDetail();
                        document.removeEventListener('keydown', escHandler);
                    }
                };
                document.addEventListener('keydown', escHandler);
            }

            // \u96B1\u85CF\u5730\u9EDE\u8A73\u60C5
            hideLocationDetail() {
                const panel = document.getElementById('location-detail-panel');
                if (panel) {
                    panel.classList.remove('visible');
                }
            }

            // \u7372\u53D6\u9810\u8A02\u72C0\u614B\u6587\u5B57
            getBookingStatusText(status) {
                const statusMap = {
                    'planned': '\u5DF2\u898F\u5283',
                    'booked': '\u5DF2\u9810\u8A02',
                    'completed': '\u5DF2\u5B8C\u6210',
                    'cancelled': '\u5DF2\u53D6\u6D88'
                };
                return statusMap[status] || '\u672A\u77E5';
            }

            // \u66F4\u65B0\u8DEF\u7DDA
            updateRoute() {
                // \u5982\u679C Directions API \u5DF2\u88AB\u62D2\u7D55\uFF0C\u76F4\u63A5\u4F7F\u7528\u964D\u7D1A\u65B9\u6848
                if (this.directionsApiDenied) {
                    const currentDayPlaces = this.selectedPlaces
                        .filter(p => p.dayIndex === this.currentDayIndex)
                        .sort((a, b) => {
                            if (a.time !== b.time) {
                                return a.time.localeCompare(b.time);
                            }
                            return a.order - b.order;
                        })
                        .filter(p => p.placeData && p.placeData.latitude && p.placeData.longitude);
                    if (currentDayPlaces.length >= 2) {
                        this.drawSimpleRoute(currentDayPlaces);
                    }
                    return;
                }

                // \u6AA2\u67E5 Directions Service \u662F\u5426\u53EF\u7528
                if (!google.maps.DirectionsService || !google.maps.DirectionsRenderer) {
                    // \u975C\u9ED8\u8655\u7406\uFF0C\u76F4\u63A5\u4F7F\u7528\u964D\u7D1A\u65B9\u6848
                    const currentDayPlaces = this.selectedPlaces
                        .filter(p => p.dayIndex === this.currentDayIndex)
                        .sort((a, b) => {
                            if (a.time !== b.time) {
                                return a.time.localeCompare(b.time);
                            }
                            return a.order - b.order;
                        })
                        .filter(p => p.placeData && p.placeData.latitude && p.placeData.longitude);
                    if (currentDayPlaces.length >= 2) {
                        this.drawSimpleRoute(currentDayPlaces);
                    }
                    return;
                }

                // \u521D\u59CB\u5316\u670D\u52D9\uFF08\u5982\u679C\u5C1A\u672A\u521D\u59CB\u5316\uFF09
                if (!this.directionsService) {
                    try {
                        this.directionsService = new google.maps.DirectionsService();
                        this.directionsRenderer = new google.maps.DirectionsRenderer({
                            map: this.map,
                            suppressMarkers: true // \u4E0D\u986F\u793A\u9ED8\u8A8D\u6A19\u8A18\uFF0C\u4F7F\u7528\u6211\u5011\u81EA\u5B9A\u7FA9\u7684
                        });
                    } catch (error) {
                        // \u975C\u9ED8\u8655\u7406\u932F\u8AA4\uFF08\u5DF2\u7531\u5168\u5C40\u932F\u8AA4\u8655\u7406\u5668\u8655\u7406\uFF09
                        this.directionsApiDenied = true;
                        return;
                    }
                }

                // \u6E05\u9664\u73FE\u6709\u8DEF\u7DDA
                try {
                    this.directionsRenderer.setDirections({ routes: [] });
                } catch (error) {
                    // \u5FFD\u7565\u6E05\u9664\u932F\u8AA4
                }
                this.routePolylines.forEach(polyline => {
                    try {
                        polyline.setMap(null);
                    } catch (error) {
                        // \u5FFD\u7565\u6E05\u9664\u932F\u8AA4
                    }
                });
                this.routePolylines = [];

                // \u7372\u53D6\u7576\u524D\u5929\u6578\u7684\u5730\u9EDE\uFF0C\u6309\u6642\u9593\u548C\u9806\u5E8F\u6392\u5E8F
                const currentDayPlaces = this.selectedPlaces
                    .filter(p => p.dayIndex === this.currentDayIndex)
                    .sort((a, b) => {
                        if (a.time !== b.time) {
                            return a.time.localeCompare(b.time);
                        }
                        return a.order - b.order;
                    })
                    .filter(p => p.placeData && p.placeData.latitude && p.placeData.longitude);

                if (currentDayPlaces.length < 2) return;

                // \u69CB\u5EFA\u8DEF\u7DDA\u9EDE
                const waypoints = currentDayPlaces.slice(1, -1).map(place => ({
                    location: { lat: place.placeData.latitude, lng: place.placeData.longitude },
                    stopover: true
                }));

                const origin = { 
                    lat: currentDayPlaces[0].placeData.latitude, 
                    lng: currentDayPlaces[0].placeData.longitude 
                };
                const destination = { 
                    lat: currentDayPlaces[currentDayPlaces.length - 1].placeData.latitude, 
                    lng: currentDayPlaces[currentDayPlaces.length - 1].placeData.longitude 
                };

                // \u8ACB\u6C42\u8DEF\u7DDA
                try {
                    this.directionsService.route({
                        origin: origin,
                        destination: destination,
                        waypoints: waypoints.length > 0 ? waypoints : undefined,
                        travelMode: google.maps.TravelMode.DRIVING,
                        optimizeWaypoints: false // \u4FDD\u6301\u7528\u6236\u8A2D\u5B9A\u7684\u9806\u5E8F
                    }, (result, status) => {
                        if (status === 'OK' && result) {
                            try {
                                this.directionsRenderer.setDirections(result);
                            } catch (error) {
                                console.warn('\u8A2D\u7F6E\u8DEF\u7DDA\u5931\u6557:', error);
                            }
                        } else if (status === 'REQUEST_DENIED') {
                            // \u6A19\u8A18 API \u5DF2\u88AB\u62D2\u7D55\uFF0C\u907F\u514D\u91CD\u8907\u5617\u8A66
                            if (!this.directionsApiDenied) {
                                // \u975C\u9ED8\u8655\u7406\uFF0C\u4E0D\u986F\u793A\u8B66\u544A\uFF08\u5DF2\u7531\u5168\u5C40\u932F\u8AA4\u8655\u7406\u5668\u8655\u7406\uFF09
                                this.directionsApiDenied = true;
                            }
                            // \u4F7F\u7528\u7C21\u55AE\u7684\u6298\u7DDA\u9023\u63A5\u5730\u9EDE\u4F5C\u70BA\u964D\u7D1A\u65B9\u6848
                            this.drawSimpleRoute(currentDayPlaces);
                        } else {
                            // \u5176\u4ED6\u932F\u8AA4\u4E5F\u4F7F\u7528\u964D\u7D1A\u65B9\u6848\uFF08\u975C\u9ED8\u8655\u7406\uFF09
                            this.drawSimpleRoute(currentDayPlaces);
                        }
                    });
                } catch (error) {
                    // \u975C\u9ED8\u8655\u7406\u932F\u8AA4\uFF08\u5DF2\u7531\u5168\u5C40\u932F\u8AA4\u8655\u7406\u5668\u8655\u7406\uFF09
                    // \u4F7F\u7528\u7C21\u55AE\u7684\u6298\u7DDA\u9023\u63A5\u5730\u9EDE\u4F5C\u70BA\u964D\u7D1A\u65B9\u6848
                    this.drawSimpleRoute(currentDayPlaces);
                }
            }

            // \u7C21\u55AE\u8DEF\u7DDA\u7E6A\u88FD\uFF08\u964D\u7D1A\u65B9\u6848\uFF09
            drawSimpleRoute(places) {
                if (places.length < 2) return;

                const path = places.map(place => ({
                    lat: place.placeData.latitude,
                    lng: place.placeData.longitude
                }));

                const polyline = new google.maps.Polyline({
                    path: path,
                    geodesic: true,
                    strokeColor: '#3b82f6',
                    strokeOpacity: 0.6,
                    strokeWeight: 3
                });

                polyline.setMap(this.map);
                this.routePolylines.push(polyline);
            }

            // \u62D6\u62FD\u8655\u7406
            handleDragStart(event) {
                this.draggedElement = event.target.closest('.trip-item');
                if (this.draggedElement) {
                    this.draggedElement.classList.add('dragging');
                    event.dataTransfer.effectAllowed = 'move';
                }
            }

            handleDragEnd(event) {
                if (this.draggedElement) {
                    this.draggedElement.classList.remove('dragging');
                }
                if (this.dragOverElement) {
                    this.dragOverElement.classList.remove('drag-over');
                }
                this.draggedElement = null;
                this.dragOverElement = null;
            }

            handleDragOver(event) {
                event.preventDefault();
                event.dataTransfer.dropEffect = 'move';
                
                const tripItem = event.target.closest('.trip-item');
                if (tripItem && tripItem !== this.draggedElement) {
                    if (this.dragOverElement && this.dragOverElement !== tripItem) {
                        this.dragOverElement.classList.remove('drag-over');
                    }
                    tripItem.classList.add('drag-over');
                    this.dragOverElement = tripItem;
                }
            }

            handleDragLeave(event) {
                const tripItem = event.target.closest('.trip-item');
                if (tripItem) {
                    tripItem.classList.remove('drag-over');
                }
            }

            handleDrop(event) {
                event.preventDefault();
                
                const tripItem = event.target.closest('.trip-item');
                if (tripItem) {
                    tripItem.classList.remove('drag-over');
                }

                if (!this.draggedElement) return;

                const draggedPlaceId = this.draggedElement.dataset.placeId;
                const targetPlaceId = tripItem ? tripItem.dataset.placeId : null;

                if (!targetPlaceId || draggedPlaceId === targetPlaceId) return;

                // \u91CD\u65B0\u6392\u5E8F
                const draggedPlace = this.selectedPlaces.find(p => p.placeId === draggedPlaceId);
                const targetPlace = this.selectedPlaces.find(p => p.placeId === targetPlaceId);

                if (draggedPlace && targetPlace && draggedPlace.dayIndex === targetPlace.dayIndex) {
                    // \u7372\u53D6\u7576\u524D\u5929\u6578\u7684\u6240\u6709\u5730\u9EDE\uFF0C\u6309\u6642\u9593\u548C\u9806\u5E8F\u6392\u5E8F
                    const currentDayPlaces = this.selectedPlaces
                        .filter(p => p.dayIndex === draggedPlace.dayIndex)
                        .sort((a, b) => {
                            if (a.time !== b.time) {
                                return a.time.localeCompare(b.time);
                            }
                            return a.order - b.order;
                        });

                    // \u627E\u5230\u62D6\u62FD\u548C\u76EE\u6A19\u5730\u9EDE\u5728\u6392\u5E8F\u5217\u8868\u4E2D\u7684\u4F4D\u7F6E
                    const draggedIndex = currentDayPlaces.findIndex(p => p.placeId === draggedPlaceId);
                    const targetIndex = currentDayPlaces.findIndex(p => p.placeId === targetPlaceId);

                    if (draggedIndex >= 0 && targetIndex >= 0) {
                        // \u91CD\u65B0\u8A08\u7B97\u6240\u6709\u9805\u76EE\u7684\u9806\u5E8F
                        const newPlaces = [...currentDayPlaces];
                        const [removed] = newPlaces.splice(draggedIndex, 1);
                        newPlaces.splice(targetIndex, 0, removed);

                        // \u66F4\u65B0\u9806\u5E8F
                        newPlaces.forEach((place, index) => {
                            place.order = index;
                        });

                        // \u66F4\u65B0 UI \u548C\u5730\u5716\u6A19\u8A18
                        this.updateTripPanel();
                        this.updateMarkerNumbers();
                        this.updateRoute(); // \u66F4\u65B0\u8DEF\u7DDA
                        this.updateSaveButton();
                    }
                }
            }

            // \u66F4\u65B0\u6642\u9593
            updateTime(placeId, newTime) {
                const place = this.selectedPlaces.find(p => p.placeId === placeId);
                if (place) {
                    place.time = newTime;
                    this.updateTripPanel();
                    this.updateRoute(); // \u66F4\u65B0\u8DEF\u7DDA
                    this.updateSaveButton();
                }
            }

            // \u66F4\u65B0\u9810\u8A02\u72C0\u614B
            async updateBookingStatus(placeId, newStatus) {
                const place = this.selectedPlaces.find(p => p.placeId === placeId);
                if (!place) return;

                place.bookingStatus = newStatus;
                this.updateTripPanel();

                // \u5982\u679C\u6709 itemId\uFF0C\u66F4\u65B0\u8CC7\u6599\u5EAB
                if (place.itemId) {
                    try {
                        const response = await fetch(\`/api/trip-planner/item/\${place.itemId}/booking-status\`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ bookingStatus: newStatus }),
                            credentials: 'include'
                        });

                        if (!response.ok) {
                            throw new Error('Failed to update booking status');
                        }
                    } catch (error) {
                        console.error('Error updating booking status:', error);
                        this.showMessage('\u66F4\u65B0\u9810\u8A02\u72C0\u614B\u5931\u6557', 'error');
                    }
                }
            }

            // \u79FB\u9664\u5730\u9EDE
            removePlace(placeId) {
                if (confirm('\u78BA\u5B9A\u8981\u79FB\u9664\u9019\u500B\u5730\u9EDE\u55CE\uFF1F')) {
                    this.selectedPlaces = this.selectedPlaces.filter(p => p.placeId !== placeId);
                    
                    // \u79FB\u9664\u5730\u5716\u6A19\u8A18
                    const markerIndex = this.markers.findIndex(m => m.place.placeId === placeId);
                    if (markerIndex >= 0) {
                        this.markers[markerIndex].marker.setMap(null);
                        this.markers.splice(markerIndex, 1);
                    }
                    
                    this.updateTripPanel();
                    this.updateSelectedCount();
                    this.updateSaveButton();
                }
            }

            // \u7372\u53D6\u9810\u8A2D\u6642\u9593
            getDefaultTime() {
                const currentPlaces = this.selectedPlaces.filter(p => p.dayIndex === this.currentDayIndex);
                if (currentPlaces.length === 0) {
                    return '09:00';
                }
                
                // \u6700\u5F8C\u4E00\u500B\u5730\u9EDE\u7684\u6642\u9593 + 2\u5C0F\u6642
                const lastTime = currentPlaces[currentPlaces.length - 1].time;
                const [hours, minutes] = lastTime.split(':').map(Number);
                const nextHours = (hours + 2) % 24;
                return \`\${String(nextHours).padStart(2, '0')}:\${String(minutes).padStart(2, '0')}\`;
            }

            // \u66F4\u65B0\u5DF2\u9078\u6578\u91CF
            updateSelectedCount() {
                const countEl = document.getElementById('selected-count');
                if (countEl) {
                    countEl.textContent = this.selectedPlaces.length;
                }
            }

            // \u66F4\u65B0\u5132\u5B58\u6309\u9215\u72C0\u614B
            updateSaveButton() {
                const saveBtn = document.getElementById('save-trip-btn');
                const shareBtn = document.getElementById('share-trip-btn');
                if (saveBtn) {
                    saveBtn.disabled = this.selectedPlaces.length === 0;
                }
                if (shareBtn) {
                    shareBtn.disabled = !this.currentTripId || this.selectedPlaces.length === 0;
                }
            }

            // \u5206\u4EAB\u884C\u7A0B
            async shareTrip() {
                if (!this.currentTripId) {
                    this.showMessage('\u8ACB\u5148\u5132\u5B58\u884C\u7A0B', 'warning');
                    return;
                }

                const shareBtn = document.getElementById('share-trip-btn');
                if (!shareBtn) return;

                shareBtn.disabled = true;
                shareBtn.textContent = '\u751F\u6210\u4E2D...';

                try {
                    const response = await fetch(\`/api/trip-planner/\${this.currentTripId}/share\`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ isPublic: true }),
                        credentials: 'include'
                    });

                    if (response.ok) {
                        const result = await response.json();
                        this.shareToken = result.shareToken;
                        
                        // \u986F\u793A\u5206\u4EAB\u9023\u7D50
                        const shareUrl = result.shareUrl;
                        const copySuccess = await this.copyToClipboard(shareUrl);
                        
                        if (copySuccess) {
                            this.showMessage('\u5206\u4EAB\u9023\u7D50\u5DF2\u8907\u88FD\u5230\u526A\u8CBC\u7C3F\uFF01', 'success');
                        } else {
                            // \u5982\u679C\u8907\u88FD\u5931\u6557\uFF0C\u986F\u793A\u9023\u7D50\u8B93\u7528\u6236\u624B\u52D5\u8907\u88FD
                            const linkDisplay = document.createElement('div');
                            linkDisplay.className = 'fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50';
                            linkDisplay.innerHTML = \`
                                <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
                                    <h3 class="text-lg font-bold mb-4">\u5206\u4EAB\u9023\u7D50</h3>
                                    <p class="text-sm text-gray-600 mb-2">\u8ACB\u624B\u52D5\u8907\u88FD\u4EE5\u4E0B\u9023\u7D50\uFF1A</p>
                                    <div class="flex items-center gap-2 mb-4">
                                        <input type="text" 
                                               value="\${shareUrl}" 
                                               readonly 
                                               class="flex-1 border border-gray-300 rounded px-3 py-2 text-sm"
                                               id="share-url-input">
                                        <button type="button" 
                                                class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600"
                                                data-action="copy-share-url">
                                            \u8907\u88FD
                                        </button>
                                    </div>
                                    <button type="button" 
                                            class="w-full bg-gray-200 text-gray-700 px-4 py-2 rounded hover:bg-gray-300"
                                            data-action="close-share-dialog">
                                        \u95DC\u9589
                                    </button>
                                </div>
                            \`;
                            document.body.appendChild(linkDisplay);
                            
                            // \u7D81\u5B9A\u4E8B\u4EF6
                            linkDisplay.querySelector('[data-action="copy-share-url"]').addEventListener('click', async () => {
                                const input = linkDisplay.querySelector('#share-url-input');
                                const success = await this.copyToClipboard(shareUrl, true);
                                if (success) {
                                    linkDisplay.remove();
                                }
                            });
                            
                            linkDisplay.querySelector('[data-action="close-share-dialog"]').addEventListener('click', () => {
                                linkDisplay.remove();
                            });
                            
                            linkDisplay.addEventListener('click', (e) => {
                                if (e.target === linkDisplay) {
                                    linkDisplay.remove();
                                }
                            });
                        }
                    } else {
                        throw new Error('\u5206\u4EAB\u5931\u6557');
                    }
                } catch (error) {
                    console.error('Error sharing trip:', error);
                    this.showMessage('\u5206\u4EAB\u5931\u6557', 'error');
                } finally {
                    shareBtn.disabled = false;
                    shareBtn.textContent = '\u5206\u4EAB\u884C\u7A0B';
                }
            }

            // \u8907\u88FD\u5230\u526A\u8CBC\u7C3F
            async copyToClipboard(text, showMessage = true) {
                try {
                    // \u6AA2\u67E5\u662F\u5426\u5728\u5B89\u5168\u4E0A\u4E0B\u6587\u4E2D\uFF08HTTPS \u6216 localhost\uFF09
                    if (navigator.clipboard && window.isSecureContext && navigator.clipboard.writeText) {
                        try {
                            await navigator.clipboard.writeText(text);
                            if (showMessage) {
                                this.showMessage('\u5DF2\u8907\u88FD\u5230\u526A\u8CBC\u7C3F', 'success');
                            }
                            return true;
                        } catch (clipboardError) {
                            // \u5982\u679C clipboard API \u5931\u6557\uFF0C\u4F7F\u7528 fallback
                            console.warn('Clipboard API failed, using fallback:', clipboardError);
                        }
                    }
                    
                    // \u964D\u7D1A\u65B9\u6848\uFF1A\u4F7F\u7528\u50B3\u7D71\u65B9\u6CD5
                    const textArea = document.createElement('textarea');
                    textArea.value = text;
                    // \u4F7F\u7528 CSS \u985E\u4EE3\u66FF inline style
                    textArea.className = 'clipboard-fallback-textarea';
                    textArea.setAttribute('readonly', '');
                    textArea.setAttribute('aria-hidden', 'true');
                    document.body.appendChild(textArea);
                    
                    // \u9078\u64C7\u6587\u672C
                    textArea.select();
                    textArea.setSelectionRange(0, text.length);
                    
                    try {
                        const successful = document.execCommand('copy');
                        document.body.removeChild(textArea);
                        if (successful) {
                            if (showMessage) {
                                this.showMessage('\u5DF2\u8907\u88FD\u5230\u526A\u8CBC\u7C3F', 'success');
                            }
                            return true;
                        } else {
                            throw new Error('execCommand copy failed');
                        }
                    } catch (err) {
                        document.body.removeChild(textArea);
                        throw err;
                    }
                } catch (error) {
                    console.error('\u8907\u88FD\u5230\u526A\u8CBC\u7C3F\u5931\u6557:', error);
                    if (showMessage) {
                        this.showMessage('\u7121\u6CD5\u81EA\u52D5\u8907\u88FD\uFF0C\u8ACB\u624B\u52D5\u8907\u88FD\u9023\u7D50', 'warning');
                    }
                    return false;
                }
            }

            // \u683C\u5F0F\u5316\u65E5\u671F
            formatDate(date) {
                return date.toLocaleDateString('zh-TW', { month: 'short', day: 'numeric' });
            }

            formatDateInput(date) {
                return date.toISOString().split('T')[0];
            }

            // \u986F\u793A\u8F09\u5165\u72C0\u614B
            showLoadingState(message = '\u8F09\u5165\u4E2D...') {
                let overlay = document.getElementById('loading-overlay');
                if (!overlay) {
                    overlay = document.createElement('div');
                    overlay.id = 'loading-overlay';
                    overlay.className = 'loading-overlay';
                    overlay.innerHTML = \`
                        <div class="loading-content">
                            <div class="loading-spinner"></div>
                            <p class="text-gray-700">\${message}</p>
                        </div>
                    \`;
                    document.body.appendChild(overlay);
                } else {
                    const content = overlay.querySelector('.loading-content p');
                    if (content) {
                        content.textContent = message;
                    }
                    overlay.classList.remove('hidden');
                }
            }

            // \u96B1\u85CF\u8F09\u5165\u72C0\u614B
            hideLoadingState() {
                const overlay = document.getElementById('loading-overlay');
                if (overlay) {
                    overlay.classList.add('hidden');
                }
            }

            // \u986F\u793A\u932F\u8AA4\u8A0A\u606F
            showError(message) {
                this.showMessage(message, 'error');
            }

            // \u6E05\u7A7A\u7576\u524D\u884C\u7A0B
            clearCurrentTrip() {
                // \u6E05\u7A7A\u5730\u9EDE\u5217\u8868
                this.selectedPlaces = [];
                
                // \u79FB\u9664\u6240\u6709\u5730\u5716\u6A19\u8A18
                this.markers.forEach(({ marker }) => {
                    marker.setMap(null);
                });
                this.markers = [];
                
                // \u6E05\u9664\u8DEF\u7DDA
                if (this.directionsRenderer) {
                    try {
                        this.directionsRenderer.setDirections({ routes: [] });
                    } catch (error) {
                        // \u5FFD\u7565\u932F\u8AA4
                    }
                }
                this.routePolylines.forEach(polyline => {
                    try {
                        polyline.setMap(null);
                    } catch (error) {
                        // \u5FFD\u7565\u932F\u8AA4
                    }
                });
                this.routePolylines = [];
                
                // \u91CD\u7F6E\u5929\u6578
                this.days = [new Date()];
                this.currentDayIndex = 0;
                
                // \u91CD\u7F6E\u884C\u7A0B ID
                this.currentTripId = null;
                this.shareToken = null;
                
                // \u66F4\u65B0 UI
                this.updateDayTabs();
                this.updateTripPanel();
                this.updateSelectedCount();
                this.updateSaveButton();
            }

            // \u7372\u53D6\u7528\u6236\u7684\u6240\u6709\u884C\u7A0B\u5217\u8868
            async loadUserTrips() {
                try {
                    const response = await fetch('/api/trip-planner/list', {
                        credentials: 'include'
                    });
                    
                    if (!response.ok) {
                        throw new Error('\u7121\u6CD5\u7372\u53D6\u884C\u7A0B\u5217\u8868');
                    }
                    
                    const data = await response.json();
                    return data.trips || [];
                } catch (error) {
                    console.error('Error loading user trips:', error);
                    this.showError('\u7121\u6CD5\u8F09\u5165\u884C\u7A0B\u5217\u8868');
                    return [];
                }
            }

            // \u986F\u793A\u884C\u7A0B\u5217\u8868\u5C0D\u8A71\u6846
            async showTripList() {
                this.showLoadingState('\u8F09\u5165\u884C\u7A0B\u5217\u8868...');
                
                const trips = await this.loadUserTrips();
                this.hideLoadingState();
                
                if (trips.length === 0) {
                    this.showMessage('\u60A8\u9084\u6C92\u6709\u5132\u5B58\u4EFB\u4F55\u884C\u7A0B', 'info');
                    return;
                }
                
                // \u5275\u5EFA\u6216\u66F4\u65B0\u5C0D\u8A71\u6846
                let modal = document.getElementById('trip-list-modal');
                if (!modal) {
                    modal = document.createElement('div');
                    modal.id = 'trip-list-modal';
                    modal.className = 'trip-list-modal';
                    document.body.appendChild(modal);
                }
                
                // \u683C\u5F0F\u5316\u65E5\u671F
                const formatDate = (timestamp) => {
                    if (!timestamp) return '\u672A\u77E5\u65E5\u671F';
                    const date = new Date(timestamp);
                    return date.toLocaleDateString('zh-TW', { 
                        year: 'numeric', 
                        month: 'short', 
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                };
                
                modal.innerHTML = \`
                    <div class="trip-list-content">
                        <div class="trip-list-header">
                            <h3 class="trip-list-title">\u6211\u7684\u884C\u7A0B</h3>
                            <button class="trip-list-close" data-action="close-trip-list">\xD7</button>
                        </div>
                        <div class="trip-list-body">
                            \${trips.map(trip => \`
                                <div class="trip-list-item" data-trip-id="\${trip.id}" data-action="load-trip">
                                    <div class="trip-list-item-title">\${trip.title || '\u672A\u547D\u540D\u884C\u7A0B'}</div>
                                    <div class="trip-list-item-meta">
                                        \u66F4\u65B0\u6642\u9593\uFF1A\${formatDate(trip.updated_at)}
                                    </div>
                                </div>
                            \`).join('')}
                        </div>
                    </div>
                \`;
                
                modal.classList.add('visible');
                
                // \u7D81\u5B9A\u4E8B\u4EF6
                modal.querySelectorAll('[data-action="load-trip"]').forEach(item => {
                    item.addEventListener('click', (e) => {
                        const tripId = e.currentTarget.dataset.tripId;
                        if (tripId) {
                            this.loadTrip(tripId);
                            modal.classList.remove('visible');
                        }
                    });
                });
                
                modal.querySelector('[data-action="close-trip-list"]').addEventListener('click', () => {
                    modal.classList.remove('visible');
                });
                
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.classList.remove('visible');
                    }
                });
            }

            // \u8F09\u5165\u5DF2\u5132\u5B58\u7684\u884C\u7A0B
            async loadTrip(tripId) {
                try {
                    this.showLoadingState('\u8F09\u5165\u884C\u7A0B\u4E2D...');
                    
                    // \u5F9E API \u7372\u53D6\u884C\u7A0B\u8CC7\u6599
                    const response = await fetch(\`/api/trip-planner/\${tripId}\`, {
                        credentials: 'include'
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        throw new Error(errorData.error || '\u7121\u6CD5\u8F09\u5165\u884C\u7A0B');
                    }
                    
                    const result = await response.json();
                    
                    if (!result.success || !result.trip) {
                        throw new Error('\u884C\u7A0B\u8CC7\u6599\u683C\u5F0F\u932F\u8AA4');
                    }
                    
                    const tripData = result.trip;
                    
                    // \u6E05\u7A7A\u73FE\u6709\u884C\u7A0B
                    this.clearCurrentTrip();
                    
                    // \u8A2D\u5B9A\u884C\u7A0B ID \u548C\u5206\u4EAB\u4EE4\u724C
                    this.currentTripId = tripData.id;
                    this.shareToken = tripData.shareToken || null;
                    
                    // \u8F09\u5165\u6BCF\u4E00\u5929\u7684\u5730\u9EDE
                    if (tripData.days && tripData.days.length > 0) {
                        // \u521D\u59CB\u5316\u5929\u6578\u9663\u5217
                        this.days = [];
                        
                        for (let dayIndex = 0; dayIndex < tripData.days.length; dayIndex++) {
                            const day = tripData.days[dayIndex];
                            
                            // \u89E3\u6790\u65E5\u671F\uFF08\u5982\u679C\u6709\u7684\u8A71\uFF09
                            let dayDate = new Date();
                            if (day.date) {
                                dayDate = new Date(day.date);
                                if (isNaN(dayDate.getTime())) {
                                    dayDate = new Date();
                                }
                            }
                            this.days.push(dayDate);
                            
                            // \u8F09\u5165\u8A72\u5929\u7684\u5730\u9EDE
                            if (day.places && day.places.length > 0) {
                                for (const placeItem of day.places) {
                                    try {
                                        // \u7372\u53D6\u5730\u9EDE\u8A73\u60C5
                                        const placeDetailsResponse = await fetch(\`/api/locations/details-by-placeid/\${placeItem.placeId}\`, {
                                            credentials: 'include'
                                        });
                                        
                                        if (!placeDetailsResponse.ok) {
                                            console.warn(\`\u7121\u6CD5\u8F09\u5165\u5730\u9EDE\u8A73\u60C5: \${placeItem.placeId}\`);
                                            continue;
                                        }
                                        
                                        const placeData = await placeDetailsResponse.json();
                                        
                                        // \u6DFB\u52A0\u5230\u884C\u7A0B
                                        const place = {
                                            placeId: placeItem.placeId,
                                            placeData: placeData,
                                            dayIndex: dayIndex,
                                            time: placeItem.time || '09:00',
                                            order: placeItem.order || 0,
                                            bookingStatus: placeItem.bookingStatus || 'planned',
                                            bookingUrl: placeItem.bookingUrl || null,
                                            bookingPhone: placeItem.bookingPhone || null,
                                            bookingNotes: placeItem.bookingNotes || null,
                                            itemId: placeItem.id || null
                                        };
                                        
                                        this.selectedPlaces.push(place);
                                        
                                        // \u5728\u5730\u5716\u4E0A\u6DFB\u52A0\u6A19\u8A18
                                        this.addMarker(placeData, place);
                                    } catch (error) {
                                        console.error(\`\u8F09\u5165\u5730\u9EDE\u5931\u6557: \${placeItem.placeId}\`, error);
                                    }
                                }
                            }
                        }
                        
                        // \u5982\u679C\u6C92\u6709\u5929\u6578\uFF0C\u81F3\u5C11\u6DFB\u52A0\u4E00\u500B
                        if (this.days.length === 0) {
                            this.days = [new Date()];
                        }
                        
                        // \u8A2D\u5B9A\u7576\u524D\u5929\u6578\u7D22\u5F15
                        this.currentDayIndex = 0;
                    }
                    
                    // \u66F4\u65B0 UI
                    this.updateDayTabs();
                    this.updateTripPanel();
                    this.updateSelectedCount();
                    this.updateSaveButton();
                    this.updateRoute(); // \u66F4\u65B0\u8DEF\u7DDA
                    
                    // \u66F4\u65B0\u65E5\u671F\u9078\u64C7\u5668
                    const dateInput = document.getElementById('current-day-date');
                    if (dateInput && this.days.length > 0) {
                        dateInput.value = this.formatDateInput(this.days[0]);
                    }
                    
                    // \u96B1\u85CF\u8F09\u5165\u72C0\u614B
                    this.hideLoadingState();
                    
                    this.showMessage('\u884C\u7A0B\u8F09\u5165\u6210\u529F', 'success');
                    console.log('\u884C\u7A0B\u8F09\u5165\u6210\u529F:', tripData);
                } catch (error) {
                    console.error('\u8F09\u5165\u884C\u7A0B\u5931\u6557:', error);
                    this.showError(\`\u8F09\u5165\u884C\u7A0B\u5931\u6557: \${error.message}\`);
                    this.hideLoadingState();
                }
            }

            // \u986F\u793A\u8A0A\u606F
            showMessage(text, type = 'info') {
                // \u7C21\u55AE\u7684\u8A0A\u606F\u986F\u793A\uFF0C\u53EF\u4EE5\u6539\u9032
                console.log(\`[\${type}] \${text}\`);
                const messageArea = document.getElementById('map-message-area');
                if (messageArea) {
                    messageArea.textContent = text;
                    messageArea.className = 'absolute bottom-4 left-4 text-sm px-2 py-1 rounded shadow-sm z-20 ' + 
                        (type === 'error' ? 'bg-red-100 text-red-700' : 
                         type === 'success' ? 'bg-green-100 text-green-700' : 
                         type === 'warning' ? 'bg-yellow-100 text-yellow-700' : 
                         'bg-white text-gray-500');
                    setTimeout(() => {
                        messageArea.textContent = '\u9EDE\u64CA\u5730\u5716\u4E0A\u7684\u5716\u793A\u4EE5\u9078\u64C7\u5730\u6A19\u52A0\u5165\u884C\u7A0B';
                        messageArea.className = 'absolute bottom-4 left-4 text-sm text-gray-500 bg-white bg-opacity-90 px-2 py-1 rounded shadow-sm z-20';
                    }, 3000);
                }
            }

            // \u5132\u5B58\u884C\u7A0B
            async saveTrip() {
                const saveBtn = document.getElementById('save-trip-btn');
                if (!saveBtn) return;

                saveBtn.disabled = true;
                saveBtn.textContent = '\u5132\u5B58\u4E2D...';

                try {
                    const tripData = {
                        tripId: this.currentTripId, // \u5982\u679C\u6709\uFF0C\u5247\u66F4\u65B0\uFF1B\u5426\u5247\u5275\u5EFA\u65B0\u884C\u7A0B
                        title: \`\u6F8E\u6E56\u884C\u7A0B - \${this.formatDate(this.days[0])}\`,
                        shareToken: this.shareToken,
                        isPublic: false,
                        days: this.days.map((day, dayIndex) => ({
                            date: this.formatDateInput(day),
                            places: this.selectedPlaces
                                .filter(p => p.dayIndex === dayIndex)
                                .sort((a, b) => {
                                    if (a.time !== b.time) {
                                        return a.time.localeCompare(b.time);
                                    }
                                    return a.order - b.order;
                                })
                                .map(p => ({
                                    placeId: p.placeId,
                                    time: p.time,
                                    order: p.order,
                                    bookingStatus: p.bookingStatus || 'planned',
                                    bookingUrl: p.bookingUrl || null,
                                    bookingPhone: p.bookingPhone || null,
                                    bookingNotes: p.bookingNotes || null
                                }))
                        }))
                    };

                    const response = await fetch('/api/trip-planner/save', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(tripData),
                        credentials: 'include'
                    });

                    if (response.ok) {
                        const result = await response.json();
                        this.showMessage('\u884C\u7A0B\u5DF2\u5132\u5B58', 'success');
                        if (result.tripId) {
                            this.currentTripId = result.tripId;
                            // \u66F4\u65B0\u4FDD\u5B58\u6309\u9215\u72C0\u614B
                            this.updateSaveButton();
                            console.log('Trip saved with ID:', result.tripId);
                        }
                    } else {
                        const error = await response.json().catch(() => ({ error: '\u5132\u5B58\u5931\u6557' }));
                        throw new Error(error.error || '\u5132\u5B58\u5931\u6557');
                    }
                } catch (error) {
                    console.error('Error saving trip:', error);
                    this.showMessage('\u5132\u5B58\u5931\u6557: ' + error.message, 'error');
                } finally {
                    saveBtn.disabled = false;
                    saveBtn.textContent = '\u5132\u5B58\u884C\u7A0B';
                }
            }

            // \u521D\u59CB\u5316\u4E8B\u4EF6\u76E3\u807D\u5668
            initEventListeners() {
                const addDayBtn = document.getElementById('add-day-btn');
                if (addDayBtn) {
                    addDayBtn.addEventListener('click', () => this.addDay());
                }

                const loadTripBtn = document.getElementById('load-trip-btn');
                if (loadTripBtn) {
                    loadTripBtn.addEventListener('click', () => this.showTripList());
                }

                const saveBtn = document.getElementById('save-trip-btn');
                if (saveBtn) {
                    saveBtn.addEventListener('click', () => this.saveTrip());
                }

                const shareBtn = document.getElementById('share-trip-btn');
                if (shareBtn) {
                    shareBtn.addEventListener('click', () => this.shareTrip());
                }

                const dateInput = document.getElementById('current-day-date');
                if (dateInput) {
                    dateInput.value = this.formatDateInput(this.days[0]);
                    dateInput.addEventListener('change', (e) => {
                        const newDate = new Date(e.target.value);
                        this.days[this.currentDayIndex] = newDate;
                        this.updateDayTabs();
                    });
                }
            }

            // \u6AA2\u67E5 URL \u53C3\u6578\u4E26\u8F09\u5165\u884C\u7A0B
            checkUrlParams() {
                const urlParams = new URLSearchParams(window.location.search);
                const tripId = urlParams.get('id');
                if (tripId) {
                    // \u7B49\u5F85\u5730\u5716\u521D\u59CB\u5316\u5B8C\u6210\u5F8C\u518D\u8F09\u5165\u884C\u7A0B
                    const checkMapReady = () => {
                        if (this.map) {
                            this.loadTrip(tripId);
                        } else {
                            // \u5982\u679C\u5730\u5716\u9084\u6C92\u521D\u59CB\u5316\uFF0C\u7B49\u5F85\u4E00\u4E0B\u518D\u8A66
                            setTimeout(checkMapReady, 500);
                        }
                    };
                    // \u7D66\u5730\u5716\u4E00\u9EDE\u6642\u9593\u521D\u59CB\u5316
                    setTimeout(checkMapReady, 1000);
                }
            }
        }

        // \u5275\u5EFA\u5168\u5C40\u5BE6\u4F8B
        let tripPlanner = null;

        // \u521D\u59CB\u5316
        document.addEventListener('DOMContentLoaded', () => {
            tripPlanner = new TripPlanner();
            tripPlanner.initMap();
            tripPlanner.initEventListeners();
            // \u6AA2\u67E5 URL \u53C3\u6578\u4E26\u8F09\u5165\u884C\u7A0B\uFF08\u5982\u679C\u6709\u7684\u8A71\uFF09
            tripPlanner.checkUrlParams();
        });
    </script>
  `;
  const csp = [
    "default-src 'self'",
    `script-src 'self' 'nonce-${nonce}' 'unsafe-inline' 'unsafe-eval' https://apis.google.com https://maps.googleapis.com https://accounts.google.com https://ajax.googleapis.com`,
    `style-src 'self' https://fonts.googleapis.com https://maps.googleapis.com https://maps.gstatic.com 'nonce-${nonce}' 'unsafe-inline'`,
    `style-src-attr 'unsafe-inline'`,
    "font-src 'self' data: https://fonts.gstatic.com",
    "img-src 'self' data: https: https://www.gstatic.com https://maps.googleapis.com https://maps.gstatic.com",
    "connect-src 'self' https://apis.google.com https://accounts.google.com https://maps.googleapis.com https://www.googleapis.com https://oauth2.googleapis.com https://generativelanguage.googleapis.com https://api.openai.com https://*.googleapis.com https://*.gstatic.com",
    "frame-src 'self' https://accounts.google.com",
    "base-uri 'self'",
    "form-action 'self'",
    "frame-ancestors 'none'",
    "object-src 'none'"
  ].join("; ");
  const securityHeaders = {
    "Content-Security-Policy": csp,
    "X-Content-Type-Options": "nosniff",
    "X-Frame-Options": "DENY",
    "X-XSS-Protection": "1; mode=block",
    "Referrer-Policy": "strict-origin-when-cross-origin",
    "Permissions-Policy": "geolocation=(), microphone=(), camera=()"
  };
  return new Response(pageTemplate2({
    title: "\u884C\u7A0B\u898F\u5283 - \u597D\u6F8E\u6E56",
    content,
    user,
    nonce,
    cssContent: cssContent + `
      body { overflow-x: hidden; }
    `,
    currentPath: url.pathname
  }), {
    headers: {
      "Content-Type": "text/html;charset=utf-8",
      "Cache-Control": "no-cache, no-store, must-revalidate",
      ...securityHeaders
    }
  });
}
async function renderSharedTripPage(request, env, session, user, nonce, cssContent, shareToken) {
  const url = new URL(request.url);
  try {
    const response = await fetch(`${url.origin}/api/trip-planner/shared/${shareToken}`);
    if (!response.ok) {
      return new Response(pageTemplate2({
        title: "\u884C\u7A0B\u4E0D\u5B58\u5728 - \u597D\u6F8E\u6E56",
        content: '<div class="p-8 text-center"><h1 class="text-2xl font-bold mb-4">\u884C\u7A0B\u4E0D\u5B58\u5728\u6216\u5DF2\u53D6\u6D88\u5206\u4EAB</h1><p class="text-gray-600">\u6B64\u884C\u7A0B\u9023\u7D50\u53EF\u80FD\u5DF2\u5931\u6548\u3002</p></div>',
        user: null,
        nonce,
        cssContent,
        currentPath: url.pathname
      }), {
        headers: { "Content-Type": "text/html;charset=utf-8" }
      });
    }
    const result = await response.json();
    const trip = result.trip;
    const locationService = new (await Promise.resolve().then(() => (init_LocationService(), LocationService_exports))).LocationService(
      env.DB,
      env.GOOGLE_MAPS_API_KEY
    );
    const daysWithPlaces = await Promise.all(
      trip.days.map(async (day) => {
        const places = await Promise.all(
          day.places.map(async (place) => {
            try {
              const placeDetails = await locationService.getLocationByGooglePlaceId(place.placeId);
              return {
                ...place,
                placeData: placeDetails || { name: "\u672A\u77E5\u5730\u9EDE", address: "" }
              };
            } catch (error) {
              console.error("Error fetching place details:", error);
              return {
                ...place,
                placeData: { name: "\u672A\u77E5\u5730\u9EDE", address: "" }
              };
            }
          })
        );
        return { ...day, places };
      })
    );
    const content = `
      <div class="max-w-4xl mx-auto p-6">
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
          <h1 class="text-3xl font-bold text-gray-800 mb-2">${trip.title || "\u6F8E\u6E56\u884C\u7A0B"}</h1>
          <p class="text-gray-600 text-sm">\u5206\u4EAB\u7684\u884C\u7A0B</p>
        </div>

        ${daysWithPlaces.map((day, dayIndex) => `
          <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">\u7B2C ${dayIndex + 1} \u5929</h2>
            <div class="space-y-4">
              ${day.places.map((place, placeIndex) => {
      const placeData = place.placeData || {};
      const statusLabels = {
        "planned": { text: "\u5DF2\u898F\u5283", class: "bg-yellow-100 text-yellow-800", icon: "\u{1F7E1}" },
        "booked": { text: "\u5DF2\u9810\u8A02", class: "bg-green-100 text-green-800", icon: "\u{1F7E2}" },
        "completed": { text: "\u5DF2\u5B8C\u6210", class: "bg-blue-100 text-blue-800", icon: "\u2705" },
        "cancelled": { text: "\u5DF2\u53D6\u6D88", class: "bg-red-100 text-red-800", icon: "\u{1F534}" }
      };
      const statusInfo = statusLabels[place.bookingStatus] || statusLabels["planned"];
      return `
                  <div class="border border-gray-200 rounded-lg p-4">
                    <div class="flex items-start justify-between mb-2">
                      <div class="flex-1">
                        <h3 class="text-lg font-semibold text-gray-800">${placeData.name || "\u672A\u77E5\u5730\u9EDE"}</h3>
                        <p class="text-sm text-gray-600 mt-1">${placeData.address || "\u7121\u5730\u5740"}</p>
                      </div>
                      <div class="ml-4">
                        <span class="booking-status-badge ${statusInfo.class} px-2 py-1 rounded text-xs">
                          ${statusInfo.icon} ${statusInfo.text}
                        </span>
                      </div>
                    </div>
                    <div class="mt-2 text-sm text-gray-500">
                      <span class="font-medium">\u6642\u9593\uFF1A</span>${place.time || "\u672A\u8A2D\u5B9A"}
                    </div>
                  </div>
                `;
    }).join("")}
            </div>
          </div>
        `).join("")}

        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 text-center">
          <p class="text-blue-800">\u60F3\u8981\u898F\u5283\u81EA\u5DF1\u7684\u884C\u7A0B\u55CE\uFF1F</p>
          <a href="/trip-planner" class="inline-block mt-2 bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-6 rounded">
            \u958B\u59CB\u898F\u5283\u884C\u7A0B
          </a>
        </div>
      </div>
    `;
    const securityService = new SecurityService();
    const securityHeaders = securityService.getCSPHeaders();
    return new Response(pageTemplate2({
      title: `${trip.title || "\u884C\u7A0B"} - \u597D\u6F8E\u6E56`,
      content,
      user: null,
      nonce,
      cssContent: cssContent + `
        .booking-status-badge {
          display: inline-block;
          padding: 4px 8px;
          border-radius: 4px;
          font-size: 0.75rem;
          font-weight: 500;
        }
      `,
      currentPath: url.pathname
    }), {
      headers: {
        "Content-Type": "text/html;charset=utf-8",
        "Cache-Control": "no-cache, no-store, must-revalidate",
        ...securityHeaders
      }
    });
  } catch (error) {
    console.error("[SharedTripPage] Error:", error);
    return new Response(pageTemplate2({
      title: "\u932F\u8AA4 - \u597D\u6F8E\u6E56",
      content: '<div class="p-8 text-center"><h1 class="text-2xl font-bold mb-4">\u8F09\u5165\u884C\u7A0B\u6642\u767C\u751F\u932F\u8AA4</h1><p class="text-gray-600">\u8ACB\u7A0D\u5F8C\u518D\u8A66\u3002</p></div>',
      user: null,
      nonce,
      cssContent,
      currentPath: url.pathname
    }), {
      headers: { "Content-Type": "text/html;charset=utf-8" }
    });
  }
}
var init_TripPlanner = __esm({
  "src/pages/TripPlanner.js"() {
    "use strict";
    init_layout();
    init_SecurityService();
  }
});

// src/services/ImageDownloadService.js
var ImageDownloadService;
var init_ImageDownloadService = __esm({
  "src/services/ImageDownloadService.js"() {
    "use strict";
    init_LocationService();
    ImageDownloadService = class {
      constructor(db, googleMapsApiKey) {
        this.db = db;
        this.googleMapsApiKey = googleMapsApiKey;
        this.cacheExpiryDays = 30;
      }
      /**
       * 下載並存儲Google Places圖片
       * @param {string} googlePlaceId 
       * @param {string} locationId 
       * @returns {Promise<object>} 下載結果
       */
      async downloadAndStoreImage(googlePlaceId, locationId) {
        try {
          if (!this.googleMapsApiKey) {
            throw new Error("Google Maps API key not available");
          }
          const locationService = new LocationService(this.db, this.googleMapsApiKey);
          const locationDetails = await locationService.fetchPlaceDetails(googlePlaceId);
          if (!locationDetails || !locationDetails.photoUrls || locationDetails.photoUrls.length === 0) {
            return {
              success: false,
              message: "No photos available from Google Places API"
            };
          }
          const googleImageUrl = locationDetails.photoUrls[0];
          const imageResponse = await fetch(googleImageUrl);
          if (!imageResponse.ok) {
            return {
              success: false,
              message: "Failed to download image from Google Places API"
            };
          }
          const imageBuffer = await imageResponse.arrayBuffer();
          const base64Image = this.arrayBufferToBase64(imageBuffer);
          const contentType = imageResponse.headers.get("content-type") || "image/jpeg";
          const localImageUrl = `data:${contentType};base64,${base64Image}`;
          await this.updateLocationThumbnail(locationId, localImageUrl);
          await this.recordDownloadHistory(googlePlaceId, locationId, googleImageUrl, localImageUrl);
          return {
            success: true,
            localImageUrl,
            originalGoogleUrl: googleImageUrl,
            message: "Image downloaded and stored successfully"
          };
        } catch (error) {
          console.error(`[ImageDownloadService] Error downloading image for location ${locationId}:`, error);
          return {
            success: false,
            error: error.message,
            message: "Failed to download and store image"
          };
        }
      }
      /**
       * 批量下載所有地點的圖片
       * @returns {Promise<object>} 批量下載結果
       */
      async downloadAllLocationImages() {
        try {
          const stmt = this.db.prepare(`
                SELECT id, google_place_id, name 
                FROM locations 
                WHERE google_place_id IS NOT NULL 
                AND (thumbnail_url IS NULL OR thumbnail_url LIKE '%maps.googleapis.com%')
                ORDER BY created_at DESC
            `);
          const { results } = await stmt.all();
          if (!results || results.length === 0) {
            return {
              success: true,
              total: 0,
              downloaded: 0,
              failed: 0,
              message: "No locations need image download"
            };
          }
          let downloaded = 0;
          let failed = 0;
          for (const location of results) {
            try {
              const result = await this.downloadAndStoreImage(location.google_place_id, location.id);
              if (result.success) {
                downloaded++;
                console.log(`[ImageDownloadService] Downloaded image for: ${location.name}`);
              } else {
                failed++;
                console.error(`[ImageDownloadService] Failed to download image for: ${location.name}`);
              }
            } catch (error) {
              failed++;
              console.error(`[ImageDownloadService] Error downloading image for ${location.name}:`, error);
            }
          }
          return {
            success: true,
            total: results.length,
            downloaded,
            failed,
            message: `Downloaded ${downloaded} out of ${results.length} images`
          };
        } catch (error) {
          console.error("[ImageDownloadService] Error in batch download:", error);
          return {
            success: false,
            error: error.message,
            message: "Batch download failed"
          };
        }
      }
      /**
       * 更新地點的縮略圖URL
       * @param {string} locationId 
       * @param {string} thumbnailUrl 
       */
      async updateLocationThumbnail(locationId, thumbnailUrl) {
        const stmt = this.db.prepare("UPDATE locations SET thumbnail_url = ? WHERE id = ?");
        await stmt.bind(thumbnailUrl, locationId).run();
      }
      /**
       * 記錄下載歷史
       * @param {string} googlePlaceId 
       * @param {string} locationId 
       * @param {string} originalUrl 
       * @param {string} localUrl 
       */
      async recordDownloadHistory(googlePlaceId, locationId, originalUrl, localUrl) {
        try {
          const stmt = this.db.prepare(`
                INSERT INTO image_download_history 
                (google_place_id, location_id, original_url, local_url, downloaded_at)
                VALUES (?, ?, ?, ?, datetime('now'))
            `);
          await stmt.bind(googlePlaceId, locationId, originalUrl, localUrl).run();
        } catch (error) {
          console.error("[ImageDownloadService] Error recording download history:", error);
        }
      }
      /**
       * 將ArrayBuffer轉換為base64
       * @param {ArrayBuffer} buffer 
       * @returns {string}
       */
      arrayBufferToBase64(buffer) {
        const bytes = new Uint8Array(buffer);
        let binary = "";
        for (let i = 0; i < bytes.byteLength; i++) {
          binary += String.fromCharCode(bytes[i]);
        }
        return btoa(binary);
      }
      /**
       * 獲取下載統計
       * @returns {Promise<object>}
       */
      async getDownloadStats() {
        try {
          const totalStmt = this.db.prepare("SELECT COUNT(*) as total FROM locations WHERE google_place_id IS NOT NULL");
          const totalResult = await totalStmt.first();
          const downloadedStmt = this.db.prepare(`
                SELECT COUNT(*) as downloaded 
                FROM locations 
                WHERE google_place_id IS NOT NULL 
                AND thumbnail_url IS NOT NULL 
                AND thumbnail_url != '' 
                AND thumbnail_url NOT LIKE '%maps.googleapis.com%'
                AND thumbnail_url NOT LIKE '%placehold.co%'
            `);
          const downloadedResult = await downloadedStmt.first();
          const needsDownloadStmt = this.db.prepare(`
                SELECT COUNT(*) as needs_download 
                FROM locations 
                WHERE google_place_id IS NOT NULL 
                AND (thumbnail_url IS NULL OR thumbnail_url LIKE '%maps.googleapis.com%')
            `);
          const needsDownloadResult = await needsDownloadStmt.first();
          return {
            total: (totalResult == null ? void 0 : totalResult.total) || 0,
            downloaded: (downloadedResult == null ? void 0 : downloadedResult.downloaded) || 0,
            needsDownload: (needsDownloadResult == null ? void 0 : needsDownloadResult.needs_download) || 0
          };
        } catch (error) {
          console.error("[ImageDownloadService] Error getting download stats:", error);
          return {
            total: 0,
            downloaded: 0,
            needsDownload: 0
          };
        }
      }
    };
  }
});

// src/services/R2ImageService.js
var R2ImageService_exports = {};
__export(R2ImageService_exports, {
  R2ImageService: () => R2ImageService
});
var R2ImageService;
var init_R2ImageService = __esm({
  "src/services/R2ImageService.js"() {
    "use strict";
    init_LocationService();
    R2ImageService = class {
      constructor(db, googleMapsApiKey, r2Bucket = null) {
        if (!db) {
          throw new Error("Database connection is required for R2ImageService");
        }
        this.db = db;
        this.googleMapsApiKey = googleMapsApiKey;
        this.r2Bucket = r2Bucket;
        this.locationService = new LocationService(db, googleMapsApiKey);
      }
      /**
       * 下載並存儲圖片到 R2
       * @param {string} locationId - 地點 ID
       * @param {string} googlePlaceId - Google Place ID
       * @param {number} version - 圖片版本號（可選）
       * @returns {Promise<object>} 下載結果
       */
      async downloadAndStoreImage(locationId, googlePlaceId, version = null) {
        try {
          if (!this.r2Bucket) {
            console.warn("[R2ImageService] R2 bucket not configured, using fallback method");
            return await this.downloadAndStoreImageFallback(locationId, googlePlaceId);
          }
          const locationDetails = await this.locationService.fetchPlaceDetails(googlePlaceId);
          if (!locationDetails || !locationDetails.photoUrls || locationDetails.photoUrls.length === 0) {
            return {
              success: false,
              message: "No photos available from Google Places API"
            };
          }
          const googleImageUrl = locationDetails.photoUrls[0];
          const imageResponse = await fetch(googleImageUrl);
          if (!imageResponse.ok) {
            return {
              success: false,
              message: "Failed to download image from Google Places API"
            };
          }
          const imageBuffer = await imageResponse.arrayBuffer();
          const contentType = imageResponse.headers.get("content-type") || "image/jpeg";
          const imageKey = this.generateImageKey(locationId, googlePlaceId, version);
          await this.r2Bucket.put(imageKey, imageBuffer, {
            httpMetadata: {
              contentType,
              cacheControl: "public, max-age=31536000"
              // 1 年緩存
            },
            customMetadata: {
              locationId,
              googlePlaceId,
              version: version ? version.toString() : "1",
              downloadedAt: (/* @__PURE__ */ new Date()).toISOString()
            }
          });
          const publicUrl = this.getPublicUrl(imageKey);
          await this.updateLocationThumbnail(locationId, publicUrl, version);
          await this.recordDownloadHistory(locationId, googlePlaceId, googleImageUrl, publicUrl, imageBuffer.byteLength, contentType);
          return {
            success: true,
            url: publicUrl,
            key: imageKey,
            size: imageBuffer.byteLength,
            contentType
          };
        } catch (error) {
          console.error("[R2ImageService] Error downloading and storing image:", error);
          throw error;
        }
      }
      /**
       * 降級方案：如果 R2 不可用，使用資料庫存儲
       */
      async downloadAndStoreImageFallback(locationId, googlePlaceId) {
        try {
          const locationDetails = await this.locationService.fetchPlaceDetails(googlePlaceId);
          if (!locationDetails || !locationDetails.photoUrls || locationDetails.photoUrls.length === 0) {
            return {
              success: false,
              message: "No photos available from Google Places API"
            };
          }
          const googleImageUrl = locationDetails.photoUrls[0];
          const imageResponse = await fetch(googleImageUrl);
          if (!imageResponse.ok) {
            return {
              success: false,
              message: "Failed to download image"
            };
          }
          const proxyUrl = `/api/image/proxy/?url=${encodeURIComponent(googleImageUrl)}`;
          await this.updateLocationThumbnail(locationId, proxyUrl, null);
          return {
            success: true,
            url: proxyUrl,
            key: null,
            size: 0,
            contentType: imageResponse.headers.get("content-type") || "image/jpeg"
          };
        } catch (error) {
          console.error("[R2ImageService] Error in fallback method:", error);
          throw error;
        }
      }
      /**
       * 生成圖片鍵（用於 R2 存儲）
       * @param {string} locationId - 地點 ID
       * @param {string} googlePlaceId - Google Place ID
       * @param {number} version - 版本號
       * @returns {string}
       */
      generateImageKey(locationId, googlePlaceId, version = null) {
        const timestamp = Date.now();
        const versionStr = version ? `v${version}` : "v1";
        return `locations/${locationId}/${googlePlaceId}_${versionStr}_${timestamp}.jpg`;
      }
      /**
       * 獲取公開 URL
       * @param {string} key - R2 物件鍵
       * @returns {string}
       */
      getPublicUrl(key) {
        return `/api/image/r2/${encodeURIComponent(key)}`;
      }
      /**
       * 更新地點縮圖
       * @param {string} locationId - 地點 ID
       * @param {string} thumbnailUrl - 縮圖 URL
       * @param {number} version - 版本號
       */
      async updateLocationThumbnail(locationId, thumbnailUrl, version) {
        try {
          await this.db.prepare(
            `UPDATE locations 
         SET thumbnail_url = ?, updated_at = datetime('now')
         WHERE id = ?`
          ).bind(thumbnailUrl, locationId).run();
          if (version) {
            await this.db.prepare(
              `INSERT OR REPLACE INTO image_versions (location_id, version, url, created_at)
           VALUES (?, ?, ?, datetime('now'))`
            ).bind(locationId, version, thumbnailUrl).run();
          }
        } catch (error) {
          console.error("[R2ImageService] Error updating thumbnail:", error);
          throw error;
        }
      }
      /**
       * 記錄下載歷史
       */
      async recordDownloadHistory(locationId, googlePlaceId, originalUrl, localUrl, fileSize, contentType) {
        try {
          await this.db.prepare(
            `INSERT INTO image_download_history 
         (google_place_id, location_id, original_url, local_url, downloaded_at, file_size, content_type)
         VALUES (?, ?, ?, ?, datetime('now'), ?, ?)`
          ).bind(googlePlaceId, locationId, originalUrl, localUrl, fileSize, contentType).run();
        } catch (error) {
          console.error("[R2ImageService] Error recording download history:", error);
        }
      }
      /**
       * 獲取圖片版本列表
       * @param {string} locationId - 地點 ID
       * @returns {Promise<array>}
       */
      async getImageVersions(locationId) {
        try {
          const result = await this.db.prepare(
            `SELECT version, url, created_at
         FROM image_versions
         WHERE location_id = ?
         ORDER BY version DESC`
          ).bind(locationId).all();
          return result.results || [];
        } catch (error) {
          console.error("[R2ImageService] Error getting image versions:", error);
          return [];
        }
      }
      /**
       * 獲取需要更新的圖片列表（過期或缺失的圖片）
       * @param {number} limit - 數量限制
       * @returns {Promise<array>}
       */
      async getImagesNeedingUpdate(limit = 50) {
        try {
          const result = await this.db.prepare(
            `SELECT l.id, l.google_place_id, l.thumbnail_url, l.updated_at
         FROM locations l
         WHERE l.google_place_id IS NOT NULL
           AND (
             l.thumbnail_url IS NULL 
             OR l.thumbnail_url = ''
             OR l.updated_at < datetime('now', '-30 days')
           )
         ORDER BY l.updated_at ASC NULLS FIRST
         LIMIT ?`
          ).bind(limit).all();
          return result.results || [];
        } catch (error) {
          console.error("[R2ImageService] Error getting images needing update:", error);
          return [];
        }
      }
      /**
       * 批量更新圖片
       * @param {number} batchSize - 批次大小
       * @returns {Promise<object>} 更新結果
       */
      async batchUpdateImages(batchSize = 10) {
        try {
          const imagesToUpdate = await this.getImagesNeedingUpdate(batchSize);
          const results = {
            total: imagesToUpdate.length,
            success: 0,
            failed: 0,
            errors: []
          };
          for (const image of imagesToUpdate) {
            try {
              const result = await this.downloadAndStoreImage(
                image.id,
                image.google_place_id,
                null
                // 使用當前版本
              );
              if (result.success) {
                results.success++;
              } else {
                results.failed++;
                results.errors.push({
                  locationId: image.id,
                  error: result.message
                });
              }
            } catch (error) {
              results.failed++;
              results.errors.push({
                locationId: image.id,
                error: error.message
              });
            }
          }
          return results;
        } catch (error) {
          console.error("[R2ImageService] Error in batch update:", error);
          throw error;
        }
      }
      /**
       * 從 R2 獲取圖片
       * @param {string} key - R2 物件鍵
       * @returns {Promise<Response|null>}
       */
      async getImageFromR2(key) {
        var _a, _b;
        try {
          if (!this.r2Bucket) {
            return null;
          }
          const object = await this.r2Bucket.get(key);
          if (!object) {
            return null;
          }
          return new Response(object.body, {
            headers: {
              "Content-Type": ((_a = object.httpMetadata) == null ? void 0 : _a.contentType) || "image/jpeg",
              "Cache-Control": ((_b = object.httpMetadata) == null ? void 0 : _b.cacheControl) || "public, max-age=31536000"
            }
          });
        } catch (error) {
          console.error("[R2ImageService] Error getting image from R2:", error);
          return null;
        }
      }
    };
  }
});

// src/utils/cacheMonitor.js
function getCacheStats(cacheKey) {
  if (!globalCacheStats.has(cacheKey)) {
    globalCacheStats.set(cacheKey, new CacheStats());
  }
  return globalCacheStats.get(cacheKey);
}
function recordCacheHit(cacheKey, responseTime = 0) {
  const stats = getCacheStats(cacheKey);
  stats.recordHit(responseTime);
  console.log(`[CacheMonitor] Hit for ${cacheKey}: ${stats.getHitRate() * 100}% hit rate`);
}
function recordCacheMiss(cacheKey, responseTime = 0) {
  const stats = getCacheStats(cacheKey);
  stats.recordMiss(responseTime);
  console.log(`[CacheMonitor] Miss for ${cacheKey}: ${stats.getHitRate() * 100}% hit rate`);
}
function getCacheStatsSummary(cacheKey = null) {
  if (cacheKey) {
    const stats = getCacheStats(cacheKey);
    return {
      [cacheKey]: stats.getSummary()
    };
  }
  const summary = {};
  for (const [key, stats] of globalCacheStats.entries()) {
    summary[key] = stats.getSummary();
  }
  return summary;
}
var CacheStats, globalCacheStats, PerformanceMetrics, performanceMetrics;
var init_cacheMonitor = __esm({
  "src/utils/cacheMonitor.js"() {
    "use strict";
    CacheStats = class {
      constructor() {
        this.hits = 0;
        this.misses = 0;
        this.total = 0;
        this.totalResponseTime = 0;
        this.cacheResponseTime = 0;
        this.missResponseTime = 0;
        this.startTime = Date.now();
      }
      /**
       * 記錄緩存命中
       * @param {number} responseTime - 響應時間（毫秒）
       */
      recordHit(responseTime = 0) {
        this.hits++;
        this.total++;
        this.totalResponseTime += responseTime;
        this.cacheResponseTime += responseTime;
      }
      /**
       * 記錄緩存未命中
       * @param {number} responseTime - 響應時間（毫秒）
       */
      recordMiss(responseTime = 0) {
        this.misses++;
        this.total++;
        this.totalResponseTime += responseTime;
        this.missResponseTime += responseTime;
      }
      /**
       * 獲取緩存命中率
       * @returns {number} 命中率（0-1）
       */
      getHitRate() {
        if (this.total === 0)
          return 0;
        return this.hits / this.total;
      }
      /**
       * 獲取平均響應時間
       * @returns {number} 平均響應時間（毫秒）
       */
      getAverageResponseTime() {
        if (this.total === 0)
          return 0;
        return this.totalResponseTime / this.total;
      }
      /**
       * 獲取緩存命中平均響應時間
       * @returns {number} 平均響應時間（毫秒）
       */
      getAverageCacheResponseTime() {
        if (this.hits === 0)
          return 0;
        return this.cacheResponseTime / this.hits;
      }
      /**
       * 獲取緩存未命中平均響應時間
       * @returns {number} 平均響應時間（毫秒）
       */
      getAverageMissResponseTime() {
        if (this.misses === 0)
          return 0;
        return this.missResponseTime / this.misses;
      }
      /**
       * 獲取統計摘要
       * @returns {object} 統計摘要對象
       */
      getSummary() {
        return {
          hits: this.hits,
          misses: this.misses,
          total: this.total,
          hitRate: this.getHitRate(),
          hitRatePercent: (this.getHitRate() * 100).toFixed(2) + "%",
          averageResponseTime: this.getAverageResponseTime().toFixed(2) + "ms",
          averageCacheResponseTime: this.getAverageCacheResponseTime().toFixed(2) + "ms",
          averageMissResponseTime: this.getAverageMissResponseTime().toFixed(2) + "ms",
          uptime: Date.now() - this.startTime,
          uptimeMinutes: ((Date.now() - this.startTime) / 6e4).toFixed(2) + " minutes"
        };
      }
      /**
       * 重置統計
       */
      reset() {
        this.hits = 0;
        this.misses = 0;
        this.total = 0;
        this.totalResponseTime = 0;
        this.cacheResponseTime = 0;
        this.missResponseTime = 0;
        this.startTime = Date.now();
      }
    };
    globalCacheStats = /* @__PURE__ */ new Map();
    PerformanceMetrics = class {
      constructor() {
        this.metrics = /* @__PURE__ */ new Map();
      }
      /**
       * 記錄性能指標
       * @param {string} metricName - 指標名稱
       * @param {number} value - 指標值
       * @param {object} tags - 可選標籤
       */
      record(metricName, value, tags = {}) {
        if (!this.metrics.has(metricName)) {
          this.metrics.set(metricName, {
            count: 0,
            sum: 0,
            min: Infinity,
            max: -Infinity,
            values: [],
            tags
          });
        }
        const metric = this.metrics.get(metricName);
        metric.count++;
        metric.sum += value;
        metric.min = Math.min(metric.min, value);
        metric.max = Math.max(metric.max, value);
        metric.values.push(value);
        if (metric.values.length > 1e3) {
          metric.values.shift();
        }
      }
      /**
       * 獲取指標統計
       * @param {string} metricName - 指標名稱
       * @returns {object} 統計對象
       */
      getStats(metricName) {
        if (!this.metrics.has(metricName)) {
          return null;
        }
        const metric = this.metrics.get(metricName);
        const avg = metric.sum / metric.count;
        const sorted = [...metric.values].sort((a, b) => a - b);
        const median = sorted.length % 2 === 0 ? (sorted[sorted.length / 2 - 1] + sorted[sorted.length / 2]) / 2 : sorted[Math.floor(sorted.length / 2)];
        return {
          name: metricName,
          count: metric.count,
          sum: metric.sum,
          average: avg,
          median,
          min: metric.min === Infinity ? 0 : metric.min,
          max: metric.max === -Infinity ? 0 : metric.max,
          tags: metric.tags
        };
      }
      /**
       * 獲取所有指標統計
       * @returns {object} 所有指標統計
       */
      getAllStats() {
        const stats = {};
        for (const metricName of this.metrics.keys()) {
          stats[metricName] = this.getStats(metricName);
        }
        return stats;
      }
      /**
       * 重置指標
       * @param {string} metricName - 指標名稱（可選）
       */
      reset(metricName = null) {
        if (metricName) {
          this.metrics.delete(metricName);
        } else {
          this.metrics.clear();
        }
      }
    };
    performanceMetrics = new PerformanceMetrics();
  }
});

// src/utils/logger.js
function createLogger(name) {
  return new Logger(name);
}
var LogLevel, LogLevelNames, LoggerConfig, loggerConfig, LogEntry, Logger, logger;
var init_logger = __esm({
  "src/utils/logger.js"() {
    "use strict";
    LogLevel = {
      DEBUG: 0,
      INFO: 1,
      WARN: 2,
      ERROR: 3,
      FATAL: 4
    };
    LogLevelNames = {
      [LogLevel.DEBUG]: "DEBUG",
      [LogLevel.INFO]: "INFO",
      [LogLevel.WARN]: "WARN",
      [LogLevel.ERROR]: "ERROR",
      [LogLevel.FATAL]: "FATAL"
    };
    LoggerConfig = class {
      constructor() {
        this.minLevel = LogLevel.INFO;
        this.enableConsole = true;
        this.enableDatabase = false;
        this.enablePerformanceLogging = true;
        this.enableErrorTracking = true;
        this.maxLogLength = 1e4;
      }
      /**
       * 設置最小日誌級別
       * @param {number} level - 日誌級別
       */
      setMinLevel(level) {
        this.minLevel = level;
      }
      /**
       * 啟用/禁用控制台輸出
       * @param {boolean} enable - 是否啟用
       */
      setConsoleOutput(enable) {
        this.enableConsole = enable;
      }
      /**
       * 啟用/禁用數據庫存儲
       * @param {boolean} enable - 是否啟用
       */
      setDatabaseStorage(enable) {
        this.enableDatabase = enable;
      }
    };
    loggerConfig = new LoggerConfig();
    LogEntry = class {
      constructor(level, message, context = {}) {
        var _a;
        this.timestamp = (/* @__PURE__ */ new Date()).toISOString();
        this.level = level;
        this.levelName = LogLevelNames[level];
        this.message = message;
        this.context = context;
        this.error = context.error || null;
        this.stack = ((_a = context.error) == null ? void 0 : _a.stack) || null;
        this.userId = context.userId || null;
        this.requestId = context.requestId || null;
        this.path = context.path || null;
        this.method = context.method || null;
        this.duration = context.duration || null;
        this.metadata = context.metadata || {};
      }
      /**
       * 轉換為 JSON 字符串
       * @returns {string}
       */
      toJSON() {
        return JSON.stringify({
          timestamp: this.timestamp,
          level: this.levelName,
          message: this.message,
          ...this.error && { error: this.error.message, stack: this.stack },
          ...this.userId && { userId: this.userId },
          ...this.requestId && { requestId: this.requestId },
          ...this.path && { path: this.path },
          ...this.method && { method: this.method },
          ...this.duration && { duration: `${this.duration}ms` },
          ...Object.keys(this.metadata).length > 0 && { metadata: this.metadata }
        });
      }
      /**
       * 轉換為控制台輸出格式
       * @returns {string}
       */
      toConsoleString() {
        const prefix = `[${this.levelName}] [${new Date(this.timestamp).toLocaleTimeString()}]`;
        let output = `${prefix} ${this.message}`;
        if (this.error) {
          output += `
  Error: ${this.error.message}`;
          if (this.stack) {
            output += `
  Stack: ${this.stack.split("\n").slice(0, 3).join("\n")}`;
          }
        }
        if (this.path) {
          output += `
  Path: ${this.method} ${this.path}`;
        }
        if (this.duration) {
          output += `
  Duration: ${this.duration}ms`;
        }
        if (Object.keys(this.metadata).length > 0) {
          output += `
  Metadata: ${JSON.stringify(this.metadata, null, 2)}`;
        }
        return output;
      }
    };
    Logger = class {
      constructor(name = "App") {
        this.name = name;
      }
      /**
       * 記錄日誌
       * @param {number} level - 日誌級別
       * @param {string} message - 日誌消息
       * @param {object} context - 上下文信息
       */
      log(level, message, context = {}) {
        if (level < loggerConfig.minLevel) {
          return;
        }
        if (message.length > loggerConfig.maxLogLength) {
          message = message.substring(0, loggerConfig.maxLogLength) + "... (truncated)";
        }
        const entry = new LogEntry(level, message, {
          ...context,
          logger: this.name
        });
        if (loggerConfig.enableConsole) {
          this._outputToConsole(entry);
        }
        if (loggerConfig.enableDatabase && context.db) {
          this._storeToDatabase(entry, context.db).catch((err) => {
            console.error("[Logger] Failed to store log to database:", err);
          });
        }
      }
      /**
       * 輸出到控制台
       * @param {LogEntry} entry - 日誌條目
       */
      _outputToConsole(entry) {
        const consoleMethod = this._getConsoleMethod(entry.level);
        consoleMethod(entry.toConsoleString());
      }
      /**
       * 獲取對應的控制台方法
       * @param {number} level - 日誌級別
       * @returns {Function}
       */
      _getConsoleMethod(level) {
        switch (level) {
          case LogLevel.DEBUG:
            return console.debug;
          case LogLevel.INFO:
            return console.info;
          case LogLevel.WARN:
            return console.warn;
          case LogLevel.ERROR:
          case LogLevel.FATAL:
            return console.error;
          default:
            return console.log;
        }
      }
      /**
       * 存儲到數據庫
       * @param {LogEntry} entry - 日誌條目
       * @param {object} db - 數據庫實例
       */
      async _storeToDatabase(entry, db) {
        var _a;
        try {
          const stmt = db.prepare(`
        INSERT INTO application_logs 
        (timestamp, level, message, error_message, stack, user_id, request_id, path, method, duration, metadata)
        VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
      `);
          await stmt.bind(
            entry.timestamp,
            entry.levelName,
            entry.message,
            ((_a = entry.error) == null ? void 0 : _a.message) || null,
            entry.stack || null,
            entry.userId || null,
            entry.requestId || null,
            entry.path || null,
            entry.method || null,
            entry.duration || null,
            JSON.stringify(entry.metadata)
          ).run();
        } catch (error) {
          console.error("[Logger] Database storage failed:", error);
        }
      }
      /**
       * 記錄調試信息
       */
      debug(message, context = {}) {
        this.log(LogLevel.DEBUG, message, context);
      }
      /**
       * 記錄信息
       */
      info(message, context = {}) {
        this.log(LogLevel.INFO, message, context);
      }
      /**
       * 記錄警告
       */
      warn(message, context = {}) {
        this.log(LogLevel.WARN, message, context);
      }
      /**
       * 記錄錯誤
       */
      error(message, error = null, context = {}) {
        this.log(LogLevel.ERROR, message, {
          ...context,
          error: error || new Error(message)
        });
      }
      /**
       * 記錄致命錯誤
       */
      fatal(message, error = null, context = {}) {
        this.log(LogLevel.FATAL, message, {
          ...context,
          error: error || new Error(message)
        });
      }
      /**
       * 記錄性能指標
       */
      performance(operation, duration, context = {}) {
        if (!loggerConfig.enablePerformanceLogging) {
          return;
        }
        this.log(LogLevel.INFO, `Performance: ${operation}`, {
          ...context,
          duration,
          metadata: {
            ...context.metadata,
            operation,
            performance: true
          }
        });
      }
      /**
       * 記錄 API 請求
       */
      apiRequest(method, path, duration, statusCode, context = {}) {
        const level = statusCode >= 500 ? LogLevel.ERROR : statusCode >= 400 ? LogLevel.WARN : LogLevel.INFO;
        this.log(level, `API Request: ${method} ${path} - ${statusCode}`, {
          ...context,
          method,
          path,
          duration,
          statusCode,
          metadata: {
            ...context.metadata,
            apiRequest: true
          }
        });
      }
      /**
       * 記錄數據庫查詢
       */
      databaseQuery(query, duration, context = {}) {
        if (!loggerConfig.enablePerformanceLogging) {
          return;
        }
        const level = duration > 1e3 ? LogLevel.WARN : LogLevel.DEBUG;
        this.log(level, `Database Query: ${query.substring(0, 100)}...`, {
          ...context,
          duration,
          metadata: {
            ...context.metadata,
            databaseQuery: true,
            query: query.substring(0, 500)
            // 限制查詢長度
          }
        });
      }
    };
    logger = createLogger("App");
  }
});

// src/utils/cacheHelper.js
function generateCacheKey(prefix, key, params = {}) {
  const paramString = Object.keys(params).sort().map((k) => `${k}=${params[k]}`).join("&");
  return paramString ? `${prefix}:${key}:${paramString}` : `${prefix}:${key}`;
}
async function getCachedResponse(request, cacheKey, cache) {
  try {
    const cacheUrl = new URL(request.url);
    cacheUrl.pathname = `/cache/${cacheKey}`;
    const cacheRequest = new Request(cacheUrl.toString(), request);
    const startTime = Date.now();
    const cachedResponse = await cache.match(cacheRequest);
    const responseTime = Date.now() - startTime;
    if (cachedResponse) {
      logger.debug(`Cache hit for key: ${cacheKey}`, {
        cacheKey,
        duration: responseTime,
        metadata: { cache: true }
      });
      recordCacheHit(cacheKey, responseTime);
      return cachedResponse;
    }
    logger.debug(`Cache miss for key: ${cacheKey}`, {
      cacheKey,
      duration: responseTime,
      metadata: { cache: false }
    });
    recordCacheMiss(cacheKey, responseTime);
    return null;
  } catch (error) {
    console.error(`[Cache] Error getting cached response for key ${cacheKey}:`, error);
    return null;
  }
}
async function setCachedResponse(request, response, cacheKey, ttl, cache, ctx = null) {
  try {
    const responseClone = response.clone();
    const headers = new Headers(responseClone.headers);
    headers.set("Cache-Control", `public, max-age=${ttl}`);
    headers.set("X-Cache-Key", cacheKey);
    headers.set("X-Cached-At", (/* @__PURE__ */ new Date()).toISOString());
    const cachedResponse = new Response(responseClone.body, {
      status: responseClone.status,
      statusText: responseClone.statusText,
      headers
    });
    const cacheUrl = new URL(request.url);
    cacheUrl.pathname = `/cache/${cacheKey}`;
    const cacheRequest = new Request(cacheUrl.toString(), request);
    const cacheStartTime = Date.now();
    if (ctx && ctx.waitUntil) {
      ctx.waitUntil(
        cache.put(cacheRequest, cachedResponse.clone()).then(() => {
          const cacheTime = Date.now() - cacheStartTime;
          logger.debug(`Cached response for key: ${cacheKey}`, {
            cacheKey,
            ttl,
            duration: cacheTime,
            metadata: { cache: true }
          });
        }).catch((err) => logger.error(`Error caching response for key ${cacheKey}`, err, {
          cacheKey,
          metadata: { cache: true }
        }))
      );
    } else {
      await cache.put(cacheRequest, cachedResponse);
      const cacheTime = Date.now() - cacheStartTime;
      logger.debug(`Cached response for key: ${cacheKey}`, {
        cacheKey,
        ttl,
        duration: cacheTime,
        metadata: { cache: true }
      });
    }
  } catch (error) {
    console.error(`[Cache] Error setting cached response for key ${cacheKey}:`, error);
  }
}
function withCache(handler, options = {}) {
  const {
    cacheKey = "api",
    ttl = 300,
    // 默認 5 分鐘
    keyGenerator = null,
    shouldCache = (response) => response.ok && response.status === 200
  } = options;
  return async (request, env, ...args) => {
    const cache = caches.default;
    let finalCacheKey;
    if (keyGenerator) {
      finalCacheKey = keyGenerator(request, ...args);
    } else {
      const url = new URL(request.url);
      const params = Object.fromEntries(url.searchParams.entries());
      finalCacheKey = generateCacheKey(cacheKey, url.pathname, params);
    }
    const cachedResponse = await getCachedResponse(request, finalCacheKey, cache);
    if (cachedResponse) {
      return cachedResponse;
    }
    const response = await handler(request, env, ...args);
    if (shouldCache(response)) {
      const ctx = args.find((arg) => arg && typeof arg.waitUntil === "function") || null;
      await setCachedResponse(request, response, finalCacheKey, ttl, cache, ctx);
    }
    return response;
  };
}
var CACHE_TTL;
var init_cacheHelper = __esm({
  "src/utils/cacheHelper.js"() {
    "use strict";
    init_cacheMonitor();
    init_logger();
    CACHE_TTL = {
      SHORT: 60,
      // 1 分鐘 - 用於頻繁變化的數據
      MEDIUM: 300,
      // 5 分鐘 - 用於一般數據
      LONG: 1800,
      // 30 分鐘 - 用於不經常變化的數據
      VERY_LONG: 3600,
      // 1 小時 - 用於靜態或很少變化的數據
      STATIC: 86400
      // 24 小時 - 用於幾乎不變化的數據
    };
  }
});

// src/services/ImageRefreshService.js
var ImageRefreshService_exports = {};
__export(ImageRefreshService_exports, {
  ImageRefreshService: () => ImageRefreshService
});
var ImageRefreshService;
var init_ImageRefreshService = __esm({
  "src/services/ImageRefreshService.js"() {
    "use strict";
    init_ImageCacheService();
    ImageRefreshService = class {
      constructor(db, locationService) {
        this.db = db;
        this.locationService = locationService;
        this.imageCacheService = new ImageCacheService(db);
      }
      /**
       * 批量刷新所有地點的圖片
       * @returns {Promise<object>} 刷新結果統計
       */
      async refreshAllLocationImages() {
        console.log("[ImageRefreshService] Starting batch refresh of all location images");
        try {
          const stmt = this.db.prepare(`
                SELECT id, google_place_id, name, thumbnail_url 
                FROM locations 
                ORDER BY created_at DESC
            `);
          const { results } = await stmt.all();
          if (!results || results.length === 0) {
            return {
              success: true,
              total: 0,
              refreshed: 0,
              failed: 0,
              message: "No locations found"
            };
          }
          let refreshed = 0;
          let failed = 0;
          for (const location of results) {
            try {
              if (location.google_place_id) {
                await this.refreshLocationImage(location.id, location.google_place_id);
              } else {
                const defaultImageUrl = this.imageCacheService.getDefaultImageUrl();
                await this.updateLocationThumbnail(location.id, defaultImageUrl);
              }
              refreshed++;
              console.log(`[ImageRefreshService] Refreshed image for location: ${location.name}`);
            } catch (error) {
              failed++;
              console.error(`[ImageRefreshService] Failed to refresh image for location ${location.name}:`, error);
            }
          }
          return {
            success: true,
            total: results.length,
            refreshed,
            failed,
            message: `Refreshed ${refreshed} out of ${results.length} locations`
          };
        } catch (error) {
          console.error("[ImageRefreshService] Error in batch refresh:", error);
          return {
            success: false,
            error: error.message,
            message: "Batch refresh failed"
          };
        }
      }
      /**
       * 刷新單個地點的圖片
       * @param {string} locationId 
       * @param {string} googlePlaceId 
       * @returns {Promise<object>} 刷新結果
       */
      async refreshLocationImage(locationId, googlePlaceId) {
        if (!locationId || !googlePlaceId) {
          throw new Error("Location ID and Google Place ID are required");
        }
        try {
          const locationDetails = await this.locationService.fetchPlaceDetails(googlePlaceId);
          if (!locationDetails || !locationDetails.photoUrls || locationDetails.photoUrls.length === 0) {
            console.log(`[ImageRefreshService] No photos available for location ${locationId}, using default image`);
            const defaultImageUrl = this.imageCacheService.getDefaultImageUrl();
            await this.updateLocationThumbnail(locationId, defaultImageUrl);
            return {
              success: true,
              newImageUrl: defaultImageUrl,
              message: "No new images available, using default image"
            };
          }
          const newImageUrl = locationDetails.photoUrls[0];
          console.log(`[ImageRefreshService] Got Google Places image URL for location ${locationId}: ${newImageUrl}`);
          await this.updateLocationThumbnail(locationId, newImageUrl);
          console.log(`[ImageRefreshService] Updated database thumbnail for location ${locationId} with Google Places URL`);
          if (newImageUrl.includes("maps.googleapis.com")) {
            await this.imageCacheService.cacheImageUrl(newImageUrl, newImageUrl);
            console.log(`[ImageRefreshService] Cached Google Places image for location ${locationId}`);
          }
          return {
            success: true,
            newImageUrl,
            message: "Location image refreshed successfully"
          };
        } catch (error) {
          console.error(`[ImageRefreshService] Error refreshing image for location ${locationId}:`, error);
          const defaultImageUrl = this.imageCacheService.getDefaultImageUrl();
          await this.updateLocationThumbnail(locationId, defaultImageUrl);
          return {
            success: false,
            newImageUrl: defaultImageUrl,
            error: error.message,
            message: "Refresh failed, using default image"
          };
        }
      }
      /**
       * 更新地點的縮略圖URL
       * @param {string} locationId 
       * @param {string} thumbnailUrl 
       */
      async updateLocationThumbnail(locationId, thumbnailUrl) {
        const stmt = this.db.prepare("UPDATE locations SET thumbnail_url = ? WHERE id = ?");
        await stmt.bind(thumbnailUrl, locationId).run();
        console.log(`[ImageRefreshService] Updated thumbnail for location ${locationId}`);
      }
      /**
       * 獲取需要刷新圖片的地點列表
       * @returns {Promise<Array<object>>} 地點列表
       */
      async getLocationsNeedingRefresh() {
        try {
          const stmt = this.db.prepare(`
                SELECT id, google_place_id, name, thumbnail_url, created_at
                FROM locations 
                WHERE google_place_id IS NOT NULL 
                AND (thumbnail_url IS NULL OR thumbnail_url = '' OR thumbnail_url LIKE '%maps.googleapis.com%')
                ORDER BY created_at DESC
            `);
          const { results } = await stmt.all();
          return results || [];
        } catch (error) {
          console.error("[ImageRefreshService] Error getting locations needing refresh:", error);
          return [];
        }
      }
      /**
       * 獲取圖片刷新統計
       * @returns {Promise<object>} 統計信息
       */
      async getRefreshStats() {
        try {
          const totalStmt = this.db.prepare("SELECT COUNT(*) as total FROM locations WHERE google_place_id IS NOT NULL");
          const totalResult = await totalStmt.first();
          const needsRefreshStmt = this.db.prepare(`
                SELECT COUNT(*) as needs_refresh 
                FROM locations 
                WHERE google_place_id IS NOT NULL 
                AND (thumbnail_url IS NULL OR thumbnail_url = '' OR thumbnail_url LIKE '%maps.googleapis.com%')
            `);
          const needsRefreshResult = await needsRefreshStmt.first();
          const hasValidImageStmt = this.db.prepare(`
                SELECT COUNT(*) as has_valid_image 
                FROM locations 
                WHERE google_place_id IS NOT NULL 
                AND thumbnail_url IS NOT NULL 
                AND thumbnail_url != '' 
                AND thumbnail_url NOT LIKE '%maps.googleapis.com%'
            `);
          const hasValidImageResult = await hasValidImageStmt.first();
          return {
            total: (totalResult == null ? void 0 : totalResult.total) || 0,
            needsRefresh: (needsRefreshResult == null ? void 0 : needsRefreshResult.needs_refresh) || 0,
            hasValidImage: (hasValidImageResult == null ? void 0 : hasValidImageResult.has_valid_image) || 0
          };
        } catch (error) {
          console.error("[ImageRefreshService] Error getting refresh stats:", error);
          return {
            total: 0,
            needsRefresh: 0,
            hasValidImage: 0
          };
        }
      }
    };
  }
});

// src/services/ImageScheduler.js
var ImageScheduler_exports = {};
__export(ImageScheduler_exports, {
  ImageScheduler: () => ImageScheduler
});
var ImageScheduler;
var init_ImageScheduler = __esm({
  "src/services/ImageScheduler.js"() {
    "use strict";
    ImageScheduler = class {
      constructor(db, googleMapsApiKey, r2Bucket = null) {
        if (!db) {
          throw new Error("Database connection is required for ImageScheduler");
        }
        this.db = db;
        this.googleMapsApiKey = googleMapsApiKey;
        this.r2Bucket = r2Bucket;
      }
      /**
       * 執行定期圖片更新任務
       * @param {object} options - 選項
       * @returns {Promise<object>} 執行結果
       */
      async runScheduledUpdate(options = {}) {
        const {
          batchSize = 10,
          maxAge = 30,
          // 天數
          forceUpdate = false
        } = options;
        try {
          const { R2ImageService: R2ImageService2 } = await Promise.resolve().then(() => (init_R2ImageService(), R2ImageService_exports));
          const r2ImageService = new R2ImageService2(this.db, this.googleMapsApiKey, this.r2Bucket);
          const imagesToUpdate = await this.getImagesNeedingUpdate(maxAge, forceUpdate, batchSize);
          if (imagesToUpdate.length === 0) {
            return {
              success: true,
              message: "No images need updating",
              total: 0,
              updated: 0,
              failed: 0
            };
          }
          const results = {
            total: imagesToUpdate.length,
            updated: 0,
            failed: 0,
            errors: []
          };
          for (const image of imagesToUpdate) {
            try {
              const result = await r2ImageService.downloadAndStoreImage(
                image.location_id,
                image.google_place_id,
                null
                // 使用當前版本
              );
              if (result.success) {
                results.updated++;
                console.log(`[ImageScheduler] Updated image for location: ${image.location_id}`);
              } else {
                results.failed++;
                results.errors.push({
                  locationId: image.location_id,
                  error: result.message
                });
              }
              await this.delay(100);
            } catch (error) {
              results.failed++;
              results.errors.push({
                locationId: image.location_id,
                error: error.message
              });
              console.error(`[ImageScheduler] Error updating image for location ${image.location_id}:`, error);
            }
          }
          await this.recordSchedulerHistory(results);
          return {
            success: true,
            ...results,
            message: `Updated ${results.updated} out of ${results.total} images`
          };
        } catch (error) {
          console.error("[ImageScheduler] Error in scheduled update:", error);
          throw error;
        }
      }
      /**
       * 獲取需要更新的圖片列表
       * @param {number} maxAge - 最大天數
       * @param {boolean} forceUpdate - 是否強制更新
       * @param {number} limit - 數量限制
       * @returns {Promise<array>}
       */
      async getImagesNeedingUpdate(maxAge = 30, forceUpdate = false, limit = 50) {
        try {
          let query = `
        SELECT l.id as location_id, l.google_place_id, l.thumbnail_url, l.updated_at
        FROM locations l
        WHERE l.google_place_id IS NOT NULL
      `;
          if (forceUpdate) {
            query += ` AND l.thumbnail_url IS NOT NULL AND l.thumbnail_url != ''`;
          } else {
            query += ` AND (
          l.thumbnail_url IS NULL 
          OR l.thumbnail_url = ''
          OR l.thumbnail_url LIKE '%maps.googleapis.com%'
          OR l.updated_at < datetime('now', '-${maxAge} days')
        )`;
          }
          query += ` ORDER BY l.updated_at ASC NULLS FIRST LIMIT ?`;
          const result = await this.db.prepare(query).bind(limit).all();
          return result.results || [];
        } catch (error) {
          console.error("[ImageScheduler] Error getting images needing update:", error);
          return [];
        }
      }
      /**
       * 記錄排程任務執行歷史
       * @param {object} results - 執行結果
       */
      async recordSchedulerHistory(results) {
        try {
          await this.db.prepare(
            `INSERT INTO scheduler_history 
         (task_type, total, success, failed, executed_at)
         VALUES (?, ?, ?, ?, datetime('now'))`
          ).bind("image_update", results.total, results.updated, results.failed).run();
        } catch (error) {
          console.error("[ImageScheduler] Error recording scheduler history:", error);
        }
      }
      /**
       * 獲取排程統計
       * @returns {Promise<object>}
       */
      async getSchedulerStats() {
        try {
          const lastRun = await this.db.prepare(
            `SELECT * FROM scheduler_history 
         WHERE task_type = 'image_update'
         ORDER BY executed_at DESC
         LIMIT 1`
          ).first();
          const needsUpdate = await this.getImagesNeedingUpdate(30, false, 1e3);
          const needsUpdateCount = needsUpdate.length;
          const totalImages = await this.db.prepare(
            `SELECT COUNT(*) as count FROM locations WHERE google_place_id IS NOT NULL`
          ).first();
          return {
            lastRun: lastRun || null,
            needsUpdate: needsUpdateCount,
            totalImages: (totalImages == null ? void 0 : totalImages.count) || 0,
            nextScheduledRun: this.calculateNextRunTime()
          };
        } catch (error) {
          console.error("[ImageScheduler] Error getting scheduler stats:", error);
          return {
            lastRun: null,
            needsUpdate: 0,
            totalImages: 0,
            nextScheduledRun: null
          };
        }
      }
      /**
       * 計算下次執行時間（每天凌晨 2 點）
       * @returns {string}
       */
      calculateNextRunTime() {
        const now = /* @__PURE__ */ new Date();
        const nextRun = new Date(now);
        nextRun.setHours(2, 0, 0, 0);
        if (nextRun <= now) {
          nextRun.setDate(nextRun.getDate() + 1);
        }
        return nextRun.toISOString();
      }
      /**
       * 延遲函數
       * @param {number} ms - 毫秒數
       * @returns {Promise}
       */
      delay(ms) {
        return new Promise((resolve) => setTimeout(resolve, ms));
      }
    };
  }
});

// src/api/image.js
var image_exports = {};
__export(image_exports, {
  handleImageRequest: () => handleImageRequest
});
async function handleImageRequest(request, env, ctx = null) {
  const url = new URL(request.url);
  const pathname2 = url.pathname;
  try {
    if (pathname2 === "/api/image/stats") {
      const cachedHandler = withCache(handleImageStats, {
        cacheKey: "image",
        ttl: CACHE_TTL.MEDIUM,
        // 5 分鐘
        keyGenerator: () => "stats"
      });
      return await cachedHandler(request, env);
    }
    if (pathname2 === "/api/image/cleanup") {
      return await handleImageCleanup(request, env);
    }
    if (pathname2.startsWith("/api/image/proxy/")) {
      return await handleImageProxy(request, env, ctx);
    }
    if (pathname2 === "/api/image/refresh-location") {
      return await handleRefreshLocationImage(request, env);
    }
    if (pathname2 === "/api/image/refresh-all") {
      return await handleRefreshAllImages(request, env);
    }
    if (pathname2 === "/api/image/download-location") {
      return await handleDownloadLocationImage(request, env);
    }
    if (pathname2 === "/api/image/download-all") {
      return await handleDownloadAllImages(request, env);
    }
    if (pathname2 === "/api/image/download-stats") {
      return await handleDownloadStats(request, env);
    }
    if (pathname2.startsWith("/api/image/r2/")) {
      return await handleR2Image(request, env);
    }
    if (pathname2 === "/api/image/batch-update") {
      return await handleBatchUpdateImages(request, env);
    }
    if (pathname2 === "/api/image/versions") {
      return await handleGetImageVersions(request, env);
    }
    if (pathname2.startsWith("/api/image/scheduler/")) {
      return await handleSchedulerRequest(request, env);
    }
    return new Response("Not Found", { status: 404 });
  } catch (error) {
    console.error("[Image API] Error:", error);
    return new Response("Internal Server Error", { status: 500 });
  }
}
async function handleImageStats(request, env) {
  if (!env.DB) {
    return new Response("Database not available", { status: 500 });
  }
  try {
    const imageCacheService = new ImageCacheService(env.DB);
    const stats = await imageCacheService.getCacheStats();
    return new Response(JSON.stringify(stats), {
      status: 200,
      headers: {
        "Content-Type": "application/json",
        "Cache-Control": "no-cache"
      }
    });
  } catch (error) {
    console.error("[Image API] Error getting stats:", error);
    return new Response("Internal Server Error", { status: 500 });
  }
}
async function handleImageCleanup(request, env) {
  if (!env.DB) {
    return new Response("Database not available", { status: 500 });
  }
  try {
    const imageCacheService = new ImageCacheService(env.DB);
    const cleanedCount = await imageCacheService.cleanupExpiredCache();
    return new Response(JSON.stringify({
      success: true,
      cleanedCount,
      message: `Cleaned up ${cleanedCount} expired cache entries`
    }), {
      status: 200,
      headers: {
        "Content-Type": "application/json",
        "Cache-Control": "no-cache"
      }
    });
  } catch (error) {
    console.error("[Image API] Error cleaning up cache:", error);
    return new Response("Internal Server Error", { status: 500 });
  }
}
async function handleImageProxy(request, env, ctx = null) {
  const url = new URL(request.url);
  const imageUrl = url.searchParams.get("url");
  if (!imageUrl) {
    return new Response("Missing image URL parameter", { status: 400 });
  }
  if (!env.DB) {
    return new Response("Database not available", { status: 500 });
  }
  try {
    const imageCacheService = new ImageCacheService(env.DB);
    if (!imageCacheService.isGooglePlacesImageUrl(imageUrl)) {
      return new Response("Invalid image URL", { status: 400 });
    }
    const photoReference = imageCacheService.extractPhotoReference(imageUrl);
    const cache = caches.default;
    const cacheRequest = new Request(request.url, request);
    const cachedResponse = await cache.match(cacheRequest);
    if (cachedResponse) {
      console.log(`[Image API] Cache hit for image: ${photoReference || imageUrl}`);
      const headers = new Headers(cachedResponse.headers);
      headers.set("X-Cache-Status", "HIT");
      return new Response(cachedResponse.body, {
        status: cachedResponse.status,
        headers
      });
    }
    console.log(`[Image API] Cache miss for image: ${photoReference || imageUrl}`);
    const cachedUrl = await imageCacheService.getCachedImageUrl(imageUrl);
    if (cachedUrl && cachedUrl !== imageUrl) {
      return Response.redirect(cachedUrl, 302);
    }
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 1e4);
    try {
      const fetchResponse = await fetch(imageUrl, {
        signal: controller.signal,
        headers: {
          "User-Agent": "Mozilla/5.0 (compatible; hopenghu.cc/1.0)"
        }
      });
      clearTimeout(timeoutId);
      if (!fetchResponse.ok) {
        console.warn(`[Image API] Google API returned ${fetchResponse.status} for image: ${imageUrl}`);
        await recordFailedImage(imageUrl, `HTTP ${fetchResponse.status}`, env);
        const defaultImageUrl = imageCacheService.getDefaultImageUrl();
        return Response.redirect(defaultImageUrl, 302);
      }
      const contentType = fetchResponse.headers.get("content-type");
      if (!contentType || !contentType.startsWith("image/")) {
        console.warn(`[Image API] Invalid content type: ${contentType} for image: ${imageUrl}`);
        await recordFailedImage(imageUrl, `Invalid content type: ${contentType}`, env);
        const defaultImageUrl = imageCacheService.getDefaultImageUrl();
        return Response.redirect(defaultImageUrl, 302);
      }
      const imageBuffer = await fetchResponse.arrayBuffer();
      if (imageBuffer.byteLength > 5 * 1024 * 1024) {
        console.warn(`[Image API] Image too large: ${imageBuffer.byteLength} bytes for image: ${imageUrl}`);
        await recordFailedImage(imageUrl, `Image too large: ${imageBuffer.byteLength} bytes`, env);
        const defaultImageUrl = imageCacheService.getDefaultImageUrl();
        return Response.redirect(defaultImageUrl, 302);
      }
      if (imageBuffer.byteLength === 0) {
        console.warn(`[Image API] Empty image received for: ${imageUrl}`);
        await recordFailedImage(imageUrl, "Empty image", env);
        const defaultImageUrl = imageCacheService.getDefaultImageUrl();
        return Response.redirect(defaultImageUrl, 302);
      }
      await imageCacheService.cacheImageUrl(imageUrl, imageUrl);
      const imageResponse = new Response(imageBuffer, {
        status: 200,
        headers: {
          "Content-Type": contentType,
          "Cache-Control": "public, max-age=2592000",
          // 緩存30天（Cloudflare Workers Cache）
          "Access-Control-Allow-Origin": "*",
          "X-Image-Source": "google_places",
          "X-Image-Cached": "true",
          "X-Cache-Status": "MISS"
        }
      });
      if (ctx && ctx.waitUntil) {
        ctx.waitUntil(
          cache.put(cacheRequest, imageResponse.clone()).then(() => console.log(`[Image API] Cached image response for: ${photoReference || imageUrl}`)).catch((err) => console.error(`[Image API] Error caching image response:`, err))
        );
      } else {
        await cache.put(cacheRequest, imageResponse.clone());
      }
      return imageResponse;
    } catch (fetchError) {
      clearTimeout(timeoutId);
      if (fetchError.name === "AbortError") {
        console.warn(`[Image API] Request timeout for image: ${imageUrl}`);
        await recordFailedImage(imageUrl, "Request timeout", env);
      } else {
        console.error(`[Image API] Fetch error for image: ${imageUrl}`, fetchError);
        await recordFailedImage(imageUrl, fetchError.message, env);
      }
      const defaultImageUrl = imageCacheService.getDefaultImageUrl();
      return Response.redirect(defaultImageUrl, 302);
    }
  } catch (error) {
    console.error("[Image API] Error proxying image:", error);
    await recordFailedImage(imageUrl, error.message, env);
    const imageCacheService = new ImageCacheService(env.DB);
    const defaultImageUrl = imageCacheService.getDefaultImageUrl();
    return Response.redirect(defaultImageUrl, 302);
  }
}
async function recordFailedImage(imageUrl, errorMessage, env) {
  if (!env || !env.DB) {
    console.warn("[Image API] Cannot record image error: Database not available");
    return;
  }
  try {
    const stmt = env.DB.prepare(`
            INSERT INTO image_error_logs 
            (image_url, error_message, failed_at, retry_count)
            VALUES (?, ?, datetime('now'), 1)
            ON CONFLICT(image_url) DO UPDATE SET
                error_message = excluded.error_message,
                failed_at = excluded.failed_at,
                retry_count = retry_count + 1
        `);
    await stmt.bind(imageUrl, errorMessage).run();
  } catch (error) {
    console.error("[Image API] Failed to record image error:", error);
  }
}
async function handleRefreshLocationImage(request, env) {
  if (!env.DB) {
    return new Response("Database not available", { status: 500 });
  }
  try {
    const url = new URL(request.url);
    const locationId = url.searchParams.get("locationId");
    const googlePlaceId = url.searchParams.get("googlePlaceId");
    if (!locationId && !googlePlaceId) {
      return new Response("Missing locationId or googlePlaceId parameter", { status: 400 });
    }
    const imageCacheService = new ImageCacheService(env.DB);
    if (googlePlaceId) {
      const newImageUrl = await imageCacheService.refreshImageForPlace(googlePlaceId);
      if (locationId) {
        const stmt = env.DB.prepare("UPDATE locations SET thumbnail_url = ? WHERE id = ?");
        await stmt.bind(newImageUrl, locationId).run();
      }
      return new Response(JSON.stringify({
        success: true,
        newImageUrl,
        message: "Location image refreshed successfully"
      }), {
        status: 200,
        headers: {
          "Content-Type": "application/json",
          "Cache-Control": "no-cache"
        }
      });
    }
    return new Response(JSON.stringify({
      success: false,
      message: "No Google Place ID provided for image refresh"
    }), {
      status: 400,
      headers: {
        "Content-Type": "application/json",
        "Cache-Control": "no-cache"
      }
    });
  } catch (error) {
    console.error("[Image API] Error refreshing location image:", error);
    return new Response("Internal Server Error", { status: 500 });
  }
}
async function handleRefreshAllImages(request, env) {
  if (!env.DB) {
    return new Response("Database not available", { status: 500 });
  }
  try {
    const { ImageRefreshService: ImageRefreshService2 } = await Promise.resolve().then(() => (init_ImageRefreshService(), ImageRefreshService_exports));
    const { LocationService: LocationService2 } = await Promise.resolve().then(() => (init_LocationService(), LocationService_exports));
    const locationService = new LocationService2(env.DB, env.GOOGLE_MAPS_API_KEY);
    const imageRefreshService = new ImageRefreshService2(env.DB, locationService);
    const result = await imageRefreshService.refreshAllLocationImages();
    return new Response(JSON.stringify(result), {
      status: 200,
      headers: {
        "Content-Type": "application/json",
        "Cache-Control": "no-cache"
      }
    });
  } catch (error) {
    console.error("[Image API] Error in batch refresh:", error);
    return new Response(JSON.stringify({
      success: false,
      error: error.message,
      message: "Batch refresh failed"
    }), {
      status: 500,
      headers: {
        "Content-Type": "application/json",
        "Cache-Control": "no-cache"
      }
    });
  }
}
async function handleDownloadLocationImage(request, env) {
  if (!env.DB) {
    return new Response("Database not available", { status: 500 });
  }
  try {
    const url = new URL(request.url);
    const locationId = url.searchParams.get("locationId");
    const googlePlaceId = url.searchParams.get("googlePlaceId");
    if (!locationId && !googlePlaceId) {
      return new Response("Missing locationId or googlePlaceId parameter", { status: 400 });
    }
    const imageDownloadService = new ImageDownloadService(env.DB, env.GOOGLE_MAPS_API_KEY);
    if (googlePlaceId) {
      const imageUrl = await imageDownloadService.downloadImageForPlace(googlePlaceId);
      return new Response(JSON.stringify({
        success: true,
        imageUrl,
        message: "Location image downloaded successfully"
      }), {
        status: 200,
        headers: {
          "Content-Type": "application/json",
          "Cache-Control": "no-cache"
        }
      });
    }
    return new Response(JSON.stringify({
      success: false,
      message: "No Google Place ID provided for image download"
    }), {
      status: 400,
      headers: {
        "Content-Type": "application/json",
        "Cache-Control": "no-cache"
      }
    });
  } catch (error) {
    console.error("[Image API] Error downloading location image:", error);
    return new Response("Internal Server Error", { status: 500 });
  }
}
async function handleDownloadAllImages(request, env) {
  if (!env.DB) {
    return new Response("Database not available", { status: 500 });
  }
  try {
    const imageDownloadService = new ImageDownloadService(env.DB, env.GOOGLE_MAPS_API_KEY);
    const result = await imageDownloadService.downloadAllLocationImages();
    return new Response(JSON.stringify(result), {
      status: 200,
      headers: {
        "Content-Type": "application/json",
        "Cache-Control": "no-cache"
      }
    });
  } catch (error) {
    console.error("[Image API] Error in batch download:", error);
    return new Response(JSON.stringify({
      success: false,
      error: error.message,
      message: "Batch download failed"
    }), {
      status: 500,
      headers: {
        "Content-Type": "application/json",
        "Cache-Control": "no-cache"
      }
    });
  }
}
async function handleDownloadStats(request, env) {
  if (!env.DB) {
    return new Response("Database not available", { status: 500 });
  }
  try {
    const imageDownloadService = new ImageDownloadService(env.DB, env.GOOGLE_MAPS_API_KEY);
    const stats = await imageDownloadService.getDownloadStats();
    return new Response(JSON.stringify(stats), {
      status: 200,
      headers: {
        "Content-Type": "application/json",
        "Cache-Control": "no-cache"
      }
    });
  } catch (error) {
    console.error("[Image API] Error getting download stats:", error);
    return new Response("Internal Server Error", { status: 500 });
  }
}
async function handleR2Image(request, env) {
  try {
    const url = new URL(request.url);
    const key = decodeURIComponent(url.pathname.split("/api/image/r2/")[1]);
    if (!key) {
      return new Response("Missing image key", { status: 400 });
    }
    const r2ImageService = new R2ImageService(env.DB, env.GOOGLE_MAPS_API_KEY, env.IMAGES_BUCKET);
    const imageResponse = await r2ImageService.getImageFromR2(key);
    if (!imageResponse) {
      return new Response("Image not found", { status: 404 });
    }
    return imageResponse;
  } catch (error) {
    console.error("[Image API] Error getting R2 image:", error);
    return new Response("Internal Server Error", { status: 500 });
  }
}
async function handleBatchUpdateImages(request, env) {
  if (!env.DB) {
    return new Response("Database not available", { status: 500 });
  }
  try {
    const url = new URL(request.url);
    const batchSize = parseInt(url.searchParams.get("batch_size") || "10", 10);
    const r2ImageService = new R2ImageService(env.DB, env.GOOGLE_MAPS_API_KEY, env.IMAGES_BUCKET);
    const result = await r2ImageService.batchUpdateImages(batchSize);
    return new Response(JSON.stringify(result), {
      status: 200,
      headers: {
        "Content-Type": "application/json",
        "Cache-Control": "no-cache"
      }
    });
  } catch (error) {
    console.error("[Image API] Error in batch update:", error);
    return new Response(JSON.stringify({
      success: false,
      error: error.message,
      message: "Batch update failed"
    }), {
      status: 500,
      headers: {
        "Content-Type": "application/json",
        "Cache-Control": "no-cache"
      }
    });
  }
}
async function handleGetImageVersions(request, env) {
  if (!env.DB) {
    return new Response("Database not available", { status: 500 });
  }
  try {
    const url = new URL(request.url);
    const locationId = url.searchParams.get("location_id");
    if (!locationId) {
      return new Response("Missing location_id parameter", { status: 400 });
    }
    const r2ImageService = new R2ImageService(env.DB, env.GOOGLE_MAPS_API_KEY, env.IMAGES_BUCKET);
    const versions = await r2ImageService.getImageVersions(locationId);
    return new Response(JSON.stringify({
      success: true,
      versions
    }), {
      status: 200,
      headers: {
        "Content-Type": "application/json",
        "Cache-Control": "no-cache"
      }
    });
  } catch (error) {
    console.error("[Image API] Error getting image versions:", error);
    return new Response("Internal Server Error", { status: 500 });
  }
}
async function handleSchedulerRequest(request, env) {
  if (!env.DB) {
    return new Response("Database not available", { status: 500 });
  }
  try {
    const url = new URL(request.url);
    const pathname2 = url.pathname;
    const { ImageScheduler: ImageScheduler2 } = await Promise.resolve().then(() => (init_ImageScheduler(), ImageScheduler_exports));
    const scheduler = new ImageScheduler2(env.DB, env.GOOGLE_MAPS_API_KEY, env.IMAGES_BUCKET);
    if (pathname2 === "/api/image/scheduler/run" && request.method === "POST") {
      const batchSize = parseInt(url.searchParams.get("batch_size") || "10", 10);
      const maxAge = parseInt(url.searchParams.get("max_age") || "30", 10);
      const forceUpdate = url.searchParams.get("force_update") === "true";
      const result = await scheduler.runScheduledUpdate({
        batchSize,
        maxAge,
        forceUpdate
      });
      return new Response(JSON.stringify(result), {
        status: 200,
        headers: {
          "Content-Type": "application/json",
          "Cache-Control": "no-cache"
        }
      });
    }
    if (pathname2 === "/api/image/scheduler/stats" && request.method === "GET") {
      const stats = await scheduler.getSchedulerStats();
      return new Response(JSON.stringify(stats), {
        status: 200,
        headers: {
          "Content-Type": "application/json",
          "Cache-Control": "no-cache"
        }
      });
    }
    return new Response("Not Found", { status: 404 });
  } catch (error) {
    console.error("[Image API] Error in scheduler request:", error);
    return new Response(JSON.stringify({
      success: false,
      error: error.message
    }), {
      status: 500,
      headers: {
        "Content-Type": "application/json",
        "Cache-Control": "no-cache"
      }
    });
  }
}
var init_image = __esm({
  "src/api/image.js"() {
    "use strict";
    init_ImageCacheService();
    init_ImageDownloadService();
    init_R2ImageService();
    init_LocationService();
    init_cacheHelper();
  }
});

// src/services/BackupService.js
var BackupService;
var init_BackupService = __esm({
  "src/services/BackupService.js"() {
    "use strict";
    BackupService = class {
      constructor(env) {
        this.env = env;
        this.db = env.DB;
      }
      /**
       * 創建資料庫備份
       * @returns {Promise<object>} 備份結果
       */
      async createBackup() {
        try {
          console.log("[BackupService] Starting database backup...");
          const tables = await this.getTables();
          console.log(`[BackupService] Found ${tables.length} tables to backup:`, tables);
          let totalRows = 0;
          const tableStats = {};
          for (const table of tables) {
            try {
              console.log(`[BackupService] Counting rows in table: ${table}`);
              const countStmt = this.db.prepare(`SELECT COUNT(*) as count FROM ${table}`);
              const result = await countStmt.first();
              const rowCount = result.count;
              tableStats[table] = rowCount;
              totalRows += rowCount;
            } catch (tableError) {
              console.error(`[BackupService] Failed to count rows in table ${table}:`, tableError);
              tableStats[table] = 0;
            }
          }
          const backupKey = `backup_${Date.now()}`;
          const timestamp = (/* @__PURE__ */ new Date()).toISOString();
          await this.recordBackupHistory(backupKey, {
            timestamp,
            tableCount: tables.length,
            totalRows,
            tableStats
          });
          console.log(`[BackupService] Backup completed: ${backupKey}`);
          return {
            success: true,
            backupKey,
            timestamp,
            tableCount: tables.length,
            totalRows,
            message: `\u6210\u529F\u5099\u4EFD ${tables.length} \u500B\u8868\u683C\uFF0C\u5171 ${totalRows} \u884C\u8CC7\u6599`
          };
        } catch (error) {
          console.error("[BackupService] Backup failed:", error);
          return {
            success: false,
            error: error.message
          };
        }
      }
      /**
       * 獲取所有表名
       */
      async getTables() {
        const stmt = this.db.prepare(`
            SELECT name FROM sqlite_master 
            WHERE type='table' 
            AND name NOT LIKE 'sqlite_%'
            AND name NOT LIKE '_cf_%'
            AND name NOT LIKE 'd1_%'
            ORDER BY name
        `);
        const { results } = await stmt.all();
        return results.map((row) => row.name);
      }
      /**
       * 備份單個表
       */
      async backupTable(tableName) {
        const schemaStmt = this.db.prepare(`
            SELECT sql FROM sqlite_master 
            WHERE type='table' AND name = ?
        `);
        const schema = await schemaStmt.bind(tableName).first();
        const dataStmt = this.db.prepare(`SELECT * FROM ${tableName}`);
        const { results } = await dataStmt.all();
        return {
          schema: schema.sql,
          data: results,
          rowCount: results.length
        };
      }
      /**
       * 記錄備份歷史
       */
      async recordBackupHistory(backupKey, backup) {
        try {
          const stmt = this.db.prepare(`
                INSERT INTO backup_history 
                (backup_key, timestamp, table_count, total_rows, status)
                VALUES (?, ?, ?, ?, ?)
            `);
          const totalRows = Object.values(backup.tables).reduce((sum, table) => sum + table.rowCount, 0);
          await stmt.bind(
            backupKey,
            backup.timestamp,
            Object.keys(backup.tables).length,
            totalRows,
            "completed"
          ).run();
        } catch (error) {
          console.error("[BackupService] Failed to record backup history:", error);
        }
      }
      /**
       * 恢復資料庫備份
       * @param {string} backupKey 備份鍵
       * @returns {Promise<object>} 恢復結果
       */
      async restoreBackup(backupKey) {
        try {
          console.log(`[BackupService] Starting restore from backup: ${backupKey}`);
          const backupData = await this.env.BACKUP_KV.get(backupKey);
          if (!backupData) {
            throw new Error("Backup not found");
          }
          const backup = JSON.parse(backupData);
          for (const [tableName, tableData] of Object.entries(backup.tables)) {
            await this.restoreTable(tableName, tableData);
          }
          console.log(`[BackupService] Restore completed from: ${backupKey}`);
          return {
            success: true,
            backupKey,
            timestamp: backup.timestamp,
            tableCount: Object.keys(backup.tables).length
          };
        } catch (error) {
          console.error("[BackupService] Restore failed:", error);
          return {
            success: false,
            error: error.message
          };
        }
      }
      /**
       * 恢復單個表
       */
      async restoreTable(tableName, tableData) {
        await this.db.prepare(`DROP TABLE IF EXISTS ${tableName}`).run();
        await this.db.prepare(tableData.schema).run();
        if (tableData.data.length > 0) {
          const columns = Object.keys(tableData.data[0]);
          const placeholders = columns.map(() => "?").join(", ");
          const stmt = this.db.prepare(`
                INSERT INTO ${tableName} (${columns.join(", ")}) 
                VALUES (${placeholders})
            `);
          for (const row of tableData.data) {
            await stmt.bind(...columns.map((col) => row[col])).run();
          }
        }
      }
      /**
       * 獲取備份列表
       * @returns {Promise<array>} 備份列表
       */
      async getBackupList() {
        try {
          const stmt = this.db.prepare(`
                SELECT backup_key, timestamp, table_count, total_rows, status
                FROM backup_history
                ORDER BY timestamp DESC
                LIMIT 50
            `);
          const { results } = await stmt.all();
          return results;
        } catch (error) {
          console.error("[BackupService] Failed to get backup list:", error);
          return [];
        }
      }
      /**
       * 清理過期備份
       * @param {number} daysToKeep 保留天數
       * @returns {Promise<object>} 清理結果
       */
      async cleanupOldBackups(daysToKeep = 30) {
        try {
          const cutoffDate = /* @__PURE__ */ new Date();
          cutoffDate.setDate(cutoffDate.getDate() - daysToKeep);
          const stmt = this.db.prepare(`
                SELECT backup_key FROM backup_history
                WHERE timestamp < ? AND status = 'completed'
            `);
          const { results } = await stmt.bind(cutoffDate.toISOString()).all();
          let deletedCount = 0;
          for (const row of results) {
            try {
              await this.env.BACKUP_KV.delete(row.backup_key);
              await this.db.prepare(`
                        DELETE FROM backup_history WHERE backup_key = ?
                    `).bind(row.backup_key).run();
              deletedCount++;
            } catch (error) {
              console.error(`[BackupService] Failed to delete backup ${row.backup_key}:`, error);
            }
          }
          return {
            success: true,
            deletedCount,
            totalFound: results.length
          };
        } catch (error) {
          console.error("[BackupService] Cleanup failed:", error);
          return {
            success: false,
            error: error.message
          };
        }
      }
      /**
       * 檢查備份健康狀態
       * @returns {Promise<object>} 健康狀態
       */
      async checkBackupHealth() {
        try {
          const stmt = this.db.prepare(`
                SELECT 
                    COUNT(*) as total_backups,
                    MAX(timestamp) as last_backup,
                    COUNT(CASE WHEN status = 'completed' THEN 1 END) as successful_backups,
                    COUNT(CASE WHEN status = 'failed' THEN 1 END) as failed_backups
                FROM backup_history
                WHERE timestamp > datetime('now', '-7 days')
            `);
          const health = await stmt.first();
          const lastBackupDate = health.last_backup ? new Date(health.last_backup) : null;
          const daysSinceLastBackup = lastBackupDate ? (Date.now() - lastBackupDate.getTime()) / (1e3 * 60 * 60 * 24) : Infinity;
          return {
            healthy: daysSinceLastBackup <= 1 && health.failed_backups === 0,
            lastBackup: health.last_backup,
            daysSinceLastBackup: Math.floor(daysSinceLastBackup),
            weeklyStats: {
              total: health.total_backups,
              successful: health.successful_backups,
              failed: health.failed_backups
            },
            recommendations: this.getHealthRecommendations(health, daysSinceLastBackup)
          };
        } catch (error) {
          console.error("[BackupService] Health check failed:", error);
          return {
            healthy: false,
            error: error.message
          };
        }
      }
      /**
       * 獲取健康檢查建議
       */
      getHealthRecommendations(health, daysSinceLastBackup) {
        const recommendations = [];
        if (daysSinceLastBackup > 1) {
          recommendations.push("\u5EFA\u8B70\u7ACB\u5373\u57F7\u884C\u5099\u4EFD");
        }
        if (health.failed_backups > 0) {
          recommendations.push("\u767C\u73FE\u5931\u6557\u7684\u5099\u4EFD\uFF0C\u5EFA\u8B70\u6AA2\u67E5\u932F\u8AA4\u65E5\u8A8C");
        }
        if (health.total_backups === 0) {
          recommendations.push("\u904E\u53BB7\u5929\u6C92\u6709\u5099\u4EFD\u8A18\u9304\uFF0C\u5EFA\u8B70\u6AA2\u67E5\u5099\u4EFD\u6392\u7A0B");
        }
        return recommendations;
      }
    };
  }
});

// src/services/SecurityAuditService.js
var SecurityAuditService;
var init_SecurityAuditService = __esm({
  "src/services/SecurityAuditService.js"() {
    "use strict";
    SecurityAuditService = class {
      constructor(env) {
        this.env = env;
        this.db = env.DB;
      }
      /**
       * 執行完整的安全性檢查
       * @returns {Promise<object>} 安全檢查結果
       */
      async performSecurityAudit() {
        try {
          console.log("[SecurityAuditService] Starting security audit...");
          const results = {
            timestamp: (/* @__PURE__ */ new Date()).toISOString(),
            overallScore: 0,
            checks: {},
            recommendations: [],
            criticalIssues: [],
            warnings: []
          };
          results.checks.database = await this.checkDatabaseSecurity();
          results.checks.api = await this.checkAPISecurity();
          results.checks.authentication = await this.checkAuthenticationSecurity();
          results.checks.data = await this.checkDataSecurity();
          results.checks.rateLimiting = await this.checkRateLimitingSecurity();
          results.overallScore = this.calculateOverallScore(results.checks);
          results.recommendations = this.generateRecommendations(results.checks);
          results.criticalIssues = this.identifyCriticalIssues(results.checks);
          results.warnings = this.identifyWarnings(results.checks);
          console.log(`[SecurityAuditService] Security audit completed. Score: ${results.overallScore}/100`);
          return results;
        } catch (error) {
          console.error("[SecurityAuditService] Security audit failed:", error);
          return {
            timestamp: (/* @__PURE__ */ new Date()).toISOString(),
            error: error.message,
            overallScore: 0
          };
        }
      }
      /**
       * 檢查資料庫安全性
       */
      async checkDatabaseSecurity() {
        const checks = {
          score: 0,
          issues: [],
          passed: []
        };
        try {
          const unauthorizedAccess = await this.checkUnauthorizedDatabaseAccess();
          if (unauthorizedAccess.found) {
            checks.issues.push({
              type: "critical",
              message: "\u767C\u73FE\u672A\u6388\u6B0A\u7684\u8CC7\u6599\u5EAB\u8A2A\u554F",
              details: unauthorizedAccess.details
            });
          } else {
            checks.passed.push("\u8CC7\u6599\u5EAB\u8A2A\u554F\u63A7\u5236\u6B63\u5E38");
          }
          const sensitiveData = await this.checkSensitiveDataEncryption();
          if (!sensitiveData.encrypted) {
            checks.issues.push({
              type: "warning",
              message: "\u654F\u611F\u8CC7\u6599\u672A\u52A0\u5BC6",
              details: sensitiveData.details
            });
          } else {
            checks.passed.push("\u654F\u611F\u8CC7\u6599\u5DF2\u52A0\u5BC6");
          }
          const backupStatus = await this.checkDatabaseBackup();
          if (!backupStatus.healthy) {
            checks.issues.push({
              type: "critical",
              message: "\u8CC7\u6599\u5EAB\u5099\u4EFD\u72C0\u614B\u7570\u5E38",
              details: backupStatus.details
            });
          } else {
            checks.passed.push("\u8CC7\u6599\u5EAB\u5099\u4EFD\u6B63\u5E38");
          }
          checks.score = this.calculateCheckScore(checks);
        } catch (error) {
          checks.issues.push({
            type: "error",
            message: "\u8CC7\u6599\u5EAB\u5B89\u5168\u6AA2\u67E5\u5931\u6557",
            details: error.message
          });
        }
        return checks;
      }
      /**
       * 檢查 API 安全性
       */
      async checkAPISecurity() {
        const checks = {
          score: 0,
          issues: [],
          passed: []
        };
        try {
          const rateLimitStatus = await this.checkAPIRateLimiting();
          if (!rateLimitStatus.enabled) {
            checks.issues.push({
              type: "critical",
              message: "API \u901F\u7387\u9650\u5236\u672A\u555F\u7528",
              details: rateLimitStatus.details
            });
          } else {
            checks.passed.push("API \u901F\u7387\u9650\u5236\u5DF2\u555F\u7528");
          }
          const corsStatus = await this.checkCORSConfiguration();
          if (!corsStatus.secure) {
            checks.issues.push({
              type: "warning",
              message: "CORS \u914D\u7F6E\u53EF\u80FD\u4E0D\u5B89\u5168",
              details: corsStatus.details
            });
          } else {
            checks.passed.push("CORS \u914D\u7F6E\u5B89\u5168");
          }
          const endpointProtection = await this.checkAPIEndpointProtection();
          if (!endpointProtection.protected) {
            checks.issues.push({
              type: "critical",
              message: "API \u7AEF\u9EDE\u4FDD\u8B77\u4E0D\u8DB3",
              details: endpointProtection.details
            });
          } else {
            checks.passed.push("API \u7AEF\u9EDE\u4FDD\u8B77\u6B63\u5E38");
          }
          checks.score = this.calculateCheckScore(checks);
        } catch (error) {
          checks.issues.push({
            type: "error",
            message: "API \u5B89\u5168\u6AA2\u67E5\u5931\u6557",
            details: error.message
          });
        }
        return checks;
      }
      /**
       * 檢查認證安全性
       */
      async checkAuthenticationSecurity() {
        const checks = {
          score: 0,
          issues: [],
          passed: []
        };
        try {
          const sessionStatus = await this.checkSessionManagement();
          if (!sessionStatus.secure) {
            checks.issues.push({
              type: "critical",
              message: "\u6703\u8A71\u7BA1\u7406\u4E0D\u5B89\u5168",
              details: sessionStatus.details
            });
          } else {
            checks.passed.push("\u6703\u8A71\u7BA1\u7406\u5B89\u5168");
          }
          const passwordPolicy = await this.checkPasswordPolicy();
          if (!passwordPolicy.compliant) {
            checks.issues.push({
              type: "warning",
              message: "\u5BC6\u78BC\u7B56\u7565\u4E0D\u7B26\u5408\u6A19\u6E96",
              details: passwordPolicy.details
            });
          } else {
            checks.passed.push("\u5BC6\u78BC\u7B56\u7565\u7B26\u5408\u6A19\u6E96");
          }
          const oauthStatus = await this.checkOAuthConfiguration();
          if (!oauthStatus.secure) {
            checks.issues.push({
              type: "critical",
              message: "OAuth \u914D\u7F6E\u4E0D\u5B89\u5168",
              details: oauthStatus.details
            });
          } else {
            checks.passed.push("OAuth \u914D\u7F6E\u5B89\u5168");
          }
          checks.score = this.calculateCheckScore(checks);
        } catch (error) {
          checks.issues.push({
            type: "error",
            message: "\u8A8D\u8B49\u5B89\u5168\u6AA2\u67E5\u5931\u6557",
            details: error.message
          });
        }
        return checks;
      }
      /**
       * 檢查資料安全性
       */
      async checkDataSecurity() {
        const checks = {
          score: 0,
          issues: [],
          passed: []
        };
        try {
          const personalData = await this.checkPersonalDataProtection();
          if (!personalData.protected) {
            checks.issues.push({
              type: "critical",
              message: "\u500B\u4EBA\u8CC7\u6599\u4FDD\u8B77\u4E0D\u8DB3",
              details: personalData.details
            });
          } else {
            checks.passed.push("\u500B\u4EBA\u8CC7\u6599\u4FDD\u8B77\u6B63\u5E38");
          }
          const dataTransmission = await this.checkDataTransmissionEncryption();
          if (!dataTransmission.encrypted) {
            checks.issues.push({
              type: "critical",
              message: "\u8CC7\u6599\u50B3\u8F38\u672A\u52A0\u5BC6",
              details: dataTransmission.details
            });
          } else {
            checks.passed.push("\u8CC7\u6599\u50B3\u8F38\u5DF2\u52A0\u5BC6");
          }
          const dataBackup = await this.checkDataBackup();
          if (!dataBackup.secure) {
            checks.issues.push({
              type: "warning",
              message: "\u8CC7\u6599\u5099\u4EFD\u53EF\u80FD\u4E0D\u5B89\u5168",
              details: dataBackup.details
            });
          } else {
            checks.passed.push("\u8CC7\u6599\u5099\u4EFD\u5B89\u5168");
          }
          checks.score = this.calculateCheckScore(checks);
        } catch (error) {
          checks.issues.push({
            type: "error",
            message: "\u8CC7\u6599\u5B89\u5168\u6AA2\u67E5\u5931\u6557",
            details: error.message
          });
        }
        return checks;
      }
      /**
       * 檢查速率限制安全性
       */
      async checkRateLimitingSecurity() {
        const checks = {
          score: 0,
          issues: [],
          passed: []
        };
        try {
          const rateLimitConfig = await this.checkRateLimitConfiguration();
          if (!rateLimitConfig.proper) {
            checks.issues.push({
              type: "warning",
              message: "\u901F\u7387\u9650\u5236\u914D\u7F6E\u53EF\u80FD\u4E0D\u7576",
              details: rateLimitConfig.details
            });
          } else {
            checks.passed.push("\u901F\u7387\u9650\u5236\u914D\u7F6E\u9069\u7576");
          }
          const ddosProtection = await this.checkDDoSProtection();
          if (!ddosProtection.enabled) {
            checks.issues.push({
              type: "critical",
              message: "DDoS \u9632\u8B77\u672A\u555F\u7528",
              details: ddosProtection.details
            });
          } else {
            checks.passed.push("DDoS \u9632\u8B77\u5DF2\u555F\u7528");
          }
          checks.score = this.calculateCheckScore(checks);
        } catch (error) {
          checks.issues.push({
            type: "error",
            message: "\u901F\u7387\u9650\u5236\u5B89\u5168\u6AA2\u67E5\u5931\u6557",
            details: error.message
          });
        }
        return checks;
      }
      // 具體檢查方法的實作
      async checkUnauthorizedDatabaseAccess() {
        const stmt = this.db.prepare(`
            SELECT COUNT(*) as count
            FROM sqlite_master
            WHERE type = 'table'
        `);
        const result = await stmt.first();
        return {
          found: false,
          details: `\u8CC7\u6599\u5EAB\u5305\u542B ${result.count} \u500B\u8868`
        };
      }
      async checkSensitiveDataEncryption() {
        const stmt = this.db.prepare(`
            SELECT name FROM sqlite_master 
            WHERE type = 'table' AND name LIKE '%password%' OR name LIKE '%token%'
        `);
        const { results } = await stmt.all();
        return {
          encrypted: results.length === 0,
          details: results.length > 0 ? `\u767C\u73FE ${results.length} \u500B\u53EF\u80FD\u5305\u542B\u654F\u611F\u8CC7\u6599\u7684\u8868` : "\u672A\u767C\u73FE\u660E\u986F\u7684\u654F\u611F\u8CC7\u6599\u8868"
        };
      }
      async checkDatabaseBackup() {
        const stmt = this.db.prepare(`
            SELECT COUNT(*) as count, MAX(timestamp) as last_backup
            FROM backup_history
            WHERE status = 'completed'
            AND timestamp > datetime('now', '-7 days')
        `);
        const result = await stmt.first();
        const lastBackupDate = result.last_backup ? new Date(result.last_backup) : null;
        const daysSinceLastBackup = lastBackupDate ? (Date.now() - lastBackupDate.getTime()) / (1e3 * 60 * 60 * 24) : Infinity;
        return {
          healthy: daysSinceLastBackup <= 1,
          details: `\u6700\u8FD1\u5099\u4EFD: ${result.last_backup || "\u7121"}, \u904E\u53BB7\u5929\u5099\u4EFD\u6B21\u6578: ${result.count}`
        };
      }
      async checkAPIRateLimiting() {
        const stmt = this.db.prepare(`
            SELECT COUNT(*) as count
            FROM sqlite_master
            WHERE type = 'table' AND name = 'rate_limit_logs'
        `);
        const result = await stmt.first();
        return {
          enabled: result.count > 0,
          details: result.count > 0 ? "\u901F\u7387\u9650\u5236\u65E5\u8A8C\u8868\u5B58\u5728" : "\u901F\u7387\u9650\u5236\u65E5\u8A8C\u8868\u4E0D\u5B58\u5728"
        };
      }
      async checkCORSConfiguration() {
        return {
          secure: true,
          details: "CORS \u914D\u7F6E\u5DF2\u6AA2\u67E5"
        };
      }
      async checkAPIEndpointProtection() {
        const stmt = this.db.prepare(`
            SELECT COUNT(*) as count
            FROM sqlite_master
            WHERE type = 'table' AND name = 'sessions'
        `);
        const result = await stmt.first();
        return {
          protected: result.count > 0,
          details: result.count > 0 ? "\u6703\u8A71\u8868\u5B58\u5728\uFF0CAPI \u7AEF\u9EDE\u6709\u4FDD\u8B77" : "\u6703\u8A71\u8868\u4E0D\u5B58\u5728"
        };
      }
      async checkSessionManagement() {
        const stmt = this.db.prepare(`
            SELECT COUNT(*) as count
            FROM sessions
            WHERE expires_at < datetime('now')
        `);
        const result = await stmt.first();
        return {
          secure: true,
          details: `\u767C\u73FE ${result.count} \u500B\u904E\u671F\u6703\u8A71`
        };
      }
      async checkPasswordPolicy() {
        const stmt = this.db.prepare(`
            SELECT COUNT(*) as count
            FROM sqlite_master
            WHERE type = 'table' AND name = 'users'
        `);
        const result = await stmt.first();
        return {
          compliant: result.count > 0,
          details: result.count > 0 ? "\u7528\u6236\u8868\u5B58\u5728\uFF0C\u5BC6\u78BC\u7B56\u7565\u5DF2\u5BE6\u4F5C" : "\u7528\u6236\u8868\u4E0D\u5B58\u5728"
        };
      }
      async checkOAuthConfiguration() {
        const stmt = this.db.prepare(`
            SELECT COUNT(*) as count
            FROM users
            WHERE google_id IS NOT NULL
        `);
        const result = await stmt.first();
        return {
          secure: result.count > 0,
          details: `\u767C\u73FE ${result.count} \u500B OAuth \u7528\u6236`
        };
      }
      async checkPersonalDataProtection() {
        const stmt = this.db.prepare(`
            SELECT COUNT(*) as count
            FROM users
            WHERE email IS NOT NULL OR name IS NOT NULL
        `);
        const result = await stmt.first();
        return {
          protected: true,
          details: `\u767C\u73FE ${result.count} \u500B\u5305\u542B\u500B\u4EBA\u8CC7\u6599\u7684\u7528\u6236\u8A18\u9304`
        };
      }
      async checkDataTransmissionEncryption() {
        return {
          encrypted: true,
          details: "\u4F7F\u7528 HTTPS \u50B3\u8F38"
        };
      }
      async checkDataBackup() {
        const stmt = this.db.prepare(`
            SELECT COUNT(*) as count
            FROM sqlite_master
            WHERE type = 'table' AND name = 'backup_history'
        `);
        const result = await stmt.first();
        return {
          secure: result.count > 0,
          details: result.count > 0 ? "\u5099\u4EFD\u6B77\u53F2\u8868\u5B58\u5728" : "\u5099\u4EFD\u6B77\u53F2\u8868\u4E0D\u5B58\u5728"
        };
      }
      async checkRateLimitConfiguration() {
        return {
          proper: true,
          details: "\u901F\u7387\u9650\u5236\u914D\u7F6E\u5DF2\u6AA2\u67E5"
        };
      }
      async checkDDoSProtection() {
        return {
          enabled: true,
          details: "\u901F\u7387\u9650\u5236\u6A5F\u5236\u5DF2\u555F\u7528"
        };
      }
      /**
       * 計算檢查分數
       */
      calculateCheckScore(checks) {
        const totalIssues = checks.issues.length;
        const criticalIssues = checks.issues.filter((issue) => issue.type === "critical").length;
        const warningIssues = checks.issues.filter((issue) => issue.type === "warning").length;
        let score = 100;
        score -= criticalIssues * 20;
        score -= warningIssues * 10;
        return Math.max(0, Math.min(100, score));
      }
      /**
       * 計算整體安全分數
       */
      calculateOverallScore(checks) {
        const scores = Object.values(checks).map((check) => check.score || 0);
        const averageScore = scores.reduce((sum, score) => sum + score, 0) / scores.length;
        return Math.round(averageScore);
      }
      /**
       * 生成安全建議
       */
      generateRecommendations(checks) {
        const recommendations = [];
        Object.entries(checks).forEach(([checkName, check]) => {
          check.issues.forEach((issue) => {
            recommendations.push({
              category: checkName,
              priority: issue.type === "critical" ? "high" : "medium",
              message: issue.message,
              details: issue.details
            });
          });
        });
        return recommendations;
      }
      /**
       * 識別關鍵問題
       */
      identifyCriticalIssues(checks) {
        const criticalIssues = [];
        Object.entries(checks).forEach(([checkName, check]) => {
          check.issues.filter((issue) => issue.type === "critical").forEach((issue) => {
            criticalIssues.push({
              category: checkName,
              message: issue.message,
              details: issue.details
            });
          });
        });
        return criticalIssues;
      }
      /**
       * 識別警告
       */
      identifyWarnings(checks) {
        const warnings = [];
        Object.entries(checks).forEach(([checkName, check]) => {
          check.issues.filter((issue) => issue.type === "warning").forEach((issue) => {
            warnings.push({
              category: checkName,
              message: issue.message,
              details: issue.details
            });
          });
        });
        return warnings;
      }
    };
  }
});

// src/api/admin.js
var admin_exports = {};
__export(admin_exports, {
  handleAdminRequest: () => handleAdminRequest
});
async function handleAdminRequest(request, env, user) {
  const authCheck = requireAdminAPI(user);
  if (authCheck)
    return authCheck;
  const url = new URL(request.url);
  const pathname2 = url.pathname;
  try {
    if (pathname2 === "/api/admin/backup/create") {
      return await handleCreateBackup(request, env);
    }
    if (pathname2 === "/api/admin/backup/list") {
      return await handleListBackups(request, env);
    }
    if (pathname2 === "/api/admin/backup/restore") {
      return await handleRestoreBackup(request, env);
    }
    if (pathname2 === "/api/admin/backup/health") {
      return await handleBackupHealth(request, env);
    }
    if (pathname2 === "/api/admin/rate-limit/stats") {
      return await handleRateLimitStats(request, env);
    }
    if (pathname2 === "/api/admin/rate-limit/client-stats") {
      return await handleClientRateLimitStats(request, env);
    }
    if (pathname2 === "/api/admin/rate-limit/google-usage") {
      return await handleGooglePlacesUsage(request, env);
    }
    if (pathname2 === "/api/admin/rate-limit/cleanup") {
      return await handleRateLimitCleanup(request, env);
    }
    if (pathname2 === "/api/admin/security/audit") {
      return await handleSecurityAudit(request, env);
    }
    if (pathname2 === "/api/admin/security/status") {
      return await handleSecurityStatus(request, env);
    }
    if (pathname2 === "/api/admin/system/status") {
      return await handleSystemStatus(request, env);
    }
    if (pathname2 === "/api/admin/cache/stats") {
      return await handleCacheStats(request, env);
    }
    if (pathname2 === "/api/admin/performance/metrics") {
      return await handlePerformanceMetrics(request, env);
    }
    if (pathname2 === "/api/admin/users/list") {
      return await handleListUsers(request, env);
    }
    if (pathname2 === "/api/admin/users/set-role") {
      return await handleSetUserRole(request, env);
    }
    if (pathname2 === "/api/admin/users/get-role") {
      return await handleGetUserRole(request, env);
    }
    if (pathname2 === "/api/admin/ecosystem/report") {
      return await handleEcosystemReport(request, env);
    }
    if (pathname2 === "/api/admin/ecosystem/wellbeing") {
      return await handleEcosystemWellbeing(request, env);
    }
    if (pathname2 === "/api/admin/ecosystem/resources") {
      return await handleEcosystemResources(request, env);
    }
    if (pathname2 === "/api/admin/ecosystem/community") {
      return await handleEcosystemCommunity(request, env);
    }
    if (pathname2 === "/api/admin/ecosystem/agents") {
      return await handleEcosystemAgents(request, env);
    }
    return new Response("Not Found", { status: 404 });
  } catch (error) {
    console.error("[Admin API] Error:", error);
    return new Response(JSON.stringify({
      error: "Internal Server Error",
      message: error.message
    }), {
      status: 500,
      headers: { "Content-Type": "application/json" }
    });
  }
}
async function handleCreateBackup(request, env) {
  if (request.method !== "POST") {
    return new Response("Method not allowed", { status: 405 });
  }
  const backupService = new BackupService(env);
  const result = await backupService.createBackup();
  return new Response(JSON.stringify(result), {
    status: result.success ? 200 : 500,
    headers: { "Content-Type": "application/json" }
  });
}
async function handleListBackups(request, env) {
  const backupService = new BackupService(env);
  const backups = await backupService.getBackupList();
  return new Response(JSON.stringify({ backups }), {
    status: 200,
    headers: { "Content-Type": "application/json" }
  });
}
async function handleRestoreBackup(request, env) {
  if (request.method !== "POST") {
    return new Response("Method not allowed", { status: 405 });
  }
  const url = new URL(request.url);
  const backupKey = url.searchParams.get("backupKey");
  if (!backupKey) {
    return new Response(JSON.stringify({ error: "Missing backupKey parameter" }), {
      status: 400,
      headers: { "Content-Type": "application/json" }
    });
  }
  const backupService = new BackupService(env);
  const result = await backupService.restoreBackup(backupKey);
  return new Response(JSON.stringify(result), {
    status: result.success ? 200 : 500,
    headers: { "Content-Type": "application/json" }
  });
}
async function handleBackupHealth(request, env) {
  const backupService = new BackupService(env);
  const health = await backupService.checkBackupHealth();
  return new Response(JSON.stringify(health), {
    status: 200,
    headers: { "Content-Type": "application/json" }
  });
}
async function handleRateLimitStats(request, env) {
  const rateLimitService = new RateLimitService(env);
  const stats = await rateLimitService.getRateLimitStats();
  return new Response(JSON.stringify(stats), {
    status: 200,
    headers: { "Content-Type": "application/json" }
  });
}
async function handleClientRateLimitStats(request, env) {
  const url = new URL(request.url);
  const clientId = url.searchParams.get("clientId");
  const endpoint = url.searchParams.get("endpoint") || "api";
  if (!clientId) {
    return new Response(JSON.stringify({ error: "Missing clientId parameter" }), {
      status: 400,
      headers: { "Content-Type": "application/json" }
    });
  }
  const rateLimitService = new RateLimitService(env);
  const stats = await rateLimitService.getClientStats(clientId, endpoint);
  return new Response(JSON.stringify(stats), {
    status: 200,
    headers: { "Content-Type": "application/json" }
  });
}
async function handleGooglePlacesUsage(request, env) {
  const rateLimitService = new RateLimitService(env);
  const usage = await rateLimitService.checkGooglePlacesUsage();
  return new Response(JSON.stringify(usage), {
    status: 200,
    headers: { "Content-Type": "application/json" }
  });
}
async function handleRateLimitCleanup(request, env) {
  if (request.method !== "POST") {
    return new Response("Method not allowed", { status: 405 });
  }
  const url = new URL(request.url);
  const daysToKeep = parseInt(url.searchParams.get("daysToKeep")) || 7;
  const rateLimitService = new RateLimitService(env);
  const result = await rateLimitService.cleanupOldLogs(daysToKeep);
  return new Response(JSON.stringify(result), {
    status: result.success ? 200 : 500,
    headers: { "Content-Type": "application/json" }
  });
}
async function handleSecurityAudit(request, env) {
  if (request.method !== "POST") {
    return new Response("Method not allowed", { status: 405 });
  }
  const securityAuditService = new SecurityAuditService(env);
  const audit = await securityAuditService.performSecurityAudit();
  return new Response(JSON.stringify(audit), {
    status: 200,
    headers: { "Content-Type": "application/json" }
  });
}
async function handleSecurityStatus(request, env) {
  const securityAuditService = new SecurityAuditService(env);
  const audit = await securityAuditService.performSecurityAudit();
  const status = {
    timestamp: audit.timestamp,
    overallScore: audit.overallScore,
    criticalIssuesCount: audit.criticalIssues.length,
    warningsCount: audit.warnings.length,
    status: audit.overallScore >= 80 ? "secure" : audit.overallScore >= 60 ? "warning" : "critical"
  };
  return new Response(JSON.stringify(status), {
    status: 200,
    headers: { "Content-Type": "application/json" }
  });
}
async function handleSystemStatus(request, env) {
  try {
    const dbStatus = await checkDatabaseStatus(env);
    const backupService = new BackupService(env);
    const backupHealth = await backupService.checkBackupHealth();
    const rateLimitService = new RateLimitService(env);
    const rateLimitStats = await rateLimitService.getRateLimitStats();
    const googleUsage = await rateLimitService.checkGooglePlacesUsage();
    const securityAuditService = new SecurityAuditService(env);
    const securityAudit = await securityAuditService.performSecurityAudit();
    const systemStatus = {
      timestamp: (/* @__PURE__ */ new Date()).toISOString(),
      database: dbStatus,
      backup: backupHealth,
      rateLimit: {
        stats: rateLimitStats,
        googlePlacesUsage: googleUsage
      },
      security: {
        overallScore: securityAudit.overallScore,
        criticalIssuesCount: securityAudit.criticalIssues.length,
        warningsCount: securityAudit.warnings.length
      },
      overallHealth: calculateOverallHealth(dbStatus, backupHealth, googleUsage, securityAudit)
    };
    return new Response(JSON.stringify(systemStatus), {
      status: 200,
      headers: { "Content-Type": "application/json" }
    });
  } catch (error) {
    console.error("[Admin API] System status check failed:", error);
    return new Response(JSON.stringify({
      error: "System status check failed",
      message: error.message
    }), {
      status: 500,
      headers: { "Content-Type": "application/json" }
    });
  }
}
async function checkDatabaseStatus(env) {
  try {
    const stmt = env.DB.prepare('SELECT COUNT(*) as count FROM sqlite_master WHERE type = "table"');
    const result = await stmt.first();
    return {
      connected: true,
      tableCount: result.count,
      status: "healthy"
    };
  } catch (error) {
    return {
      connected: false,
      error: error.message,
      status: "error"
    };
  }
}
async function handleCacheStats(request, env) {
  try {
    const cacheStats = getCacheStatsSummary();
    return new Response(JSON.stringify({
      success: true,
      timestamp: (/* @__PURE__ */ new Date()).toISOString(),
      stats: cacheStats
    }), {
      status: 200,
      headers: { "Content-Type": "application/json" }
    });
  } catch (error) {
    console.error("[Admin API] Cache stats failed:", error);
    return new Response(JSON.stringify({
      success: false,
      error: "Failed to get cache stats",
      message: error.message
    }), {
      status: 500,
      headers: { "Content-Type": "application/json" }
    });
  }
}
async function handlePerformanceMetrics(request, env) {
  try {
    const metrics = performanceMetrics.getAllStats();
    return new Response(JSON.stringify({
      success: true,
      timestamp: (/* @__PURE__ */ new Date()).toISOString(),
      metrics
    }), {
      status: 200,
      headers: { "Content-Type": "application/json" }
    });
  } catch (error) {
    console.error("[Admin API] Performance metrics failed:", error);
    return new Response(JSON.stringify({
      success: false,
      error: "Failed to get performance metrics",
      message: error.message
    }), {
      status: 500,
      headers: { "Content-Type": "application/json" }
    });
  }
}
function calculateOverallHealth(dbStatus, backupHealth, googleUsage, securityAudit) {
  let score = 100;
  if (!dbStatus.connected)
    score -= 30;
  if (!backupHealth.healthy)
    score -= 20;
  if (googleUsage.status === "warning")
    score -= 10;
  if (googleUsage.status === "critical")
    score -= 20;
  score = Math.min(score, securityAudit.overallScore);
  return {
    score: Math.max(0, score),
    status: score >= 80 ? "healthy" : score >= 60 ? "warning" : "critical",
    issues: []
  };
}
async function handleListUsers(request, env) {
  try {
    const url = new URL(request.url);
    const role = url.searchParams.get("role");
    const search = url.searchParams.get("search");
    let query = "SELECT id, email, name, role, created_at, lastLogin FROM users WHERE 1=1";
    const params = [];
    if (role) {
      query += " AND role = ?";
      params.push(role);
    }
    if (search) {
      query += " AND (email LIKE ? OR name LIKE ?)";
      params.push(`%${search}%`, `%${search}%`);
    }
    query += " ORDER BY created_at DESC LIMIT 100";
    const result = await env.DB.prepare(query).bind(...params).all();
    return new Response(JSON.stringify({
      success: true,
      users: result.results || []
    }), {
      status: 200,
      headers: { "Content-Type": "application/json" }
    });
  } catch (error) {
    console.error("[Admin API] Error listing users:", error);
    return new Response(JSON.stringify({
      error: "Failed to list users",
      message: error.message
    }), {
      status: 500,
      headers: { "Content-Type": "application/json" }
    });
  }
}
async function handleSetUserRole(request, env) {
  if (request.method !== "POST") {
    return new Response("Method not allowed", { status: 405 });
  }
  try {
    const body = await request.json();
    const { email, role } = body;
    if (!email || !role) {
      return new Response(JSON.stringify({ error: "Email and role are required" }), {
        status: 400,
        headers: { "Content-Type": "application/json" }
      });
    }
    if (role !== "admin" && role !== "user") {
      return new Response(JSON.stringify({ error: 'Invalid role. Must be "admin" or "user"' }), {
        status: 400,
        headers: { "Content-Type": "application/json" }
      });
    }
    const userCheck = await env.DB.prepare(
      "SELECT id, email, role FROM users WHERE email = ?"
    ).bind(email).first();
    if (!userCheck) {
      return new Response(JSON.stringify({ error: "User not found" }), {
        status: 404,
        headers: { "Content-Type": "application/json" }
      });
    }
    await env.DB.prepare(
      "UPDATE users SET role = ? WHERE email = ?"
    ).bind(role, email).run();
    return new Response(JSON.stringify({
      success: true,
      message: `User role updated to ${role}`,
      user: {
        email,
        role
      }
    }), {
      status: 200,
      headers: { "Content-Type": "application/json" }
    });
  } catch (error) {
    console.error("[Admin API] Error setting user role:", error);
    return new Response(JSON.stringify({
      error: "Failed to set user role",
      message: error.message
    }), {
      status: 500,
      headers: { "Content-Type": "application/json" }
    });
  }
}
async function handleGetUserRole(request, env) {
  try {
    const url = new URL(request.url);
    const email = url.searchParams.get("email");
    if (!email) {
      return new Response(JSON.stringify({ error: "Email parameter is required" }), {
        status: 400,
        headers: { "Content-Type": "application/json" }
      });
    }
    const user = await env.DB.prepare(
      "SELECT id, email, name, role, created_at FROM users WHERE email = ?"
    ).bind(email).first();
    if (!user) {
      return new Response(JSON.stringify({ error: "User not found" }), {
        status: 404,
        headers: { "Content-Type": "application/json" }
      });
    }
    return new Response(JSON.stringify({
      success: true,
      user: {
        id: user.id,
        email: user.email,
        name: user.name,
        role: user.role,
        created_at: user.created_at
      }
    }), {
      status: 200,
      headers: { "Content-Type": "application/json" }
    });
  } catch (error) {
    console.error("[Admin API] Error getting user role:", error);
    return new Response(JSON.stringify({
      error: "Failed to get user role",
      message: error.message
    }), {
      status: 500,
      headers: { "Content-Type": "application/json" }
    });
  }
}
async function handleEcosystemReport(request, env) {
  try {
    const url = new URL(request.url);
    const days = parseInt(url.searchParams.get("days") || "7");
    const serviceFactory = new ServiceFactory(env);
    const ecosystemService = serviceFactory.getService("ecosystemService");
    const report = await ecosystemService.getEcosystemReport({ days });
    return new Response(JSON.stringify(report), {
      status: 200,
      headers: { "Content-Type": "application/json" }
    });
  } catch (error) {
    console.error("[Admin API] Ecosystem report failed:", error);
    return new Response(JSON.stringify({
      error: "Failed to get ecosystem report",
      message: error.message
    }), {
      status: 500,
      headers: { "Content-Type": "application/json" }
    });
  }
}
async function handleEcosystemWellbeing(request, env) {
  try {
    const url = new URL(request.url);
    const userId = url.searchParams.get("userId");
    const days = parseInt(url.searchParams.get("days") || "30");
    const serviceFactory = new ServiceFactory(env);
    const ecosystemService = serviceFactory.getService("ecosystemService");
    const wellbeing = await ecosystemService.getUserWellbeing(userId, { days });
    return new Response(JSON.stringify(wellbeing), {
      status: 200,
      headers: { "Content-Type": "application/json" }
    });
  } catch (error) {
    console.error("[Admin API] Ecosystem wellbeing failed:", error);
    return new Response(JSON.stringify({
      error: "Failed to get wellbeing data",
      message: error.message
    }), {
      status: 500,
      headers: { "Content-Type": "application/json" }
    });
  }
}
async function handleEcosystemResources(request, env) {
  try {
    const url = new URL(request.url);
    const days = parseInt(url.searchParams.get("days") || "7");
    const serviceFactory = new ServiceFactory(env);
    const ecosystemService = serviceFactory.getService("ecosystemService");
    const usage = await ecosystemService.getResourceUsage({ days });
    return new Response(JSON.stringify(usage), {
      status: 200,
      headers: { "Content-Type": "application/json" }
    });
  } catch (error) {
    console.error("[Admin API] Ecosystem resources failed:", error);
    return new Response(JSON.stringify({
      error: "Failed to get resource usage",
      message: error.message
    }), {
      status: 500,
      headers: { "Content-Type": "application/json" }
    });
  }
}
async function handleEcosystemCommunity(request, env) {
  try {
    const url = new URL(request.url);
    const days = parseInt(url.searchParams.get("days") || "7");
    const serviceFactory = new ServiceFactory(env);
    const ecosystemService = serviceFactory.getService("ecosystemService");
    const health = await ecosystemService.getCommunityHealth({ days });
    return new Response(JSON.stringify(health), {
      status: 200,
      headers: { "Content-Type": "application/json" }
    });
  } catch (error) {
    console.error("[Admin API] Ecosystem community failed:", error);
    return new Response(JSON.stringify({
      error: "Failed to get community health",
      message: error.message
    }), {
      status: 500,
      headers: { "Content-Type": "application/json" }
    });
  }
}
async function handleEcosystemAgents(request, env) {
  try {
    const serviceFactory = new ServiceFactory(env);
    const aiAgentFactory = serviceFactory.getService("aiAgentFactory");
    const stats = aiAgentFactory.getStats();
    const allStates = aiAgentFactory.getAllAgentStates();
    return new Response(JSON.stringify({
      stats,
      agents: allStates
    }), {
      status: 200,
      headers: { "Content-Type": "application/json" }
    });
  } catch (error) {
    console.error("[Admin API] Ecosystem agents failed:", error);
    return new Response(JSON.stringify({
      error: "Failed to get agent stats",
      message: error.message
    }), {
      status: 500,
      headers: { "Content-Type": "application/json" }
    });
  }
}
var init_admin = __esm({
  "src/api/admin.js"() {
    "use strict";
    init_BackupService();
    init_RateLimitService();
    init_SecurityAuditService();
    init_auth();
    init_cacheMonitor();
    init_ServiceFactory();
  }
});

// src/api/ai.js
var ai_exports = {};
__export(ai_exports, {
  handleAIRequest: () => handleAIRequest
});
async function handleAIRequest(request, env, user, ctx) {
  const url = new URL(request.url);
  const path = url.pathname;
  if (!env.OPENAI_API_KEY) {
    console.error("[AI API] OpenAI API key not configured");
    return new Response(JSON.stringify({
      error: "OpenAI API key not configured",
      message: "OpenAI API key not configured"
    }), {
      status: 500,
      headers: { "Content-Type": "application/json" }
    });
  }
  if (!env.OPENAI_API_KEY.startsWith("sk-")) {
    console.error("[AI API] Invalid OpenAI API key format");
    return new Response(JSON.stringify({
      error: "Invalid API key format",
      message: "Invalid OpenAI API key format"
    }), {
      status: 500,
      headers: { "Content-Type": "application/json" }
    });
  }
  try {
    const locationService = env.locationService || null;
    console.log("[AI API] Initializing AIService with API keys:", {
      openai: env.OPENAI_API_KEY ? env.OPENAI_API_KEY.substring(0, 10) + "..." : "missing",
      gemini: env.GEMINI_API_KEY ? env.GEMINI_API_KEY.substring(0, 10) + "..." : "missing",
      googleMaps: env.GOOGLE_MAPS_API_KEY ? env.GOOGLE_MAPS_API_KEY.substring(0, 10) + "..." : "missing"
    });
    const aiService = new AIService(
      env.DB,
      env.OPENAI_API_KEY,
      env.GEMINI_API_KEY,
      locationService,
      env.GOOGLE_MAPS_API_KEY
    );
    if (path === "/api/ai/query" && request.method === "POST") {
      return await handleAIQuery(request, env, user, aiService, ctx);
    }
    if (path === "/api/ai/feedback" && request.method === "POST") {
      return await handleAIFeedback(request, env, user, aiService);
    }
    if (path === "/api/ai/history" && request.method === "GET") {
      return await handleAIHistory(request, env, user, aiService);
    }
    if (path === "/api/ai/location-selected" && request.method === "POST") {
      return await handleLocationSelected(request, env, user, aiService);
    }
    return new Response(JSON.stringify({ error: "API endpoint not found" }), {
      status: 404,
      headers: { "Content-Type": "application/json" }
    });
  } catch (error) {
    console.error("[AI API] Error:", error);
    return new Response(JSON.stringify({
      error: "Internal server error",
      message: error.message
    }), {
      status: 500,
      headers: { "Content-Type": "application/json" }
    });
  }
}
async function handleAIQuery(request, env, user, aiService, ctx) {
  var _a;
  try {
    const body = await request.json();
    const { message, sessionId, mode } = body;
    if (!message || typeof message !== "string" || message.trim().length === 0) {
      return new Response(JSON.stringify({
        error: "Message is required"
      }), {
        status: 400,
        headers: { "Content-Type": "application/json" }
      });
    }
    if (message.length > 1e3) {
      return new Response(JSON.stringify({
        error: "Message too long (max 1000 characters)"
      }), {
        status: 400,
        headers: { "Content-Type": "application/json" }
      });
    }
    const userId = user ? user.id : null;
    const finalSessionId = sessionId || generateSessionId2();
    console.log("[AI API] Processing query:", {
      userId: userId || "anonymous",
      sessionId: finalSessionId,
      messageLength: message.length,
      mode: mode || "auto"
    });
    const result = await aiService.handleQuery(userId, finalSessionId, message.trim(), mode, ctx);
    console.log("[AI API] Query result:", {
      success: result.success,
      messageLength: ((_a = result.message) == null ? void 0 : _a.length) || 0,
      hasError: !!result.error,
      model: result.model,
      mode: result.mode
    });
    return new Response(JSON.stringify({
      success: result.success,
      message: result.message,
      sessionId: finalSessionId,
      model: result.model,
      // 使用的模型（gemini 或 gpt）
      mode: result.mode,
      // 使用的模式（traveler 或 resident）
      // 在開發環境或管理員可以看到錯誤詳情
      error: result.error,
      details: result.details
    }), {
      status: 200,
      headers: { "Content-Type": "application/json" }
    });
  } catch (error) {
    console.error("[AI API] Error handling query:", error);
    return new Response(JSON.stringify({
      success: false,
      error: "Failed to process query",
      message: error.message || "\u8655\u7406\u67E5\u8A62\u6642\u767C\u751F\u932F\u8AA4"
    }), {
      status: 500,
      headers: { "Content-Type": "application/json" }
    });
  }
}
async function handleAIFeedback(request, env, user, aiService) {
  try {
    const body = await request.json();
    const { conversationId, feedbackType, feedbackContent } = body;
    if (!conversationId || !feedbackType) {
      return new Response(JSON.stringify({
        error: "conversationId and feedbackType are required"
      }), {
        status: 400,
        headers: { "Content-Type": "application/json" }
      });
    }
    const userId = user ? user.id : null;
    const success = await aiService.saveFeedback(
      conversationId,
      userId,
      feedbackType,
      feedbackContent
    );
    return new Response(JSON.stringify({
      success
    }), {
      status: 200,
      headers: { "Content-Type": "application/json" }
    });
  } catch (error) {
    console.error("[AI API] Error handling feedback:", error);
    return new Response(JSON.stringify({
      error: "Failed to save feedback",
      message: error.message
    }), {
      status: 500,
      headers: { "Content-Type": "application/json" }
    });
  }
}
async function handleAIHistory(request, env, user, aiService) {
  try {
    const url = new URL(request.url);
    const sessionId = url.searchParams.get("sessionId");
    const limit = parseInt(url.searchParams.get("limit") || "20");
    if (!sessionId) {
      return new Response(JSON.stringify({
        error: "sessionId is required"
      }), {
        status: 400,
        headers: { "Content-Type": "application/json" }
      });
    }
    const history = await env.DB.prepare(
      `SELECT id, message_type, message_content, created_at
       FROM ai_conversations
       WHERE session_id = ?
       ORDER BY created_at ASC
       LIMIT ?`
    ).bind(sessionId, limit).all();
    return new Response(JSON.stringify({
      success: true,
      history: history.results || []
    }), {
      status: 200,
      headers: { "Content-Type": "application/json" }
    });
  } catch (error) {
    console.error("[AI API] Error handling history:", error);
    return new Response(JSON.stringify({
      error: "Failed to fetch history",
      message: error.message
    }), {
      status: 500,
      headers: { "Content-Type": "application/json" }
    });
  }
}
async function handleLocationSelected(request, env, user, aiService) {
  try {
    const body = await request.json();
    const { place, sessionId } = body;
    if (!place || !place.location) {
      return new Response(JSON.stringify({
        success: false,
        error: "Place information is required"
      }), {
        status: 400,
        headers: { "Content-Type": "application/json" }
      });
    }
    const userId = user ? user.id : null;
    if (sessionId) {
      try {
        await env.DB.prepare(
          `INSERT INTO ai_conversations (session_id, user_id, message_type, message_content, created_at)
           VALUES (?, ?, ?, ?, ?)`
        ).bind(
          sessionId,
          userId,
          "location_selected",
          JSON.stringify({
            place,
            timestamp: (/* @__PURE__ */ new Date()).toISOString()
          }),
          (/* @__PURE__ */ new Date()).toISOString()
        ).run();
        console.log("[AI API] Location saved to conversation:", sessionId);
      } catch (dbError) {
        console.error("[AI API] Error saving location to conversation:", dbError);
      }
    }
    if (userId && place.name && place.location) {
      try {
        const locationService = env.locationService;
        if (locationService) {
          console.log("[AI API] Location selected by user:", userId, place);
        }
      } catch (error) {
        console.error("[AI API] Error saving location:", error);
      }
    }
    return new Response(JSON.stringify({
      success: true,
      message: "Location saved successfully"
    }), {
      status: 200,
      headers: { "Content-Type": "application/json" }
    });
  } catch (error) {
    console.error("[AI API] Error handling location selection:", error);
    return new Response(JSON.stringify({
      success: false,
      error: "Failed to save location",
      message: error.message || "Unknown error"
    }), {
      status: 500,
      headers: { "Content-Type": "application/json" }
    });
  }
}
function generateSessionId2() {
  return `session_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
}
var init_ai = __esm({
  "src/api/ai.js"() {
    "use strict";
    init_AIService();
  }
});

// node_modules/hono/dist/compose.js
var compose;
var init_compose = __esm({
  "node_modules/hono/dist/compose.js"() {
    compose = (middleware, onError, onNotFound) => {
      return (context, next) => {
        let index = -1;
        return dispatch(0);
        async function dispatch(i) {
          if (i <= index) {
            throw new Error("next() called multiple times");
          }
          index = i;
          let res;
          let isError = false;
          let handler;
          if (middleware[i]) {
            handler = middleware[i][0][0];
            context.req.routeIndex = i;
          } else {
            handler = i === middleware.length && next || void 0;
          }
          if (handler) {
            try {
              res = await handler(context, () => dispatch(i + 1));
            } catch (err) {
              if (err instanceof Error && onError) {
                context.error = err;
                res = await onError(err, context);
                isError = true;
              } else {
                throw err;
              }
            }
          } else {
            if (context.finalized === false && onNotFound) {
              res = await onNotFound(context);
            }
          }
          if (res && (context.finalized === false || isError)) {
            context.res = res;
          }
          return context;
        }
      };
    };
  }
});

// node_modules/hono/dist/http-exception.js
var init_http_exception = __esm({
  "node_modules/hono/dist/http-exception.js"() {
  }
});

// node_modules/hono/dist/request/constants.js
var GET_MATCH_RESULT;
var init_constants = __esm({
  "node_modules/hono/dist/request/constants.js"() {
    GET_MATCH_RESULT = /* @__PURE__ */ Symbol();
  }
});

// node_modules/hono/dist/utils/body.js
async function parseFormData(request, options) {
  const formData = await request.formData();
  if (formData) {
    return convertFormDataToBodyData(formData, options);
  }
  return {};
}
function convertFormDataToBodyData(formData, options) {
  const form = /* @__PURE__ */ Object.create(null);
  formData.forEach((value, key) => {
    const shouldParseAllValues = options.all || key.endsWith("[]");
    if (!shouldParseAllValues) {
      form[key] = value;
    } else {
      handleParsingAllValues(form, key, value);
    }
  });
  if (options.dot) {
    Object.entries(form).forEach(([key, value]) => {
      const shouldParseDotValues = key.includes(".");
      if (shouldParseDotValues) {
        handleParsingNestedValues(form, key, value);
        delete form[key];
      }
    });
  }
  return form;
}
var parseBody, handleParsingAllValues, handleParsingNestedValues;
var init_body = __esm({
  "node_modules/hono/dist/utils/body.js"() {
    init_request();
    parseBody = async (request, options = /* @__PURE__ */ Object.create(null)) => {
      const { all = false, dot = false } = options;
      const headers = request instanceof HonoRequest ? request.raw.headers : request.headers;
      const contentType = headers.get("Content-Type");
      if ((contentType == null ? void 0 : contentType.startsWith("multipart/form-data")) || (contentType == null ? void 0 : contentType.startsWith("application/x-www-form-urlencoded"))) {
        return parseFormData(request, { all, dot });
      }
      return {};
    };
    handleParsingAllValues = (form, key, value) => {
      if (form[key] !== void 0) {
        if (Array.isArray(form[key])) {
          ;
          form[key].push(value);
        } else {
          form[key] = [form[key], value];
        }
      } else {
        if (!key.endsWith("[]")) {
          form[key] = value;
        } else {
          form[key] = [value];
        }
      }
    };
    handleParsingNestedValues = (form, key, value) => {
      let nestedForm = form;
      const keys = key.split(".");
      keys.forEach((key2, index) => {
        if (index === keys.length - 1) {
          nestedForm[key2] = value;
        } else {
          if (!nestedForm[key2] || typeof nestedForm[key2] !== "object" || Array.isArray(nestedForm[key2]) || nestedForm[key2] instanceof File) {
            nestedForm[key2] = /* @__PURE__ */ Object.create(null);
          }
          nestedForm = nestedForm[key2];
        }
      });
    };
  }
});

// node_modules/hono/dist/utils/url.js
var splitPath, splitRoutingPath, extractGroupsFromPath, replaceGroupMarks, patternCache, getPattern, tryDecode, tryDecodeURI, getPath, getPathNoStrict, mergePath, checkOptionalParameter, _decodeURI, _getQueryParam, getQueryParam, getQueryParams, decodeURIComponent_;
var init_url = __esm({
  "node_modules/hono/dist/utils/url.js"() {
    splitPath = (path) => {
      const paths = path.split("/");
      if (paths[0] === "") {
        paths.shift();
      }
      return paths;
    };
    splitRoutingPath = (routePath) => {
      const { groups, path } = extractGroupsFromPath(routePath);
      const paths = splitPath(path);
      return replaceGroupMarks(paths, groups);
    };
    extractGroupsFromPath = (path) => {
      const groups = [];
      path = path.replace(/\{[^}]+\}/g, (match2, index) => {
        const mark = `@${index}`;
        groups.push([mark, match2]);
        return mark;
      });
      return { groups, path };
    };
    replaceGroupMarks = (paths, groups) => {
      for (let i = groups.length - 1; i >= 0; i--) {
        const [mark] = groups[i];
        for (let j = paths.length - 1; j >= 0; j--) {
          if (paths[j].includes(mark)) {
            paths[j] = paths[j].replace(mark, groups[i][1]);
            break;
          }
        }
      }
      return paths;
    };
    patternCache = {};
    getPattern = (label, next) => {
      if (label === "*") {
        return "*";
      }
      const match2 = label.match(/^\:([^\{\}]+)(?:\{(.+)\})?$/);
      if (match2) {
        const cacheKey = `${label}#${next}`;
        if (!patternCache[cacheKey]) {
          if (match2[2]) {
            patternCache[cacheKey] = next && next[0] !== ":" && next[0] !== "*" ? [cacheKey, match2[1], new RegExp(`^${match2[2]}(?=/${next})`)] : [label, match2[1], new RegExp(`^${match2[2]}$`)];
          } else {
            patternCache[cacheKey] = [label, match2[1], true];
          }
        }
        return patternCache[cacheKey];
      }
      return null;
    };
    tryDecode = (str, decoder) => {
      try {
        return decoder(str);
      } catch {
        return str.replace(/(?:%[0-9A-Fa-f]{2})+/g, (match2) => {
          try {
            return decoder(match2);
          } catch {
            return match2;
          }
        });
      }
    };
    tryDecodeURI = (str) => tryDecode(str, decodeURI);
    getPath = (request) => {
      const url = request.url;
      const start = url.indexOf("/", url.indexOf(":") + 4);
      let i = start;
      for (; i < url.length; i++) {
        const charCode = url.charCodeAt(i);
        if (charCode === 37) {
          const queryIndex = url.indexOf("?", i);
          const path = url.slice(start, queryIndex === -1 ? void 0 : queryIndex);
          return tryDecodeURI(path.includes("%25") ? path.replace(/%25/g, "%2525") : path);
        } else if (charCode === 63) {
          break;
        }
      }
      return url.slice(start, i);
    };
    getPathNoStrict = (request) => {
      const result = getPath(request);
      return result.length > 1 && result.at(-1) === "/" ? result.slice(0, -1) : result;
    };
    mergePath = (base, sub, ...rest) => {
      if (rest.length) {
        sub = mergePath(sub, ...rest);
      }
      return `${(base == null ? void 0 : base[0]) === "/" ? "" : "/"}${base}${sub === "/" ? "" : `${(base == null ? void 0 : base.at(-1)) === "/" ? "" : "/"}${(sub == null ? void 0 : sub[0]) === "/" ? sub.slice(1) : sub}`}`;
    };
    checkOptionalParameter = (path) => {
      if (path.charCodeAt(path.length - 1) !== 63 || !path.includes(":")) {
        return null;
      }
      const segments = path.split("/");
      const results = [];
      let basePath = "";
      segments.forEach((segment) => {
        if (segment !== "" && !/\:/.test(segment)) {
          basePath += "/" + segment;
        } else if (/\:/.test(segment)) {
          if (/\?/.test(segment)) {
            if (results.length === 0 && basePath === "") {
              results.push("/");
            } else {
              results.push(basePath);
            }
            const optionalSegment = segment.replace("?", "");
            basePath += "/" + optionalSegment;
            results.push(basePath);
          } else {
            basePath += "/" + segment;
          }
        }
      });
      return results.filter((v, i, a) => a.indexOf(v) === i);
    };
    _decodeURI = (value) => {
      if (!/[%+]/.test(value)) {
        return value;
      }
      if (value.indexOf("+") !== -1) {
        value = value.replace(/\+/g, " ");
      }
      return value.indexOf("%") !== -1 ? tryDecode(value, decodeURIComponent_) : value;
    };
    _getQueryParam = (url, key, multiple) => {
      let encoded;
      if (!multiple && key && !/[%+]/.test(key)) {
        let keyIndex2 = url.indexOf("?", 8);
        if (keyIndex2 === -1) {
          return void 0;
        }
        if (!url.startsWith(key, keyIndex2 + 1)) {
          keyIndex2 = url.indexOf(`&${key}`, keyIndex2 + 1);
        }
        while (keyIndex2 !== -1) {
          const trailingKeyCode = url.charCodeAt(keyIndex2 + key.length + 1);
          if (trailingKeyCode === 61) {
            const valueIndex = keyIndex2 + key.length + 2;
            const endIndex = url.indexOf("&", valueIndex);
            return _decodeURI(url.slice(valueIndex, endIndex === -1 ? void 0 : endIndex));
          } else if (trailingKeyCode == 38 || isNaN(trailingKeyCode)) {
            return "";
          }
          keyIndex2 = url.indexOf(`&${key}`, keyIndex2 + 1);
        }
        encoded = /[%+]/.test(url);
        if (!encoded) {
          return void 0;
        }
      }
      const results = {};
      encoded ??= /[%+]/.test(url);
      let keyIndex = url.indexOf("?", 8);
      while (keyIndex !== -1) {
        const nextKeyIndex = url.indexOf("&", keyIndex + 1);
        let valueIndex = url.indexOf("=", keyIndex);
        if (valueIndex > nextKeyIndex && nextKeyIndex !== -1) {
          valueIndex = -1;
        }
        let name = url.slice(
          keyIndex + 1,
          valueIndex === -1 ? nextKeyIndex === -1 ? void 0 : nextKeyIndex : valueIndex
        );
        if (encoded) {
          name = _decodeURI(name);
        }
        keyIndex = nextKeyIndex;
        if (name === "") {
          continue;
        }
        let value;
        if (valueIndex === -1) {
          value = "";
        } else {
          value = url.slice(valueIndex + 1, nextKeyIndex === -1 ? void 0 : nextKeyIndex);
          if (encoded) {
            value = _decodeURI(value);
          }
        }
        if (multiple) {
          if (!(results[name] && Array.isArray(results[name]))) {
            results[name] = [];
          }
          ;
          results[name].push(value);
        } else {
          results[name] ??= value;
        }
      }
      return key ? results[key] : results;
    };
    getQueryParam = _getQueryParam;
    getQueryParams = (url, key) => {
      return _getQueryParam(url, key, true);
    };
    decodeURIComponent_ = decodeURIComponent;
  }
});

// node_modules/hono/dist/request.js
var tryDecodeURIComponent, HonoRequest;
var init_request = __esm({
  "node_modules/hono/dist/request.js"() {
    init_http_exception();
    init_constants();
    init_body();
    init_url();
    tryDecodeURIComponent = (str) => tryDecode(str, decodeURIComponent_);
    HonoRequest = class {
      /**
       * `.raw` can get the raw Request object.
       *
       * @see {@link https://hono.dev/docs/api/request#raw}
       *
       * @example
       * ```ts
       * // For Cloudflare Workers
       * app.post('/', async (c) => {
       *   const metadata = c.req.raw.cf?.hostMetadata?
       *   ...
       * })
       * ```
       */
      raw;
      #validatedData;
      // Short name of validatedData
      #matchResult;
      routeIndex = 0;
      /**
       * `.path` can get the pathname of the request.
       *
       * @see {@link https://hono.dev/docs/api/request#path}
       *
       * @example
       * ```ts
       * app.get('/about/me', (c) => {
       *   const pathname = c.req.path // `/about/me`
       * })
       * ```
       */
      path;
      bodyCache = {};
      constructor(request, path = "/", matchResult = [[]]) {
        this.raw = request;
        this.path = path;
        this.#matchResult = matchResult;
        this.#validatedData = {};
      }
      param(key) {
        return key ? this.#getDecodedParam(key) : this.#getAllDecodedParams();
      }
      #getDecodedParam(key) {
        const paramKey = this.#matchResult[0][this.routeIndex][1][key];
        const param = this.#getParamValue(paramKey);
        return param && /\%/.test(param) ? tryDecodeURIComponent(param) : param;
      }
      #getAllDecodedParams() {
        const decoded = {};
        const keys = Object.keys(this.#matchResult[0][this.routeIndex][1]);
        for (const key of keys) {
          const value = this.#getParamValue(this.#matchResult[0][this.routeIndex][1][key]);
          if (value !== void 0) {
            decoded[key] = /\%/.test(value) ? tryDecodeURIComponent(value) : value;
          }
        }
        return decoded;
      }
      #getParamValue(paramKey) {
        return this.#matchResult[1] ? this.#matchResult[1][paramKey] : paramKey;
      }
      query(key) {
        return getQueryParam(this.url, key);
      }
      queries(key) {
        return getQueryParams(this.url, key);
      }
      header(name) {
        if (name) {
          return this.raw.headers.get(name) ?? void 0;
        }
        const headerData = {};
        this.raw.headers.forEach((value, key) => {
          headerData[key] = value;
        });
        return headerData;
      }
      async parseBody(options) {
        return this.bodyCache.parsedBody ??= await parseBody(this, options);
      }
      #cachedBody = (key) => {
        const { bodyCache, raw: raw2 } = this;
        const cachedBody = bodyCache[key];
        if (cachedBody) {
          return cachedBody;
        }
        const anyCachedKey = Object.keys(bodyCache)[0];
        if (anyCachedKey) {
          return bodyCache[anyCachedKey].then((body) => {
            if (anyCachedKey === "json") {
              body = JSON.stringify(body);
            }
            return new Response(body)[key]();
          });
        }
        return bodyCache[key] = raw2[key]();
      };
      /**
       * `.json()` can parse Request body of type `application/json`
       *
       * @see {@link https://hono.dev/docs/api/request#json}
       *
       * @example
       * ```ts
       * app.post('/entry', async (c) => {
       *   const body = await c.req.json()
       * })
       * ```
       */
      json() {
        return this.#cachedBody("text").then((text) => JSON.parse(text));
      }
      /**
       * `.text()` can parse Request body of type `text/plain`
       *
       * @see {@link https://hono.dev/docs/api/request#text}
       *
       * @example
       * ```ts
       * app.post('/entry', async (c) => {
       *   const body = await c.req.text()
       * })
       * ```
       */
      text() {
        return this.#cachedBody("text");
      }
      /**
       * `.arrayBuffer()` parse Request body as an `ArrayBuffer`
       *
       * @see {@link https://hono.dev/docs/api/request#arraybuffer}
       *
       * @example
       * ```ts
       * app.post('/entry', async (c) => {
       *   const body = await c.req.arrayBuffer()
       * })
       * ```
       */
      arrayBuffer() {
        return this.#cachedBody("arrayBuffer");
      }
      /**
       * Parses the request body as a `Blob`.
       * @example
       * ```ts
       * app.post('/entry', async (c) => {
       *   const body = await c.req.blob();
       * });
       * ```
       * @see https://hono.dev/docs/api/request#blob
       */
      blob() {
        return this.#cachedBody("blob");
      }
      /**
       * Parses the request body as `FormData`.
       * @example
       * ```ts
       * app.post('/entry', async (c) => {
       *   const body = await c.req.formData();
       * });
       * ```
       * @see https://hono.dev/docs/api/request#formdata
       */
      formData() {
        return this.#cachedBody("formData");
      }
      /**
       * Adds validated data to the request.
       *
       * @param target - The target of the validation.
       * @param data - The validated data to add.
       */
      addValidatedData(target, data) {
        this.#validatedData[target] = data;
      }
      valid(target) {
        return this.#validatedData[target];
      }
      /**
       * `.url()` can get the request url strings.
       *
       * @see {@link https://hono.dev/docs/api/request#url}
       *
       * @example
       * ```ts
       * app.get('/about/me', (c) => {
       *   const url = c.req.url // `http://localhost:8787/about/me`
       *   ...
       * })
       * ```
       */
      get url() {
        return this.raw.url;
      }
      /**
       * `.method()` can get the method name of the request.
       *
       * @see {@link https://hono.dev/docs/api/request#method}
       *
       * @example
       * ```ts
       * app.get('/about/me', (c) => {
       *   const method = c.req.method // `GET`
       * })
       * ```
       */
      get method() {
        return this.raw.method;
      }
      get [GET_MATCH_RESULT]() {
        return this.#matchResult;
      }
      /**
       * `.matchedRoutes()` can return a matched route in the handler
       *
       * @deprecated
       *
       * Use matchedRoutes helper defined in "hono/route" instead.
       *
       * @see {@link https://hono.dev/docs/api/request#matchedroutes}
       *
       * @example
       * ```ts
       * app.use('*', async function logger(c, next) {
       *   await next()
       *   c.req.matchedRoutes.forEach(({ handler, method, path }, i) => {
       *     const name = handler.name || (handler.length < 2 ? '[handler]' : '[middleware]')
       *     console.log(
       *       method,
       *       ' ',
       *       path,
       *       ' '.repeat(Math.max(10 - path.length, 0)),
       *       name,
       *       i === c.req.routeIndex ? '<- respond from here' : ''
       *     )
       *   })
       * })
       * ```
       */
      get matchedRoutes() {
        return this.#matchResult[0].map(([[, route]]) => route);
      }
      /**
       * `routePath()` can retrieve the path registered within the handler
       *
       * @deprecated
       *
       * Use routePath helper defined in "hono/route" instead.
       *
       * @see {@link https://hono.dev/docs/api/request#routepath}
       *
       * @example
       * ```ts
       * app.get('/posts/:id', (c) => {
       *   return c.json({ path: c.req.routePath })
       * })
       * ```
       */
      get routePath() {
        return this.#matchResult[0].map(([[, route]]) => route)[this.routeIndex].path;
      }
    };
  }
});

// node_modules/hono/dist/utils/html.js
var HtmlEscapedCallbackPhase, raw, resolveCallback;
var init_html = __esm({
  "node_modules/hono/dist/utils/html.js"() {
    HtmlEscapedCallbackPhase = {
      Stringify: 1,
      BeforeStream: 2,
      Stream: 3
    };
    raw = (value, callbacks) => {
      const escapedString = new String(value);
      escapedString.isEscaped = true;
      escapedString.callbacks = callbacks;
      return escapedString;
    };
    resolveCallback = async (str, phase, preserveCallbacks, context, buffer) => {
      if (typeof str === "object" && !(str instanceof String)) {
        if (!(str instanceof Promise)) {
          str = str.toString();
        }
        if (str instanceof Promise) {
          str = await str;
        }
      }
      const callbacks = str.callbacks;
      if (!(callbacks == null ? void 0 : callbacks.length)) {
        return Promise.resolve(str);
      }
      if (buffer) {
        buffer[0] += str;
      } else {
        buffer = [str];
      }
      const resStr = Promise.all(callbacks.map((c) => c({ phase, buffer, context }))).then(
        (res) => Promise.all(
          res.filter(Boolean).map((str2) => resolveCallback(str2, phase, false, context, buffer))
        ).then(() => buffer[0])
      );
      if (preserveCallbacks) {
        return raw(await resStr, callbacks);
      } else {
        return resStr;
      }
    };
  }
});

// node_modules/hono/dist/context.js
var TEXT_PLAIN, setDefaultContentType, Context;
var init_context = __esm({
  "node_modules/hono/dist/context.js"() {
    init_request();
    init_html();
    TEXT_PLAIN = "text/plain; charset=UTF-8";
    setDefaultContentType = (contentType, headers) => {
      return {
        "Content-Type": contentType,
        ...headers
      };
    };
    Context = class {
      #rawRequest;
      #req;
      /**
       * `.env` can get bindings (environment variables, secrets, KV namespaces, D1 database, R2 bucket etc.) in Cloudflare Workers.
       *
       * @see {@link https://hono.dev/docs/api/context#env}
       *
       * @example
       * ```ts
       * // Environment object for Cloudflare Workers
       * app.get('*', async c => {
       *   const counter = c.env.COUNTER
       * })
       * ```
       */
      env = {};
      #var;
      finalized = false;
      /**
       * `.error` can get the error object from the middleware if the Handler throws an error.
       *
       * @see {@link https://hono.dev/docs/api/context#error}
       *
       * @example
       * ```ts
       * app.use('*', async (c, next) => {
       *   await next()
       *   if (c.error) {
       *     // do something...
       *   }
       * })
       * ```
       */
      error;
      #status;
      #executionCtx;
      #res;
      #layout;
      #renderer;
      #notFoundHandler;
      #preparedHeaders;
      #matchResult;
      #path;
      /**
       * Creates an instance of the Context class.
       *
       * @param req - The Request object.
       * @param options - Optional configuration options for the context.
       */
      constructor(req, options) {
        this.#rawRequest = req;
        if (options) {
          this.#executionCtx = options.executionCtx;
          this.env = options.env;
          this.#notFoundHandler = options.notFoundHandler;
          this.#path = options.path;
          this.#matchResult = options.matchResult;
        }
      }
      /**
       * `.req` is the instance of {@link HonoRequest}.
       */
      get req() {
        this.#req ??= new HonoRequest(this.#rawRequest, this.#path, this.#matchResult);
        return this.#req;
      }
      /**
       * @see {@link https://hono.dev/docs/api/context#event}
       * The FetchEvent associated with the current request.
       *
       * @throws Will throw an error if the context does not have a FetchEvent.
       */
      get event() {
        if (this.#executionCtx && "respondWith" in this.#executionCtx) {
          return this.#executionCtx;
        } else {
          throw Error("This context has no FetchEvent");
        }
      }
      /**
       * @see {@link https://hono.dev/docs/api/context#executionctx}
       * The ExecutionContext associated with the current request.
       *
       * @throws Will throw an error if the context does not have an ExecutionContext.
       */
      get executionCtx() {
        if (this.#executionCtx) {
          return this.#executionCtx;
        } else {
          throw Error("This context has no ExecutionContext");
        }
      }
      /**
       * @see {@link https://hono.dev/docs/api/context#res}
       * The Response object for the current request.
       */
      get res() {
        return this.#res ||= new Response(null, {
          headers: this.#preparedHeaders ??= new Headers()
        });
      }
      /**
       * Sets the Response object for the current request.
       *
       * @param _res - The Response object to set.
       */
      set res(_res) {
        if (this.#res && _res) {
          _res = new Response(_res.body, _res);
          for (const [k, v] of this.#res.headers.entries()) {
            if (k === "content-type") {
              continue;
            }
            if (k === "set-cookie") {
              const cookies = this.#res.headers.getSetCookie();
              _res.headers.delete("set-cookie");
              for (const cookie of cookies) {
                _res.headers.append("set-cookie", cookie);
              }
            } else {
              _res.headers.set(k, v);
            }
          }
        }
        this.#res = _res;
        this.finalized = true;
      }
      /**
       * `.render()` can create a response within a layout.
       *
       * @see {@link https://hono.dev/docs/api/context#render-setrenderer}
       *
       * @example
       * ```ts
       * app.get('/', (c) => {
       *   return c.render('Hello!')
       * })
       * ```
       */
      render = (...args) => {
        this.#renderer ??= (content) => this.html(content);
        return this.#renderer(...args);
      };
      /**
       * Sets the layout for the response.
       *
       * @param layout - The layout to set.
       * @returns The layout function.
       */
      setLayout = (layout) => this.#layout = layout;
      /**
       * Gets the current layout for the response.
       *
       * @returns The current layout function.
       */
      getLayout = () => this.#layout;
      /**
       * `.setRenderer()` can set the layout in the custom middleware.
       *
       * @see {@link https://hono.dev/docs/api/context#render-setrenderer}
       *
       * @example
       * ```tsx
       * app.use('*', async (c, next) => {
       *   c.setRenderer((content) => {
       *     return c.html(
       *       <html>
       *         <body>
       *           <p>{content}</p>
       *         </body>
       *       </html>
       *     )
       *   })
       *   await next()
       * })
       * ```
       */
      setRenderer = (renderer) => {
        this.#renderer = renderer;
      };
      /**
       * `.header()` can set headers.
       *
       * @see {@link https://hono.dev/docs/api/context#header}
       *
       * @example
       * ```ts
       * app.get('/welcome', (c) => {
       *   // Set headers
       *   c.header('X-Message', 'Hello!')
       *   c.header('Content-Type', 'text/plain')
       *
       *   return c.body('Thank you for coming')
       * })
       * ```
       */
      header = (name, value, options) => {
        if (this.finalized) {
          this.#res = new Response(this.#res.body, this.#res);
        }
        const headers = this.#res ? this.#res.headers : this.#preparedHeaders ??= new Headers();
        if (value === void 0) {
          headers.delete(name);
        } else if (options == null ? void 0 : options.append) {
          headers.append(name, value);
        } else {
          headers.set(name, value);
        }
      };
      status = (status) => {
        this.#status = status;
      };
      /**
       * `.set()` can set the value specified by the key.
       *
       * @see {@link https://hono.dev/docs/api/context#set-get}
       *
       * @example
       * ```ts
       * app.use('*', async (c, next) => {
       *   c.set('message', 'Hono is hot!!')
       *   await next()
       * })
       * ```
       */
      set = (key, value) => {
        this.#var ??= /* @__PURE__ */ new Map();
        this.#var.set(key, value);
      };
      /**
       * `.get()` can use the value specified by the key.
       *
       * @see {@link https://hono.dev/docs/api/context#set-get}
       *
       * @example
       * ```ts
       * app.get('/', (c) => {
       *   const message = c.get('message')
       *   return c.text(`The message is "${message}"`)
       * })
       * ```
       */
      get = (key) => {
        return this.#var ? this.#var.get(key) : void 0;
      };
      /**
       * `.var` can access the value of a variable.
       *
       * @see {@link https://hono.dev/docs/api/context#var}
       *
       * @example
       * ```ts
       * const result = c.var.client.oneMethod()
       * ```
       */
      // c.var.propName is a read-only
      get var() {
        if (!this.#var) {
          return {};
        }
        return Object.fromEntries(this.#var);
      }
      #newResponse(data, arg, headers) {
        const responseHeaders = this.#res ? new Headers(this.#res.headers) : this.#preparedHeaders ?? new Headers();
        if (typeof arg === "object" && "headers" in arg) {
          const argHeaders = arg.headers instanceof Headers ? arg.headers : new Headers(arg.headers);
          for (const [key, value] of argHeaders) {
            if (key.toLowerCase() === "set-cookie") {
              responseHeaders.append(key, value);
            } else {
              responseHeaders.set(key, value);
            }
          }
        }
        if (headers) {
          for (const [k, v] of Object.entries(headers)) {
            if (typeof v === "string") {
              responseHeaders.set(k, v);
            } else {
              responseHeaders.delete(k);
              for (const v2 of v) {
                responseHeaders.append(k, v2);
              }
            }
          }
        }
        const status = typeof arg === "number" ? arg : (arg == null ? void 0 : arg.status) ?? this.#status;
        return new Response(data, { status, headers: responseHeaders });
      }
      newResponse = (...args) => this.#newResponse(...args);
      /**
       * `.body()` can return the HTTP response.
       * You can set headers with `.header()` and set HTTP status code with `.status`.
       * This can also be set in `.text()`, `.json()` and so on.
       *
       * @see {@link https://hono.dev/docs/api/context#body}
       *
       * @example
       * ```ts
       * app.get('/welcome', (c) => {
       *   // Set headers
       *   c.header('X-Message', 'Hello!')
       *   c.header('Content-Type', 'text/plain')
       *   // Set HTTP status code
       *   c.status(201)
       *
       *   // Return the response body
       *   return c.body('Thank you for coming')
       * })
       * ```
       */
      body = (data, arg, headers) => this.#newResponse(data, arg, headers);
      /**
       * `.text()` can render text as `Content-Type:text/plain`.
       *
       * @see {@link https://hono.dev/docs/api/context#text}
       *
       * @example
       * ```ts
       * app.get('/say', (c) => {
       *   return c.text('Hello!')
       * })
       * ```
       */
      text = (text, arg, headers) => {
        return !this.#preparedHeaders && !this.#status && !arg && !headers && !this.finalized ? new Response(text) : this.#newResponse(
          text,
          arg,
          setDefaultContentType(TEXT_PLAIN, headers)
        );
      };
      /**
       * `.json()` can render JSON as `Content-Type:application/json`.
       *
       * @see {@link https://hono.dev/docs/api/context#json}
       *
       * @example
       * ```ts
       * app.get('/api', (c) => {
       *   return c.json({ message: 'Hello!' })
       * })
       * ```
       */
      json = (object, arg, headers) => {
        return this.#newResponse(
          JSON.stringify(object),
          arg,
          setDefaultContentType("application/json", headers)
        );
      };
      html = (html, arg, headers) => {
        const res = (html2) => this.#newResponse(html2, arg, setDefaultContentType("text/html; charset=UTF-8", headers));
        return typeof html === "object" ? resolveCallback(html, HtmlEscapedCallbackPhase.Stringify, false, {}).then(res) : res(html);
      };
      /**
       * `.redirect()` can Redirect, default status code is 302.
       *
       * @see {@link https://hono.dev/docs/api/context#redirect}
       *
       * @example
       * ```ts
       * app.get('/redirect', (c) => {
       *   return c.redirect('/')
       * })
       * app.get('/redirect-permanently', (c) => {
       *   return c.redirect('/', 301)
       * })
       * ```
       */
      redirect = (location, status) => {
        const locationString = String(location);
        this.header(
          "Location",
          // Multibyes should be encoded
          // eslint-disable-next-line no-control-regex
          !/[^\x00-\xFF]/.test(locationString) ? locationString : encodeURI(locationString)
        );
        return this.newResponse(null, status ?? 302);
      };
      /**
       * `.notFound()` can return the Not Found Response.
       *
       * @see {@link https://hono.dev/docs/api/context#notfound}
       *
       * @example
       * ```ts
       * app.get('/notfound', (c) => {
       *   return c.notFound()
       * })
       * ```
       */
      notFound = () => {
        this.#notFoundHandler ??= () => new Response();
        return this.#notFoundHandler(this);
      };
    };
  }
});

// node_modules/hono/dist/router.js
var METHOD_NAME_ALL, METHOD_NAME_ALL_LOWERCASE, METHODS, MESSAGE_MATCHER_IS_ALREADY_BUILT, UnsupportedPathError;
var init_router = __esm({
  "node_modules/hono/dist/router.js"() {
    METHOD_NAME_ALL = "ALL";
    METHOD_NAME_ALL_LOWERCASE = "all";
    METHODS = ["get", "post", "put", "delete", "options", "patch"];
    MESSAGE_MATCHER_IS_ALREADY_BUILT = "Can not add a route since the matcher is already built.";
    UnsupportedPathError = class extends Error {
    };
  }
});

// node_modules/hono/dist/utils/constants.js
var COMPOSED_HANDLER;
var init_constants2 = __esm({
  "node_modules/hono/dist/utils/constants.js"() {
    COMPOSED_HANDLER = "__COMPOSED_HANDLER";
  }
});

// node_modules/hono/dist/hono-base.js
var notFoundHandler, errorHandler, Hono;
var init_hono_base = __esm({
  "node_modules/hono/dist/hono-base.js"() {
    init_compose();
    init_context();
    init_router();
    init_constants2();
    init_url();
    notFoundHandler = (c) => {
      return c.text("404 Not Found", 404);
    };
    errorHandler = (err, c) => {
      if ("getResponse" in err) {
        const res = err.getResponse();
        return c.newResponse(res.body, res);
      }
      console.error(err);
      return c.text("Internal Server Error", 500);
    };
    Hono = class _Hono {
      get;
      post;
      put;
      delete;
      options;
      patch;
      all;
      on;
      use;
      /*
        This class is like an abstract class and does not have a router.
        To use it, inherit the class and implement router in the constructor.
      */
      router;
      getPath;
      // Cannot use `#` because it requires visibility at JavaScript runtime.
      _basePath = "/";
      #path = "/";
      routes = [];
      constructor(options = {}) {
        const allMethods = [...METHODS, METHOD_NAME_ALL_LOWERCASE];
        allMethods.forEach((method) => {
          this[method] = (args1, ...args) => {
            if (typeof args1 === "string") {
              this.#path = args1;
            } else {
              this.#addRoute(method, this.#path, args1);
            }
            args.forEach((handler) => {
              this.#addRoute(method, this.#path, handler);
            });
            return this;
          };
        });
        this.on = (method, path, ...handlers) => {
          for (const p of [path].flat()) {
            this.#path = p;
            for (const m of [method].flat()) {
              handlers.map((handler) => {
                this.#addRoute(m.toUpperCase(), this.#path, handler);
              });
            }
          }
          return this;
        };
        this.use = (arg1, ...handlers) => {
          if (typeof arg1 === "string") {
            this.#path = arg1;
          } else {
            this.#path = "*";
            handlers.unshift(arg1);
          }
          handlers.forEach((handler) => {
            this.#addRoute(METHOD_NAME_ALL, this.#path, handler);
          });
          return this;
        };
        const { strict, ...optionsWithoutStrict } = options;
        Object.assign(this, optionsWithoutStrict);
        this.getPath = strict ?? true ? options.getPath ?? getPath : getPathNoStrict;
      }
      #clone() {
        const clone = new _Hono({
          router: this.router,
          getPath: this.getPath
        });
        clone.errorHandler = this.errorHandler;
        clone.#notFoundHandler = this.#notFoundHandler;
        clone.routes = this.routes;
        return clone;
      }
      #notFoundHandler = notFoundHandler;
      // Cannot use `#` because it requires visibility at JavaScript runtime.
      errorHandler = errorHandler;
      /**
       * `.route()` allows grouping other Hono instance in routes.
       *
       * @see {@link https://hono.dev/docs/api/routing#grouping}
       *
       * @param {string} path - base Path
       * @param {Hono} app - other Hono instance
       * @returns {Hono} routed Hono instance
       *
       * @example
       * ```ts
       * const app = new Hono()
       * const app2 = new Hono()
       *
       * app2.get("/user", (c) => c.text("user"))
       * app.route("/api", app2) // GET /api/user
       * ```
       */
      route(path, app) {
        const subApp = this.basePath(path);
        app.routes.map((r) => {
          let handler;
          if (app.errorHandler === errorHandler) {
            handler = r.handler;
          } else {
            handler = async (c, next) => (await compose([], app.errorHandler)(c, () => r.handler(c, next))).res;
            handler[COMPOSED_HANDLER] = r.handler;
          }
          subApp.#addRoute(r.method, r.path, handler);
        });
        return this;
      }
      /**
       * `.basePath()` allows base paths to be specified.
       *
       * @see {@link https://hono.dev/docs/api/routing#base-path}
       *
       * @param {string} path - base Path
       * @returns {Hono} changed Hono instance
       *
       * @example
       * ```ts
       * const api = new Hono().basePath('/api')
       * ```
       */
      basePath(path) {
        const subApp = this.#clone();
        subApp._basePath = mergePath(this._basePath, path);
        return subApp;
      }
      /**
       * `.onError()` handles an error and returns a customized Response.
       *
       * @see {@link https://hono.dev/docs/api/hono#error-handling}
       *
       * @param {ErrorHandler} handler - request Handler for error
       * @returns {Hono} changed Hono instance
       *
       * @example
       * ```ts
       * app.onError((err, c) => {
       *   console.error(`${err}`)
       *   return c.text('Custom Error Message', 500)
       * })
       * ```
       */
      onError = (handler) => {
        this.errorHandler = handler;
        return this;
      };
      /**
       * `.notFound()` allows you to customize a Not Found Response.
       *
       * @see {@link https://hono.dev/docs/api/hono#not-found}
       *
       * @param {NotFoundHandler} handler - request handler for not-found
       * @returns {Hono} changed Hono instance
       *
       * @example
       * ```ts
       * app.notFound((c) => {
       *   return c.text('Custom 404 Message', 404)
       * })
       * ```
       */
      notFound = (handler) => {
        this.#notFoundHandler = handler;
        return this;
      };
      /**
       * `.mount()` allows you to mount applications built with other frameworks into your Hono application.
       *
       * @see {@link https://hono.dev/docs/api/hono#mount}
       *
       * @param {string} path - base Path
       * @param {Function} applicationHandler - other Request Handler
       * @param {MountOptions} [options] - options of `.mount()`
       * @returns {Hono} mounted Hono instance
       *
       * @example
       * ```ts
       * import { Router as IttyRouter } from 'itty-router'
       * import { Hono } from 'hono'
       * // Create itty-router application
       * const ittyRouter = IttyRouter()
       * // GET /itty-router/hello
       * ittyRouter.get('/hello', () => new Response('Hello from itty-router'))
       *
       * const app = new Hono()
       * app.mount('/itty-router', ittyRouter.handle)
       * ```
       *
       * @example
       * ```ts
       * const app = new Hono()
       * // Send the request to another application without modification.
       * app.mount('/app', anotherApp, {
       *   replaceRequest: (req) => req,
       * })
       * ```
       */
      mount(path, applicationHandler, options) {
        let replaceRequest;
        let optionHandler;
        if (options) {
          if (typeof options === "function") {
            optionHandler = options;
          } else {
            optionHandler = options.optionHandler;
            if (options.replaceRequest === false) {
              replaceRequest = (request) => request;
            } else {
              replaceRequest = options.replaceRequest;
            }
          }
        }
        const getOptions = optionHandler ? (c) => {
          const options2 = optionHandler(c);
          return Array.isArray(options2) ? options2 : [options2];
        } : (c) => {
          let executionContext = void 0;
          try {
            executionContext = c.executionCtx;
          } catch {
          }
          return [c.env, executionContext];
        };
        replaceRequest ||= (() => {
          const mergedPath = mergePath(this._basePath, path);
          const pathPrefixLength = mergedPath === "/" ? 0 : mergedPath.length;
          return (request) => {
            const url = new URL(request.url);
            url.pathname = url.pathname.slice(pathPrefixLength) || "/";
            return new Request(url, request);
          };
        })();
        const handler = async (c, next) => {
          const res = await applicationHandler(replaceRequest(c.req.raw), ...getOptions(c));
          if (res) {
            return res;
          }
          await next();
        };
        this.#addRoute(METHOD_NAME_ALL, mergePath(path, "*"), handler);
        return this;
      }
      #addRoute(method, path, handler) {
        method = method.toUpperCase();
        path = mergePath(this._basePath, path);
        const r = { basePath: this._basePath, path, method, handler };
        this.router.add(method, path, [handler, r]);
        this.routes.push(r);
      }
      #handleError(err, c) {
        if (err instanceof Error) {
          return this.errorHandler(err, c);
        }
        throw err;
      }
      #dispatch(request, executionCtx, env, method) {
        if (method === "HEAD") {
          return (async () => new Response(null, await this.#dispatch(request, executionCtx, env, "GET")))();
        }
        const path = this.getPath(request, { env });
        const matchResult = this.router.match(method, path);
        const c = new Context(request, {
          path,
          matchResult,
          env,
          executionCtx,
          notFoundHandler: this.#notFoundHandler
        });
        if (matchResult[0].length === 1) {
          let res;
          try {
            res = matchResult[0][0][0][0](c, async () => {
              c.res = await this.#notFoundHandler(c);
            });
          } catch (err) {
            return this.#handleError(err, c);
          }
          return res instanceof Promise ? res.then(
            (resolved) => resolved || (c.finalized ? c.res : this.#notFoundHandler(c))
          ).catch((err) => this.#handleError(err, c)) : res ?? this.#notFoundHandler(c);
        }
        const composed = compose(matchResult[0], this.errorHandler, this.#notFoundHandler);
        return (async () => {
          try {
            const context = await composed(c);
            if (!context.finalized) {
              throw new Error(
                "Context is not finalized. Did you forget to return a Response object or `await next()`?"
              );
            }
            return context.res;
          } catch (err) {
            return this.#handleError(err, c);
          }
        })();
      }
      /**
       * `.fetch()` will be entry point of your app.
       *
       * @see {@link https://hono.dev/docs/api/hono#fetch}
       *
       * @param {Request} request - request Object of request
       * @param {Env} Env - env Object
       * @param {ExecutionContext} - context of execution
       * @returns {Response | Promise<Response>} response of request
       *
       */
      fetch = (request, ...rest) => {
        return this.#dispatch(request, rest[1], rest[0], request.method);
      };
      /**
       * `.request()` is a useful method for testing.
       * You can pass a URL or pathname to send a GET request.
       * app will return a Response object.
       * ```ts
       * test('GET /hello is ok', async () => {
       *   const res = await app.request('/hello')
       *   expect(res.status).toBe(200)
       * })
       * ```
       * @see https://hono.dev/docs/api/hono#request
       */
      request = (input, requestInit, Env, executionCtx) => {
        if (input instanceof Request) {
          return this.fetch(requestInit ? new Request(input, requestInit) : input, Env, executionCtx);
        }
        input = input.toString();
        return this.fetch(
          new Request(
            /^https?:\/\//.test(input) ? input : `http://localhost${mergePath("/", input)}`,
            requestInit
          ),
          Env,
          executionCtx
        );
      };
      /**
       * `.fire()` automatically adds a global fetch event listener.
       * This can be useful for environments that adhere to the Service Worker API, such as non-ES module Cloudflare Workers.
       * @deprecated
       * Use `fire` from `hono/service-worker` instead.
       * ```ts
       * import { Hono } from 'hono'
       * import { fire } from 'hono/service-worker'
       *
       * const app = new Hono()
       * // ...
       * fire(app)
       * ```
       * @see https://hono.dev/docs/api/hono#fire
       * @see https://developer.mozilla.org/en-US/docs/Web/API/Service_Worker_API
       * @see https://developers.cloudflare.com/workers/reference/migrate-to-module-workers/
       */
      fire = () => {
        addEventListener("fetch", (event) => {
          event.respondWith(this.#dispatch(event.request, event, void 0, event.request.method));
        });
      };
    };
  }
});

// node_modules/hono/dist/router/reg-exp-router/matcher.js
function match(method, path) {
  const matchers = this.buildAllMatchers();
  const match2 = (method2, path2) => {
    const matcher = matchers[method2] || matchers[METHOD_NAME_ALL];
    const staticMatch = matcher[2][path2];
    if (staticMatch) {
      return staticMatch;
    }
    const match3 = path2.match(matcher[0]);
    if (!match3) {
      return [[], emptyParam];
    }
    const index = match3.indexOf("", 1);
    return [matcher[1][index], match3];
  };
  this.match = match2;
  return match2(method, path);
}
var emptyParam;
var init_matcher = __esm({
  "node_modules/hono/dist/router/reg-exp-router/matcher.js"() {
    init_router();
    emptyParam = [];
  }
});

// node_modules/hono/dist/router/reg-exp-router/node.js
function compareKey(a, b) {
  if (a.length === 1) {
    return b.length === 1 ? a < b ? -1 : 1 : -1;
  }
  if (b.length === 1) {
    return 1;
  }
  if (a === ONLY_WILDCARD_REG_EXP_STR || a === TAIL_WILDCARD_REG_EXP_STR) {
    return 1;
  } else if (b === ONLY_WILDCARD_REG_EXP_STR || b === TAIL_WILDCARD_REG_EXP_STR) {
    return -1;
  }
  if (a === LABEL_REG_EXP_STR) {
    return 1;
  } else if (b === LABEL_REG_EXP_STR) {
    return -1;
  }
  return a.length === b.length ? a < b ? -1 : 1 : b.length - a.length;
}
var LABEL_REG_EXP_STR, ONLY_WILDCARD_REG_EXP_STR, TAIL_WILDCARD_REG_EXP_STR, PATH_ERROR, regExpMetaChars, Node;
var init_node = __esm({
  "node_modules/hono/dist/router/reg-exp-router/node.js"() {
    LABEL_REG_EXP_STR = "[^/]+";
    ONLY_WILDCARD_REG_EXP_STR = ".*";
    TAIL_WILDCARD_REG_EXP_STR = "(?:|/.*)";
    PATH_ERROR = /* @__PURE__ */ Symbol();
    regExpMetaChars = new Set(".\\+*[^]$()");
    Node = class _Node {
      #index;
      #varIndex;
      #children = /* @__PURE__ */ Object.create(null);
      insert(tokens, index, paramMap, context, pathErrorCheckOnly) {
        if (tokens.length === 0) {
          if (this.#index !== void 0) {
            throw PATH_ERROR;
          }
          if (pathErrorCheckOnly) {
            return;
          }
          this.#index = index;
          return;
        }
        const [token, ...restTokens] = tokens;
        const pattern = token === "*" ? restTokens.length === 0 ? ["", "", ONLY_WILDCARD_REG_EXP_STR] : ["", "", LABEL_REG_EXP_STR] : token === "/*" ? ["", "", TAIL_WILDCARD_REG_EXP_STR] : token.match(/^\:([^\{\}]+)(?:\{(.+)\})?$/);
        let node;
        if (pattern) {
          const name = pattern[1];
          let regexpStr = pattern[2] || LABEL_REG_EXP_STR;
          if (name && pattern[2]) {
            if (regexpStr === ".*") {
              throw PATH_ERROR;
            }
            regexpStr = regexpStr.replace(/^\((?!\?:)(?=[^)]+\)$)/, "(?:");
            if (/\((?!\?:)/.test(regexpStr)) {
              throw PATH_ERROR;
            }
          }
          node = this.#children[regexpStr];
          if (!node) {
            if (Object.keys(this.#children).some(
              (k) => k !== ONLY_WILDCARD_REG_EXP_STR && k !== TAIL_WILDCARD_REG_EXP_STR
            )) {
              throw PATH_ERROR;
            }
            if (pathErrorCheckOnly) {
              return;
            }
            node = this.#children[regexpStr] = new _Node();
            if (name !== "") {
              node.#varIndex = context.varIndex++;
            }
          }
          if (!pathErrorCheckOnly && name !== "") {
            paramMap.push([name, node.#varIndex]);
          }
        } else {
          node = this.#children[token];
          if (!node) {
            if (Object.keys(this.#children).some(
              (k) => k.length > 1 && k !== ONLY_WILDCARD_REG_EXP_STR && k !== TAIL_WILDCARD_REG_EXP_STR
            )) {
              throw PATH_ERROR;
            }
            if (pathErrorCheckOnly) {
              return;
            }
            node = this.#children[token] = new _Node();
          }
        }
        node.insert(restTokens, index, paramMap, context, pathErrorCheckOnly);
      }
      buildRegExpStr() {
        const childKeys = Object.keys(this.#children).sort(compareKey);
        const strList = childKeys.map((k) => {
          const c = this.#children[k];
          return (typeof c.#varIndex === "number" ? `(${k})@${c.#varIndex}` : regExpMetaChars.has(k) ? `\\${k}` : k) + c.buildRegExpStr();
        });
        if (typeof this.#index === "number") {
          strList.unshift(`#${this.#index}`);
        }
        if (strList.length === 0) {
          return "";
        }
        if (strList.length === 1) {
          return strList[0];
        }
        return "(?:" + strList.join("|") + ")";
      }
    };
  }
});

// node_modules/hono/dist/router/reg-exp-router/trie.js
var Trie;
var init_trie = __esm({
  "node_modules/hono/dist/router/reg-exp-router/trie.js"() {
    init_node();
    Trie = class {
      #context = { varIndex: 0 };
      #root = new Node();
      insert(path, index, pathErrorCheckOnly) {
        const paramAssoc = [];
        const groups = [];
        for (let i = 0; ; ) {
          let replaced = false;
          path = path.replace(/\{[^}]+\}/g, (m) => {
            const mark = `@\\${i}`;
            groups[i] = [mark, m];
            i++;
            replaced = true;
            return mark;
          });
          if (!replaced) {
            break;
          }
        }
        const tokens = path.match(/(?::[^\/]+)|(?:\/\*$)|./g) || [];
        for (let i = groups.length - 1; i >= 0; i--) {
          const [mark] = groups[i];
          for (let j = tokens.length - 1; j >= 0; j--) {
            if (tokens[j].indexOf(mark) !== -1) {
              tokens[j] = tokens[j].replace(mark, groups[i][1]);
              break;
            }
          }
        }
        this.#root.insert(tokens, index, paramAssoc, this.#context, pathErrorCheckOnly);
        return paramAssoc;
      }
      buildRegExp() {
        let regexp = this.#root.buildRegExpStr();
        if (regexp === "") {
          return [/^$/, [], []];
        }
        let captureIndex = 0;
        const indexReplacementMap = [];
        const paramReplacementMap = [];
        regexp = regexp.replace(/#(\d+)|@(\d+)|\.\*\$/g, (_, handlerIndex, paramIndex) => {
          if (handlerIndex !== void 0) {
            indexReplacementMap[++captureIndex] = Number(handlerIndex);
            return "$()";
          }
          if (paramIndex !== void 0) {
            paramReplacementMap[Number(paramIndex)] = ++captureIndex;
            return "";
          }
          return "";
        });
        return [new RegExp(`^${regexp}`), indexReplacementMap, paramReplacementMap];
      }
    };
  }
});

// node_modules/hono/dist/router/reg-exp-router/router.js
function buildWildcardRegExp(path) {
  return wildcardRegExpCache[path] ??= new RegExp(
    path === "*" ? "" : `^${path.replace(
      /\/\*$|([.\\+*[^\]$()])/g,
      (_, metaChar) => metaChar ? `\\${metaChar}` : "(?:|/.*)"
    )}$`
  );
}
function clearWildcardRegExpCache() {
  wildcardRegExpCache = /* @__PURE__ */ Object.create(null);
}
function buildMatcherFromPreprocessedRoutes(routes) {
  var _a;
  const trie = new Trie();
  const handlerData = [];
  if (routes.length === 0) {
    return nullMatcher;
  }
  const routesWithStaticPathFlag = routes.map(
    (route) => [!/\*|\/:/.test(route[0]), ...route]
  ).sort(
    ([isStaticA, pathA], [isStaticB, pathB]) => isStaticA ? 1 : isStaticB ? -1 : pathA.length - pathB.length
  );
  const staticMap = /* @__PURE__ */ Object.create(null);
  for (let i = 0, j = -1, len = routesWithStaticPathFlag.length; i < len; i++) {
    const [pathErrorCheckOnly, path, handlers] = routesWithStaticPathFlag[i];
    if (pathErrorCheckOnly) {
      staticMap[path] = [handlers.map(([h]) => [h, /* @__PURE__ */ Object.create(null)]), emptyParam];
    } else {
      j++;
    }
    let paramAssoc;
    try {
      paramAssoc = trie.insert(path, j, pathErrorCheckOnly);
    } catch (e) {
      throw e === PATH_ERROR ? new UnsupportedPathError(path) : e;
    }
    if (pathErrorCheckOnly) {
      continue;
    }
    handlerData[j] = handlers.map(([h, paramCount]) => {
      const paramIndexMap = /* @__PURE__ */ Object.create(null);
      paramCount -= 1;
      for (; paramCount >= 0; paramCount--) {
        const [key, value] = paramAssoc[paramCount];
        paramIndexMap[key] = value;
      }
      return [h, paramIndexMap];
    });
  }
  const [regexp, indexReplacementMap, paramReplacementMap] = trie.buildRegExp();
  for (let i = 0, len = handlerData.length; i < len; i++) {
    for (let j = 0, len2 = handlerData[i].length; j < len2; j++) {
      const map = (_a = handlerData[i][j]) == null ? void 0 : _a[1];
      if (!map) {
        continue;
      }
      const keys = Object.keys(map);
      for (let k = 0, len3 = keys.length; k < len3; k++) {
        map[keys[k]] = paramReplacementMap[map[keys[k]]];
      }
    }
  }
  const handlerMap = [];
  for (const i in indexReplacementMap) {
    handlerMap[i] = handlerData[indexReplacementMap[i]];
  }
  return [regexp, handlerMap, staticMap];
}
function findMiddleware(middleware, path) {
  if (!middleware) {
    return void 0;
  }
  for (const k of Object.keys(middleware).sort((a, b) => b.length - a.length)) {
    if (buildWildcardRegExp(k).test(path)) {
      return [...middleware[k]];
    }
  }
  return void 0;
}
var nullMatcher, wildcardRegExpCache, RegExpRouter;
var init_router2 = __esm({
  "node_modules/hono/dist/router/reg-exp-router/router.js"() {
    init_router();
    init_url();
    init_matcher();
    init_node();
    init_trie();
    nullMatcher = [/^$/, [], /* @__PURE__ */ Object.create(null)];
    wildcardRegExpCache = /* @__PURE__ */ Object.create(null);
    RegExpRouter = class {
      name = "RegExpRouter";
      #middleware;
      #routes;
      constructor() {
        this.#middleware = { [METHOD_NAME_ALL]: /* @__PURE__ */ Object.create(null) };
        this.#routes = { [METHOD_NAME_ALL]: /* @__PURE__ */ Object.create(null) };
      }
      add(method, path, handler) {
        const middleware = this.#middleware;
        const routes = this.#routes;
        if (!middleware || !routes) {
          throw new Error(MESSAGE_MATCHER_IS_ALREADY_BUILT);
        }
        if (!middleware[method]) {
          ;
          [middleware, routes].forEach((handlerMap) => {
            handlerMap[method] = /* @__PURE__ */ Object.create(null);
            Object.keys(handlerMap[METHOD_NAME_ALL]).forEach((p) => {
              handlerMap[method][p] = [...handlerMap[METHOD_NAME_ALL][p]];
            });
          });
        }
        if (path === "/*") {
          path = "*";
        }
        const paramCount = (path.match(/\/:/g) || []).length;
        if (/\*$/.test(path)) {
          const re = buildWildcardRegExp(path);
          if (method === METHOD_NAME_ALL) {
            Object.keys(middleware).forEach((m) => {
              middleware[m][path] ||= findMiddleware(middleware[m], path) || findMiddleware(middleware[METHOD_NAME_ALL], path) || [];
            });
          } else {
            middleware[method][path] ||= findMiddleware(middleware[method], path) || findMiddleware(middleware[METHOD_NAME_ALL], path) || [];
          }
          Object.keys(middleware).forEach((m) => {
            if (method === METHOD_NAME_ALL || method === m) {
              Object.keys(middleware[m]).forEach((p) => {
                re.test(p) && middleware[m][p].push([handler, paramCount]);
              });
            }
          });
          Object.keys(routes).forEach((m) => {
            if (method === METHOD_NAME_ALL || method === m) {
              Object.keys(routes[m]).forEach(
                (p) => re.test(p) && routes[m][p].push([handler, paramCount])
              );
            }
          });
          return;
        }
        const paths = checkOptionalParameter(path) || [path];
        for (let i = 0, len = paths.length; i < len; i++) {
          const path2 = paths[i];
          Object.keys(routes).forEach((m) => {
            if (method === METHOD_NAME_ALL || method === m) {
              routes[m][path2] ||= [
                ...findMiddleware(middleware[m], path2) || findMiddleware(middleware[METHOD_NAME_ALL], path2) || []
              ];
              routes[m][path2].push([handler, paramCount - len + i + 1]);
            }
          });
        }
      }
      match = match;
      buildAllMatchers() {
        const matchers = /* @__PURE__ */ Object.create(null);
        Object.keys(this.#routes).concat(Object.keys(this.#middleware)).forEach((method) => {
          matchers[method] ||= this.#buildMatcher(method);
        });
        this.#middleware = this.#routes = void 0;
        clearWildcardRegExpCache();
        return matchers;
      }
      #buildMatcher(method) {
        const routes = [];
        let hasOwnRoute = method === METHOD_NAME_ALL;
        [this.#middleware, this.#routes].forEach((r) => {
          const ownRoute = r[method] ? Object.keys(r[method]).map((path) => [path, r[method][path]]) : [];
          if (ownRoute.length !== 0) {
            hasOwnRoute ||= true;
            routes.push(...ownRoute);
          } else if (method !== METHOD_NAME_ALL) {
            routes.push(
              ...Object.keys(r[METHOD_NAME_ALL]).map((path) => [path, r[METHOD_NAME_ALL][path]])
            );
          }
        });
        if (!hasOwnRoute) {
          return null;
        } else {
          return buildMatcherFromPreprocessedRoutes(routes);
        }
      }
    };
  }
});

// node_modules/hono/dist/router/reg-exp-router/prepared-router.js
var init_prepared_router = __esm({
  "node_modules/hono/dist/router/reg-exp-router/prepared-router.js"() {
    init_router();
    init_matcher();
    init_router2();
  }
});

// node_modules/hono/dist/router/reg-exp-router/index.js
var init_reg_exp_router = __esm({
  "node_modules/hono/dist/router/reg-exp-router/index.js"() {
    init_router2();
    init_prepared_router();
  }
});

// node_modules/hono/dist/router/smart-router/router.js
var SmartRouter;
var init_router3 = __esm({
  "node_modules/hono/dist/router/smart-router/router.js"() {
    init_router();
    SmartRouter = class {
      name = "SmartRouter";
      #routers = [];
      #routes = [];
      constructor(init) {
        this.#routers = init.routers;
      }
      add(method, path, handler) {
        if (!this.#routes) {
          throw new Error(MESSAGE_MATCHER_IS_ALREADY_BUILT);
        }
        this.#routes.push([method, path, handler]);
      }
      match(method, path) {
        if (!this.#routes) {
          throw new Error("Fatal error");
        }
        const routers = this.#routers;
        const routes = this.#routes;
        const len = routers.length;
        let i = 0;
        let res;
        for (; i < len; i++) {
          const router = routers[i];
          try {
            for (let i2 = 0, len2 = routes.length; i2 < len2; i2++) {
              router.add(...routes[i2]);
            }
            res = router.match(method, path);
          } catch (e) {
            if (e instanceof UnsupportedPathError) {
              continue;
            }
            throw e;
          }
          this.match = router.match.bind(router);
          this.#routers = [router];
          this.#routes = void 0;
          break;
        }
        if (i === len) {
          throw new Error("Fatal error");
        }
        this.name = `SmartRouter + ${this.activeRouter.name}`;
        return res;
      }
      get activeRouter() {
        if (this.#routes || this.#routers.length !== 1) {
          throw new Error("No active router has been determined yet.");
        }
        return this.#routers[0];
      }
    };
  }
});

// node_modules/hono/dist/router/smart-router/index.js
var init_smart_router = __esm({
  "node_modules/hono/dist/router/smart-router/index.js"() {
    init_router3();
  }
});

// node_modules/hono/dist/router/trie-router/node.js
var emptyParams, Node2;
var init_node2 = __esm({
  "node_modules/hono/dist/router/trie-router/node.js"() {
    init_router();
    init_url();
    emptyParams = /* @__PURE__ */ Object.create(null);
    Node2 = class _Node2 {
      #methods;
      #children;
      #patterns;
      #order = 0;
      #params = emptyParams;
      constructor(method, handler, children) {
        this.#children = children || /* @__PURE__ */ Object.create(null);
        this.#methods = [];
        if (method && handler) {
          const m = /* @__PURE__ */ Object.create(null);
          m[method] = { handler, possibleKeys: [], score: 0 };
          this.#methods = [m];
        }
        this.#patterns = [];
      }
      insert(method, path, handler) {
        this.#order = ++this.#order;
        let curNode = this;
        const parts = splitRoutingPath(path);
        const possibleKeys = [];
        for (let i = 0, len = parts.length; i < len; i++) {
          const p = parts[i];
          const nextP = parts[i + 1];
          const pattern = getPattern(p, nextP);
          const key = Array.isArray(pattern) ? pattern[0] : p;
          if (key in curNode.#children) {
            curNode = curNode.#children[key];
            if (pattern) {
              possibleKeys.push(pattern[1]);
            }
            continue;
          }
          curNode.#children[key] = new _Node2();
          if (pattern) {
            curNode.#patterns.push(pattern);
            possibleKeys.push(pattern[1]);
          }
          curNode = curNode.#children[key];
        }
        curNode.#methods.push({
          [method]: {
            handler,
            possibleKeys: possibleKeys.filter((v, i, a) => a.indexOf(v) === i),
            score: this.#order
          }
        });
        return curNode;
      }
      #getHandlerSets(node, method, nodeParams, params) {
        const handlerSets = [];
        for (let i = 0, len = node.#methods.length; i < len; i++) {
          const m = node.#methods[i];
          const handlerSet = m[method] || m[METHOD_NAME_ALL];
          const processedSet = {};
          if (handlerSet !== void 0) {
            handlerSet.params = /* @__PURE__ */ Object.create(null);
            handlerSets.push(handlerSet);
            if (nodeParams !== emptyParams || params && params !== emptyParams) {
              for (let i2 = 0, len2 = handlerSet.possibleKeys.length; i2 < len2; i2++) {
                const key = handlerSet.possibleKeys[i2];
                const processed = processedSet[handlerSet.score];
                handlerSet.params[key] = (params == null ? void 0 : params[key]) && !processed ? params[key] : nodeParams[key] ?? (params == null ? void 0 : params[key]);
                processedSet[handlerSet.score] = true;
              }
            }
          }
        }
        return handlerSets;
      }
      search(method, path) {
        var _a;
        const handlerSets = [];
        this.#params = emptyParams;
        const curNode = this;
        let curNodes = [curNode];
        const parts = splitPath(path);
        const curNodesQueue = [];
        for (let i = 0, len = parts.length; i < len; i++) {
          const part = parts[i];
          const isLast = i === len - 1;
          const tempNodes = [];
          for (let j = 0, len2 = curNodes.length; j < len2; j++) {
            const node = curNodes[j];
            const nextNode = node.#children[part];
            if (nextNode) {
              nextNode.#params = node.#params;
              if (isLast) {
                if (nextNode.#children["*"]) {
                  handlerSets.push(
                    ...this.#getHandlerSets(nextNode.#children["*"], method, node.#params)
                  );
                }
                handlerSets.push(...this.#getHandlerSets(nextNode, method, node.#params));
              } else {
                tempNodes.push(nextNode);
              }
            }
            for (let k = 0, len3 = node.#patterns.length; k < len3; k++) {
              const pattern = node.#patterns[k];
              const params = node.#params === emptyParams ? {} : { ...node.#params };
              if (pattern === "*") {
                const astNode = node.#children["*"];
                if (astNode) {
                  handlerSets.push(...this.#getHandlerSets(astNode, method, node.#params));
                  astNode.#params = params;
                  tempNodes.push(astNode);
                }
                continue;
              }
              const [key, name, matcher] = pattern;
              if (!part && !(matcher instanceof RegExp)) {
                continue;
              }
              const child = node.#children[key];
              const restPathString = parts.slice(i).join("/");
              if (matcher instanceof RegExp) {
                const m = matcher.exec(restPathString);
                if (m) {
                  params[name] = m[0];
                  handlerSets.push(...this.#getHandlerSets(child, method, node.#params, params));
                  if (Object.keys(child.#children).length) {
                    child.#params = params;
                    const componentCount = ((_a = m[0].match(/\//)) == null ? void 0 : _a.length) ?? 0;
                    const targetCurNodes = curNodesQueue[componentCount] ||= [];
                    targetCurNodes.push(child);
                  }
                  continue;
                }
              }
              if (matcher === true || matcher.test(part)) {
                params[name] = part;
                if (isLast) {
                  handlerSets.push(...this.#getHandlerSets(child, method, params, node.#params));
                  if (child.#children["*"]) {
                    handlerSets.push(
                      ...this.#getHandlerSets(child.#children["*"], method, params, node.#params)
                    );
                  }
                } else {
                  child.#params = params;
                  tempNodes.push(child);
                }
              }
            }
          }
          curNodes = tempNodes.concat(curNodesQueue.shift() ?? []);
        }
        if (handlerSets.length > 1) {
          handlerSets.sort((a, b) => {
            return a.score - b.score;
          });
        }
        return [handlerSets.map(({ handler, params }) => [handler, params])];
      }
    };
  }
});

// node_modules/hono/dist/router/trie-router/router.js
var TrieRouter;
var init_router4 = __esm({
  "node_modules/hono/dist/router/trie-router/router.js"() {
    init_url();
    init_node2();
    TrieRouter = class {
      name = "TrieRouter";
      #node;
      constructor() {
        this.#node = new Node2();
      }
      add(method, path, handler) {
        const results = checkOptionalParameter(path);
        if (results) {
          for (let i = 0, len = results.length; i < len; i++) {
            this.#node.insert(method, results[i], handler);
          }
          return;
        }
        this.#node.insert(method, path, handler);
      }
      match(method, path) {
        return this.#node.search(method, path);
      }
    };
  }
});

// node_modules/hono/dist/router/trie-router/index.js
var init_trie_router = __esm({
  "node_modules/hono/dist/router/trie-router/index.js"() {
    init_router4();
  }
});

// node_modules/hono/dist/hono.js
var Hono2;
var init_hono = __esm({
  "node_modules/hono/dist/hono.js"() {
    init_hono_base();
    init_reg_exp_router();
    init_smart_router();
    init_trie_router();
    Hono2 = class extends Hono {
      /**
       * Creates an instance of the Hono class.
       *
       * @param options - Optional configuration options for the Hono instance.
       */
      constructor(options = {}) {
        super(options);
        this.router = options.router ?? new SmartRouter({
          routers: [new RegExpRouter(), new TrieRouter()]
        });
      }
    };
  }
});

// node_modules/hono/dist/index.js
var dist_exports = {};
__export(dist_exports, {
  Hono: () => Hono2
});
var init_dist = __esm({
  "node_modules/hono/dist/index.js"() {
    init_hono();
  }
});

// src/api/story.js
var story_exports = {};
__export(story_exports, {
  handleStoryRequest: () => handleStoryRequest
});
async function handleStoryRequest(request, env, user = null) {
  const url = new URL(request.url);
  const pathname2 = url.pathname;
  try {
    if (pathname2 === "/api/story/timeline" && request.method === "GET") {
      return await handleGetTimeline(request, env, user);
    }
    if (pathname2 === "/api/story/location" && request.method === "GET") {
      return await handleGetLocationStories(request, env, user);
    }
    if (pathname2 === "/api/story/create" && request.method === "POST") {
      return await handleCreateStory(request, env, user);
    }
    if (pathname2 === "/api/story/statistics" && request.method === "GET") {
      return await handleGetStatistics(request, env, user);
    }
    if (pathname2.startsWith("/api/story/") && request.method === "GET") {
      const storyId = pathname2.split("/").pop();
      if (storyId && storyId !== "timeline" && storyId !== "location" && storyId !== "create" && storyId !== "statistics" && storyId !== "share") {
        return await handleGetStory(storyId, env, user);
      }
    }
    if (pathname2 === "/api/story/share" && request.method === "POST") {
      return await handleShareStory(request, env, user);
    }
    if (pathname2.startsWith("/api/story/share/") && request.method === "GET") {
      const shareId = pathname2.split("/").pop();
      return await handleGetSharedStory(shareId, env);
    }
    return new Response("Not Found", { status: 404 });
  } catch (error) {
    console.error("[Story API] Error:", error);
    return new Response(JSON.stringify({
      success: false,
      error: error.message || "Internal Server Error"
    }), {
      status: 500,
      headers: { "Content-Type": "application/json" }
    });
  }
}
async function handleGetTimeline(request, env, user) {
  if (!user || !user.id) {
    return new Response(JSON.stringify({
      success: false,
      error: "Authentication required"
    }), {
      status: 401,
      headers: { "Content-Type": "application/json" }
    });
  }
  try {
    const url = new URL(request.url);
    const actionType = url.searchParams.get("action_type");
    const limit = parseInt(url.searchParams.get("limit") || "50");
    const offset = parseInt(url.searchParams.get("offset") || "0");
    const storyModule = new StoryModule(env.DB);
    const timeline = await storyModule.getPersonTimeline(user.id, actionType);
    const paginatedTimeline = timeline.slice(offset, offset + limit);
    return new Response(JSON.stringify({
      success: true,
      timeline: paginatedTimeline,
      total: timeline.length,
      hasMore: offset + limit < timeline.length
    }), {
      headers: { "Content-Type": "application/json" }
    });
  } catch (error) {
    console.error("[Story API] Error getting timeline:", error);
    throw error;
  }
}
async function handleGetLocationStories(request, env, user) {
  try {
    const url = new URL(request.url);
    const locationId = url.searchParams.get("location_id");
    if (!locationId) {
      return new Response(JSON.stringify({
        success: false,
        error: "location_id is required"
      }), {
        status: 400,
        headers: { "Content-Type": "application/json" }
      });
    }
    const actionType = url.searchParams.get("action_type");
    const storyModule = new StoryModule(env.DB);
    const stories = await storyModule.getLocationStories(locationId, actionType);
    return new Response(JSON.stringify({
      success: true,
      stories
    }), {
      headers: { "Content-Type": "application/json" }
    });
  } catch (error) {
    console.error("[Story API] Error getting location stories:", error);
    throw error;
  }
}
async function handleCreateStory(request, env, user) {
  if (!user || !user.id) {
    return new Response(JSON.stringify({
      success: false,
      error: "Authentication required"
    }), {
      status: 401,
      headers: { "Content-Type": "application/json" }
    });
  }
  try {
    const body = await request.json();
    const { location_id, action_type, description } = body;
    if (!location_id || !action_type) {
      return new Response(JSON.stringify({
        success: false,
        error: "location_id and action_type are required"
      }), {
        status: 400,
        headers: { "Content-Type": "application/json" }
      });
    }
    const storyModule = new StoryModule(env.DB);
    const story = await storyModule.createStory(user.id, location_id, action_type, description);
    const timeModule = new (await Promise.resolve().then(() => (init_TimeModule(), TimeModule_exports))).TimeModule();
    const actionModule = new (await Promise.resolve().then(() => (init_ActionModule(), ActionModule_exports))).ActionModule();
    return new Response(JSON.stringify({
      success: true,
      story: {
        ...story.toJSON(),
        timeDescription: timeModule.getStoryTimeDescription(story),
        actionName: actionModule.getActionTypeName(story.action_type),
        actionIcon: actionModule.getActionTypeIcon(story.action_type)
      }
    }), {
      headers: { "Content-Type": "application/json" }
    });
  } catch (error) {
    console.error("[Story API] Error creating story:", error);
    throw error;
  }
}
async function handleGetStatistics(request, env, user) {
  try {
    const url = new URL(request.url);
    const personId = url.searchParams.get("person_id");
    const locationId = url.searchParams.get("location_id");
    if (!personId && !locationId) {
      if (user && user.id) {
        const storyModule2 = new StoryModule(env.DB);
        const stats2 = await storyModule2.getStoryStatistics(user.id, null);
        return new Response(JSON.stringify({
          success: true,
          statistics: stats2
        }), {
          headers: { "Content-Type": "application/json" }
        });
      } else {
        return new Response(JSON.stringify({
          success: false,
          error: "person_id or location_id is required, or user must be authenticated"
        }), {
          status: 400,
          headers: { "Content-Type": "application/json" }
        });
      }
    }
    const storyModule = new StoryModule(env.DB);
    const stats = await storyModule.getStoryStatistics(personId, locationId);
    return new Response(JSON.stringify({
      success: true,
      statistics: stats
    }), {
      headers: { "Content-Type": "application/json" }
    });
  } catch (error) {
    console.error("[Story API] Error getting statistics:", error);
    throw error;
  }
}
async function handleGetStory(storyId, env, user) {
  try {
    const storyModule = new StoryModule(env.DB);
    const story = await storyModule.getFullStory(storyId);
    if (!story) {
      return new Response(JSON.stringify({
        success: false,
        error: "Story not found"
      }), {
        status: 404,
        headers: { "Content-Type": "application/json" }
      });
    }
    return new Response(JSON.stringify({
      success: true,
      story
    }), {
      headers: { "Content-Type": "application/json" }
    });
  } catch (error) {
    console.error("[Story API] Error getting story:", error);
    throw error;
  }
}
var init_story = __esm({
  "src/api/story.js"() {
    "use strict";
    init_StoryModule();
    init_PersonModule();
    init_LocationModule();
  }
});

// src/api/recommendation.js
var recommendation_exports = {};
__export(recommendation_exports, {
  handleRecommendationRequest: () => handleRecommendationRequest
});
async function handleRecommendationRequest(request, env, user = null) {
  const url = new URL(request.url);
  const pathname2 = url.pathname;
  try {
    if (pathname2 === "/api/recommendation/personal" && request.method === "GET") {
      return await handleGetPersonalRecommendations(request, env, user);
    }
    if (pathname2 === "/api/recommendation/similar" && request.method === "GET") {
      return await handleGetSimilarRecommendations(request, env, user);
    }
    if (pathname2 === "/api/recommendation/popular" && request.method === "GET") {
      return await handleGetPopularLocations(request, env, user);
    }
    return new Response("Not Found", { status: 404 });
  } catch (error) {
    console.error("[Recommendation API] Error:", error);
    return new Response(JSON.stringify({
      success: false,
      error: error.message || "Internal Server Error"
    }), {
      status: 500,
      headers: { "Content-Type": "application/json" }
    });
  }
}
async function handleGetPersonalRecommendations(request, env, user) {
  if (!user || !user.id) {
    return new Response(JSON.stringify({
      success: false,
      error: "Authentication required"
    }), {
      status: 401,
      headers: { "Content-Type": "application/json" }
    });
  }
  try {
    const url = new URL(request.url);
    const limit = parseInt(url.searchParams.get("limit") || "10");
    const recommendationService = new RecommendationService(
      env.DB,
      env.GOOGLE_MAPS_API_KEY
    );
    const recommendations = await recommendationService.recommendLocationsByStories(
      user.id,
      limit
    );
    return new Response(JSON.stringify({
      success: true,
      recommendations,
      count: recommendations.length
    }), {
      headers: { "Content-Type": "application/json" }
    });
  } catch (error) {
    console.error("[Recommendation API] Error getting personal recommendations:", error);
    throw error;
  }
}
async function handleGetSimilarRecommendations(request, env, user) {
  try {
    const url = new URL(request.url);
    const locationId = url.searchParams.get("location_id");
    const limit = parseInt(url.searchParams.get("limit") || "5");
    if (!locationId) {
      return new Response(JSON.stringify({
        success: false,
        error: "location_id is required"
      }), {
        status: 400,
        headers: { "Content-Type": "application/json" }
      });
    }
    const recommendationService = new RecommendationService(
      env.DB,
      env.GOOGLE_MAPS_API_KEY
    );
    const recommendations = await recommendationService.recommendSimilarLocations(
      locationId,
      limit
    );
    return new Response(JSON.stringify({
      success: true,
      recommendations,
      count: recommendations.length
    }), {
      headers: { "Content-Type": "application/json" }
    });
  } catch (error) {
    console.error("[Recommendation API] Error getting similar recommendations:", error);
    throw error;
  }
}
async function handleGetPopularLocations(request, env, user) {
  try {
    const url = new URL(request.url);
    const limit = parseInt(url.searchParams.get("limit") || "10");
    const recommendationService = new RecommendationService(
      env.DB,
      env.GOOGLE_MAPS_API_KEY
    );
    const popularLocations = await recommendationService.getPopularLocations(limit);
    return new Response(JSON.stringify({
      success: true,
      locations: popularLocations,
      count: popularLocations.length
    }), {
      headers: { "Content-Type": "application/json" }
    });
  } catch (error) {
    console.error("[Recommendation API] Error getting popular locations:", error);
    throw error;
  }
}
var init_recommendation = __esm({
  "src/api/recommendation.js"() {
    "use strict";
    init_RecommendationService();
  }
});

// src/api/search.js
var search_exports = {};
__export(search_exports, {
  handleSearchRequest: () => handleSearchRequest
});
async function handleSearchRequest(request, env, user = null) {
  const url = new URL(request.url);
  const pathname2 = url.pathname;
  try {
    if (pathname2 === "/api/search/locations" && request.method === "GET") {
      const cachedHandler = withCache(handleSearchLocations, {
        cacheKey: "search",
        ttl: CACHE_TTL.SHORT,
        // 1 分鐘（60秒）
        keyGenerator: (request2, env2, user2) => {
          const url2 = new URL(request2.url);
          const query = url2.searchParams.get("q") || "";
          const limit = url2.searchParams.get("limit") || "20";
          const offset = url2.searchParams.get("offset") || "0";
          const types = url2.searchParams.get("types") || "";
          const minRating = url2.searchParams.get("min_rating") || "";
          const businessStatus = url2.searchParams.get("business_status") || "";
          const sortBy = url2.searchParams.get("sort_by") || "relevance";
          const sortOrder = url2.searchParams.get("sort_order") || "DESC";
          const userId = (user2 == null ? void 0 : user2.id) || "anonymous";
          return `locations:${query}:${limit}:${offset}:${types}:${minRating}:${businessStatus}:${sortBy}:${sortOrder}:${userId}`;
        }
      });
      return await cachedHandler(request, env, user);
    }
    if (pathname2 === "/api/search/autocomplete" && request.method === "GET") {
      const cachedHandler = withCache(handleAutocomplete, {
        cacheKey: "search",
        ttl: CACHE_TTL.MEDIUM,
        // 5 分鐘
        keyGenerator: (request2, env2, user2) => {
          const url2 = new URL(request2.url);
          const query = url2.searchParams.get("q") || "";
          const limit = url2.searchParams.get("limit") || "10";
          return `autocomplete:${query}:${limit}`;
        }
      });
      return await cachedHandler(request, env, user);
    }
    if (pathname2 === "/api/search/filters" && request.method === "GET") {
      const cachedHandler = withCache(handleGetFilters, {
        cacheKey: "search",
        ttl: CACHE_TTL.LONG,
        // 10 分鐘
        keyGenerator: () => "filters"
      });
      return await cachedHandler(request, env, user);
    }
    if (pathname2 === "/api/search/popular" && request.method === "GET") {
      const cachedHandler = withCache(handleGetPopularTerms, {
        cacheKey: "search",
        ttl: CACHE_TTL.VERY_LONG,
        // 30 分鐘
        keyGenerator: () => "popular"
      });
      return await cachedHandler(request, env, user);
    }
    return new Response("Not Found", { status: 404 });
  } catch (error) {
    console.error("[Search API] Error:", error);
    return new Response(JSON.stringify({
      success: false,
      error: error.message || "Internal Server Error"
    }), {
      status: 500,
      headers: { "Content-Type": "application/json" }
    });
  }
}
async function handleSearchLocations(request, env, user) {
  try {
    const url = new URL(request.url);
    const query = url.searchParams.get("q") || "";
    const limit = parseInt(url.searchParams.get("limit") || "20");
    const offset = parseInt(url.searchParams.get("offset") || "0");
    const filters = {
      types: url.searchParams.get("types") ? url.searchParams.get("types").split(",") : [],
      minRating: url.searchParams.get("min_rating") ? parseFloat(url.searchParams.get("min_rating")) : void 0,
      businessStatus: url.searchParams.get("business_status") || void 0
    };
    const sortOptions = {
      sortBy: url.searchParams.get("sort_by") || "relevance",
      sortOrder: url.searchParams.get("sort_order") || "DESC"
    };
    const searchService = new SearchService(env.DB);
    const results = await searchService.searchLocations(
      query,
      filters,
      sortOptions,
      limit,
      offset
    );
    return new Response(JSON.stringify({
      success: true,
      ...results
    }), {
      headers: { "Content-Type": "application/json" }
    });
  } catch (error) {
    console.error("[Search API] Error searching locations:", error);
    throw error;
  }
}
async function handleAutocomplete(request, env, user) {
  try {
    const url = new URL(request.url);
    const query = url.searchParams.get("q") || "";
    const limit = parseInt(url.searchParams.get("limit") || "10");
    if (!query || query.trim().length < 2) {
      return new Response(JSON.stringify({
        success: true,
        suggestions: []
      }), {
        headers: { "Content-Type": "application/json" }
      });
    }
    const searchService = new SearchService(env.DB);
    const suggestions = await searchService.fuzzySearchLocationNames(query, limit);
    return new Response(JSON.stringify({
      success: true,
      suggestions
    }), {
      headers: { "Content-Type": "application/json" }
    });
  } catch (error) {
    console.error("[Search API] Error autocomplete:", error);
    throw error;
  }
}
async function handleGetFilters(request, env, user) {
  try {
    const searchService = new SearchService(env.DB);
    const filters = await searchService.getSearchFilters();
    return new Response(JSON.stringify({
      success: true,
      filters
    }), {
      headers: { "Content-Type": "application/json" }
    });
  } catch (error) {
    console.error("[Search API] Error getting filters:", error);
    throw error;
  }
}
async function handleGetPopularTerms(request, env, user) {
  try {
    const url = new URL(request.url);
    const limit = parseInt(url.searchParams.get("limit") || "10");
    const searchService = new SearchService(env.DB);
    const terms = await searchService.getPopularSearchTerms(limit);
    return new Response(JSON.stringify({
      success: true,
      terms
    }), {
      headers: { "Content-Type": "application/json" }
    });
  } catch (error) {
    console.error("[Search API] Error getting popular terms:", error);
    throw error;
  }
}
var init_search = __esm({
  "src/api/search.js"() {
    "use strict";
    init_SearchService();
    init_cacheHelper();
  }
});

// src/api/favorites.js
var favorites_exports = {};
__export(favorites_exports, {
  handleFavoritesRequest: () => handleFavoritesRequest
});
async function handleFavoritesRequest(request, env, user = null) {
  const url = new URL(request.url);
  const pathname2 = url.pathname;
  try {
    if (pathname2 === "/api/favorites/toggle" && request.method === "POST") {
      return await handleToggleFavorite(request, env, user);
    }
    if (pathname2 === "/api/favorites/list" && request.method === "GET") {
      return await handleGetFavorites(request, env, user);
    }
    if (pathname2 === "/api/favorites/check" && request.method === "GET") {
      return await handleCheckFavorite(request, env, user);
    }
    if (pathname2 === "/api/favorites/rating" && request.method === "POST") {
      return await handleAddRating(request, env, user);
    }
    if (pathname2 === "/api/favorites/rating" && request.method === "GET") {
      return await handleGetRating(request, env, user);
    }
    if (pathname2 === "/api/favorites/comment" && request.method === "POST") {
      return await handleAddComment(request, env, user);
    }
    if (pathname2 === "/api/favorites/comments" && request.method === "GET") {
      return await handleGetComments(request, env, user);
    }
    return new Response("Not Found", { status: 404 });
  } catch (error) {
    console.error("[Favorites API] Error:", error);
    return new Response(JSON.stringify({
      success: false,
      error: error.message || "Internal Server Error"
    }), {
      status: 500,
      headers: { "Content-Type": "application/json" }
    });
  }
}
async function handleToggleFavorite(request, env, user) {
  if (!user || !user.id) {
    return new Response(JSON.stringify({
      success: false,
      error: "Authentication required"
    }), {
      status: 401,
      headers: { "Content-Type": "application/json" }
    });
  }
  try {
    const body = await request.json();
    const { location_id } = body;
    if (!location_id) {
      return new Response(JSON.stringify({
        success: false,
        error: "location_id is required"
      }), {
        status: 400,
        headers: { "Content-Type": "application/json" }
      });
    }
    const favoritesService = new FavoritesService(env.DB);
    const isFavorited = await favoritesService.toggleFavorite(user.id, location_id);
    const favoriteCount = await favoritesService.getFavoriteCount(location_id);
    return new Response(JSON.stringify({
      success: true,
      is_favorited: isFavorited,
      favorite_count: favoriteCount
    }), {
      headers: { "Content-Type": "application/json" }
    });
  } catch (error) {
    console.error("[Favorites API] Error toggling favorite:", error);
    throw error;
  }
}
async function handleGetFavorites(request, env, user) {
  if (!user || !user.id) {
    return new Response(JSON.stringify({
      success: false,
      error: "Authentication required"
    }), {
      status: 401,
      headers: { "Content-Type": "application/json" }
    });
  }
  try {
    const url = new URL(request.url);
    const limit = parseInt(url.searchParams.get("limit") || "20");
    const offset = parseInt(url.searchParams.get("offset") || "0");
    const favoritesService = new FavoritesService(env.DB);
    const result = await favoritesService.getUserFavorites(user.id, limit, offset);
    return new Response(JSON.stringify({
      success: true,
      ...result
    }), {
      headers: { "Content-Type": "application/json" }
    });
  } catch (error) {
    console.error("[Favorites API] Error getting favorites:", error);
    throw error;
  }
}
async function handleCheckFavorite(request, env, user) {
  if (!user || !user.id) {
    return new Response(JSON.stringify({
      success: true,
      is_favorited: false
    }), {
      headers: { "Content-Type": "application/json" }
    });
  }
  try {
    const url = new URL(request.url);
    const location_id = url.searchParams.get("location_id");
    if (!location_id) {
      return new Response(JSON.stringify({
        success: false,
        error: "location_id is required"
      }), {
        status: 400,
        headers: { "Content-Type": "application/json" }
      });
    }
    const favoritesService = new FavoritesService(env.DB);
    const isFavorited = await favoritesService.isFavorited(user.id, location_id);
    const favoriteCount = await favoritesService.getFavoriteCount(location_id);
    return new Response(JSON.stringify({
      success: true,
      is_favorited: isFavorited,
      favorite_count: favoriteCount
    }), {
      headers: { "Content-Type": "application/json" }
    });
  } catch (error) {
    console.error("[Favorites API] Error checking favorite:", error);
    throw error;
  }
}
async function handleAddRating(request, env, user) {
  if (!user || !user.id) {
    return new Response(JSON.stringify({
      success: false,
      error: "Authentication required"
    }), {
      status: 401,
      headers: { "Content-Type": "application/json" }
    });
  }
  try {
    const body = await request.json();
    const { location_id, rating, comment } = body;
    if (!location_id || !rating) {
      return new Response(JSON.stringify({
        success: false,
        error: "location_id and rating are required"
      }), {
        status: 400,
        headers: { "Content-Type": "application/json" }
      });
    }
    const favoritesService = new FavoritesService(env.DB);
    await favoritesService.addRating(user.id, location_id, rating, comment);
    const ratingInfo = await favoritesService.getLocationRating(location_id);
    return new Response(JSON.stringify({
      success: true,
      rating: ratingInfo
    }), {
      headers: { "Content-Type": "application/json" }
    });
  } catch (error) {
    console.error("[Favorites API] Error adding rating:", error);
    throw error;
  }
}
async function handleGetRating(request, env, user) {
  try {
    const url = new URL(request.url);
    const location_id = url.searchParams.get("location_id");
    if (!location_id) {
      return new Response(JSON.stringify({
        success: false,
        error: "location_id is required"
      }), {
        status: 400,
        headers: { "Content-Type": "application/json" }
      });
    }
    const favoritesService = new FavoritesService(env.DB);
    const rating = await favoritesService.getLocationRating(location_id);
    let userRating = null;
    if (user && user.id) {
      userRating = await favoritesService.getUserRating(user.id, location_id);
    }
    return new Response(JSON.stringify({
      success: true,
      rating,
      user_rating: userRating
    }), {
      headers: { "Content-Type": "application/json" }
    });
  } catch (error) {
    console.error("[Favorites API] Error getting rating:", error);
    throw error;
  }
}
async function handleAddComment(request, env, user) {
  if (!user || !user.id) {
    return new Response(JSON.stringify({
      success: false,
      error: "Authentication required"
    }), {
      status: 401,
      headers: { "Content-Type": "application/json" }
    });
  }
  try {
    const body = await request.json();
    const { location_id, content } = body;
    if (!location_id || !content) {
      return new Response(JSON.stringify({
        success: false,
        error: "location_id and content are required"
      }), {
        status: 400,
        headers: { "Content-Type": "application/json" }
      });
    }
    const favoritesService = new FavoritesService(env.DB);
    const commentId = await favoritesService.addComment(user.id, location_id, content);
    return new Response(JSON.stringify({
      success: true,
      comment_id: commentId
    }), {
      headers: { "Content-Type": "application/json" }
    });
  } catch (error) {
    console.error("[Favorites API] Error adding comment:", error);
    throw error;
  }
}
async function handleGetComments(request, env, user) {
  try {
    const url = new URL(request.url);
    const location_id = url.searchParams.get("location_id");
    const limit = parseInt(url.searchParams.get("limit") || "20");
    const offset = parseInt(url.searchParams.get("offset") || "0");
    if (!location_id) {
      return new Response(JSON.stringify({
        success: false,
        error: "location_id is required"
      }), {
        status: 400,
        headers: { "Content-Type": "application/json" }
      });
    }
    const favoritesService = new FavoritesService(env.DB);
    const result = await favoritesService.getLocationComments(location_id, limit, offset);
    return new Response(JSON.stringify({
      success: true,
      ...result
    }), {
      headers: { "Content-Type": "application/json" }
    });
  } catch (error) {
    console.error("[Favorites API] Error getting comments:", error);
    throw error;
  }
}
var init_favorites = __esm({
  "src/api/favorites.js"() {
    "use strict";
    init_FavoritesService();
  }
});

// src/api/itinerary-location.js
async function handleCreateLocationFromGoogle(request, env, user, locationService) {
  try {
    const body = await request.json();
    const { google_place_data, auto_link_to_user = true, initial_status = "want_to_visit" } = body;
    if (!google_place_data || !google_place_data.place_id) {
      return new Response(JSON.stringify({
        success: false,
        error: "Missing google_place_data or place_id"
      }), {
        status: 400,
        headers: { "Content-Type": "application/json" }
      });
    }
    const location = await locationService.createOrGetLocationFromGoogleMaps(
      google_place_data,
      user.id,
      {
        autoLink: auto_link_to_user,
        initialStatus: initial_status,
        sourceType: "itinerary_added"
      }
    );
    return new Response(JSON.stringify({
      success: true,
      data: location
    }), {
      status: 200,
      headers: { "Content-Type": "application/json" }
    });
  } catch (error) {
    console.error("[Itinerary Location API] Error creating location from Google:", error);
    return new Response(JSON.stringify({
      success: false,
      error: error.message || "Failed to create location"
    }), {
      status: 500,
      headers: { "Content-Type": "application/json" }
    });
  }
}
async function handleGetUserPersonalLocations(request, env, user, locationService) {
  try {
    const url = new URL(request.url);
    const status = url.searchParams.get("status");
    const category = url.searchParams.get("category");
    const userLocations = await locationService.getUserLocations(user.id);
    let filtered = userLocations;
    if (status) {
      filtered = filtered.filter((loc) => loc.user_location_status === status);
    }
    if (category) {
      filtered = filtered.filter((loc) => loc.category === category);
    }
    return new Response(JSON.stringify({
      success: true,
      data: filtered
    }), {
      status: 200,
      headers: { "Content-Type": "application/json" }
    });
  } catch (error) {
    console.error("[Itinerary Location API] Error getting user personal locations:", error);
    return new Response(JSON.stringify({
      success: false,
      error: error.message || "Failed to get user locations"
    }), {
      status: 500,
      headers: { "Content-Type": "application/json" }
    });
  }
}
async function handleUpdateUserLocationStatus(request, env, user, locationService, locationId) {
  try {
    const body = await request.json();
    const { status, user_rating, user_description } = body;
    if (!locationId) {
      return new Response(JSON.stringify({
        success: false,
        error: "Missing location_id"
      }), {
        status: 400,
        headers: { "Content-Type": "application/json" }
      });
    }
    const existing = await locationService.db.prepare(
      `SELECT * FROM user_locations WHERE user_id = ? AND location_id = ?`
    ).bind(user.id, locationId).first();
    const now = (/* @__PURE__ */ new Date()).toISOString();
    if (existing) {
      await locationService.db.prepare(
        `UPDATE user_locations 
         SET status = COALESCE(?, status), 
             user_rating = COALESCE(?, user_rating),
             user_description = COALESCE(?, user_description),
             updated_at = ?
         WHERE user_id = ? AND location_id = ?`
      ).bind(
        status || null,
        user_rating || null,
        user_description || null,
        now,
        user.id,
        locationId
      ).run();
      if (status === "visited" && existing.status !== "visited") {
        await locationService.incrementVisitCount(locationId);
      }
    } else {
      const linkId = crypto.randomUUID();
      await locationService.db.prepare(
        `INSERT INTO user_locations (id, user_id, location_id, status, user_rating, user_description, added_at, updated_at)
         VALUES (?, ?, ?, ?, ?, ?, ?, ?)`
      ).bind(
        linkId,
        user.id,
        locationId,
        status || "want_to_visit",
        user_rating || null,
        user_description || null,
        now,
        now
      ).run();
      if (status === "visited") {
        await locationService.incrementVisitCount(locationId);
      }
    }
    return new Response(JSON.stringify({
      success: true,
      message: "User location status updated"
    }), {
      status: 200,
      headers: { "Content-Type": "application/json" }
    });
  } catch (error) {
    console.error("[Itinerary Location API] Error updating user location status:", error);
    return new Response(JSON.stringify({
      success: false,
      error: error.message || "Failed to update user location status"
    }), {
      status: 500,
      headers: { "Content-Type": "application/json" }
    });
  }
}
var init_itinerary_location = __esm({
  "src/api/itinerary-location.js"() {
    "use strict";
  }
});

// src/api/itinerary.js
var itinerary_exports = {};
__export(itinerary_exports, {
  handleItineraryRequest: () => handleItineraryRequest
});
async function handleItineraryRequest(request, env, user) {
  const url = new URL(request.url);
  const path = url.pathname;
  const method = request.method;
  if (!user) {
    return new Response(JSON.stringify({
      success: false,
      error: "Unauthorized"
    }), {
      status: 401,
      headers: { "Content-Type": "application/json" }
    });
  }
  try {
    const locationService = new (await Promise.resolve().then(() => (init_LocationService(), LocationService_exports))).LocationService(
      env.DB,
      env.GOOGLE_MAPS_API_KEY
    );
    const aiService = new (await Promise.resolve().then(() => (init_AIService(), AIService_exports))).AIService(
      env.DB,
      env.OPENAI_API_KEY,
      env.GEMINI_API_KEY,
      locationService,
      env.GOOGLE_MAPS_API_KEY
    );
    const itineraryService = new ItineraryService(env.DB, locationService, aiService);
    if (path === "/api/itinerary/maps-api-key" && method === "GET") {
      return new Response(JSON.stringify({
        success: true,
        apiKey: env.GOOGLE_MAPS_API_KEY || ""
      }), {
        status: 200,
        headers: { "Content-Type": "application/json" }
      });
    } else if (path === "/api/itinerary" && method === "GET") {
      return await handleGetUserItineraries(request, env, user, itineraryService);
    } else if (path === "/api/itinerary" && method === "POST") {
      return await handleCreateItinerary(request, env, user, itineraryService);
    } else if (path.startsWith("/api/itinerary/") && method === "GET") {
      const itineraryId = path.split("/").pop();
      return await handleGetItinerary(request, env, user, itineraryService, itineraryId);
    } else if (path.startsWith("/api/itinerary/") && method === "PUT") {
      const itineraryId = path.split("/").pop();
      return await handleUpdateItinerary(request, env, user, itineraryService, itineraryId);
    } else if (path.startsWith("/api/itinerary/") && method === "DELETE") {
      const itineraryId = path.split("/").pop();
      return await handleDeleteItinerary(request, env, user, itineraryService, itineraryId);
    } else if (path.startsWith("/api/itinerary/") && path.endsWith("/optimize") && method === "POST") {
      const itineraryId = path.split("/")[3];
      return await handleOptimizeItinerary(request, env, user, itineraryService, itineraryId);
    } else if (path === "/api/itinerary/search-places" && method === "POST") {
      return await handleSearchPlaces(request, env, user, aiService);
    } else if (path === "/api/itinerary/optimize-day-plan" && method === "POST") {
      return await handleOptimizeDayPlan(request, env, user, aiService);
    } else if (path === "/api/itinerary/location/from-google" && method === "POST") {
      return await handleCreateLocationFromGoogle(request, env, user, locationService);
    } else if (path === "/api/itinerary/location/personal" && method === "GET") {
      return await handleGetUserPersonalLocations(request, env, user, locationService);
    } else if (path.startsWith("/api/itinerary/location/personal/") && method === "PUT") {
      const locationId = path.split("/").pop();
      return await handleUpdateUserLocationStatus(request, env, user, locationService, locationId);
    }
    return new Response(JSON.stringify({
      success: false,
      error: "API endpoint not found"
    }), {
      status: 404,
      headers: { "Content-Type": "application/json" }
    });
  } catch (error) {
    console.error("[Itinerary API] Error:", error);
    return new Response(JSON.stringify({
      success: false,
      error: error.message || "Internal server error"
    }), {
      status: 500,
      headers: { "Content-Type": "application/json" }
    });
  }
}
async function handleGetUserItineraries(request, env, user, itineraryService) {
  try {
    const itineraries = await itineraryService.getUserItineraries(user.id);
    return new Response(JSON.stringify({
      success: true,
      data: itineraries
    }), {
      status: 200,
      headers: { "Content-Type": "application/json" }
    });
  } catch (error) {
    console.error("[Itinerary API] Error getting user itineraries:", error);
    return new Response(JSON.stringify({
      success: false,
      error: error.message || "Failed to get itineraries"
    }), {
      status: 500,
      headers: { "Content-Type": "application/json" }
    });
  }
}
async function handleCreateItinerary(request, env, user, itineraryService) {
  try {
    const body = await request.json();
    const { title, dayPlans } = body;
    if (!dayPlans || !Array.isArray(dayPlans)) {
      return new Response(JSON.stringify({
        success: false,
        error: "dayPlans is required and must be an array"
      }), {
        status: 400,
        headers: { "Content-Type": "application/json" }
      });
    }
    const itinerary = await itineraryService.createItinerary(user.id, {
      title,
      dayPlans
    });
    return new Response(JSON.stringify({
      success: true,
      data: itinerary
    }), {
      status: 201,
      headers: { "Content-Type": "application/json" }
    });
  } catch (error) {
    console.error("[Itinerary API] Error creating itinerary:", error);
    return new Response(JSON.stringify({
      success: false,
      error: error.message || "Failed to create itinerary"
    }), {
      status: 500,
      headers: { "Content-Type": "application/json" }
    });
  }
}
async function handleGetItinerary(request, env, user, itineraryService, itineraryId) {
  try {
    if (!itineraryId) {
      return new Response(JSON.stringify({
        success: false,
        error: "Itinerary ID is required"
      }), {
        status: 400,
        headers: { "Content-Type": "application/json" }
      });
    }
    const itinerary = await itineraryService.getItinerary(user.id, itineraryId);
    if (!itinerary) {
      return new Response(JSON.stringify({
        success: false,
        error: "Itinerary not found"
      }), {
        status: 404,
        headers: { "Content-Type": "application/json" }
      });
    }
    return new Response(JSON.stringify({
      success: true,
      data: itinerary
    }), {
      status: 200,
      headers: { "Content-Type": "application/json" }
    });
  } catch (error) {
    console.error("[Itinerary API] Error getting itinerary:", error);
    return new Response(JSON.stringify({
      success: false,
      error: error.message || "Failed to get itinerary"
    }), {
      status: 500,
      headers: { "Content-Type": "application/json" }
    });
  }
}
async function handleUpdateItinerary(request, env, user, itineraryService, itineraryId) {
  try {
    if (!itineraryId) {
      return new Response(JSON.stringify({
        success: false,
        error: "Itinerary ID is required"
      }), {
        status: 400,
        headers: { "Content-Type": "application/json" }
      });
    }
    const body = await request.json();
    const { title, dayPlans } = body;
    const itinerary = await itineraryService.updateItinerary(user.id, itineraryId, {
      title,
      dayPlans
    });
    return new Response(JSON.stringify({
      success: true,
      data: itinerary
    }), {
      status: 200,
      headers: { "Content-Type": "application/json" }
    });
  } catch (error) {
    console.error("[Itinerary API] Error updating itinerary:", error);
    return new Response(JSON.stringify({
      success: false,
      error: error.message || "Failed to update itinerary"
    }), {
      status: 500,
      headers: { "Content-Type": "application/json" }
    });
  }
}
async function handleDeleteItinerary(request, env, user, itineraryService, itineraryId) {
  try {
    if (!itineraryId) {
      return new Response(JSON.stringify({
        success: false,
        error: "Itinerary ID is required"
      }), {
        status: 400,
        headers: { "Content-Type": "application/json" }
      });
    }
    await itineraryService.deleteItinerary(user.id, itineraryId);
    return new Response(JSON.stringify({
      success: true,
      message: "Itinerary deleted successfully"
    }), {
      status: 200,
      headers: { "Content-Type": "application/json" }
    });
  } catch (error) {
    console.error("[Itinerary API] Error deleting itinerary:", error);
    return new Response(JSON.stringify({
      success: false,
      error: error.message || "Failed to delete itinerary"
    }), {
      status: 500,
      headers: { "Content-Type": "application/json" }
    });
  }
}
async function handleOptimizeItinerary(request, env, user, itineraryService, itineraryId) {
  try {
    if (!itineraryId) {
      return new Response(JSON.stringify({
        success: false,
        error: "Itinerary ID is required"
      }), {
        status: 400,
        headers: { "Content-Type": "application/json" }
      });
    }
    const body = await request.json();
    const { dayIndex } = body || {};
    const itinerary = await itineraryService.optimizeItinerary(
      user.id,
      itineraryId,
      dayIndex !== void 0 ? dayIndex : null
    );
    return new Response(JSON.stringify({
      success: true,
      data: itinerary
    }), {
      status: 200,
      headers: { "Content-Type": "application/json" }
    });
  } catch (error) {
    console.error("[Itinerary API] Error optimizing itinerary:", error);
    return new Response(JSON.stringify({
      success: false,
      error: error.message || "Failed to optimize itinerary"
    }), {
      status: 500,
      headers: { "Content-Type": "application/json" }
    });
  }
}
async function handleSearchPlaces(request, env, user, aiService) {
  var _a, _b, _c, _d;
  try {
    const body = await request.json();
    const { query, latitude, longitude } = body;
    if (!query) {
      return new Response(JSON.stringify({
        success: false,
        error: "Query is required"
      }), {
        status: 400,
        headers: { "Content-Type": "application/json" }
      });
    }
    if (!env.GEMINI_API_KEY) {
      return new Response(JSON.stringify({
        success: false,
        error: "Gemini API key not configured"
      }), {
        status: 500,
        headers: { "Content-Type": "application/json" }
      });
    }
    try {
      const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${env.GEMINI_API_KEY}`;
      const response = await fetch(url, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          contents: [{
            parts: [{
              text: `\u4F60\u662F\u4E00\u500B\u5C08\u696D\u7684\u6F8E\u6E56\u5C0E\u904A\u3002\u8ACB\u91DD\u5C0D\u641C\u5C0B\u8A5E "${query}" \u627E\u51FA\u6F8E\u6E56\u76F8\u95DC\u7684\u71B1\u9580\u666F\u9EDE\u3001\u96B1\u85CF\u7F8E\u98DF\u6216\u5730\u6A19\u3002
\u8ACB\u52D9\u5FC5\u900F\u904E Google Maps \u641C\u5C0B\u5DE5\u5177\u56DE\u50B3\u7CBE\u78BA\u7684\u5730\u9EDE\u540D\u7A31\u3001\u5730\u5740\u4EE5\u53CA\u7D93\u7DEF\u5EA6\u5EA7\u6A19\u3002`
            }]
          }],
          tools: [{ googleMaps: {} }],
          toolConfig: {
            retrievalConfig: {
              latLng: latitude && longitude ? { latitude, longitude } : void 0
            }
          }
        })
      });
      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(((_a = errorData.error) == null ? void 0 : _a.message) || `Gemini API error: ${response.status}`);
      }
      const data = await response.json();
      const chunks = ((_d = (_c = (_b = data.candidates) == null ? void 0 : _b[0]) == null ? void 0 : _c.groundingMetadata) == null ? void 0 : _d.groundingChunks) || [];
      const places = chunks.filter((chunk) => chunk.maps).map((chunk, index) => {
        const mapData = chunk.maps;
        return {
          id: `place-${Date.now()}-${index}`,
          name: mapData.title || "\u672A\u77E5\u5730\u9EDE",
          uri: mapData.uri,
          address: mapData.address,
          location: mapData.location ? {
            lat: mapData.location.latitude,
            lng: mapData.location.longitude
          } : void 0
        };
      });
      return new Response(JSON.stringify({
        success: true,
        data: places
      }), {
        status: 200,
        headers: { "Content-Type": "application/json" }
      });
    } catch (error) {
      console.error("[Itinerary API] Gemini search error:", error);
      return new Response(JSON.stringify({
        success: false,
        error: error.message || "Failed to search places"
      }), {
        status: 500,
        headers: { "Content-Type": "application/json" }
      });
    }
  } catch (error) {
    console.error("[Itinerary API] Error searching places:", error);
    return new Response(JSON.stringify({
      success: false,
      error: error.message || "Failed to search places"
    }), {
      status: 500,
      headers: { "Content-Type": "application/json" }
    });
  }
}
async function handleOptimizeDayPlan(request, env, user, aiService) {
  var _a, _b, _c, _d, _e, _f;
  try {
    const body = await request.json();
    const { places } = body;
    if (!places || !Array.isArray(places)) {
      return new Response(JSON.stringify({
        success: false,
        error: "Places array is required"
      }), {
        status: 400,
        headers: { "Content-Type": "application/json" }
      });
    }
    if (!env.GEMINI_API_KEY) {
      return new Response(JSON.stringify({
        success: false,
        error: "Gemini API key not configured"
      }), {
        status: 500,
        headers: { "Content-Type": "application/json" }
      });
    }
    try {
      const prompt = `\u5DF2\u77E5\u5730\u9EDE\uFF1A${places.map((p) => p.name).join(", ")}\uFF0C
\u8ACB\u6839\u64DA\u5730\u7406\u4F4D\u7F6E\u3001\u6F8E\u6E56\u7684\u4EA4\u901A\u7279\u6027\u8207\u5E38\u898B\u71DF\u696D\u6642\u9593\uFF0C\u70BA\u4E00\u5929\u7684\u884C\u7A0B\u5B89\u6392\u6700\u9806\u66A2\u7684\u5148\u5F8C\u9806\u5E8F\u3002
\u8ACB\u4EE5 JSON \u683C\u5F0F\u56DE\u50B3\uFF0C\u5305\u542B 'itinerary' \u9663\u5217\uFF1A
{ placeName: \u5730\u9EDE\u540D\u7A31, recommendedTime: \u5EFA\u8B70\u6642\u9593 (HH:MM\u683C\u5F0F), reason: \u5B89\u6392\u7406\u7531 }`;
      const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-3-pro-preview:generateContent?key=${env.GEMINI_API_KEY}`;
      const response = await fetch(url, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          contents: [{
            parts: [{ text: prompt }]
          }],
          generationConfig: {
            responseMimeType: "application/json",
            responseSchema: {
              type: "object",
              properties: {
                itinerary: {
                  type: "array",
                  items: {
                    type: "object",
                    properties: {
                      placeName: { type: "string" },
                      recommendedTime: { type: "string" },
                      reason: { type: "string" }
                    },
                    required: ["placeName", "recommendedTime"]
                  }
                }
              },
              required: ["itinerary"]
            }
          }
        })
      });
      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(((_a = errorData.error) == null ? void 0 : _a.message) || `Gemini API error: ${response.status}`);
      }
      const data = await response.json();
      const text = ((_f = (_e = (_d = (_c = (_b = data.candidates) == null ? void 0 : _b[0]) == null ? void 0 : _c.content) == null ? void 0 : _d.parts) == null ? void 0 : _e[0]) == null ? void 0 : _f.text) || "{}";
      const optimizedData = JSON.parse(text);
      return new Response(JSON.stringify({
        success: true,
        data: optimizedData
      }), {
        status: 200,
        headers: { "Content-Type": "application/json" }
      });
    } catch (error) {
      console.error("[Itinerary API] Gemini optimization error:", error);
      return new Response(JSON.stringify({
        success: false,
        error: error.message || "Failed to optimize day plan"
      }), {
        status: 500,
        headers: { "Content-Type": "application/json" }
      });
    }
  } catch (error) {
    console.error("[Itinerary API] Error optimizing day plan:", error);
    return new Response(JSON.stringify({
      success: false,
      error: error.message || "Failed to optimize day plan"
    }), {
      status: 500,
      headers: { "Content-Type": "application/json" }
    });
  }
}
var init_itinerary = __esm({
  "src/api/itinerary.js"() {
    "use strict";
    init_ItineraryService();
    init_itinerary_location();
  }
});

// src/api/trip-planner.js
var trip_planner_exports = {};
__export(trip_planner_exports, {
  handleTripPlannerRequest: () => handleTripPlannerRequest
});
async function handleTripPlannerRequest(request, env, user) {
  const url = new URL(request.url);
  const path = url.pathname;
  const method = request.method;
  try {
    if (path.startsWith("/api/trip-planner/shared/") && method === "GET") {
      const shareToken = path.split("/").pop();
      if (shareToken && shareToken !== "shared") {
        return await handleGetSharedTrip(shareToken, env);
      }
    }
    if (!user) {
      return new Response(JSON.stringify({
        success: false,
        error: "Unauthorized"
      }), {
        status: 401,
        headers: { "Content-Type": "application/json" }
      });
    }
    if (path === "/api/trip-planner/save" && method === "POST") {
      return await handleSaveTrip(request, env, user);
    }
    if (path === "/api/trip-planner/list" && method === "GET") {
      return await handleGetUserTrips(request, env, user);
    }
    if (path.startsWith("/api/trip-planner/item/") && path.endsWith("/booking-status") && method === "PUT") {
      const itemId = path.split("/")[4];
      return await handleUpdateBookingStatus(itemId, request, env, user);
    }
    if (path.startsWith("/api/trip-planner/item/") && path.endsWith("/booking-info") && method === "PUT") {
      const itemId = path.split("/")[4];
      return await handleUpdateBookingInfo(itemId, request, env, user);
    }
    if (path.startsWith("/api/trip-planner/") && path.endsWith("/share") && method === "POST") {
      const tripId = path.split("/")[3];
      return await handleShareTrip(tripId, request, env, user);
    }
    if (path.startsWith("/api/trip-planner/") && path.endsWith("/share") && method === "DELETE") {
      const tripId = path.split("/")[3];
      return await handleUnshareTrip(tripId, env, user);
    }
    if (path.startsWith("/api/trip-planner/") && method === "GET") {
      const tripId = path.split("/").pop();
      if (tripId && tripId !== "save" && tripId !== "list" && tripId !== "shared") {
        return await handleGetTrip(tripId, env, user);
      }
    }
    if (path.startsWith("/api/trip-planner/") && method === "DELETE") {
      const tripId = path.split("/").pop();
      if (tripId && tripId !== "save" && tripId !== "list" && tripId !== "shared") {
        return await handleDeleteTrip(tripId, env, user);
      }
    }
    return new Response(JSON.stringify({
      success: false,
      error: "API endpoint not found"
    }), {
      status: 404,
      headers: { "Content-Type": "application/json" }
    });
  } catch (error) {
    console.error("[Trip Planner API] Error:", error);
    return new Response(JSON.stringify({
      success: false,
      error: "Internal server error",
      message: error.message
    }), {
      status: 500,
      headers: { "Content-Type": "application/json" }
    });
  }
}
async function handleSaveTrip(request, env, user) {
  try {
    const body = await request.json();
    const { title, days } = body;
    if (!title || !days || !Array.isArray(days)) {
      return new Response(JSON.stringify({
        success: false,
        error: "Invalid request data"
      }), {
        status: 400,
        headers: { "Content-Type": "application/json" }
      });
    }
    const tripId = body.tripId || `trip_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
    const now = Date.now();
    const shareToken = body.shareToken || null;
    const isPublic = body.isPublic ? 1 : 0;
    const existingTrip = await env.DB.prepare(
      `SELECT id FROM trip_plans WHERE id = ? AND user_id = ?`
    ).bind(tripId, user.id).first();
    if (existingTrip) {
      await env.DB.prepare(
        `UPDATE trip_plans SET title = ?, updated_at = ?, share_token = ?, is_public = ? WHERE id = ?`
      ).bind(title, now, shareToken, isPublic, tripId).run();
      await env.DB.prepare(
        `DELETE FROM trip_plan_items WHERE trip_id = ?`
      ).bind(tripId).run();
    } else {
      await env.DB.prepare(
        `INSERT INTO trip_plans (id, user_id, title, share_token, is_public, created_at, updated_at)
         VALUES (?, ?, ?, ?, ?, ?, ?)`
      ).bind(tripId, user.id, title, shareToken, isPublic, now, now).run();
    }
    for (let dayIndex = 0; dayIndex < days.length; dayIndex++) {
      const day = days[dayIndex];
      if (!day.date || !day.places || !Array.isArray(day.places)) {
        continue;
      }
      for (let placeIndex = 0; placeIndex < day.places.length; placeIndex++) {
        const place = day.places[placeIndex];
        if (!place.placeId) {
          continue;
        }
        const itemId = `trip_item_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
        await env.DB.prepare(
          `INSERT INTO trip_plan_items (id, trip_id, day_index, place_id, time, order_index, booking_status, booking_url, booking_phone, booking_notes, created_at)
           VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)`
        ).bind(
          itemId,
          tripId,
          dayIndex,
          place.placeId,
          place.time || "09:00",
          place.order || placeIndex,
          place.bookingStatus || "planned",
          place.bookingUrl || null,
          place.bookingPhone || null,
          place.bookingNotes || null,
          now
        ).run();
      }
    }
    return new Response(JSON.stringify({
      success: true,
      tripId,
      message: "\u884C\u7A0B\u5DF2\u5132\u5B58"
    }), {
      status: 200,
      headers: { "Content-Type": "application/json" }
    });
  } catch (error) {
    console.error("[Trip Planner API] Error saving trip:", error);
    return new Response(JSON.stringify({
      success: false,
      error: "Failed to save trip",
      message: error.message
    }), {
      status: 500,
      headers: { "Content-Type": "application/json" }
    });
  }
}
async function handleGetUserTrips(request, env, user) {
  try {
    const trips = await env.DB.prepare(
      `SELECT id, title, created_at, updated_at
       FROM trip_plans
       WHERE user_id = ?
       ORDER BY updated_at DESC
       LIMIT 50`
    ).bind(user.id).all();
    return new Response(JSON.stringify({
      success: true,
      trips: trips.results || []
    }), {
      status: 200,
      headers: { "Content-Type": "application/json" }
    });
  } catch (error) {
    console.error("[Trip Planner API] Error getting user trips:", error);
    return new Response(JSON.stringify({
      success: false,
      error: "Failed to get trips",
      message: error.message
    }), {
      status: 500,
      headers: { "Content-Type": "application/json" }
    });
  }
}
async function handleGetTrip(tripId, env, user) {
  try {
    const trip = await env.DB.prepare(
      `SELECT id, user_id, title, share_token, is_public, created_at, updated_at
       FROM trip_plans
       WHERE id = ? AND user_id = ?`
    ).bind(tripId, user.id).first();
    if (!trip) {
      return new Response(JSON.stringify({
        success: false,
        error: "Trip not found"
      }), {
        status: 404,
        headers: { "Content-Type": "application/json" }
      });
    }
    const items = await env.DB.prepare(
      `SELECT id, day_index, place_id, time, order_index, booking_status, booking_url, booking_phone, booking_notes
       FROM trip_plan_items
       WHERE trip_id = ?
       ORDER BY day_index, order_index`
    ).bind(tripId).all();
    const daysMap = /* @__PURE__ */ new Map();
    for (const item of items.results || []) {
      const dayIndex = item.day_index;
      if (!daysMap.has(dayIndex)) {
        daysMap.set(dayIndex, []);
      }
      daysMap.get(dayIndex).push({
        id: item.id,
        placeId: item.place_id,
        time: item.time,
        order: item.order_index,
        bookingStatus: item.booking_status || "planned",
        bookingUrl: item.booking_url,
        bookingPhone: item.booking_phone,
        bookingNotes: item.booking_notes
      });
    }
    const days = Array.from(daysMap.entries()).sort((a, b) => a[0] - b[0]).map(([dayIndex, places]) => ({
      dayIndex,
      places
    }));
    return new Response(JSON.stringify({
      success: true,
      trip: {
        id: trip.id,
        title: trip.title,
        shareToken: trip.share_token,
        isPublic: trip.is_public === 1,
        createdAt: trip.created_at,
        updatedAt: trip.updated_at,
        days
      }
    }), {
      status: 200,
      headers: { "Content-Type": "application/json" }
    });
  } catch (error) {
    console.error("[Trip Planner API] Error getting trip:", error);
    return new Response(JSON.stringify({
      success: false,
      error: "Failed to get trip",
      message: error.message
    }), {
      status: 500,
      headers: { "Content-Type": "application/json" }
    });
  }
}
async function handleDeleteTrip(tripId, env, user) {
  try {
    const trip = await env.DB.prepare(
      `SELECT id FROM trip_plans WHERE id = ? AND user_id = ?`
    ).bind(tripId, user.id).first();
    if (!trip) {
      return new Response(JSON.stringify({
        success: false,
        error: "Trip not found"
      }), {
        status: 404,
        headers: { "Content-Type": "application/json" }
      });
    }
    await env.DB.prepare(
      `DELETE FROM trip_plan_items WHERE trip_id = ?`
    ).bind(tripId).run();
    await env.DB.prepare(
      `DELETE FROM trip_plans WHERE id = ?`
    ).bind(tripId).run();
    return new Response(JSON.stringify({
      success: true,
      message: "Trip deleted"
    }), {
      status: 200,
      headers: { "Content-Type": "application/json" }
    });
  } catch (error) {
    console.error("[Trip Planner API] Error deleting trip:", error);
    return new Response(JSON.stringify({
      success: false,
      error: "Failed to delete trip",
      message: error.message
    }), {
      status: 500,
      headers: { "Content-Type": "application/json" }
    });
  }
}
async function handleUpdateBookingStatus(itemId, request, env, user) {
  try {
    const body = await request.json();
    const { bookingStatus } = body;
    if (!bookingStatus || !["planned", "booked", "completed", "cancelled"].includes(bookingStatus)) {
      return new Response(JSON.stringify({
        success: false,
        error: "Invalid booking status"
      }), {
        status: 400,
        headers: { "Content-Type": "application/json" }
      });
    }
    const item = await env.DB.prepare(
      `SELECT tpi.id, tp.user_id 
       FROM trip_plan_items tpi
       JOIN trip_plans tp ON tpi.trip_id = tp.id
       WHERE tpi.id = ? AND tp.user_id = ?`
    ).bind(itemId, user.id).first();
    if (!item) {
      return new Response(JSON.stringify({
        success: false,
        error: "Item not found or unauthorized"
      }), {
        status: 404,
        headers: { "Content-Type": "application/json" }
      });
    }
    await env.DB.prepare(
      `UPDATE trip_plan_items SET booking_status = ? WHERE id = ?`
    ).bind(bookingStatus, itemId).run();
    return new Response(JSON.stringify({
      success: true,
      message: "Booking status updated"
    }), {
      status: 200,
      headers: { "Content-Type": "application/json" }
    });
  } catch (error) {
    console.error("[Trip Planner API] Error updating booking status:", error);
    return new Response(JSON.stringify({
      success: false,
      error: "Failed to update booking status",
      message: error.message
    }), {
      status: 500,
      headers: { "Content-Type": "application/json" }
    });
  }
}
async function handleUpdateBookingInfo(itemId, request, env, user) {
  try {
    const body = await request.json();
    const { bookingUrl, bookingPhone, bookingNotes } = body;
    const item = await env.DB.prepare(
      `SELECT tpi.id, tp.user_id 
       FROM trip_plan_items tpi
       JOIN trip_plans tp ON tpi.trip_id = tp.id
       WHERE tpi.id = ? AND tp.user_id = ?`
    ).bind(itemId, user.id).first();
    if (!item) {
      return new Response(JSON.stringify({
        success: false,
        error: "Item not found or unauthorized"
      }), {
        status: 404,
        headers: { "Content-Type": "application/json" }
      });
    }
    await env.DB.prepare(
      `UPDATE trip_plan_items 
       SET booking_url = ?, booking_phone = ?, booking_notes = ?
       WHERE id = ?`
    ).bind(bookingUrl || null, bookingPhone || null, bookingNotes || null, itemId).run();
    return new Response(JSON.stringify({
      success: true,
      message: "Booking info updated"
    }), {
      status: 200,
      headers: { "Content-Type": "application/json" }
    });
  } catch (error) {
    console.error("[Trip Planner API] Error updating booking info:", error);
    return new Response(JSON.stringify({
      success: false,
      error: "Failed to update booking info",
      message: error.message
    }), {
      status: 500,
      headers: { "Content-Type": "application/json" }
    });
  }
}
async function handleShareTrip(tripId, request, env, user) {
  try {
    const body = await request.json();
    const { isPublic } = body;
    const trip = await env.DB.prepare(
      `SELECT id FROM trip_plans WHERE id = ? AND user_id = ?`
    ).bind(tripId, user.id).first();
    if (!trip) {
      return new Response(JSON.stringify({
        success: false,
        error: "Trip not found or unauthorized"
      }), {
        status: 404,
        headers: { "Content-Type": "application/json" }
      });
    }
    let shareToken = await env.DB.prepare(
      `SELECT share_token FROM trip_plans WHERE id = ?`
    ).bind(tripId).first();
    if (!shareToken || !shareToken.share_token) {
      shareToken = `share_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
      let attempts = 0;
      while (attempts < 10) {
        const existing = await env.DB.prepare(
          `SELECT id FROM trip_plans WHERE share_token = ?`
        ).bind(shareToken).first();
        if (!existing)
          break;
        shareToken = `share_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
        attempts++;
      }
    } else {
      shareToken = shareToken.share_token;
    }
    await env.DB.prepare(
      `UPDATE trip_plans SET share_token = ?, is_public = ? WHERE id = ?`
    ).bind(shareToken, isPublic ? 1 : 0, tripId).run();
    const shareUrl = `${new URL(request.url).origin}/trip-planner/shared/${shareToken}`;
    return new Response(JSON.stringify({
      success: true,
      shareToken,
      shareUrl,
      isPublic
    }), {
      status: 200,
      headers: { "Content-Type": "application/json" }
    });
  } catch (error) {
    console.error("[Trip Planner API] Error sharing trip:", error);
    return new Response(JSON.stringify({
      success: false,
      error: "Failed to share trip",
      message: error.message
    }), {
      status: 500,
      headers: { "Content-Type": "application/json" }
    });
  }
}
async function handleUnshareTrip(tripId, env, user) {
  try {
    const trip = await env.DB.prepare(
      `SELECT id FROM trip_plans WHERE id = ? AND user_id = ?`
    ).bind(tripId, user.id).first();
    if (!trip) {
      return new Response(JSON.stringify({
        success: false,
        error: "Trip not found or unauthorized"
      }), {
        status: 404,
        headers: { "Content-Type": "application/json" }
      });
    }
    await env.DB.prepare(
      `UPDATE trip_plans SET share_token = NULL, is_public = 0 WHERE id = ?`
    ).bind(tripId).run();
    return new Response(JSON.stringify({
      success: true,
      message: "Trip unshared"
    }), {
      status: 200,
      headers: { "Content-Type": "application/json" }
    });
  } catch (error) {
    console.error("[Trip Planner API] Error unsharing trip:", error);
    return new Response(JSON.stringify({
      success: false,
      error: "Failed to unshare trip",
      message: error.message
    }), {
      status: 500,
      headers: { "Content-Type": "application/json" }
    });
  }
}
async function handleGetSharedTrip(shareToken, env) {
  try {
    const trip = await env.DB.prepare(
      `SELECT id, user_id, title, is_public, created_at, updated_at
       FROM trip_plans
       WHERE share_token = ? AND is_public = 1`
    ).bind(shareToken).first();
    if (!trip) {
      return new Response(JSON.stringify({
        success: false,
        error: "Shared trip not found"
      }), {
        status: 404,
        headers: { "Content-Type": "application/json" }
      });
    }
    const items = await env.DB.prepare(
      `SELECT id, day_index, place_id, time, order_index, booking_status
       FROM trip_plan_items
       WHERE trip_id = ?
       ORDER BY day_index, order_index`
    ).bind(trip.id).all();
    const daysMap = /* @__PURE__ */ new Map();
    for (const item of items.results || []) {
      const dayIndex = item.day_index;
      if (!daysMap.has(dayIndex)) {
        daysMap.set(dayIndex, []);
      }
      daysMap.get(dayIndex).push({
        id: item.id,
        placeId: item.place_id,
        time: item.time,
        order: item.order_index,
        bookingStatus: item.booking_status || "planned"
      });
    }
    const days = Array.from(daysMap.entries()).sort((a, b) => a[0] - b[0]).map(([dayIndex, places]) => ({
      dayIndex,
      places
    }));
    return new Response(JSON.stringify({
      success: true,
      trip: {
        id: trip.id,
        title: trip.title,
        createdAt: trip.created_at,
        updatedAt: trip.updated_at,
        days
      }
    }), {
      status: 200,
      headers: { "Content-Type": "application/json" }
    });
  } catch (error) {
    console.error("[Trip Planner API] Error getting shared trip:", error);
    return new Response(JSON.stringify({
      success: false,
      error: "Failed to get shared trip",
      message: error.message
    }), {
      status: 500,
      headers: { "Content-Type": "application/json" }
    });
  }
}
var init_trip_planner = __esm({
  "src/api/trip-planner.js"() {
    "use strict";
  }
});

// src/api/business-verification.js
var business_verification_exports = {};
__export(business_verification_exports, {
  handleBusinessVerificationRequest: () => handleBusinessVerificationRequest
});
async function handleBusinessVerificationRequest(request, env, user = null) {
  var _a;
  const url = new URL(request.url);
  const pathname2 = url.pathname;
  if (!env.DB) {
    return new Response(JSON.stringify({
      success: false,
      error: "Database not available"
    }), {
      status: 500,
      headers: { "Content-Type": "application/json" }
    });
  }
  try {
    const verificationService = ((_a = env.services) == null ? void 0 : _a.businessVerification) || new BusinessVerificationService(env.DB);
    if (pathname2 === "/api/business/verify/request" && request.method === "POST") {
      return await handleRequestVerification(request, env, user, verificationService);
    }
    if (pathname2 === "/api/business/verify/status" && request.method === "GET") {
      return await handleGetVerificationStatus(request, env, user, verificationService);
    }
    if (pathname2 === "/api/business/verify/my-requests" && request.method === "GET") {
      return await handleGetUserVerifications(request, env, user, verificationService);
    }
    const adminAuthCheck = requireAdminAPI(user);
    if (adminAuthCheck)
      return adminAuthCheck;
    if (pathname2 === "/api/business/verify/pending" && request.method === "GET") {
      return await handleGetPendingVerifications(request, env, user, verificationService);
    }
    if (pathname2 === "/api/business/verify/all" && request.method === "GET") {
      return await handleGetAllVerifications(request, env, user, verificationService);
    }
    if (pathname2 === "/api/business/verify/stats" && request.method === "GET") {
      const cachedHandler = withCache(handleGetStatistics2, {
        cacheKey: "business-verification",
        ttl: CACHE_TTL.MEDIUM,
        // 5 分鐘
        keyGenerator: () => "stats"
      });
      return await cachedHandler(request, env, user, verificationService);
    }
    if (pathname2 === "/api/business/verify/approve" && request.method === "POST") {
      return await handleApproveVerification(request, env, user, verificationService);
    }
    if (pathname2 === "/api/business/verify/reject" && request.method === "POST") {
      return await handleRejectVerification(request, env, user, verificationService);
    }
    if (pathname2.startsWith("/api/business/verify/") && pathname2.endsWith("/details") && request.method === "GET") {
      const verificationId = pathname2.split("/")[4];
      return await handleGetVerificationDetails(request, env, user, verificationService, verificationId);
    }
    if (pathname2 === "/api/business/verify/batch-approve" && request.method === "POST") {
      return await handleBatchApproveVerifications(request, env, user, verificationService);
    }
    if (pathname2 === "/api/business/verify/batch-reject" && request.method === "POST") {
      return await handleBatchRejectVerifications(request, env, user, verificationService);
    }
    return new Response("Not Found", { status: 404 });
  } catch (error) {
    console.error("[Business Verification API] Error:", error);
    return new Response(JSON.stringify({
      success: false,
      error: error.message || "Internal Server Error"
    }), {
      status: 500,
      headers: { "Content-Type": "application/json" }
    });
  }
}
async function handleRequestVerification(request, env, user, verificationService) {
  if (!user || !user.id) {
    return new Response(JSON.stringify({
      success: false,
      error: "Authentication required"
    }), {
      status: 401,
      headers: { "Content-Type": "application/json" }
    });
  }
  try {
    const body = await request.json();
    const { location_id, google_place_id } = body;
    if (!location_id) {
      return new Response(JSON.stringify({
        success: false,
        error: "location_id is required"
      }), {
        status: 400,
        headers: { "Content-Type": "application/json" }
      });
    }
    const result = await verificationService.requestVerification(
      location_id,
      user.id,
      google_place_id || null
    );
    return new Response(JSON.stringify(result), {
      status: result.success ? 200 : 400,
      headers: { "Content-Type": "application/json" }
    });
  } catch (error) {
    console.error("[Business Verification API] Error requesting verification:", error);
    throw error;
  }
}
async function handleGetVerificationStatus(request, env, user, verificationService) {
  try {
    const url = new URL(request.url);
    const locationId = url.searchParams.get("location_id");
    if (!locationId) {
      return new Response(JSON.stringify({
        success: false,
        error: "location_id is required"
      }), {
        status: 400,
        headers: { "Content-Type": "application/json" }
      });
    }
    const status = await verificationService.getLocationVerificationStatus(locationId);
    let userVerification = null;
    if (user && user.id) {
      const userVerifications = await verificationService.getUserVerifications(user.id);
      userVerification = userVerifications.find((v) => v.location_id === locationId) || null;
    }
    return new Response(JSON.stringify({
      success: true,
      locationVerification: status,
      userVerification
    }), {
      headers: { "Content-Type": "application/json" }
    });
  } catch (error) {
    console.error("[Business Verification API] Error getting verification status:", error);
    throw error;
  }
}
async function handleGetUserVerifications(request, env, user, verificationService) {
  if (!user || !user.id) {
    return new Response(JSON.stringify({
      success: false,
      error: "Authentication required"
    }), {
      status: 401,
      headers: { "Content-Type": "application/json" }
    });
  }
  try {
    const verifications = await verificationService.getUserVerifications(user.id);
    return new Response(JSON.stringify({
      success: true,
      verifications
    }), {
      headers: { "Content-Type": "application/json" }
    });
  } catch (error) {
    console.error("[Business Verification API] Error getting user verifications:", error);
    throw error;
  }
}
async function handleGetPendingVerifications(request, env, user, verificationService) {
  try {
    const url = new URL(request.url);
    const limit = parseInt(url.searchParams.get("limit") || "20", 10);
    const offset = parseInt(url.searchParams.get("offset") || "0", 10);
    const result = await verificationService.getPendingVerifications(limit, offset);
    return new Response(JSON.stringify({
      success: true,
      ...result
    }), {
      headers: { "Content-Type": "application/json" }
    });
  } catch (error) {
    console.error("[Business Verification API] Error getting pending verifications:", error);
    throw error;
  }
}
async function handleGetAllVerifications(request, env, user, verificationService) {
  try {
    const url = new URL(request.url);
    const limit = parseInt(url.searchParams.get("limit") || "20", 10);
    const offset = parseInt(url.searchParams.get("offset") || "0", 10);
    const status = url.searchParams.get("status") || null;
    const search = url.searchParams.get("search") || null;
    const result = await verificationService.getAllVerifications(limit, offset, status, search);
    return new Response(JSON.stringify({
      success: true,
      ...result
    }), {
      headers: { "Content-Type": "application/json" }
    });
  } catch (error) {
    console.error("[Business Verification API] Error getting all verifications:", error);
    throw error;
  }
}
async function handleGetStatistics2(request, env, user, verificationService) {
  try {
    const stats = await verificationService.getStatistics();
    return new Response(JSON.stringify({
      success: true,
      stats
    }), {
      headers: { "Content-Type": "application/json" }
    });
  } catch (error) {
    console.error("[Business Verification API] Error getting statistics:", error);
    throw error;
  }
}
async function handleApproveVerification(request, env, user, verificationService) {
  try {
    const body = await request.json();
    const { verification_id, notes } = body;
    if (!verification_id) {
      return new Response(JSON.stringify({
        success: false,
        error: "verification_id is required"
      }), {
        status: 400,
        headers: { "Content-Type": "application/json" }
      });
    }
    const result = await verificationService.approveVerification(
      verification_id,
      user.id,
      notes || null
    );
    return new Response(JSON.stringify(result), {
      status: result.success ? 200 : 400,
      headers: { "Content-Type": "application/json" }
    });
  } catch (error) {
    console.error("[Business Verification API] Error approving verification:", error);
    throw error;
  }
}
async function handleRejectVerification(request, env, user, verificationService) {
  try {
    const body = await request.json();
    const { verification_id, rejection_reason } = body;
    if (!verification_id) {
      return new Response(JSON.stringify({
        success: false,
        error: "verification_id is required"
      }), {
        status: 400,
        headers: { "Content-Type": "application/json" }
      });
    }
    if (!rejection_reason) {
      return new Response(JSON.stringify({
        success: false,
        error: "rejection_reason is required"
      }), {
        status: 400,
        headers: { "Content-Type": "application/json" }
      });
    }
    const result = await verificationService.rejectVerification(
      verification_id,
      user.id,
      rejection_reason
    );
    return new Response(JSON.stringify(result), {
      status: result.success ? 200 : 400,
      headers: { "Content-Type": "application/json" }
    });
  } catch (error) {
    console.error("[Business Verification API] Error rejecting verification:", error);
    throw error;
  }
}
async function handleGetVerificationDetails(request, env, user, verificationService, verificationId) {
  try {
    const verification = await verificationService.getVerification(verificationId);
    if (!verification) {
      return new Response(JSON.stringify({
        success: false,
        error: "Verification not found"
      }), {
        status: 404,
        headers: { "Content-Type": "application/json" }
      });
    }
    if (user.role !== "admin" && verification.user_id !== user.id) {
      return new Response(JSON.stringify({
        success: false,
        error: "Access denied"
      }), {
        status: 403,
        headers: { "Content-Type": "application/json" }
      });
    }
    return new Response(JSON.stringify({
      success: true,
      verification
    }), {
      headers: { "Content-Type": "application/json" }
    });
  } catch (error) {
    console.error("[Business Verification API] Error getting verification details:", error);
    throw error;
  }
}
async function handleBatchApproveVerifications(request, env, user, verificationService) {
  try {
    const body = await request.json();
    const { verification_ids, notes } = body;
    if (!Array.isArray(verification_ids) || verification_ids.length === 0) {
      return new Response(JSON.stringify({
        success: false,
        error: "\u8ACB\u9078\u64C7\u81F3\u5C11\u4E00\u500B\u9A57\u8B49\u7533\u8ACB"
      }), {
        status: 400,
        headers: { "Content-Type": "application/json" }
      });
    }
    const result = await verificationService.batchApproveVerifications(
      verification_ids,
      user.id,
      notes || null
    );
    return new Response(JSON.stringify(result), {
      status: result.success ? 200 : 400,
      headers: { "Content-Type": "application/json" }
    });
  } catch (error) {
    console.error("[Business Verification API] Error batch approving verifications:", error);
    return new Response(JSON.stringify({
      success: false,
      error: error.message || "Internal Server Error"
    }), {
      status: 500,
      headers: { "Content-Type": "application/json" }
    });
  }
}
async function handleBatchRejectVerifications(request, env, user, verificationService) {
  try {
    const body = await request.json();
    const { verification_ids, rejection_reason } = body;
    if (!Array.isArray(verification_ids) || verification_ids.length === 0) {
      return new Response(JSON.stringify({
        success: false,
        error: "\u8ACB\u9078\u64C7\u81F3\u5C11\u4E00\u500B\u9A57\u8B49\u7533\u8ACB"
      }), {
        status: 400,
        headers: { "Content-Type": "application/json" }
      });
    }
    if (!rejection_reason || !rejection_reason.trim()) {
      return new Response(JSON.stringify({
        success: false,
        error: "\u62D2\u7D55\u539F\u56E0\u4E0D\u80FD\u70BA\u7A7A"
      }), {
        status: 400,
        headers: { "Content-Type": "application/json" }
      });
    }
    const result = await verificationService.batchRejectVerifications(
      verification_ids,
      user.id,
      rejection_reason
    );
    return new Response(JSON.stringify(result), {
      status: result.success ? 200 : 400,
      headers: { "Content-Type": "application/json" }
    });
  } catch (error) {
    console.error("[Business Verification API] Error batch rejecting verifications:", error);
    return new Response(JSON.stringify({
      success: false,
      error: error.message || "Internal Server Error"
    }), {
      status: 500,
      headers: { "Content-Type": "application/json" }
    });
  }
}
var init_business_verification = __esm({
  "src/api/business-verification.js"() {
    "use strict";
    init_BusinessVerificationService();
    init_auth();
    init_cacheHelper();
  }
});

// src/api/ai-admin.js
var ai_admin_exports = {};
__export(ai_admin_exports, {
  handleAIAdminRequest: () => handleAIAdminRequest
});
async function handleAIAdminRequest(request, env, user) {
  if (!user || user.role !== "admin") {
    return new Response(JSON.stringify({ error: "Unauthorized" }), {
      status: 403,
      headers: { "Content-Type": "application/json" }
    });
  }
  const url = new URL(request.url);
  const path = url.pathname;
  try {
    if (path === "/api/ai/admin/statistics" && request.method === "GET") {
      const cachedHandler = withCache(handleStatistics, {
        cacheKey: "ai-admin",
        ttl: CACHE_TTL.MEDIUM,
        // 5 分鐘
        keyGenerator: () => "statistics"
      });
      return await cachedHandler(request, env);
    }
    if (path === "/api/ai/admin/conversations" && request.method === "GET") {
      return await handleConversations(request, env);
    }
    if (path === "/api/ai/admin/knowledge" && request.method === "GET") {
      return await handleGetKnowledge(request, env);
    }
    if (path === "/api/ai/admin/knowledge" && request.method === "POST") {
      return await handleAddKnowledge(request, env);
    }
    if (path.startsWith("/api/ai/admin/knowledge/") && request.method === "DELETE") {
      return await handleDeleteKnowledge(request, env);
    }
    if (path === "/api/ai/admin/feedback" && request.method === "GET") {
      return await handleFeedback(request, env);
    }
    if (path === "/api/ai/admin/analytics" && request.method === "GET") {
      return await handleAnalytics(request, env);
    }
    if (path === "/api/ai/admin/question-learning" && request.method === "GET") {
      return await handleQuestionLearning(request, env);
    }
    if (path === "/api/ai/admin/question-templates" && request.method === "GET") {
      return await handleQuestionTemplates(request, env);
    }
    if (path === "/api/ai/admin/question-templates/extract" && request.method === "POST") {
      return await handleExtractTemplates(request, env);
    }
    if (path === "/api/ai/admin/question-improvements" && request.method === "GET") {
      return await handleQuestionImprovements(request, env);
    }
    return new Response(JSON.stringify({ error: "API endpoint not found" }), {
      status: 404,
      headers: { "Content-Type": "application/json" }
    });
  } catch (error) {
    console.error("[AI Admin API] Error:", error);
    return new Response(JSON.stringify({
      error: "Internal server error",
      message: error.message
    }), {
      status: 500,
      headers: { "Content-Type": "application/json" }
    });
  }
}
async function handleStatistics(request, env) {
  try {
    const totalResult = await env.DB.prepare(
      "SELECT COUNT(*) as count FROM ai_conversations WHERE message_type = ?"
    ).bind("user").first();
    const totalConversations = (totalResult == null ? void 0 : totalResult.count) || 0;
    const todayResult = await env.DB.prepare(
      `SELECT COUNT(*) as count FROM ai_conversations 
       WHERE message_type = ? AND DATE(created_at) = DATE('now')`
    ).bind("user").first();
    const todayConversations = (todayResult == null ? void 0 : todayResult.count) || 0;
    const kbResult = await env.DB.prepare(
      "SELECT COUNT(*) as count FROM ai_knowledge_base"
    ).first();
    const knowledgeBaseCount = (kbResult == null ? void 0 : kbResult.count) || 0;
    const feedbackResult = await env.DB.prepare(
      "SELECT COUNT(*) as count FROM ai_feedback"
    ).first();
    const feedbackCount = (feedbackResult == null ? void 0 : feedbackResult.count) || 0;
    return new Response(JSON.stringify({
      success: true,
      totalConversations,
      todayConversations,
      knowledgeBaseCount,
      feedbackCount
    }), {
      status: 200,
      headers: { "Content-Type": "application/json" }
    });
  } catch (error) {
    console.error("[AI Admin] Error getting statistics:", error);
    throw error;
  }
}
async function handleConversations(request, env) {
  try {
    const url = new URL(request.url);
    const page = parseInt(url.searchParams.get("page") || "1");
    const pageSize = parseInt(url.searchParams.get("pageSize") || "20");
    const search = url.searchParams.get("search") || "";
    const filter = url.searchParams.get("filter") || "";
    let query = "SELECT * FROM ai_conversations WHERE 1=1";
    const params = [];
    if (search) {
      query += " AND message_content LIKE ?";
      params.push(`%${search}%`);
    }
    if (filter === "logged-in") {
      query += " AND user_id IS NOT NULL";
    } else if (filter === "anonymous") {
      query += " AND user_id IS NULL";
    }
    query += " ORDER BY created_at DESC LIMIT ? OFFSET ?";
    params.push(pageSize, (page - 1) * pageSize);
    const result = await env.DB.prepare(query).bind(...params).all();
    let countQuery = "SELECT COUNT(*) as count FROM ai_conversations WHERE 1=1";
    const countParams = [];
    if (search) {
      countQuery += " AND message_content LIKE ?";
      countParams.push(`%${search}%`);
    }
    if (filter === "logged-in") {
      countQuery += " AND user_id IS NOT NULL";
    } else if (filter === "anonymous") {
      countQuery += " AND user_id IS NULL";
    }
    const countResult = await env.DB.prepare(countQuery).bind(...countParams).first();
    const total = (countResult == null ? void 0 : countResult.count) || 0;
    return new Response(JSON.stringify({
      success: true,
      conversations: result.results || [],
      totalPages: Math.ceil(total / pageSize),
      currentPage: page
    }), {
      status: 200,
      headers: { "Content-Type": "application/json" }
    });
  } catch (error) {
    console.error("[AI Admin] Error getting conversations:", error);
    throw error;
  }
}
async function handleGetKnowledge(request, env) {
  try {
    const result = await env.DB.prepare(
      "SELECT * FROM ai_knowledge_base ORDER BY usage_count DESC, created_at DESC"
    ).all();
    return new Response(JSON.stringify({
      success: true,
      knowledge: result.results || []
    }), {
      status: 200,
      headers: { "Content-Type": "application/json" }
    });
  } catch (error) {
    console.error("[AI Admin] Error getting knowledge:", error);
    throw error;
  }
}
async function handleAddKnowledge(request, env) {
  try {
    const body = await request.json();
    const { question, answer } = body;
    if (!question || !answer) {
      return new Response(JSON.stringify({ error: "Question and answer are required" }), {
        status: 400,
        headers: { "Content-Type": "application/json" }
      });
    }
    await env.DB.prepare(
      `INSERT INTO ai_knowledge_base (question, answer, source_type, source_user_id)
       VALUES (?, ?, 'admin', NULL)`
    ).bind(question, answer).run();
    return new Response(JSON.stringify({
      success: true
    }), {
      status: 200,
      headers: { "Content-Type": "application/json" }
    });
  } catch (error) {
    console.error("[AI Admin] Error adding knowledge:", error);
    throw error;
  }
}
async function handleDeleteKnowledge(request, env) {
  try {
    const url = new URL(request.url);
    const id = url.pathname.split("/").pop();
    await env.DB.prepare(
      "DELETE FROM ai_knowledge_base WHERE id = ?"
    ).bind(id).run();
    return new Response(JSON.stringify({
      success: true
    }), {
      status: 200,
      headers: { "Content-Type": "application/json" }
    });
  } catch (error) {
    console.error("[AI Admin] Error deleting knowledge:", error);
    throw error;
  }
}
async function handleFeedback(request, env) {
  try {
    const result = await env.DB.prepare(
      "SELECT * FROM ai_feedback ORDER BY created_at DESC LIMIT 100"
    ).all();
    return new Response(JSON.stringify({
      success: true,
      feedback: result.results || []
    }), {
      status: 200,
      headers: { "Content-Type": "application/json" }
    });
  } catch (error) {
    console.error("[AI Admin] Error getting feedback:", error);
    throw error;
  }
}
async function handleAnalytics(request, env) {
  try {
    const popularQuestions = await env.DB.prepare(
      `SELECT message_content as question, COUNT(*) as count
       FROM ai_conversations
       WHERE message_type = 'user'
       GROUP BY message_content
       ORDER BY count DESC
       LIMIT 10`
    ).all();
    return new Response(JSON.stringify({
      success: true,
      popularQuestions: popularQuestions.results || []
    }), {
      status: 200,
      headers: { "Content-Type": "application/json" }
    });
  } catch (error) {
    console.error("[AI Admin] Error getting analytics:", error);
    throw error;
  }
}
async function handleQuestionLearning(request, env) {
  try {
    const url = new URL(request.url);
    const page = parseInt(url.searchParams.get("page") || "1");
    const pageSize = parseInt(url.searchParams.get("pageSize") || "20");
    const category = url.searchParams.get("category") || "";
    const questionType = url.searchParams.get("questionType") || "";
    let query = "SELECT * FROM ai_question_learning WHERE 1=1";
    const params = [];
    if (category) {
      query += " AND question_category = ?";
      params.push(category);
    }
    if (questionType) {
      query += " AND question_type = ?";
      params.push(questionType);
    }
    query += " ORDER BY created_at DESC LIMIT ? OFFSET ?";
    params.push(pageSize, (page - 1) * pageSize);
    const result = await env.DB.prepare(query).bind(...params).all();
    let countQuery = "SELECT COUNT(*) as count FROM ai_question_learning WHERE 1=1";
    const countParams = [];
    if (category) {
      countQuery += " AND question_category = ?";
      countParams.push(category);
    }
    if (questionType) {
      countQuery += " AND question_type = ?";
      countParams.push(questionType);
    }
    const countResult = await env.DB.prepare(countQuery).bind(...countParams).first();
    const total = (countResult == null ? void 0 : countResult.count) || 0;
    return new Response(JSON.stringify({
      success: true,
      learning: result.results || [],
      totalPages: Math.ceil(total / pageSize),
      currentPage: page
    }), {
      status: 200,
      headers: { "Content-Type": "application/json" }
    });
  } catch (error) {
    console.error("[AI Admin] Error getting question learning:", error);
    throw error;
  }
}
async function handleQuestionTemplates(request, env) {
  try {
    const url = new URL(request.url);
    const templateType = url.searchParams.get("templateType") || "";
    const contextType = url.searchParams.get("contextType") || "";
    let query = "SELECT * FROM ai_question_templates WHERE is_active = true";
    const params = [];
    if (templateType) {
      query += " AND template_type = ?";
      params.push(templateType);
    }
    if (contextType) {
      query += " AND (context_type = ? OR context_type IS NULL)";
      params.push(contextType);
    }
    query += " ORDER BY success_rate DESC, usage_count DESC";
    const result = await env.DB.prepare(query).bind(...params).all();
    return new Response(JSON.stringify({
      success: true,
      templates: result.results || []
    }), {
      status: 200,
      headers: { "Content-Type": "application/json" }
    });
  } catch (error) {
    console.error("[AI Admin] Error getting question templates:", error);
    throw error;
  }
}
async function handleExtractTemplates(request, env) {
  try {
    const body = await request.json();
    const minSuccessRate = parseFloat(body.minSuccessRate || "0.7");
    const minQualityScore = parseFloat(body.minQualityScore || "0.7");
    const questionAnalysisService = new QuestionAnalysisService(env.DB);
    const templates = await questionAnalysisService.extractQuestionTemplates(minSuccessRate, minQualityScore);
    return new Response(JSON.stringify({
      success: true,
      templates,
      count: templates.length
    }), {
      status: 200,
      headers: { "Content-Type": "application/json" }
    });
  } catch (error) {
    console.error("[AI Admin] Error extracting templates:", error);
    throw error;
  }
}
async function handleQuestionImprovements(request, env) {
  try {
    const url = new URL(request.url);
    const page = parseInt(url.searchParams.get("page") || "1");
    const pageSize = parseInt(url.searchParams.get("pageSize") || "20");
    const result = await env.DB.prepare(
      `SELECT * FROM ai_question_improvements 
       ORDER BY created_at DESC 
       LIMIT ? OFFSET ?`
    ).bind(pageSize, (page - 1) * pageSize).all();
    const countResult = await env.DB.prepare(
      "SELECT COUNT(*) as count FROM ai_question_improvements"
    ).first();
    const total = (countResult == null ? void 0 : countResult.count) || 0;
    return new Response(JSON.stringify({
      success: true,
      improvements: result.results || [],
      totalPages: Math.ceil(total / pageSize),
      currentPage: page
    }), {
      status: 200,
      headers: { "Content-Type": "application/json" }
    });
  } catch (error) {
    console.error("[AI Admin] Error getting question improvements:", error);
    throw error;
  }
}
var init_ai_admin = __esm({
  "src/api/ai-admin.js"() {
    "use strict";
    init_QuestionAnalysisService();
    init_cacheHelper();
  }
});

// src/templates/html.js
var html_exports = {};
__export(html_exports, {
  getAddPlacePageContent: () => getAddPlacePageContent,
  getAddPlacePageHtml: () => getAddPlacePageHtml,
  getAdminInvitationsPageHtml: () => getAdminInvitationsPageHtml,
  getClaimLocationPageHtml: () => getClaimLocationPageHtml,
  getGoogleInfoContent: () => getGoogleInfoContent,
  getGoogleInfoPageHtml: () => getGoogleInfoPageHtml,
  getHomePageContent: () => getHomePageContent,
  getHomePageHtml: () => getHomePageHtml,
  getProfilePageContent: () => getProfilePageContent,
  getProfilePageHtml: () => getProfilePageHtml
});
function translatePlaceTypes2(typesArray) {
  if (!typesArray || typesArray.length === 0)
    return "-";
  const translatedTypes = typesArray.map((type) => placeTypeTranslations[type] || null).filter((translated) => translated !== null && translated !== "\u5834\u6240");
  return translatedTypes.length > 0 ? translatedTypes.join(", ") : "\u5176\u4ED6";
}
function createImageWithFallback2(src, alt, className, locationName) {
  const defaultImage = "https://placehold.co/400x268/6B7280/FFFFFF?text=Location+Image";
  const imageId = `img-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
  const containerId = `img-container-${imageId}`;
  if (!src || src === "null" || src === "undefined") {
    return `<div id="${containerId}" class="image-loader-container">
            <img 
                id="${imageId}"
                src="${defaultImage}" 
                alt="${alt || "\u5730\u9EDE\u7167\u7247"}" 
                class="${className}" 
                style="opacity: 1; transition: opacity 0.3s ease-in-out;"
            >
        </div>`;
  }
  if (src.includes("placehold.co")) {
    return `<div id="${containerId}" class="image-loader-container">
            <img 
                id="${imageId}"
                src="${src}" 
                alt="${alt || "\u5730\u9EDE\u7167\u7247"}" 
                class="${className}" 
                style="opacity: 1; transition: opacity 0.3s ease-in-out;"
            >
        </div>`;
  }
  return `
        <div id="${containerId}" class="image-loader-container relative">
            <!-- \u9AA8\u67B6\u5C4F -->
            <div class="image-skeleton absolute inset-0 bg-gray-200 animate-pulse rounded">
                <div class="w-full h-full bg-gradient-to-r from-gray-200 via-gray-300 to-gray-200 bg-[length:200%_100%] animate-shimmer"></div>
            </div>
            <!-- \u8F09\u5165\u9032\u5EA6\u6307\u793A\u5668 -->
            <div class="image-progress absolute inset-0 flex items-center justify-center bg-gray-100 bg-opacity-50">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
            </div>
            <!-- \u5716\u7247 -->
            <img 
                id="${imageId}"
                src="${src}" 
                alt="${alt || "\u5730\u9EDE\u7167\u7247"}" 
                class="${className} image-loader-img"
                style="opacity: 0; transition: opacity 0.3s ease-in-out; position: relative; z-index: 1;"
                onerror="window.handleImageError && window.handleImageError('${imageId}', '${containerId}', '${defaultImage}')"
                onload="window.handleImageLoad && window.handleImageLoad('${imageId}', '${containerId}')"
                loading="lazy"
            >
            <!-- \u932F\u8AA4\u8A0A\u606F -->
            <div id="error-${imageId}" class="image-error-message hidden absolute inset-0 flex flex-col items-center justify-center bg-gray-50 z-10">
                <svg class="w-6 h-6 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <p class="text-xs text-gray-500 mt-1">\u5716\u7247\u8F09\u5165\u5931\u6557</p>
            </div>
        </div>
    `;
}
function getHomePageContent(locations = [], userLocationCounts = null, locationInteractionCounts = {}, userLocationStatuses = {}) {
  const content = `
    <div class="w-full h-full relative overflow-hidden">
        <div class="w-full h-full overflow-y-auto pb-20">
            <div class="w-full px-2 py-4">
                <h1 class="text-2xl font-bold text-gray-800 mb-4 px-2">\u6211\u7684\u5730\u9EDE</h1>
            </div>
        </div>
    </div>
  `;
  return content;
}
function renderLocationGrid(locations, category, userLocationStatuses, locationInteractionCounts) {
  if (locations.length === 0) {
    return `
      <div class="text-center py-12">
        <div class="text-gray-400 mb-4">
          <svg class="mx-auto h-12 w-12" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
          </svg>
        </div>
        <h3 class="text-lg font-medium text-gray-900 mb-2">\u9084\u6C92\u6709${getCategoryName2(category)}\u7684\u5730\u9EDE</h3>
        <p class="text-gray-500 mb-6">\u958B\u59CB\u63A2\u7D22\u4E26\u8A18\u9304\u60A8\u7684\u5730\u9EDE\u5427\uFF01</p>
        <a href="/" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700">
          <svg class="mr-2 h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
          </svg>
          \u700F\u89BD\u5730\u9EDE
        </a>
      </div>
    `;
  }
  return `
    <!-- \u5C0F\u7D05\u66F8\u98A8\u683C\u7011\u5E03\u6D41\u4F48\u5C40 -->
    <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-2 md:gap-3 lg:gap-4">
      ${locations.map((loc) => {
    let typesArray = [];
    try {
      if (loc.google_types) {
        typesArray = JSON.parse(loc.google_types);
      }
    } catch (e) {
      console.error("Error parsing google_types JSON:", e, loc.google_types);
    }
    const displayTypes = translatePlaceTypes2(typesArray);
    const userStatus = userLocationStatuses[loc.id] || null;
    const locationCounts = locationInteractionCounts[loc.id] || { visited: 0, want_to_visit: 0, want_to_revisit: 0 };
    const visitedCount = locationCounts.visited || 0;
    const wantToVisitCount = locationCounts.want_to_visit || 0;
    const wantToRevisitCount = locationCounts.want_to_revisit || 0;
    const visitedButtonClass = userStatus === "visited" ? "bg-green-500 text-white" : "bg-gray-200 text-gray-700 hover:bg-green-100";
    const wantToVisitButtonClass = userStatus === "want_to_visit" ? "bg-blue-500 text-white" : "bg-gray-200 text-gray-700 hover:bg-blue-100";
    const wantToRevisitButtonClass = userStatus === "want_to_revisit" ? "bg-purple-500 text-white" : "bg-gray-200 text-gray-700 hover:bg-purple-100";
    return `
        <!-- \u5C0F\u7D05\u66F8\u98A8\u683C\u5361\u7247 -->
        <div class="location-card bg-white rounded-lg shadow-sm overflow-hidden border border-gray-100 flex flex-col hover:shadow-md transition-shadow duration-200 cursor-pointer" data-location-id="${loc.id}">
          <!-- \u5716\u7247\u5340\u57DF - \u76F4\u5C4F\u6BD4\u4F8B -->
          <div class="relative aspect-[3/4] overflow-hidden">
            ${createImageWithFallback2(
      loc.thumbnail_url || "https://placehold.co/400x533/png?text=No+Image",
      loc.name || "\u5730\u9EDE\u7167\u7247",
      "w-full h-full object-cover",
      loc.name || "\u672A\u547D\u540D\u5730\u9EDE"
    )}
            <!-- \u985E\u578B\u6A19\u7C64 -->
            <div class="absolute top-2 left-2 bg-black bg-opacity-50 text-white text-xs px-2 py-1 rounded-full">
              ${displayTypes.split(",")[0] || "\u666F\u9EDE"}
            </div>
          </div>
          
          <!-- \u5167\u5BB9\u5340\u57DF -->
          <div class="p-3 flex-grow flex flex-col">
            <!-- \u6A19\u984C\u548C\u5730\u5740 -->
            <h3 class="text-sm font-semibold mb-1 line-clamp-2 leading-tight" title="${loc.name || "\u672A\u547D\u540D\u5730\u9EDE"}">${loc.name || "\u672A\u547D\u540D\u5730\u9EDE"}</h3>
            <p class="text-xs text-gray-500 mb-2 line-clamp-1" title="${loc.address || "\u7121\u5730\u5740\u8CC7\u8A0A"}">${loc.address || "\u7121\u5730\u5740\u8CC7\u8A0A"}</p>
            
            <!-- \u7C21\u4ECB\uFF08\u5982\u679C\u6709\u7684\u8A71\uFF09 -->
            ${loc.editorial_summary ? `<p class="text-xs text-gray-600 mb-2 line-clamp-2 leading-tight" title="${loc.editorial_summary}">${loc.editorial_summary}</p>` : ""}
            
            <!-- \u4E92\u52D5\u6309\u9215 - \u5C0F\u7D05\u66F8\u98A8\u683C -->
            <div class="mt-auto pt-2">
              <div class="flex flex-wrap gap-1">
                <button 
                  onclick='event.stopPropagation(); updateLocationStatus("${loc.id}", "visited", event)'
                  class="flex items-center space-x-1 px-2 py-1 rounded-full text-xs transition-colors ${visitedButtonClass}"
                >
                  <span>\u4F86\u904E</span>
                  <span>${visitedCount}</span>
                </button>
                <button 
                  onclick='event.stopPropagation(); updateLocationStatus("${loc.id}", "want_to_visit", event)'
                  class="flex items-center space-x-1 px-2 py-1 rounded-full text-xs transition-colors ${wantToVisitButtonClass}"
                >
                  <span>\u60F3\u4F86</span>
                  <span>${wantToVisitCount}</span>
                </button>
                <button 
                  onclick='event.stopPropagation(); updateLocationStatus("${loc.id}", "want_to_revisit", event)'
                  class="flex items-center space-x-1 px-2 py-1 rounded-full text-xs transition-colors ${wantToRevisitButtonClass}"
                >
                  <span>\u60F3\u518D\u4F86</span>
                  <span>${wantToRevisitCount}</span>
                </button>
              </div>
            </div>
          </div>
        </div>
        `;
  }).join("")}
    </div>
  `;
}
function getCategoryName2(category) {
  const categoryNames = {
    "visited": "\u4F86\u904E",
    "want_to_visit": "\u60F3\u4F86",
    "want_to_revisit": "\u60F3\u518D\u4F86",
    "created": "\u5EFA\u7ACB",
    "all": "\u6240\u6709"
  };
  return categoryNames[category] || category;
}
function getGoogleInfoContent(user) {
  const userName = user ? user.name || user.email : "Guest";
  return `
    <div class="text-center bg-white p-8 rounded shadow-md">
        <h1 class="text-2xl font-semibold text-green-600 mb-4">Google Login Successful!</h1>
        <p class="mb-4">Welcome, ${userName}!</p>
        <p class="mb-6 text-gray-600">You have been successfully authenticated.</p>
        <a href="/" class="text-blue-500 hover:underline">Go back home</a>
    </div>
   `;
}
function getProfilePageContent(user, locations = [], userLocationCounts = null, locationInteractionCounts = {}, userLocationStatuses = {}) {
  if (!user)
    return `<p>Error: User data is missing.</p>`;
  const displayName = user.name ? String(user.name).replace(/</g, "&lt;").replace(/>/g, "&gt;") : "N/A";
  const displayEmail = user.email ? String(user.email).replace(/</g, "&lt;").replace(/>/g, "&gt;") : "N/A";
  const avatarUrl = user.avatar_url ? String(user.avatar_url) : "";
  const visitedLocations = locations.filter((loc) => userLocationStatuses[loc.id] === "visited");
  const wantToVisitLocations = locations.filter((loc) => userLocationStatuses[loc.id] === "want_to_visit");
  const wantToRevisitLocations = locations.filter((loc) => userLocationStatuses[loc.id] === "want_to_revisit");
  const createdCount = userLocationCounts ? userLocationCounts.created || 0 : 0;
  const createdLocations = locations.filter((loc) => loc.created_by_user_id === user.id);
  const content = `
    <div class="max-w-6xl mx-auto px-4 py-8">
      <!-- \u7528\u6236\u8CC7\u8A0A\u5340\u57DF -->
      <div class="bg-white rounded-lg shadow-md p-6 mb-8">
        <div class="flex items-center space-x-4">
          ${avatarUrl ? `<img src="${avatarUrl}" alt="User Avatar" class="w-16 h-16 rounded-full object-cover">` : `<span class="w-16 h-16 rounded-full bg-blue-500 flex items-center justify-center text-2xl font-semibold text-white">${displayName.charAt(0).toUpperCase()}</span>`}
          <div>
            <h1 class="text-2xl font-bold text-gray-900">${displayName || "\u4F7F\u7528\u8005"}</h1>
            <p class="text-gray-600">${displayEmail || "\u96FB\u5B50\u90F5\u4EF6\u672A\u63D0\u4F9B"}</p>
            <div class="flex space-x-4 mt-2 text-sm text-gray-500">
              <span>\u4F86\u904E: ${visitedLocations.length}</span>
              <span>\u60F3\u4F86: ${wantToVisitLocations.length}</span>
              <span>\u60F3\u518D\u4F86: ${wantToRevisitLocations.length}</span>
              <span>\u6211\u5EFA\u7ACB: ${createdCount}</span>
            </div>
          </div>
        </div>
      </div>

      <!-- \u6211\u7684\u5730\u9EDE\u5206\u985E\u6A19\u7C64 -->
      <div class="bg-white rounded-lg shadow-md p-6 mb-8">
        <h2 class="text-xl font-semibold mb-4">\u6211\u7684\u5730\u9EDE</h2>
        <div class="flex flex-wrap gap-2 mb-6">
          <button onclick='showLocationCategory("visited")' class="location-tab active px-4 py-2 rounded-full bg-blue-500 text-white text-sm font-medium transition-colors">
            \u4F86\u904E (${visitedLocations.length})
          </button>
          <button onclick='showLocationCategory("want_to_visit")' class="location-tab px-4 py-2 rounded-full bg-gray-200 text-gray-700 text-sm font-medium transition-colors">
            \u60F3\u4F86 (${wantToVisitLocations.length})
          </button>
          <button onclick='showLocationCategory("want_to_revisit")' class="location-tab px-4 py-2 rounded-full bg-gray-200 text-gray-700 text-sm font-medium transition-colors">
            \u60F3\u518D\u4F86 (${wantToRevisitLocations.length})
          </button>
          <button onclick='showLocationCategory("created")' class="location-tab px-4 py-2 rounded-full bg-gray-200 text-gray-700 text-sm font-medium transition-colors">
            \u6211\u5EFA\u7ACB (${createdCount})
          </button>
        </div>

        <!-- \u4F86\u904E\u7684\u5730\u9EDE -->
        <div id="visited-locations" class="location-category">
          ${renderLocationGrid(visitedLocations, "visited", userLocationStatuses, locationInteractionCounts)}
        </div>

        <!-- \u60F3\u4F86\u7684\u5730\u9EDE -->
        <div id="want_to_visit-locations" class="location-category" style="display: none;">
          ${renderLocationGrid(wantToVisitLocations, "want_to_visit", userLocationStatuses, locationInteractionCounts)}
        </div>

        <!-- \u60F3\u518D\u4F86\u7684\u5730\u9EDE -->
        <div id="want_to_revisit-locations" class="location-category" style="display: none;">
          ${renderLocationGrid(wantToRevisitLocations, "want_to_revisit", userLocationStatuses, locationInteractionCounts)}
        </div>

        <!-- \u6211\u5EFA\u7ACB\u7684\u5730\u9EDE -->
        <div id="created-locations" class="location-category" style="display: none;">
          ${renderLocationGrid(createdLocations, "created", userLocationStatuses, locationInteractionCounts)}
        </div>
      </div>
    </div>
    
    <!-- \u5730\u9EDE\u8A73\u60C5\u5074\u908A\u6B04 - \u684C\u6A5F\u7248 -->
    <div id="location-detail-sidebar" class="fixed top-0 right-0 w-1/4 h-full bg-white shadow-lg transform translate-x-full transition-transform duration-300 ease-in-out z-50 hidden lg:block">
      <div id="location-detail-content" class="h-full overflow-y-auto">
        <!-- \u5730\u9EDE\u8A73\u60C5\u5167\u5BB9\u5C07\u5728\u9019\u88E1\u52D5\u614B\u63D2\u5165 -->
      </div>
    </div>
    
    <!-- \u5730\u9EDE\u8A73\u60C5\u6A21\u614B\u6846 - \u624B\u6A5F\u7248 -->
    <div id="location-detail-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden lg:hidden">
      <div class="w-full h-full bg-white transform translate-y-full transition-transform duration-300 ease-in-out">
        <div class="flex items-center p-4 border-b border-gray-200">
          <button id="close-location-detail" class="flex items-center text-gray-600 hover:text-gray-800">
            <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
            </svg>
            <span>\u8FD4\u56DE</span>
          </button>
        </div>
        <div id="location-detail-modal-content" class="h-full overflow-y-auto">
          <!-- \u5730\u9EDE\u8A73\u60C5\u5167\u5BB9\u5C07\u5728\u9019\u88E1\u52D5\u614B\u63D2\u5165 -->
        </div>
      </div>
    </div>
    
    <!-- \u906E\u7F69\u5C64 - \u684C\u6A5F\u7248\u9EDE\u64CA\u95DC\u9589 -->
    <div id="location-detail-overlay" class="fixed inset-0 bg-black bg-opacity-25 z-40 hidden lg:block" style="display: none;"></div>

    <script>
      // \u5730\u9EDE\u985E\u578B\u7FFB\u8B6F\u5C0D\u8C61
      const placeTypeTranslations = {
        'accounting': '\u6703\u8A08',
        'airport': '\u6A5F\u5834',
        'amusement_park': '\u904A\u6A02\u5712',
        'aquarium': '\u6C34\u65CF\u9928',
        'art_gallery': '\u85DD\u5ECA',
        'atm': 'ATM',
        'bakery': '\u9EB5\u5305\u5E97',
        'bank': '\u9280\u884C',
        'bar': '\u9152\u5427',
        'beauty_salon': '\u7F8E\u5BB9\u9662',
        'bicycle_store': '\u8173\u8E0F\u8ECA\u5E97',
        'book_store': '\u66F8\u5E97',
        'bowling_alley': '\u4FDD\u9F61\u7403\u9928',
        'bus_station': '\u516C\u8ECA\u7AD9',
        'cafe': '\u5496\u5561\u5EF3',
        'car_dealer': '\u6C7D\u8ECA\u7D93\u92B7\u5546',
        'car_rental': '\u79DF\u8ECA',
        'car_repair': '\u6C7D\u8ECA\u7DAD\u4FEE',
        'car_wash': '\u6D17\u8ECA',
        'casino': '\u8CED\u5834',
        'cemetery': '\u5893\u5712',
        'church': '\u6559\u5802',
        'city_hall': '\u5E02\u653F\u5E9C',
        'clothing_store': '\u670D\u98FE\u5E97',
        'convenience_store': '\u4FBF\u5229\u5546\u5E97',
        'courthouse': '\u6CD5\u9662',
        'dentist': '\u7259\u91AB',
        'department_store': '\u767E\u8CA8\u516C\u53F8',
        'doctor': '\u91AB\u751F',
        'drugstore': '\u85E5\u5C40',
        'electrician': '\u96FB\u5DE5',
        'electronics_store': '\u96FB\u5B50\u7528\u54C1\u5E97',
        'embassy': '\u5927\u4F7F\u9928',
        'fire_station': '\u6D88\u9632\u5C40',
        'florist': '\u82B1\u5E97',
        'funeral_home': '\u6BAF\u5100\u9928',
        'furniture_store': '\u5BB6\u5177\u5E97',
        'gas_station': '\u52A0\u6CB9\u7AD9',
        'gym': '\u5065\u8EAB\u623F',
        'hair_care': '\u7F8E\u9AEE',
        'hardware_store': '\u4E94\u91D1\u884C',
        'hindu_temple': '\u5370\u5EA6\u5EDF',
        'home_goods_store': '\u5BB6\u5C45\u7528\u54C1\u5E97',
        'hospital': '\u91AB\u9662',
        'insurance_agency': '\u4FDD\u96AA\u516C\u53F8',
        'jewelry_store': '\u73E0\u5BF6\u5E97',
        'laundry': '\u6D17\u8863\u5E97',
        'lawyer': '\u5F8B\u5E2B',
        'library': '\u5716\u66F8\u9928',
        'light_rail_station': '\u8F15\u8ECC\u7AD9',
        'liquor_store': '\u9152\u985E\u5C08\u8CE3\u5E97',
        'local_government_office': '\u653F\u5E9C\u6A5F\u95DC',
        'locksmith': '\u9396\u5320',
        'lodging': '\u4F4F\u5BBF',
        'meal_delivery': '\u5916\u9001',
        'meal_takeaway': '\u5916\u5E36',
        'mosque': '\u6E05\u771F\u5BFA',
        'movie_rental': '\u5F71\u7247\u51FA\u79DF',
        'movie_theater': '\u96FB\u5F71\u9662',
        'moving_company': '\u642C\u5BB6\u516C\u53F8',
        'museum': '\u535A\u7269\u9928',
        'night_club': '\u591C\u5E97',
        'painter': '\u6CB9\u6F06\u5DE5',
        'park': '\u516C\u5712',
        'parking': '\u505C\u8ECA\u5834',
        'pet_store': '\u5BF5\u7269\u5E97',
        'pharmacy': '\u85E5\u623F',
        'physiotherapist': '\u7269\u7406\u6CBB\u7642\u5E2B',
        'plumber': '\u6C34\u96FB\u5DE5',
        'police': '\u8B66\u5BDF\u5C40',
        'post_office': '\u90F5\u5C40',
        'primary_school': '\u5C0F\u5B78',
        'real_estate_agency': '\u623F\u5730\u7522\u516C\u53F8',
        'restaurant': '\u9910\u5EF3',
        'roofing_contractor': '\u5C4B\u9802\u627F\u5305\u5546',
        'rv_park': '\u9732\u71DF\u8ECA\u516C\u5712',
        'school': '\u5B78\u6821',
        'secondary_school': '\u4E2D\u5B78',
        'shoe_store': '\u978B\u5E97',
        'shopping_mall': '\u8CFC\u7269\u4E2D\u5FC3',
        'spa': 'SPA',
        'stadium': '\u9AD4\u80B2\u5834',
        'storage': '\u5009\u5132',
        'store': '\u5546\u5E97',
        'subway_station': '\u5730\u9435\u7AD9',
        'supermarket': '\u8D85\u5E02',
        'synagogue': '\u7336\u592A\u6559\u5802',
        'taxi_stand': '\u8A08\u7A0B\u8ECA\u7AD9',
        'tourist_attraction': '\u89C0\u5149\u666F\u9EDE',
        'train_station': '\u706B\u8ECA\u7AD9',
        'transit_station': '\u5927\u773E\u904B\u8F38\u7AD9',
        'travel_agency': '\u65C5\u884C\u793E',
        'university': '\u5927\u5B78',
        'veterinary_care': '\u7378\u91AB',
        'zoo': '\u52D5\u7269\u5712',
        'point_of_interest': '\u666F\u9EDE',
        'establishment': '\u5834\u6240'
      };

      // \u5730\u9EDE\u985E\u578B\u7FFB\u8B6F\u51FD\u6578
      function translatePlaceTypes(typesArray) {
        if (!typesArray || typesArray.length === 0) return '-';

        const translatedTypes = typesArray
          .map(type => placeTypeTranslations[type] || null) 
          .filter(translated => translated !== null && translated !== '\u5834\u6240');

        return translatedTypes.length > 0 ? translatedTypes.join(', ') : '\u5176\u4ED6'; 
      }

      // \u5206\u985E\u6A19\u7C64\u5207\u63DB\u529F\u80FD
      function showLocationCategory(category) {
        // \u96B1\u85CF\u6240\u6709\u5206\u985E
        const categories = ['visited', 'want_to_visit', 'want_to_revisit', 'created'];
        categories.forEach(cat => {
          const element = document.getElementById(cat + '-locations');
          if (element) element.style.display = 'none';
        });
        
        // \u986F\u793A\u9078\u4E2D\u7684\u5206\u985E
        const selectedElement = document.getElementById(category + '-locations');
        if (selectedElement) selectedElement.style.display = 'block';
        
        // \u66F4\u65B0\u6A19\u7C64\u6A23\u5F0F
        const tabs = document.querySelectorAll('.location-tab');
        tabs.forEach(tab => {
          tab.classList.remove('active', 'bg-blue-500', 'text-white');
          tab.classList.add('bg-gray-200', 'text-gray-700');
        });
        
        // \u6FC0\u6D3B\u9078\u4E2D\u7684\u6A19\u7C64
        const activeTab = event.target;
        activeTab.classList.remove('bg-gray-200', 'text-gray-700');
        activeTab.classList.add('active', 'bg-blue-500', 'text-white');
        
        // \u91CD\u65B0\u6DFB\u52A0\u5730\u9EDE\u5361\u7247\u9EDE\u64CA\u4E8B\u4EF6
        setTimeout(() => {
          addLocationCardListeners();
        }, 100);
      }

      // \u66F4\u65B0\u5730\u9EDE\u72C0\u614B
      function updateLocationStatus(locationId, newStatus) {
        fetch('/api/location/status', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            locationId: locationId,
            status: newStatus
          })
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            // \u66F4\u65B0\u6309\u9215\u72C0\u614B
            const button = event.target.closest('button');
            if (button) {
              // \u91CD\u7F6E\u6240\u6709\u6309\u9215
              const allButtons = button.parentElement.querySelectorAll('button');
              allButtons.forEach(btn => {
                btn.classList.remove('bg-green-500', 'bg-blue-500', 'bg-purple-500', 'text-white');
                btn.classList.add('bg-gray-200', 'text-gray-700');
              });
              
              // \u6FC0\u6D3B\u9078\u4E2D\u7684\u6309\u9215
              button.classList.remove('bg-gray-200', 'text-gray-700');
              if (newStatus === 'visited') {
                button.classList.add('bg-green-500', 'text-white');
              } else if (newStatus === 'want_to_visit') {
                button.classList.add('bg-blue-500', 'text-white');
              } else if (newStatus === 'want_to_revisit') {
                button.classList.add('bg-purple-500', 'text-white');
              }
            }
            
            // \u66F4\u65B0\u7D71\u8A08\u6578\u5B57
            updateLocationInteractionCounts(locationId);
            
            // \u91CD\u65B0\u8F09\u5165\u9801\u9762\u4EE5\u66F4\u65B0\u5206\u985E\u7D71\u8A08
            setTimeout(() => {
              location.reload();
            }, 500);
          } else {
            alert('\u66F4\u65B0\u5931\u6557: ' + data.error);
          }
        })
        .catch(error => {
          console.error('Error:', error);
          alert('\u66F4\u65B0\u5931\u6557\uFF0C\u8ACB\u7A0D\u5F8C\u518D\u8A66');
        });
      }
      
      // \u66F4\u65B0\u7279\u5B9A\u5730\u9EDE\u5361\u7247\u7684\u7D71\u8A08\u6578\u5B57\u986F\u793A
      async function updateLocationInteractionCounts(locationId, event) {
        try {
          const response = await fetch('/api/location/' + locationId + '/interaction-counts');
          if (response.ok) {
            const counts = await response.json();
            
            // \u66F4\u65B0\u672C\u5730\u6578\u64DA
            locationInteractionCountsData[locationId] = counts;
            
            // \u627E\u5230\u7576\u524D\u5730\u9EDE\u5361\u7247\u7684\u6240\u6709\u6309\u9215
            const locationCard = event ? event.target.closest('.location-card') : null;
            if (locationCard) {
              const visitedButton = locationCard.querySelector('button[onclick*="visited"]');
              const wantToVisitButton = locationCard.querySelector('button[onclick*="want_to_visit"]');
              const wantToRevisitButton = locationCard.querySelector('button[onclick*="want_to_revisit"]');
              
              if (visitedButton) {
                const span = visitedButton.querySelector('span:last-child');
                if (span) {
                  span.textContent = '(' + (counts.visited || 0) + ')';
                }
              }
              
              if (wantToVisitButton) {
                const span = wantToVisitButton.querySelector('span:last-child');
                if (span) {
                  span.textContent = '(' + (counts.want_to_visit || 0) + ')';
                }
              }
              
              if (wantToRevisitButton) {
                const span = wantToRevisitButton.querySelector('span:last-child');
                if (span) {
                  span.textContent = '(' + (counts.want_to_revisit || 0) + ')';
                }
              }
            }
          }
        } catch (error) {
          console.error('Error updating location interaction counts:', error);
        }
      }
      
      // \u5730\u9EDE\u8A73\u60C5\u7BA1\u7406
      let currentLocationDetail = null;
      
      // \u7372\u53D6\u5730\u9EDE\u6578\u64DA\uFF08\u5F9E\u670D\u52D9\u5668\u7372\u53D6\uFF09
      async function getLocationById(locationId) {
        try {
          const response = await fetch('/api/locations/' + locationId + '/details');
          if (response.ok) {
            return await response.json();
          } else {
            console.error('Failed to fetch location details:', response.status);
            return null;
          }
        } catch (error) {
          console.error('Error fetching location details:', error);
          return null;
        }
      }
      
      // \u986F\u793A\u5730\u9EDE\u8A73\u60C5
      async function showLocationDetail(locationId) {
        // \u7372\u53D6\u5730\u9EDE\u6578\u64DA
        const location = await getLocationById(locationId);
        if (!location) {
          alert('\u7121\u6CD5\u7372\u53D6\u5730\u9EDE\u8A73\u60C5\uFF0C\u8ACB\u7A0D\u5F8C\u518D\u8A66');
          return;
        }
        
        currentLocationDetail = location;
        
        // \u684C\u6A5F\u7248\uFF1A\u986F\u793A\u5074\u908A\u6B04
        if (window.innerWidth >= 1024) {
          const sidebar = document.getElementById('location-detail-sidebar');
          const overlay = document.getElementById('location-detail-overlay');
          const content = document.getElementById('location-detail-content');
          
          content.innerHTML = generateLocationDetailHtml(location);
          sidebar.classList.remove('translate-x-full');
          overlay.style.display = 'block';
          
          // \u9EDE\u64CA\u906E\u7F69\u95DC\u9589
          overlay.onclick = hideLocationDetail;
        } else {
          // \u624B\u6A5F\u7248\uFF1A\u986F\u793A\u6A21\u614B\u6846
          const modal = document.getElementById('location-detail-modal');
          const modalContent = document.getElementById('location-detail-modal-content');
          
          modalContent.innerHTML = generateLocationDetailHtml(location);
          modal.classList.remove('hidden');
          
          // \u52D5\u756B\u986F\u793A
          setTimeout(() => {
            const modalInner = modal.querySelector('.bg-white');
            modalInner.classList.remove('translate-y-full');
          }, 10);
        }
      }
      
      // \u96B1\u85CF\u5730\u9EDE\u8A73\u60C5
      function hideLocationDetail() {
        currentLocationDetail = null;
        
        // \u684C\u6A5F\u7248\uFF1A\u96B1\u85CF\u5074\u908A\u6B04
        if (window.innerWidth >= 1024) {
          const sidebar = document.getElementById('location-detail-sidebar');
          const overlay = document.getElementById('location-detail-overlay');
          
          sidebar.classList.add('translate-x-full');
          overlay.style.display = 'none';
        } else {
          // \u624B\u6A5F\u7248\uFF1A\u96B1\u85CF\u6A21\u614B\u6846
          const modal = document.getElementById('location-detail-modal');
          const modalInner = modal.querySelector('.bg-white');
          
          modalInner.classList.add('translate-y-full');
          setTimeout(() => {
            modal.classList.add('hidden');
          }, 300);
        }
      }
      
      // \u751F\u6210\u5730\u9EDE\u8A73\u60C5 HTML
      function generateLocationDetailHtml(location) {
        // Parse google_types JSON string
        let typesArray = [];
        try {
          if (location.google_types) {
            typesArray = JSON.parse(location.google_types);
          }
        } catch (e) {
          console.error('Error parsing google_types JSON:', e, location.google_types);
        }
        const displayTypes = translatePlaceTypes(typesArray);
        
        // \u7372\u53D6\u7528\u6236\u72C0\u614B\u548C\u4E92\u52D5\u7D71\u8A08
        const userStatus = location.userStatus || null;
        const interactionCounts = location.interactionCounts || { visited: 0, want_to_visit: 0, want_to_revisit: 0 };
        
        // \u78BA\u5B9A\u6309\u9215\u6A23\u5F0F
        const getButtonClass = (status, currentStatus) => {
          if (currentStatus === status) {
            if (status === 'visited') return 'bg-green-500 text-white';
            if (status === 'want_to_visit') return 'bg-blue-500 text-white';
            if (status === 'want_to_revisit') return 'bg-purple-500 text-white';
          }
          return 'bg-gray-200 text-gray-700 hover:bg-gray-100';
        };
        
        const imgSrc = location.thumbnail_url || 'https://placehold.co/600x450/png?text=No+Image';
        const imgAlt = location.name || '\u5730\u9EDE\u7167\u7247';
        const locationName = location.name || '\u672A\u547D\u540D\u5730\u9EDE';
        const locationAddress = location.address || '\u7121\u5730\u5740\u8CC7\u8A0A';
        const firstType = displayTypes.split(',')[0] || '\u666F\u9EDE';
        const visitedClass = getButtonClass('visited', userStatus);
        const wantToVisitClass = getButtonClass('want_to_visit', userStatus);
        const wantToRevisitClass = getButtonClass('want_to_revisit', userStatus);
        const visitedCount = interactionCounts.visited || 0;
        const wantToVisitCount = interactionCounts.want_to_visit || 0;
        const wantToRevisitCount = interactionCounts.want_to_revisit || 0;
        const summaryHtml = location.editorial_summary ? 
          '<div class="mb-6"><h3 class="text-lg font-semibold text-gray-900 mb-2">\u7C21\u4ECB</h3><p class="text-gray-700 leading-relaxed">' + 
          location.editorial_summary.replace(/</g, '&lt;').replace(/>/g, '&gt;') + 
          '</p></div>' : '';
        
        return '<div class="p-6">' +
          '<!-- \u5730\u9EDE\u5716\u7247 -->' +
          '<div class="relative aspect-[4/3] overflow-hidden rounded-lg mb-6">' +
          '<img src="' + imgSrc + '" alt="' + imgAlt + '" class="w-full h-full object-cover" ' +
          'onerror="this.src='https://placehold.co/600x450/png?text=No+Image'">' +
          '<!-- \u985E\u578B\u6A19\u7C64 -->' +
          '<div class="absolute top-4 left-4 bg-black bg-opacity-50 text-white text-sm px-3 py-1 rounded-full">' +
          firstType + '</div></div>' +
          '<!-- \u5730\u9EDE\u6A19\u984C -->' +
          '<h2 class="text-2xl font-bold text-gray-900 mb-2">' + locationName.replace(/</g, '&lt;').replace(/>/g, '&gt;') + '</h2>' +
          '<!-- \u5730\u5740 -->' +
          '<p class="text-gray-600 mb-4">\u{1F4CD} ' + locationAddress.replace(/</g, '&lt;').replace(/>/g, '&gt;') + '</p>' +
          '<!-- \u985E\u578B -->' +
          '<p class="text-sm text-gray-500 mb-4">\u985E\u578B: ' + displayTypes + '</p>' +
          '<!-- \u7C21\u4ECB -->' + summaryHtml +
          '<!-- \u4E92\u52D5\u6309\u9215 -->' +
          '<div class="border-t border-gray-200 pt-6">' +
          '<h3 class="text-lg font-semibold text-gray-900 mb-4">\u60A8\u7684\u72C0\u614B</h3>' +
          '<div class="flex flex-wrap gap-3">' +
          '<button onclick='updateLocationStatus("' + location.id + '", "visited")' ' +
          'class="flex items-center space-x-2 px-4 py-2 rounded-full text-sm transition-colors ' + visitedClass + '">' +
          '<span>\u4F86\u904E</span><span class="bg-white px-2 py-1 rounded-full text-xs">' + visitedCount + '</span></button>' +
          '<button onclick='updateLocationStatus("' + location.id + '", "want_to_visit")' ' +
          'class="flex items-center space-x-2 px-4 py-2 rounded-full text-sm transition-colors ' + wantToVisitClass + '">' +
          '<span>\u60F3\u4F86</span><span class="bg-white px-2 py-1 rounded-full text-xs">' + wantToVisitCount + '</span></button>' +
          '<button onclick='updateLocationStatus("' + location.id + '", "want_to_revisit")' ' +
          'class="flex items-center space-x-2 px-4 py-2 rounded-full text-sm transition-colors ' + wantToRevisitClass + '">' +
          '<span>\u60F3\u518D\u4F86</span><span class="bg-white px-2 py-1 rounded-full text-xs">' + wantToRevisitCount + '</span></button>' +
          '</div></div></div>';
      }
      
      // \u521D\u59CB\u5316\u4E8B\u4EF6\u76E3\u807D\u5668
      document.addEventListener('DOMContentLoaded', function() {
        // \u624B\u6A5F\u7248\u95DC\u9589\u6309\u9215
        const closeButton = document.getElementById('close-location-detail');
        if (closeButton) {
          closeButton.addEventListener('click', hideLocationDetail);
        }
        
        // \u70BA\u6240\u6709\u5730\u9EDE\u5361\u7247\u6DFB\u52A0\u9EDE\u64CA\u4E8B\u4EF6
        addLocationCardListeners();
      });
      
      // \u52D5\u614B\u6DFB\u52A0\u5730\u9EDE\u5361\u7247\u9EDE\u64CA\u4E8B\u4EF6\uFF08\u7528\u65BC\u52D5\u614B\u52A0\u8F09\u7684\u5167\u5BB9\uFF09
      function addLocationCardListeners() {
        document.querySelectorAll('.location-card').forEach(card => {
          // \u79FB\u9664\u820A\u7684\u4E8B\u4EF6\u76E3\u807D\u5668
          card.removeEventListener('click', handleLocationCardClick);
          // \u6DFB\u52A0\u65B0\u7684\u4E8B\u4EF6\u76E3\u807D\u5668
          card.addEventListener('click', handleLocationCardClick);
        });
      }
      
      // \u5730\u9EDE\u5361\u7247\u9EDE\u64CA\u8655\u7406\u51FD\u6578
      function handleLocationCardClick(e) {
        // \u5982\u679C\u9EDE\u64CA\u7684\u662F\u4E92\u52D5\u6309\u9215\uFF0C\u4E0D\u89F8\u767C\u8A73\u60C5\u986F\u793A
        if (e.target.closest('button')) return;
        
        const locationId = this.dataset.locationId;
        if (locationId) {
          showLocationDetail(locationId);
        }
      }
    </script>
  `;
  return content;
}
function getAddPlacePageContent() {
  return `
    <div class="bg-white w-full h-full flex flex-col overflow-hidden"> <!-- Full height container -->
        <h1 class="text-2xl font-bold mb-4 text-gray-800 flex-shrink-0 hidden">\u65B0\u589E\u5730\u9EDE (\u900F\u904E Google \u5730\u6A19\u641C\u5C0B)</h1> <!-- Hidden H1 -->

        <!-- Search Input Area -->
        <div class="p-4 flex-shrink-0 bg-white border-b border-gray-200 z-10">
            <label for="place-input" class="block text-sm font-medium text-gray-700 mb-1">\u641C\u5C0B\u5730\u9EDE\u540D\u7A31\u6216\u5730\u5740:</label>
            <input 
                type="text" 
                id="place-input" 
                name="place-search"
                placeholder="\u4F8B\u5982\uFF1A\u6F8E\u6E56\u8DE8\u6D77\u5927\u6A4B \u6216 \u53F0\u5317101"
                class="w-full border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm p-2"
            >
        </div>

        <!-- Main Content Area -->
        <div class="flex flex-col md:flex-row flex-grow min-h-0 relative overflow-hidden"> <!-- Main container -->

            <!-- Map Container (Full width on mobile, 3/4 on desktop) -->
            <div id="map-container" class="w-full md:w-3/4 h-full relative"> <!-- Map container -->
                 <div id="map" class="w-full h-full"></div> <!-- Full size map -->
                 <div id="map-message-area" class="absolute bottom-4 left-4 text-sm text-gray-500 bg-white bg-opacity-90 px-2 py-1 rounded shadow-sm z-20">\u9EDE\u64CA\u5730\u5716\u4E0A\u7684\u5716\u793A\u4EE5\u9078\u64C7\u5730\u6A19\uFF0C\u6216\u4F7F\u7528\u4E0A\u65B9\u641C\u5C0B\u6846\u3002</div> <!-- Floating message -->
            </div>

            <!-- Details Panel (Hidden on mobile by default, visible on desktop) -->
            <div id="details-panel" class="w-full md:w-1/4 h-full bg-white border-l border-gray-200 flex flex-col transform transition-all duration-300 ease-in-out" style="transform: translateY(100%); opacity: 0;"> <!-- Sliding panel -->
                
                <!-- Message Area -->
                <div id="message-area" class="p-4 text-sm h-6 flex-shrink-0 border-b border-gray-100"></div> <!-- Message area -->

                <!-- Location Details Display Area -->
                <div id="location-details-area" class="flex-grow overflow-y-auto max-h-full scrollbar-thin scrollbar-thumb-gray-300 scrollbar-track-gray-100" style="display: none;"> <!-- Scrollable content area with custom scrollbar -->
                    <!-- Mobile Back Button -->
                    <div class="md:hidden flex items-center p-4 border-b border-gray-100 flex-shrink-0">
                        <button id="back-to-map-btn" class="flex items-center text-gray-600 hover:text-gray-800 font-medium">
                            <span class="text-xl mr-2">\u2190</span>
                            <span>\u8FD4\u56DE\u5730\u5716</span>
                        </button>
                    </div>
                    
                    <div class="p-4" style="padding-bottom: calc(var(--nav-height) + 2rem);"> <!-- Dynamic bottom padding to avoid nav overlap -->
                        <h3 class="text-lg font-semibold mb-4 text-gray-800">\u5730\u9EDE\u8CC7\u8A0A</h3>
                    <!-- Location Photo Display Area (Moved Inside) -->
                    <div id="location-photo-area" class="mb-4" style="display: none;"> 
                        <img id="location-photo" src="" alt="\u5730\u9EDE\u7167\u7247" class="w-full h-auto rounded max-h-48 object-cover border border-gray-200">
                    </div>
                    <p class="mb-1 text-sm"><strong>\u540D\u7A31:</strong> <span id="location-name">---</span></p>
                    <p class="mb-1 text-sm"><strong>\u5730\u5740:</strong> <span id="location-address">---</span></p>
                    <p class="mb-1 text-sm hidden"><strong>\u5EA7\u6A19:</strong> <span id="location-coords">---</span></p> 
                    <p id="location-summary-paragraph" class="mt-2 text-sm text-gray-700" style="display: none;">
                        <strong>\u7C21\u4ECB:</strong> <span id="location-summary">---</span>
                    </p>
                    <p class="mb-1 text-sm"><strong>\u985E\u578B:</strong> <span id="location-types">---</span></p>
                    <p class="mb-1 text-sm"><strong>\u96FB\u8A71:</strong> <span id="location-phone">---</span></p>
                    <p class="mb-1 text-sm"><strong>\u7DB2\u7AD9:</strong> <span id="location-website">---</span></p>
                    <p class="mb-1 text-sm"><strong>\u8A55\u5206:</strong> <span id="location-rating">---</span></p>
                    <p class="mb-1 text-sm"><strong>\u72C0\u614B:</strong> <span id="location-status">---</span></p>
                    <p class="mb-1 text-sm"><strong>\u4F86\u6E90:</strong> <span id="location-source">---</span></p>
                    
                    <!-- \u65B0\u589E\uFF1A\u5730\u9EDE\u72C0\u614B\u9078\u64C7\u5340\u57DF -->
                    <div id="location-status-selection" class="mt-4 p-3 bg-gray-50 rounded-lg" style="display: none;">
                        <h4 class="text-sm font-semibold mb-2 text-gray-700">\u6B64\u5730\u9EDE\u5DF2\u5B58\u5728\uFF0C\u8ACB\u9078\u64C7\u60A8\u7684\u72C0\u614B\uFF1A</h4>
                        <div class="flex flex-col space-y-2">
                            <button id="status-visited" class="status-btn bg-gray-200 text-gray-700 hover:bg-green-100 px-3 py-2 rounded text-sm transition-colors">
                                <span>\u2713</span>
                                <span>\u4F86\u904E</span>
                            </button>
                            <button id="status-want-to-visit" class="status-btn bg-gray-200 text-gray-700 hover:bg-blue-100 px-3 py-2 rounded text-sm transition-colors">
                                <span>\u2764</span>
                                <span>\u60F3\u4F86</span>
                            </button>
                            <button id="status-want-to-revisit" class="status-btn bg-gray-200 text-gray-700 hover:bg-purple-100 px-3 py-2 rounded text-sm transition-colors">
                                <span>\u{1F504}</span>
                                <span>\u60F3\u518D\u4F86</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Action Button and Navigation Options Container -->
                <div class="flex-shrink-0 border-t border-gray-100 bg-white" style="padding-bottom: calc(var(--nav-height) + 1rem);">
                    <div class="p-4">
                        <button id="confirm-add-button" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded disabled:opacity-50 transition-colors" disabled>
                            \u78BA\u8A8D\u65B0\u589E\u6B64\u5730\u9EDE
                        </button>

                        <!-- Navigation Options (Hidden by default) -->
                        <div id="navigation-options" class="mt-4 p-4 bg-gray-50 rounded-lg" style="display: none;">
                            <h4 class="text-sm font-semibold mb-3 text-gray-700">\u63A5\u4E0B\u4F86\u8981\u505A\u4EC0\u9EBC\uFF1F</h4>
                            <div class="flex flex-col space-y-2">
                                <button id="continue-search-btn" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded text-sm transition-colors">
                                    \u{1F50D} \u7E7C\u7E8C\u641C\u5C0B\u5730\u9EDE
                                </button>
                                <button id="go-home-btn" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded text-sm transition-colors">
                                    \u{1F3E0} \u8FD4\u56DE\u9996\u9801
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

            </div>

        </div>
    </div>

    <style>
      /* Custom scrollbar styles */
      .scrollbar-thin::-webkit-scrollbar {
        width: 6px;
      }
      .scrollbar-thin::-webkit-scrollbar-track {
        background: #f1f5f9;
        border-radius: 3px;
      }
      .scrollbar-thin::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 3px;
      }
      .scrollbar-thin::-webkit-scrollbar-thumb:hover {
        background: #94a3b8;
      }
      
      /* Ensure content is scrollable */
      #location-details-area {
        scrollbar-width: thin;
        scrollbar-color: #cbd5e1 #f1f5f9;
      }
    </style>

    <script>
      // --- Type Translation Logic (Duplicated for Client-Side Script Scope) --- 
      const placeTypeTranslations = {
          'bar': '\u9152\u5427',
          'restaurant': '\u9910\u5EF3',
          'cafe': '\u5496\u5561\u5EF3',
          'store': '\u5546\u5E97',
          'supermarket': '\u8D85\u5E02',
          'convenience_store': '\u4FBF\u5229\u5546\u5E97',
          'department_store': '\u767E\u8CA8\u516C\u53F8',
          'shopping_mall': '\u8CFC\u7269\u4E2D\u5FC3',
          'lodging': '\u4F4F\u5BBF',
          'hotel': '\u98EF\u5E97',
          'point_of_interest': '\u666F\u9EDE',
          'tourist_attraction': '\u65C5\u904A\u666F\u9EDE',
          'park': '\u516C\u5712',
          'museum': '\u535A\u7269\u9928',
          'library': '\u5716\u66F8\u9928',
          'school': '\u5B78\u6821',
          'hospital': '\u91AB\u9662',
          'train_station': '\u706B\u8ECA\u7AD9',
          'bus_station': '\u516C\u8ECA\u7AD9',
          'airport': '\u6A5F\u5834',
          'bank': '\u9280\u884C',
          'post_office': '\u90F5\u5C40',
          'gas_station': '\u52A0\u6CB9\u7AD9',
          'establishment': '\u5834\u6240' 
      };
      
      function translatePlaceTypes(typesArray) {
          if (!typesArray || typesArray.length === 0) return '-';
      
          const translatedTypes = typesArray
              .map(type => placeTypeTranslations[type] || null) 
              .filter(translated => translated !== null && translated !== '\u5834\u6240');
      
          return translatedTypes.length > 0 ? translatedTypes.join(', ') : '\u5176\u4ED6'; 
      }
      // --- END Duplicated Logic ---

      // Make sure declarations are at the top
      let mapsApiKey = null;
      let map; // Declare map globally in script scope
      let marker; // Declare marker globally
      let currentPlaceData = null; // Variable to store temporary place data

      // Function to initialize Google Maps script and Autocomplete
      async function initMap() { 
        try {
            // 1. Fetch API Key from our backend
            const configResponse = await fetch('/api/maps/config');
            if (!configResponse.ok) {
                throw new Error('Failed to fetch Maps config');
            }
            const config = await configResponse.json();
            mapsApiKey = config.apiKey;
            if (!mapsApiKey) {
                 throw new Error('Maps API Key not provided by backend.');
            }

            // 2. Load Google Maps JS API script dynamically
            const script = document.createElement('script');
            script.src = 'https://maps.googleapis.com/maps/api/js?key=' + mapsApiKey + '&libraries=places,places.element&loading=async'; 
            script.async = true; // Keep async loading

            // --- NEW: Initialize AFTER script loads ---
            script.onload = () => {
                console.log('Google Maps API script loaded successfully.');
                initializeMapAndAutocomplete(); // Call the initialization function
            };
            script.onerror = () => {
                 console.error('Failed to load Google Maps API script.');
                 setMessage('\u932F\u8AA4\uFF1A\u7121\u6CD5\u8F09\u5165 Google Maps API\u3002', 'error');
            };
            // --- END NEW ---

            // REMOVED: window.initAutocomplete = initAutocomplete; 
            document.head.appendChild(script);

        } catch (error) {
            console.error('Error initializing map script loading:', error); // Changed log message slightly
            setMessage('\u932F\u8AA4\uFF1A\u7121\u6CD5\u958B\u59CB\u8F09\u5165\u5730\u5716\u641C\u5C0B\u529F\u80FD\u3002 (' + error.message + ')', 'error');
        }
      }

      // --- NEW: Separate initialization function ---
      function initializeMapAndAutocomplete() {
          console.log('Attempting to initialize Map and Autocomplete...'); // Renamed Log

          // --- Initialize the Map FIRST ---
          const initialCenter = { lat: 23.5687, lng: 119.5775 }; 
          const mapDiv = document.getElementById('map');
          if (!mapDiv) {
              console.error('Map container element (#map) not found!');
              setMessage('\u932F\u8AA4\uFF1A\u7121\u6CD5\u521D\u59CB\u5316\u5730\u5716\u5BB9\u5668\u3002', 'error');
          } else {
             map = new google.maps.Map(mapDiv, { 
                 center: initialCenter,
                 zoom: 12,
                 mapTypeControl: false,
                 clickableIcons: true // Enable clicking on POI icons
             });
             console.log('Map initialized.');
             
             // \u8F09\u5165\u5DF2\u5B58\u5728\u7684\u5730\u9EDE\u4E26\u5728\u5730\u5716\u4E0A\u986F\u793A
             loadExistingLocationsOnMap();
             
             // \u521D\u59CB\u5316\u684C\u9762\u7248\u9762\u677F\u72C0\u614B
             initializeDesktopPanel();
             
             // \u8ABF\u6574\u5BB9\u5668\u9AD8\u5EA6
             adjustContainerHeight();
             
             // \u8ABF\u6574\u8A73\u60C5\u9762\u677F\u9593\u8DDD
             adjustDetailsPanelSpacing();
             
             // \u9A57\u8B49\u4F48\u5C40\u7CFB\u7D71
             setTimeout(() => {
                 validateLayout();
             }, 200);
             
             // --- NEW: POI Click Listener --- 
             map.addListener('click', (event) => {
                 if (event.placeId) {
                     // Prevent infowindow from opening on marker click if map has default markers
                     event.stop(); 
                     console.log('POI Clicked, Place ID:', event.placeId);
                     handlePoiClick(event.placeId);
                 } else {
                     // Clicked on the map, not a POI
                     console.log('Map clicked, but not on a POI.');
                     setMessage('\u8ACB\u9EDE\u9078\u5730\u5716\u4E0A\u7684\u5716\u793A\u4EE5\u9078\u64C7\u5730\u6A19\uFF0C\u6216\u4F7F\u7528\u4E0A\u65B9\u641C\u5C0B\u6846\u3002 ', 'warning'); 
                     // Clear details and marker if a non-POI is clicked
                     updateLocationDetails(null);
                     if (marker) marker.setMap(null);
                 }
             });
             console.log('POI click listener added.');
          }
          // --- End Map Initialization ---


          // --- Initialize Autocomplete (Using deprecated Autocomplete class) ---
          console.log('Attempting to find Autocomplete input element...'); // Modified Log
          const inputElement = document.getElementById('place-input'); // Get the <input>

          if (!inputElement) {
               console.error('Autocomplete input element (#place-input) not found!'); // Modified Log
               setMessage('\u932F\u8AA4\uFF1A\u7121\u6CD5\u521D\u59CB\u5316\u641C\u5C0B\u8F38\u5165\u6846\u3002', 'error'); // Modified Message
               return;
          }
          console.log('Autocomplete input element Found:', inputElement); // Modified Log

          // Check if the places library is ready
          console.log('Checking if google.maps.places library is ready...'); // Modified Log
          if (google && google.maps && google.maps.places) {
               console.log('google.maps.places library IS ready. Initializing Autocomplete...'); // Modified Log
               
               // Create the Autocomplete instance attached to the input element
               // Requesting specific fields to ensure we get necessary data
               const autocomplete = new google.maps.places.Autocomplete(inputElement, { 
                   types: ['geocode', 'establishment'], // Optional: Restrict search types
                   fields: ['place_id', 'name', 'formatted_address', 'geometry', 'types', 'international_phone_number', 'website', 'rating', 'user_ratings_total', 'business_status'] // Specify fields
               }); 
               console.log('google.maps.places.Autocomplete initialized.');

               // Add the 'place_changed' listener to the autocomplete instance
               autocomplete.addListener('place_changed', async () => { // Make listener async
                   const place = autocomplete.getPlace();
                   if (place && place.place_id) {
                       console.log('Autocomplete place_changed, Place ID:', place.place_id);
                       await fetchAndDisplayPlaceDetails(place.place_id, 'Google \u641C\u5C0B (Autocomplete)'); // Call unified function
                   } else {
                       console.warn('Autocomplete event fired but getPlace() returned incomplete data:', place);
                       setMessage('\u5730\u9EDE\u8CC7\u8A0A\u4E0D\u5B8C\u6574\uFF0C\u8ACB\u91CD\u65B0\u9078\u64C7\u3002', 'warning');
                       updateLocationDetails(null); 
                       if (marker) marker.setMap(null);
                   }
               }); 
               console.log('Autocomplete listener ADDED for place_changed.'); 

          } else {
               console.error('google.maps.places library not ready when trying to initialize Autocomplete.'); // Modified Log
               setMessage('\u932F\u8AA4\uFF1AGoogle \u5730\u9EDE\u7A0B\u5F0F\u5EAB\u5C1A\u672A\u5C31\u7DD2\u3002', 'error'); // Modified Message
          }
          console.log('Map and Autocomplete initialization process finished.'); 
      }
      // --- END MODIFIED FUNCTION ---

      // Helper function to set messages
      function setMessage(text, type = 'info') {
          const messageArea = document.getElementById('message-area');
          if (!messageArea) return;
          messageArea.textContent = text;
          
          // \u4FDD\u6301\u4E00\u81F4\u7684\u4F48\u5C40\u6A23\u5F0F\uFF0C\u53EA\u6539\u8B8A\u6587\u5B57\u984F\u8272
          const baseClasses = 'p-4 text-sm h-6 flex-shrink-0 border-b border-gray-100';
          let textColorClass = 'text-blue-600'; // Default/Info
          
          if (type === 'error') {
              textColorClass = 'text-red-600';
          } else if (type === 'success') {
              textColorClass = 'text-green-600';
          } else if (type === 'warning') {
              textColorClass = 'text-orange-600';
          }
          
          messageArea.className = baseClasses + ' ' + textColorClass;
      }

      // Function to update the location details display area
      function updateLocationDetails(data) {
          const detailsArea = document.getElementById('location-details-area');
          const confirmButton = document.getElementById('confirm-add-button');
          if (!detailsArea || !confirmButton) return;

          // Handle photo display
          const photoArea = document.getElementById('location-photo-area');
          const photoImg = document.getElementById('location-photo');
          const summaryParagraph = document.getElementById('location-summary-paragraph');
          const summarySpan = document.getElementById('location-summary');

          if (data) {
              // Show photo if available
              if (photoArea && photoImg && data.photoUrls && data.photoUrls.length > 0) {
                  photoImg.src = data.photoUrls[0]; // Show the first photo
                  photoArea.style.display = 'block';
              } else if (photoArea) {
                  photoArea.style.display = 'none'; // Hide if no photos
              }

              // Basic Info
              document.getElementById('location-name').textContent = data.name || 'N/A';
              document.getElementById('location-address').textContent = data.address || ' (\u7121\u5730\u5740\u8CC7\u8A0A) ';
              document.getElementById('location-coords').textContent = data.coords ? (data.coords.lat.toFixed(6) + ', ' + data.coords.lng.toFixed(6)) : 'N/A';
              document.getElementById('location-source').textContent = data.source || 'N/A';
              
              // Additional Details (check if they exist in the data object)
              document.getElementById('location-types').textContent = translatePlaceTypes(data.types);
              document.getElementById('location-phone').textContent = data.phone || '-';
              const websiteSpan = document.getElementById('location-website');
              if (data.website) {
                  // Use string concatenation for innerHTML
                  websiteSpan.innerHTML = '<a href="' + data.website + '" target="_blank" class="text-blue-600 hover:underline">' + data.website + '</a>';
              } else {
                  websiteSpan.textContent = '-';
              }
              // Use string concatenation for rating text
              document.getElementById('location-rating').textContent = data.rating ? (data.rating + ' (' + (data.ratingCount || 0) + ' \u5247\u8A55\u8AD6)') : '-';
              document.getElementById('location-status').textContent = data.status || '-';

              // Show summary if available
              if (summaryParagraph && summarySpan && data.editorialSummary) {
                  summarySpan.textContent = data.editorialSummary;
                  summaryParagraph.style.display = 'block';
              } else if (summaryParagraph) {
                  summarySpan.textContent = '---';
                  summaryParagraph.style.display = 'none'; // Hide if no summary
              }

              detailsArea.style.display = 'block';
              confirmButton.disabled = false;
              currentPlaceData = data.payload; // Store the data needed for backend API call
              
              // \u986F\u793A\u9762\u677F
              slidePanelUp();
              
              // \u78BA\u4FDD\u6EFE\u52D5\u5340\u57DF\u6B63\u78BA\u521D\u59CB\u5316
              setTimeout(() => {
                  if (detailsArea.scrollHeight > detailsArea.clientHeight) {
                      detailsArea.style.overflowY = 'auto';
                  }
              }, 100);
          } else {
              // Hide photo area when clearing details
              if (photoArea) {
                  photoArea.style.display = 'none';
              }
              if (photoImg) {
                  photoImg.src = ''; // Clear image source
              }
              // Clear all fields when hiding
              document.getElementById('location-name').textContent = '---';
              document.getElementById('location-address').textContent = '---';
              document.getElementById('location-coords').textContent = '---';
              // Clear summary when clearing details
              if (summaryParagraph) { 
                  summarySpan.textContent = '---';
                  summaryParagraph.style.display = 'none'; 
              }
              document.getElementById('location-types').textContent = '---';
              document.getElementById('location-phone').textContent = '---';
              document.getElementById('location-website').textContent = '---';
              document.getElementById('location-rating').textContent = '---';
              document.getElementById('location-status').textContent = '---';
              document.getElementById('location-source').textContent = '---';
              
              detailsArea.style.display = 'none';
              confirmButton.disabled = true;
              currentPlaceData = null;
              
              // \u91CD\u7F6E\u72C0\u614B\u8B8A\u6578
              selectedStatus = null;
              existingLocationId = null;
              hideLocationStatusSelection();
              hideNavigationOptions();
              
              // \u96B1\u85CF\u9762\u677F
              slidePanelDown();
          }
          // Conditionally set message
          if (data) {
              setMessage('\u5DF2\u9078\u64C7\u5730\u9EDE\uFF0C\u8ACB\u78BA\u8A8D\u8CC7\u8A0A\u5F8C\u9EDE\u64CA\u6309\u9215\u65B0\u589E\u3002', 'info');
          } // When data is null (clearing), don't set this default message.
      }

      // --- REUSABLE FUNCTION to fetch details and update UI ---
      async function fetchAndDisplayPlaceDetails(placeId, sourceDescription) {
          if (!placeId) return;

          console.log('--- Fetching and Displaying Details for Place ID:', placeId);
          updateLocationDetails(null); // Clear previous details
          if (marker) marker.setMap(null); // Clear previous marker
          setMessage('\u6B63\u5728\u8F09\u5165\u5730\u6A19\u8CC7\u8A0A...', 'info'); 

          try {
              const apiUrl = '/api/locations/details-by-placeid/' + placeId;
              const response = await fetch(apiUrl);

              if (response.ok) {
                  const result = await response.json(); 
                  console.log('Details fetched successfully:', result);

                  const displayData = {
                      name: result.name,
                      address: result.address,
                      coords: result.latitude && result.longitude 
                              ? { lat: result.latitude, lng: result.longitude } 
                              : null, 
                      types: result.googleTypes || [], 
                      phone: result.phone_number || null,
                      website: result.website,
                      rating: result.google_rating,
                      ratingCount: result.google_user_ratings_total,
                      status: result.business_status || null,
                      photoUrls: result.photoUrls || [],
                      editorialSummary: result.editorialSummary || null,
                      source: sourceDescription || '\u672A\u77E5\u4F86\u6E90', 
                      payload: { googlePlaceId: result.googlePlaceId },
                      existingLocation: result.existingLocation || null // \u65B0\u589E\uFF1A\u6AA2\u67E5\u662F\u5426\u5DF2\u5B58\u5728
                  };

                  updateLocationDetails(displayData);

                  if (displayData.coords) {
                      if (marker) marker.setMap(null); 
                      marker = new google.maps.Marker({
                          map: map,
                          position: displayData.coords,
                          title: displayData.name
                      });
                      map.setCenter(displayData.coords);
                      map.setZoom(17); 
                  } else {
                      console.warn('Place details missing coordinates:', result);
                  }

                  // \u6AA2\u67E5\u5730\u9EDE\u662F\u5426\u5DF2\u5B58\u5728
                  if (displayData.existingLocation) {
                      setMessage('\u6B64\u5730\u9EDE\u5DF2\u5B58\u5728\u65BC\u8CC7\u6599\u5EAB\u4E2D\uFF0C\u8ACB\u9078\u64C7\u60A8\u7684\u72C0\u614B\u3002', 'warning');
                      showLocationStatusSelection(displayData.existingLocation);
                  } else {
                      setMessage('\u5DF2\u9078\u64C7\u5730\u6A19\uFF0C\u8ACB\u78BA\u8A8D\u8CC7\u8A0A\u5F8C\u9EDE\u64CA\u6309\u9215\u65B0\u589E\u3002', 'success');
                      hideLocationStatusSelection();
                  }

              } else {
                  const errorResult = await response.json().catch(() => ({ error: 'HTTP error ' + response.status }));
                  console.error('Details API call failed:', response.status, errorResult);
                  setMessage('\u7121\u6CD5\u8F09\u5165\u5730\u6A19\u8CC7\u8A0A\u3002 (' + (errorResult.error || response.statusText) + ')', 'error');
                  updateLocationDetails(null);
              }
          } catch (error) {
              console.error('Error calling details API:', error);
              setMessage('\u8F09\u5165\u5730\u6A19\u8CC7\u8A0A\u6642\u767C\u751F\u7DB2\u8DEF\u932F\u8AA4\u3002', 'error');
              updateLocationDetails(null);
          }
      }
      // --- END REUSABLE FUNCTION ---

      // --- Map POI Click Handler (Calls reusable function) ---
      async function handlePoiClick(placeId) {
         await fetchAndDisplayPlaceDetails(placeId, '\u5730\u5716\u9EDE\u64CA (\u5730\u6A19)'); // Just call the reusable function
      }

      // \u986F\u793A\u5730\u9EDE\u72C0\u614B\u9078\u64C7
      function showLocationStatusSelection(existingLocation) {
          const statusSelection = document.getElementById('location-status-selection');
          const confirmButton = document.getElementById('confirm-add-button');
          
          if (statusSelection) {
              statusSelection.style.display = 'block';
              
              // \u8A2D\u7F6E\u73FE\u6709\u5730\u9EDEID
              existingLocationId = existingLocation.id;
              
              // \u66F4\u65B0\u6309\u9215\u6587\u5B57
              if (confirmButton) {
                  confirmButton.textContent = '\u66F4\u65B0\u6211\u7684\u72C0\u614B';
                  confirmButton.disabled = false;
              }
              
              // \u6DFB\u52A0\u72C0\u614B\u6309\u9215\u4E8B\u4EF6\u76E3\u807D\u5668
              addStatusButtonListeners(existingLocation.id);
          }
      }

      // \u96B1\u85CF\u5730\u9EDE\u72C0\u614B\u9078\u64C7
      function hideLocationStatusSelection() {
          const statusSelection = document.getElementById('location-status-selection');
          const confirmButton = document.getElementById('confirm-add-button');
          
          if (statusSelection) {
              statusSelection.style.display = 'none';
          }
          
          if (confirmButton) {
              confirmButton.textContent = '\u78BA\u8A8D\u65B0\u589E\u6B64\u5730\u9EDE';
          }
      }

      // \u986F\u793A\u5C0E\u822A\u9078\u9805
      function showNavigationOptions() {
          const navigationOptions = document.getElementById('navigation-options');
          if (navigationOptions) {
              navigationOptions.style.display = 'block';
          }
      }

      // \u96B1\u85CF\u5C0E\u822A\u9078\u9805
      function hideNavigationOptions() {
          const navigationOptions = document.getElementById('navigation-options');
          if (navigationOptions) {
              navigationOptions.style.display = 'none';
          }
      }

      // \u6ED1\u52D5\u9762\u677F\u63A7\u5236
      function slidePanelUp() {
          const detailsPanel = document.getElementById('details-panel');
          const mapContainer = document.getElementById('map-container');
          
          if (detailsPanel) {
              if (isMobile()) {
                  detailsPanel.style.transform = 'translateY(0)';
                  detailsPanel.style.opacity = '1';
                  detailsPanel.style.zIndex = '50';
                  
                  // \u78BA\u4FDD\u5730\u5716\u5BB9\u5668\u4FDD\u6301\u53EF\u898B\u4F46\u88AB\u906E\u64CB
                  if (mapContainer) {
                      mapContainer.style.zIndex = '10';
                  }
              } else {
                  // \u684C\u9762\u7248\uFF1A\u78BA\u4FDD\u9762\u677F\u53EF\u898B
                  detailsPanel.style.transform = 'translateX(0)';
                  detailsPanel.style.opacity = '1';
                  detailsPanel.style.zIndex = '20';
              }
          }
      }

      function slidePanelDown() {
          const detailsPanel = document.getElementById('details-panel');
          const mapContainer = document.getElementById('map-container');
          
          if (detailsPanel) {
              if (isMobile()) {
                  detailsPanel.style.transform = 'translateY(100%)';
                  detailsPanel.style.opacity = '0';
                  detailsPanel.style.zIndex = '10';
                  
                  // \u6062\u5FA9\u5730\u5716\u5BB9\u5668\u7684\u53EF\u898B\u6027
                  if (mapContainer) {
                      mapContainer.style.zIndex = '20';
                      mapContainer.style.display = 'block';
                  }
              } else {
                  // \u684C\u9762\u7248\uFF1A\u4FDD\u6301\u9762\u677F\u53EF\u898B\uFF0C\u4F46\u96B1\u85CF\u5167\u5BB9
                  detailsPanel.style.transform = 'translateX(0)';
                  detailsPanel.style.opacity = '1';
                  detailsPanel.style.zIndex = '20';
              }
          }
      }

      // \u521D\u59CB\u5316\u684C\u9762\u7248\u9762\u677F\u72C0\u614B
      function initializeDesktopPanel() {
          if (!isMobile()) {
              const detailsPanel = document.getElementById('details-panel');
              if (detailsPanel) {
                  detailsPanel.style.transform = 'translateX(0)';
                  detailsPanel.style.opacity = '1';
                  detailsPanel.style.zIndex = '20';
                  // \u78BA\u4FDD\u684C\u9762\u7248\u9762\u677F\u59CB\u7D42\u53EF\u898B
                  detailsPanel.classList.add('md:block');
              }
          } else {
              // \u79FB\u52D5\u7248\uFF1A\u78BA\u4FDD\u9762\u677F\u96B1\u85CF
              const detailsPanel = document.getElementById('details-panel');
              const mapContainer = document.getElementById('map-container');
              
              if (detailsPanel) {
                  detailsPanel.style.transform = 'translateY(100%)';
                  detailsPanel.style.opacity = '0';
                  detailsPanel.style.zIndex = '10';
              }
              
              if (mapContainer) {
                  mapContainer.style.zIndex = '20';
                  mapContainer.style.display = 'block';
              }
          }
      }

      // \u6AA2\u67E5\u662F\u5426\u70BA\u79FB\u52D5\u8A2D\u5099
      function isMobile() {
          return window.innerWidth < 768; // md breakpoint
      }

      // \u9A57\u8B49\u5168\u5C40\u4F48\u5C40\u7CFB\u7D71
      function validateLayout() {
          const header = document.querySelector('header');
          const nav = document.querySelector('nav');
          const main = document.querySelector('main');
          const pageContainer = document.querySelector('.page-container, .fullscreen-container');
          
          const headerHeight = header ? header.offsetHeight : 0;
          const navHeight = nav ? nav.offsetHeight : 0;
          const mainHeight = main ? main.offsetHeight : 0;
          const containerHeight = pageContainer ? pageContainer.offsetHeight : 0;
          const windowHeight = window.innerHeight;
          
          // \u6AA2\u67E5 CSS \u8B8A\u6578
          const cssHeaderHeight = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--header-height')) || 0;
          const cssNavHeight = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--nav-height')) || 0;
          const cssMainHeight = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--main-available-height')) || 0;
          
          console.log('[Global Layout Validation]', {
              // \u5BE6\u969B\u5143\u7D20\u9AD8\u5EA6
              headerHeight,
              navHeight,
              mainHeight,
              containerHeight,
              windowHeight,
              totalHeight: headerHeight + navHeight + mainHeight,
              
              // CSS \u8B8A\u6578\u503C
              cssHeaderHeight,
              cssNavHeight,
              cssMainHeight,
              
              // \u9A57\u8B49\u7D50\u679C
              expectedHeaderHeight: 64,
              expectedNavHeight: 64,
              headerMatch: headerHeight === 64,
              navMatch: navHeight === 64,
              cssMatch: cssHeaderHeight === 64 && cssNavHeight === 64,
              layoutValid: Math.abs((headerHeight + navHeight + mainHeight) - windowHeight) < 5, // \u5141\u8A31 5px \u8AA4\u5DEE
              
              // \u4F48\u5C40\u985E\u578B
              layoutType: pageContainer ? (pageContainer.classList.contains('fullscreen-container') ? 'fullscreen' : 'standard') : 'unknown'
          });
          
          return {
              headerHeight,
              navHeight,
              mainHeight,
              containerHeight,
              windowHeight,
              cssHeaderHeight,
              cssNavHeight,
              cssMainHeight,
              isValid: Math.abs((headerHeight + navHeight + mainHeight) - windowHeight) < 5
          };
      }

      // \u8ABF\u6574\u5BB9\u5668\u9AD8\u5EA6\u4EE5\u9069\u61C9\u5168\u5C40\u4F48\u5C40\u7CFB\u7D71
      function adjustContainerHeight() {
          const mapContainer = document.getElementById('map-container');
          if (mapContainer) {
              // \u4F7F\u7528 CSS \u8B8A\u6578\u7372\u53D6\u7CBE\u78BA\u9AD8\u5EA6
              const headerHeight = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--header-height')) || 64;
              const navHeight = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--nav-height')) || 64;
              const totalFixedHeight = headerHeight + navHeight;
              const availableHeight = window.innerHeight - totalFixedHeight;
              
              // \u8A2D\u7F6E\u7CBE\u78BA\u7684\u9AD8\u5EA6
              mapContainer.style.height = availableHeight + 'px';
              
              // \u78BA\u4FDD\u5730\u5716\u5BB9\u5668\u6B63\u78BA\u986F\u793A
              const mapElement = document.getElementById('map');
              if (mapElement && window.google && window.google.maps) {
                  setTimeout(() => {
                      window.google.maps.event.trigger(mapElement, 'resize');
                  }, 100);
              }
              
              console.log('[Layout] Adjusted map container height:', {
                  headerHeight,
                  navHeight,
                  totalFixedHeight,
                  availableHeight,
                  windowHeight: window.innerHeight
              });
          }
      }
      
      // \u8ABF\u6574\u8A73\u60C5\u9762\u677F\u7684\u5E95\u90E8\u9593\u8DDD
      function adjustDetailsPanelSpacing() {
          const detailsPanel = document.getElementById('details-panel');
          const actionContainer = detailsPanel ? detailsPanel.querySelector('.flex-shrink-0') : null;
          const contentArea = document.getElementById('location-details-area');
          
          if (actionContainer) {
              const navHeight = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--nav-height')) || 64;
              actionContainer.style.paddingBottom = (navHeight + 16) + 'px'; // 64px nav + 16px extra
          }
          
          if (contentArea) {
              const contentDiv = contentArea.querySelector('.p-4');
              if (contentDiv) {
                  const navHeight = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--nav-height')) || 64;
                  contentDiv.style.paddingBottom = (navHeight + 32) + 'px'; // 64px nav + 32px extra
              }
          }
          
          console.log('[Layout] Adjusted details panel spacing');
      }

      // \u8F09\u5165\u5DF2\u5B58\u5728\u7684\u5730\u9EDE\u4E26\u5728\u5730\u5716\u4E0A\u986F\u793A
      async function loadExistingLocationsOnMap() {
          try {
              const response = await fetch('/api/locations/existing');
              if (response.ok) {
                  const locations = await response.json();
                  
                  // \u6E05\u9664\u73FE\u6709\u7684\u6A19\u8A18
                  existingLocationMarkers.forEach(marker => marker.setMap(null));
                  existingLocationMarkers = [];
                  
                  // \u70BA\u6BCF\u500B\u5DF2\u5B58\u5728\u7684\u5730\u9EDE\u5275\u5EFA\u6A19\u8A18
                  locations.forEach(location => {
                      if (location.latitude && location.longitude) {
                          const marker = new google.maps.Marker({
                              position: { lat: location.latitude, lng: location.longitude },
                              map: map,
                              title: location.name,
                              icon: {
                                  url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent('<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="12" cy="12" r="8" fill="#4F46E5" stroke="white" stroke-width="2"/><text x="12" y="16" text-anchor="middle" fill="white" font-size="10" font-weight="bold">\u2713</text></svg>'),
                                  scaledSize: new google.maps.Size(24, 24),
                                  anchor: new google.maps.Point(12, 12)
                              }
                          });
                          
                          // \u6DFB\u52A0\u9EDE\u64CA\u4E8B\u4EF6
                          marker.addListener('click', () => {
                              handleExistingLocationClick(location);
                          });
                          
                          existingLocationMarkers.push(marker);
                      }
                  });
                  
                  console.log('[Map] Loaded ' + existingLocationMarkers.length + ' existing locations on map');
              }
          } catch (error) {
              console.error('Error loading existing locations:', error);
          }
      }

      // \u8655\u7406\u5DF2\u5B58\u5728\u5730\u9EDE\u7684\u9EDE\u64CA
      function handleExistingLocationClick(location) {
          console.log('Existing location clicked:', location);
          
          // \u66F4\u65B0\u5730\u9EDE\u8A73\u60C5\u986F\u793A
          const displayData = {
              name: location.name,
              address: location.address,
              coords: { lat: location.latitude, lng: location.longitude },
              types: location.google_types ? JSON.parse(location.google_types) : [],
              phone: location.phone_number,
              website: location.website,
              rating: location.google_rating,
              ratingCount: location.google_user_ratings_total,
              status: location.business_status,
              photoUrls: location.thumbnail_url ? [location.thumbnail_url] : [],
              editorialSummary: location.editorial_summary,
              source: '\u5DF2\u5EFA\u7ACB\u7684\u5730\u6A19',
              payload: { googlePlaceId: location.google_place_id },
              existingLocation: location
          };
          
          updateLocationDetails(displayData);
          
          // \u8A2D\u7F6E\u73FE\u6709\u5730\u9EDEID
          existingLocationId = location.id;
          
          // \u986F\u793A\u72C0\u614B\u9078\u64C7
          showLocationStatusSelection(location);
          
          // \u66F4\u65B0\u5730\u5716\u4E2D\u5FC3
          map.setCenter({ lat: location.latitude, lng: location.longitude });
          map.setZoom(17);
          
          // \u6E05\u9664\u81E8\u6642\u6A19\u8A18
          if (marker) marker.setMap(null);
          
          // \u986F\u793A\u9762\u677F
          slidePanelUp();
          
          setMessage('\u6B64\u5730\u9EDE\u5DF2\u5B58\u5728\u65BC\u8CC7\u6599\u5EAB\u4E2D\uFF0C\u8ACB\u9078\u64C7\u60A8\u7684\u72C0\u614B\u3002', 'warning');
      }

      // \u6DFB\u52A0\u72C0\u614B\u6309\u9215\u4E8B\u4EF6\u76E3\u807D\u5668
      function addStatusButtonListeners(locationId) {
          const statusButtons = document.querySelectorAll('.status-btn');
          
          statusButtons.forEach(button => {
              button.addEventListener('click', function() {
                  // \u91CD\u7F6E\u6240\u6709\u6309\u9215\u6A23\u5F0F
                  statusButtons.forEach(btn => {
                      btn.classList.remove('bg-green-500', 'bg-blue-500', 'bg-purple-500', 'text-white');
                      btn.classList.add('bg-gray-200', 'text-gray-700');
                  });
                  
                  // \u8A2D\u7F6E\u9078\u4E2D\u6309\u9215\u6A23\u5F0F
                  this.classList.remove('bg-gray-200', 'text-gray-700');
                  
                  if (this.id === 'status-visited') {
                      this.classList.add('bg-green-500', 'text-white');
                      selectedStatus = 'visited';
                  } else if (this.id === 'status-want-to-visit') {
                      this.classList.add('bg-blue-500', 'text-white');
                      selectedStatus = 'want_to_visit';
                  } else if (this.id === 'status-want-to-revisit') {
                      this.classList.add('bg-purple-500', 'text-white');
                      selectedStatus = 'want_to_revisit';
                  }
              });
          });
      }

      // \u5168\u5C40\u8B8A\u6578\u5B58\u5132\u9078\u4E2D\u7684\u72C0\u614B
      let selectedStatus = null;
      let existingLocationId = null;
      let existingLocationMarkers = []; // \u5B58\u5132\u5DF2\u5B58\u5728\u5730\u9EDE\u7684\u6A19\u8A18

      // --- Confirm Button Handler --- 
      // Moved definition before the setTimeout call
      async function handleConfirmAdd() {
          const confirmButton = document.getElementById('confirm-add-button');
          confirmButton.disabled = true; // Disable button during request

          // \u6AA2\u67E5\u662F\u5426\u662F\u66F4\u65B0\u73FE\u6709\u5730\u9EDE\u7684\u72C0\u614B
          if (existingLocationId && selectedStatus) {
              setMessage('\u8655\u7406\u4E2D\uFF1A\u6B63\u5728\u66F4\u65B0\u60A8\u7684\u72C0\u614B...', 'info');
              
              try {
                  const response = await fetch('/api/location/status', {
                      method: 'POST',
                      headers: {
                          'Content-Type': 'application/json',
                      },
                      body: JSON.stringify({
                          locationId: existingLocationId,
                          status: selectedStatus
                      })
                  });
                  
                  const result = await response.json();
                  
                  if (response.ok && result.success) {
                      setMessage('\u72C0\u614B\u66F4\u65B0\u6210\u529F\uFF01', 'success');
                      showNavigationOptions();
                  } else {
                      throw new Error(result.error || '\u66F4\u65B0\u5931\u6557');
                  }
              } catch (error) {
                  console.error('Error updating location status:', error);
                  setMessage('\u932F\u8AA4\uFF1A\u7121\u6CD5\u66F4\u65B0\u72C0\u614B\u3002 (' + error.message + ')', 'error');
                  confirmButton.disabled = false;
              }
              return;
          }

          // \u539F\u6709\u7684\u65B0\u589E\u5730\u9EDE\u908F\u8F2F
          if (!currentPlaceData) {
              console.error('Confirm button clicked but no currentPlaceData to send.');
              setMessage('\u932F\u8AA4\uFF1A\u6C92\u6709\u53EF\u65B0\u589E\u7684\u5730\u9EDE\u8CC7\u8A0A\u3002', 'error');
              confirmButton.disabled = false;
              return;
          }
          
          setMessage('\u8655\u7406\u4E2D\uFF1A\u6B63\u5728\u65B0\u589E\u5730\u9EDE\u5230\u8CC7\u6599\u5EAB...', 'info');

          try {
              const response = await fetch('/api/locations/import/google-place', {
                  method: 'POST',
                  headers: {
                      'Content-Type': 'application/json',
                  },
                  body: JSON.stringify(currentPlaceData) // Send the stored data
              });
              const result = await response.json();

              if (!response.ok) {
                  throw new Error(result.error || ('HTTP error ' + response.status)); 
              }
              
              console.log('Backend response (Confirm Add):', result);
              setMessage('\u5DF2\u5C06\u589E\u52A0\u5730\u9EDE\u52A0\u5165\uFF01', 'success');
              showNavigationOptions();

          } catch (error) {
              console.error('Error importing place via Confirm Button:', error);
              setMessage('\u932F\u8AA4\uFF1A\u7121\u6CD5\u52A0\u5165\u5730\u9EDE\u3002 (' + error.message + ')', 'error');
              confirmButton.disabled = false; // Re-enable button on error
          }
      }

      // Start the process when the script runs
      initMap();
      
      // Add listener for the confirm button AFTER the DOM is loaded
      // Using setTimeout 0 is a common trick to delay execution until after current stack clears
      setTimeout(() => {
           const confirmButton = document.getElementById('confirm-add-button');
           if (confirmButton) {
               confirmButton.addEventListener('click', handleConfirmAdd);
           } else {
               console.error('Confirm button not found after timeout.');
           }

           // \u6DFB\u52A0\u5C0E\u822A\u6309\u9215\u4E8B\u4EF6\u76E3\u807D\u5668
           const continueSearchBtn = document.getElementById('continue-search-btn');
           const goHomeBtn = document.getElementById('go-home-btn');
           
           if (continueSearchBtn) {
               continueSearchBtn.addEventListener('click', () => {
                   // \u91CD\u7F6E\u754C\u9762
                   updateLocationDetails(null);
                   hideNavigationOptions();
                   // \u6E05\u7A7A\u641C\u5C0B\u6846
                   const searchInput = document.getElementById('place-input');
                   if (searchInput) {
                       searchInput.value = '';
                   }
                   setMessage('\u8ACB\u641C\u5C0B\u6216\u9EDE\u64CA\u5730\u5716\u4E0A\u7684\u5730\u6A19\u4F86\u9078\u64C7\u5730\u9EDE\u3002', 'info');
               });
           }
           
           if (goHomeBtn) {
               goHomeBtn.addEventListener('click', () => {
                   window.location.href = '/';
               });
           }

           // \u6DFB\u52A0\u8FD4\u56DE\u5730\u5716\u6309\u9215\u4E8B\u4EF6\u76E3\u807D\u5668
           const backToMapBtn = document.getElementById('back-to-map-btn');
           if (backToMapBtn) {
               backToMapBtn.addEventListener('click', () => {
                   slidePanelDown();
                   
                   // \u78BA\u4FDD\u5730\u5716\u5BB9\u5668\u53EF\u898B\u4E26\u91CD\u65B0\u521D\u59CB\u5316
                   const mapContainer = document.getElementById('map-container');
                   const map = document.getElementById('map');
                   
                   if (mapContainer) {
                       mapContainer.style.display = 'block';
                       mapContainer.style.zIndex = '20';
                   }
                   
                   // \u91CD\u65B0\u89F8\u767C\u5730\u5716\u7684 resize \u4E8B\u4EF6\u4EE5\u78BA\u4FDD\u6B63\u78BA\u986F\u793A
                   if (map && window.google && window.google.maps) {
                       setTimeout(() => {
                           window.google.maps.event.trigger(map, 'resize');
                       }, 300);
                   }
               });
           }

           // \u6DFB\u52A0\u7A97\u53E3\u5927\u5C0F\u6539\u8B8A\u76E3\u807D\u5668
           window.addEventListener('resize', () => {
               setTimeout(() => {
                   initializeDesktopPanel();
                   adjustContainerHeight();
                   adjustDetailsPanelSpacing();
                   validateLayout();
               }, 100);
           });
      }, 0);
      
    </script>
`;
}
function getHomePageHtml(user, bundledCss, generalLocations = [], userLocationCounts = null, locationInteractionCounts = {}, userLocationStatuses = {}) {
  console.log("[getHomePageHtml] User object:", user ? { id: user.id, email: user.email, name: user.name, avatar_url: user.avatar_url } : "null");
  const content = getHomePageContent(generalLocations, userLocationCounts, locationInteractionCounts, userLocationStatuses);
  const criticalImages = extractCriticalImages(generalLocations, 3);
  const preloadTags = generateImagePreloadTags(criticalImages);
  let html = wrapPageHtml("Home", content, user, bundledCss);
  if (preloadTags) {
    html = html.replace("</head>", `    ${preloadTags}
</head>`);
  }
  return html;
}
function extractCriticalImages(locations = [], maxImages = 3) {
  if (!Array.isArray(locations) || locations.length === 0) {
    return [];
  }
  const imageUrls = [];
  const defaultImage = "https://placehold.co/400x268/6B7280/FFFFFF?text=Location+Image";
  for (let i = 0; i < Math.min(locations.length, maxImages); i++) {
    const location = locations[i];
    const imageUrl = (location == null ? void 0 : location.thumbnail_url) || (location == null ? void 0 : location.photo_url) || null;
    if (imageUrl && imageUrl !== defaultImage && !imageUrl.includes("placehold.co")) {
      imageUrls.push(imageUrl);
    }
  }
  return imageUrls;
}
function generateImagePreloadTags(imageUrls = []) {
  if (!Array.isArray(imageUrls) || imageUrls.length === 0) {
    return "";
  }
  const maxPreload = 3;
  const urlsToPreload = imageUrls.slice(0, maxPreload);
  return urlsToPreload.map((url) => `<link rel="preload" as="image" href="${url.replace(/"/g, "&quot;")}" fetchpriority="high">`).join("\n    ");
}
function getGoogleInfoPageHtml(user, bundledCss) {
  const content = getGoogleInfoContent(user);
  return wrapPageHtml("Google Info", content, user, bundledCss);
}
function getProfilePageHtml(user, bundledCss, userLocations = [], userLocationCounts = null, locationInteractionCounts = {}, userLocationStatuses = {}) {
  const content = getProfilePageContent(user, userLocations, userLocationCounts, locationInteractionCounts, userLocationStatuses);
  return wrapPageHtml("Profile", content, user, bundledCss);
}
function getAddPlacePageHtml(user, bundledCss) {
  const content = getAddPlacePageContent();
  return `
<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add Place - Hopenghu</title>
    <style>
      /* Inject bundled Tailwind CSS */
      ${bundledCss}
      
      /* ===== GLOBAL LAYOUT SYSTEM ===== */
      
      /* CSS Reset for consistent box model */
      *, *::before, *::after {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }
      
      /* Layout System Variables */
      :root {
        --header-height: 64px;
        --nav-height: 64px;
        --total-fixed-height: calc(var(--header-height) + var(--nav-height));
        --main-available-height: calc(100vh - var(--total-fixed-height));
      }
      
      /* Global Layout Structure */
      html, body {
        height: 100%;
        overflow-x: hidden;
      }
      
      body { 
        display: flex; 
        flex-direction: column; 
        background-color: #f3f4f6;
        color: #1f2937;
      }
      
      /* Fixed Header - Always at top */
      header {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        height: var(--header-height);
        background: white;
        border-bottom: 1px solid #e5e7eb;
        box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
        z-index: 1000;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      
      /* Fixed Navigation - Always at bottom */
      nav {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        height: var(--nav-height);
        background: white;
        border-top: 1px solid #e5e7eb;
        box-shadow: 0 -1px 3px 0 rgba(0, 0, 0, 0.1);
        z-index: 1000;
        display: flex;
        justify-content: space-around;
        align-items: center;
      }
      
      /* Main Content Area - Between header and nav */
      main {
        flex: 1;
        margin-top: var(--header-height);
        margin-bottom: var(--nav-height);
        min-height: var(--main-available-height);
        width: 100%;
        overflow: hidden; /* Prevent scrolling for add-place */
      }
      
      /* Full Screen Layout for add-place page */
      .fullscreen-container {
        width: 100%;
        height: var(--main-available-height);
        margin: 0;
        padding: 0;
        overflow: hidden;
      }
      
      /* Map container takes full available height */
      .map-container { 
        height: var(--main-available-height);
        width: 100%;
      }
      
      /* Details panel bottom spacing to avoid nav overlap */
      #details-panel .flex-shrink-0 {
        padding-bottom: calc(var(--nav-height) + 1rem);
      }
      
      /* Content area bottom spacing */
      #location-details-area .p-4 {
        padding-bottom: calc(var(--nav-height) + 2rem) !important;
      }
      
      /* Responsive adjustments */
      @media (max-width: 768px) {
        :root {
          --header-height: 64px;
          --nav-height: 64px;
        }
      }
      
      /* ===== END GLOBAL LAYOUT SYSTEM ===== */
    </style>
</head>
<body>
    ${getFixedHeaderHtml()}
    <main>
      <div class="fullscreen-container">
        ${content} 
      </div>
    </main>
    ${getBottomNavHtml(user)}
    ${getBottomNavScript()}
</body>
</html>
`;
}
function getAdminInvitationsPageHtml(user, bundledCss, initialLocations = []) {
  const pageTitle = "\u7BA1\u7406\u5546\u5BB6\u9080\u8ACB - HOPENGHU";
  const locationsListHtml = initialLocations.map((loc) => `
        <div class="location-item p-4 border mb-4 rounded-lg shadow">
            <h3 class="text-xl font-semibold">${loc.name || "\u672A\u547D\u540D\u5730\u9EDE"}</h3>
            <p class="text-sm text-gray-600">${loc.address || "\u7121\u5730\u5740\u8CC7\u8A0A"}</p>
            ${loc.claimed_by_user_id ? `<p class="text-sm text-green-600">\u5DF2\u7531\u7528\u6236 ${loc.claimed_by_user_id} \u8A8D\u9818 (Email: ${loc.owner_email || "\u672A\u77E5"})</p>` : `<p class="text-sm text-blue-600">\u5C1A\u672A\u8A8D\u9818</p>`}
            ${!loc.claimed_by_user_id ? `
                <div class="mt-2">
                    <label for="merchant-email-${loc.id}" class="block text-sm font-medium text-gray-700">\u5546\u5BB6 Email:</label>
                    <input type="email" id="merchant-email-${loc.id}" name="merchant-email-${loc.id}" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="merchant@example.com">
                    <button onclick='handleInvite("${loc.id}")' class="mt-2 inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                        \u7522\u751F\u9080\u8ACB\u9023\u7D50
                    </button>
                </div>` : ""}
        </div>
    `).join("") || '<p>\u76EE\u524D\u6C92\u6709\u5730\u9EDE\u53EF\u4F9B\u9080\u8ACB\uFF0C\u8ACB\u5148 <a href="/add-place" class="text-indigo-600 hover:text-indigo-800">\u65B0\u589E\u5730\u9EDE</a>\u3002</p>';
  const content = `
        <div class="container mx-auto px-4 py-8">
            <div class="flex justify-between items-center mb-6">
                <h1 class="text-3xl font-bold text-gray-800">\u7BA1\u7406\u5546\u5BB6\u9080\u8ACB</h1>
                <a href="/add-place" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                    \uFF0B \u65B0\u589E\u5730\u9EDE
                </a>
            </div>

            <div id="invitation-message" class="mb-4 p-3 rounded-md bg-blue-100 text-blue-700" style="display: none;"></div>
            <div id="error-message" class="mb-4 p-3 rounded-md bg-red-100 text-red-700" style="display: none;"></div>

            <div id="locations-list">
                ${locationsListHtml}
            </div>
        </div>

        <script>
            // REMOVED: function getAuthToken() { ... }

            async function handleInvite(locationId) {
                const emailInput = document.getElementById('merchant-email-' + locationId);
                const merchantEmail = emailInput.value.trim();
                const invitationMessageEl = document.getElementById('invitation-message');
                const errorMessageEl = document.getElementById('error-message');

                invitationMessageEl.style.display = 'none';
                errorMessageEl.style.display = 'none';
                invitationMessageEl.textContent = '';
                errorMessageEl.textContent = '';

                if (!merchantEmail || !merchantEmail.includes('@')) {
                    errorMessageEl.textContent = '\u8ACB\u8F38\u5165\u6709\u6548\u7684\u5546\u5BB6 Email\u3002';
                    errorMessageEl.style.display = 'block';
                    return;
                }

                // REMOVED: authToken check
                // if (!authToken) { ... }

                try {
                    // The browser will automatically send the session cookie.
                    // No Authorization header is needed for cookie-based sessions on the same domain.
                    const response = await fetch('/api/admin/locations/generate-claim-link', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            // REMOVED: 'Authorization': 'Bearer ' + authToken
                        },
                        body: JSON.stringify({
                            location_id: locationId,
                            merchant_email: merchantEmail
                        })
                    });

                    const result = await response.json();

                    if (response.ok && result.claim_url) {
                        invitationMessageEl.innerHTML = '\u9080\u8ACB\u9023\u7D50\u5DF2\u7522\u751F: <br><a href="' + result.claim_url + '" target="_blank" class="font-bold hover:underline">' + result.claim_url + '</a><br>(\u8ACB\u8907\u88FD\u6B64\u9023\u7D50\u4E26\u50B3\u9001\u7D66\u5546\u5BB6: ' + result.merchant_email + ')';
                        invitationMessageEl.style.display = 'block';
                        emailInput.value = ''; // Clear input on success
                    } else {
                        // Check if the error is due to unauthorized access (e.g., session expired or invalid)
                        if (response.status === 401 || response.status === 403) {
                             errorMessageEl.textContent = '\u7522\u751F\u9080\u8ACB\u9023\u7D50\u5931\u6557: \u7BA1\u7406\u54E1\u672A\u767B\u5165\u6216\u6B0A\u9650\u4E0D\u8DB3\u3002\u8ACB\u91CD\u65B0\u6574\u7406\u9801\u9762\u6216\u767B\u5165\u3002 (' + (result.error || 'Unauthorized') + ')';
                        } else {
                             errorMessageEl.textContent = '\u7522\u751F\u9080\u8ACB\u9023\u7D50\u5931\u6557: ' + (result.error || '\u672A\u77E5\u932F\u8AA4\uFF0C\u8ACB\u6AA2\u67E5\u4F3A\u670D\u5668\u65E5\u8A8C\u3002') + ' (\u72C0\u614B\u78BC: ' + response.status + ')';
                        }
                        errorMessageEl.style.display = 'block';
                    }
                } catch (error) {
                    console.error('Error calling generate-claim-link API:', error);
                    errorMessageEl.textContent = '\u547C\u53EB API \u6642\u767C\u751F\u7DB2\u8DEF\u6216\u7A0B\u5F0F\u932F\u8AA4: ' + error.message;
                    errorMessageEl.style.display = 'block';
                }
            }

            // Optional: Function to refresh locations list if needed in the future
            // async function refreshLocations() {
            //    try {
            //        // REMOVED: const authToken = getAuthToken();
            //        // REMOVED: if (!authToken) { /* handle not logged in */ return; }
            //        const response = await fetch('/api/admin/locations-for-invitation', {
            //            // REMOVED: headers: { 'Authorization': 'Bearer ' + authToken }
            //        });
            //        if (response.ok) {
            //            const locations = await response.json();
            //            // Re-render the list (simplified here)
            //            // document.getElementById('locations-list').innerHTML = ... (rebuild locationsListHtml)
            //            console.log("Locations refreshed");
            //        }
            //    } catch (error) {
            //        console.error('Error refreshing locations:', error);
            //    }
            // }
        </script>
    `;
  return wrapPageHtml(pageTitle, content, user, bundledCss);
}
function getClaimLocationPageHtml(user, bundledCss, pageData = {}) {
  let contentHtml = '<div class="text-center bg-white p-8 rounded-lg shadow-md w-full max-w-md">';
  console.log("[getClaimLocationPageHtml] Received pageData:", JSON.stringify(pageData));
  if (pageData.success) {
    contentHtml += `
            <h1 class="text-2xl font-semibold text-green-600 mb-4">\u{1F389} \u5730\u9EDE\u8A8D\u9818\u6210\u529F\uFF01</h1>
            <p class="text-gray-700 mb-6">\u606D\u559C\uFF01\u5730\u9EDE <strong>${pageData.locationName ? String(pageData.locationName).replace(/</g, "&lt;").replace(/>/g, "&gt;") : "\u6B64\u5730\u9EDE"}</strong> \u5DF2\u6210\u529F\u7531\u60A8\u8A8D\u9818\u3002</p>
            <p class="mb-4">\u60A8\u53EF\u4EE5\u524D\u5F80\u60A8\u7684 <a href="/profile" class="text-blue-600 hover:underline">\u500B\u4EBA\u8CC7\u6599\u9801\u9762</a> \u67E5\u770B\u60A8\u5DF2\u8A8D\u9818\u7684\u5730\u9EDE\u3002</p>
            <a href="/" class="inline-block bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded transition duration-200 ease-in-out no-underline">\u8FD4\u56DE\u9996\u9801</a>
        `;
  } else if (pageData.success_with_warning) {
    contentHtml += `
            <h1 class="text-2xl font-semibold text-yellow-500 mb-4">\u26A0\uFE0F \u5730\u9EDE\u5DF2\u8A8D\u9818\uFF0C\u4F46\u6709\u6CE8\u610F\u4E8B\u9805</h1>
            <p class="text-gray-700 mb-2">\u5730\u9EDE <strong>${pageData.locationName ? String(pageData.locationName).replace(/</g, "&lt;").replace(/>/g, "&gt;") : "\u6B64\u5730\u9EDE"}</strong> \u5DF2\u6210\u529F\u7531\u60A8\u8A8D\u9818\u3002</p>
            <p class="text-yellow-700 bg-yellow-100 border border-yellow-300 p-3 rounded mb-6">${pageData.message ? String(pageData.message).replace(/</g, "&lt;").replace(/>/g, "&gt;") : "\u66F4\u65B0\u9080\u8ACB\u72C0\u614B\u6642\u9047\u5230\u4E00\u4E9B\u554F\u984C\uFF0C\u8ACB\u806F\u7E6B\u7BA1\u7406\u54E1\u3002"}</p>
            <p class="mb-4">\u60A8\u53EF\u4EE5\u524D\u5F80\u60A8\u7684 <a href="/profile" class="text-blue-600 hover:underline">\u500B\u4EBA\u8CC7\u6599\u9801\u9762</a> \u67E5\u770B\u3002</p>
            <a href="/" class="inline-block bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded transition duration-200 ease-in-out no-underline">\u8FD4\u56DE\u9996\u9801</a>
        `;
  } else if (pageData.error) {
    let title = "\u8ACB\u6C42\u8655\u7406\u5931\u6557";
    let userActionHtml = `<a href="/" class="text-blue-500 hover:underline">\u8FD4\u56DE\u9996\u9801</a>`;
    switch (pageData.error) {
      case "missing_token":
        title = "\u274C \u7F3A\u5C11\u6B0A\u6756";
        break;
      case "invalid_token":
        title = "\u{1F511} \u6B0A\u6756\u7121\u6548";
        break;
      case "expired":
        title = "\u23F3 \u6B0A\u6756\u5DF2\u904E\u671F";
        userActionHtml = `\u8ACB\u806F\u7E6B\u7BA1\u7406\u54E1\u4EE5\u7372\u53D6\u65B0\u7684\u8A8D\u9818\u9023\u7D50\u3002\u6216\u8005 <a href="/" class="text-blue-500 hover:underline">\u8FD4\u56DE\u9996\u9801</a>\u3002`;
        break;
      case "already_used":
        title = "\u{1F517} \u6B0A\u6756\u5DF2\u4F7F\u7528";
        userActionHtml = `\u5982\u679C\u60A8\u8A8D\u70BA\u9019\u662F\u932F\u8AA4\uFF0C\u8ACB\u806F\u7E6B\u7BA1\u7406\u54E1\u3002\u6216\u8005 <a href="/" class="text-blue-500 hover:underline">\u8FD4\u56DE\u9996\u9801</a>\u3002`;
        break;
      case "email_mismatch":
        title = "\u{1F4E7} \u96FB\u5B50\u90F5\u4EF6\u4E0D\u7B26";
        if (user) {
          userActionHtml = `
                        <p class="mb-2">\u60A8\u76EE\u524D\u767B\u5165\u7684\u5E33\u865F\u662F <strong>${String(user.email).replace(/</g, "&lt;").replace(/>/g, "&gt;")}</strong>\u3002</p>
                        <form action="/api/auth/logout" method="POST" class="inline">
                            <button type="submit" class="text-blue-500 hover:underline">\u767B\u51FA</button>
                        </form>
                        \u7136\u5F8C\u4F7F\u7528\u6B63\u78BA\u7684 Google \u5E33\u865F\u91CD\u65B0\u767B\u5165\u4E26\u5617\u8A66\u8A8D\u9818\u3002
                        \u6216\u8005 <a href="/" class="text-blue-500 hover:underline">\u8FD4\u56DE\u9996\u9801</a>\u3002
                    `;
        } else {
          userActionHtml = `\u8ACB <a href="/api/auth/google" class="text-blue-500 hover:underline">\u767B\u5165</a> \u6B63\u78BA\u7684 Google \u5E33\u865F\u5F8C\u518D\u8A66\u4E00\u6B21\uFF0C\u6216 <a href="/" class="text-blue-500 hover:underline">\u8FD4\u56DE\u9996\u9801</a>\u3002`;
        }
        break;
      case "claim_failed":
        title = "\u{1F6AB} \u8A8D\u9818\u5931\u6557";
        userActionHtml = `\u8ACB\u7A0D\u5F8C\u518D\u8A66\uFF0C\u6216\u806F\u7E6B\u7BA1\u7406\u54E1\u3002\u6216\u8005 <a href="/" class="text-blue-500 hover:underline">\u8FD4\u56DE\u9996\u9801</a>\u3002`;
        break;
      case "server_error":
      default:
        title = "\u2699\uFE0F \u4F3A\u670D\u5668\u932F\u8AA4";
        userActionHtml = `\u8ACB\u7A0D\u5F8C\u518D\u8A66\uFF0C\u6216\u806F\u7E6B\u7BA1\u7406\u54E1\u3002\u6216\u8005 <a href="/" class="text-blue-500 hover:underline">\u8FD4\u56DE\u9996\u9801</a>\u3002`;
        break;
    }
    contentHtml += `
            <h1 class="text-2xl font-semibold text-red-600 mb-4">${title}</h1>
            <p class="text-gray-700 bg-red-100 border border-red-300 p-3 rounded mb-6">${pageData.message ? String(pageData.message).replace(/</g, "&lt;").replace(/>/g, "&gt;") : "\u767C\u751F\u672A\u77E5\u7684\u932F\u8AA4\u3002"}</p>
            <div class="mt-6">
                ${userActionHtml}
            </div>
        `;
  } else {
    contentHtml += `
            <h1 class="text-2xl font-semibold text-blue-600 mb-4">\u8655\u7406\u8A8D\u9818\u8ACB\u6C42</h1>
            <p class="text-gray-700 mb-6">\u6B63\u5728\u8655\u7406\u60A8\u7684\u5730\u9EDE\u8A8D\u9818\u8ACB\u6C42...</p>
            <p class="text-gray-500 text-sm">\u5982\u679C\u60A8\u76F4\u63A5\u4F86\u5230\u6B64\u9801\u9762\uFF0C\u60A8\u53EF\u80FD\u9700\u8981\u900F\u904E\u7BA1\u7406\u54E1\u63D0\u4F9B\u7684\u8A8D\u9818\u9023\u7D50\u9032\u5165\u3002</p>
            <div class="mt-6">
                 <a href="/" class="text-blue-500 hover:underline">\u8FD4\u56DE\u9996\u9801</a>
            </div>
        `;
  }
  contentHtml += "</div>";
  return wrapPageHtml("\u8A8D\u9818\u5730\u9EDE", contentHtml, user, bundledCss);
}
var placeTypeTranslations, getFixedHeaderHtml, getBottomNavHtml, getBottomNavScript, criticalCSS, wrapPageHtml;
var init_html2 = __esm({
  "src/templates/html.js"() {
    "use strict";
    placeTypeTranslations = {
      "bar": "\u9152\u5427",
      "restaurant": "\u9910\u5EF3",
      "cafe": "\u5496\u5561\u5EF3",
      "store": "\u5546\u5E97",
      "supermarket": "\u8D85\u5E02",
      "convenience_store": "\u4FBF\u5229\u5546\u5E97",
      "department_store": "\u767E\u8CA8\u516C\u53F8",
      "shopping_mall": "\u8CFC\u7269\u4E2D\u5FC3",
      "lodging": "\u4F4F\u5BBF",
      "hotel": "\u98EF\u5E97",
      "point_of_interest": "\u666F\u9EDE",
      "tourist_attraction": "\u65C5\u904A\u666F\u9EDE",
      "park": "\u516C\u5712",
      "museum": "\u535A\u7269\u9928",
      "library": "\u5716\u66F8\u9928",
      "school": "\u5B78\u6821",
      "hospital": "\u91AB\u9662",
      "train_station": "\u706B\u8ECA\u7AD9",
      "bus_station": "\u516C\u8ECA\u7AD9",
      "airport": "\u6A5F\u5834",
      "bank": "\u9280\u884C",
      "post_office": "\u90F5\u5C40",
      "gas_station": "\u52A0\u6CB9\u7AD9",
      "establishment": "\u5834\u6240"
    };
    getFixedHeaderHtml = () => `
<header class="fixed top-0 left-0 right-0 bg-white border-b border-gray-200 shadow-sm flex items-center justify-center h-16 z-40" style="height: 64px;">
  <a href="/" class="text-2xl font-bold text-blue-600">HOPENGHU</a>
  <!-- Add search icon/bar later if needed -->
</header>
`;
    getBottomNavHtml = (user) => {
      console.log("[getBottomNavHtml] User object:", user ? { id: user.id, email: user.email, name: user.name, avatar_url: user.avatar_url } : "null");
      return `
<nav class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 shadow-md flex justify-around items-center h-16 z-50" style="height: 64px;">
  <a href="/" class="flex flex-col items-center text-gray-700 hover:text-blue-600 p-2">
    <!-- Placeholder icon (replace with SVG/Icon font later) -->
    <span class="text-xl">\u{1F3E0}</span> 
    <span class="text-xs mt-1">\u9996\u9801</span>
  </a>
  <a href="/add-place" class="flex flex-col items-center text-gray-700 hover:text-blue-600 p-2">
    <span class="text-xl">\u2795</span>
    <span class="text-xs mt-1">\u65B0\u589E\u5730\u9EDE</span>
  </a>
  ${user ? `<a href="/itinerary" class="flex flex-col items-center text-gray-700 hover:text-blue-600 p-2">
    <span class="text-xl">\u{1F5FA}\uFE0F</span>
    <span class="text-xs mt-1">\u884C\u7A0B\u898F\u5283</span>
  </a>` : `<a href="#" class="flex flex-col items-center text-gray-700 hover:text-blue-600 p-2"> <!-- Placeholder link for \u512A\u60E0 -->
    <span class="text-xl">\u{1F3F7}\uFE0F</span>
    <span class="text-xs mt-1">\u512A\u60E0</span>
  </a>`}
  ${user ? `<div class="relative flex flex-col items-center p-2">
         <div id="bottom-avatar-container" role="button" tabindex="0" aria-label="User menu" class="focus:outline-none cursor-pointer">
           ${user.avatar_url ? `<img src="${user.avatar_url}" alt="User Avatar" class="w-8 h-8 rounded-full object-cover border-2 border-transparent hover:border-blue-600 transition-colors duration-200">` : `<span class="w-8 h-8 rounded-full bg-blue-500 text-white text-center font-bold text-sm leading-8 flex items-center justify-center">${user.name ? user.name.charAt(0).toUpperCase() : "?"}</span>`}
         </div>
         <span class="text-xs mt-1 text-gray-700">\u6211\u7684</span>
         
         <div id="bottom-user-dropdown-menu" class="hidden absolute bottom-full right-0 mb-2 min-w-[180px] bg-white rounded-md shadow-lg z-50 py-1 border border-gray-200" style="bottom: calc(100% + 8px);">
           <div class="px-4 py-2 border-b border-gray-200">
             <p class="text-sm font-medium text-gray-900 truncate">${user.name || "User"}</p>
             <p class="text-sm text-gray-500 truncate">${user.email || ""}</p>
           </div>
           <a href="/profile" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">\u6211\u7684\u5730\u9EDE</a>
           <a href="/itinerary" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">\u6211\u7684\u884C\u7A0B</a>
           <a href="/google-info" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">\u6211\u7684\u5E33\u865F</a>
           <div class="border-t border-gray-200 my-1"></div>
           <button id="bottom-logout-button" class="block w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-red-50">\u767B\u51FA</button>
         </div>
       </div>` : `<a href="/api/auth/google" class="flex flex-col items-center text-gray-700 hover:text-blue-600 p-2">
         <span class="text-xl">\u27A1\uFE0F</span>
         <span class="text-xs mt-1">\u767B\u5165</span>
       </a>`}
</nav>
`;
    };
    getBottomNavScript = () => `
<script>
  // Bottom Navigation User Dropdown Menu Logic
  (function() {
    const avatarContainer = document.getElementById('bottom-avatar-container');
    const dropdownMenu = document.getElementById('bottom-user-dropdown-menu');
    const logoutButton = document.getElementById('bottom-logout-button');

    if (avatarContainer && dropdownMenu) {
      avatarContainer.addEventListener('click', (event) => {
        event.stopPropagation();
        dropdownMenu.classList.toggle('hidden');
      });
      
      avatarContainer.addEventListener('keydown', (event) => {
        if (event.key === 'Enter' || event.key === ' ') {
          event.preventDefault();
          dropdownMenu.classList.toggle('hidden');
        }
      });
      
      document.addEventListener('click', (event) => {
        if (!dropdownMenu.contains(event.target) && !avatarContainer.contains(event.target)) {
          dropdownMenu.classList.add('hidden');
        }
      });
      
      document.addEventListener('keydown', (event) => {
        if (event.key === 'Escape' && !dropdownMenu.classList.contains('hidden')) {
          dropdownMenu.classList.add('hidden');
          avatarContainer.focus();
        }
      });
    }

    // Logout button handler
    if (logoutButton) {
      logoutButton.addEventListener('click', async () => {
        if (dropdownMenu) dropdownMenu.classList.add('hidden');
        
        try {
          const response = await fetch('/api/auth/logout', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
          });
          if (response.ok) {
            window.location.href = '/';
          } else {
            console.error('Logout failed:', await response.text());
            alert('\u767B\u51FA\u5931\u6557\uFF0C\u8ACB\u7A0D\u5F8C\u518D\u8A66\u3002');
          }
        } catch (error) {
          console.error('Error logging out:', error);
          alert('\u767B\u51FA\u6642\u767C\u751F\u932F\u8AA4\u3002');
        }
      });
    }

    // \u5168\u5C40\u5716\u7247\u8F09\u5165\u8655\u7406\u51FD\u6578
    window.handleImageLoad = function(imageId, containerId) {
      const img = document.getElementById(imageId);
      const container = document.getElementById(containerId);
      if (img && container) {
        const skeleton = container.querySelector('.image-skeleton');
        const progress = container.querySelector('.image-progress');
        const errorMsg = container.querySelector('#error-' + imageId);
        if (skeleton) skeleton.classList.add('hidden');
        if (progress) progress.classList.add('hidden');
        if (errorMsg) errorMsg.classList.add('hidden');
        img.style.opacity = '1';
      }
    };

    window.handleImageError = function(imageId, containerId, defaultImage) {
      const img = document.getElementById(imageId);
      const container = document.getElementById(containerId);
      if (img && container) {
        const skeleton = container.querySelector('.image-skeleton');
        const progress = container.querySelector('.image-progress');
        if (skeleton) skeleton.classList.add('hidden');
        if (progress) progress.classList.add('hidden');
        const errorMsg = container.querySelector('#error-' + imageId);
        if (errorMsg) errorMsg.classList.remove('hidden');
        if (img.src !== defaultImage) {
          img.onerror = null;
          img.src = defaultImage;
          img.style.opacity = '1';
        } else {
          img.style.opacity = '0.3';
        }
      }
    };

    // \u9032\u968E\u61F6\u8F09\u5165\uFF08\u4F7F\u7528 IntersectionObserver\uFF09
    if ('IntersectionObserver' in window) {
      const imageObserver = new IntersectionObserver((entries, observer) => {
        entries.forEach(entry => {
          if (entry.isIntersecting) {
            const img = entry.target;
            const dataSrc = img.getAttribute('data-src');
            if (dataSrc) {
              img.src = dataSrc;
              img.removeAttribute('data-src');
              img.removeAttribute('loading');
              observer.unobserve(img);
            }
          }
        });
      }, { rootMargin: '50px' });

      // \u5728 DOM \u8F09\u5165\u5B8C\u6210\u5F8C\u89C0\u5BDF\u6240\u6709\u5E36\u6709 data-src \u7684\u5716\u7247
      function observeLazyImages() {
        document.querySelectorAll('img[data-src]').forEach(img => imageObserver.observe(img));
      }

      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', observeLazyImages);
      } else {
        observeLazyImages();
      }
    }

    // \u6AA2\u6E2C WebP \u652F\u63F4
    (function() {
      const canvas = document.createElement('canvas');
      canvas.width = 1;
      canvas.height = 1;
      if (canvas.toDataURL('image/webp').indexOf('data:image/webp') === 0) {
        document.documentElement.classList.add('webp-supported');
      } else {
        document.documentElement.classList.add('webp-not-supported');
      }
    })();
  })();
</script>
`;
    criticalCSS = `
/* ===== CRITICAL CSS - Above the fold ===== */
*, *::before, *::after {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

:root {
  --header-height: 64px;
  --nav-height: 64px;
  --total-fixed-height: calc(var(--header-height) + var(--nav-height));
  --main-available-height: calc(100vh - var(--header-height) + var(--nav-height));
  --main-padding: 1rem;
  --main-padding-md: 2rem;
}

html, body {
  height: 100%;
  overflow-x: hidden;
}

body {
  display: flex;
  flex-direction: column;
  background-color: #f3f4f6;
  color: #1f2937;
  font-family: 'Noto Sans TC', sans-serif;
  line-height: 1.6;
}

header {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  height: var(--header-height);
  background: white;
  border-bottom: 1px solid #e5e7eb;
  box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
  z-index: 1000;
  display: flex;
  align-items: center;
  justify-content: center;
}

nav {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  height: var(--nav-height);
  background: white;
  border-top: 1px solid #e5e7eb;
  box-shadow: 0 -1px 3px 0 rgba(0, 0, 0, 0.1);
  z-index: 1000;
  display: flex;
  justify-content: space-around;
  align-items: center;
}

main {
  flex: 1;
  margin-top: var(--header-height);
  margin-bottom: var(--nav-height);
  min-height: var(--main-available-height);
  width: 100%;
  overflow-x: hidden;
  overflow-y: auto;
}

.image-loader-container {
  position: relative;
  width: 100%;
  height: 100%;
  overflow: hidden;
}

.image-skeleton {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
  background-size: 200% 100%;
  animation: shimmer 1.5s infinite;
  z-index: 1;
}

@keyframes shimmer {
  0% { background-position: -200% 0; }
  100% { background-position: 200% 0; }
}

.image-progress {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  display: flex;
  align-items: center;
  justify-content: center;
  background: rgba(255, 255, 255, 0.8);
  z-index: 2;
}

.image-loader-img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  position: relative;
  z-index: 1;
}

.page-container {
  width: 100%;
  max-width: 1200px;
  margin: 0 auto;
  padding: var(--main-padding);
  min-height: var(--main-available-height);
}

@media (min-width: 768px) {
  .page-container {
    padding: var(--main-padding-md);
  }
}

.line-clamp-1 {
  overflow: hidden;
  display: -webkit-box;
  -webkit-box-orient: vertical;
  -webkit-line-clamp: 1;
}

.line-clamp-2 {
  overflow: hidden;
  display: -webkit-box;
  -webkit-box-orient: vertical;
  -webkit-line-clamp: 2;
}

.line-clamp-3 {
  overflow: hidden;
  display: -webkit-box;
  -webkit-box-orient: vertical;
  -webkit-line-clamp: 3;
}

.aspect-\\[3\\/4\\] {
  aspect-ratio: 3 / 4;
}
`;
    wrapPageHtml = (title, mainContentHtml, user, bundledCss = "") => {
      console.log("[wrapPageHtml] User object:", user ? { id: user.id, email: user.email, name: user.name, avatar_url: user.avatar_url } : "null");
      return `
<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${title} - Hopenghu</title>
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <!-- Critical CSS - Inline for faster rendering -->
    <style id="critical-css">
      ${criticalCSS}
    </style>
    <!-- Non-critical CSS - Loaded asynchronously -->
    <style id="non-critical-css" media="print" onload="this.media='all'; this.onload=null;">
      /* Inject bundled Tailwind CSS */
      ${bundledCss}
      
      /* ===== GLOBAL LAYOUT SYSTEM ===== */
      
      /* CSS Reset for consistent box model */
      *, *::before, *::after {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }
      
      /* Layout System Variables */
      :root {
        --header-height: 64px;
        --nav-height: 64px;
        --total-fixed-height: calc(var(--header-height) + var(--nav-height));
        --main-available-height: calc(100vh - var(--total-fixed-height));
        --main-padding: 1rem;
        --main-padding-md: 2rem;
      }
      
      /* Global Layout Structure */
      html, body {
        height: 100%;
        overflow-x: hidden;
      }
      
      body { 
        display: flex; 
        flex-direction: column; 
        background-color: #f3f4f6;
        color: #1f2937;
      }
      
      /* Fixed Header - Always at top */
      header {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        height: var(--header-height);
        background: white;
        border-bottom: 1px solid #e5e7eb;
        box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
        z-index: 1000;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      
      /* Fixed Navigation - Always at bottom */
      nav {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        height: var(--nav-height);
        background: white;
        border-top: 1px solid #e5e7eb;
        box-shadow: 0 -1px 3px 0 rgba(0, 0, 0, 0.1);
        z-index: 1000;
        display: flex;
        justify-content: space-around;
        align-items: center;
      }
      
      /* Main Content Area - Between header and nav */
      main {
        flex: 1;
        margin-top: var(--header-height);
        margin-bottom: var(--nav-height);
        min-height: var(--main-available-height);
        width: 100%;
        overflow-x: hidden;
        overflow-y: auto;
      }
      
      /* Standard Page Layout */
      .page-container {
        width: 100%;
        max-width: 1200px;
        margin: 0 auto;
        padding: var(--main-padding);
        min-height: var(--main-available-height);
      }
      
      @media (min-width: 768px) {
        .page-container {
          padding: var(--main-padding-md);
        }
      }
      
      /* Full Screen Layout (for add-place page) */
      .fullscreen-container {
        width: 100%;
        height: 100vh;
        margin: 0;
        padding: 0;
        overflow: hidden;
      }
      
      /* ===== UTILITY CLASSES ===== */
      
      /* Line Clamp Utilities */
      .line-clamp-1 {
        overflow: hidden;
        display: -webkit-box;
        -webkit-box-orient: vertical;
        -webkit-line-clamp: 1;
      }
      
      .line-clamp-2 {
        overflow: hidden;
        display: -webkit-box;
        -webkit-box-orient: vertical;
        -webkit-line-clamp: 2;
      }
      
      .line-clamp-3 {
        overflow: hidden;
        display: -webkit-box;
        -webkit-box-orient: vertical;
        -webkit-line-clamp: 3;
      }
      
      /* Aspect Ratio Utilities */
      .aspect-\\[3\\/4\\] {
        aspect-ratio: 3 / 4;
      }
      
      /* ===== RESPONSIVE DESIGN ===== */
      
      /* Mobile First Approach */
      @media (max-width: 640px) {
        /* Mobile specific styles */
        .mobile-full-width {
          width: 100vw;
          margin-left: calc(-50vw + 50%);
        }
      }
      
      /* Tablet and Desktop */
      @media (min-width: 768px) {
        /* Tablet specific styles */
      }
      
      @media (min-width: 1024px) {
        /* Desktop specific styles */
      }
      
      /* ===== ANIMATIONS ===== */
      
      /* Smooth transitions */
      .transition-shadow {
        transition: box-shadow 0.2s ease-in-out;
      }
      
      .transition-colors {
        transition: color 0.2s ease-in-out, background-color 0.2s ease-in-out;
      }
      
      /* ===== CUSTOM SCROLLBAR ===== */
      
      /* Webkit browsers */
      ::-webkit-scrollbar {
        width: 6px;
      }
      
      ::-webkit-scrollbar-track {
        background: #f1f1f1;
      }
      
      ::-webkit-scrollbar-thumb {
        background: #c1c1c1;
        border-radius: 3px;
      }
      
      ::-webkit-scrollbar-thumb:hover {
        background: #a8a8a8;
      }
      
      /* Firefox */
      * {
        scrollbar-width: thin;
        scrollbar-color: #c1c1c1 #f1f1f1;
      }
    </style>
    <noscript>
      <style id="non-critical-css-fallback">
        /* Inject bundled Tailwind CSS */
        ${bundledCss}
      </style>
    </noscript>
    <!-- Preload critical resources -->
    <link rel="preload" as="image" href="https://placehold.co/400x268/6B7280/FFFFFF?text=Location+Image">
    <link rel="dns-prefetch" href="https://maps.googleapis.com">
    <link rel="dns-prefetch" href="https://maps.gstatic.com">
    <link rel="dns-prefetch" href="https://www.gstatic.com">
</head>
<body>
    ${getFixedHeaderHtml()}
    
    <main>
        ${mainContentHtml}
    </main>
    
    ${getBottomNavHtml(user)}
    ${getBottomNavScript()}
</body>
</html>
`;
    };
  }
});

// src/assets/itinerary-assets.js
var itinerary_assets_exports = {};
__export(itinerary_assets_exports, {
  getAllItineraryAssets: () => getAllItineraryAssets,
  getItineraryAsset: () => getItineraryAsset,
  itineraryAssets: () => itineraryAssets
});
function getItineraryAsset(path) {
  return itineraryAssets[path] || null;
}
function getAllItineraryAssets() {
  return itineraryAssets;
}
var itineraryAssets;
var init_itinerary_assets = __esm({
  "src/assets/itinerary-assets.js"() {
    "use strict";
    itineraryAssets = {
      "App.js": 'import * as En from "react";\nimport mt, { useLayoutEffect as fo, useEffect as B, useRef as j, useMemo as W, useCallback as lt, useState as L, createContext as Lt, memo as Pl, useReducer as Rl, useContext as q, useId as $s, useInsertionEffect as po, Children as Ml, isValidElement as El, Fragment as mo, createElement as Vl, forwardRef as Nl, Component as kl } from "react";\nimport { unstable_batchedUpdates as ln, createPortal as Il } from "react-dom";\nvar _n = { exports: {} }, Ie = {};\n/**\n * @license React\n * react-jsx-runtime.production.js\n *\n * Copyright (c) Meta Platforms, Inc. and affiliates.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n */\nvar Ii;\nfunction jl() {\n  if (Ii) return Ie;\n  Ii = 1;\n  var t = Symbol.for("react.transitional.element"), e = Symbol.for("react.fragment");\n  function n(s, i, r) {\n    var o = null;\n    if (r !== void 0 && (o = "" + r), i.key !== void 0 && (o = "" + i.key), "key" in i) {\n      r = {};\n      for (var a in i)\n        a !== "key" && (r[a] = i[a]);\n    } else r = i;\n    return i = r.ref, {\n      $$typeof: t,\n      type: s,\n      key: o,\n      ref: i !== void 0 ? i : null,\n      props: r\n    };\n  }\n  return Ie.Fragment = e, Ie.jsx = n, Ie.jsxs = n, Ie;\n}\nvar ji;\nfunction Ll() {\n  return ji || (ji = 1, _n.exports = jl()), _n.exports;\n}\nvar p = Ll();\nfunction Ol() {\n  for (var t = arguments.length, e = new Array(t), n = 0; n < t; n++)\n    e[n] = arguments[n];\n  return W(\n    () => (s) => {\n      e.forEach((i) => i(s));\n    },\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n    e\n  );\n}\nconst Vn = typeof window < "u" && typeof window.document < "u" && typeof window.document.createElement < "u";\nfunction De(t) {\n  const e = Object.prototype.toString.call(t);\n  return e === "[object Window]" || // In Electron context the Window object serializes to [object global]\n  e === "[object global]";\n}\nfunction _s(t) {\n  return "nodeType" in t;\n}\nfunction vt(t) {\n  var e, n;\n  return t ? De(t) ? t : _s(t) && (e = (n = t.ownerDocument) == null ? void 0 : n.defaultView) != null ? e : window : window;\n}\nfunction Us(t) {\n  const {\n    Document: e\n  } = vt(t);\n  return t instanceof e;\n}\nfunction Qe(t) {\n  return De(t) ? !1 : t instanceof vt(t).HTMLElement;\n}\nfunction go(t) {\n  return t instanceof vt(t).SVGElement;\n}\nfunction Ce(t) {\n  return t ? De(t) ? t.document : _s(t) ? Us(t) ? t : Qe(t) || go(t) ? t.ownerDocument : document : document : document;\n}\nconst Wt = Vn ? fo : B;\nfunction zs(t) {\n  const e = j(t);\n  return Wt(() => {\n    e.current = t;\n  }), lt(function() {\n    for (var n = arguments.length, s = new Array(n), i = 0; i < n; i++)\n      s[i] = arguments[i];\n    return e.current == null ? void 0 : e.current(...s);\n  }, []);\n}\nfunction Fl() {\n  const t = j(null), e = lt((s, i) => {\n    t.current = setInterval(s, i);\n  }, []), n = lt(() => {\n    t.current !== null && (clearInterval(t.current), t.current = null);\n  }, []);\n  return [e, n];\n}\nfunction We(t, e) {\n  e === void 0 && (e = [t]);\n  const n = j(t);\n  return Wt(() => {\n    n.current !== t && (n.current = t);\n  }, e), n;\n}\nfunction tn(t, e) {\n  const n = j();\n  return W(\n    () => {\n      const s = t(n.current);\n      return n.current = s, s;\n    },\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n    [...e]\n  );\n}\nfunction bn(t) {\n  const e = zs(t), n = j(null), s = lt(\n    (i) => {\n      i !== n.current && e?.(i, n.current), n.current = i;\n    },\n    //eslint-disable-next-line\n    []\n  );\n  return [n, s];\n}\nfunction fs(t) {\n  const e = j();\n  return B(() => {\n    e.current = t;\n  }, [t]), e.current;\n}\nlet Un = {};\nfunction en(t, e) {\n  return W(() => {\n    if (e)\n      return e;\n    const n = Un[t] == null ? 0 : Un[t] + 1;\n    return Un[t] = n, t + "-" + n;\n  }, [t, e]);\n}\nfunction yo(t) {\n  return function(e) {\n    for (var n = arguments.length, s = new Array(n > 1 ? n - 1 : 0), i = 1; i < n; i++)\n      s[i - 1] = arguments[i];\n    return s.reduce((r, o) => {\n      const a = Object.entries(o);\n      for (const [l, u] of a) {\n        const c = r[l];\n        c != null && (r[l] = c + t * u);\n      }\n      return r;\n    }, {\n      ...e\n    });\n  };\n}\nconst be = /* @__PURE__ */ yo(1), Ke = /* @__PURE__ */ yo(-1);\nfunction Bl(t) {\n  return "clientX" in t && "clientY" in t;\n}\nfunction Ws(t) {\n  if (!t)\n    return !1;\n  const {\n    KeyboardEvent: e\n  } = vt(t.target);\n  return e && t instanceof e;\n}\nfunction $l(t) {\n  if (!t)\n    return !1;\n  const {\n    TouchEvent: e\n  } = vt(t.target);\n  return e && t instanceof e;\n}\nfunction ps(t) {\n  if ($l(t)) {\n    if (t.touches && t.touches.length) {\n      const {\n        clientX: e,\n        clientY: n\n      } = t.touches[0];\n      return {\n        x: e,\n        y: n\n      };\n    } else if (t.changedTouches && t.changedTouches.length) {\n      const {\n        clientX: e,\n        clientY: n\n      } = t.changedTouches[0];\n      return {\n        x: e,\n        y: n\n      };\n    }\n  }\n  return Bl(t) ? {\n    x: t.clientX,\n    y: t.clientY\n  } : null;\n}\nconst Ge = /* @__PURE__ */ Object.freeze({\n  Translate: {\n    toString(t) {\n      if (!t)\n        return;\n      const {\n        x: e,\n        y: n\n      } = t;\n      return "translate3d(" + (e ? Math.round(e) : 0) + "px, " + (n ? Math.round(n) : 0) + "px, 0)";\n    }\n  },\n  Scale: {\n    toString(t) {\n      if (!t)\n        return;\n      const {\n        scaleX: e,\n        scaleY: n\n      } = t;\n      return "scaleX(" + e + ") scaleY(" + n + ")";\n    }\n  },\n  Transform: {\n    toString(t) {\n      if (t)\n        return [Ge.Translate.toString(t), Ge.Scale.toString(t)].join(" ");\n    }\n  },\n  Transition: {\n    toString(t) {\n      let {\n        property: e,\n        duration: n,\n        easing: s\n      } = t;\n      return e + " " + n + "ms " + s;\n    }\n  }\n}), Li = "a,frame,iframe,input:not([type=hidden]):not(:disabled),select:not(:disabled),textarea:not(:disabled),button:not(:disabled),*[tabindex]";\nfunction _l(t) {\n  return t.matches(Li) ? t : t.querySelector(Li);\n}\nconst Ul = {\n  display: "none"\n};\nfunction zl(t) {\n  let {\n    id: e,\n    value: n\n  } = t;\n  return mt.createElement("div", {\n    id: e,\n    style: Ul\n  }, n);\n}\nfunction Wl(t) {\n  let {\n    id: e,\n    announcement: n,\n    ariaLiveType: s = "assertive"\n  } = t;\n  const i = {\n    position: "fixed",\n    top: 0,\n    left: 0,\n    width: 1,\n    height: 1,\n    margin: -1,\n    border: 0,\n    padding: 0,\n    overflow: "hidden",\n    clip: "rect(0 0 0 0)",\n    clipPath: "inset(100%)",\n    whiteSpace: "nowrap"\n  };\n  return mt.createElement("div", {\n    id: e,\n    style: i,\n    role: "status",\n    "aria-live": s,\n    "aria-atomic": !0\n  }, n);\n}\nfunction Kl() {\n  const [t, e] = L("");\n  return {\n    announce: lt((s) => {\n      s != null && e(s);\n    }, []),\n    announcement: t\n  };\n}\nconst vo = /* @__PURE__ */ Lt(null);\nfunction Gl(t) {\n  const e = q(vo);\n  B(() => {\n    if (!e)\n      throw new Error("useDndMonitor must be used within a children of <DndContext>");\n    return e(t);\n  }, [t, e]);\n}\nfunction Hl() {\n  const [t] = L(() => /* @__PURE__ */ new Set()), e = lt((s) => (t.add(s), () => t.delete(s)), [t]);\n  return [lt((s) => {\n    let {\n      type: i,\n      event: r\n    } = s;\n    t.forEach((o) => {\n      var a;\n      return (a = o[i]) == null ? void 0 : a.call(o, r);\n    });\n  }, [t]), e];\n}\nconst Xl = {\n  draggable: `\n    To pick up a draggable item, press the space bar.\n    While dragging, use the arrow keys to move the item.\n    Press space again to drop the item in its new position, or press escape to cancel.\n  `\n}, Yl = {\n  onDragStart(t) {\n    let {\n      active: e\n    } = t;\n    return "Picked up draggable item " + e.id + ".";\n  },\n  onDragOver(t) {\n    let {\n      active: e,\n      over: n\n    } = t;\n    return n ? "Draggable item " + e.id + " was moved over droppable area " + n.id + "." : "Draggable item " + e.id + " is no longer over a droppable area.";\n  },\n  onDragEnd(t) {\n    let {\n      active: e,\n      over: n\n    } = t;\n    return n ? "Draggable item " + e.id + " was dropped over droppable area " + n.id : "Draggable item " + e.id + " was dropped.";\n  },\n  onDragCancel(t) {\n    let {\n      active: e\n    } = t;\n    return "Dragging was cancelled. Draggable item " + e.id + " was dropped.";\n  }\n};\nfunction ql(t) {\n  let {\n    announcements: e = Yl,\n    container: n,\n    hiddenTextDescribedById: s,\n    screenReaderInstructions: i = Xl\n  } = t;\n  const {\n    announce: r,\n    announcement: o\n  } = Kl(), a = en("DndLiveRegion"), [l, u] = L(!1);\n  if (B(() => {\n    u(!0);\n  }, []), Gl(W(() => ({\n    onDragStart(d) {\n      let {\n        active: h\n      } = d;\n      r(e.onDragStart({\n        active: h\n      }));\n    },\n    onDragMove(d) {\n      let {\n        active: h,\n        over: f\n      } = d;\n      e.onDragMove && r(e.onDragMove({\n        active: h,\n        over: f\n      }));\n    },\n    onDragOver(d) {\n      let {\n        active: h,\n        over: f\n      } = d;\n      r(e.onDragOver({\n        active: h,\n        over: f\n      }));\n    },\n    onDragEnd(d) {\n      let {\n        active: h,\n        over: f\n      } = d;\n      r(e.onDragEnd({\n        active: h,\n        over: f\n      }));\n    },\n    onDragCancel(d) {\n      let {\n        active: h,\n        over: f\n      } = d;\n      r(e.onDragCancel({\n        active: h,\n        over: f\n      }));\n    }\n  }), [r, e])), !l)\n    return null;\n  const c = mt.createElement(mt.Fragment, null, mt.createElement(zl, {\n    id: s,\n    value: i.draggable\n  }), mt.createElement(Wl, {\n    id: a,\n    announcement: o\n  }));\n  return n ? Il(c, n) : c;\n}\nvar it;\n(function(t) {\n  t.DragStart = "dragStart", t.DragMove = "dragMove", t.DragEnd = "dragEnd", t.DragCancel = "dragCancel", t.DragOver = "dragOver", t.RegisterDroppable = "registerDroppable", t.SetDroppableDisabled = "setDroppableDisabled", t.UnregisterDroppable = "unregisterDroppable";\n})(it || (it = {}));\nfunction wn() {\n}\nfunction Oi(t, e) {\n  return W(\n    () => ({\n      sensor: t,\n      options: e ?? {}\n    }),\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n    [t, e]\n  );\n}\nfunction Jl() {\n  for (var t = arguments.length, e = new Array(t), n = 0; n < t; n++)\n    e[n] = arguments[n];\n  return W(\n    () => [...e].filter((s) => s != null),\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n    [...e]\n  );\n}\nconst jt = /* @__PURE__ */ Object.freeze({\n  x: 0,\n  y: 0\n});\nfunction xo(t, e) {\n  return Math.sqrt(Math.pow(t.x - e.x, 2) + Math.pow(t.y - e.y, 2));\n}\nfunction bo(t, e) {\n  let {\n    data: {\n      value: n\n    }\n  } = t, {\n    data: {\n      value: s\n    }\n  } = e;\n  return n - s;\n}\nfunction Zl(t, e) {\n  let {\n    data: {\n      value: n\n    }\n  } = t, {\n    data: {\n      value: s\n    }\n  } = e;\n  return s - n;\n}\nfunction Fi(t) {\n  let {\n    left: e,\n    top: n,\n    height: s,\n    width: i\n  } = t;\n  return [{\n    x: e,\n    y: n\n  }, {\n    x: e + i,\n    y: n\n  }, {\n    x: e,\n    y: n + s\n  }, {\n    x: e + i,\n    y: n + s\n  }];\n}\nfunction wo(t, e) {\n  if (!t || t.length === 0)\n    return null;\n  const [n] = t;\n  return n[e];\n}\nfunction Bi(t, e, n) {\n  return e === void 0 && (e = t.left), n === void 0 && (n = t.top), {\n    x: e + t.width * 0.5,\n    y: n + t.height * 0.5\n  };\n}\nconst Ql = (t) => {\n  let {\n    collisionRect: e,\n    droppableRects: n,\n    droppableContainers: s\n  } = t;\n  const i = Bi(e, e.left, e.top), r = [];\n  for (const o of s) {\n    const {\n      id: a\n    } = o, l = n.get(a);\n    if (l) {\n      const u = xo(Bi(l), i);\n      r.push({\n        id: a,\n        data: {\n          droppableContainer: o,\n          value: u\n        }\n      });\n    }\n  }\n  return r.sort(bo);\n}, tc = (t) => {\n  let {\n    collisionRect: e,\n    droppableRects: n,\n    droppableContainers: s\n  } = t;\n  const i = Fi(e), r = [];\n  for (const o of s) {\n    const {\n      id: a\n    } = o, l = n.get(a);\n    if (l) {\n      const u = Fi(l), c = i.reduce((h, f, g) => h + xo(u[g], f), 0), d = Number((c / 4).toFixed(4));\n      r.push({\n        id: a,\n        data: {\n          droppableContainer: o,\n          value: d\n        }\n      });\n    }\n  }\n  return r.sort(bo);\n};\nfunction ec(t, e) {\n  const n = Math.max(e.top, t.top), s = Math.max(e.left, t.left), i = Math.min(e.left + e.width, t.left + t.width), r = Math.min(e.top + e.height, t.top + t.height), o = i - s, a = r - n;\n  if (s < i && n < r) {\n    const l = e.width * e.height, u = t.width * t.height, c = o * a, d = c / (l + u - c);\n    return Number(d.toFixed(4));\n  }\n  return 0;\n}\nconst nc = (t) => {\n  let {\n    collisionRect: e,\n    droppableRects: n,\n    droppableContainers: s\n  } = t;\n  const i = [];\n  for (const r of s) {\n    const {\n      id: o\n    } = r, a = n.get(o);\n    if (a) {\n      const l = ec(a, e);\n      l > 0 && i.push({\n        id: o,\n        data: {\n          droppableContainer: r,\n          value: l\n        }\n      });\n    }\n  }\n  return i.sort(Zl);\n};\nfunction sc(t, e, n) {\n  return {\n    ...t,\n    scaleX: e && n ? e.width / n.width : 1,\n    scaleY: e && n ? e.height / n.height : 1\n  };\n}\nfunction To(t, e) {\n  return t && e ? {\n    x: t.left - e.left,\n    y: t.top - e.top\n  } : jt;\n}\nfunction ic(t) {\n  return function(n) {\n    for (var s = arguments.length, i = new Array(s > 1 ? s - 1 : 0), r = 1; r < s; r++)\n      i[r - 1] = arguments[r];\n    return i.reduce((o, a) => ({\n      ...o,\n      top: o.top + t * a.y,\n      bottom: o.bottom + t * a.y,\n      left: o.left + t * a.x,\n      right: o.right + t * a.x\n    }), {\n      ...n\n    });\n  };\n}\nconst rc = /* @__PURE__ */ ic(1);\nfunction oc(t) {\n  if (t.startsWith("matrix3d(")) {\n    const e = t.slice(9, -1).split(/, /);\n    return {\n      x: +e[12],\n      y: +e[13],\n      scaleX: +e[0],\n      scaleY: +e[5]\n    };\n  } else if (t.startsWith("matrix(")) {\n    const e = t.slice(7, -1).split(/, /);\n    return {\n      x: +e[4],\n      y: +e[5],\n      scaleX: +e[0],\n      scaleY: +e[3]\n    };\n  }\n  return null;\n}\nfunction ac(t, e, n) {\n  const s = oc(e);\n  if (!s)\n    return t;\n  const {\n    scaleX: i,\n    scaleY: r,\n    x: o,\n    y: a\n  } = s, l = t.left - o - (1 - i) * parseFloat(n), u = t.top - a - (1 - r) * parseFloat(n.slice(n.indexOf(" ") + 1)), c = i ? t.width / i : t.width, d = r ? t.height / r : t.height;\n  return {\n    width: c,\n    height: d,\n    top: u,\n    right: l + c,\n    bottom: u + d,\n    left: l\n  };\n}\nconst lc = {\n  ignoreTransform: !1\n};\nfunction Ae(t, e) {\n  e === void 0 && (e = lc);\n  let n = t.getBoundingClientRect();\n  if (e.ignoreTransform) {\n    const {\n      transform: u,\n      transformOrigin: c\n    } = vt(t).getComputedStyle(t);\n    u && (n = ac(n, u, c));\n  }\n  const {\n    top: s,\n    left: i,\n    width: r,\n    height: o,\n    bottom: a,\n    right: l\n  } = n;\n  return {\n    top: s,\n    left: i,\n    width: r,\n    height: o,\n    bottom: a,\n    right: l\n  };\n}\nfunction $i(t) {\n  return Ae(t, {\n    ignoreTransform: !0\n  });\n}\nfunction cc(t) {\n  const e = t.innerWidth, n = t.innerHeight;\n  return {\n    top: 0,\n    left: 0,\n    right: e,\n    bottom: n,\n    width: e,\n    height: n\n  };\n}\nfunction uc(t, e) {\n  return e === void 0 && (e = vt(t).getComputedStyle(t)), e.position === "fixed";\n}\nfunction dc(t, e) {\n  e === void 0 && (e = vt(t).getComputedStyle(t));\n  const n = /(auto|scroll|overlay)/;\n  return ["overflow", "overflowX", "overflowY"].some((i) => {\n    const r = e[i];\n    return typeof r == "string" ? n.test(r) : !1;\n  });\n}\nfunction Nn(t, e) {\n  const n = [];\n  function s(i) {\n    if (e != null && n.length >= e || !i)\n      return n;\n    if (Us(i) && i.scrollingElement != null && !n.includes(i.scrollingElement))\n      return n.push(i.scrollingElement), n;\n    if (!Qe(i) || go(i) || n.includes(i))\n      return n;\n    const r = vt(t).getComputedStyle(i);\n    return i !== t && dc(i, r) && n.push(i), uc(i, r) ? n : s(i.parentNode);\n  }\n  return t ? s(t) : n;\n}\nfunction So(t) {\n  const [e] = Nn(t, 1);\n  return e ?? null;\n}\nfunction zn(t) {\n  return !Vn || !t ? null : De(t) ? t : _s(t) ? Us(t) || t === Ce(t).scrollingElement ? window : Qe(t) ? t : null : null;\n}\nfunction Do(t) {\n  return De(t) ? t.scrollX : t.scrollLeft;\n}\nfunction Co(t) {\n  return De(t) ? t.scrollY : t.scrollTop;\n}\nfunction ms(t) {\n  return {\n    x: Do(t),\n    y: Co(t)\n  };\n}\nvar at;\n(function(t) {\n  t[t.Forward = 1] = "Forward", t[t.Backward = -1] = "Backward";\n})(at || (at = {}));\nfunction Ao(t) {\n  return !Vn || !t ? !1 : t === document.scrollingElement;\n}\nfunction Po(t) {\n  const e = {\n    x: 0,\n    y: 0\n  }, n = Ao(t) ? {\n    height: window.innerHeight,\n    width: window.innerWidth\n  } : {\n    height: t.clientHeight,\n    width: t.clientWidth\n  }, s = {\n    x: t.scrollWidth - n.width,\n    y: t.scrollHeight - n.height\n  }, i = t.scrollTop <= e.y, r = t.scrollLeft <= e.x, o = t.scrollTop >= s.y, a = t.scrollLeft >= s.x;\n  return {\n    isTop: i,\n    isLeft: r,\n    isBottom: o,\n    isRight: a,\n    maxScroll: s,\n    minScroll: e\n  };\n}\nconst hc = {\n  x: 0.2,\n  y: 0.2\n};\nfunction fc(t, e, n, s, i) {\n  let {\n    top: r,\n    left: o,\n    right: a,\n    bottom: l\n  } = n;\n  s === void 0 && (s = 10), i === void 0 && (i = hc);\n  const {\n    isTop: u,\n    isBottom: c,\n    isLeft: d,\n    isRight: h\n  } = Po(t), f = {\n    x: 0,\n    y: 0\n  }, g = {\n    x: 0,\n    y: 0\n  }, v = {\n    height: e.height * i.y,\n    width: e.width * i.x\n  };\n  return !u && r <= e.top + v.height ? (f.y = at.Backward, g.y = s * Math.abs((e.top + v.height - r) / v.height)) : !c && l >= e.bottom - v.height && (f.y = at.Forward, g.y = s * Math.abs((e.bottom - v.height - l) / v.height)), !h && a >= e.right - v.width ? (f.x = at.Forward, g.x = s * Math.abs((e.right - v.width - a) / v.width)) : !d && o <= e.left + v.width && (f.x = at.Backward, g.x = s * Math.abs((e.left + v.width - o) / v.width)), {\n    direction: f,\n    speed: g\n  };\n}\nfunction pc(t) {\n  if (t === document.scrollingElement) {\n    const {\n      innerWidth: r,\n      innerHeight: o\n    } = window;\n    return {\n      top: 0,\n      left: 0,\n      right: r,\n      bottom: o,\n      width: r,\n      height: o\n    };\n  }\n  const {\n    top: e,\n    left: n,\n    right: s,\n    bottom: i\n  } = t.getBoundingClientRect();\n  return {\n    top: e,\n    left: n,\n    right: s,\n    bottom: i,\n    width: t.clientWidth,\n    height: t.clientHeight\n  };\n}\nfunction Ro(t) {\n  return t.reduce((e, n) => be(e, ms(n)), jt);\n}\nfunction mc(t) {\n  return t.reduce((e, n) => e + Do(n), 0);\n}\nfunction gc(t) {\n  return t.reduce((e, n) => e + Co(n), 0);\n}\nfunction yc(t, e) {\n  if (e === void 0 && (e = Ae), !t)\n    return;\n  const {\n    top: n,\n    left: s,\n    bottom: i,\n    right: r\n  } = e(t);\n  So(t) && (i <= 0 || r <= 0 || n >= window.innerHeight || s >= window.innerWidth) && t.scrollIntoView({\n    block: "center",\n    inline: "center"\n  });\n}\nconst vc = [["x", ["left", "right"], mc], ["y", ["top", "bottom"], gc]];\nclass Ks {\n  constructor(e, n) {\n    this.rect = void 0, this.width = void 0, this.height = void 0, this.top = void 0, this.bottom = void 0, this.right = void 0, this.left = void 0;\n    const s = Nn(n), i = Ro(s);\n    this.rect = {\n      ...e\n    }, this.width = e.width, this.height = e.height;\n    for (const [r, o, a] of vc)\n      for (const l of o)\n        Object.defineProperty(this, l, {\n          get: () => {\n            const u = a(s), c = i[r] - u;\n            return this.rect[l] + c;\n          },\n          enumerable: !0\n        });\n    Object.defineProperty(this, "rect", {\n      enumerable: !1\n    });\n  }\n}\nclass Oe {\n  constructor(e) {\n    this.target = void 0, this.listeners = [], this.removeAll = () => {\n      this.listeners.forEach((n) => {\n        var s;\n        return (s = this.target) == null ? void 0 : s.removeEventListener(...n);\n      });\n    }, this.target = e;\n  }\n  add(e, n, s) {\n    var i;\n    (i = this.target) == null || i.addEventListener(e, n, s), this.listeners.push([e, n, s]);\n  }\n}\nfunction xc(t) {\n  const {\n    EventTarget: e\n  } = vt(t);\n  return t instanceof e ? t : Ce(t);\n}\nfunction Wn(t, e) {\n  const n = Math.abs(t.x), s = Math.abs(t.y);\n  return typeof e == "number" ? Math.sqrt(n ** 2 + s ** 2) > e : "x" in e && "y" in e ? n > e.x && s > e.y : "x" in e ? n > e.x : "y" in e ? s > e.y : !1;\n}\nvar Pt;\n(function(t) {\n  t.Click = "click", t.DragStart = "dragstart", t.Keydown = "keydown", t.ContextMenu = "contextmenu", t.Resize = "resize", t.SelectionChange = "selectionchange", t.VisibilityChange = "visibilitychange";\n})(Pt || (Pt = {}));\nfunction _i(t) {\n  t.preventDefault();\n}\nfunction bc(t) {\n  t.stopPropagation();\n}\nvar $;\n(function(t) {\n  t.Space = "Space", t.Down = "ArrowDown", t.Right = "ArrowRight", t.Left = "ArrowLeft", t.Up = "ArrowUp", t.Esc = "Escape", t.Enter = "Enter", t.Tab = "Tab";\n})($ || ($ = {}));\nconst Mo = {\n  start: [$.Space, $.Enter],\n  cancel: [$.Esc],\n  end: [$.Space, $.Enter, $.Tab]\n}, wc = (t, e) => {\n  let {\n    currentCoordinates: n\n  } = e;\n  switch (t.code) {\n    case $.Right:\n      return {\n        ...n,\n        x: n.x + 25\n      };\n    case $.Left:\n      return {\n        ...n,\n        x: n.x - 25\n      };\n    case $.Down:\n      return {\n        ...n,\n        y: n.y + 25\n      };\n    case $.Up:\n      return {\n        ...n,\n        y: n.y - 25\n      };\n  }\n};\nclass Gs {\n  constructor(e) {\n    this.props = void 0, this.autoScrollEnabled = !1, this.referenceCoordinates = void 0, this.listeners = void 0, this.windowListeners = void 0, this.props = e;\n    const {\n      event: {\n        target: n\n      }\n    } = e;\n    this.props = e, this.listeners = new Oe(Ce(n)), this.windowListeners = new Oe(vt(n)), this.handleKeyDown = this.handleKeyDown.bind(this), this.handleCancel = this.handleCancel.bind(this), this.attach();\n  }\n  attach() {\n    this.handleStart(), this.windowListeners.add(Pt.Resize, this.handleCancel), this.windowListeners.add(Pt.VisibilityChange, this.handleCancel), setTimeout(() => this.listeners.add(Pt.Keydown, this.handleKeyDown));\n  }\n  handleStart() {\n    const {\n      activeNode: e,\n      onStart: n\n    } = this.props, s = e.node.current;\n    s && yc(s), n(jt);\n  }\n  handleKeyDown(e) {\n    if (Ws(e)) {\n      const {\n        active: n,\n        context: s,\n        options: i\n      } = this.props, {\n        keyboardCodes: r = Mo,\n        coordinateGetter: o = wc,\n        scrollBehavior: a = "smooth"\n      } = i, {\n        code: l\n      } = e;\n      if (r.end.includes(l)) {\n        this.handleEnd(e);\n        return;\n      }\n      if (r.cancel.includes(l)) {\n        this.handleCancel(e);\n        return;\n      }\n      const {\n        collisionRect: u\n      } = s.current, c = u ? {\n        x: u.left,\n        y: u.top\n      } : jt;\n      this.referenceCoordinates || (this.referenceCoordinates = c);\n      const d = o(e, {\n        active: n,\n        context: s.current,\n        currentCoordinates: c\n      });\n      if (d) {\n        const h = Ke(d, c), f = {\n          x: 0,\n          y: 0\n        }, {\n          scrollableAncestors: g\n        } = s.current;\n        for (const v of g) {\n          const y = e.code, {\n            isTop: x,\n            isRight: T,\n            isLeft: b,\n            isBottom: P,\n            maxScroll: D,\n            minScroll: R\n          } = Po(v), m = pc(v), w = {\n            x: Math.min(y === $.Right ? m.right - m.width / 2 : m.right, Math.max(y === $.Right ? m.left : m.left + m.width / 2, d.x)),\n            y: Math.min(y === $.Down ? m.bottom - m.height / 2 : m.bottom, Math.max(y === $.Down ? m.top : m.top + m.height / 2, d.y))\n          }, C = y === $.Right && !T || y === $.Left && !b, M = y === $.Down && !P || y === $.Up && !x;\n          if (C && w.x !== d.x) {\n            const S = v.scrollLeft + h.x, N = y === $.Right && S <= D.x || y === $.Left && S >= R.x;\n            if (N && !h.y) {\n              v.scrollTo({\n                left: S,\n                behavior: a\n              });\n              return;\n            }\n            N ? f.x = v.scrollLeft - S : f.x = y === $.Right ? v.scrollLeft - D.x : v.scrollLeft - R.x, f.x && v.scrollBy({\n              left: -f.x,\n              behavior: a\n            });\n            break;\n          } else if (M && w.y !== d.y) {\n            const S = v.scrollTop + h.y, N = y === $.Down && S <= D.y || y === $.Up && S >= R.y;\n            if (N && !h.x) {\n              v.scrollTo({\n                top: S,\n                behavior: a\n              });\n              return;\n            }\n            N ? f.y = v.scrollTop - S : f.y = y === $.Down ? v.scrollTop - D.y : v.scrollTop - R.y, f.y && v.scrollBy({\n              top: -f.y,\n              behavior: a\n            });\n            break;\n          }\n        }\n        this.handleMove(e, be(Ke(d, this.referenceCoordinates), f));\n      }\n    }\n  }\n  handleMove(e, n) {\n    const {\n      onMove: s\n    } = this.props;\n    e.preventDefault(), s(n);\n  }\n  handleEnd(e) {\n    const {\n      onEnd: n\n    } = this.props;\n    e.preventDefault(), this.detach(), n();\n  }\n  handleCancel(e) {\n    const {\n      onCancel: n\n    } = this.props;\n    e.preventDefault(), this.detach(), n();\n  }\n  detach() {\n    this.listeners.removeAll(), this.windowListeners.removeAll();\n  }\n}\nGs.activators = [{\n  eventName: "onKeyDown",\n  handler: (t, e, n) => {\n    let {\n      keyboardCodes: s = Mo,\n      onActivation: i\n    } = e, {\n      active: r\n    } = n;\n    const {\n      code: o\n    } = t.nativeEvent;\n    if (s.start.includes(o)) {\n      const a = r.activatorNode.current;\n      return a && t.target !== a ? !1 : (t.preventDefault(), i?.({\n        event: t.nativeEvent\n      }), !0);\n    }\n    return !1;\n  }\n}];\nfunction Ui(t) {\n  return !!(t && "distance" in t);\n}\nfunction zi(t) {\n  return !!(t && "delay" in t);\n}\nclass Hs {\n  constructor(e, n, s) {\n    var i;\n    s === void 0 && (s = xc(e.event.target)), this.props = void 0, this.events = void 0, this.autoScrollEnabled = !0, this.document = void 0, this.activated = !1, this.initialCoordinates = void 0, this.timeoutId = null, this.listeners = void 0, this.documentListeners = void 0, this.windowListeners = void 0, this.props = e, this.events = n;\n    const {\n      event: r\n    } = e, {\n      target: o\n    } = r;\n    this.props = e, this.events = n, this.document = Ce(o), this.documentListeners = new Oe(this.document), this.listeners = new Oe(s), this.windowListeners = new Oe(vt(o)), this.initialCoordinates = (i = ps(r)) != null ? i : jt, this.handleStart = this.handleStart.bind(this), this.handleMove = this.handleMove.bind(this), this.handleEnd = this.handleEnd.bind(this), this.handleCancel = this.handleCancel.bind(this), this.handleKeydown = this.handleKeydown.bind(this), this.removeTextSelection = this.removeTextSelection.bind(this), this.attach();\n  }\n  attach() {\n    const {\n      events: e,\n      props: {\n        options: {\n          activationConstraint: n,\n          bypassActivationConstraint: s\n        }\n      }\n    } = this;\n    if (this.listeners.add(e.move.name, this.handleMove, {\n      passive: !1\n    }), this.listeners.add(e.end.name, this.handleEnd), e.cancel && this.listeners.add(e.cancel.name, this.handleCancel), this.windowListeners.add(Pt.Resize, this.handleCancel), this.windowListeners.add(Pt.DragStart, _i), this.windowListeners.add(Pt.VisibilityChange, this.handleCancel), this.windowListeners.add(Pt.ContextMenu, _i), this.documentListeners.add(Pt.Keydown, this.handleKeydown), n) {\n      if (s != null && s({\n        event: this.props.event,\n        activeNode: this.props.activeNode,\n        options: this.props.options\n      }))\n        return this.handleStart();\n      if (zi(n)) {\n        this.timeoutId = setTimeout(this.handleStart, n.delay), this.handlePending(n);\n        return;\n      }\n      if (Ui(n)) {\n        this.handlePending(n);\n        return;\n      }\n    }\n    this.handleStart();\n  }\n  detach() {\n    this.listeners.removeAll(), this.windowListeners.removeAll(), setTimeout(this.documentListeners.removeAll, 50), this.timeoutId !== null && (clearTimeout(this.timeoutId), this.timeoutId = null);\n  }\n  handlePending(e, n) {\n    const {\n      active: s,\n      onPending: i\n    } = this.props;\n    i(s, e, this.initialCoordinates, n);\n  }\n  handleStart() {\n    const {\n      initialCoordinates: e\n    } = this, {\n      onStart: n\n    } = this.props;\n    e && (this.activated = !0, this.documentListeners.add(Pt.Click, bc, {\n      capture: !0\n    }), this.removeTextSelection(), this.documentListeners.add(Pt.SelectionChange, this.removeTextSelection), n(e));\n  }\n  handleMove(e) {\n    var n;\n    const {\n      activated: s,\n      initialCoordinates: i,\n      props: r\n    } = this, {\n      onMove: o,\n      options: {\n        activationConstraint: a\n      }\n    } = r;\n    if (!i)\n      return;\n    const l = (n = ps(e)) != null ? n : jt, u = Ke(i, l);\n    if (!s && a) {\n      if (Ui(a)) {\n        if (a.tolerance != null && Wn(u, a.tolerance))\n          return this.handleCancel();\n        if (Wn(u, a.distance))\n          return this.handleStart();\n      }\n      if (zi(a) && Wn(u, a.tolerance))\n        return this.handleCancel();\n      this.handlePending(a, u);\n      return;\n    }\n    e.cancelable && e.preventDefault(), o(l);\n  }\n  handleEnd() {\n    const {\n      onAbort: e,\n      onEnd: n\n    } = this.props;\n    this.detach(), this.activated || e(this.props.active), n();\n  }\n  handleCancel() {\n    const {\n      onAbort: e,\n      onCancel: n\n    } = this.props;\n    this.detach(), this.activated || e(this.props.active), n();\n  }\n  handleKeydown(e) {\n    e.code === $.Esc && this.handleCancel();\n  }\n  removeTextSelection() {\n    var e;\n    (e = this.document.getSelection()) == null || e.removeAllRanges();\n  }\n}\nconst Tc = {\n  cancel: {\n    name: "pointercancel"\n  },\n  move: {\n    name: "pointermove"\n  },\n  end: {\n    name: "pointerup"\n  }\n};\nclass Xs extends Hs {\n  constructor(e) {\n    const {\n      event: n\n    } = e, s = Ce(n.target);\n    super(e, Tc, s);\n  }\n}\nXs.activators = [{\n  eventName: "onPointerDown",\n  handler: (t, e) => {\n    let {\n      nativeEvent: n\n    } = t, {\n      onActivation: s\n    } = e;\n    return !n.isPrimary || n.button !== 0 ? !1 : (s?.({\n      event: n\n    }), !0);\n  }\n}];\nconst Sc = {\n  move: {\n    name: "mousemove"\n  },\n  end: {\n    name: "mouseup"\n  }\n};\nvar gs;\n(function(t) {\n  t[t.RightClick = 2] = "RightClick";\n})(gs || (gs = {}));\nclass Dc extends Hs {\n  constructor(e) {\n    super(e, Sc, Ce(e.event.target));\n  }\n}\nDc.activators = [{\n  eventName: "onMouseDown",\n  handler: (t, e) => {\n    let {\n      nativeEvent: n\n    } = t, {\n      onActivation: s\n    } = e;\n    return n.button === gs.RightClick ? !1 : (s?.({\n      event: n\n    }), !0);\n  }\n}];\nconst Kn = {\n  cancel: {\n    name: "touchcancel"\n  },\n  move: {\n    name: "touchmove"\n  },\n  end: {\n    name: "touchend"\n  }\n};\nclass Cc extends Hs {\n  constructor(e) {\n    super(e, Kn);\n  }\n  static setup() {\n    return window.addEventListener(Kn.move.name, e, {\n      capture: !1,\n      passive: !1\n    }), function() {\n      window.removeEventListener(Kn.move.name, e);\n    };\n    function e() {\n    }\n  }\n}\nCc.activators = [{\n  eventName: "onTouchStart",\n  handler: (t, e) => {\n    let {\n      nativeEvent: n\n    } = t, {\n      onActivation: s\n    } = e;\n    const {\n      touches: i\n    } = n;\n    return i.length > 1 ? !1 : (s?.({\n      event: n\n    }), !0);\n  }\n}];\nvar Fe;\n(function(t) {\n  t[t.Pointer = 0] = "Pointer", t[t.DraggableRect = 1] = "DraggableRect";\n})(Fe || (Fe = {}));\nvar Tn;\n(function(t) {\n  t[t.TreeOrder = 0] = "TreeOrder", t[t.ReversedTreeOrder = 1] = "ReversedTreeOrder";\n})(Tn || (Tn = {}));\nfunction Ac(t) {\n  let {\n    acceleration: e,\n    activator: n = Fe.Pointer,\n    canScroll: s,\n    draggingRect: i,\n    enabled: r,\n    interval: o = 5,\n    order: a = Tn.TreeOrder,\n    pointerCoordinates: l,\n    scrollableAncestors: u,\n    scrollableAncestorRects: c,\n    delta: d,\n    threshold: h\n  } = t;\n  const f = Rc({\n    delta: d,\n    disabled: !r\n  }), [g, v] = Fl(), y = j({\n    x: 0,\n    y: 0\n  }), x = j({\n    x: 0,\n    y: 0\n  }), T = W(() => {\n    switch (n) {\n      case Fe.Pointer:\n        return l ? {\n          top: l.y,\n          bottom: l.y,\n          left: l.x,\n          right: l.x\n        } : null;\n      case Fe.DraggableRect:\n        return i;\n    }\n  }, [n, i, l]), b = j(null), P = lt(() => {\n    const R = b.current;\n    if (!R)\n      return;\n    const m = y.current.x * x.current.x, w = y.current.y * x.current.y;\n    R.scrollBy(m, w);\n  }, []), D = W(() => a === Tn.TreeOrder ? [...u].reverse() : u, [a, u]);\n  B(\n    () => {\n      if (!r || !u.length || !T) {\n        v();\n        return;\n      }\n      for (const R of D) {\n        if (s?.(R) === !1)\n          continue;\n        const m = u.indexOf(R), w = c[m];\n        if (!w)\n          continue;\n        const {\n          direction: C,\n          speed: M\n        } = fc(R, w, T, e, h);\n        for (const S of ["x", "y"])\n          f[S][C[S]] || (M[S] = 0, C[S] = 0);\n        if (M.x > 0 || M.y > 0) {\n          v(), b.current = R, g(P, o), y.current = M, x.current = C;\n          return;\n        }\n      }\n      y.current = {\n        x: 0,\n        y: 0\n      }, x.current = {\n        x: 0,\n        y: 0\n      }, v();\n    },\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n    [\n      e,\n      P,\n      s,\n      v,\n      r,\n      o,\n      // eslint-disable-next-line react-hooks/exhaustive-deps\n      JSON.stringify(T),\n      // eslint-disable-next-line react-hooks/exhaustive-deps\n      JSON.stringify(f),\n      g,\n      u,\n      D,\n      c,\n      // eslint-disable-next-line react-hooks/exhaustive-deps\n      JSON.stringify(h)\n    ]\n  );\n}\nconst Pc = {\n  x: {\n    [at.Backward]: !1,\n    [at.Forward]: !1\n  },\n  y: {\n    [at.Backward]: !1,\n    [at.Forward]: !1\n  }\n};\nfunction Rc(t) {\n  let {\n    delta: e,\n    disabled: n\n  } = t;\n  const s = fs(e);\n  return tn((i) => {\n    if (n || !s || !i)\n      return Pc;\n    const r = {\n      x: Math.sign(e.x - s.x),\n      y: Math.sign(e.y - s.y)\n    };\n    return {\n      x: {\n        [at.Backward]: i.x[at.Backward] || r.x === -1,\n        [at.Forward]: i.x[at.Forward] || r.x === 1\n      },\n      y: {\n        [at.Backward]: i.y[at.Backward] || r.y === -1,\n        [at.Forward]: i.y[at.Forward] || r.y === 1\n      }\n    };\n  }, [n, e, s]);\n}\nfunction Mc(t, e) {\n  const n = e != null ? t.get(e) : void 0, s = n ? n.node.current : null;\n  return tn((i) => {\n    var r;\n    return e == null ? null : (r = s ?? i) != null ? r : null;\n  }, [s, e]);\n}\nfunction Ec(t, e) {\n  return W(() => t.reduce((n, s) => {\n    const {\n      sensor: i\n    } = s, r = i.activators.map((o) => ({\n      eventName: o.eventName,\n      handler: e(o.handler, s)\n    }));\n    return [...n, ...r];\n  }, []), [t, e]);\n}\nvar He;\n(function(t) {\n  t[t.Always = 0] = "Always", t[t.BeforeDragging = 1] = "BeforeDragging", t[t.WhileDragging = 2] = "WhileDragging";\n})(He || (He = {}));\nvar ys;\n(function(t) {\n  t.Optimized = "optimized";\n})(ys || (ys = {}));\nconst Wi = /* @__PURE__ */ new Map();\nfunction Vc(t, e) {\n  let {\n    dragging: n,\n    dependencies: s,\n    config: i\n  } = e;\n  const [r, o] = L(null), {\n    frequency: a,\n    measure: l,\n    strategy: u\n  } = i, c = j(t), d = y(), h = We(d), f = lt(function(x) {\n    x === void 0 && (x = []), !h.current && o((T) => T === null ? x : T.concat(x.filter((b) => !T.includes(b))));\n  }, [h]), g = j(null), v = tn((x) => {\n    if (d && !n)\n      return Wi;\n    if (!x || x === Wi || c.current !== t || r != null) {\n      const T = /* @__PURE__ */ new Map();\n      for (let b of t) {\n        if (!b)\n          continue;\n        if (r && r.length > 0 && !r.includes(b.id) && b.rect.current) {\n          T.set(b.id, b.rect.current);\n          continue;\n        }\n        const P = b.node.current, D = P ? new Ks(l(P), P) : null;\n        b.rect.current = D, D && T.set(b.id, D);\n      }\n      return T;\n    }\n    return x;\n  }, [t, r, n, d, l]);\n  return B(() => {\n    c.current = t;\n  }, [t]), B(\n    () => {\n      d || f();\n    },\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n    [n, d]\n  ), B(\n    () => {\n      r && r.length > 0 && o(null);\n    },\n    //eslint-disable-next-line react-hooks/exhaustive-deps\n    [JSON.stringify(r)]\n  ), B(\n    () => {\n      d || typeof a != "number" || g.current !== null || (g.current = setTimeout(() => {\n        f(), g.current = null;\n      }, a));\n    },\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n    [a, d, f, ...s]\n  ), {\n    droppableRects: v,\n    measureDroppableContainers: f,\n    measuringScheduled: r != null\n  };\n  function y() {\n    switch (u) {\n      case He.Always:\n        return !1;\n      case He.BeforeDragging:\n        return n;\n      default:\n        return !n;\n    }\n  }\n}\nfunction Eo(t, e) {\n  return tn((n) => t ? n || (typeof e == "function" ? e(t) : t) : null, [e, t]);\n}\nfunction Nc(t, e) {\n  return Eo(t, e);\n}\nfunction kc(t) {\n  let {\n    callback: e,\n    disabled: n\n  } = t;\n  const s = zs(e), i = W(() => {\n    if (n || typeof window > "u" || typeof window.MutationObserver > "u")\n      return;\n    const {\n      MutationObserver: r\n    } = window;\n    return new r(s);\n  }, [s, n]);\n  return B(() => () => i?.disconnect(), [i]), i;\n}\nfunction kn(t) {\n  let {\n    callback: e,\n    disabled: n\n  } = t;\n  const s = zs(e), i = W(\n    () => {\n      if (n || typeof window > "u" || typeof window.ResizeObserver > "u")\n        return;\n      const {\n        ResizeObserver: r\n      } = window;\n      return new r(s);\n    },\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n    [n]\n  );\n  return B(() => () => i?.disconnect(), [i]), i;\n}\nfunction Ic(t) {\n  return new Ks(Ae(t), t);\n}\nfunction Ki(t, e, n) {\n  e === void 0 && (e = Ic);\n  const [s, i] = L(null);\n  function r() {\n    i((l) => {\n      if (!t)\n        return null;\n      if (t.isConnected === !1) {\n        var u;\n        return (u = l ?? n) != null ? u : null;\n      }\n      const c = e(t);\n      return JSON.stringify(l) === JSON.stringify(c) ? l : c;\n    });\n  }\n  const o = kc({\n    callback(l) {\n      if (t)\n        for (const u of l) {\n          const {\n            type: c,\n            target: d\n          } = u;\n          if (c === "childList" && d instanceof HTMLElement && d.contains(t)) {\n            r();\n            break;\n          }\n        }\n    }\n  }), a = kn({\n    callback: r\n  });\n  return Wt(() => {\n    r(), t ? (a?.observe(t), o?.observe(document.body, {\n      childList: !0,\n      subtree: !0\n    })) : (a?.disconnect(), o?.disconnect());\n  }, [t]), s;\n}\nfunction jc(t) {\n  const e = Eo(t);\n  return To(t, e);\n}\nconst Gi = [];\nfunction Lc(t) {\n  const e = j(t), n = tn((s) => t ? s && s !== Gi && t && e.current && t.parentNode === e.current.parentNode ? s : Nn(t) : Gi, [t]);\n  return B(() => {\n    e.current = t;\n  }, [t]), n;\n}\nfunction Oc(t) {\n  const [e, n] = L(null), s = j(t), i = lt((r) => {\n    const o = zn(r.target);\n    o && n((a) => a ? (a.set(o, ms(o)), new Map(a)) : null);\n  }, []);\n  return B(() => {\n    const r = s.current;\n    if (t !== r) {\n      o(r);\n      const a = t.map((l) => {\n        const u = zn(l);\n        return u ? (u.addEventListener("scroll", i, {\n          passive: !0\n        }), [u, ms(u)]) : null;\n      }).filter((l) => l != null);\n      n(a.length ? new Map(a) : null), s.current = t;\n    }\n    return () => {\n      o(t), o(r);\n    };\n    function o(a) {\n      a.forEach((l) => {\n        const u = zn(l);\n        u?.removeEventListener("scroll", i);\n      });\n    }\n  }, [i, t]), W(() => t.length ? e ? Array.from(e.values()).reduce((r, o) => be(r, o), jt) : Ro(t) : jt, [t, e]);\n}\nfunction Hi(t, e) {\n  e === void 0 && (e = []);\n  const n = j(null);\n  return B(\n    () => {\n      n.current = null;\n    },\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n    e\n  ), B(() => {\n    const s = t !== jt;\n    s && !n.current && (n.current = t), !s && n.current && (n.current = null);\n  }, [t]), n.current ? Ke(t, n.current) : jt;\n}\nfunction Fc(t) {\n  B(\n    () => {\n      if (!Vn)\n        return;\n      const e = t.map((n) => {\n        let {\n          sensor: s\n        } = n;\n        return s.setup == null ? void 0 : s.setup();\n      });\n      return () => {\n        for (const n of e)\n          n?.();\n      };\n    },\n    // TO-DO: Sensors length could theoretically change which would not be a valid dependency\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n    t.map((e) => {\n      let {\n        sensor: n\n      } = e;\n      return n;\n    })\n  );\n}\nfunction Bc(t, e) {\n  return W(() => t.reduce((n, s) => {\n    let {\n      eventName: i,\n      handler: r\n    } = s;\n    return n[i] = (o) => {\n      r(o, e);\n    }, n;\n  }, {}), [t, e]);\n}\nfunction Vo(t) {\n  return W(() => t ? cc(t) : null, [t]);\n}\nconst Xi = [];\nfunction $c(t, e) {\n  e === void 0 && (e = Ae);\n  const [n] = t, s = Vo(n ? vt(n) : null), [i, r] = L(Xi);\n  function o() {\n    r(() => t.length ? t.map((l) => Ao(l) ? s : new Ks(e(l), l)) : Xi);\n  }\n  const a = kn({\n    callback: o\n  });\n  return Wt(() => {\n    a?.disconnect(), o(), t.forEach((l) => a?.observe(l));\n  }, [t]), i;\n}\nfunction _c(t) {\n  if (!t)\n    return null;\n  if (t.children.length > 1)\n    return t;\n  const e = t.children[0];\n  return Qe(e) ? e : t;\n}\nfunction Uc(t) {\n  let {\n    measure: e\n  } = t;\n  const [n, s] = L(null), i = lt((u) => {\n    for (const {\n      target: c\n    } of u)\n      if (Qe(c)) {\n        s((d) => {\n          const h = e(c);\n          return d ? {\n            ...d,\n            width: h.width,\n            height: h.height\n          } : h;\n        });\n        break;\n      }\n  }, [e]), r = kn({\n    callback: i\n  }), o = lt((u) => {\n    const c = _c(u);\n    r?.disconnect(), c && r?.observe(c), s(c ? e(c) : null);\n  }, [e, r]), [a, l] = bn(o);\n  return W(() => ({\n    nodeRef: a,\n    rect: n,\n    setRef: l\n  }), [n, a, l]);\n}\nconst zc = [{\n  sensor: Xs,\n  options: {}\n}, {\n  sensor: Gs,\n  options: {}\n}], Wc = {\n  current: {}\n}, mn = {\n  draggable: {\n    measure: $i\n  },\n  droppable: {\n    measure: $i,\n    strategy: He.WhileDragging,\n    frequency: ys.Optimized\n  },\n  dragOverlay: {\n    measure: Ae\n  }\n};\nclass Be extends Map {\n  get(e) {\n    var n;\n    return e != null && (n = super.get(e)) != null ? n : void 0;\n  }\n  toArray() {\n    return Array.from(this.values());\n  }\n  getEnabled() {\n    return this.toArray().filter((e) => {\n      let {\n        disabled: n\n      } = e;\n      return !n;\n    });\n  }\n  getNodeFor(e) {\n    var n, s;\n    return (n = (s = this.get(e)) == null ? void 0 : s.node.current) != null ? n : void 0;\n  }\n}\nconst Kc = {\n  activatorEvent: null,\n  active: null,\n  activeNode: null,\n  activeNodeRect: null,\n  collisions: null,\n  containerNodeRect: null,\n  draggableNodes: /* @__PURE__ */ new Map(),\n  droppableRects: /* @__PURE__ */ new Map(),\n  droppableContainers: /* @__PURE__ */ new Be(),\n  over: null,\n  dragOverlay: {\n    nodeRef: {\n      current: null\n    },\n    rect: null,\n    setRef: wn\n  },\n  scrollableAncestors: [],\n  scrollableAncestorRects: [],\n  measuringConfiguration: mn,\n  measureDroppableContainers: wn,\n  windowRect: null,\n  measuringScheduled: !1\n}, Gc = {\n  activatorEvent: null,\n  activators: [],\n  active: null,\n  activeNodeRect: null,\n  ariaDescribedById: {\n    draggable: ""\n  },\n  dispatch: wn,\n  draggableNodes: /* @__PURE__ */ new Map(),\n  over: null,\n  measureDroppableContainers: wn\n}, In = /* @__PURE__ */ Lt(Gc), No = /* @__PURE__ */ Lt(Kc);\nfunction Hc() {\n  return {\n    draggable: {\n      active: null,\n      initialCoordinates: {\n        x: 0,\n        y: 0\n      },\n      nodes: /* @__PURE__ */ new Map(),\n      translate: {\n        x: 0,\n        y: 0\n      }\n    },\n    droppable: {\n      containers: new Be()\n    }\n  };\n}\nfunction Xc(t, e) {\n  switch (e.type) {\n    case it.DragStart:\n      return {\n        ...t,\n        draggable: {\n          ...t.draggable,\n          initialCoordinates: e.initialCoordinates,\n          active: e.active\n        }\n      };\n    case it.DragMove:\n      return t.draggable.active == null ? t : {\n        ...t,\n        draggable: {\n          ...t.draggable,\n          translate: {\n            x: e.coordinates.x - t.draggable.initialCoordinates.x,\n            y: e.coordinates.y - t.draggable.initialCoordinates.y\n          }\n        }\n      };\n    case it.DragEnd:\n    case it.DragCancel:\n      return {\n        ...t,\n        draggable: {\n          ...t.draggable,\n          active: null,\n          initialCoordinates: {\n            x: 0,\n            y: 0\n          },\n          translate: {\n            x: 0,\n            y: 0\n          }\n        }\n      };\n    case it.RegisterDroppable: {\n      const {\n        element: n\n      } = e, {\n        id: s\n      } = n, i = new Be(t.droppable.containers);\n      return i.set(s, n), {\n        ...t,\n        droppable: {\n          ...t.droppable,\n          containers: i\n        }\n      };\n    }\n    case it.SetDroppableDisabled: {\n      const {\n        id: n,\n        key: s,\n        disabled: i\n      } = e, r = t.droppable.containers.get(n);\n      if (!r || s !== r.key)\n        return t;\n      const o = new Be(t.droppable.containers);\n      return o.set(n, {\n        ...r,\n        disabled: i\n      }), {\n        ...t,\n        droppable: {\n          ...t.droppable,\n          containers: o\n        }\n      };\n    }\n    case it.UnregisterDroppable: {\n      const {\n        id: n,\n        key: s\n      } = e, i = t.droppable.containers.get(n);\n      if (!i || s !== i.key)\n        return t;\n      const r = new Be(t.droppable.containers);\n      return r.delete(n), {\n        ...t,\n        droppable: {\n          ...t.droppable,\n          containers: r\n        }\n      };\n    }\n    default:\n      return t;\n  }\n}\nfunction Yc(t) {\n  let {\n    disabled: e\n  } = t;\n  const {\n    active: n,\n    activatorEvent: s,\n    draggableNodes: i\n  } = q(In), r = fs(s), o = fs(n?.id);\n  return B(() => {\n    if (!e && !s && r && o != null) {\n      if (!Ws(r) || document.activeElement === r.target)\n        return;\n      const a = i.get(o);\n      if (!a)\n        return;\n      const {\n        activatorNode: l,\n        node: u\n      } = a;\n      if (!l.current && !u.current)\n        return;\n      requestAnimationFrame(() => {\n        for (const c of [l.current, u.current]) {\n          if (!c)\n            continue;\n          const d = _l(c);\n          if (d) {\n            d.focus();\n            break;\n          }\n        }\n      });\n    }\n  }, [s, e, i, o, r]), null;\n}\nfunction qc(t, e) {\n  let {\n    transform: n,\n    ...s\n  } = e;\n  return t != null && t.length ? t.reduce((i, r) => r({\n    transform: i,\n    ...s\n  }), n) : n;\n}\nfunction Jc(t) {\n  return W(\n    () => ({\n      draggable: {\n        ...mn.draggable,\n        ...t?.draggable\n      },\n      droppable: {\n        ...mn.droppable,\n        ...t?.droppable\n      },\n      dragOverlay: {\n        ...mn.dragOverlay,\n        ...t?.dragOverlay\n      }\n    }),\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n    [t?.draggable, t?.droppable, t?.dragOverlay]\n  );\n}\nfunction Zc(t) {\n  let {\n    activeNode: e,\n    measure: n,\n    initialRect: s,\n    config: i = !0\n  } = t;\n  const r = j(!1), {\n    x: o,\n    y: a\n  } = typeof i == "boolean" ? {\n    x: i,\n    y: i\n  } : i;\n  Wt(() => {\n    if (!o && !a || !e) {\n      r.current = !1;\n      return;\n    }\n    if (r.current || !s)\n      return;\n    const u = e?.node.current;\n    if (!u || u.isConnected === !1)\n      return;\n    const c = n(u), d = To(c, s);\n    if (o || (d.x = 0), a || (d.y = 0), r.current = !0, Math.abs(d.x) > 0 || Math.abs(d.y) > 0) {\n      const h = So(u);\n      h && h.scrollBy({\n        top: d.y,\n        left: d.x\n      });\n    }\n  }, [e, o, a, s, n]);\n}\nconst ko = /* @__PURE__ */ Lt({\n  ...jt,\n  scaleX: 1,\n  scaleY: 1\n});\nvar te;\n(function(t) {\n  t[t.Uninitialized = 0] = "Uninitialized", t[t.Initializing = 1] = "Initializing", t[t.Initialized = 2] = "Initialized";\n})(te || (te = {}));\nconst Qc = /* @__PURE__ */ Pl(function(e) {\n  var n, s, i, r;\n  let {\n    id: o,\n    accessibility: a,\n    autoScroll: l = !0,\n    children: u,\n    sensors: c = zc,\n    collisionDetection: d = nc,\n    measuring: h,\n    modifiers: f,\n    ...g\n  } = e;\n  const v = Rl(Xc, void 0, Hc), [y, x] = v, [T, b] = Hl(), [P, D] = L(te.Uninitialized), R = P === te.Initialized, {\n    draggable: {\n      active: m,\n      nodes: w,\n      translate: C\n    },\n    droppable: {\n      containers: M\n    }\n  } = y, S = m != null ? w.get(m) : null, N = j({\n    initial: null,\n    translated: null\n  }), O = W(() => {\n    var ht;\n    return m != null ? {\n      id: m,\n      // It\'s possible for the active node to unmount while dragging\n      data: (ht = S?.data) != null ? ht : Wc,\n      rect: N\n    } : null;\n  }, [m, S]), F = j(null), [G, _] = L(null), [k, U] = L(null), H = We(g, Object.values(g)), tt = en("DndDescribedBy", o), et = W(() => M.getEnabled(), [M]), X = Jc(h), {\n    droppableRects: dt,\n    measureDroppableContainers: xt,\n    measuringScheduled: Ot\n  } = Vc(et, {\n    dragging: R,\n    dependencies: [C.x, C.y],\n    config: X.droppable\n  }), pt = Mc(w, m), ie = W(() => k ? ps(k) : null, [k]), Ft = Al(), Et = Nc(pt, X.draggable.measure);\n  Zc({\n    activeNode: m != null ? w.get(m) : null,\n    config: Ft.layoutShiftCompensation,\n    initialRect: Et,\n    measure: X.draggable.measure\n  });\n  const K = Ki(pt, X.draggable.measure, Et), re = Ki(pt ? pt.parentElement : null), St = j({\n    activatorEvent: null,\n    active: null,\n    activeNode: pt,\n    collisionRect: null,\n    collisions: null,\n    droppableRects: dt,\n    draggableNodes: w,\n    draggingNode: null,\n    draggingNodeRect: null,\n    droppableContainers: M,\n    over: null,\n    scrollableAncestors: [],\n    scrollAdjustedTranslate: null\n  }), Xt = M.getNodeFor((n = St.current.over) == null ? void 0 : n.id), A = Uc({\n    measure: X.dragOverlay.measure\n  }), V = (s = A.nodeRef.current) != null ? s : pt, E = R ? (i = A.rect) != null ? i : K : null, z = !!(A.nodeRef.current && A.rect), Z = jc(z ? null : K), rt = Vo(V ? vt(V) : null), ot = Lc(R ? Xt ?? pt : null), Vt = $c(ot), Dt = qc(f, {\n    transform: {\n      x: C.x - Z.x,\n      y: C.y - Z.y,\n      scaleX: 1,\n      scaleY: 1\n    },\n    activatorEvent: k,\n    active: O,\n    activeNodeRect: K,\n    containerNodeRect: re,\n    draggingNodeRect: E,\n    over: St.current.over,\n    overlayNodeRect: A.rect,\n    scrollableAncestors: ot,\n    scrollableAncestorRects: Vt,\n    windowRect: rt\n  }), Nt = ie ? be(ie, C) : null, an = Oc(ot), xl = Hi(an), bl = Hi(an, [K]), he = be(Dt, xl), fe = E ? rc(E, Dt) : null, Ee = O && fe ? d({\n    active: O,\n    collisionRect: fe,\n    droppableRects: dt,\n    droppableContainers: et,\n    pointerCoordinates: Nt\n  }) : null, Ei = wo(Ee, "id"), [Yt, Vi] = L(null), wl = z ? Dt : be(Dt, bl), Tl = sc(wl, (r = Yt?.rect) != null ? r : null, K), Bn = j(null), Ni = lt(\n    (ht, bt) => {\n      let {\n        sensor: wt,\n        options: qt\n      } = bt;\n      if (F.current == null)\n        return;\n      const Ct = w.get(F.current);\n      if (!Ct)\n        return;\n      const Tt = ht.nativeEvent, Bt = new wt({\n        active: F.current,\n        activeNode: Ct,\n        event: Tt,\n        options: qt,\n        // Sensors need to be instantiated with refs for arguments that change over time\n        // otherwise they are frozen in time with the stale arguments\n        context: St,\n        onAbort(ct) {\n          if (!w.get(ct))\n            return;\n          const {\n            onDragAbort: $t\n          } = H.current, Kt = {\n            id: ct\n          };\n          $t?.(Kt), T({\n            type: "onDragAbort",\n            event: Kt\n          });\n        },\n        onPending(ct, Jt, $t, Kt) {\n          if (!w.get(ct))\n            return;\n          const {\n            onDragPending: Ne\n          } = H.current, Zt = {\n            id: ct,\n            constraint: Jt,\n            initialCoordinates: $t,\n            offset: Kt\n          };\n          Ne?.(Zt), T({\n            type: "onDragPending",\n            event: Zt\n          });\n        },\n        onStart(ct) {\n          const Jt = F.current;\n          if (Jt == null)\n            return;\n          const $t = w.get(Jt);\n          if (!$t)\n            return;\n          const {\n            onDragStart: Kt\n          } = H.current, Ve = {\n            activatorEvent: Tt,\n            active: {\n              id: Jt,\n              data: $t.data,\n              rect: N\n            }\n          };\n          ln(() => {\n            Kt?.(Ve), D(te.Initializing), x({\n              type: it.DragStart,\n              initialCoordinates: ct,\n              active: Jt\n            }), T({\n              type: "onDragStart",\n              event: Ve\n            }), _(Bn.current), U(Tt);\n          });\n        },\n        onMove(ct) {\n          x({\n            type: it.DragMove,\n            coordinates: ct\n          });\n        },\n        onEnd: pe(it.DragEnd),\n        onCancel: pe(it.DragCancel)\n      });\n      Bn.current = Bt;\n      function pe(ct) {\n        return async function() {\n          const {\n            active: $t,\n            collisions: Kt,\n            over: Ve,\n            scrollAdjustedTranslate: Ne\n          } = St.current;\n          let Zt = null;\n          if ($t && Ne) {\n            const {\n              cancelDrop: ke\n            } = H.current;\n            Zt = {\n              activatorEvent: Tt,\n              active: $t,\n              collisions: Kt,\n              delta: Ne,\n              over: Ve\n            }, ct === it.DragEnd && typeof ke == "function" && await Promise.resolve(ke(Zt)) && (ct = it.DragCancel);\n          }\n          F.current = null, ln(() => {\n            x({\n              type: ct\n            }), D(te.Uninitialized), Vi(null), _(null), U(null), Bn.current = null;\n            const ke = ct === it.DragEnd ? "onDragEnd" : "onDragCancel";\n            if (Zt) {\n              const $n = H.current[ke];\n              $n?.(Zt), T({\n                type: ke,\n                event: Zt\n              });\n            }\n          });\n        };\n      }\n    },\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n    [w]\n  ), Sl = lt((ht, bt) => (wt, qt) => {\n    const Ct = wt.nativeEvent, Tt = w.get(qt);\n    if (\n      // Another sensor is already instantiating\n      F.current !== null || // No active draggable\n      !Tt || // Event has already been captured\n      Ct.dndKit || Ct.defaultPrevented\n    )\n      return;\n    const Bt = {\n      active: Tt\n    };\n    ht(wt, bt.options, Bt) === !0 && (Ct.dndKit = {\n      capturedBy: bt.sensor\n    }, F.current = qt, Ni(wt, bt));\n  }, [w, Ni]), ki = Ec(c, Sl);\n  Fc(c), Wt(() => {\n    K && P === te.Initializing && D(te.Initialized);\n  }, [K, P]), B(\n    () => {\n      const {\n        onDragMove: ht\n      } = H.current, {\n        active: bt,\n        activatorEvent: wt,\n        collisions: qt,\n        over: Ct\n      } = St.current;\n      if (!bt || !wt)\n        return;\n      const Tt = {\n        active: bt,\n        activatorEvent: wt,\n        collisions: qt,\n        delta: {\n          x: he.x,\n          y: he.y\n        },\n        over: Ct\n      };\n      ln(() => {\n        ht?.(Tt), T({\n          type: "onDragMove",\n          event: Tt\n        });\n      });\n    },\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n    [he.x, he.y]\n  ), B(\n    () => {\n      const {\n        active: ht,\n        activatorEvent: bt,\n        collisions: wt,\n        droppableContainers: qt,\n        scrollAdjustedTranslate: Ct\n      } = St.current;\n      if (!ht || F.current == null || !bt || !Ct)\n        return;\n      const {\n        onDragOver: Tt\n      } = H.current, Bt = qt.get(Ei), pe = Bt && Bt.rect.current ? {\n        id: Bt.id,\n        rect: Bt.rect.current,\n        data: Bt.data,\n        disabled: Bt.disabled\n      } : null, ct = {\n        active: ht,\n        activatorEvent: bt,\n        collisions: wt,\n        delta: {\n          x: Ct.x,\n          y: Ct.y\n        },\n        over: pe\n      };\n      ln(() => {\n        Vi(pe), Tt?.(ct), T({\n          type: "onDragOver",\n          event: ct\n        });\n      });\n    },\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n    [Ei]\n  ), Wt(() => {\n    St.current = {\n      activatorEvent: k,\n      active: O,\n      activeNode: pt,\n      collisionRect: fe,\n      collisions: Ee,\n      droppableRects: dt,\n      draggableNodes: w,\n      draggingNode: V,\n      draggingNodeRect: E,\n      droppableContainers: M,\n      over: Yt,\n      scrollableAncestors: ot,\n      scrollAdjustedTranslate: he\n    }, N.current = {\n      initial: E,\n      translated: fe\n    };\n  }, [O, pt, Ee, fe, w, V, E, dt, M, Yt, ot, he]), Ac({\n    ...Ft,\n    delta: C,\n    draggingRect: fe,\n    pointerCoordinates: Nt,\n    scrollableAncestors: ot,\n    scrollableAncestorRects: Vt\n  });\n  const Dl = W(() => ({\n    active: O,\n    activeNode: pt,\n    activeNodeRect: K,\n    activatorEvent: k,\n    collisions: Ee,\n    containerNodeRect: re,\n    dragOverlay: A,\n    draggableNodes: w,\n    droppableContainers: M,\n    droppableRects: dt,\n    over: Yt,\n    measureDroppableContainers: xt,\n    scrollableAncestors: ot,\n    scrollableAncestorRects: Vt,\n    measuringConfiguration: X,\n    measuringScheduled: Ot,\n    windowRect: rt\n  }), [O, pt, K, k, Ee, re, A, w, M, dt, Yt, xt, ot, Vt, X, Ot, rt]), Cl = W(() => ({\n    activatorEvent: k,\n    activators: ki,\n    active: O,\n    activeNodeRect: K,\n    ariaDescribedById: {\n      draggable: tt\n    },\n    dispatch: x,\n    draggableNodes: w,\n    over: Yt,\n    measureDroppableContainers: xt\n  }), [k, ki, O, K, x, tt, w, Yt, xt]);\n  return mt.createElement(vo.Provider, {\n    value: b\n  }, mt.createElement(In.Provider, {\n    value: Cl\n  }, mt.createElement(No.Provider, {\n    value: Dl\n  }, mt.createElement(ko.Provider, {\n    value: Tl\n  }, u)), mt.createElement(Yc, {\n    disabled: a?.restoreFocus === !1\n  })), mt.createElement(ql, {\n    ...a,\n    hiddenTextDescribedById: tt\n  }));\n  function Al() {\n    const ht = G?.autoScrollEnabled === !1, bt = typeof l == "object" ? l.enabled === !1 : l === !1, wt = R && !ht && !bt;\n    return typeof l == "object" ? {\n      ...l,\n      enabled: wt\n    } : {\n      enabled: wt\n    };\n  }\n}), tu = /* @__PURE__ */ Lt(null), Yi = "button", eu = "Draggable";\nfunction nu(t) {\n  let {\n    id: e,\n    data: n,\n    disabled: s = !1,\n    attributes: i\n  } = t;\n  const r = en(eu), {\n    activators: o,\n    activatorEvent: a,\n    active: l,\n    activeNodeRect: u,\n    ariaDescribedById: c,\n    draggableNodes: d,\n    over: h\n  } = q(In), {\n    role: f = Yi,\n    roleDescription: g = "draggable",\n    tabIndex: v = 0\n  } = i ?? {}, y = l?.id === e, x = q(y ? ko : tu), [T, b] = bn(), [P, D] = bn(), R = Bc(o, e), m = We(n);\n  Wt(\n    () => (d.set(e, {\n      id: e,\n      key: r,\n      node: T,\n      activatorNode: P,\n      data: m\n    }), () => {\n      const C = d.get(e);\n      C && C.key === r && d.delete(e);\n    }),\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n    [d, e]\n  );\n  const w = W(() => ({\n    role: f,\n    tabIndex: v,\n    "aria-disabled": s,\n    "aria-pressed": y && f === Yi ? !0 : void 0,\n    "aria-roledescription": g,\n    "aria-describedby": c.draggable\n  }), [s, f, v, y, g, c.draggable]);\n  return {\n    active: l,\n    activatorEvent: a,\n    activeNodeRect: u,\n    attributes: w,\n    isDragging: y,\n    listeners: s ? void 0 : R,\n    node: T,\n    over: h,\n    setNodeRef: b,\n    setActivatorNodeRef: D,\n    transform: x\n  };\n}\nfunction su() {\n  return q(No);\n}\nconst iu = "Droppable", ru = {\n  timeout: 25\n};\nfunction ou(t) {\n  let {\n    data: e,\n    disabled: n = !1,\n    id: s,\n    resizeObserverConfig: i\n  } = t;\n  const r = en(iu), {\n    active: o,\n    dispatch: a,\n    over: l,\n    measureDroppableContainers: u\n  } = q(In), c = j({\n    disabled: n\n  }), d = j(!1), h = j(null), f = j(null), {\n    disabled: g,\n    updateMeasurementsFor: v,\n    timeout: y\n  } = {\n    ...ru,\n    ...i\n  }, x = We(v ?? s), T = lt(\n    () => {\n      if (!d.current) {\n        d.current = !0;\n        return;\n      }\n      f.current != null && clearTimeout(f.current), f.current = setTimeout(() => {\n        u(Array.isArray(x.current) ? x.current : [x.current]), f.current = null;\n      }, y);\n    },\n    //eslint-disable-next-line react-hooks/exhaustive-deps\n    [y]\n  ), b = kn({\n    callback: T,\n    disabled: g || !o\n  }), P = lt((w, C) => {\n    b && (C && (b.unobserve(C), d.current = !1), w && b.observe(w));\n  }, [b]), [D, R] = bn(P), m = We(e);\n  return B(() => {\n    !b || !D.current || (b.disconnect(), d.current = !1, b.observe(D.current));\n  }, [D, b]), B(\n    () => (a({\n      type: it.RegisterDroppable,\n      element: {\n        id: s,\n        key: r,\n        disabled: n,\n        node: D,\n        rect: h,\n        data: m\n      }\n    }), () => a({\n      type: it.UnregisterDroppable,\n      key: r,\n      id: s\n    })),\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n    [s]\n  ), B(() => {\n    n !== c.current.disabled && (a({\n      type: it.SetDroppableDisabled,\n      id: s,\n      key: r,\n      disabled: n\n    }), c.current.disabled = n);\n  }, [s, r, n, a]), {\n    active: o,\n    rect: h,\n    isOver: l?.id === s,\n    node: D,\n    over: l,\n    setNodeRef: R\n  };\n}\nfunction Ys(t, e, n) {\n  const s = t.slice();\n  return s.splice(n < 0 ? s.length + n : n, 0, s.splice(e, 1)[0]), s;\n}\nfunction au(t, e) {\n  return t.reduce((n, s, i) => {\n    const r = e.get(s);\n    return r && (n[i] = r), n;\n  }, Array(t.length));\n}\nfunction cn(t) {\n  return t !== null && t >= 0;\n}\nfunction lu(t, e) {\n  if (t === e)\n    return !0;\n  if (t.length !== e.length)\n    return !1;\n  for (let n = 0; n < t.length; n++)\n    if (t[n] !== e[n])\n      return !1;\n  return !0;\n}\nfunction cu(t) {\n  return typeof t == "boolean" ? {\n    draggable: t,\n    droppable: t\n  } : t;\n}\nconst Io = (t) => {\n  let {\n    rects: e,\n    activeIndex: n,\n    overIndex: s,\n    index: i\n  } = t;\n  const r = Ys(e, s, n), o = e[i], a = r[i];\n  return !a || !o ? null : {\n    x: a.left - o.left,\n    y: a.top - o.top,\n    scaleX: a.width / o.width,\n    scaleY: a.height / o.height\n  };\n}, un = {\n  scaleX: 1,\n  scaleY: 1\n}, uu = (t) => {\n  var e;\n  let {\n    activeIndex: n,\n    activeNodeRect: s,\n    index: i,\n    rects: r,\n    overIndex: o\n  } = t;\n  const a = (e = r[n]) != null ? e : s;\n  if (!a)\n    return null;\n  if (i === n) {\n    const u = r[o];\n    return u ? {\n      x: 0,\n      y: n < o ? u.top + u.height - (a.top + a.height) : u.top - a.top,\n      ...un\n    } : null;\n  }\n  const l = du(r, i, n);\n  return i > n && i <= o ? {\n    x: 0,\n    y: -a.height - l,\n    ...un\n  } : i < n && i >= o ? {\n    x: 0,\n    y: a.height + l,\n    ...un\n  } : {\n    x: 0,\n    y: 0,\n    ...un\n  };\n};\nfunction du(t, e, n) {\n  const s = t[e], i = t[e - 1], r = t[e + 1];\n  return s ? n < e ? i ? s.top - (i.top + i.height) : r ? r.top - (s.top + s.height) : 0 : r ? r.top - (s.top + s.height) : i ? s.top - (i.top + i.height) : 0 : 0;\n}\nconst jo = "Sortable", Lo = /* @__PURE__ */ mt.createContext({\n  activeIndex: -1,\n  containerId: jo,\n  disableTransforms: !1,\n  items: [],\n  overIndex: -1,\n  useDragOverlay: !1,\n  sortedRects: [],\n  strategy: Io,\n  disabled: {\n    draggable: !1,\n    droppable: !1\n  }\n});\nfunction hu(t) {\n  let {\n    children: e,\n    id: n,\n    items: s,\n    strategy: i = Io,\n    disabled: r = !1\n  } = t;\n  const {\n    active: o,\n    dragOverlay: a,\n    droppableRects: l,\n    over: u,\n    measureDroppableContainers: c\n  } = su(), d = en(jo, n), h = a.rect !== null, f = W(() => s.map((R) => typeof R == "object" && "id" in R ? R.id : R), [s]), g = o != null, v = o ? f.indexOf(o.id) : -1, y = u ? f.indexOf(u.id) : -1, x = j(f), T = !lu(f, x.current), b = y !== -1 && v === -1 || T, P = cu(r);\n  Wt(() => {\n    T && g && c(f);\n  }, [T, f, g, c]), B(() => {\n    x.current = f;\n  }, [f]);\n  const D = W(\n    () => ({\n      activeIndex: v,\n      containerId: d,\n      disabled: P,\n      disableTransforms: b,\n      items: f,\n      overIndex: y,\n      useDragOverlay: h,\n      sortedRects: au(f, l),\n      strategy: i\n    }),\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n    [v, d, P.draggable, P.droppable, b, f, y, l, h, i]\n  );\n  return mt.createElement(Lo.Provider, {\n    value: D\n  }, e);\n}\nconst fu = (t) => {\n  let {\n    id: e,\n    items: n,\n    activeIndex: s,\n    overIndex: i\n  } = t;\n  return Ys(n, s, i).indexOf(e);\n}, pu = (t) => {\n  let {\n    containerId: e,\n    isSorting: n,\n    wasDragging: s,\n    index: i,\n    items: r,\n    newIndex: o,\n    previousItems: a,\n    previousContainerId: l,\n    transition: u\n  } = t;\n  return !u || !s || a !== r && i === o ? !1 : n ? !0 : o !== i && e === l;\n}, mu = {\n  duration: 200,\n  easing: "ease"\n}, Oo = "transform", gu = /* @__PURE__ */ Ge.Transition.toString({\n  property: Oo,\n  duration: 0,\n  easing: "linear"\n}), yu = {\n  roleDescription: "sortable"\n};\nfunction vu(t) {\n  let {\n    disabled: e,\n    index: n,\n    node: s,\n    rect: i\n  } = t;\n  const [r, o] = L(null), a = j(n);\n  return Wt(() => {\n    if (!e && n !== a.current && s.current) {\n      const l = i.current;\n      if (l) {\n        const u = Ae(s.current, {\n          ignoreTransform: !0\n        }), c = {\n          x: l.left - u.left,\n          y: l.top - u.top,\n          scaleX: l.width / u.width,\n          scaleY: l.height / u.height\n        };\n        (c.x || c.y) && o(c);\n      }\n    }\n    n !== a.current && (a.current = n);\n  }, [e, n, s, i]), B(() => {\n    r && o(null);\n  }, [r]), r;\n}\nfunction xu(t) {\n  let {\n    animateLayoutChanges: e = pu,\n    attributes: n,\n    disabled: s,\n    data: i,\n    getNewIndex: r = fu,\n    id: o,\n    strategy: a,\n    resizeObserverConfig: l,\n    transition: u = mu\n  } = t;\n  const {\n    items: c,\n    containerId: d,\n    activeIndex: h,\n    disabled: f,\n    disableTransforms: g,\n    sortedRects: v,\n    overIndex: y,\n    useDragOverlay: x,\n    strategy: T\n  } = q(Lo), b = bu(s, f), P = c.indexOf(o), D = W(() => ({\n    sortable: {\n      containerId: d,\n      index: P,\n      items: c\n    },\n    ...i\n  }), [d, i, P, c]), R = W(() => c.slice(c.indexOf(o)), [c, o]), {\n    rect: m,\n    node: w,\n    isOver: C,\n    setNodeRef: M\n  } = ou({\n    id: o,\n    data: D,\n    disabled: b.droppable,\n    resizeObserverConfig: {\n      updateMeasurementsFor: R,\n      ...l\n    }\n  }), {\n    active: S,\n    activatorEvent: N,\n    activeNodeRect: O,\n    attributes: F,\n    setNodeRef: G,\n    listeners: _,\n    isDragging: k,\n    over: U,\n    setActivatorNodeRef: H,\n    transform: tt\n  } = nu({\n    id: o,\n    data: D,\n    attributes: {\n      ...yu,\n      ...n\n    },\n    disabled: b.draggable\n  }), et = Ol(M, G), X = !!S, dt = X && !g && cn(h) && cn(y), xt = !x && k, Ot = xt && dt ? tt : null, ie = dt ? Ot ?? (a ?? T)({\n    rects: v,\n    activeNodeRect: O,\n    activeIndex: h,\n    overIndex: y,\n    index: P\n  }) : null, Ft = cn(h) && cn(y) ? r({\n    id: o,\n    items: c,\n    activeIndex: h,\n    overIndex: y\n  }) : P, Et = S?.id, K = j({\n    activeId: Et,\n    items: c,\n    newIndex: Ft,\n    containerId: d\n  }), re = c !== K.current.items, St = e({\n    active: S,\n    containerId: d,\n    isDragging: k,\n    isSorting: X,\n    id: o,\n    index: P,\n    items: c,\n    newIndex: K.current.newIndex,\n    previousItems: K.current.items,\n    previousContainerId: K.current.containerId,\n    transition: u,\n    wasDragging: K.current.activeId != null\n  }), Xt = vu({\n    disabled: !St,\n    index: P,\n    node: w,\n    rect: m\n  });\n  return B(() => {\n    X && K.current.newIndex !== Ft && (K.current.newIndex = Ft), d !== K.current.containerId && (K.current.containerId = d), c !== K.current.items && (K.current.items = c);\n  }, [X, Ft, d, c]), B(() => {\n    if (Et === K.current.activeId)\n      return;\n    if (Et != null && K.current.activeId == null) {\n      K.current.activeId = Et;\n      return;\n    }\n    const V = setTimeout(() => {\n      K.current.activeId = Et;\n    }, 50);\n    return () => clearTimeout(V);\n  }, [Et]), {\n    active: S,\n    activeIndex: h,\n    attributes: F,\n    data: D,\n    rect: m,\n    index: P,\n    newIndex: Ft,\n    items: c,\n    isOver: C,\n    isSorting: X,\n    isDragging: k,\n    listeners: _,\n    node: w,\n    overIndex: y,\n    over: U,\n    setNodeRef: et,\n    setActivatorNodeRef: H,\n    setDroppableNodeRef: M,\n    setDraggableNodeRef: G,\n    transform: Xt ?? ie,\n    transition: A()\n  };\n  function A() {\n    if (\n      // Temporarily disable transitions for a single frame to set up derived transforms\n      Xt || // Or to prevent items jumping to back to their "new" position when items change\n      re && K.current.newIndex === P\n    )\n      return gu;\n    if (!(xt && !Ws(N) || !u) && (X || St))\n      return Ge.Transition.toString({\n        ...u,\n        property: Oo\n      });\n  }\n}\nfunction bu(t, e) {\n  var n, s;\n  return typeof t == "boolean" ? {\n    draggable: t,\n    // Backwards compatibility\n    droppable: !1\n  } : {\n    draggable: (n = t?.draggable) != null ? n : e.draggable,\n    droppable: (s = t?.droppable) != null ? s : e.droppable\n  };\n}\nfunction Sn(t) {\n  if (!t)\n    return !1;\n  const e = t.data.current;\n  return !!(e && "sortable" in e && typeof e.sortable == "object" && "containerId" in e.sortable && "items" in e.sortable && "index" in e.sortable);\n}\nconst wu = [$.Down, $.Right, $.Up, $.Left], Tu = (t, e) => {\n  let {\n    context: {\n      active: n,\n      collisionRect: s,\n      droppableRects: i,\n      droppableContainers: r,\n      over: o,\n      scrollableAncestors: a\n    }\n  } = e;\n  if (wu.includes(t.code)) {\n    if (t.preventDefault(), !n || !s)\n      return;\n    const l = [];\n    r.getEnabled().forEach((d) => {\n      if (!d || d != null && d.disabled)\n        return;\n      const h = i.get(d.id);\n      if (h)\n        switch (t.code) {\n          case $.Down:\n            s.top < h.top && l.push(d);\n            break;\n          case $.Up:\n            s.top > h.top && l.push(d);\n            break;\n          case $.Left:\n            s.left > h.left && l.push(d);\n            break;\n          case $.Right:\n            s.left < h.left && l.push(d);\n            break;\n        }\n    });\n    const u = tc({\n      collisionRect: s,\n      droppableRects: i,\n      droppableContainers: l\n    });\n    let c = wo(u, "id");\n    if (c === o?.id && u.length > 1 && (c = u[1].id), c != null) {\n      const d = r.get(n.id), h = r.get(c), f = h ? i.get(h.id) : null, g = h?.node.current;\n      if (g && f && d && h) {\n        const y = Nn(g).some((R, m) => a[m] !== R), x = Fo(d, h), T = Su(d, h), b = y || !x ? {\n          x: 0,\n          y: 0\n        } : {\n          x: T ? s.width - f.width : 0,\n          y: T ? s.height - f.height : 0\n        }, P = {\n          x: f.left,\n          y: f.top\n        };\n        return b.x && b.y ? P : Ke(P, b);\n      }\n    }\n  }\n};\nfunction Fo(t, e) {\n  return !Sn(t) || !Sn(e) ? !1 : t.data.current.sortable.containerId === e.data.current.sortable.containerId;\n}\nfunction Su(t, e) {\n  return !Sn(t) || !Sn(e) || !Fo(t, e) ? !1 : t.data.current.sortable.index < e.data.current.sortable.index;\n}\nconst qs = Lt({});\nfunction Js(t) {\n  const e = j(null);\n  return e.current === null && (e.current = t()), e.current;\n}\nconst Zs = typeof window < "u", Bo = Zs ? fo : B, jn = /* @__PURE__ */ Lt(null);\nfunction Qs(t, e) {\n  t.indexOf(e) === -1 && t.push(e);\n}\nfunction ti(t, e) {\n  const n = t.indexOf(e);\n  n > -1 && t.splice(n, 1);\n}\nconst Gt = (t, e, n) => n > e ? e : n < t ? t : n;\nlet ei = () => {\n};\nconst Ht = {}, $o = (t) => /^-?(?:\\d+(?:\\.\\d+)?|\\.\\d+)$/u.test(t);\nfunction _o(t) {\n  return typeof t == "object" && t !== null;\n}\nconst Uo = (t) => /^0[^.\\s]+$/u.test(t);\n// @__NO_SIDE_EFFECTS__\nfunction ni(t) {\n  let e;\n  return () => (e === void 0 && (e = t()), e);\n}\nconst Mt = /* @__NO_SIDE_EFFECTS__ */ (t) => t, Du = (t, e) => (n) => e(t(n)), nn = (...t) => t.reduce(Du), Xe = /* @__NO_SIDE_EFFECTS__ */ (t, e, n) => {\n  const s = e - t;\n  return s === 0 ? 1 : (n - t) / s;\n};\nclass si {\n  constructor() {\n    this.subscriptions = [];\n  }\n  add(e) {\n    return Qs(this.subscriptions, e), () => ti(this.subscriptions, e);\n  }\n  notify(e, n, s) {\n    const i = this.subscriptions.length;\n    if (i)\n      if (i === 1)\n        this.subscriptions[0](e, n, s);\n      else\n        for (let r = 0; r < i; r++) {\n          const o = this.subscriptions[r];\n          o && o(e, n, s);\n        }\n  }\n  getSize() {\n    return this.subscriptions.length;\n  }\n  clear() {\n    this.subscriptions.length = 0;\n  }\n}\nconst Ut = /* @__NO_SIDE_EFFECTS__ */ (t) => t * 1e3, Rt = /* @__NO_SIDE_EFFECTS__ */ (t) => t / 1e3;\nfunction zo(t, e) {\n  return e ? t * (1e3 / e) : 0;\n}\nconst Wo = (t, e, n) => (((1 - 3 * n + 3 * e) * t + (3 * n - 6 * e)) * t + 3 * e) * t, Cu = 1e-7, Au = 12;\nfunction Pu(t, e, n, s, i) {\n  let r, o, a = 0;\n  do\n    o = e + (n - e) / 2, r = Wo(o, s, i) - t, r > 0 ? n = o : e = o;\n  while (Math.abs(r) > Cu && ++a < Au);\n  return o;\n}\nfunction sn(t, e, n, s) {\n  if (t === e && n === s)\n    return Mt;\n  const i = (r) => Pu(r, 0, 1, t, n);\n  return (r) => r === 0 || r === 1 ? r : Wo(i(r), e, s);\n}\nconst Ko = (t) => (e) => e <= 0.5 ? t(2 * e) / 2 : (2 - t(2 * (1 - e))) / 2, Go = (t) => (e) => 1 - t(1 - e), Ho = /* @__PURE__ */ sn(0.33, 1.53, 0.69, 0.99), ii = /* @__PURE__ */ Go(Ho), Xo = /* @__PURE__ */ Ko(ii), Yo = (t) => (t *= 2) < 1 ? 0.5 * ii(t) : 0.5 * (2 - Math.pow(2, -10 * (t - 1))), ri = (t) => 1 - Math.sin(Math.acos(t)), qo = Go(ri), Jo = Ko(ri), Ru = /* @__PURE__ */ sn(0.42, 0, 1, 1), Mu = /* @__PURE__ */ sn(0, 0, 0.58, 1), Zo = /* @__PURE__ */ sn(0.42, 0, 0.58, 1), Eu = (t) => Array.isArray(t) && typeof t[0] != "number", Qo = (t) => Array.isArray(t) && typeof t[0] == "number", Vu = {\n  linear: Mt,\n  easeIn: Ru,\n  easeInOut: Zo,\n  easeOut: Mu,\n  circIn: ri,\n  circInOut: Jo,\n  circOut: qo,\n  backIn: ii,\n  backInOut: Xo,\n  backOut: Ho,\n  anticipate: Yo\n}, Nu = (t) => typeof t == "string", qi = (t) => {\n  if (Qo(t)) {\n    ei(t.length === 4);\n    const [e, n, s, i] = t;\n    return sn(e, n, s, i);\n  } else if (Nu(t))\n    return Vu[t];\n  return t;\n}, dn = [\n  "setup",\n  // Compute\n  "read",\n  // Read\n  "resolveKeyframes",\n  // Write/Read/Write/Read\n  "preUpdate",\n  // Compute\n  "update",\n  // Compute\n  "preRender",\n  // Compute\n  "render",\n  // Write\n  "postRender"\n  // Compute\n];\nfunction ku(t, e) {\n  let n = /* @__PURE__ */ new Set(), s = /* @__PURE__ */ new Set(), i = !1, r = !1;\n  const o = /* @__PURE__ */ new WeakSet();\n  let a = {\n    delta: 0,\n    timestamp: 0,\n    isProcessing: !1\n  };\n  function l(c) {\n    o.has(c) && (u.schedule(c), t()), c(a);\n  }\n  const u = {\n    /**\n     * Schedule a process to run on the next frame.\n     */\n    schedule: (c, d = !1, h = !1) => {\n      const g = h && i ? n : s;\n      return d && o.add(c), g.has(c) || g.add(c), c;\n    },\n    /**\n     * Cancel the provided callback from running on the next frame.\n     */\n    cancel: (c) => {\n      s.delete(c), o.delete(c);\n    },\n    /**\n     * Execute all schedule callbacks.\n     */\n    process: (c) => {\n      if (a = c, i) {\n        r = !0;\n        return;\n      }\n      i = !0, [n, s] = [s, n], n.forEach(l), n.clear(), i = !1, r && (r = !1, u.process(c));\n    }\n  };\n  return u;\n}\nconst Iu = 40;\nfunction ta(t, e) {\n  let n = !1, s = !0;\n  const i = {\n    delta: 0,\n    timestamp: 0,\n    isProcessing: !1\n  }, r = () => n = !0, o = dn.reduce((b, P) => (b[P] = ku(r), b), {}), { setup: a, read: l, resolveKeyframes: u, preUpdate: c, update: d, preRender: h, render: f, postRender: g } = o, v = () => {\n    const b = Ht.useManualTiming ? i.timestamp : performance.now();\n    n = !1, Ht.useManualTiming || (i.delta = s ? 1e3 / 60 : Math.max(Math.min(b - i.timestamp, Iu), 1)), i.timestamp = b, i.isProcessing = !0, a.process(i), l.process(i), u.process(i), c.process(i), d.process(i), h.process(i), f.process(i), g.process(i), i.isProcessing = !1, n && e && (s = !1, t(v));\n  }, y = () => {\n    n = !0, s = !0, i.isProcessing || t(v);\n  };\n  return { schedule: dn.reduce((b, P) => {\n    const D = o[P];\n    return b[P] = (R, m = !1, w = !1) => (n || y(), D.schedule(R, m, w)), b;\n  }, {}), cancel: (b) => {\n    for (let P = 0; P < dn.length; P++)\n      o[dn[P]].cancel(b);\n  }, state: i, steps: o };\n}\nconst { schedule: Y, cancel: ee, state: ut, steps: Gn } = /* @__PURE__ */ ta(typeof requestAnimationFrame < "u" ? requestAnimationFrame : Mt, !0);\nlet gn;\nfunction ju() {\n  gn = void 0;\n}\nconst yt = {\n  now: () => (gn === void 0 && yt.set(ut.isProcessing || Ht.useManualTiming ? ut.timestamp : performance.now()), gn),\n  set: (t) => {\n    gn = t, queueMicrotask(ju);\n  }\n}, ea = (t) => (e) => typeof e == "string" && e.startsWith(t), na = /* @__PURE__ */ ea("--"), Lu = /* @__PURE__ */ ea("var(--"), oi = (t) => Lu(t) ? Ou.test(t.split("/*")[0].trim()) : !1, Ou = /var\\(--(?:[\\w-]+\\s*|[\\w-]+\\s*,(?:\\s*[^)(\\s]|\\s*\\((?:[^)(]|\\([^)(]*\\))*\\))+\\s*)\\)$/iu, Pe = {\n  test: (t) => typeof t == "number",\n  parse: parseFloat,\n  transform: (t) => t\n}, Ye = {\n  ...Pe,\n  transform: (t) => Gt(0, 1, t)\n}, hn = {\n  ...Pe,\n  default: 1\n}, $e = (t) => Math.round(t * 1e5) / 1e5, ai = /-?(?:\\d+(?:\\.\\d+)?|\\.\\d+)/gu;\nfunction Fu(t) {\n  return t == null;\n}\nconst Bu = /^(?:#[\\da-f]{3,8}|(?:rgb|hsl)a?\\((?:-?[\\d.]+%?[,\\s]+){2}-?[\\d.]+%?\\s*(?:[,/]\\s*)?(?:\\b\\d+(?:\\.\\d+)?|\\.\\d+)?%?\\))$/iu, li = (t, e) => (n) => !!(typeof n == "string" && Bu.test(n) && n.startsWith(t) || e && !Fu(n) && Object.prototype.hasOwnProperty.call(n, e)), sa = (t, e, n) => (s) => {\n  if (typeof s != "string")\n    return s;\n  const [i, r, o, a] = s.match(ai);\n  return {\n    [t]: parseFloat(i),\n    [e]: parseFloat(r),\n    [n]: parseFloat(o),\n    alpha: a !== void 0 ? parseFloat(a) : 1\n  };\n}, $u = (t) => Gt(0, 255, t), Hn = {\n  ...Pe,\n  transform: (t) => Math.round($u(t))\n}, le = {\n  test: /* @__PURE__ */ li("rgb", "red"),\n  parse: /* @__PURE__ */ sa("red", "green", "blue"),\n  transform: ({ red: t, green: e, blue: n, alpha: s = 1 }) => "rgba(" + Hn.transform(t) + ", " + Hn.transform(e) + ", " + Hn.transform(n) + ", " + $e(Ye.transform(s)) + ")"\n};\nfunction _u(t) {\n  let e = "", n = "", s = "", i = "";\n  return t.length > 5 ? (e = t.substring(1, 3), n = t.substring(3, 5), s = t.substring(5, 7), i = t.substring(7, 9)) : (e = t.substring(1, 2), n = t.substring(2, 3), s = t.substring(3, 4), i = t.substring(4, 5), e += e, n += n, s += s, i += i), {\n    red: parseInt(e, 16),\n    green: parseInt(n, 16),\n    blue: parseInt(s, 16),\n    alpha: i ? parseInt(i, 16) / 255 : 1\n  };\n}\nconst vs = {\n  test: /* @__PURE__ */ li("#"),\n  parse: _u,\n  transform: le.transform\n}, rn = /* @__NO_SIDE_EFFECTS__ */ (t) => ({\n  test: (e) => typeof e == "string" && e.endsWith(t) && e.split(" ").length === 1,\n  parse: parseFloat,\n  transform: (e) => `${e}${t}`\n}), Qt = /* @__PURE__ */ rn("deg"), zt = /* @__PURE__ */ rn("%"), I = /* @__PURE__ */ rn("px"), Uu = /* @__PURE__ */ rn("vh"), zu = /* @__PURE__ */ rn("vw"), Ji = {\n  ...zt,\n  parse: (t) => zt.parse(t) / 100,\n  transform: (t) => zt.transform(t * 100)\n}, me = {\n  test: /* @__PURE__ */ li("hsl", "hue"),\n  parse: /* @__PURE__ */ sa("hue", "saturation", "lightness"),\n  transform: ({ hue: t, saturation: e, lightness: n, alpha: s = 1 }) => "hsla(" + Math.round(t) + ", " + zt.transform($e(e)) + ", " + zt.transform($e(n)) + ", " + $e(Ye.transform(s)) + ")"\n}, nt = {\n  test: (t) => le.test(t) || vs.test(t) || me.test(t),\n  parse: (t) => le.test(t) ? le.parse(t) : me.test(t) ? me.parse(t) : vs.parse(t),\n  transform: (t) => typeof t == "string" ? t : t.hasOwnProperty("red") ? le.transform(t) : me.transform(t),\n  getAnimatableNone: (t) => {\n    const e = nt.parse(t);\n    return e.alpha = 0, nt.transform(e);\n  }\n}, Wu = /(?:#[\\da-f]{3,8}|(?:rgb|hsl)a?\\((?:-?[\\d.]+%?[,\\s]+){2}-?[\\d.]+%?\\s*(?:[,/]\\s*)?(?:\\b\\d+(?:\\.\\d+)?|\\.\\d+)?%?\\))/giu;\nfunction Ku(t) {\n  return isNaN(t) && typeof t == "string" && (t.match(ai)?.length || 0) + (t.match(Wu)?.length || 0) > 0;\n}\nconst ia = "number", ra = "color", Gu = "var", Hu = "var(", Zi = "${}", Xu = /var\\s*\\(\\s*--(?:[\\w-]+\\s*|[\\w-]+\\s*,(?:\\s*[^)(\\s]|\\s*\\((?:[^)(]|\\([^)(]*\\))*\\))+\\s*)\\)|#[\\da-f]{3,8}|(?:rgb|hsl)a?\\((?:-?[\\d.]+%?[,\\s]+){2}-?[\\d.]+%?\\s*(?:[,/]\\s*)?(?:\\b\\d+(?:\\.\\d+)?|\\.\\d+)?%?\\)|-?(?:\\d+(?:\\.\\d+)?|\\.\\d+)/giu;\nfunction qe(t) {\n  const e = t.toString(), n = [], s = {\n    color: [],\n    number: [],\n    var: []\n  }, i = [];\n  let r = 0;\n  const a = e.replace(Xu, (l) => (nt.test(l) ? (s.color.push(r), i.push(ra), n.push(nt.parse(l))) : l.startsWith(Hu) ? (s.var.push(r), i.push(Gu), n.push(l)) : (s.number.push(r), i.push(ia), n.push(parseFloat(l))), ++r, Zi)).split(Zi);\n  return { values: n, split: a, indexes: s, types: i };\n}\nfunction oa(t) {\n  return qe(t).values;\n}\nfunction aa(t) {\n  const { split: e, types: n } = qe(t), s = e.length;\n  return (i) => {\n    let r = "";\n    for (let o = 0; o < s; o++)\n      if (r += e[o], i[o] !== void 0) {\n        const a = n[o];\n        a === ia ? r += $e(i[o]) : a === ra ? r += nt.transform(i[o]) : r += i[o];\n      }\n    return r;\n  };\n}\nconst Yu = (t) => typeof t == "number" ? 0 : nt.test(t) ? nt.getAnimatableNone(t) : t;\nfunction qu(t) {\n  const e = oa(t);\n  return aa(t)(e.map(Yu));\n}\nconst ne = {\n  test: Ku,\n  parse: oa,\n  createTransformer: aa,\n  getAnimatableNone: qu\n};\nfunction Xn(t, e, n) {\n  return n < 0 && (n += 1), n > 1 && (n -= 1), n < 1 / 6 ? t + (e - t) * 6 * n : n < 1 / 2 ? e : n < 2 / 3 ? t + (e - t) * (2 / 3 - n) * 6 : t;\n}\nfunction Ju({ hue: t, saturation: e, lightness: n, alpha: s }) {\n  t /= 360, e /= 100, n /= 100;\n  let i = 0, r = 0, o = 0;\n  if (!e)\n    i = r = o = n;\n  else {\n    const a = n < 0.5 ? n * (1 + e) : n + e - n * e, l = 2 * n - a;\n    i = Xn(l, a, t + 1 / 3), r = Xn(l, a, t), o = Xn(l, a, t - 1 / 3);\n  }\n  return {\n    red: Math.round(i * 255),\n    green: Math.round(r * 255),\n    blue: Math.round(o * 255),\n    alpha: s\n  };\n}\nfunction Dn(t, e) {\n  return (n) => n > 0 ? e : t;\n}\nconst J = (t, e, n) => t + (e - t) * n, Yn = (t, e, n) => {\n  const s = t * t, i = n * (e * e - s) + s;\n  return i < 0 ? 0 : Math.sqrt(i);\n}, Zu = [vs, le, me], Qu = (t) => Zu.find((e) => e.test(t));\nfunction Qi(t) {\n  const e = Qu(t);\n  if (!e)\n    return !1;\n  let n = e.parse(t);\n  return e === me && (n = Ju(n)), n;\n}\nconst tr = (t, e) => {\n  const n = Qi(t), s = Qi(e);\n  if (!n || !s)\n    return Dn(t, e);\n  const i = { ...n };\n  return (r) => (i.red = Yn(n.red, s.red, r), i.green = Yn(n.green, s.green, r), i.blue = Yn(n.blue, s.blue, r), i.alpha = J(n.alpha, s.alpha, r), le.transform(i));\n}, xs = /* @__PURE__ */ new Set(["none", "hidden"]);\nfunction td(t, e) {\n  return xs.has(t) ? (n) => n <= 0 ? t : e : (n) => n >= 1 ? e : t;\n}\nfunction ed(t, e) {\n  return (n) => J(t, e, n);\n}\nfunction ci(t) {\n  return typeof t == "number" ? ed : typeof t == "string" ? oi(t) ? Dn : nt.test(t) ? tr : id : Array.isArray(t) ? la : typeof t == "object" ? nt.test(t) ? tr : nd : Dn;\n}\nfunction la(t, e) {\n  const n = [...t], s = n.length, i = t.map((r, o) => ci(r)(r, e[o]));\n  return (r) => {\n    for (let o = 0; o < s; o++)\n      n[o] = i[o](r);\n    return n;\n  };\n}\nfunction nd(t, e) {\n  const n = { ...t, ...e }, s = {};\n  for (const i in n)\n    t[i] !== void 0 && e[i] !== void 0 && (s[i] = ci(t[i])(t[i], e[i]));\n  return (i) => {\n    for (const r in s)\n      n[r] = s[r](i);\n    return n;\n  };\n}\nfunction sd(t, e) {\n  const n = [], s = { color: 0, var: 0, number: 0 };\n  for (let i = 0; i < e.values.length; i++) {\n    const r = e.types[i], o = t.indexes[r][s[r]], a = t.values[o] ?? 0;\n    n[i] = a, s[r]++;\n  }\n  return n;\n}\nconst id = (t, e) => {\n  const n = ne.createTransformer(e), s = qe(t), i = qe(e);\n  return s.indexes.var.length === i.indexes.var.length && s.indexes.color.length === i.indexes.color.length && s.indexes.number.length >= i.indexes.number.length ? xs.has(t) && !i.values.length || xs.has(e) && !s.values.length ? td(t, e) : nn(la(sd(s, i), i.values), n) : Dn(t, e);\n};\nfunction ca(t, e, n) {\n  return typeof t == "number" && typeof e == "number" && typeof n == "number" ? J(t, e, n) : ci(t)(t, e);\n}\nconst rd = (t) => {\n  const e = ({ timestamp: n }) => t(n);\n  return {\n    start: (n = !0) => Y.update(e, n),\n    stop: () => ee(e),\n    /**\n     * If we\'re processing this frame we can use the\n     * framelocked timestamp to keep things in sync.\n     */\n    now: () => ut.isProcessing ? ut.timestamp : yt.now()\n  };\n}, ua = (t, e, n = 10) => {\n  let s = "";\n  const i = Math.max(Math.round(e / n), 2);\n  for (let r = 0; r < i; r++)\n    s += Math.round(t(r / (i - 1)) * 1e4) / 1e4 + ", ";\n  return `linear(${s.substring(0, s.length - 2)})`;\n}, Cn = 2e4;\nfunction ui(t) {\n  let e = 0;\n  const n = 50;\n  let s = t.next(e);\n  for (; !s.done && e < Cn; )\n    e += n, s = t.next(e);\n  return e >= Cn ? 1 / 0 : e;\n}\nfunction od(t, e = 100, n) {\n  const s = n({ ...t, keyframes: [0, e] }), i = Math.min(ui(s), Cn);\n  return {\n    type: "keyframes",\n    ease: (r) => s.next(i * r).value / e,\n    duration: /* @__PURE__ */ Rt(i)\n  };\n}\nconst ad = 5;\nfunction da(t, e, n) {\n  const s = Math.max(e - ad, 0);\n  return zo(n - t(s), e - s);\n}\nconst Q = {\n  // Default spring physics\n  stiffness: 100,\n  damping: 10,\n  mass: 1,\n  velocity: 0,\n  // Default duration/bounce-based options\n  duration: 800,\n  // in ms\n  bounce: 0.3,\n  visualDuration: 0.3,\n  // in seconds\n  // Rest thresholds\n  restSpeed: {\n    granular: 0.01,\n    default: 2\n  },\n  restDelta: {\n    granular: 5e-3,\n    default: 0.5\n  },\n  // Limits\n  minDuration: 0.01,\n  // in seconds\n  maxDuration: 10,\n  // in seconds\n  minDamping: 0.05,\n  maxDamping: 1\n}, qn = 1e-3;\nfunction ld({ duration: t = Q.duration, bounce: e = Q.bounce, velocity: n = Q.velocity, mass: s = Q.mass }) {\n  let i, r, o = 1 - e;\n  o = Gt(Q.minDamping, Q.maxDamping, o), t = Gt(Q.minDuration, Q.maxDuration, /* @__PURE__ */ Rt(t)), o < 1 ? (i = (u) => {\n    const c = u * o, d = c * t, h = c - n, f = bs(u, o), g = Math.exp(-d);\n    return qn - h / f * g;\n  }, r = (u) => {\n    const d = u * o * t, h = d * n + n, f = Math.pow(o, 2) * Math.pow(u, 2) * t, g = Math.exp(-d), v = bs(Math.pow(u, 2), o);\n    return (-i(u) + qn > 0 ? -1 : 1) * ((h - f) * g) / v;\n  }) : (i = (u) => {\n    const c = Math.exp(-u * t), d = (u - n) * t + 1;\n    return -qn + c * d;\n  }, r = (u) => {\n    const c = Math.exp(-u * t), d = (n - u) * (t * t);\n    return c * d;\n  });\n  const a = 5 / t, l = ud(i, r, a);\n  if (t = /* @__PURE__ */ Ut(t), isNaN(l))\n    return {\n      stiffness: Q.stiffness,\n      damping: Q.damping,\n      duration: t\n    };\n  {\n    const u = Math.pow(l, 2) * s;\n    return {\n      stiffness: u,\n      damping: o * 2 * Math.sqrt(s * u),\n      duration: t\n    };\n  }\n}\nconst cd = 12;\nfunction ud(t, e, n) {\n  let s = n;\n  for (let i = 1; i < cd; i++)\n    s = s - t(s) / e(s);\n  return s;\n}\nfunction bs(t, e) {\n  return t * Math.sqrt(1 - e * e);\n}\nconst dd = ["duration", "bounce"], hd = ["stiffness", "damping", "mass"];\nfunction er(t, e) {\n  return e.some((n) => t[n] !== void 0);\n}\nfunction fd(t) {\n  let e = {\n    velocity: Q.velocity,\n    stiffness: Q.stiffness,\n    damping: Q.damping,\n    mass: Q.mass,\n    isResolvedFromDuration: !1,\n    ...t\n  };\n  if (!er(t, hd) && er(t, dd))\n    if (t.visualDuration) {\n      const n = t.visualDuration, s = 2 * Math.PI / (n * 1.2), i = s * s, r = 2 * Gt(0.05, 1, 1 - (t.bounce || 0)) * Math.sqrt(i);\n      e = {\n        ...e,\n        mass: Q.mass,\n        stiffness: i,\n        damping: r\n      };\n    } else {\n      const n = ld(t);\n      e = {\n        ...e,\n        ...n,\n        mass: Q.mass\n      }, e.isResolvedFromDuration = !0;\n    }\n  return e;\n}\nfunction An(t = Q.visualDuration, e = Q.bounce) {\n  const n = typeof t != "object" ? {\n    visualDuration: t,\n    keyframes: [0, 1],\n    bounce: e\n  } : t;\n  let { restSpeed: s, restDelta: i } = n;\n  const r = n.keyframes[0], o = n.keyframes[n.keyframes.length - 1], a = { done: !1, value: r }, { stiffness: l, damping: u, mass: c, duration: d, velocity: h, isResolvedFromDuration: f } = fd({\n    ...n,\n    velocity: -/* @__PURE__ */ Rt(n.velocity || 0)\n  }), g = h || 0, v = u / (2 * Math.sqrt(l * c)), y = o - r, x = /* @__PURE__ */ Rt(Math.sqrt(l / c)), T = Math.abs(y) < 5;\n  s || (s = T ? Q.restSpeed.granular : Q.restSpeed.default), i || (i = T ? Q.restDelta.granular : Q.restDelta.default);\n  let b;\n  if (v < 1) {\n    const D = bs(x, v);\n    b = (R) => {\n      const m = Math.exp(-v * x * R);\n      return o - m * ((g + v * x * y) / D * Math.sin(D * R) + y * Math.cos(D * R));\n    };\n  } else if (v === 1)\n    b = (D) => o - Math.exp(-x * D) * (y + (g + x * y) * D);\n  else {\n    const D = x * Math.sqrt(v * v - 1);\n    b = (R) => {\n      const m = Math.exp(-v * x * R), w = Math.min(D * R, 300);\n      return o - m * ((g + v * x * y) * Math.sinh(w) + D * y * Math.cosh(w)) / D;\n    };\n  }\n  const P = {\n    calculatedDuration: f && d || null,\n    next: (D) => {\n      const R = b(D);\n      if (f)\n        a.done = D >= d;\n      else {\n        let m = D === 0 ? g : 0;\n        v < 1 && (m = D === 0 ? /* @__PURE__ */ Ut(g) : da(b, D, R));\n        const w = Math.abs(m) <= s, C = Math.abs(o - R) <= i;\n        a.done = w && C;\n      }\n      return a.value = a.done ? o : R, a;\n    },\n    toString: () => {\n      const D = Math.min(ui(P), Cn), R = ua((m) => P.next(D * m).value, D, 30);\n      return D + "ms " + R;\n    },\n    toTransition: () => {\n    }\n  };\n  return P;\n}\nAn.applyToOptions = (t) => {\n  const e = od(t, 100, An);\n  return t.ease = e.ease, t.duration = /* @__PURE__ */ Ut(e.duration), t.type = "keyframes", t;\n};\nfunction ws({ keyframes: t, velocity: e = 0, power: n = 0.8, timeConstant: s = 325, bounceDamping: i = 10, bounceStiffness: r = 500, modifyTarget: o, min: a, max: l, restDelta: u = 0.5, restSpeed: c }) {\n  const d = t[0], h = {\n    done: !1,\n    value: d\n  }, f = (w) => a !== void 0 && w < a || l !== void 0 && w > l, g = (w) => a === void 0 ? l : l === void 0 || Math.abs(a - w) < Math.abs(l - w) ? a : l;\n  let v = n * e;\n  const y = d + v, x = o === void 0 ? y : o(y);\n  x !== y && (v = x - d);\n  const T = (w) => -v * Math.exp(-w / s), b = (w) => x + T(w), P = (w) => {\n    const C = T(w), M = b(w);\n    h.done = Math.abs(C) <= u, h.value = h.done ? x : M;\n  };\n  let D, R;\n  const m = (w) => {\n    f(h.value) && (D = w, R = An({\n      keyframes: [h.value, g(h.value)],\n      velocity: da(b, w, h.value),\n      // TODO: This should be passing * 1000\n      damping: i,\n      stiffness: r,\n      restDelta: u,\n      restSpeed: c\n    }));\n  };\n  return m(0), {\n    calculatedDuration: null,\n    next: (w) => {\n      let C = !1;\n      return !R && D === void 0 && (C = !0, P(w), m(w)), D !== void 0 && w >= D ? R.next(w - D) : (!C && P(w), h);\n    }\n  };\n}\nfunction pd(t, e, n) {\n  const s = [], i = n || Ht.mix || ca, r = t.length - 1;\n  for (let o = 0; o < r; o++) {\n    let a = i(t[o], t[o + 1]);\n    if (e) {\n      const l = Array.isArray(e) ? e[o] || Mt : e;\n      a = nn(l, a);\n    }\n    s.push(a);\n  }\n  return s;\n}\nfunction md(t, e, { clamp: n = !0, ease: s, mixer: i } = {}) {\n  const r = t.length;\n  if (ei(r === e.length), r === 1)\n    return () => e[0];\n  if (r === 2 && e[0] === e[1])\n    return () => e[1];\n  const o = t[0] === t[1];\n  t[0] > t[r - 1] && (t = [...t].reverse(), e = [...e].reverse());\n  const a = pd(e, s, i), l = a.length, u = (c) => {\n    if (o && c < t[0])\n      return e[0];\n    let d = 0;\n    if (l > 1)\n      for (; d < t.length - 2 && !(c < t[d + 1]); d++)\n        ;\n    const h = /* @__PURE__ */ Xe(t[d], t[d + 1], c);\n    return a[d](h);\n  };\n  return n ? (c) => u(Gt(t[0], t[r - 1], c)) : u;\n}\nfunction gd(t, e) {\n  const n = t[t.length - 1];\n  for (let s = 1; s <= e; s++) {\n    const i = /* @__PURE__ */ Xe(0, e, s);\n    t.push(J(n, 1, i));\n  }\n}\nfunction yd(t) {\n  const e = [0];\n  return gd(e, t.length - 1), e;\n}\nfunction vd(t, e) {\n  return t.map((n) => n * e);\n}\nfunction xd(t, e) {\n  return t.map(() => e || Zo).splice(0, t.length - 1);\n}\nfunction _e({ duration: t = 300, keyframes: e, times: n, ease: s = "easeInOut" }) {\n  const i = Eu(s) ? s.map(qi) : qi(s), r = {\n    done: !1,\n    value: e[0]\n  }, o = vd(\n    // Only use the provided offsets if they\'re the correct length\n    // TODO Maybe we should warn here if there\'s a length mismatch\n    n && n.length === e.length ? n : yd(e),\n    t\n  ), a = md(o, e, {\n    ease: Array.isArray(i) ? i : xd(e, i)\n  });\n  return {\n    calculatedDuration: t,\n    next: (l) => (r.value = a(l), r.done = l >= t, r)\n  };\n}\nconst bd = (t) => t !== null;\nfunction di(t, { repeat: e, repeatType: n = "loop" }, s, i = 1) {\n  const r = t.filter(bd), a = i < 0 || e && n !== "loop" && e % 2 === 1 ? 0 : r.length - 1;\n  return !a || s === void 0 ? r[a] : s;\n}\nconst wd = {\n  decay: ws,\n  inertia: ws,\n  tween: _e,\n  keyframes: _e,\n  spring: An\n};\nfunction ha(t) {\n  typeof t.type == "string" && (t.type = wd[t.type]);\n}\nclass hi {\n  constructor() {\n    this.updateFinished();\n  }\n  get finished() {\n    return this._finished;\n  }\n  updateFinished() {\n    this._finished = new Promise((e) => {\n      this.resolve = e;\n    });\n  }\n  notifyFinished() {\n    this.resolve();\n  }\n  /**\n   * Allows the animation to be awaited.\n   *\n   * @deprecated Use `finished` instead.\n   */\n  then(e, n) {\n    return this.finished.then(e, n);\n  }\n}\nconst Td = (t) => t / 100;\nclass fi extends hi {\n  constructor(e) {\n    super(), this.state = "idle", this.startTime = null, this.isStopped = !1, this.currentTime = 0, this.holdTime = null, this.playbackSpeed = 1, this.stop = () => {\n      const { motionValue: n } = this.options;\n      n && n.updatedAt !== yt.now() && this.tick(yt.now()), this.isStopped = !0, this.state !== "idle" && (this.teardown(), this.options.onStop?.());\n    }, this.options = e, this.initAnimation(), this.play(), e.autoplay === !1 && this.pause();\n  }\n  initAnimation() {\n    const { options: e } = this;\n    ha(e);\n    const { type: n = _e, repeat: s = 0, repeatDelay: i = 0, repeatType: r, velocity: o = 0 } = e;\n    let { keyframes: a } = e;\n    const l = n || _e;\n    l !== _e && typeof a[0] != "number" && (this.mixKeyframes = nn(Td, ca(a[0], a[1])), a = [0, 100]);\n    const u = l({ ...e, keyframes: a });\n    r === "mirror" && (this.mirroredGenerator = l({\n      ...e,\n      keyframes: [...a].reverse(),\n      velocity: -o\n    })), u.calculatedDuration === null && (u.calculatedDuration = ui(u));\n    const { calculatedDuration: c } = u;\n    this.calculatedDuration = c, this.resolvedDuration = c + i, this.totalDuration = this.resolvedDuration * (s + 1) - i, this.generator = u;\n  }\n  updateTime(e) {\n    const n = Math.round(e - this.startTime) * this.playbackSpeed;\n    this.holdTime !== null ? this.currentTime = this.holdTime : this.currentTime = n;\n  }\n  tick(e, n = !1) {\n    const { generator: s, totalDuration: i, mixKeyframes: r, mirroredGenerator: o, resolvedDuration: a, calculatedDuration: l } = this;\n    if (this.startTime === null)\n      return s.next(0);\n    const { delay: u = 0, keyframes: c, repeat: d, repeatType: h, repeatDelay: f, type: g, onUpdate: v, finalKeyframe: y } = this.options;\n    this.speed > 0 ? this.startTime = Math.min(this.startTime, e) : this.speed < 0 && (this.startTime = Math.min(e - i / this.speed, this.startTime)), n ? this.currentTime = e : this.updateTime(e);\n    const x = this.currentTime - u * (this.playbackSpeed >= 0 ? 1 : -1), T = this.playbackSpeed >= 0 ? x < 0 : x > i;\n    this.currentTime = Math.max(x, 0), this.state === "finished" && this.holdTime === null && (this.currentTime = i);\n    let b = this.currentTime, P = s;\n    if (d) {\n      const w = Math.min(this.currentTime, i) / a;\n      let C = Math.floor(w), M = w % 1;\n      !M && w >= 1 && (M = 1), M === 1 && C--, C = Math.min(C, d + 1), !!(C % 2) && (h === "reverse" ? (M = 1 - M, f && (M -= f / a)) : h === "mirror" && (P = o)), b = Gt(0, 1, M) * a;\n    }\n    const D = T ? { done: !1, value: c[0] } : P.next(b);\n    r && (D.value = r(D.value));\n    let { done: R } = D;\n    !T && l !== null && (R = this.playbackSpeed >= 0 ? this.currentTime >= i : this.currentTime <= 0);\n    const m = this.holdTime === null && (this.state === "finished" || this.state === "running" && R);\n    return m && g !== ws && (D.value = di(c, this.options, y, this.speed)), v && v(D.value), m && this.finish(), D;\n  }\n  /**\n   * Allows the returned animation to be awaited or promise-chained. Currently\n   * resolves when the animation finishes at all but in a future update could/should\n   * reject if its cancels.\n   */\n  then(e, n) {\n    return this.finished.then(e, n);\n  }\n  get duration() {\n    return /* @__PURE__ */ Rt(this.calculatedDuration);\n  }\n  get iterationDuration() {\n    const { delay: e = 0 } = this.options || {};\n    return this.duration + /* @__PURE__ */ Rt(e);\n  }\n  get time() {\n    return /* @__PURE__ */ Rt(this.currentTime);\n  }\n  set time(e) {\n    e = /* @__PURE__ */ Ut(e), this.currentTime = e, this.startTime === null || this.holdTime !== null || this.playbackSpeed === 0 ? this.holdTime = e : this.driver && (this.startTime = this.driver.now() - e / this.playbackSpeed), this.driver?.start(!1);\n  }\n  get speed() {\n    return this.playbackSpeed;\n  }\n  set speed(e) {\n    this.updateTime(yt.now());\n    const n = this.playbackSpeed !== e;\n    this.playbackSpeed = e, n && (this.time = /* @__PURE__ */ Rt(this.currentTime));\n  }\n  play() {\n    if (this.isStopped)\n      return;\n    const { driver: e = rd, startTime: n } = this.options;\n    this.driver || (this.driver = e((i) => this.tick(i))), this.options.onPlay?.();\n    const s = this.driver.now();\n    this.state === "finished" ? (this.updateFinished(), this.startTime = s) : this.holdTime !== null ? this.startTime = s - this.holdTime : this.startTime || (this.startTime = n ?? s), this.state === "finished" && this.speed < 0 && (this.startTime += this.calculatedDuration), this.holdTime = null, this.state = "running", this.driver.start();\n  }\n  pause() {\n    this.state = "paused", this.updateTime(yt.now()), this.holdTime = this.currentTime;\n  }\n  complete() {\n    this.state !== "running" && this.play(), this.state = "finished", this.holdTime = null;\n  }\n  finish() {\n    this.notifyFinished(), this.teardown(), this.state = "finished", this.options.onComplete?.();\n  }\n  cancel() {\n    this.holdTime = null, this.startTime = 0, this.tick(0), this.teardown(), this.options.onCancel?.();\n  }\n  teardown() {\n    this.state = "idle", this.stopDriver(), this.startTime = this.holdTime = null;\n  }\n  stopDriver() {\n    this.driver && (this.driver.stop(), this.driver = void 0);\n  }\n  sample(e) {\n    return this.startTime = 0, this.tick(e, !0);\n  }\n  attachTimeline(e) {\n    return this.options.allowFlatten && (this.options.type = "keyframes", this.options.ease = "linear", this.initAnimation()), this.driver?.stop(), e.observe(this);\n  }\n}\nfunction Sd(t) {\n  for (let e = 1; e < t.length; e++)\n    t[e] ?? (t[e] = t[e - 1]);\n}\nconst ce = (t) => t * 180 / Math.PI, Ts = (t) => {\n  const e = ce(Math.atan2(t[1], t[0]));\n  return Ss(e);\n}, Dd = {\n  x: 4,\n  y: 5,\n  translateX: 4,\n  translateY: 5,\n  scaleX: 0,\n  scaleY: 3,\n  scale: (t) => (Math.abs(t[0]) + Math.abs(t[3])) / 2,\n  rotate: Ts,\n  rotateZ: Ts,\n  skewX: (t) => ce(Math.atan(t[1])),\n  skewY: (t) => ce(Math.atan(t[2])),\n  skew: (t) => (Math.abs(t[1]) + Math.abs(t[2])) / 2\n}, Ss = (t) => (t = t % 360, t < 0 && (t += 360), t), nr = Ts, sr = (t) => Math.sqrt(t[0] * t[0] + t[1] * t[1]), ir = (t) => Math.sqrt(t[4] * t[4] + t[5] * t[5]), Cd = {\n  x: 12,\n  y: 13,\n  z: 14,\n  translateX: 12,\n  translateY: 13,\n  translateZ: 14,\n  scaleX: sr,\n  scaleY: ir,\n  scale: (t) => (sr(t) + ir(t)) / 2,\n  rotateX: (t) => Ss(ce(Math.atan2(t[6], t[5]))),\n  rotateY: (t) => Ss(ce(Math.atan2(-t[2], t[0]))),\n  rotateZ: nr,\n  rotate: nr,\n  skewX: (t) => ce(Math.atan(t[4])),\n  skewY: (t) => ce(Math.atan(t[1])),\n  skew: (t) => (Math.abs(t[1]) + Math.abs(t[4])) / 2\n};\nfunction Ds(t) {\n  return t.includes("scale") ? 1 : 0;\n}\nfunction Cs(t, e) {\n  if (!t || t === "none")\n    return Ds(e);\n  const n = t.match(/^matrix3d\\(([-\\d.e\\s,]+)\\)$/u);\n  let s, i;\n  if (n)\n    s = Cd, i = n;\n  else {\n    const a = t.match(/^matrix\\(([-\\d.e\\s,]+)\\)$/u);\n    s = Dd, i = a;\n  }\n  if (!i)\n    return Ds(e);\n  const r = s[e], o = i[1].split(",").map(Pd);\n  return typeof r == "function" ? r(o) : o[r];\n}\nconst Ad = (t, e) => {\n  const { transform: n = "none" } = getComputedStyle(t);\n  return Cs(n, e);\n};\nfunction Pd(t) {\n  return parseFloat(t.trim());\n}\nconst Re = [\n  "transformPerspective",\n  "x",\n  "y",\n  "z",\n  "translateX",\n  "translateY",\n  "translateZ",\n  "scale",\n  "scaleX",\n  "scaleY",\n  "rotate",\n  "rotateX",\n  "rotateY",\n  "rotateZ",\n  "skew",\n  "skewX",\n  "skewY"\n], Me = new Set(Re), rr = (t) => t === Pe || t === I, Rd = /* @__PURE__ */ new Set(["x", "y", "z"]), Md = Re.filter((t) => !Rd.has(t));\nfunction Ed(t) {\n  const e = [];\n  return Md.forEach((n) => {\n    const s = t.getValue(n);\n    s !== void 0 && (e.push([n, s.get()]), s.set(n.startsWith("scale") ? 1 : 0));\n  }), e;\n}\nconst ue = {\n  // Dimensions\n  width: ({ x: t }, { paddingLeft: e = "0", paddingRight: n = "0" }) => t.max - t.min - parseFloat(e) - parseFloat(n),\n  height: ({ y: t }, { paddingTop: e = "0", paddingBottom: n = "0" }) => t.max - t.min - parseFloat(e) - parseFloat(n),\n  top: (t, { top: e }) => parseFloat(e),\n  left: (t, { left: e }) => parseFloat(e),\n  bottom: ({ y: t }, { top: e }) => parseFloat(e) + (t.max - t.min),\n  right: ({ x: t }, { left: e }) => parseFloat(e) + (t.max - t.min),\n  // Transform\n  x: (t, { transform: e }) => Cs(e, "x"),\n  y: (t, { transform: e }) => Cs(e, "y")\n};\nue.translateX = ue.x;\nue.translateY = ue.y;\nconst de = /* @__PURE__ */ new Set();\nlet As = !1, Ps = !1, Rs = !1;\nfunction fa() {\n  if (Ps) {\n    const t = Array.from(de).filter((s) => s.needsMeasurement), e = new Set(t.map((s) => s.element)), n = /* @__PURE__ */ new Map();\n    e.forEach((s) => {\n      const i = Ed(s);\n      i.length && (n.set(s, i), s.render());\n    }), t.forEach((s) => s.measureInitialState()), e.forEach((s) => {\n      s.render();\n      const i = n.get(s);\n      i && i.forEach(([r, o]) => {\n        s.getValue(r)?.set(o);\n      });\n    }), t.forEach((s) => s.measureEndState()), t.forEach((s) => {\n      s.suspendedScrollY !== void 0 && window.scrollTo(0, s.suspendedScrollY);\n    });\n  }\n  Ps = !1, As = !1, de.forEach((t) => t.complete(Rs)), de.clear();\n}\nfunction pa() {\n  de.forEach((t) => {\n    t.readKeyframes(), t.needsMeasurement && (Ps = !0);\n  });\n}\nfunction Vd() {\n  Rs = !0, pa(), fa(), Rs = !1;\n}\nclass pi {\n  constructor(e, n, s, i, r, o = !1) {\n    this.state = "pending", this.isAsync = !1, this.needsMeasurement = !1, this.unresolvedKeyframes = [...e], this.onComplete = n, this.name = s, this.motionValue = i, this.element = r, this.isAsync = o;\n  }\n  scheduleResolve() {\n    this.state = "scheduled", this.isAsync ? (de.add(this), As || (As = !0, Y.read(pa), Y.resolveKeyframes(fa))) : (this.readKeyframes(), this.complete());\n  }\n  readKeyframes() {\n    const { unresolvedKeyframes: e, name: n, element: s, motionValue: i } = this;\n    if (e[0] === null) {\n      const r = i?.get(), o = e[e.length - 1];\n      if (r !== void 0)\n        e[0] = r;\n      else if (s && n) {\n        const a = s.readValue(n, o);\n        a != null && (e[0] = a);\n      }\n      e[0] === void 0 && (e[0] = o), i && r === void 0 && i.set(e[0]);\n    }\n    Sd(e);\n  }\n  setFinalKeyframe() {\n  }\n  measureInitialState() {\n  }\n  renderEndStyles() {\n  }\n  measureEndState() {\n  }\n  complete(e = !1) {\n    this.state = "complete", this.onComplete(this.unresolvedKeyframes, this.finalKeyframe, e), de.delete(this);\n  }\n  cancel() {\n    this.state === "scheduled" && (de.delete(this), this.state = "pending");\n  }\n  resume() {\n    this.state === "pending" && this.scheduleResolve();\n  }\n}\nconst Nd = (t) => t.startsWith("--");\nfunction kd(t, e, n) {\n  Nd(e) ? t.style.setProperty(e, n) : t.style[e] = n;\n}\nconst Id = /* @__PURE__ */ ni(() => window.ScrollTimeline !== void 0), jd = {};\nfunction Ld(t, e) {\n  const n = /* @__PURE__ */ ni(t);\n  return () => jd[e] ?? n();\n}\nconst ma = /* @__PURE__ */ Ld(() => {\n  try {\n    document.createElement("div").animate({ opacity: 0 }, { easing: "linear(0, 1)" });\n  } catch {\n    return !1;\n  }\n  return !0;\n}, "linearEasing"), Le = ([t, e, n, s]) => `cubic-bezier(${t}, ${e}, ${n}, ${s})`, or = {\n  linear: "linear",\n  ease: "ease",\n  easeIn: "ease-in",\n  easeOut: "ease-out",\n  easeInOut: "ease-in-out",\n  circIn: /* @__PURE__ */ Le([0, 0.65, 0.55, 1]),\n  circOut: /* @__PURE__ */ Le([0.55, 0, 1, 0.45]),\n  backIn: /* @__PURE__ */ Le([0.31, 0.01, 0.66, -0.59]),\n  backOut: /* @__PURE__ */ Le([0.33, 1.53, 0.69, 0.99])\n};\nfunction ga(t, e) {\n  if (t)\n    return typeof t == "function" ? ma() ? ua(t, e) : "ease-out" : Qo(t) ? Le(t) : Array.isArray(t) ? t.map((n) => ga(n, e) || or.easeOut) : or[t];\n}\nfunction Od(t, e, n, { delay: s = 0, duration: i = 300, repeat: r = 0, repeatType: o = "loop", ease: a = "easeOut", times: l } = {}, u = void 0) {\n  const c = {\n    [e]: n\n  };\n  l && (c.offset = l);\n  const d = ga(a, i);\n  Array.isArray(d) && (c.easing = d);\n  const h = {\n    delay: s,\n    duration: i,\n    easing: Array.isArray(d) ? "linear" : d,\n    fill: "both",\n    iterations: r + 1,\n    direction: o === "reverse" ? "alternate" : "normal"\n  };\n  return u && (h.pseudoElement = u), t.animate(c, h);\n}\nfunction ya(t) {\n  return typeof t == "function" && "applyToOptions" in t;\n}\nfunction Fd({ type: t, ...e }) {\n  return ya(t) && ma() ? t.applyToOptions(e) : (e.duration ?? (e.duration = 300), e.ease ?? (e.ease = "easeOut"), e);\n}\nclass Bd extends hi {\n  constructor(e) {\n    if (super(), this.finishedTime = null, this.isStopped = !1, !e)\n      return;\n    const { element: n, name: s, keyframes: i, pseudoElement: r, allowFlatten: o = !1, finalKeyframe: a, onComplete: l } = e;\n    this.isPseudoElement = !!r, this.allowFlatten = o, this.options = e, ei(typeof e.type != "string");\n    const u = Fd(e);\n    this.animation = Od(n, s, i, u, r), u.autoplay === !1 && this.animation.pause(), this.animation.onfinish = () => {\n      if (this.finishedTime = this.time, !r) {\n        const c = di(i, this.options, a, this.speed);\n        this.updateMotionValue ? this.updateMotionValue(c) : kd(n, s, c), this.animation.cancel();\n      }\n      l?.(), this.notifyFinished();\n    };\n  }\n  play() {\n    this.isStopped || (this.animation.play(), this.state === "finished" && this.updateFinished());\n  }\n  pause() {\n    this.animation.pause();\n  }\n  complete() {\n    this.animation.finish?.();\n  }\n  cancel() {\n    try {\n      this.animation.cancel();\n    } catch {\n    }\n  }\n  stop() {\n    if (this.isStopped)\n      return;\n    this.isStopped = !0;\n    const { state: e } = this;\n    e === "idle" || e === "finished" || (this.updateMotionValue ? this.updateMotionValue() : this.commitStyles(), this.isPseudoElement || this.cancel());\n  }\n  /**\n   * WAAPI doesn\'t natively have any interruption capabilities.\n   *\n   * In this method, we commit styles back to the DOM before cancelling\n   * the animation.\n   *\n   * This is designed to be overridden by NativeAnimationExtended, which\n   * will create a renderless JS animation and sample it twice to calculate\n   * its current value, "previous" value, and therefore allow\n   * Motion to also correctly calculate velocity for any subsequent animation\n   * while deferring the commit until the next animation frame.\n   */\n  commitStyles() {\n    this.isPseudoElement || this.animation.commitStyles?.();\n  }\n  get duration() {\n    const e = this.animation.effect?.getComputedTiming?.().duration || 0;\n    return /* @__PURE__ */ Rt(Number(e));\n  }\n  get iterationDuration() {\n    const { delay: e = 0 } = this.options || {};\n    return this.duration + /* @__PURE__ */ Rt(e);\n  }\n  get time() {\n    return /* @__PURE__ */ Rt(Number(this.animation.currentTime) || 0);\n  }\n  set time(e) {\n    this.finishedTime = null, this.animation.currentTime = /* @__PURE__ */ Ut(e);\n  }\n  /**\n   * The playback speed of the animation.\n   * 1 = normal speed, 2 = double speed, 0.5 = half speed.\n   */\n  get speed() {\n    return this.animation.playbackRate;\n  }\n  set speed(e) {\n    e < 0 && (this.finishedTime = null), this.animation.playbackRate = e;\n  }\n  get state() {\n    return this.finishedTime !== null ? "finished" : this.animation.playState;\n  }\n  get startTime() {\n    return Number(this.animation.startTime);\n  }\n  set startTime(e) {\n    this.animation.startTime = e;\n  }\n  /**\n   * Attaches a timeline to the animation, for instance the `ScrollTimeline`.\n   */\n  attachTimeline({ timeline: e, observe: n }) {\n    return this.allowFlatten && this.animation.effect?.updateTiming({ easing: "linear" }), this.animation.onfinish = null, e && Id() ? (this.animation.timeline = e, Mt) : n(this);\n  }\n}\nconst va = {\n  anticipate: Yo,\n  backInOut: Xo,\n  circInOut: Jo\n};\nfunction $d(t) {\n  return t in va;\n}\nfunction _d(t) {\n  typeof t.ease == "string" && $d(t.ease) && (t.ease = va[t.ease]);\n}\nconst ar = 10;\nclass Ud extends Bd {\n  constructor(e) {\n    _d(e), ha(e), super(e), e.startTime && (this.startTime = e.startTime), this.options = e;\n  }\n  /**\n   * WAAPI doesn\'t natively have any interruption capabilities.\n   *\n   * Rather than read commited styles back out of the DOM, we can\n   * create a renderless JS animation and sample it twice to calculate\n   * its current value, "previous" value, and therefore allow\n   * Motion to calculate velocity for any subsequent animation.\n   */\n  updateMotionValue(e) {\n    const { motionValue: n, onUpdate: s, onComplete: i, element: r, ...o } = this.options;\n    if (!n)\n      return;\n    if (e !== void 0) {\n      n.set(e);\n      return;\n    }\n    const a = new fi({\n      ...o,\n      autoplay: !1\n    }), l = /* @__PURE__ */ Ut(this.finishedTime ?? this.time);\n    n.setWithVelocity(a.sample(l - ar).value, a.sample(l).value, ar), a.stop();\n  }\n}\nconst lr = (t, e) => e === "zIndex" ? !1 : !!(typeof t == "number" || Array.isArray(t) || typeof t == "string" && // It\'s animatable if we have a string\n(ne.test(t) || t === "0") && // And it contains numbers and/or colors\n!t.startsWith("url("));\nfunction zd(t) {\n  const e = t[0];\n  if (t.length === 1)\n    return !0;\n  for (let n = 0; n < t.length; n++)\n    if (t[n] !== e)\n      return !0;\n}\nfunction Wd(t, e, n, s) {\n  const i = t[0];\n  if (i === null)\n    return !1;\n  if (e === "display" || e === "visibility")\n    return !0;\n  const r = t[t.length - 1], o = lr(i, e), a = lr(r, e);\n  return !o || !a ? !1 : zd(t) || (n === "spring" || ya(n)) && s;\n}\nfunction Ms(t) {\n  t.duration = 0, t.type = "keyframes";\n}\nconst Kd = /* @__PURE__ */ new Set([\n  "opacity",\n  "clipPath",\n  "filter",\n  "transform"\n  // TODO: Could be re-enabled now we have support for linear() easing\n  // "background-color"\n]), Gd = /* @__PURE__ */ ni(() => Object.hasOwnProperty.call(Element.prototype, "animate"));\nfunction Hd(t) {\n  const { motionValue: e, name: n, repeatDelay: s, repeatType: i, damping: r, type: o } = t;\n  if (!(e?.owner?.current instanceof HTMLElement))\n    return !1;\n  const { onUpdate: l, transformTemplate: u } = e.owner.getProps();\n  return Gd() && n && Kd.has(n) && (n !== "transform" || !u) && /**\n   * If we\'re outputting values to onUpdate then we can\'t use WAAPI as there\'s\n   * no way to read the value from WAAPI every frame.\n   */\n  !l && !s && i !== "mirror" && r !== 0 && o !== "inertia";\n}\nconst Xd = 40;\nclass Yd extends hi {\n  constructor({ autoplay: e = !0, delay: n = 0, type: s = "keyframes", repeat: i = 0, repeatDelay: r = 0, repeatType: o = "loop", keyframes: a, name: l, motionValue: u, element: c, ...d }) {\n    super(), this.stop = () => {\n      this._animation && (this._animation.stop(), this.stopTimeline?.()), this.keyframeResolver?.cancel();\n    }, this.createdAt = yt.now();\n    const h = {\n      autoplay: e,\n      delay: n,\n      type: s,\n      repeat: i,\n      repeatDelay: r,\n      repeatType: o,\n      name: l,\n      motionValue: u,\n      element: c,\n      ...d\n    }, f = c?.KeyframeResolver || pi;\n    this.keyframeResolver = new f(a, (g, v, y) => this.onKeyframesResolved(g, v, h, !y), l, u, c), this.keyframeResolver?.scheduleResolve();\n  }\n  onKeyframesResolved(e, n, s, i) {\n    this.keyframeResolver = void 0;\n    const { name: r, type: o, velocity: a, delay: l, isHandoff: u, onUpdate: c } = s;\n    this.resolvedAt = yt.now(), Wd(e, r, o, a) || ((Ht.instantAnimations || !l) && c?.(di(e, s, n)), e[0] = e[e.length - 1], Ms(s), s.repeat = 0);\n    const h = {\n      startTime: i ? this.resolvedAt ? this.resolvedAt - this.createdAt > Xd ? this.resolvedAt : this.createdAt : this.createdAt : void 0,\n      finalKeyframe: n,\n      ...s,\n      keyframes: e\n    }, f = !u && Hd(h) ? new Ud({\n      ...h,\n      element: h.motionValue.owner.current\n    }) : new fi(h);\n    f.finished.then(() => this.notifyFinished()).catch(Mt), this.pendingTimeline && (this.stopTimeline = f.attachTimeline(this.pendingTimeline), this.pendingTimeline = void 0), this._animation = f;\n  }\n  get finished() {\n    return this._animation ? this.animation.finished : this._finished;\n  }\n  then(e, n) {\n    return this.finished.finally(e).then(() => {\n    });\n  }\n  get animation() {\n    return this._animation || (this.keyframeResolver?.resume(), Vd()), this._animation;\n  }\n  get duration() {\n    return this.animation.duration;\n  }\n  get iterationDuration() {\n    return this.animation.iterationDuration;\n  }\n  get time() {\n    return this.animation.time;\n  }\n  set time(e) {\n    this.animation.time = e;\n  }\n  get speed() {\n    return this.animation.speed;\n  }\n  get state() {\n    return this.animation.state;\n  }\n  set speed(e) {\n    this.animation.speed = e;\n  }\n  get startTime() {\n    return this.animation.startTime;\n  }\n  attachTimeline(e) {\n    return this._animation ? this.stopTimeline = this.animation.attachTimeline(e) : this.pendingTimeline = e, () => this.stop();\n  }\n  play() {\n    this.animation.play();\n  }\n  pause() {\n    this.animation.pause();\n  }\n  complete() {\n    this.animation.complete();\n  }\n  cancel() {\n    this._animation && this.animation.cancel(), this.keyframeResolver?.cancel();\n  }\n}\nconst qd = (\n  // eslint-disable-next-line redos-detector/no-unsafe-regex -- false positive, as it can match a lot of words\n  /^var\\(--(?:([\\w-]+)|([\\w-]+), ?([a-zA-Z\\d ()%#.,-]+))\\)/u\n);\nfunction Jd(t) {\n  const e = qd.exec(t);\n  if (!e)\n    return [,];\n  const [, n, s, i] = e;\n  return [`--${n ?? s}`, i];\n}\nfunction xa(t, e, n = 1) {\n  const [s, i] = Jd(t);\n  if (!s)\n    return;\n  const r = window.getComputedStyle(e).getPropertyValue(s);\n  if (r) {\n    const o = r.trim();\n    return $o(o) ? parseFloat(o) : o;\n  }\n  return oi(i) ? xa(i, e, n + 1) : i;\n}\nfunction mi(t, e) {\n  return t?.[e] ?? t?.default ?? t;\n}\nconst ba = /* @__PURE__ */ new Set([\n  "width",\n  "height",\n  "top",\n  "left",\n  "right",\n  "bottom",\n  ...Re\n]), Zd = {\n  test: (t) => t === "auto",\n  parse: (t) => t\n}, wa = (t) => (e) => e.test(t), Ta = [Pe, I, zt, Qt, zu, Uu, Zd], cr = (t) => Ta.find(wa(t));\nfunction Qd(t) {\n  return typeof t == "number" ? t === 0 : t !== null ? t === "none" || t === "0" || Uo(t) : !0;\n}\nconst th = /* @__PURE__ */ new Set(["brightness", "contrast", "saturate", "opacity"]);\nfunction eh(t) {\n  const [e, n] = t.slice(0, -1).split("(");\n  if (e === "drop-shadow")\n    return t;\n  const [s] = n.match(ai) || [];\n  if (!s)\n    return t;\n  const i = n.replace(s, "");\n  let r = th.has(e) ? 1 : 0;\n  return s !== n && (r *= 100), e + "(" + r + i + ")";\n}\nconst nh = /\\b([a-z-]*)\\(.*?\\)/gu, Es = {\n  ...ne,\n  getAnimatableNone: (t) => {\n    const e = t.match(nh);\n    return e ? e.map(eh).join(" ") : t;\n  }\n}, ur = {\n  ...Pe,\n  transform: Math.round\n}, sh = {\n  rotate: Qt,\n  rotateX: Qt,\n  rotateY: Qt,\n  rotateZ: Qt,\n  scale: hn,\n  scaleX: hn,\n  scaleY: hn,\n  scaleZ: hn,\n  skew: Qt,\n  skewX: Qt,\n  skewY: Qt,\n  distance: I,\n  translateX: I,\n  translateY: I,\n  translateZ: I,\n  x: I,\n  y: I,\n  z: I,\n  perspective: I,\n  transformPerspective: I,\n  opacity: Ye,\n  originX: Ji,\n  originY: Ji,\n  originZ: I\n}, gi = {\n  // Border props\n  borderWidth: I,\n  borderTopWidth: I,\n  borderRightWidth: I,\n  borderBottomWidth: I,\n  borderLeftWidth: I,\n  borderRadius: I,\n  radius: I,\n  borderTopLeftRadius: I,\n  borderTopRightRadius: I,\n  borderBottomRightRadius: I,\n  borderBottomLeftRadius: I,\n  // Positioning props\n  width: I,\n  maxWidth: I,\n  height: I,\n  maxHeight: I,\n  top: I,\n  right: I,\n  bottom: I,\n  left: I,\n  // Spacing props\n  padding: I,\n  paddingTop: I,\n  paddingRight: I,\n  paddingBottom: I,\n  paddingLeft: I,\n  margin: I,\n  marginTop: I,\n  marginRight: I,\n  marginBottom: I,\n  marginLeft: I,\n  // Misc\n  backgroundPositionX: I,\n  backgroundPositionY: I,\n  ...sh,\n  zIndex: ur,\n  // SVG\n  fillOpacity: Ye,\n  strokeOpacity: Ye,\n  numOctaves: ur\n}, ih = {\n  ...gi,\n  // Color props\n  color: nt,\n  backgroundColor: nt,\n  outlineColor: nt,\n  fill: nt,\n  stroke: nt,\n  // Border props\n  borderColor: nt,\n  borderTopColor: nt,\n  borderRightColor: nt,\n  borderBottomColor: nt,\n  borderLeftColor: nt,\n  filter: Es,\n  WebkitFilter: Es\n}, Sa = (t) => ih[t];\nfunction Da(t, e) {\n  let n = Sa(t);\n  return n !== Es && (n = ne), n.getAnimatableNone ? n.getAnimatableNone(e) : void 0;\n}\nconst rh = /* @__PURE__ */ new Set(["auto", "none", "0"]);\nfunction oh(t, e, n) {\n  let s = 0, i;\n  for (; s < t.length && !i; ) {\n    const r = t[s];\n    typeof r == "string" && !rh.has(r) && qe(r).values.length && (i = t[s]), s++;\n  }\n  if (i && n)\n    for (const r of e)\n      t[r] = Da(n, i);\n}\nclass ah extends pi {\n  constructor(e, n, s, i, r) {\n    super(e, n, s, i, r, !0);\n  }\n  readKeyframes() {\n    const { unresolvedKeyframes: e, element: n, name: s } = this;\n    if (!n || !n.current)\n      return;\n    super.readKeyframes();\n    for (let l = 0; l < e.length; l++) {\n      let u = e[l];\n      if (typeof u == "string" && (u = u.trim(), oi(u))) {\n        const c = xa(u, n.current);\n        c !== void 0 && (e[l] = c), l === e.length - 1 && (this.finalKeyframe = u);\n      }\n    }\n    if (this.resolveNoneKeyframes(), !ba.has(s) || e.length !== 2)\n      return;\n    const [i, r] = e, o = cr(i), a = cr(r);\n    if (o !== a)\n      if (rr(o) && rr(a))\n        for (let l = 0; l < e.length; l++) {\n          const u = e[l];\n          typeof u == "string" && (e[l] = parseFloat(u));\n        }\n      else ue[s] && (this.needsMeasurement = !0);\n  }\n  resolveNoneKeyframes() {\n    const { unresolvedKeyframes: e, name: n } = this, s = [];\n    for (let i = 0; i < e.length; i++)\n      (e[i] === null || Qd(e[i])) && s.push(i);\n    s.length && oh(e, s, n);\n  }\n  measureInitialState() {\n    const { element: e, unresolvedKeyframes: n, name: s } = this;\n    if (!e || !e.current)\n      return;\n    s === "height" && (this.suspendedScrollY = window.pageYOffset), this.measuredOrigin = ue[s](e.measureViewportBox(), window.getComputedStyle(e.current)), n[0] = this.measuredOrigin;\n    const i = n[n.length - 1];\n    i !== void 0 && e.getValue(s, i).jump(i, !1);\n  }\n  measureEndState() {\n    const { element: e, name: n, unresolvedKeyframes: s } = this;\n    if (!e || !e.current)\n      return;\n    const i = e.getValue(n);\n    i && i.jump(this.measuredOrigin, !1);\n    const r = s.length - 1, o = s[r];\n    s[r] = ue[n](e.measureViewportBox(), window.getComputedStyle(e.current)), o !== null && this.finalKeyframe === void 0 && (this.finalKeyframe = o), this.removedTransforms?.length && this.removedTransforms.forEach(([a, l]) => {\n      e.getValue(a).set(l);\n    }), this.resolveNoneKeyframes();\n  }\n}\nfunction lh(t, e, n) {\n  if (t instanceof EventTarget)\n    return [t];\n  if (typeof t == "string") {\n    let s = document;\n    const i = n?.[t] ?? s.querySelectorAll(t);\n    return i ? Array.from(i) : [];\n  }\n  return Array.from(t);\n}\nconst Ca = (t, e) => e && typeof t == "number" ? e.transform(t) : t;\nfunction Aa(t) {\n  return _o(t) && "offsetHeight" in t;\n}\nconst dr = 30, ch = (t) => !isNaN(parseFloat(t));\nclass uh {\n  /**\n   * @param init - The initiating value\n   * @param config - Optional configuration options\n   *\n   * -  `transformer`: A function to transform incoming values with.\n   */\n  constructor(e, n = {}) {\n    this.canTrackVelocity = null, this.events = {}, this.updateAndNotify = (s) => {\n      const i = yt.now();\n      if (this.updatedAt !== i && this.setPrevFrameValue(), this.prev = this.current, this.setCurrent(s), this.current !== this.prev && (this.events.change?.notify(this.current), this.dependents))\n        for (const r of this.dependents)\n          r.dirty();\n    }, this.hasAnimated = !1, this.setCurrent(e), this.owner = n.owner;\n  }\n  setCurrent(e) {\n    this.current = e, this.updatedAt = yt.now(), this.canTrackVelocity === null && e !== void 0 && (this.canTrackVelocity = ch(this.current));\n  }\n  setPrevFrameValue(e = this.current) {\n    this.prevFrameValue = e, this.prevUpdatedAt = this.updatedAt;\n  }\n  /**\n   * Adds a function that will be notified when the `MotionValue` is updated.\n   *\n   * It returns a function that, when called, will cancel the subscription.\n   *\n   * When calling `onChange` inside a React component, it should be wrapped with the\n   * `useEffect` hook. As it returns an unsubscribe function, this should be returned\n   * from the `useEffect` function to ensure you don\'t add duplicate subscribers..\n   *\n   * ```jsx\n   * export const MyComponent = () => {\n   *   const x = useMotionValue(0)\n   *   const y = useMotionValue(0)\n   *   const opacity = useMotionValue(1)\n   *\n   *   useEffect(() => {\n   *     function updateOpacity() {\n   *       const maxXY = Math.max(x.get(), y.get())\n   *       const newOpacity = transform(maxXY, [0, 100], [1, 0])\n   *       opacity.set(newOpacity)\n   *     }\n   *\n   *     const unsubscribeX = x.on("change", updateOpacity)\n   *     const unsubscribeY = y.on("change", updateOpacity)\n   *\n   *     return () => {\n   *       unsubscribeX()\n   *       unsubscribeY()\n   *     }\n   *   }, [])\n   *\n   *   return <motion.div style={{ x }} />\n   * }\n   * ```\n   *\n   * @param subscriber - A function that receives the latest value.\n   * @returns A function that, when called, will cancel this subscription.\n   *\n   * @deprecated\n   */\n  onChange(e) {\n    return this.on("change", e);\n  }\n  on(e, n) {\n    this.events[e] || (this.events[e] = new si());\n    const s = this.events[e].add(n);\n    return e === "change" ? () => {\n      s(), Y.read(() => {\n        this.events.change.getSize() || this.stop();\n      });\n    } : s;\n  }\n  clearListeners() {\n    for (const e in this.events)\n      this.events[e].clear();\n  }\n  /**\n   * Attaches a passive effect to the `MotionValue`.\n   */\n  attach(e, n) {\n    this.passiveEffect = e, this.stopPassiveEffect = n;\n  }\n  /**\n   * Sets the state of the `MotionValue`.\n   *\n   * @remarks\n   *\n   * ```jsx\n   * const x = useMotionValue(0)\n   * x.set(10)\n   * ```\n   *\n   * @param latest - Latest value to set.\n   * @param render - Whether to notify render subscribers. Defaults to `true`\n   *\n   * @public\n   */\n  set(e) {\n    this.passiveEffect ? this.passiveEffect(e, this.updateAndNotify) : this.updateAndNotify(e);\n  }\n  setWithVelocity(e, n, s) {\n    this.set(n), this.prev = void 0, this.prevFrameValue = e, this.prevUpdatedAt = this.updatedAt - s;\n  }\n  /**\n   * Set the state of the `MotionValue`, stopping any active animations,\n   * effects, and resets velocity to `0`.\n   */\n  jump(e, n = !0) {\n    this.updateAndNotify(e), this.prev = e, this.prevUpdatedAt = this.prevFrameValue = void 0, n && this.stop(), this.stopPassiveEffect && this.stopPassiveEffect();\n  }\n  dirty() {\n    this.events.change?.notify(this.current);\n  }\n  addDependent(e) {\n    this.dependents || (this.dependents = /* @__PURE__ */ new Set()), this.dependents.add(e);\n  }\n  removeDependent(e) {\n    this.dependents && this.dependents.delete(e);\n  }\n  /**\n   * Returns the latest state of `MotionValue`\n   *\n   * @returns - The latest state of `MotionValue`\n   *\n   * @public\n   */\n  get() {\n    return this.current;\n  }\n  /**\n   * @public\n   */\n  getPrevious() {\n    return this.prev;\n  }\n  /**\n   * Returns the latest velocity of `MotionValue`\n   *\n   * @returns - The latest velocity of `MotionValue`. Returns `0` if the state is non-numerical.\n   *\n   * @public\n   */\n  getVelocity() {\n    const e = yt.now();\n    if (!this.canTrackVelocity || this.prevFrameValue === void 0 || e - this.updatedAt > dr)\n      return 0;\n    const n = Math.min(this.updatedAt - this.prevUpdatedAt, dr);\n    return zo(parseFloat(this.current) - parseFloat(this.prevFrameValue), n);\n  }\n  /**\n   * Registers a new animation to control this `MotionValue`. Only one\n   * animation can drive a `MotionValue` at one time.\n   *\n   * ```jsx\n   * value.start()\n   * ```\n   *\n   * @param animation - A function that starts the provided animation\n   */\n  start(e) {\n    return this.stop(), new Promise((n) => {\n      this.hasAnimated = !0, this.animation = e(n), this.events.animationStart && this.events.animationStart.notify();\n    }).then(() => {\n      this.events.animationComplete && this.events.animationComplete.notify(), this.clearAnimation();\n    });\n  }\n  /**\n   * Stop the currently active animation.\n   *\n   * @public\n   */\n  stop() {\n    this.animation && (this.animation.stop(), this.events.animationCancel && this.events.animationCancel.notify()), this.clearAnimation();\n  }\n  /**\n   * Returns `true` if this value is currently animating.\n   *\n   * @public\n   */\n  isAnimating() {\n    return !!this.animation;\n  }\n  clearAnimation() {\n    delete this.animation;\n  }\n  /**\n   * Destroy and clean up subscribers to this `MotionValue`.\n   *\n   * The `MotionValue` hooks like `useMotionValue` and `useTransform` automatically\n   * handle the lifecycle of the returned `MotionValue`, so this method is only necessary if you\'ve manually\n   * created a `MotionValue` via the `motionValue` function.\n   *\n   * @public\n   */\n  destroy() {\n    this.dependents?.clear(), this.events.destroy?.notify(), this.clearListeners(), this.stop(), this.stopPassiveEffect && this.stopPassiveEffect();\n  }\n}\nfunction Te(t, e) {\n  return new uh(t, e);\n}\nconst { schedule: yi } = /* @__PURE__ */ ta(queueMicrotask, !1), It = {\n  x: !1,\n  y: !1\n};\nfunction Pa() {\n  return It.x || It.y;\n}\nfunction dh(t) {\n  return t === "x" || t === "y" ? It[t] ? null : (It[t] = !0, () => {\n    It[t] = !1;\n  }) : It.x || It.y ? null : (It.x = It.y = !0, () => {\n    It.x = It.y = !1;\n  });\n}\nfunction Ra(t, e) {\n  const n = lh(t), s = new AbortController(), i = {\n    passive: !0,\n    ...e,\n    signal: s.signal\n  };\n  return [n, i, () => s.abort()];\n}\nfunction hr(t) {\n  return !(t.pointerType === "touch" || Pa());\n}\nfunction hh(t, e, n = {}) {\n  const [s, i, r] = Ra(t, n), o = (a) => {\n    if (!hr(a))\n      return;\n    const { target: l } = a, u = e(l, a);\n    if (typeof u != "function" || !l)\n      return;\n    const c = (d) => {\n      hr(d) && (u(d), l.removeEventListener("pointerleave", c));\n    };\n    l.addEventListener("pointerleave", c, i);\n  };\n  return s.forEach((a) => {\n    a.addEventListener("pointerenter", o, i);\n  }), r;\n}\nconst Ma = (t, e) => e ? t === e ? !0 : Ma(t, e.parentElement) : !1, vi = (t) => t.pointerType === "mouse" ? typeof t.button != "number" || t.button <= 0 : t.isPrimary !== !1, fh = /* @__PURE__ */ new Set([\n  "BUTTON",\n  "INPUT",\n  "SELECT",\n  "TEXTAREA",\n  "A"\n]);\nfunction ph(t) {\n  return fh.has(t.tagName) || t.tabIndex !== -1;\n}\nconst yn = /* @__PURE__ */ new WeakSet();\nfunction fr(t) {\n  return (e) => {\n    e.key === "Enter" && t(e);\n  };\n}\nfunction Jn(t, e) {\n  t.dispatchEvent(new PointerEvent("pointer" + e, { isPrimary: !0, bubbles: !0 }));\n}\nconst mh = (t, e) => {\n  const n = t.currentTarget;\n  if (!n)\n    return;\n  const s = fr(() => {\n    if (yn.has(n))\n      return;\n    Jn(n, "down");\n    const i = fr(() => {\n      Jn(n, "up");\n    }), r = () => Jn(n, "cancel");\n    n.addEventListener("keyup", i, e), n.addEventListener("blur", r, e);\n  });\n  n.addEventListener("keydown", s, e), n.addEventListener("blur", () => n.removeEventListener("keydown", s), e);\n};\nfunction pr(t) {\n  return vi(t) && !Pa();\n}\nfunction gh(t, e, n = {}) {\n  const [s, i, r] = Ra(t, n), o = (a) => {\n    const l = a.currentTarget;\n    if (!pr(a))\n      return;\n    yn.add(l);\n    const u = e(l, a), c = (f, g) => {\n      window.removeEventListener("pointerup", d), window.removeEventListener("pointercancel", h), yn.has(l) && yn.delete(l), pr(f) && typeof u == "function" && u(f, { success: g });\n    }, d = (f) => {\n      c(f, l === window || l === document || n.useGlobalTarget || Ma(l, f.target));\n    }, h = (f) => {\n      c(f, !1);\n    };\n    window.addEventListener("pointerup", d, i), window.addEventListener("pointercancel", h, i);\n  };\n  return s.forEach((a) => {\n    (n.useGlobalTarget ? window : a).addEventListener("pointerdown", o, i), Aa(a) && (a.addEventListener("focus", (u) => mh(u, i)), !ph(a) && !a.hasAttribute("tabindex") && (a.tabIndex = 0));\n  }), r;\n}\nfunction Ea(t) {\n  return _o(t) && "ownerSVGElement" in t;\n}\nfunction yh(t) {\n  return Ea(t) && t.tagName === "svg";\n}\nconst ft = (t) => !!(t && t.getVelocity), vh = [...Ta, nt, ne], xh = (t) => vh.find(wa(t)), xi = Lt({\n  transformPagePoint: (t) => t,\n  isStatic: !1,\n  reducedMotion: "never"\n});\nfunction mr(t, e) {\n  if (typeof t == "function")\n    return t(e);\n  t != null && (t.current = e);\n}\nfunction bh(...t) {\n  return (e) => {\n    let n = !1;\n    const s = t.map((i) => {\n      const r = mr(i, e);\n      return !n && typeof r == "function" && (n = !0), r;\n    });\n    if (n)\n      return () => {\n        for (let i = 0; i < s.length; i++) {\n          const r = s[i];\n          typeof r == "function" ? r() : mr(t[i], null);\n        }\n      };\n  };\n}\nfunction wh(...t) {\n  return En.useCallback(bh(...t), t);\n}\nclass Th extends En.Component {\n  getSnapshotBeforeUpdate(e) {\n    const n = this.props.childRef.current;\n    if (n && e.isPresent && !this.props.isPresent) {\n      const s = n.offsetParent, i = Aa(s) && s.offsetWidth || 0, r = this.props.sizeRef.current;\n      r.height = n.offsetHeight || 0, r.width = n.offsetWidth || 0, r.top = n.offsetTop, r.left = n.offsetLeft, r.right = i - r.width - r.left;\n    }\n    return null;\n  }\n  /**\n   * Required with getSnapshotBeforeUpdate to stop React complaining.\n   */\n  componentDidUpdate() {\n  }\n  render() {\n    return this.props.children;\n  }\n}\nfunction Sh({ children: t, isPresent: e, anchorX: n, root: s }) {\n  const i = $s(), r = j(null), o = j({\n    width: 0,\n    height: 0,\n    top: 0,\n    left: 0,\n    right: 0\n  }), { nonce: a } = q(xi), l = wh(r, t?.ref);\n  return po(() => {\n    const { width: u, height: c, top: d, left: h, right: f } = o.current;\n    if (e || !r.current || !u || !c)\n      return;\n    const g = n === "left" ? `left: ${h}` : `right: ${f}`;\n    r.current.dataset.motionPopId = i;\n    const v = document.createElement("style");\n    a && (v.nonce = a);\n    const y = s ?? document.head;\n    return y.appendChild(v), v.sheet && v.sheet.insertRule(`\n          [data-motion-pop-id="${i}"] {\n            position: absolute !important;\n            width: ${u}px !important;\n            height: ${c}px !important;\n            ${g}px !important;\n            top: ${d}px !important;\n          }\n        `), () => {\n      y.contains(v) && y.removeChild(v);\n    };\n  }, [e]), p.jsx(Th, { isPresent: e, childRef: r, sizeRef: o, children: En.cloneElement(t, { ref: l }) });\n}\nconst Dh = ({ children: t, initial: e, isPresent: n, onExitComplete: s, custom: i, presenceAffectsLayout: r, mode: o, anchorX: a, root: l }) => {\n  const u = Js(Ch), c = $s();\n  let d = !0, h = W(() => (d = !1, {\n    id: c,\n    initial: e,\n    isPresent: n,\n    custom: i,\n    onExitComplete: (f) => {\n      u.set(f, !0);\n      for (const g of u.values())\n        if (!g)\n          return;\n      s && s();\n    },\n    register: (f) => (u.set(f, !1), () => u.delete(f))\n  }), [n, u, s]);\n  return r && d && (h = { ...h }), W(() => {\n    u.forEach((f, g) => u.set(g, !1));\n  }, [n]), En.useEffect(() => {\n    !n && !u.size && s && s();\n  }, [n]), o === "popLayout" && (t = p.jsx(Sh, { isPresent: n, anchorX: a, root: l, children: t })), p.jsx(jn.Provider, { value: h, children: t });\n};\nfunction Ch() {\n  return /* @__PURE__ */ new Map();\n}\nfunction Va(t = !0) {\n  const e = q(jn);\n  if (e === null)\n    return [!0, null];\n  const { isPresent: n, onExitComplete: s, register: i } = e, r = $s();\n  B(() => {\n    if (t)\n      return i(r);\n  }, [t]);\n  const o = lt(() => t && s && s(r), [r, s, t]);\n  return !n && s ? [!1, o] : [!0];\n}\nconst fn = (t) => t.key || "";\nfunction gr(t) {\n  const e = [];\n  return Ml.forEach(t, (n) => {\n    El(n) && e.push(n);\n  }), e;\n}\nconst Ah = ({ children: t, custom: e, initial: n = !0, onExitComplete: s, presenceAffectsLayout: i = !0, mode: r = "sync", propagate: o = !1, anchorX: a = "left", root: l }) => {\n  const [u, c] = Va(o), d = W(() => gr(t), [t]), h = o && !u ? [] : d.map(fn), f = j(!0), g = j(d), v = Js(() => /* @__PURE__ */ new Map()), [y, x] = L(d), [T, b] = L(d);\n  Bo(() => {\n    f.current = !1, g.current = d;\n    for (let R = 0; R < T.length; R++) {\n      const m = fn(T[R]);\n      h.includes(m) ? v.delete(m) : v.get(m) !== !0 && v.set(m, !1);\n    }\n  }, [T, h.length, h.join("-")]);\n  const P = [];\n  if (d !== y) {\n    let R = [...d];\n    for (let m = 0; m < T.length; m++) {\n      const w = T[m], C = fn(w);\n      h.includes(C) || (R.splice(m, 0, w), P.push(w));\n    }\n    return r === "wait" && P.length && (R = P), b(gr(R)), x(d), null;\n  }\n  const { forceRender: D } = q(qs);\n  return p.jsx(p.Fragment, { children: T.map((R) => {\n    const m = fn(R), w = o && !u ? !1 : d === T || h.includes(m), C = () => {\n      if (v.has(m))\n        v.set(m, !0);\n      else\n        return;\n      let M = !0;\n      v.forEach((S) => {\n        S || (M = !1);\n      }), M && (D?.(), b(g.current), o && c?.(), s && s());\n    };\n    return p.jsx(Dh, { isPresent: w, initial: !f.current || n ? void 0 : !1, custom: e, presenceAffectsLayout: i, mode: r, root: l, onExitComplete: w ? void 0 : C, anchorX: a, children: R }, m);\n  }) });\n}, Na = Lt({ strict: !1 }), yr = {\n  animation: [\n    "animate",\n    "variants",\n    "whileHover",\n    "whileTap",\n    "exit",\n    "whileInView",\n    "whileFocus",\n    "whileDrag"\n  ],\n  exit: ["exit"],\n  drag: ["drag", "dragControls"],\n  focus: ["whileFocus"],\n  hover: ["whileHover", "onHoverStart", "onHoverEnd"],\n  tap: ["whileTap", "onTap", "onTapStart", "onTapCancel"],\n  pan: ["onPan", "onPanStart", "onPanSessionStart", "onPanEnd"],\n  inView: ["whileInView", "onViewportEnter", "onViewportLeave"],\n  layout: ["layout", "layoutId"]\n}, Se = {};\nfor (const t in yr)\n  Se[t] = {\n    isEnabled: (e) => yr[t].some((n) => !!e[n])\n  };\nfunction Ph(t) {\n  for (const e in t)\n    Se[e] = {\n      ...Se[e],\n      ...t[e]\n    };\n}\nconst Rh = /* @__PURE__ */ new Set([\n  "animate",\n  "exit",\n  "variants",\n  "initial",\n  "style",\n  "values",\n  "variants",\n  "transition",\n  "transformTemplate",\n  "custom",\n  "inherit",\n  "onBeforeLayoutMeasure",\n  "onAnimationStart",\n  "onAnimationComplete",\n  "onUpdate",\n  "onDragStart",\n  "onDrag",\n  "onDragEnd",\n  "onMeasureDragConstraints",\n  "onDirectionLock",\n  "onDragTransitionEnd",\n  "_dragX",\n  "_dragY",\n  "onHoverStart",\n  "onHoverEnd",\n  "onViewportEnter",\n  "onViewportLeave",\n  "globalTapTarget",\n  "ignoreStrict",\n  "viewport"\n]);\nfunction Pn(t) {\n  return t.startsWith("while") || t.startsWith("drag") && t !== "draggable" || t.startsWith("layout") || t.startsWith("onTap") || t.startsWith("onPan") || t.startsWith("onLayout") || Rh.has(t);\n}\nlet ka = (t) => !Pn(t);\nfunction Mh(t) {\n  typeof t == "function" && (ka = (e) => e.startsWith("on") ? !Pn(e) : t(e));\n}\ntry {\n  Mh(require("@emotion/is-prop-valid").default);\n} catch {\n}\nfunction Eh(t, e, n) {\n  const s = {};\n  for (const i in t)\n    i === "values" && typeof t.values == "object" || (ka(i) || n === !0 && Pn(i) || !e && !Pn(i) || // If trying to use native HTML drag events, forward drag listeners\n    t.draggable && i.startsWith("onDrag")) && (s[i] = t[i]);\n  return s;\n}\nconst Ln = /* @__PURE__ */ Lt({});\nfunction On(t) {\n  return t !== null && typeof t == "object" && typeof t.start == "function";\n}\nfunction Je(t) {\n  return typeof t == "string" || Array.isArray(t);\n}\nconst bi = [\n  "animate",\n  "whileInView",\n  "whileFocus",\n  "whileHover",\n  "whileTap",\n  "whileDrag",\n  "exit"\n], wi = ["initial", ...bi];\nfunction Fn(t) {\n  return On(t.animate) || wi.some((e) => Je(t[e]));\n}\nfunction Ia(t) {\n  return !!(Fn(t) || t.variants);\n}\nfunction Vh(t, e) {\n  if (Fn(t)) {\n    const { initial: n, animate: s } = t;\n    return {\n      initial: n === !1 || Je(n) ? n : void 0,\n      animate: Je(s) ? s : void 0\n    };\n  }\n  return t.inherit !== !1 ? e : {};\n}\nfunction Nh(t) {\n  const { initial: e, animate: n } = Vh(t, q(Ln));\n  return W(() => ({ initial: e, animate: n }), [vr(e), vr(n)]);\n}\nfunction vr(t) {\n  return Array.isArray(t) ? t.join(" ") : t;\n}\nfunction xr(t, e) {\n  return e.max === e.min ? 0 : t / (e.max - e.min) * 100;\n}\nconst je = {\n  correct: (t, e) => {\n    if (!e.target)\n      return t;\n    if (typeof t == "string")\n      if (I.test(t))\n        t = parseFloat(t);\n      else\n        return t;\n    const n = xr(t, e.target.x), s = xr(t, e.target.y);\n    return `${n}% ${s}%`;\n  }\n}, kh = {\n  correct: (t, { treeScale: e, projectionDelta: n }) => {\n    const s = t, i = ne.parse(t);\n    if (i.length > 5)\n      return s;\n    const r = ne.createTransformer(t), o = typeof i[0] != "number" ? 1 : 0, a = n.x.scale * e.x, l = n.y.scale * e.y;\n    i[0 + o] /= a, i[1 + o] /= l;\n    const u = J(a, l, 0.5);\n    return typeof i[2 + o] == "number" && (i[2 + o] /= u), typeof i[3 + o] == "number" && (i[3 + o] /= u), r(i);\n  }\n}, Vs = {\n  borderRadius: {\n    ...je,\n    applyTo: [\n      "borderTopLeftRadius",\n      "borderTopRightRadius",\n      "borderBottomLeftRadius",\n      "borderBottomRightRadius"\n    ]\n  },\n  borderTopLeftRadius: je,\n  borderTopRightRadius: je,\n  borderBottomLeftRadius: je,\n  borderBottomRightRadius: je,\n  boxShadow: kh\n};\nfunction ja(t, { layout: e, layoutId: n }) {\n  return Me.has(t) || t.startsWith("origin") || (e || n !== void 0) && (!!Vs[t] || t === "opacity");\n}\nconst Ih = {\n  x: "translateX",\n  y: "translateY",\n  z: "translateZ",\n  transformPerspective: "perspective"\n}, jh = Re.length;\nfunction Lh(t, e, n) {\n  let s = "", i = !0;\n  for (let r = 0; r < jh; r++) {\n    const o = Re[r], a = t[o];\n    if (a === void 0)\n      continue;\n    let l = !0;\n    if (typeof a == "number" ? l = a === (o.startsWith("scale") ? 1 : 0) : l = parseFloat(a) === 0, !l || n) {\n      const u = Ca(a, gi[o]);\n      if (!l) {\n        i = !1;\n        const c = Ih[o] || o;\n        s += `${c}(${u}) `;\n      }\n      n && (e[o] = u);\n    }\n  }\n  return s = s.trim(), n ? s = n(e, i ? "" : s) : i && (s = "none"), s;\n}\nfunction Ti(t, e, n) {\n  const { style: s, vars: i, transformOrigin: r } = t;\n  let o = !1, a = !1;\n  for (const l in e) {\n    const u = e[l];\n    if (Me.has(l)) {\n      o = !0;\n      continue;\n    } else if (na(l)) {\n      i[l] = u;\n      continue;\n    } else {\n      const c = Ca(u, gi[l]);\n      l.startsWith("origin") ? (a = !0, r[l] = c) : s[l] = c;\n    }\n  }\n  if (e.transform || (o || n ? s.transform = Lh(e, t.transform, n) : s.transform && (s.transform = "none")), a) {\n    const { originX: l = "50%", originY: u = "50%", originZ: c = 0 } = r;\n    s.transformOrigin = `${l} ${u} ${c}`;\n  }\n}\nconst Si = () => ({\n  style: {},\n  transform: {},\n  transformOrigin: {},\n  vars: {}\n});\nfunction La(t, e, n) {\n  for (const s in e)\n    !ft(e[s]) && !ja(s, n) && (t[s] = e[s]);\n}\nfunction Oh({ transformTemplate: t }, e) {\n  return W(() => {\n    const n = Si();\n    return Ti(n, e, t), Object.assign({}, n.vars, n.style);\n  }, [e]);\n}\nfunction Fh(t, e) {\n  const n = t.style || {}, s = {};\n  return La(s, n, t), Object.assign(s, Oh(t, e)), s;\n}\nfunction Bh(t, e) {\n  const n = {}, s = Fh(t, e);\n  return t.drag && t.dragListener !== !1 && (n.draggable = !1, s.userSelect = s.WebkitUserSelect = s.WebkitTouchCallout = "none", s.touchAction = t.drag === !0 ? "none" : `pan-${t.drag === "x" ? "y" : "x"}`), t.tabIndex === void 0 && (t.onTap || t.onTapStart || t.whileTap) && (n.tabIndex = 0), n.style = s, n;\n}\nconst $h = {\n  offset: "stroke-dashoffset",\n  array: "stroke-dasharray"\n}, _h = {\n  offset: "strokeDashoffset",\n  array: "strokeDasharray"\n};\nfunction Uh(t, e, n = 1, s = 0, i = !0) {\n  t.pathLength = 1;\n  const r = i ? $h : _h;\n  t[r.offset] = I.transform(-s);\n  const o = I.transform(e), a = I.transform(n);\n  t[r.array] = `${o} ${a}`;\n}\nfunction Oa(t, {\n  attrX: e,\n  attrY: n,\n  attrScale: s,\n  pathLength: i,\n  pathSpacing: r = 1,\n  pathOffset: o = 0,\n  // This is object creation, which we try to avoid per-frame.\n  ...a\n}, l, u, c) {\n  if (Ti(t, a, u), l) {\n    t.style.viewBox && (t.attrs.viewBox = t.style.viewBox);\n    return;\n  }\n  t.attrs = t.style, t.style = {};\n  const { attrs: d, style: h } = t;\n  d.transform && (h.transform = d.transform, delete d.transform), (h.transform || d.transformOrigin) && (h.transformOrigin = d.transformOrigin ?? "50% 50%", delete d.transformOrigin), h.transform && (h.transformBox = c?.transformBox ?? "fill-box", delete d.transformBox), e !== void 0 && (d.x = e), n !== void 0 && (d.y = n), s !== void 0 && (d.scale = s), i !== void 0 && Uh(d, i, r, o, !1);\n}\nconst Fa = () => ({\n  ...Si(),\n  attrs: {}\n}), Ba = (t) => typeof t == "string" && t.toLowerCase() === "svg";\nfunction zh(t, e, n, s) {\n  const i = W(() => {\n    const r = Fa();\n    return Oa(r, e, Ba(s), t.transformTemplate, t.style), {\n      ...r.attrs,\n      style: { ...r.style }\n    };\n  }, [e]);\n  if (t.style) {\n    const r = {};\n    La(r, t.style, t), i.style = { ...r, ...i.style };\n  }\n  return i;\n}\nconst Wh = [\n  "animate",\n  "circle",\n  "defs",\n  "desc",\n  "ellipse",\n  "g",\n  "image",\n  "line",\n  "filter",\n  "marker",\n  "mask",\n  "metadata",\n  "path",\n  "pattern",\n  "polygon",\n  "polyline",\n  "rect",\n  "stop",\n  "switch",\n  "symbol",\n  "svg",\n  "text",\n  "tspan",\n  "use",\n  "view"\n];\nfunction Di(t) {\n  return (\n    /**\n     * If it\'s not a string, it\'s a custom React component. Currently we only support\n     * HTML custom React components.\n     */\n    typeof t != "string" || /**\n     * If it contains a dash, the element is a custom HTML webcomponent.\n     */\n    t.includes("-") ? !1 : (\n      /**\n       * If it\'s in our list of lowercase SVG tags, it\'s an SVG component\n       */\n      !!(Wh.indexOf(t) > -1 || /**\n       * If it contains a capital letter, it\'s an SVG component\n       */\n      /[A-Z]/u.test(t))\n    )\n  );\n}\nfunction Kh(t, e, n, { latestValues: s }, i, r = !1) {\n  const a = (Di(t) ? zh : Bh)(e, s, i, t), l = Eh(e, typeof t == "string", r), u = t !== mo ? { ...l, ...a, ref: n } : {}, { children: c } = e, d = W(() => ft(c) ? c.get() : c, [c]);\n  return Vl(t, {\n    ...u,\n    children: d\n  });\n}\nfunction br(t) {\n  const e = [{}, {}];\n  return t?.values.forEach((n, s) => {\n    e[0][s] = n.get(), e[1][s] = n.getVelocity();\n  }), e;\n}\nfunction Ci(t, e, n, s) {\n  if (typeof e == "function") {\n    const [i, r] = br(s);\n    e = e(n !== void 0 ? n : t.custom, i, r);\n  }\n  if (typeof e == "string" && (e = t.variants && t.variants[e]), typeof e == "function") {\n    const [i, r] = br(s);\n    e = e(n !== void 0 ? n : t.custom, i, r);\n  }\n  return e;\n}\nfunction vn(t) {\n  return ft(t) ? t.get() : t;\n}\nfunction Gh({ scrapeMotionValuesFromProps: t, createRenderState: e }, n, s, i) {\n  return {\n    latestValues: Hh(n, s, i, t),\n    renderState: e()\n  };\n}\nfunction Hh(t, e, n, s) {\n  const i = {}, r = s(t, {});\n  for (const h in r)\n    i[h] = vn(r[h]);\n  let { initial: o, animate: a } = t;\n  const l = Fn(t), u = Ia(t);\n  e && u && !l && t.inherit !== !1 && (o === void 0 && (o = e.initial), a === void 0 && (a = e.animate));\n  let c = n ? n.initial === !1 : !1;\n  c = c || o === !1;\n  const d = c ? a : o;\n  if (d && typeof d != "boolean" && !On(d)) {\n    const h = Array.isArray(d) ? d : [d];\n    for (let f = 0; f < h.length; f++) {\n      const g = Ci(t, h[f]);\n      if (g) {\n        const { transitionEnd: v, transition: y, ...x } = g;\n        for (const T in x) {\n          let b = x[T];\n          if (Array.isArray(b)) {\n            const P = c ? b.length - 1 : 0;\n            b = b[P];\n          }\n          b !== null && (i[T] = b);\n        }\n        for (const T in v)\n          i[T] = v[T];\n      }\n    }\n  }\n  return i;\n}\nconst $a = (t) => (e, n) => {\n  const s = q(Ln), i = q(jn), r = () => Gh(t, e, s, i);\n  return n ? r() : Js(r);\n};\nfunction Ai(t, e, n) {\n  const { style: s } = t, i = {};\n  for (const r in s)\n    (ft(s[r]) || e.style && ft(e.style[r]) || ja(r, t) || n?.getValue(r)?.liveStyle !== void 0) && (i[r] = s[r]);\n  return i;\n}\nconst Xh = /* @__PURE__ */ $a({\n  scrapeMotionValuesFromProps: Ai,\n  createRenderState: Si\n});\nfunction _a(t, e, n) {\n  const s = Ai(t, e, n);\n  for (const i in t)\n    if (ft(t[i]) || ft(e[i])) {\n      const r = Re.indexOf(i) !== -1 ? "attr" + i.charAt(0).toUpperCase() + i.substring(1) : i;\n      s[r] = t[i];\n    }\n  return s;\n}\nconst Yh = /* @__PURE__ */ $a({\n  scrapeMotionValuesFromProps: _a,\n  createRenderState: Fa\n}), qh = Symbol.for("motionComponentSymbol");\nfunction ge(t) {\n  return t && typeof t == "object" && Object.prototype.hasOwnProperty.call(t, "current");\n}\nfunction Jh(t, e, n) {\n  return lt(\n    (s) => {\n      s && t.onMount && t.onMount(s), e && (s ? e.mount(s) : e.unmount()), n && (typeof n == "function" ? n(s) : ge(n) && (n.current = s));\n    },\n    /**\n     * Include externalRef in dependencies to ensure the callback updates\n     * when the ref changes, allowing proper ref forwarding.\n     */\n    [e]\n  );\n}\nconst Pi = (t) => t.replace(/([a-z])([A-Z])/gu, "$1-$2").toLowerCase(), Zh = "framerAppearId", Ua = "data-" + Pi(Zh), za = Lt({});\nfunction Qh(t, e, n, s, i) {\n  const { visualElement: r } = q(Ln), o = q(Na), a = q(jn), l = q(xi).reducedMotion, u = j(null);\n  s = s || o.renderer, !u.current && s && (u.current = s(t, {\n    visualState: e,\n    parent: r,\n    props: n,\n    presenceContext: a,\n    blockInitialAnimation: a ? a.initial === !1 : !1,\n    reducedMotionConfig: l\n  }));\n  const c = u.current, d = q(za);\n  c && !c.projection && i && (c.type === "html" || c.type === "svg") && tf(u.current, n, i, d);\n  const h = j(!1);\n  po(() => {\n    c && h.current && c.update(n, a);\n  });\n  const f = n[Ua], g = j(!!f && !window.MotionHandoffIsComplete?.(f) && window.MotionHasOptimisedAnimation?.(f));\n  return Bo(() => {\n    c && (h.current = !0, window.MotionIsMounted = !0, c.updateFeatures(), c.scheduleRenderMicrotask(), g.current && c.animationState && c.animationState.animateChanges());\n  }), B(() => {\n    c && (!g.current && c.animationState && c.animationState.animateChanges(), g.current && (queueMicrotask(() => {\n      window.MotionHandoffMarkAsComplete?.(f);\n    }), g.current = !1), c.enteringChildren = void 0);\n  }), c;\n}\nfunction tf(t, e, n, s) {\n  const { layoutId: i, layout: r, drag: o, dragConstraints: a, layoutScroll: l, layoutRoot: u, layoutCrossfade: c } = e;\n  t.projection = new n(t.latestValues, e["data-framer-portal-id"] ? void 0 : Wa(t.parent)), t.projection.setOptions({\n    layoutId: i,\n    layout: r,\n    alwaysMeasureLayout: !!o || a && ge(a),\n    visualElement: t,\n    /**\n     * TODO: Update options in an effect. This could be tricky as it\'ll be too late\n     * to update by the time layout animations run.\n     * We also need to fix this safeToRemove by linking it up to the one returned by usePresence,\n     * ensuring it gets called if there\'s no potential layout animations.\n     *\n     */\n    animationType: typeof r == "string" ? r : "both",\n    initialPromotionConfig: s,\n    crossfade: c,\n    layoutScroll: l,\n    layoutRoot: u\n  });\n}\nfunction Wa(t) {\n  if (t)\n    return t.options.allowProjection !== !1 ? t.projection : Wa(t.parent);\n}\nfunction Zn(t, { forwardMotionProps: e = !1 } = {}, n, s) {\n  n && Ph(n);\n  const i = Di(t) ? Yh : Xh;\n  function r(a, l) {\n    let u;\n    const c = {\n      ...q(xi),\n      ...a,\n      layoutId: ef(a)\n    }, { isStatic: d } = c, h = Nh(a), f = i(a, d);\n    if (!d && Zs) {\n      nf();\n      const g = sf(c);\n      u = g.MeasureLayout, h.visualElement = Qh(t, f, c, s, g.ProjectionNode);\n    }\n    return p.jsxs(Ln.Provider, { value: h, children: [u && h.visualElement ? p.jsx(u, { visualElement: h.visualElement, ...c }) : null, Kh(t, a, Jh(f, h.visualElement, l), f, d, e)] });\n  }\n  r.displayName = `motion.${typeof t == "string" ? t : `create(${t.displayName ?? t.name ?? ""})`}`;\n  const o = Nl(r);\n  return o[qh] = t, o;\n}\nfunction ef({ layoutId: t }) {\n  const e = q(qs).id;\n  return e && t !== void 0 ? e + "-" + t : t;\n}\nfunction nf(t, e) {\n  q(Na).strict;\n}\nfunction sf(t) {\n  const { drag: e, layout: n } = Se;\n  if (!e && !n)\n    return {};\n  const s = { ...e, ...n };\n  return {\n    MeasureLayout: e?.isEnabled(t) || n?.isEnabled(t) ? s.MeasureLayout : void 0,\n    ProjectionNode: s.ProjectionNode\n  };\n}\nfunction rf(t, e) {\n  if (typeof Proxy > "u")\n    return Zn;\n  const n = /* @__PURE__ */ new Map(), s = (r, o) => Zn(r, o, t, e), i = (r, o) => s(r, o);\n  return new Proxy(i, {\n    /**\n     * Called when `motion` is referenced with a prop: `motion.div`, `motion.input` etc.\n     * The prop name is passed through as `key` and we can use that to generate a `motion`\n     * DOM component with that name.\n     */\n    get: (r, o) => o === "create" ? s : (n.has(o) || n.set(o, Zn(o, void 0, t, e)), n.get(o))\n  });\n}\nfunction Ka({ top: t, left: e, right: n, bottom: s }) {\n  return {\n    x: { min: e, max: n },\n    y: { min: t, max: s }\n  };\n}\nfunction of({ x: t, y: e }) {\n  return { top: e.min, right: t.max, bottom: e.max, left: t.min };\n}\nfunction af(t, e) {\n  if (!e)\n    return t;\n  const n = e({ x: t.left, y: t.top }), s = e({ x: t.right, y: t.bottom });\n  return {\n    top: n.y,\n    left: n.x,\n    bottom: s.y,\n    right: s.x\n  };\n}\nfunction Qn(t) {\n  return t === void 0 || t === 1;\n}\nfunction Ns({ scale: t, scaleX: e, scaleY: n }) {\n  return !Qn(t) || !Qn(e) || !Qn(n);\n}\nfunction ae(t) {\n  return Ns(t) || Ga(t) || t.z || t.rotate || t.rotateX || t.rotateY || t.skewX || t.skewY;\n}\nfunction Ga(t) {\n  return wr(t.x) || wr(t.y);\n}\nfunction wr(t) {\n  return t && t !== "0%";\n}\nfunction Rn(t, e, n) {\n  const s = t - n, i = e * s;\n  return n + i;\n}\nfunction Tr(t, e, n, s, i) {\n  return i !== void 0 && (t = Rn(t, i, s)), Rn(t, n, s) + e;\n}\nfunction ks(t, e = 0, n = 1, s, i) {\n  t.min = Tr(t.min, e, n, s, i), t.max = Tr(t.max, e, n, s, i);\n}\nfunction Ha(t, { x: e, y: n }) {\n  ks(t.x, e.translate, e.scale, e.originPoint), ks(t.y, n.translate, n.scale, n.originPoint);\n}\nconst Sr = 0.999999999999, Dr = 1.0000000000001;\nfunction lf(t, e, n, s = !1) {\n  const i = n.length;\n  if (!i)\n    return;\n  e.x = e.y = 1;\n  let r, o;\n  for (let a = 0; a < i; a++) {\n    r = n[a], o = r.projectionDelta;\n    const { visualElement: l } = r.options;\n    l && l.props.style && l.props.style.display === "contents" || (s && r.options.layoutScroll && r.scroll && r !== r.root && ve(t, {\n      x: -r.scroll.offset.x,\n      y: -r.scroll.offset.y\n    }), o && (e.x *= o.x.scale, e.y *= o.y.scale, Ha(t, o)), s && ae(r.latestValues) && ve(t, r.latestValues));\n  }\n  e.x < Dr && e.x > Sr && (e.x = 1), e.y < Dr && e.y > Sr && (e.y = 1);\n}\nfunction ye(t, e) {\n  t.min = t.min + e, t.max = t.max + e;\n}\nfunction Cr(t, e, n, s, i = 0.5) {\n  const r = J(t.min, t.max, i);\n  ks(t, e, n, r, s);\n}\nfunction ve(t, e) {\n  Cr(t.x, e.x, e.scaleX, e.scale, e.originX), Cr(t.y, e.y, e.scaleY, e.scale, e.originY);\n}\nfunction Xa(t, e) {\n  return Ka(af(t.getBoundingClientRect(), e));\n}\nfunction cf(t, e, n) {\n  const s = Xa(t, n), { scroll: i } = e;\n  return i && (ye(s.x, i.offset.x), ye(s.y, i.offset.y)), s;\n}\nconst Ar = () => ({\n  translate: 0,\n  scale: 1,\n  origin: 0,\n  originPoint: 0\n}), xe = () => ({\n  x: Ar(),\n  y: Ar()\n}), Pr = () => ({ min: 0, max: 0 }), st = () => ({\n  x: Pr(),\n  y: Pr()\n}), Is = { current: null }, Ya = { current: !1 };\nfunction uf() {\n  if (Ya.current = !0, !!Zs)\n    if (window.matchMedia) {\n      const t = window.matchMedia("(prefers-reduced-motion)"), e = () => Is.current = t.matches;\n      t.addEventListener("change", e), e();\n    } else\n      Is.current = !1;\n}\nconst df = /* @__PURE__ */ new WeakMap();\nfunction hf(t, e, n) {\n  for (const s in e) {\n    const i = e[s], r = n[s];\n    if (ft(i))\n      t.addValue(s, i);\n    else if (ft(r))\n      t.addValue(s, Te(i, { owner: t }));\n    else if (r !== i)\n      if (t.hasValue(s)) {\n        const o = t.getValue(s);\n        o.liveStyle === !0 ? o.jump(i) : o.hasAnimated || o.set(i);\n      } else {\n        const o = t.getStaticValue(s);\n        t.addValue(s, Te(o !== void 0 ? o : i, { owner: t }));\n      }\n  }\n  for (const s in n)\n    e[s] === void 0 && t.removeValue(s);\n  return e;\n}\nconst Rr = [\n  "AnimationStart",\n  "AnimationComplete",\n  "Update",\n  "BeforeLayoutMeasure",\n  "LayoutMeasure",\n  "LayoutAnimationStart",\n  "LayoutAnimationComplete"\n];\nclass ff {\n  /**\n   * This method takes React props and returns found MotionValues. For example, HTML\n   * MotionValues will be found within the style prop, whereas for Three.js within attribute arrays.\n   *\n   * This isn\'t an abstract method as it needs calling in the constructor, but it is\n   * intended to be one.\n   */\n  scrapeMotionValuesFromProps(e, n, s) {\n    return {};\n  }\n  constructor({ parent: e, props: n, presenceContext: s, reducedMotionConfig: i, blockInitialAnimation: r, visualState: o }, a = {}) {\n    this.current = null, this.children = /* @__PURE__ */ new Set(), this.isVariantNode = !1, this.isControllingVariants = !1, this.shouldReduceMotion = null, this.values = /* @__PURE__ */ new Map(), this.KeyframeResolver = pi, this.features = {}, this.valueSubscriptions = /* @__PURE__ */ new Map(), this.prevMotionValues = {}, this.events = {}, this.propEventSubscriptions = {}, this.notifyUpdate = () => this.notify("Update", this.latestValues), this.render = () => {\n      this.current && (this.triggerBuild(), this.renderInstance(this.current, this.renderState, this.props.style, this.projection));\n    }, this.renderScheduledAt = 0, this.scheduleRender = () => {\n      const h = yt.now();\n      this.renderScheduledAt < h && (this.renderScheduledAt = h, Y.render(this.render, !1, !0));\n    };\n    const { latestValues: l, renderState: u } = o;\n    this.latestValues = l, this.baseTarget = { ...l }, this.initialValues = n.initial ? { ...l } : {}, this.renderState = u, this.parent = e, this.props = n, this.presenceContext = s, this.depth = e ? e.depth + 1 : 0, this.reducedMotionConfig = i, this.options = a, this.blockInitialAnimation = !!r, this.isControllingVariants = Fn(n), this.isVariantNode = Ia(n), this.isVariantNode && (this.variantChildren = /* @__PURE__ */ new Set()), this.manuallyAnimateOnMount = !!(e && e.current);\n    const { willChange: c, ...d } = this.scrapeMotionValuesFromProps(n, {}, this);\n    for (const h in d) {\n      const f = d[h];\n      l[h] !== void 0 && ft(f) && f.set(l[h]);\n    }\n  }\n  mount(e) {\n    this.current = e, df.set(e, this), this.projection && !this.projection.instance && this.projection.mount(e), this.parent && this.isVariantNode && !this.isControllingVariants && (this.removeFromVariantTree = this.parent.addVariantChild(this)), this.values.forEach((n, s) => this.bindToMotionValue(s, n)), Ya.current || uf(), this.shouldReduceMotion = this.reducedMotionConfig === "never" ? !1 : this.reducedMotionConfig === "always" ? !0 : Is.current, this.parent?.addChild(this), this.update(this.props, this.presenceContext);\n  }\n  unmount() {\n    this.projection && this.projection.unmount(), ee(this.notifyUpdate), ee(this.render), this.valueSubscriptions.forEach((e) => e()), this.valueSubscriptions.clear(), this.removeFromVariantTree && this.removeFromVariantTree(), this.parent?.removeChild(this);\n    for (const e in this.events)\n      this.events[e].clear();\n    for (const e in this.features) {\n      const n = this.features[e];\n      n && (n.unmount(), n.isMounted = !1);\n    }\n    this.current = null;\n  }\n  addChild(e) {\n    this.children.add(e), this.enteringChildren ?? (this.enteringChildren = /* @__PURE__ */ new Set()), this.enteringChildren.add(e);\n  }\n  removeChild(e) {\n    this.children.delete(e), this.enteringChildren && this.enteringChildren.delete(e);\n  }\n  bindToMotionValue(e, n) {\n    this.valueSubscriptions.has(e) && this.valueSubscriptions.get(e)();\n    const s = Me.has(e);\n    s && this.onBindTransform && this.onBindTransform();\n    const i = n.on("change", (o) => {\n      this.latestValues[e] = o, this.props.onUpdate && Y.preRender(this.notifyUpdate), s && this.projection && (this.projection.isTransformDirty = !0), this.scheduleRender();\n    });\n    let r;\n    window.MotionCheckAppearSync && (r = window.MotionCheckAppearSync(this, e, n)), this.valueSubscriptions.set(e, () => {\n      i(), r && r(), n.owner && n.stop();\n    });\n  }\n  sortNodePosition(e) {\n    return !this.current || !this.sortInstanceNodePosition || this.type !== e.type ? 0 : this.sortInstanceNodePosition(this.current, e.current);\n  }\n  updateFeatures() {\n    let e = "animation";\n    for (e in Se) {\n      const n = Se[e];\n      if (!n)\n        continue;\n      const { isEnabled: s, Feature: i } = n;\n      if (!this.features[e] && i && s(this.props) && (this.features[e] = new i(this)), this.features[e]) {\n        const r = this.features[e];\n        r.isMounted ? r.update() : (r.mount(), r.isMounted = !0);\n      }\n    }\n  }\n  triggerBuild() {\n    this.build(this.renderState, this.latestValues, this.props);\n  }\n  /**\n   * Measure the current viewport box with or without transforms.\n   * Only measures axis-aligned boxes, rotate and skew must be manually\n   * removed with a re-render to work.\n   */\n  measureViewportBox() {\n    return this.current ? this.measureInstanceViewportBox(this.current, this.props) : st();\n  }\n  getStaticValue(e) {\n    return this.latestValues[e];\n  }\n  setStaticValue(e, n) {\n    this.latestValues[e] = n;\n  }\n  /**\n   * Update the provided props. Ensure any newly-added motion values are\n   * added to our map, old ones removed, and listeners updated.\n   */\n  update(e, n) {\n    (e.transformTemplate || this.props.transformTemplate) && this.scheduleRender(), this.prevProps = this.props, this.props = e, this.prevPresenceContext = this.presenceContext, this.presenceContext = n;\n    for (let s = 0; s < Rr.length; s++) {\n      const i = Rr[s];\n      this.propEventSubscriptions[i] && (this.propEventSubscriptions[i](), delete this.propEventSubscriptions[i]);\n      const r = "on" + i, o = e[r];\n      o && (this.propEventSubscriptions[i] = this.on(i, o));\n    }\n    this.prevMotionValues = hf(this, this.scrapeMotionValuesFromProps(e, this.prevProps, this), this.prevMotionValues), this.handleChildMotionValue && this.handleChildMotionValue();\n  }\n  getProps() {\n    return this.props;\n  }\n  /**\n   * Returns the variant definition with a given name.\n   */\n  getVariant(e) {\n    return this.props.variants ? this.props.variants[e] : void 0;\n  }\n  /**\n   * Returns the defined default transition on this component.\n   */\n  getDefaultTransition() {\n    return this.props.transition;\n  }\n  getTransformPagePoint() {\n    return this.props.transformPagePoint;\n  }\n  getClosestVariantNode() {\n    return this.isVariantNode ? this : this.parent ? this.parent.getClosestVariantNode() : void 0;\n  }\n  /**\n   * Add a child visual element to our set of children.\n   */\n  addVariantChild(e) {\n    const n = this.getClosestVariantNode();\n    if (n)\n      return n.variantChildren && n.variantChildren.add(e), () => n.variantChildren.delete(e);\n  }\n  /**\n   * Add a motion value and bind it to this visual element.\n   */\n  addValue(e, n) {\n    const s = this.values.get(e);\n    n !== s && (s && this.removeValue(e), this.bindToMotionValue(e, n), this.values.set(e, n), this.latestValues[e] = n.get());\n  }\n  /**\n   * Remove a motion value and unbind any active subscriptions.\n   */\n  removeValue(e) {\n    this.values.delete(e);\n    const n = this.valueSubscriptions.get(e);\n    n && (n(), this.valueSubscriptions.delete(e)), delete this.latestValues[e], this.removeValueFromRenderState(e, this.renderState);\n  }\n  /**\n   * Check whether we have a motion value for this key\n   */\n  hasValue(e) {\n    return this.values.has(e);\n  }\n  getValue(e, n) {\n    if (this.props.values && this.props.values[e])\n      return this.props.values[e];\n    let s = this.values.get(e);\n    return s === void 0 && n !== void 0 && (s = Te(n === null ? void 0 : n, { owner: this }), this.addValue(e, s)), s;\n  }\n  /**\n   * If we\'re trying to animate to a previously unencountered value,\n   * we need to check for it in our state and as a last resort read it\n   * directly from the instance (which might have performance implications).\n   */\n  readValue(e, n) {\n    let s = this.latestValues[e] !== void 0 || !this.current ? this.latestValues[e] : this.getBaseTargetFromProps(this.props, e) ?? this.readValueFromInstance(this.current, e, this.options);\n    return s != null && (typeof s == "string" && ($o(s) || Uo(s)) ? s = parseFloat(s) : !xh(s) && ne.test(n) && (s = Da(e, n)), this.setBaseTarget(e, ft(s) ? s.get() : s)), ft(s) ? s.get() : s;\n  }\n  /**\n   * Set the base target to later animate back to. This is currently\n   * only hydrated on creation and when we first read a value.\n   */\n  setBaseTarget(e, n) {\n    this.baseTarget[e] = n;\n  }\n  /**\n   * Find the base target for a value thats been removed from all animation\n   * props.\n   */\n  getBaseTarget(e) {\n    const { initial: n } = this.props;\n    let s;\n    if (typeof n == "string" || typeof n == "object") {\n      const r = Ci(this.props, n, this.presenceContext?.custom);\n      r && (s = r[e]);\n    }\n    if (n && s !== void 0)\n      return s;\n    const i = this.getBaseTargetFromProps(this.props, e);\n    return i !== void 0 && !ft(i) ? i : this.initialValues[e] !== void 0 && s === void 0 ? void 0 : this.baseTarget[e];\n  }\n  on(e, n) {\n    return this.events[e] || (this.events[e] = new si()), this.events[e].add(n);\n  }\n  notify(e, ...n) {\n    this.events[e] && this.events[e].notify(...n);\n  }\n  scheduleRenderMicrotask() {\n    yi.render(this.render);\n  }\n}\nclass qa extends ff {\n  constructor() {\n    super(...arguments), this.KeyframeResolver = ah;\n  }\n  sortInstanceNodePosition(e, n) {\n    return e.compareDocumentPosition(n) & 2 ? 1 : -1;\n  }\n  getBaseTargetFromProps(e, n) {\n    return e.style ? e.style[n] : void 0;\n  }\n  removeValueFromRenderState(e, { vars: n, style: s }) {\n    delete n[e], delete s[e];\n  }\n  handleChildMotionValue() {\n    this.childSubscription && (this.childSubscription(), delete this.childSubscription);\n    const { children: e } = this.props;\n    ft(e) && (this.childSubscription = e.on("change", (n) => {\n      this.current && (this.current.textContent = `${n}`);\n    }));\n  }\n}\nfunction Ja(t, { style: e, vars: n }, s, i) {\n  const r = t.style;\n  let o;\n  for (o in e)\n    r[o] = e[o];\n  i?.applyProjectionStyles(r, s);\n  for (o in n)\n    r.setProperty(o, n[o]);\n}\nfunction pf(t) {\n  return window.getComputedStyle(t);\n}\nclass mf extends qa {\n  constructor() {\n    super(...arguments), this.type = "html", this.renderInstance = Ja;\n  }\n  readValueFromInstance(e, n) {\n    if (Me.has(n))\n      return this.projection?.isProjecting ? Ds(n) : Ad(e, n);\n    {\n      const s = pf(e), i = (na(n) ? s.getPropertyValue(n) : s[n]) || 0;\n      return typeof i == "string" ? i.trim() : i;\n    }\n  }\n  measureInstanceViewportBox(e, { transformPagePoint: n }) {\n    return Xa(e, n);\n  }\n  build(e, n, s) {\n    Ti(e, n, s.transformTemplate);\n  }\n  scrapeMotionValuesFromProps(e, n, s) {\n    return Ai(e, n, s);\n  }\n}\nconst Za = /* @__PURE__ */ new Set([\n  "baseFrequency",\n  "diffuseConstant",\n  "kernelMatrix",\n  "kernelUnitLength",\n  "keySplines",\n  "keyTimes",\n  "limitingConeAngle",\n  "markerHeight",\n  "markerWidth",\n  "numOctaves",\n  "targetX",\n  "targetY",\n  "surfaceScale",\n  "specularConstant",\n  "specularExponent",\n  "stdDeviation",\n  "tableValues",\n  "viewBox",\n  "gradientTransform",\n  "pathLength",\n  "startOffset",\n  "textLength",\n  "lengthAdjust"\n]);\nfunction gf(t, e, n, s) {\n  Ja(t, e, void 0, s);\n  for (const i in e.attrs)\n    t.setAttribute(Za.has(i) ? i : Pi(i), e.attrs[i]);\n}\nclass yf extends qa {\n  constructor() {\n    super(...arguments), this.type = "svg", this.isSVGTag = !1, this.measureInstanceViewportBox = st;\n  }\n  getBaseTargetFromProps(e, n) {\n    return e[n];\n  }\n  readValueFromInstance(e, n) {\n    if (Me.has(n)) {\n      const s = Sa(n);\n      return s && s.default || 0;\n    }\n    return n = Za.has(n) ? n : Pi(n), e.getAttribute(n);\n  }\n  scrapeMotionValuesFromProps(e, n, s) {\n    return _a(e, n, s);\n  }\n  build(e, n, s) {\n    Oa(e, n, this.isSVGTag, s.transformTemplate, s.style);\n  }\n  renderInstance(e, n, s, i) {\n    gf(e, n, s, i);\n  }\n  mount(e) {\n    this.isSVGTag = Ba(e.tagName), super.mount(e);\n  }\n}\nconst vf = (t, e) => Di(t) ? new yf(e) : new mf(e, {\n  allowProjection: t !== mo\n});\nfunction we(t, e, n) {\n  const s = t.getProps();\n  return Ci(s, e, n !== void 0 ? n : s.custom, t);\n}\nconst js = (t) => Array.isArray(t);\nfunction xf(t, e, n) {\n  t.hasValue(e) ? t.getValue(e).set(n) : t.addValue(e, Te(n));\n}\nfunction bf(t) {\n  return js(t) ? t[t.length - 1] || 0 : t;\n}\nfunction wf(t, e) {\n  const n = we(t, e);\n  let { transitionEnd: s = {}, transition: i = {}, ...r } = n || {};\n  r = { ...r, ...s };\n  for (const o in r) {\n    const a = bf(r[o]);\n    xf(t, o, a);\n  }\n}\nfunction Tf(t) {\n  return !!(ft(t) && t.add);\n}\nfunction Ls(t, e) {\n  const n = t.getValue("willChange");\n  if (Tf(n))\n    return n.add(e);\n  if (!n && Ht.WillChange) {\n    const s = new Ht.WillChange("auto");\n    t.addValue("willChange", s), s.add(e);\n  }\n}\nfunction Qa(t) {\n  return t.props[Ua];\n}\nconst Sf = (t) => t !== null;\nfunction Df(t, { repeat: e, repeatType: n = "loop" }, s) {\n  const i = t.filter(Sf), r = e && n !== "loop" && e % 2 === 1 ? 0 : i.length - 1;\n  return i[r];\n}\nconst Cf = {\n  type: "spring",\n  stiffness: 500,\n  damping: 25,\n  restSpeed: 10\n}, Af = (t) => ({\n  type: "spring",\n  stiffness: 550,\n  damping: t === 0 ? 2 * Math.sqrt(550) : 30,\n  restSpeed: 10\n}), Pf = {\n  type: "keyframes",\n  duration: 0.8\n}, Rf = {\n  type: "keyframes",\n  ease: [0.25, 0.1, 0.35, 1],\n  duration: 0.3\n}, Mf = (t, { keyframes: e }) => e.length > 2 ? Pf : Me.has(t) ? t.startsWith("scale") ? Af(e[1]) : Cf : Rf;\nfunction Ef({ when: t, delay: e, delayChildren: n, staggerChildren: s, staggerDirection: i, repeat: r, repeatType: o, repeatDelay: a, from: l, elapsed: u, ...c }) {\n  return !!Object.keys(c).length;\n}\nconst Ri = (t, e, n, s = {}, i, r) => (o) => {\n  const a = mi(s, t) || {}, l = a.delay || s.delay || 0;\n  let { elapsed: u = 0 } = s;\n  u = u - /* @__PURE__ */ Ut(l);\n  const c = {\n    keyframes: Array.isArray(n) ? n : [null, n],\n    ease: "easeOut",\n    velocity: e.getVelocity(),\n    ...a,\n    delay: -u,\n    onUpdate: (h) => {\n      e.set(h), a.onUpdate && a.onUpdate(h);\n    },\n    onComplete: () => {\n      o(), a.onComplete && a.onComplete();\n    },\n    name: t,\n    motionValue: e,\n    element: r ? void 0 : i\n  };\n  Ef(a) || Object.assign(c, Mf(t, c)), c.duration && (c.duration = /* @__PURE__ */ Ut(c.duration)), c.repeatDelay && (c.repeatDelay = /* @__PURE__ */ Ut(c.repeatDelay)), c.from !== void 0 && (c.keyframes[0] = c.from);\n  let d = !1;\n  if ((c.type === !1 || c.duration === 0 && !c.repeatDelay) && (Ms(c), c.delay === 0 && (d = !0)), (Ht.instantAnimations || Ht.skipAnimations) && (d = !0, Ms(c), c.delay = 0), c.allowFlatten = !a.type && !a.ease, d && !r && e.get() !== void 0) {\n    const h = Df(c.keyframes, a);\n    if (h !== void 0) {\n      Y.update(() => {\n        c.onUpdate(h), c.onComplete();\n      });\n      return;\n    }\n  }\n  return a.isSync ? new fi(c) : new Yd(c);\n};\nfunction Vf({ protectedKeys: t, needsAnimating: e }, n) {\n  const s = t.hasOwnProperty(n) && e[n] !== !0;\n  return e[n] = !1, s;\n}\nfunction tl(t, e, { delay: n = 0, transitionOverride: s, type: i } = {}) {\n  let { transition: r = t.getDefaultTransition(), transitionEnd: o, ...a } = e;\n  s && (r = s);\n  const l = [], u = i && t.animationState && t.animationState.getState()[i];\n  for (const c in a) {\n    const d = t.getValue(c, t.latestValues[c] ?? null), h = a[c];\n    if (h === void 0 || u && Vf(u, c))\n      continue;\n    const f = {\n      delay: n,\n      ...mi(r || {}, c)\n    }, g = d.get();\n    if (g !== void 0 && !d.isAnimating && !Array.isArray(h) && h === g && !f.velocity)\n      continue;\n    let v = !1;\n    if (window.MotionHandoffAnimation) {\n      const x = Qa(t);\n      if (x) {\n        const T = window.MotionHandoffAnimation(x, c, Y);\n        T !== null && (f.startTime = T, v = !0);\n      }\n    }\n    Ls(t, c), d.start(Ri(c, d, h, t.shouldReduceMotion && ba.has(c) ? { type: !1 } : f, t, v));\n    const y = d.animation;\n    y && l.push(y);\n  }\n  return o && Promise.all(l).then(() => {\n    Y.update(() => {\n      o && wf(t, o);\n    });\n  }), l;\n}\nfunction el(t, e, n, s = 0, i = 1) {\n  const r = Array.from(t).sort((u, c) => u.sortNodePosition(c)).indexOf(e), o = t.size, a = (o - 1) * s;\n  return typeof n == "function" ? n(r, o) : i === 1 ? r * s : a - r * s;\n}\nfunction Os(t, e, n = {}) {\n  const s = we(t, e, n.type === "exit" ? t.presenceContext?.custom : void 0);\n  let { transition: i = t.getDefaultTransition() || {} } = s || {};\n  n.transitionOverride && (i = n.transitionOverride);\n  const r = s ? () => Promise.all(tl(t, s, n)) : () => Promise.resolve(), o = t.variantChildren && t.variantChildren.size ? (l = 0) => {\n    const { delayChildren: u = 0, staggerChildren: c, staggerDirection: d } = i;\n    return Nf(t, e, l, u, c, d, n);\n  } : () => Promise.resolve(), { when: a } = i;\n  if (a) {\n    const [l, u] = a === "beforeChildren" ? [r, o] : [o, r];\n    return l().then(() => u());\n  } else\n    return Promise.all([r(), o(n.delay)]);\n}\nfunction Nf(t, e, n = 0, s = 0, i = 0, r = 1, o) {\n  const a = [];\n  for (const l of t.variantChildren)\n    l.notify("AnimationStart", e), a.push(Os(l, e, {\n      ...o,\n      delay: n + (typeof s == "function" ? 0 : s) + el(t.variantChildren, l, s, i, r)\n    }).then(() => l.notify("AnimationComplete", e)));\n  return Promise.all(a);\n}\nfunction kf(t, e, n = {}) {\n  t.notify("AnimationStart", e);\n  let s;\n  if (Array.isArray(e)) {\n    const i = e.map((r) => Os(t, r, n));\n    s = Promise.all(i);\n  } else if (typeof e == "string")\n    s = Os(t, e, n);\n  else {\n    const i = typeof e == "function" ? we(t, e, n.custom) : e;\n    s = Promise.all(tl(t, i, n));\n  }\n  return s.then(() => {\n    t.notify("AnimationComplete", e);\n  });\n}\nfunction nl(t, e) {\n  if (!Array.isArray(e))\n    return !1;\n  const n = e.length;\n  if (n !== t.length)\n    return !1;\n  for (let s = 0; s < n; s++)\n    if (e[s] !== t[s])\n      return !1;\n  return !0;\n}\nconst If = wi.length;\nfunction sl(t) {\n  if (!t)\n    return;\n  if (!t.isControllingVariants) {\n    const n = t.parent ? sl(t.parent) || {} : {};\n    return t.props.initial !== void 0 && (n.initial = t.props.initial), n;\n  }\n  const e = {};\n  for (let n = 0; n < If; n++) {\n    const s = wi[n], i = t.props[s];\n    (Je(i) || i === !1) && (e[s] = i);\n  }\n  return e;\n}\nconst jf = [...bi].reverse(), Lf = bi.length;\nfunction Of(t) {\n  return (e) => Promise.all(e.map(({ animation: n, options: s }) => kf(t, n, s)));\n}\nfunction Ff(t) {\n  let e = Of(t), n = Mr(), s = !0;\n  const i = (l) => (u, c) => {\n    const d = we(t, c, l === "exit" ? t.presenceContext?.custom : void 0);\n    if (d) {\n      const { transition: h, transitionEnd: f, ...g } = d;\n      u = { ...u, ...g, ...f };\n    }\n    return u;\n  };\n  function r(l) {\n    e = l(t);\n  }\n  function o(l) {\n    const { props: u } = t, c = sl(t.parent) || {}, d = [], h = /* @__PURE__ */ new Set();\n    let f = {}, g = 1 / 0;\n    for (let y = 0; y < Lf; y++) {\n      const x = jf[y], T = n[x], b = u[x] !== void 0 ? u[x] : c[x], P = Je(b), D = x === l ? T.isActive : null;\n      D === !1 && (g = y);\n      let R = b === c[x] && b !== u[x] && P;\n      if (R && s && t.manuallyAnimateOnMount && (R = !1), T.protectedKeys = { ...f }, // If it isn\'t active and hasn\'t *just* been set as inactive\n      !T.isActive && D === null || // If we didn\'t and don\'t have any defined prop for this animation type\n      !b && !T.prevProp || // Or if the prop doesn\'t define an animation\n      On(b) || typeof b == "boolean")\n        continue;\n      const m = Bf(T.prevProp, b);\n      let w = m || // If we\'re making this variant active, we want to always make it active\n      x === l && T.isActive && !R && P || // If we removed a higher-priority variant (i is in reverse order)\n      y > g && P, C = !1;\n      const M = Array.isArray(b) ? b : [b];\n      let S = M.reduce(i(x), {});\n      D === !1 && (S = {});\n      const { prevResolvedValues: N = {} } = T, O = {\n        ...N,\n        ...S\n      }, F = (k) => {\n        w = !0, h.has(k) && (C = !0, h.delete(k)), T.needsAnimating[k] = !0;\n        const U = t.getValue(k);\n        U && (U.liveStyle = !1);\n      };\n      for (const k in O) {\n        const U = S[k], H = N[k];\n        if (f.hasOwnProperty(k))\n          continue;\n        let tt = !1;\n        js(U) && js(H) ? tt = !nl(U, H) : tt = U !== H, tt ? U != null ? F(k) : h.add(k) : U !== void 0 && h.has(k) ? F(k) : T.protectedKeys[k] = !0;\n      }\n      T.prevProp = b, T.prevResolvedValues = S, T.isActive && (f = { ...f, ...S }), s && t.blockInitialAnimation && (w = !1);\n      const G = R && m;\n      w && (!G || C) && d.push(...M.map((k) => {\n        const U = { type: x };\n        if (typeof k == "string" && s && !G && t.manuallyAnimateOnMount && t.parent) {\n          const { parent: H } = t, tt = we(H, k);\n          if (H.enteringChildren && tt) {\n            const { delayChildren: et } = tt.transition || {};\n            U.delay = el(H.enteringChildren, t, et);\n          }\n        }\n        return {\n          animation: k,\n          options: U\n        };\n      }));\n    }\n    if (h.size) {\n      const y = {};\n      if (typeof u.initial != "boolean") {\n        const x = we(t, Array.isArray(u.initial) ? u.initial[0] : u.initial);\n        x && x.transition && (y.transition = x.transition);\n      }\n      h.forEach((x) => {\n        const T = t.getBaseTarget(x), b = t.getValue(x);\n        b && (b.liveStyle = !0), y[x] = T ?? null;\n      }), d.push({ animation: y });\n    }\n    let v = !!d.length;\n    return s && (u.initial === !1 || u.initial === u.animate) && !t.manuallyAnimateOnMount && (v = !1), s = !1, v ? e(d) : Promise.resolve();\n  }\n  function a(l, u) {\n    if (n[l].isActive === u)\n      return Promise.resolve();\n    t.variantChildren?.forEach((d) => d.animationState?.setActive(l, u)), n[l].isActive = u;\n    const c = o(l);\n    for (const d in n)\n      n[d].protectedKeys = {};\n    return c;\n  }\n  return {\n    animateChanges: o,\n    setActive: a,\n    setAnimateFunction: r,\n    getState: () => n,\n    reset: () => {\n      n = Mr();\n    }\n  };\n}\nfunction Bf(t, e) {\n  return typeof e == "string" ? e !== t : Array.isArray(e) ? !nl(e, t) : !1;\n}\nfunction oe(t = !1) {\n  return {\n    isActive: t,\n    protectedKeys: {},\n    needsAnimating: {},\n    prevResolvedValues: {}\n  };\n}\nfunction Mr() {\n  return {\n    animate: oe(!0),\n    whileInView: oe(),\n    whileHover: oe(),\n    whileTap: oe(),\n    whileDrag: oe(),\n    whileFocus: oe(),\n    exit: oe()\n  };\n}\nclass se {\n  constructor(e) {\n    this.isMounted = !1, this.node = e;\n  }\n  update() {\n  }\n}\nclass $f extends se {\n  /**\n   * We dynamically generate the AnimationState manager as it contains a reference\n   * to the underlying animation library. We only want to load that if we load this,\n   * so people can optionally code split it out using the `m` component.\n   */\n  constructor(e) {\n    super(e), e.animationState || (e.animationState = Ff(e));\n  }\n  updateAnimationControlsSubscription() {\n    const { animate: e } = this.node.getProps();\n    On(e) && (this.unmountControls = e.subscribe(this.node));\n  }\n  /**\n   * Subscribe any provided AnimationControls to the component\'s VisualElement\n   */\n  mount() {\n    this.updateAnimationControlsSubscription();\n  }\n  update() {\n    const { animate: e } = this.node.getProps(), { animate: n } = this.node.prevProps || {};\n    e !== n && this.updateAnimationControlsSubscription();\n  }\n  unmount() {\n    this.node.animationState.reset(), this.unmountControls?.();\n  }\n}\nlet _f = 0;\nclass Uf extends se {\n  constructor() {\n    super(...arguments), this.id = _f++;\n  }\n  update() {\n    if (!this.node.presenceContext)\n      return;\n    const { isPresent: e, onExitComplete: n } = this.node.presenceContext, { isPresent: s } = this.node.prevPresenceContext || {};\n    if (!this.node.animationState || e === s)\n      return;\n    const i = this.node.animationState.setActive("exit", !e);\n    n && !e && i.then(() => {\n      n(this.id);\n    });\n  }\n  mount() {\n    const { register: e, onExitComplete: n } = this.node.presenceContext || {};\n    n && n(this.id), e && (this.unmount = e(this.id));\n  }\n  unmount() {\n  }\n}\nconst zf = {\n  animation: {\n    Feature: $f\n  },\n  exit: {\n    Feature: Uf\n  }\n};\nfunction Ze(t, e, n, s = { passive: !0 }) {\n  return t.addEventListener(e, n, s), () => t.removeEventListener(e, n);\n}\nfunction on(t) {\n  return {\n    point: {\n      x: t.pageX,\n      y: t.pageY\n    }\n  };\n}\nconst Wf = (t) => (e) => vi(e) && t(e, on(e));\nfunction Ue(t, e, n, s) {\n  return Ze(t, e, Wf(n), s);\n}\nconst il = 1e-4, Kf = 1 - il, Gf = 1 + il, rl = 0.01, Hf = 0 - rl, Xf = 0 + rl;\nfunction gt(t) {\n  return t.max - t.min;\n}\nfunction Yf(t, e, n) {\n  return Math.abs(t - e) <= n;\n}\nfunction Er(t, e, n, s = 0.5) {\n  t.origin = s, t.originPoint = J(e.min, e.max, t.origin), t.scale = gt(n) / gt(e), t.translate = J(n.min, n.max, t.origin) - t.originPoint, (t.scale >= Kf && t.scale <= Gf || isNaN(t.scale)) && (t.scale = 1), (t.translate >= Hf && t.translate <= Xf || isNaN(t.translate)) && (t.translate = 0);\n}\nfunction ze(t, e, n, s) {\n  Er(t.x, e.x, n.x, s ? s.originX : void 0), Er(t.y, e.y, n.y, s ? s.originY : void 0);\n}\nfunction Vr(t, e, n) {\n  t.min = n.min + e.min, t.max = t.min + gt(e);\n}\nfunction qf(t, e, n) {\n  Vr(t.x, e.x, n.x), Vr(t.y, e.y, n.y);\n}\nfunction Nr(t, e, n) {\n  t.min = e.min - n.min, t.max = t.min + gt(e);\n}\nfunction Mn(t, e, n) {\n  Nr(t.x, e.x, n.x), Nr(t.y, e.y, n.y);\n}\nfunction At(t) {\n  return [t("x"), t("y")];\n}\nconst ol = ({ current: t }) => t ? t.ownerDocument.defaultView : null, kr = (t, e) => Math.abs(t - e);\nfunction Jf(t, e) {\n  const n = kr(t.x, e.x), s = kr(t.y, e.y);\n  return Math.sqrt(n ** 2 + s ** 2);\n}\nclass al {\n  constructor(e, n, { transformPagePoint: s, contextWindow: i = window, dragSnapToOrigin: r = !1, distanceThreshold: o = 3 } = {}) {\n    if (this.startEvent = null, this.lastMoveEvent = null, this.lastMoveEventInfo = null, this.handlers = {}, this.contextWindow = window, this.updatePoint = () => {\n      if (!(this.lastMoveEvent && this.lastMoveEventInfo))\n        return;\n      const h = es(this.lastMoveEventInfo, this.history), f = this.startEvent !== null, g = Jf(h.offset, { x: 0, y: 0 }) >= this.distanceThreshold;\n      if (!f && !g)\n        return;\n      const { point: v } = h, { timestamp: y } = ut;\n      this.history.push({ ...v, timestamp: y });\n      const { onStart: x, onMove: T } = this.handlers;\n      f || (x && x(this.lastMoveEvent, h), this.startEvent = this.lastMoveEvent), T && T(this.lastMoveEvent, h);\n    }, this.handlePointerMove = (h, f) => {\n      this.lastMoveEvent = h, this.lastMoveEventInfo = ts(f, this.transformPagePoint), Y.update(this.updatePoint, !0);\n    }, this.handlePointerUp = (h, f) => {\n      this.end();\n      const { onEnd: g, onSessionEnd: v, resumeAnimation: y } = this.handlers;\n      if (this.dragSnapToOrigin && y && y(), !(this.lastMoveEvent && this.lastMoveEventInfo))\n        return;\n      const x = es(h.type === "pointercancel" ? this.lastMoveEventInfo : ts(f, this.transformPagePoint), this.history);\n      this.startEvent && g && g(h, x), v && v(h, x);\n    }, !vi(e))\n      return;\n    this.dragSnapToOrigin = r, this.handlers = n, this.transformPagePoint = s, this.distanceThreshold = o, this.contextWindow = i || window;\n    const a = on(e), l = ts(a, this.transformPagePoint), { point: u } = l, { timestamp: c } = ut;\n    this.history = [{ ...u, timestamp: c }];\n    const { onSessionStart: d } = n;\n    d && d(e, es(l, this.history)), this.removeListeners = nn(Ue(this.contextWindow, "pointermove", this.handlePointerMove), Ue(this.contextWindow, "pointerup", this.handlePointerUp), Ue(this.contextWindow, "pointercancel", this.handlePointerUp));\n  }\n  updateHandlers(e) {\n    this.handlers = e;\n  }\n  end() {\n    this.removeListeners && this.removeListeners(), ee(this.updatePoint);\n  }\n}\nfunction ts(t, e) {\n  return e ? { point: e(t.point) } : t;\n}\nfunction Ir(t, e) {\n  return { x: t.x - e.x, y: t.y - e.y };\n}\nfunction es({ point: t }, e) {\n  return {\n    point: t,\n    delta: Ir(t, ll(e)),\n    offset: Ir(t, Zf(e)),\n    velocity: Qf(e, 0.1)\n  };\n}\nfunction Zf(t) {\n  return t[0];\n}\nfunction ll(t) {\n  return t[t.length - 1];\n}\nfunction Qf(t, e) {\n  if (t.length < 2)\n    return { x: 0, y: 0 };\n  let n = t.length - 1, s = null;\n  const i = ll(t);\n  for (; n >= 0 && (s = t[n], !(i.timestamp - s.timestamp > /* @__PURE__ */ Ut(e))); )\n    n--;\n  if (!s)\n    return { x: 0, y: 0 };\n  const r = /* @__PURE__ */ Rt(i.timestamp - s.timestamp);\n  if (r === 0)\n    return { x: 0, y: 0 };\n  const o = {\n    x: (i.x - s.x) / r,\n    y: (i.y - s.y) / r\n  };\n  return o.x === 1 / 0 && (o.x = 0), o.y === 1 / 0 && (o.y = 0), o;\n}\nfunction tp(t, { min: e, max: n }, s) {\n  return e !== void 0 && t < e ? t = s ? J(e, t, s.min) : Math.max(t, e) : n !== void 0 && t > n && (t = s ? J(n, t, s.max) : Math.min(t, n)), t;\n}\nfunction jr(t, e, n) {\n  return {\n    min: e !== void 0 ? t.min + e : void 0,\n    max: n !== void 0 ? t.max + n - (t.max - t.min) : void 0\n  };\n}\nfunction ep(t, { top: e, left: n, bottom: s, right: i }) {\n  return {\n    x: jr(t.x, n, i),\n    y: jr(t.y, e, s)\n  };\n}\nfunction Lr(t, e) {\n  let n = e.min - t.min, s = e.max - t.max;\n  return e.max - e.min < t.max - t.min && ([n, s] = [s, n]), { min: n, max: s };\n}\nfunction np(t, e) {\n  return {\n    x: Lr(t.x, e.x),\n    y: Lr(t.y, e.y)\n  };\n}\nfunction sp(t, e) {\n  let n = 0.5;\n  const s = gt(t), i = gt(e);\n  return i > s ? n = /* @__PURE__ */ Xe(e.min, e.max - s, t.min) : s > i && (n = /* @__PURE__ */ Xe(t.min, t.max - i, e.min)), Gt(0, 1, n);\n}\nfunction ip(t, e) {\n  const n = {};\n  return e.min !== void 0 && (n.min = e.min - t.min), e.max !== void 0 && (n.max = e.max - t.min), n;\n}\nconst Fs = 0.35;\nfunction rp(t = Fs) {\n  return t === !1 ? t = 0 : t === !0 && (t = Fs), {\n    x: Or(t, "left", "right"),\n    y: Or(t, "top", "bottom")\n  };\n}\nfunction Or(t, e, n) {\n  return {\n    min: Fr(t, e),\n    max: Fr(t, n)\n  };\n}\nfunction Fr(t, e) {\n  return typeof t == "number" ? t : t[e] || 0;\n}\nconst op = /* @__PURE__ */ new WeakMap();\nclass ap {\n  constructor(e) {\n    this.openDragLock = null, this.isDragging = !1, this.currentDirection = null, this.originPoint = { x: 0, y: 0 }, this.constraints = !1, this.hasMutatedConstraints = !1, this.elastic = st(), this.latestPointerEvent = null, this.latestPanInfo = null, this.visualElement = e;\n  }\n  start(e, { snapToCursor: n = !1, distanceThreshold: s } = {}) {\n    const { presenceContext: i } = this.visualElement;\n    if (i && i.isPresent === !1)\n      return;\n    const r = (d) => {\n      const { dragSnapToOrigin: h } = this.getProps();\n      h ? this.pauseAnimation() : this.stopAnimation(), n && this.snapToCursor(on(d).point);\n    }, o = (d, h) => {\n      const { drag: f, dragPropagation: g, onDragStart: v } = this.getProps();\n      if (f && !g && (this.openDragLock && this.openDragLock(), this.openDragLock = dh(f), !this.openDragLock))\n        return;\n      this.latestPointerEvent = d, this.latestPanInfo = h, this.isDragging = !0, this.currentDirection = null, this.resolveConstraints(), this.visualElement.projection && (this.visualElement.projection.isAnimationBlocked = !0, this.visualElement.projection.target = void 0), At((x) => {\n        let T = this.getAxisMotionValue(x).get() || 0;\n        if (zt.test(T)) {\n          const { projection: b } = this.visualElement;\n          if (b && b.layout) {\n            const P = b.layout.layoutBox[x];\n            P && (T = gt(P) * (parseFloat(T) / 100));\n          }\n        }\n        this.originPoint[x] = T;\n      }), v && Y.postRender(() => v(d, h)), Ls(this.visualElement, "transform");\n      const { animationState: y } = this.visualElement;\n      y && y.setActive("whileDrag", !0);\n    }, a = (d, h) => {\n      this.latestPointerEvent = d, this.latestPanInfo = h;\n      const { dragPropagation: f, dragDirectionLock: g, onDirectionLock: v, onDrag: y } = this.getProps();\n      if (!f && !this.openDragLock)\n        return;\n      const { offset: x } = h;\n      if (g && this.currentDirection === null) {\n        this.currentDirection = lp(x), this.currentDirection !== null && v && v(this.currentDirection);\n        return;\n      }\n      this.updateAxis("x", h.point, x), this.updateAxis("y", h.point, x), this.visualElement.render(), y && y(d, h);\n    }, l = (d, h) => {\n      this.latestPointerEvent = d, this.latestPanInfo = h, this.stop(d, h), this.latestPointerEvent = null, this.latestPanInfo = null;\n    }, u = () => At((d) => this.getAnimationState(d) === "paused" && this.getAxisMotionValue(d).animation?.play()), { dragSnapToOrigin: c } = this.getProps();\n    this.panSession = new al(e, {\n      onSessionStart: r,\n      onStart: o,\n      onMove: a,\n      onSessionEnd: l,\n      resumeAnimation: u\n    }, {\n      transformPagePoint: this.visualElement.getTransformPagePoint(),\n      dragSnapToOrigin: c,\n      distanceThreshold: s,\n      contextWindow: ol(this.visualElement)\n    });\n  }\n  /**\n   * @internal\n   */\n  stop(e, n) {\n    const s = e || this.latestPointerEvent, i = n || this.latestPanInfo, r = this.isDragging;\n    if (this.cancel(), !r || !i || !s)\n      return;\n    const { velocity: o } = i;\n    this.startAnimation(o);\n    const { onDragEnd: a } = this.getProps();\n    a && Y.postRender(() => a(s, i));\n  }\n  /**\n   * @internal\n   */\n  cancel() {\n    this.isDragging = !1;\n    const { projection: e, animationState: n } = this.visualElement;\n    e && (e.isAnimationBlocked = !1), this.panSession && this.panSession.end(), this.panSession = void 0;\n    const { dragPropagation: s } = this.getProps();\n    !s && this.openDragLock && (this.openDragLock(), this.openDragLock = null), n && n.setActive("whileDrag", !1);\n  }\n  updateAxis(e, n, s) {\n    const { drag: i } = this.getProps();\n    if (!s || !pn(e, i, this.currentDirection))\n      return;\n    const r = this.getAxisMotionValue(e);\n    let o = this.originPoint[e] + s[e];\n    this.constraints && this.constraints[e] && (o = tp(o, this.constraints[e], this.elastic[e])), r.set(o);\n  }\n  resolveConstraints() {\n    const { dragConstraints: e, dragElastic: n } = this.getProps(), s = this.visualElement.projection && !this.visualElement.projection.layout ? this.visualElement.projection.measure(!1) : this.visualElement.projection?.layout, i = this.constraints;\n    e && ge(e) ? this.constraints || (this.constraints = this.resolveRefConstraints()) : e && s ? this.constraints = ep(s.layoutBox, e) : this.constraints = !1, this.elastic = rp(n), i !== this.constraints && s && this.constraints && !this.hasMutatedConstraints && At((r) => {\n      this.constraints !== !1 && this.getAxisMotionValue(r) && (this.constraints[r] = ip(s.layoutBox[r], this.constraints[r]));\n    });\n  }\n  resolveRefConstraints() {\n    const { dragConstraints: e, onMeasureDragConstraints: n } = this.getProps();\n    if (!e || !ge(e))\n      return !1;\n    const s = e.current, { projection: i } = this.visualElement;\n    if (!i || !i.layout)\n      return !1;\n    const r = cf(s, i.root, this.visualElement.getTransformPagePoint());\n    let o = np(i.layout.layoutBox, r);\n    if (n) {\n      const a = n(of(o));\n      this.hasMutatedConstraints = !!a, a && (o = Ka(a));\n    }\n    return o;\n  }\n  startAnimation(e) {\n    const { drag: n, dragMomentum: s, dragElastic: i, dragTransition: r, dragSnapToOrigin: o, onDragTransitionEnd: a } = this.getProps(), l = this.constraints || {}, u = At((c) => {\n      if (!pn(c, n, this.currentDirection))\n        return;\n      let d = l && l[c] || {};\n      o && (d = { min: 0, max: 0 });\n      const h = i ? 200 : 1e6, f = i ? 40 : 1e7, g = {\n        type: "inertia",\n        velocity: s ? e[c] : 0,\n        bounceStiffness: h,\n        bounceDamping: f,\n        timeConstant: 750,\n        restDelta: 1,\n        restSpeed: 10,\n        ...r,\n        ...d\n      };\n      return this.startAxisValueAnimation(c, g);\n    });\n    return Promise.all(u).then(a);\n  }\n  startAxisValueAnimation(e, n) {\n    const s = this.getAxisMotionValue(e);\n    return Ls(this.visualElement, e), s.start(Ri(e, s, 0, n, this.visualElement, !1));\n  }\n  stopAnimation() {\n    At((e) => this.getAxisMotionValue(e).stop());\n  }\n  pauseAnimation() {\n    At((e) => this.getAxisMotionValue(e).animation?.pause());\n  }\n  getAnimationState(e) {\n    return this.getAxisMotionValue(e).animation?.state;\n  }\n  /**\n   * Drag works differently depending on which props are provided.\n   *\n   * - If _dragX and _dragY are provided, we output the gesture delta directly to those motion values.\n   * - Otherwise, we apply the delta to the x/y motion values.\n   */\n  getAxisMotionValue(e) {\n    const n = `_drag${e.toUpperCase()}`, s = this.visualElement.getProps(), i = s[n];\n    return i || this.visualElement.getValue(e, (s.initial ? s.initial[e] : void 0) || 0);\n  }\n  snapToCursor(e) {\n    At((n) => {\n      const { drag: s } = this.getProps();\n      if (!pn(n, s, this.currentDirection))\n        return;\n      const { projection: i } = this.visualElement, r = this.getAxisMotionValue(n);\n      if (i && i.layout) {\n        const { min: o, max: a } = i.layout.layoutBox[n];\n        r.set(e[n] - J(o, a, 0.5));\n      }\n    });\n  }\n  /**\n   * When the viewport resizes we want to check if the measured constraints\n   * have changed and, if so, reposition the element within those new constraints\n   * relative to where it was before the resize.\n   */\n  scalePositionWithinConstraints() {\n    if (!this.visualElement.current)\n      return;\n    const { drag: e, dragConstraints: n } = this.getProps(), { projection: s } = this.visualElement;\n    if (!ge(n) || !s || !this.constraints)\n      return;\n    this.stopAnimation();\n    const i = { x: 0, y: 0 };\n    At((o) => {\n      const a = this.getAxisMotionValue(o);\n      if (a && this.constraints !== !1) {\n        const l = a.get();\n        i[o] = sp({ min: l, max: l }, this.constraints[o]);\n      }\n    });\n    const { transformTemplate: r } = this.visualElement.getProps();\n    this.visualElement.current.style.transform = r ? r({}, "") : "none", s.root && s.root.updateScroll(), s.updateLayout(), this.resolveConstraints(), At((o) => {\n      if (!pn(o, e, null))\n        return;\n      const a = this.getAxisMotionValue(o), { min: l, max: u } = this.constraints[o];\n      a.set(J(l, u, i[o]));\n    });\n  }\n  addListeners() {\n    if (!this.visualElement.current)\n      return;\n    op.set(this.visualElement, this);\n    const e = this.visualElement.current, n = Ue(e, "pointerdown", (l) => {\n      const { drag: u, dragListener: c = !0 } = this.getProps();\n      u && c && this.start(l);\n    }), s = () => {\n      const { dragConstraints: l } = this.getProps();\n      ge(l) && l.current && (this.constraints = this.resolveRefConstraints());\n    }, { projection: i } = this.visualElement, r = i.addEventListener("measure", s);\n    i && !i.layout && (i.root && i.root.updateScroll(), i.updateLayout()), Y.read(s);\n    const o = Ze(window, "resize", () => this.scalePositionWithinConstraints()), a = i.addEventListener("didUpdate", (({ delta: l, hasLayoutChanged: u }) => {\n      this.isDragging && u && (At((c) => {\n        const d = this.getAxisMotionValue(c);\n        d && (this.originPoint[c] += l[c].translate, d.set(d.get() + l[c].translate));\n      }), this.visualElement.render());\n    }));\n    return () => {\n      o(), n(), r(), a && a();\n    };\n  }\n  getProps() {\n    const e = this.visualElement.getProps(), { drag: n = !1, dragDirectionLock: s = !1, dragPropagation: i = !1, dragConstraints: r = !1, dragElastic: o = Fs, dragMomentum: a = !0 } = e;\n    return {\n      ...e,\n      drag: n,\n      dragDirectionLock: s,\n      dragPropagation: i,\n      dragConstraints: r,\n      dragElastic: o,\n      dragMomentum: a\n    };\n  }\n}\nfunction pn(t, e, n) {\n  return (e === !0 || e === t) && (n === null || n === t);\n}\nfunction lp(t, e = 10) {\n  let n = null;\n  return Math.abs(t.y) > e ? n = "y" : Math.abs(t.x) > e && (n = "x"), n;\n}\nclass cp extends se {\n  constructor(e) {\n    super(e), this.removeGroupControls = Mt, this.removeListeners = Mt, this.controls = new ap(e);\n  }\n  mount() {\n    const { dragControls: e } = this.node.getProps();\n    e && (this.removeGroupControls = e.subscribe(this.controls)), this.removeListeners = this.controls.addListeners() || Mt;\n  }\n  unmount() {\n    this.removeGroupControls(), this.removeListeners();\n  }\n}\nconst Br = (t) => (e, n) => {\n  t && Y.postRender(() => t(e, n));\n};\nclass up extends se {\n  constructor() {\n    super(...arguments), this.removePointerDownListener = Mt;\n  }\n  onPointerDown(e) {\n    this.session = new al(e, this.createPanHandlers(), {\n      transformPagePoint: this.node.getTransformPagePoint(),\n      contextWindow: ol(this.node)\n    });\n  }\n  createPanHandlers() {\n    const { onPanSessionStart: e, onPanStart: n, onPan: s, onPanEnd: i } = this.node.getProps();\n    return {\n      onSessionStart: Br(e),\n      onStart: Br(n),\n      onMove: s,\n      onEnd: (r, o) => {\n        delete this.session, i && Y.postRender(() => i(r, o));\n      }\n    };\n  }\n  mount() {\n    this.removePointerDownListener = Ue(this.node.current, "pointerdown", (e) => this.onPointerDown(e));\n  }\n  update() {\n    this.session && this.session.updateHandlers(this.createPanHandlers());\n  }\n  unmount() {\n    this.removePointerDownListener(), this.session && this.session.end();\n  }\n}\nconst xn = {\n  /**\n   * Global flag as to whether the tree has animated since the last time\n   * we resized the window\n   */\n  hasAnimatedSinceResize: !0,\n  /**\n   * We set this to true once, on the first update. Any nodes added to the tree beyond that\n   * update will be given a `data-projection-id` attribute.\n   */\n  hasEverUpdated: !1\n};\nlet ns = !1;\nclass dp extends kl {\n  /**\n   * This only mounts projection nodes for components that\n   * need measuring, we might want to do it for all components\n   * in order to incorporate transforms\n   */\n  componentDidMount() {\n    const { visualElement: e, layoutGroup: n, switchLayoutGroup: s, layoutId: i } = this.props, { projection: r } = e;\n    r && (n.group && n.group.add(r), s && s.register && i && s.register(r), ns && r.root.didUpdate(), r.addEventListener("animationComplete", () => {\n      this.safeToRemove();\n    }), r.setOptions({\n      ...r.options,\n      onExitComplete: () => this.safeToRemove()\n    })), xn.hasEverUpdated = !0;\n  }\n  getSnapshotBeforeUpdate(e) {\n    const { layoutDependency: n, visualElement: s, drag: i, isPresent: r } = this.props, { projection: o } = s;\n    return o && (o.isPresent = r, ns = !0, i || e.layoutDependency !== n || n === void 0 || e.isPresent !== r ? o.willUpdate() : this.safeToRemove(), e.isPresent !== r && (r ? o.promote() : o.relegate() || Y.postRender(() => {\n      const a = o.getStack();\n      (!a || !a.members.length) && this.safeToRemove();\n    }))), null;\n  }\n  componentDidUpdate() {\n    const { projection: e } = this.props.visualElement;\n    e && (e.root.didUpdate(), yi.postRender(() => {\n      !e.currentAnimation && e.isLead() && this.safeToRemove();\n    }));\n  }\n  componentWillUnmount() {\n    const { visualElement: e, layoutGroup: n, switchLayoutGroup: s } = this.props, { projection: i } = e;\n    ns = !0, i && (i.scheduleCheckAfterUnmount(), n && n.group && n.group.remove(i), s && s.deregister && s.deregister(i));\n  }\n  safeToRemove() {\n    const { safeToRemove: e } = this.props;\n    e && e();\n  }\n  render() {\n    return null;\n  }\n}\nfunction cl(t) {\n  const [e, n] = Va(), s = q(qs);\n  return p.jsx(dp, { ...t, layoutGroup: s, switchLayoutGroup: q(za), isPresent: e, safeToRemove: n });\n}\nfunction hp(t, e, n) {\n  const s = ft(t) ? t : Te(t);\n  return s.start(Ri("", s, e, n)), s.animation;\n}\nconst fp = (t, e) => t.depth - e.depth;\nclass pp {\n  constructor() {\n    this.children = [], this.isDirty = !1;\n  }\n  add(e) {\n    Qs(this.children, e), this.isDirty = !0;\n  }\n  remove(e) {\n    ti(this.children, e), this.isDirty = !0;\n  }\n  forEach(e) {\n    this.isDirty && this.children.sort(fp), this.isDirty = !1, this.children.forEach(e);\n  }\n}\nfunction mp(t, e) {\n  const n = yt.now(), s = ({ timestamp: i }) => {\n    const r = i - n;\n    r >= e && (ee(s), t(r - e));\n  };\n  return Y.setup(s, !0), () => ee(s);\n}\nconst ul = ["TopLeft", "TopRight", "BottomLeft", "BottomRight"], gp = ul.length, $r = (t) => typeof t == "string" ? parseFloat(t) : t, _r = (t) => typeof t == "number" || I.test(t);\nfunction yp(t, e, n, s, i, r) {\n  i ? (t.opacity = J(0, n.opacity ?? 1, vp(s)), t.opacityExit = J(e.opacity ?? 1, 0, xp(s))) : r && (t.opacity = J(e.opacity ?? 1, n.opacity ?? 1, s));\n  for (let o = 0; o < gp; o++) {\n    const a = `border${ul[o]}Radius`;\n    let l = Ur(e, a), u = Ur(n, a);\n    if (l === void 0 && u === void 0)\n      continue;\n    l || (l = 0), u || (u = 0), l === 0 || u === 0 || _r(l) === _r(u) ? (t[a] = Math.max(J($r(l), $r(u), s), 0), (zt.test(u) || zt.test(l)) && (t[a] += "%")) : t[a] = u;\n  }\n  (e.rotate || n.rotate) && (t.rotate = J(e.rotate || 0, n.rotate || 0, s));\n}\nfunction Ur(t, e) {\n  return t[e] !== void 0 ? t[e] : t.borderRadius;\n}\nconst vp = /* @__PURE__ */ dl(0, 0.5, qo), xp = /* @__PURE__ */ dl(0.5, 0.95, Mt);\nfunction dl(t, e, n) {\n  return (s) => s < t ? 0 : s > e ? 1 : n(/* @__PURE__ */ Xe(t, e, s));\n}\nfunction zr(t, e) {\n  t.min = e.min, t.max = e.max;\n}\nfunction kt(t, e) {\n  zr(t.x, e.x), zr(t.y, e.y);\n}\nfunction Wr(t, e) {\n  t.translate = e.translate, t.scale = e.scale, t.originPoint = e.originPoint, t.origin = e.origin;\n}\nfunction Kr(t, e, n, s, i) {\n  return t -= e, t = Rn(t, 1 / n, s), i !== void 0 && (t = Rn(t, 1 / i, s)), t;\n}\nfunction bp(t, e = 0, n = 1, s = 0.5, i, r = t, o = t) {\n  if (zt.test(e) && (e = parseFloat(e), e = J(o.min, o.max, e / 100) - o.min), typeof e != "number")\n    return;\n  let a = J(r.min, r.max, s);\n  t === r && (a -= e), t.min = Kr(t.min, e, n, a, i), t.max = Kr(t.max, e, n, a, i);\n}\nfunction Gr(t, e, [n, s, i], r, o) {\n  bp(t, e[n], e[s], e[i], e.scale, r, o);\n}\nconst wp = ["x", "scaleX", "originX"], Tp = ["y", "scaleY", "originY"];\nfunction Hr(t, e, n, s) {\n  Gr(t.x, e, wp, n ? n.x : void 0, s ? s.x : void 0), Gr(t.y, e, Tp, n ? n.y : void 0, s ? s.y : void 0);\n}\nfunction Xr(t) {\n  return t.translate === 0 && t.scale === 1;\n}\nfunction hl(t) {\n  return Xr(t.x) && Xr(t.y);\n}\nfunction Yr(t, e) {\n  return t.min === e.min && t.max === e.max;\n}\nfunction Sp(t, e) {\n  return Yr(t.x, e.x) && Yr(t.y, e.y);\n}\nfunction qr(t, e) {\n  return Math.round(t.min) === Math.round(e.min) && Math.round(t.max) === Math.round(e.max);\n}\nfunction fl(t, e) {\n  return qr(t.x, e.x) && qr(t.y, e.y);\n}\nfunction Jr(t) {\n  return gt(t.x) / gt(t.y);\n}\nfunction Zr(t, e) {\n  return t.translate === e.translate && t.scale === e.scale && t.originPoint === e.originPoint;\n}\nclass Dp {\n  constructor() {\n    this.members = [];\n  }\n  add(e) {\n    Qs(this.members, e), e.scheduleRender();\n  }\n  remove(e) {\n    if (ti(this.members, e), e === this.prevLead && (this.prevLead = void 0), e === this.lead) {\n      const n = this.members[this.members.length - 1];\n      n && this.promote(n);\n    }\n  }\n  relegate(e) {\n    const n = this.members.findIndex((i) => e === i);\n    if (n === 0)\n      return !1;\n    let s;\n    for (let i = n; i >= 0; i--) {\n      const r = this.members[i];\n      if (r.isPresent !== !1) {\n        s = r;\n        break;\n      }\n    }\n    return s ? (this.promote(s), !0) : !1;\n  }\n  promote(e, n) {\n    const s = this.lead;\n    if (e !== s && (this.prevLead = s, this.lead = e, e.show(), s)) {\n      s.instance && s.scheduleRender(), e.scheduleRender(), e.resumeFrom = s, n && (e.resumeFrom.preserveOpacity = !0), s.snapshot && (e.snapshot = s.snapshot, e.snapshot.latestValues = s.animationValues || s.latestValues), e.root && e.root.isUpdating && (e.isLayoutDirty = !0);\n      const { crossfade: i } = e.options;\n      i === !1 && s.hide();\n    }\n  }\n  exitAnimationComplete() {\n    this.members.forEach((e) => {\n      const { options: n, resumingFrom: s } = e;\n      n.onExitComplete && n.onExitComplete(), s && s.options.onExitComplete && s.options.onExitComplete();\n    });\n  }\n  scheduleRender() {\n    this.members.forEach((e) => {\n      e.instance && e.scheduleRender(!1);\n    });\n  }\n  /**\n   * Clear any leads that have been removed this render to prevent them from being\n   * used in future animations and to prevent memory leaks\n   */\n  removeLeadSnapshot() {\n    this.lead && this.lead.snapshot && (this.lead.snapshot = void 0);\n  }\n}\nfunction Cp(t, e, n) {\n  let s = "";\n  const i = t.x.translate / e.x, r = t.y.translate / e.y, o = n?.z || 0;\n  if ((i || r || o) && (s = `translate3d(${i}px, ${r}px, ${o}px) `), (e.x !== 1 || e.y !== 1) && (s += `scale(${1 / e.x}, ${1 / e.y}) `), n) {\n    const { transformPerspective: u, rotate: c, rotateX: d, rotateY: h, skewX: f, skewY: g } = n;\n    u && (s = `perspective(${u}px) ${s}`), c && (s += `rotate(${c}deg) `), d && (s += `rotateX(${d}deg) `), h && (s += `rotateY(${h}deg) `), f && (s += `skewX(${f}deg) `), g && (s += `skewY(${g}deg) `);\n  }\n  const a = t.x.scale * e.x, l = t.y.scale * e.y;\n  return (a !== 1 || l !== 1) && (s += `scale(${a}, ${l})`), s || "none";\n}\nconst ss = ["", "X", "Y", "Z"], Ap = 1e3;\nlet Pp = 0;\nfunction is(t, e, n, s) {\n  const { latestValues: i } = e;\n  i[t] && (n[t] = i[t], e.setStaticValue(t, 0), s && (s[t] = 0));\n}\nfunction pl(t) {\n  if (t.hasCheckedOptimisedAppear = !0, t.root === t)\n    return;\n  const { visualElement: e } = t.options;\n  if (!e)\n    return;\n  const n = Qa(e);\n  if (window.MotionHasOptimisedAnimation(n, "transform")) {\n    const { layout: i, layoutId: r } = t.options;\n    window.MotionCancelOptimisedAnimation(n, "transform", Y, !(i || r));\n  }\n  const { parent: s } = t;\n  s && !s.hasCheckedOptimisedAppear && pl(s);\n}\nfunction ml({ attachResizeListener: t, defaultParent: e, measureScroll: n, checkIsScrollRoot: s, resetTransform: i }) {\n  return class {\n    constructor(o = {}, a = e?.()) {\n      this.id = Pp++, this.animationId = 0, this.animationCommitId = 0, this.children = /* @__PURE__ */ new Set(), this.options = {}, this.isTreeAnimating = !1, this.isAnimationBlocked = !1, this.isLayoutDirty = !1, this.isProjectionDirty = !1, this.isSharedProjectionDirty = !1, this.isTransformDirty = !1, this.updateManuallyBlocked = !1, this.updateBlockedByResize = !1, this.isUpdating = !1, this.isSVG = !1, this.needsReset = !1, this.shouldResetTransform = !1, this.hasCheckedOptimisedAppear = !1, this.treeScale = { x: 1, y: 1 }, this.eventHandlers = /* @__PURE__ */ new Map(), this.hasTreeAnimated = !1, this.layoutVersion = 0, this.updateScheduled = !1, this.scheduleUpdate = () => this.update(), this.projectionUpdateScheduled = !1, this.checkUpdateFailed = () => {\n        this.isUpdating && (this.isUpdating = !1, this.clearAllSnapshots());\n      }, this.updateProjection = () => {\n        this.projectionUpdateScheduled = !1, this.nodes.forEach(Ep), this.nodes.forEach(Ip), this.nodes.forEach(jp), this.nodes.forEach(Vp);\n      }, this.resolvedRelativeTargetAt = 0, this.linkedParentVersion = 0, this.hasProjected = !1, this.isVisible = !0, this.animationProgress = 0, this.sharedNodes = /* @__PURE__ */ new Map(), this.latestValues = o, this.root = a ? a.root || a : this, this.path = a ? [...a.path, a] : [], this.parent = a, this.depth = a ? a.depth + 1 : 0;\n      for (let l = 0; l < this.path.length; l++)\n        this.path[l].shouldResetTransform = !0;\n      this.root === this && (this.nodes = new pp());\n    }\n    addEventListener(o, a) {\n      return this.eventHandlers.has(o) || this.eventHandlers.set(o, new si()), this.eventHandlers.get(o).add(a);\n    }\n    notifyListeners(o, ...a) {\n      const l = this.eventHandlers.get(o);\n      l && l.notify(...a);\n    }\n    hasListeners(o) {\n      return this.eventHandlers.has(o);\n    }\n    /**\n     * Lifecycles\n     */\n    mount(o) {\n      if (this.instance)\n        return;\n      this.isSVG = Ea(o) && !yh(o), this.instance = o;\n      const { layoutId: a, layout: l, visualElement: u } = this.options;\n      if (u && !u.current && u.mount(o), this.root.nodes.add(this), this.parent && this.parent.children.add(this), this.root.hasTreeAnimated && (l || a) && (this.isLayoutDirty = !0), t) {\n        let c, d = 0;\n        const h = () => this.root.updateBlockedByResize = !1;\n        Y.read(() => {\n          d = window.innerWidth;\n        }), t(o, () => {\n          const f = window.innerWidth;\n          f !== d && (d = f, this.root.updateBlockedByResize = !0, c && c(), c = mp(h, 250), xn.hasAnimatedSinceResize && (xn.hasAnimatedSinceResize = !1, this.nodes.forEach(eo)));\n        });\n      }\n      a && this.root.registerSharedNode(a, this), this.options.animate !== !1 && u && (a || l) && this.addEventListener("didUpdate", ({ delta: c, hasLayoutChanged: d, hasRelativeLayoutChanged: h, layout: f }) => {\n        if (this.isTreeAnimationBlocked()) {\n          this.target = void 0, this.relativeTarget = void 0;\n          return;\n        }\n        const g = this.options.transition || u.getDefaultTransition() || $p, { onLayoutAnimationStart: v, onLayoutAnimationComplete: y } = u.getProps(), x = !this.targetLayout || !fl(this.targetLayout, f), T = !d && h;\n        if (this.options.layoutRoot || this.resumeFrom || T || d && (x || !this.currentAnimation)) {\n          this.resumeFrom && (this.resumingFrom = this.resumeFrom, this.resumingFrom.resumingFrom = void 0);\n          const b = {\n            ...mi(g, "layout"),\n            onPlay: v,\n            onComplete: y\n          };\n          (u.shouldReduceMotion || this.options.layoutRoot) && (b.delay = 0, b.type = !1), this.startAnimation(b), this.setAnimationOrigin(c, T);\n        } else\n          d || eo(this), this.isLead() && this.options.onExitComplete && this.options.onExitComplete();\n        this.targetLayout = f;\n      });\n    }\n    unmount() {\n      this.options.layoutId && this.willUpdate(), this.root.nodes.remove(this);\n      const o = this.getStack();\n      o && o.remove(this), this.parent && this.parent.children.delete(this), this.instance = void 0, this.eventHandlers.clear(), ee(this.updateProjection);\n    }\n    // only on the root\n    blockUpdate() {\n      this.updateManuallyBlocked = !0;\n    }\n    unblockUpdate() {\n      this.updateManuallyBlocked = !1;\n    }\n    isUpdateBlocked() {\n      return this.updateManuallyBlocked || this.updateBlockedByResize;\n    }\n    isTreeAnimationBlocked() {\n      return this.isAnimationBlocked || this.parent && this.parent.isTreeAnimationBlocked() || !1;\n    }\n    // Note: currently only running on root node\n    startUpdate() {\n      this.isUpdateBlocked() || (this.isUpdating = !0, this.nodes && this.nodes.forEach(Lp), this.animationId++);\n    }\n    getTransformTemplate() {\n      const { visualElement: o } = this.options;\n      return o && o.getProps().transformTemplate;\n    }\n    willUpdate(o = !0) {\n      if (this.root.hasTreeAnimated = !0, this.root.isUpdateBlocked()) {\n        this.options.onExitComplete && this.options.onExitComplete();\n        return;\n      }\n      if (window.MotionCancelOptimisedAnimation && !this.hasCheckedOptimisedAppear && pl(this), !this.root.isUpdating && this.root.startUpdate(), this.isLayoutDirty)\n        return;\n      this.isLayoutDirty = !0;\n      for (let c = 0; c < this.path.length; c++) {\n        const d = this.path[c];\n        d.shouldResetTransform = !0, d.updateScroll("snapshot"), d.options.layoutRoot && d.willUpdate(!1);\n      }\n      const { layoutId: a, layout: l } = this.options;\n      if (a === void 0 && !l)\n        return;\n      const u = this.getTransformTemplate();\n      this.prevTransformTemplateValue = u ? u(this.latestValues, "") : void 0, this.updateSnapshot(), o && this.notifyListeners("willUpdate");\n    }\n    update() {\n      if (this.updateScheduled = !1, this.isUpdateBlocked()) {\n        this.unblockUpdate(), this.clearAllSnapshots(), this.nodes.forEach(Qr);\n        return;\n      }\n      if (this.animationId <= this.animationCommitId) {\n        this.nodes.forEach(to);\n        return;\n      }\n      this.animationCommitId = this.animationId, this.isUpdating ? (this.isUpdating = !1, this.nodes.forEach(kp), this.nodes.forEach(Rp), this.nodes.forEach(Mp)) : this.nodes.forEach(to), this.clearAllSnapshots();\n      const a = yt.now();\n      ut.delta = Gt(0, 1e3 / 60, a - ut.timestamp), ut.timestamp = a, ut.isProcessing = !0, Gn.update.process(ut), Gn.preRender.process(ut), Gn.render.process(ut), ut.isProcessing = !1;\n    }\n    didUpdate() {\n      this.updateScheduled || (this.updateScheduled = !0, yi.read(this.scheduleUpdate));\n    }\n    clearAllSnapshots() {\n      this.nodes.forEach(Np), this.sharedNodes.forEach(Op);\n    }\n    scheduleUpdateProjection() {\n      this.projectionUpdateScheduled || (this.projectionUpdateScheduled = !0, Y.preRender(this.updateProjection, !1, !0));\n    }\n    scheduleCheckAfterUnmount() {\n      Y.postRender(() => {\n        this.isLayoutDirty ? this.root.didUpdate() : this.root.checkUpdateFailed();\n      });\n    }\n    /**\n     * Update measurements\n     */\n    updateSnapshot() {\n      this.snapshot || !this.instance || (this.snapshot = this.measure(), this.snapshot && !gt(this.snapshot.measuredBox.x) && !gt(this.snapshot.measuredBox.y) && (this.snapshot = void 0));\n    }\n    updateLayout() {\n      if (!this.instance || (this.updateScroll(), !(this.options.alwaysMeasureLayout && this.isLead()) && !this.isLayoutDirty))\n        return;\n      if (this.resumeFrom && !this.resumeFrom.instance)\n        for (let l = 0; l < this.path.length; l++)\n          this.path[l].updateScroll();\n      const o = this.layout;\n      this.layout = this.measure(!1), this.layoutVersion++, this.layoutCorrected = st(), this.isLayoutDirty = !1, this.projectionDelta = void 0, this.notifyListeners("measure", this.layout.layoutBox);\n      const { visualElement: a } = this.options;\n      a && a.notify("LayoutMeasure", this.layout.layoutBox, o ? o.layoutBox : void 0);\n    }\n    updateScroll(o = "measure") {\n      let a = !!(this.options.layoutScroll && this.instance);\n      if (this.scroll && this.scroll.animationId === this.root.animationId && this.scroll.phase === o && (a = !1), a && this.instance) {\n        const l = s(this.instance);\n        this.scroll = {\n          animationId: this.root.animationId,\n          phase: o,\n          isRoot: l,\n          offset: n(this.instance),\n          wasRoot: this.scroll ? this.scroll.isRoot : l\n        };\n      }\n    }\n    resetTransform() {\n      if (!i)\n        return;\n      const o = this.isLayoutDirty || this.shouldResetTransform || this.options.alwaysMeasureLayout, a = this.projectionDelta && !hl(this.projectionDelta), l = this.getTransformTemplate(), u = l ? l(this.latestValues, "") : void 0, c = u !== this.prevTransformTemplateValue;\n      o && this.instance && (a || ae(this.latestValues) || c) && (i(this.instance, u), this.shouldResetTransform = !1, this.scheduleRender());\n    }\n    measure(o = !0) {\n      const a = this.measurePageBox();\n      let l = this.removeElementScroll(a);\n      return o && (l = this.removeTransform(l)), _p(l), {\n        animationId: this.root.animationId,\n        measuredBox: a,\n        layoutBox: l,\n        latestValues: {},\n        source: this.id\n      };\n    }\n    measurePageBox() {\n      const { visualElement: o } = this.options;\n      if (!o)\n        return st();\n      const a = o.measureViewportBox();\n      if (!(this.scroll?.wasRoot || this.path.some(Up))) {\n        const { scroll: u } = this.root;\n        u && (ye(a.x, u.offset.x), ye(a.y, u.offset.y));\n      }\n      return a;\n    }\n    removeElementScroll(o) {\n      const a = st();\n      if (kt(a, o), this.scroll?.wasRoot)\n        return a;\n      for (let l = 0; l < this.path.length; l++) {\n        const u = this.path[l], { scroll: c, options: d } = u;\n        u !== this.root && c && d.layoutScroll && (c.wasRoot && kt(a, o), ye(a.x, c.offset.x), ye(a.y, c.offset.y));\n      }\n      return a;\n    }\n    applyTransform(o, a = !1) {\n      const l = st();\n      kt(l, o);\n      for (let u = 0; u < this.path.length; u++) {\n        const c = this.path[u];\n        !a && c.options.layoutScroll && c.scroll && c !== c.root && ve(l, {\n          x: -c.scroll.offset.x,\n          y: -c.scroll.offset.y\n        }), ae(c.latestValues) && ve(l, c.latestValues);\n      }\n      return ae(this.latestValues) && ve(l, this.latestValues), l;\n    }\n    removeTransform(o) {\n      const a = st();\n      kt(a, o);\n      for (let l = 0; l < this.path.length; l++) {\n        const u = this.path[l];\n        if (!u.instance || !ae(u.latestValues))\n          continue;\n        Ns(u.latestValues) && u.updateSnapshot();\n        const c = st(), d = u.measurePageBox();\n        kt(c, d), Hr(a, u.latestValues, u.snapshot ? u.snapshot.layoutBox : void 0, c);\n      }\n      return ae(this.latestValues) && Hr(a, this.latestValues), a;\n    }\n    setTargetDelta(o) {\n      this.targetDelta = o, this.root.scheduleUpdateProjection(), this.isProjectionDirty = !0;\n    }\n    setOptions(o) {\n      this.options = {\n        ...this.options,\n        ...o,\n        crossfade: o.crossfade !== void 0 ? o.crossfade : !0\n      };\n    }\n    clearMeasurements() {\n      this.scroll = void 0, this.layout = void 0, this.snapshot = void 0, this.prevTransformTemplateValue = void 0, this.targetDelta = void 0, this.target = void 0, this.isLayoutDirty = !1;\n    }\n    forceRelativeParentToResolveTarget() {\n      this.relativeParent && this.relativeParent.resolvedRelativeTargetAt !== ut.timestamp && this.relativeParent.resolveTargetDelta(!0);\n    }\n    resolveTargetDelta(o = !1) {\n      const a = this.getLead();\n      this.isProjectionDirty || (this.isProjectionDirty = a.isProjectionDirty), this.isTransformDirty || (this.isTransformDirty = a.isTransformDirty), this.isSharedProjectionDirty || (this.isSharedProjectionDirty = a.isSharedProjectionDirty);\n      const l = !!this.resumingFrom || this !== a;\n      if (!(o || l && this.isSharedProjectionDirty || this.isProjectionDirty || this.parent?.isProjectionDirty || this.attemptToResolveRelativeTarget || this.root.updateBlockedByResize))\n        return;\n      const { layout: c, layoutId: d } = this.options;\n      if (!this.layout || !(c || d))\n        return;\n      this.resolvedRelativeTargetAt = ut.timestamp;\n      const h = this.getClosestProjectingParent();\n      h && this.linkedParentVersion !== h.layoutVersion && !h.options.layoutRoot && this.removeRelativeTarget(), !this.targetDelta && !this.relativeTarget && (h && h.layout ? this.createRelativeTarget(h, this.layout.layoutBox, h.layout.layoutBox) : this.removeRelativeTarget()), !(!this.relativeTarget && !this.targetDelta) && (this.target || (this.target = st(), this.targetWithTransforms = st()), this.relativeTarget && this.relativeTargetOrigin && this.relativeParent && this.relativeParent.target ? (this.forceRelativeParentToResolveTarget(), qf(this.target, this.relativeTarget, this.relativeParent.target)) : this.targetDelta ? (this.resumingFrom ? this.target = this.applyTransform(this.layout.layoutBox) : kt(this.target, this.layout.layoutBox), Ha(this.target, this.targetDelta)) : kt(this.target, this.layout.layoutBox), this.attemptToResolveRelativeTarget && (this.attemptToResolveRelativeTarget = !1, h && !!h.resumingFrom == !!this.resumingFrom && !h.options.layoutScroll && h.target && this.animationProgress !== 1 ? this.createRelativeTarget(h, this.target, h.target) : this.relativeParent = this.relativeTarget = void 0));\n    }\n    getClosestProjectingParent() {\n      if (!(!this.parent || Ns(this.parent.latestValues) || Ga(this.parent.latestValues)))\n        return this.parent.isProjecting() ? this.parent : this.parent.getClosestProjectingParent();\n    }\n    isProjecting() {\n      return !!((this.relativeTarget || this.targetDelta || this.options.layoutRoot) && this.layout);\n    }\n    createRelativeTarget(o, a, l) {\n      this.relativeParent = o, this.linkedParentVersion = o.layoutVersion, this.forceRelativeParentToResolveTarget(), this.relativeTarget = st(), this.relativeTargetOrigin = st(), Mn(this.relativeTargetOrigin, a, l), kt(this.relativeTarget, this.relativeTargetOrigin);\n    }\n    removeRelativeTarget() {\n      this.relativeParent = this.relativeTarget = void 0;\n    }\n    calcProjection() {\n      const o = this.getLead(), a = !!this.resumingFrom || this !== o;\n      let l = !0;\n      if ((this.isProjectionDirty || this.parent?.isProjectionDirty) && (l = !1), a && (this.isSharedProjectionDirty || this.isTransformDirty) && (l = !1), this.resolvedRelativeTargetAt === ut.timestamp && (l = !1), l)\n        return;\n      const { layout: u, layoutId: c } = this.options;\n      if (this.isTreeAnimating = !!(this.parent && this.parent.isTreeAnimating || this.currentAnimation || this.pendingAnimation), this.isTreeAnimating || (this.targetDelta = this.relativeTarget = void 0), !this.layout || !(u || c))\n        return;\n      kt(this.layoutCorrected, this.layout.layoutBox);\n      const d = this.treeScale.x, h = this.treeScale.y;\n      lf(this.layoutCorrected, this.treeScale, this.path, a), o.layout && !o.target && (this.treeScale.x !== 1 || this.treeScale.y !== 1) && (o.target = o.layout.layoutBox, o.targetWithTransforms = st());\n      const { target: f } = o;\n      if (!f) {\n        this.prevProjectionDelta && (this.createProjectionDeltas(), this.scheduleRender());\n        return;\n      }\n      !this.projectionDelta || !this.prevProjectionDelta ? this.createProjectionDeltas() : (Wr(this.prevProjectionDelta.x, this.projectionDelta.x), Wr(this.prevProjectionDelta.y, this.projectionDelta.y)), ze(this.projectionDelta, this.layoutCorrected, f, this.latestValues), (this.treeScale.x !== d || this.treeScale.y !== h || !Zr(this.projectionDelta.x, this.prevProjectionDelta.x) || !Zr(this.projectionDelta.y, this.prevProjectionDelta.y)) && (this.hasProjected = !0, this.scheduleRender(), this.notifyListeners("projectionUpdate", f));\n    }\n    hide() {\n      this.isVisible = !1;\n    }\n    show() {\n      this.isVisible = !0;\n    }\n    scheduleRender(o = !0) {\n      if (this.options.visualElement?.scheduleRender(), o) {\n        const a = this.getStack();\n        a && a.scheduleRender();\n      }\n      this.resumingFrom && !this.resumingFrom.instance && (this.resumingFrom = void 0);\n    }\n    createProjectionDeltas() {\n      this.prevProjectionDelta = xe(), this.projectionDelta = xe(), this.projectionDeltaWithTransform = xe();\n    }\n    setAnimationOrigin(o, a = !1) {\n      const l = this.snapshot, u = l ? l.latestValues : {}, c = { ...this.latestValues }, d = xe();\n      (!this.relativeParent || !this.relativeParent.options.layoutRoot) && (this.relativeTarget = this.relativeTargetOrigin = void 0), this.attemptToResolveRelativeTarget = !a;\n      const h = st(), f = l ? l.source : void 0, g = this.layout ? this.layout.source : void 0, v = f !== g, y = this.getStack(), x = !y || y.members.length <= 1, T = !!(v && !x && this.options.crossfade === !0 && !this.path.some(Bp));\n      this.animationProgress = 0;\n      let b;\n      this.mixTargetDelta = (P) => {\n        const D = P / 1e3;\n        no(d.x, o.x, D), no(d.y, o.y, D), this.setTargetDelta(d), this.relativeTarget && this.relativeTargetOrigin && this.layout && this.relativeParent && this.relativeParent.layout && (Mn(h, this.layout.layoutBox, this.relativeParent.layout.layoutBox), Fp(this.relativeTarget, this.relativeTargetOrigin, h, D), b && Sp(this.relativeTarget, b) && (this.isProjectionDirty = !1), b || (b = st()), kt(b, this.relativeTarget)), v && (this.animationValues = c, yp(c, u, this.latestValues, D, T, x)), this.root.scheduleUpdateProjection(), this.scheduleRender(), this.animationProgress = D;\n      }, this.mixTargetDelta(this.options.layoutRoot ? 1e3 : 0);\n    }\n    startAnimation(o) {\n      this.notifyListeners("animationStart"), this.currentAnimation?.stop(), this.resumingFrom?.currentAnimation?.stop(), this.pendingAnimation && (ee(this.pendingAnimation), this.pendingAnimation = void 0), this.pendingAnimation = Y.update(() => {\n        xn.hasAnimatedSinceResize = !0, this.motionValue || (this.motionValue = Te(0)), this.currentAnimation = hp(this.motionValue, [0, 1e3], {\n          ...o,\n          velocity: 0,\n          isSync: !0,\n          onUpdate: (a) => {\n            this.mixTargetDelta(a), o.onUpdate && o.onUpdate(a);\n          },\n          onStop: () => {\n          },\n          onComplete: () => {\n            o.onComplete && o.onComplete(), this.completeAnimation();\n          }\n        }), this.resumingFrom && (this.resumingFrom.currentAnimation = this.currentAnimation), this.pendingAnimation = void 0;\n      });\n    }\n    completeAnimation() {\n      this.resumingFrom && (this.resumingFrom.currentAnimation = void 0, this.resumingFrom.preserveOpacity = void 0);\n      const o = this.getStack();\n      o && o.exitAnimationComplete(), this.resumingFrom = this.currentAnimation = this.animationValues = void 0, this.notifyListeners("animationComplete");\n    }\n    finishAnimation() {\n      this.currentAnimation && (this.mixTargetDelta && this.mixTargetDelta(Ap), this.currentAnimation.stop()), this.completeAnimation();\n    }\n    applyTransformsToTarget() {\n      const o = this.getLead();\n      let { targetWithTransforms: a, target: l, layout: u, latestValues: c } = o;\n      if (!(!a || !l || !u)) {\n        if (this !== o && this.layout && u && gl(this.options.animationType, this.layout.layoutBox, u.layoutBox)) {\n          l = this.target || st();\n          const d = gt(this.layout.layoutBox.x);\n          l.x.min = o.target.x.min, l.x.max = l.x.min + d;\n          const h = gt(this.layout.layoutBox.y);\n          l.y.min = o.target.y.min, l.y.max = l.y.min + h;\n        }\n        kt(a, l), ve(a, c), ze(this.projectionDeltaWithTransform, this.layoutCorrected, a, c);\n      }\n    }\n    registerSharedNode(o, a) {\n      this.sharedNodes.has(o) || this.sharedNodes.set(o, new Dp()), this.sharedNodes.get(o).add(a);\n      const u = a.options.initialPromotionConfig;\n      a.promote({\n        transition: u ? u.transition : void 0,\n        preserveFollowOpacity: u && u.shouldPreserveFollowOpacity ? u.shouldPreserveFollowOpacity(a) : void 0\n      });\n    }\n    isLead() {\n      const o = this.getStack();\n      return o ? o.lead === this : !0;\n    }\n    getLead() {\n      const { layoutId: o } = this.options;\n      return o ? this.getStack()?.lead || this : this;\n    }\n    getPrevLead() {\n      const { layoutId: o } = this.options;\n      return o ? this.getStack()?.prevLead : void 0;\n    }\n    getStack() {\n      const { layoutId: o } = this.options;\n      if (o)\n        return this.root.sharedNodes.get(o);\n    }\n    promote({ needsReset: o, transition: a, preserveFollowOpacity: l } = {}) {\n      const u = this.getStack();\n      u && u.promote(this, l), o && (this.projectionDelta = void 0, this.needsReset = !0), a && this.setOptions({ transition: a });\n    }\n    relegate() {\n      const o = this.getStack();\n      return o ? o.relegate(this) : !1;\n    }\n    resetSkewAndRotation() {\n      const { visualElement: o } = this.options;\n      if (!o)\n        return;\n      let a = !1;\n      const { latestValues: l } = o;\n      if ((l.z || l.rotate || l.rotateX || l.rotateY || l.rotateZ || l.skewX || l.skewY) && (a = !0), !a)\n        return;\n      const u = {};\n      l.z && is("z", o, u, this.animationValues);\n      for (let c = 0; c < ss.length; c++)\n        is(`rotate${ss[c]}`, o, u, this.animationValues), is(`skew${ss[c]}`, o, u, this.animationValues);\n      o.render();\n      for (const c in u)\n        o.setStaticValue(c, u[c]), this.animationValues && (this.animationValues[c] = u[c]);\n      o.scheduleRender();\n    }\n    applyProjectionStyles(o, a) {\n      if (!this.instance || this.isSVG)\n        return;\n      if (!this.isVisible) {\n        o.visibility = "hidden";\n        return;\n      }\n      const l = this.getTransformTemplate();\n      if (this.needsReset) {\n        this.needsReset = !1, o.visibility = "", o.opacity = "", o.pointerEvents = vn(a?.pointerEvents) || "", o.transform = l ? l(this.latestValues, "") : "none";\n        return;\n      }\n      const u = this.getLead();\n      if (!this.projectionDelta || !this.layout || !u.target) {\n        this.options.layoutId && (o.opacity = this.latestValues.opacity !== void 0 ? this.latestValues.opacity : 1, o.pointerEvents = vn(a?.pointerEvents) || ""), this.hasProjected && !ae(this.latestValues) && (o.transform = l ? l({}, "") : "none", this.hasProjected = !1);\n        return;\n      }\n      o.visibility = "";\n      const c = u.animationValues || u.latestValues;\n      this.applyTransformsToTarget();\n      let d = Cp(this.projectionDeltaWithTransform, this.treeScale, c);\n      l && (d = l(c, d)), o.transform = d;\n      const { x: h, y: f } = this.projectionDelta;\n      o.transformOrigin = `${h.origin * 100}% ${f.origin * 100}% 0`, u.animationValues ? o.opacity = u === this ? c.opacity ?? this.latestValues.opacity ?? 1 : this.preserveOpacity ? this.latestValues.opacity : c.opacityExit : o.opacity = u === this ? c.opacity !== void 0 ? c.opacity : "" : c.opacityExit !== void 0 ? c.opacityExit : 0;\n      for (const g in Vs) {\n        if (c[g] === void 0)\n          continue;\n        const { correct: v, applyTo: y, isCSSVariable: x } = Vs[g], T = d === "none" ? c[g] : v(c[g], u);\n        if (y) {\n          const b = y.length;\n          for (let P = 0; P < b; P++)\n            o[y[P]] = T;\n        } else\n          x ? this.options.visualElement.renderState.vars[g] = T : o[g] = T;\n      }\n      this.options.layoutId && (o.pointerEvents = u === this ? vn(a?.pointerEvents) || "" : "none");\n    }\n    clearSnapshot() {\n      this.resumeFrom = this.snapshot = void 0;\n    }\n    // Only run on root\n    resetTree() {\n      this.root.nodes.forEach((o) => o.currentAnimation?.stop()), this.root.nodes.forEach(Qr), this.root.sharedNodes.clear();\n    }\n  };\n}\nfunction Rp(t) {\n  t.updateLayout();\n}\nfunction Mp(t) {\n  const e = t.resumeFrom?.snapshot || t.snapshot;\n  if (t.isLead() && t.layout && e && t.hasListeners("didUpdate")) {\n    const { layoutBox: n, measuredBox: s } = t.layout, { animationType: i } = t.options, r = e.source !== t.layout.source;\n    i === "size" ? At((c) => {\n      const d = r ? e.measuredBox[c] : e.layoutBox[c], h = gt(d);\n      d.min = n[c].min, d.max = d.min + h;\n    }) : gl(i, e.layoutBox, n) && At((c) => {\n      const d = r ? e.measuredBox[c] : e.layoutBox[c], h = gt(n[c]);\n      d.max = d.min + h, t.relativeTarget && !t.currentAnimation && (t.isProjectionDirty = !0, t.relativeTarget[c].max = t.relativeTarget[c].min + h);\n    });\n    const o = xe();\n    ze(o, n, e.layoutBox);\n    const a = xe();\n    r ? ze(a, t.applyTransform(s, !0), e.measuredBox) : ze(a, n, e.layoutBox);\n    const l = !hl(o);\n    let u = !1;\n    if (!t.resumeFrom) {\n      const c = t.getClosestProjectingParent();\n      if (c && !c.resumeFrom) {\n        const { snapshot: d, layout: h } = c;\n        if (d && h) {\n          const f = st();\n          Mn(f, e.layoutBox, d.layoutBox);\n          const g = st();\n          Mn(g, n, h.layoutBox), fl(f, g) || (u = !0), c.options.layoutRoot && (t.relativeTarget = g, t.relativeTargetOrigin = f, t.relativeParent = c);\n        }\n      }\n    }\n    t.notifyListeners("didUpdate", {\n      layout: n,\n      snapshot: e,\n      delta: a,\n      layoutDelta: o,\n      hasLayoutChanged: l,\n      hasRelativeLayoutChanged: u\n    });\n  } else if (t.isLead()) {\n    const { onExitComplete: n } = t.options;\n    n && n();\n  }\n  t.options.transition = void 0;\n}\nfunction Ep(t) {\n  t.parent && (t.isProjecting() || (t.isProjectionDirty = t.parent.isProjectionDirty), t.isSharedProjectionDirty || (t.isSharedProjectionDirty = !!(t.isProjectionDirty || t.parent.isProjectionDirty || t.parent.isSharedProjectionDirty)), t.isTransformDirty || (t.isTransformDirty = t.parent.isTransformDirty));\n}\nfunction Vp(t) {\n  t.isProjectionDirty = t.isSharedProjectionDirty = t.isTransformDirty = !1;\n}\nfunction Np(t) {\n  t.clearSnapshot();\n}\nfunction Qr(t) {\n  t.clearMeasurements();\n}\nfunction to(t) {\n  t.isLayoutDirty = !1;\n}\nfunction kp(t) {\n  const { visualElement: e } = t.options;\n  e && e.getProps().onBeforeLayoutMeasure && e.notify("BeforeLayoutMeasure"), t.resetTransform();\n}\nfunction eo(t) {\n  t.finishAnimation(), t.targetDelta = t.relativeTarget = t.target = void 0, t.isProjectionDirty = !0;\n}\nfunction Ip(t) {\n  t.resolveTargetDelta();\n}\nfunction jp(t) {\n  t.calcProjection();\n}\nfunction Lp(t) {\n  t.resetSkewAndRotation();\n}\nfunction Op(t) {\n  t.removeLeadSnapshot();\n}\nfunction no(t, e, n) {\n  t.translate = J(e.translate, 0, n), t.scale = J(e.scale, 1, n), t.origin = e.origin, t.originPoint = e.originPoint;\n}\nfunction so(t, e, n, s) {\n  t.min = J(e.min, n.min, s), t.max = J(e.max, n.max, s);\n}\nfunction Fp(t, e, n, s) {\n  so(t.x, e.x, n.x, s), so(t.y, e.y, n.y, s);\n}\nfunction Bp(t) {\n  return t.animationValues && t.animationValues.opacityExit !== void 0;\n}\nconst $p = {\n  duration: 0.45,\n  ease: [0.4, 0, 0.1, 1]\n}, io = (t) => typeof navigator < "u" && navigator.userAgent && navigator.userAgent.toLowerCase().includes(t), ro = io("applewebkit/") && !io("chrome/") ? Math.round : Mt;\nfunction oo(t) {\n  t.min = ro(t.min), t.max = ro(t.max);\n}\nfunction _p(t) {\n  oo(t.x), oo(t.y);\n}\nfunction gl(t, e, n) {\n  return t === "position" || t === "preserve-aspect" && !Yf(Jr(e), Jr(n), 0.2);\n}\nfunction Up(t) {\n  return t !== t.root && t.scroll?.wasRoot;\n}\nconst zp = ml({\n  attachResizeListener: (t, e) => Ze(t, "resize", e),\n  measureScroll: () => ({\n    x: document.documentElement.scrollLeft || document.body.scrollLeft,\n    y: document.documentElement.scrollTop || document.body.scrollTop\n  }),\n  checkIsScrollRoot: () => !0\n}), rs = {\n  current: void 0\n}, yl = ml({\n  measureScroll: (t) => ({\n    x: t.scrollLeft,\n    y: t.scrollTop\n  }),\n  defaultParent: () => {\n    if (!rs.current) {\n      const t = new zp({});\n      t.mount(window), t.setOptions({ layoutScroll: !0 }), rs.current = t;\n    }\n    return rs.current;\n  },\n  resetTransform: (t, e) => {\n    t.style.transform = e !== void 0 ? e : "none";\n  },\n  checkIsScrollRoot: (t) => window.getComputedStyle(t).position === "fixed"\n}), Wp = {\n  pan: {\n    Feature: up\n  },\n  drag: {\n    Feature: cp,\n    ProjectionNode: yl,\n    MeasureLayout: cl\n  }\n};\nfunction ao(t, e, n) {\n  const { props: s } = t;\n  t.animationState && s.whileHover && t.animationState.setActive("whileHover", n === "Start");\n  const i = "onHover" + n, r = s[i];\n  r && Y.postRender(() => r(e, on(e)));\n}\nclass Kp extends se {\n  mount() {\n    const { current: e } = this.node;\n    e && (this.unmount = hh(e, (n, s) => (ao(this.node, s, "Start"), (i) => ao(this.node, i, "End"))));\n  }\n  unmount() {\n  }\n}\nclass Gp extends se {\n  constructor() {\n    super(...arguments), this.isActive = !1;\n  }\n  onFocus() {\n    let e = !1;\n    try {\n      e = this.node.current.matches(":focus-visible");\n    } catch {\n      e = !0;\n    }\n    !e || !this.node.animationState || (this.node.animationState.setActive("whileFocus", !0), this.isActive = !0);\n  }\n  onBlur() {\n    !this.isActive || !this.node.animationState || (this.node.animationState.setActive("whileFocus", !1), this.isActive = !1);\n  }\n  mount() {\n    this.unmount = nn(Ze(this.node.current, "focus", () => this.onFocus()), Ze(this.node.current, "blur", () => this.onBlur()));\n  }\n  unmount() {\n  }\n}\nfunction lo(t, e, n) {\n  const { props: s } = t;\n  if (t.current instanceof HTMLButtonElement && t.current.disabled)\n    return;\n  t.animationState && s.whileTap && t.animationState.setActive("whileTap", n === "Start");\n  const i = "onTap" + (n === "End" ? "" : n), r = s[i];\n  r && Y.postRender(() => r(e, on(e)));\n}\nclass Hp extends se {\n  mount() {\n    const { current: e } = this.node;\n    e && (this.unmount = gh(e, (n, s) => (lo(this.node, s, "Start"), (i, { success: r }) => lo(this.node, i, r ? "End" : "Cancel")), { useGlobalTarget: this.node.props.globalTapTarget }));\n  }\n  unmount() {\n  }\n}\nconst Bs = /* @__PURE__ */ new WeakMap(), os = /* @__PURE__ */ new WeakMap(), Xp = (t) => {\n  const e = Bs.get(t.target);\n  e && e(t);\n}, Yp = (t) => {\n  t.forEach(Xp);\n};\nfunction qp({ root: t, ...e }) {\n  const n = t || document;\n  os.has(n) || os.set(n, {});\n  const s = os.get(n), i = JSON.stringify(e);\n  return s[i] || (s[i] = new IntersectionObserver(Yp, { root: t, ...e })), s[i];\n}\nfunction Jp(t, e, n) {\n  const s = qp(e);\n  return Bs.set(t, n), s.observe(t), () => {\n    Bs.delete(t), s.unobserve(t);\n  };\n}\nconst Zp = {\n  some: 0,\n  all: 1\n};\nclass Qp extends se {\n  constructor() {\n    super(...arguments), this.hasEnteredView = !1, this.isInView = !1;\n  }\n  startObserver() {\n    this.unmount();\n    const { viewport: e = {} } = this.node.getProps(), { root: n, margin: s, amount: i = "some", once: r } = e, o = {\n      root: n ? n.current : void 0,\n      rootMargin: s,\n      threshold: typeof i == "number" ? i : Zp[i]\n    }, a = (l) => {\n      const { isIntersecting: u } = l;\n      if (this.isInView === u || (this.isInView = u, r && !u && this.hasEnteredView))\n        return;\n      u && (this.hasEnteredView = !0), this.node.animationState && this.node.animationState.setActive("whileInView", u);\n      const { onViewportEnter: c, onViewportLeave: d } = this.node.getProps(), h = u ? c : d;\n      h && h(l);\n    };\n    return Jp(this.node.current, o, a);\n  }\n  mount() {\n    this.startObserver();\n  }\n  update() {\n    if (typeof IntersectionObserver > "u")\n      return;\n    const { props: e, prevProps: n } = this.node;\n    ["amount", "margin", "root"].some(tm(e, n)) && this.startObserver();\n  }\n  unmount() {\n  }\n}\nfunction tm({ viewport: t = {} }, { viewport: e = {} } = {}) {\n  return (n) => t[n] !== e[n];\n}\nconst em = {\n  inView: {\n    Feature: Qp\n  },\n  tap: {\n    Feature: Hp\n  },\n  focus: {\n    Feature: Gp\n  },\n  hover: {\n    Feature: Kp\n  }\n}, nm = {\n  layout: {\n    ProjectionNode: yl,\n    MeasureLayout: cl\n  }\n}, sm = {\n  ...zf,\n  ...em,\n  ...Wp,\n  ...nm\n}, as = /* @__PURE__ */ rf(sm, vf);\nclass im {\n  // \u4E0D\u518D\u9700\u8981 getClient\uFF0C\u56E0\u70BA\u73FE\u5728\u901A\u904E\u5F8C\u7AEF API \u8ABF\u7528\n  async searchPlaces(e, n, s) {\n    try {\n      const i = await fetch("/api/itinerary/search-places", {\n        method: "POST",\n        headers: { "Content-Type": "application/json" },\n        credentials: "include",\n        body: JSON.stringify({ query: e, latitude: n, longitude: s })\n      });\n      if (!i.ok) {\n        const o = await i.json();\n        throw new Error(o.error || "Failed to search places");\n      }\n      return (await i.json()).data || [];\n    } catch (i) {\n      return console.error("Gemini Search Error:", i), [];\n    }\n  }\n  async optimizeDayPlan(e) {\n    try {\n      const n = await fetch("/api/itinerary/optimize-day-plan", {\n        method: "POST",\n        headers: { "Content-Type": "application/json" },\n        credentials: "include",\n        body: JSON.stringify({ places: e })\n      });\n      if (!n.ok) {\n        const i = await n.json();\n        throw new Error(i.error || "Failed to optimize day plan");\n      }\n      return (await n.json()).data || null;\n    } catch (n) {\n      return console.error("Gemini Optimization Error:", n), null;\n    }\n  }\n}\nlet ls = null;\nconst rm = () => (ls || (ls = new im()), ls), co = new Proxy({}, {\n  get(t, e) {\n    return rm()[e];\n  }\n});\nclass om {\n  constructor(e = "/api") {\n    this.baseURL = e, this.defaultHeaders = {\n      "Content-Type": "application/json"\n    };\n  }\n  /**\n   * \u8A2D\u5B9A\u8A8D\u8B49 token\n   */\n  setAuthToken(e) {\n    if (e)\n      this.defaultHeaders = {\n        ...this.defaultHeaders,\n        Authorization: `Bearer ${e}`\n      };\n    else {\n      const { Authorization: n, ...s } = this.defaultHeaders;\n      this.defaultHeaders = s;\n    }\n  }\n  /**\n   * \u5F9E cookie \u6216 localStorage \u7372\u53D6 session\n   */\n  getSessionToken() {\n    const e = document.cookie.split(";");\n    for (const n of e) {\n      const [s, i] = n.trim().split("=");\n      if (s === "session_id" || s === "session")\n        return i;\n    }\n    return localStorage.getItem("session_token");\n  }\n  /**\n   * \u5EFA\u7ACB\u5B8C\u6574\u7684\u8ACB\u6C42 URL\n   */\n  buildURL(e) {\n    if (e.startsWith("http://") || e.startsWith("https://"))\n      return e;\n    const n = e.startsWith("/") ? e.slice(1) : e;\n    return `${this.baseURL}/${n}`;\n  }\n  /**\n   * \u8655\u7406 API \u56DE\u61C9\n   */\n  async handleResponse(e) {\n    const n = e.headers.get("content-type"), s = n && n.includes("application/json");\n    let i;\n    try {\n      i = s ? await e.json() : await e.text();\n    } catch {\n      return {\n        success: !1,\n        error: "Failed to parse response"\n      };\n    }\n    return e.ok ? {\n      success: !0,\n      data: i.data !== void 0 ? i.data : i,\n      message: i.message\n    } : {\n      success: !1,\n      error: i.error || i.message || `HTTP ${e.status}: ${e.statusText}`,\n      message: i.message\n    };\n  }\n  /**\n   * \u901A\u7528\u8ACB\u6C42\u65B9\u6CD5\n   */\n  async request(e, n = {}) {\n    const s = this.buildURL(e), i = this.getSessionToken(), r = {\n      ...this.defaultHeaders,\n      ...n.headers\n    };\n    i && !r.Authorization && (r.Authorization = `Bearer ${i}`);\n    try {\n      const o = await fetch(s, {\n        ...n,\n        headers: r,\n        credentials: "include"\n        // \u5305\u542B cookies\n      });\n      return await this.handleResponse(o);\n    } catch (o) {\n      return console.error("[APIClient] Request failed:", o), {\n        success: !1,\n        error: o instanceof Error ? o.message : "Network error"\n      };\n    }\n  }\n  /**\n   * GET \u8ACB\u6C42\n   */\n  async get(e, n) {\n    return this.request(e, {\n      ...n,\n      method: "GET"\n    });\n  }\n  /**\n   * POST \u8ACB\u6C42\n   */\n  async post(e, n, s) {\n    return this.request(e, {\n      ...s,\n      method: "POST",\n      body: n ? JSON.stringify(n) : void 0\n    });\n  }\n  /**\n   * PUT \u8ACB\u6C42\n   */\n  async put(e, n, s) {\n    return this.request(e, {\n      ...s,\n      method: "PUT",\n      body: n ? JSON.stringify(n) : void 0\n    });\n  }\n  /**\n   * PATCH \u8ACB\u6C42\n   */\n  async patch(e, n, s) {\n    return this.request(e, {\n      ...s,\n      method: "PATCH",\n      body: n ? JSON.stringify(n) : void 0\n    });\n  }\n  /**\n   * DELETE \u8ACB\u6C42\n   */\n  async delete(e, n) {\n    return this.request(e, {\n      ...n,\n      method: "DELETE"\n    });\n  }\n}\nlet cs = null;\nconst Mi = () => (cs || (cs = new om()), cs);\nnew Proxy({}, {\n  get(t, e) {\n    return Mi()[e];\n  }\n});\nclass am {\n  constructor(e) {\n    this.apiClient = e || Mi();\n  }\n  /**\n   * \u641C\u5C0B\u5730\u9EDE\n   */\n  async searchLocations(e) {\n    return this.apiClient.post("/location/search", e);\n  }\n  /**\n   * \u7372\u53D6\u5730\u9EDE\u8A73\u60C5\n   */\n  async getLocationDetails(e) {\n    return this.apiClient.get(`/location/${e}`);\n  }\n  /**\n   * \u7372\u53D6\u5730\u9EDE\u8A73\u60C5\uFF08\u4F7F\u7528 Google Place ID\uFF09\n   */\n  async getLocationByGooglePlaceId(e) {\n    return this.apiClient.get(`/location/google/${e}`);\n  }\n  /**\n   * \u8A2D\u5B9A\u7528\u6236\u5730\u9EDE\u4E92\u52D5\u72C0\u614B\n   */\n  async setUserLocationStatus(e, n, s) {\n    return this.apiClient.post(`/location/${e}/interaction`, {\n      status: n,\n      notes: s\n    });\n  }\n  /**\n   * \u7372\u53D6\u7528\u6236\u7684\u5730\u9EDE\u4E92\u52D5\u72C0\u614B\n   */\n  async getUserLocationStatus(e) {\n    return this.apiClient.get(`/location/${e}/interaction`);\n  }\n  /**\n   * \u6536\u85CF\u5730\u9EDE\n   */\n  async favoriteLocation(e) {\n    return this.apiClient.post(`/location/${e}/favorite`);\n  }\n  /**\n   * \u53D6\u6D88\u6536\u85CF\u5730\u9EDE\n   */\n  async unfavoriteLocation(e) {\n    return this.apiClient.delete(`/location/${e}/favorite`);\n  }\n  /**\n   * \u7372\u53D6\u7528\u6236\u6536\u85CF\u7684\u5730\u9EDE\u5217\u8868\n   */\n  async getFavoriteLocations() {\n    return this.apiClient.get("/location/favorites");\n  }\n  /**\n   * \u7372\u53D6\u7528\u6236\u8A2A\u554F\u904E\u7684\u5730\u9EDE\u5217\u8868\n   */\n  async getVisitedLocations() {\n    return this.apiClient.get("/location/visited");\n  }\n  /**\n   * \u7372\u53D6\u7528\u6236\u500B\u4EBA\u5730\u9EDE\u6536\u85CF\n   * @param status - \u7BE9\u9078\u72C0\u614B\uFF1A\'visited\' | \'want_to_visit\' | \'want_to_revisit\'\n   * @param category - \u7BE9\u9078\u5206\u985E\uFF1A\'restaurant\' | \'attraction\' | \'hotel\' | etc.\n   */\n  async getPersonalLocations(e, n) {\n    const s = new URLSearchParams();\n    e && s.append("status", e), n && s.append("category", n);\n    const i = s.toString();\n    return this.apiClient.get(`/itinerary/location/personal${i ? "?" + i : ""}`);\n  }\n  /**\n   * \u7372\u53D6\u5730\u9EDE\u8A55\u8AD6\n   */\n  async getLocationComments(e) {\n    return this.apiClient.get(`/location/${e}/comments`);\n  }\n  /**\n   * \u65B0\u589E\u5730\u9EDE\u8A55\u8AD6\n   */\n  async addLocationComment(e, n, s) {\n    return this.apiClient.post(`/location/${e}/comments`, {\n      comment: n,\n      rating: s\n    });\n  }\n}\nlet us = null;\nconst lm = () => (us || (us = new am()), us), _t = new Proxy({}, {\n  get(t, e) {\n    return lm()[e];\n  }\n});\nclass cm {\n  constructor(e) {\n    this.apiClient = e || Mi();\n  }\n  /**\n   * \u4F7F\u7528 Google OAuth \u767B\u5165\n   */\n  async loginWithGoogle() {\n    window.location.href = "/api/auth/google";\n  }\n  /**\n   * \u8655\u7406 Google OAuth \u56DE\u8ABF\n   */\n  async handleGoogleCallback(e) {\n    return this.apiClient.post("/auth/google/callback", { code: e });\n  }\n  /**\n   * \u4F7F\u7528\u96FB\u5B50\u90F5\u4EF6\u548C\u5BC6\u78BC\u767B\u5165\n   */\n  async loginWithPassword(e) {\n    const n = await this.apiClient.post("/auth/login", e);\n    return n.success && n.data && (this.saveSession(n.data.session), this.saveUser(n.data.user)), n;\n  }\n  /**\n   * \u8A3B\u518A\u65B0\u7528\u6236\n   */\n  async register(e) {\n    return this.apiClient.post("/auth/register", e);\n  }\n  /**\n   * \u767B\u51FA\n   */\n  async logout() {\n    const e = await this.apiClient.post("/auth/logout");\n    return this.clearSession(), this.clearUser(), e;\n  }\n  /**\n   * \u7372\u53D6\u7576\u524D\u7528\u6236\n   */\n  async getCurrentUser() {\n    return this.apiClient.get("/auth/me");\n  }\n  /**\n   * \u6AA2\u67E5\u662F\u5426\u5DF2\u767B\u5165\n   */\n  isAuthenticated() {\n    const e = this.getSession();\n    return e ? e.expiresAt && e.expiresAt < Date.now() ? (this.clearSession(), !1) : !0 : !1;\n  }\n  /**\n   * \u7372\u53D6\u7576\u524D\u7528\u6236\uFF08\u5F9E\u672C\u5730\u5132\u5B58\uFF09\n   */\n  getCurrentUserLocal() {\n    try {\n      const e = localStorage.getItem("user");\n      return e ? JSON.parse(e) : null;\n    } catch (e) {\n      return console.error("[AuthService] Failed to get user from local storage:", e), null;\n    }\n  }\n  /**\n   * \u5132\u5B58\u6703\u8A71\u5230 localStorage\n   */\n  saveSession(e) {\n    try {\n      localStorage.setItem("session", JSON.stringify(e)), localStorage.setItem("session_id", e.id);\n    } catch (n) {\n      console.error("[AuthService] Failed to save session:", n);\n    }\n  }\n  /**\n   * \u5F9E localStorage \u7372\u53D6\u6703\u8A71\n   */\n  getSession() {\n    try {\n      const e = localStorage.getItem("session");\n      return e ? JSON.parse(e) : null;\n    } catch (e) {\n      return console.error("[AuthService] Failed to get session from local storage:", e), null;\n    }\n  }\n  /**\n   * \u5132\u5B58\u7528\u6236\u8CC7\u8A0A\u5230 localStorage\n   */\n  saveUser(e) {\n    try {\n      localStorage.setItem("user", JSON.stringify(e));\n    } catch (n) {\n      console.error("[AuthService] Failed to save user:", n);\n    }\n  }\n  /**\n   * \u6E05\u9664\u6703\u8A71\n   */\n  clearSession() {\n    localStorage.removeItem("session"), localStorage.removeItem("session_id");\n  }\n  /**\n   * \u6E05\u9664\u7528\u6236\u8CC7\u8A0A\n   */\n  clearUser() {\n    localStorage.removeItem("user");\n  }\n}\nlet ds = null;\nconst um = () => (ds || (ds = new cm()), ds), vl = new Proxy({}, {\n  get(t, e) {\n    return um()[e];\n  }\n}), uo = ({ place: t, onClick: e, showInteractions: n = !0 }) => {\n  const [s, i] = L(null), [r, o] = L(!1), [a, l] = L(!1), [u, c] = L(!1);\n  B(() => {\n    (async () => {\n      const v = vl.isAuthenticated();\n      c(v), v && t.id && n && await d();\n    })();\n  }, [t.id, n]);\n  const d = async () => {\n    if (t.id)\n      try {\n        const g = await _t.getUserLocationStatus(t.id);\n        g.success && g.data && i(g.data.status);\n      } catch (g) {\n        console.error("[PlaceCard] Error loading user status:", g);\n      }\n  }, h = async (g, v) => {\n    if (g.stopPropagation(), !(!u || !t.id || a)) {\n      l(!0);\n      try {\n        (await _t.setUserLocationStatus(t.id, v)).success && i(v);\n      } catch (y) {\n        console.error("[PlaceCard] Error setting status:", y);\n      } finally {\n        l(!1);\n      }\n    }\n  }, f = async (g) => {\n    if (g.stopPropagation(), !(!u || !t.id || a)) {\n      l(!0);\n      try {\n        r ? (await _t.unfavoriteLocation(t.id), o(!1)) : (await _t.favoriteLocation(t.id), o(!0));\n      } catch (v) {\n        console.error("[PlaceCard] Error toggling favorite:", v);\n      } finally {\n        l(!1);\n      }\n    }\n  };\n  return /* @__PURE__ */ p.jsx(\n    "div",\n    {\n      onClick: e,\n      className: "bg-white rounded-2xl border border-slate-100 p-4 transition-all hover:bg-slate-50 hover:border-blue-200 cursor-pointer group",\n      children: /* @__PURE__ */ p.jsxs("div", { className: "flex items-center justify-between gap-3", children: [\n        /* @__PURE__ */ p.jsxs("div", { className: "flex-1 min-w-0", children: [\n          /* @__PURE__ */ p.jsx("h3", { className: "font-bold text-slate-800 truncate text-sm group-hover:text-blue-600 transition-colors", children: t.name }),\n          t.address && /* @__PURE__ */ p.jsxs("p", { className: "text-[10px] text-slate-400 mt-1 truncate font-medium", children: [\n            /* @__PURE__ */ p.jsx("i", { className: "fas fa-map-marker-alt mr-1 text-slate-300" }),\n            " ",\n            t.address\n          ] }),\n          t.rating && /* @__PURE__ */ p.jsxs("div", { className: "flex items-center gap-1 mt-1", children: [\n            /* @__PURE__ */ p.jsx("i", { className: "fas fa-star text-amber-400 text-[9px]" }),\n            /* @__PURE__ */ p.jsx("span", { className: "text-[9px] text-slate-500 font-bold", children: t.rating }),\n            t.userRatingCount && /* @__PURE__ */ p.jsxs("span", { className: "text-[8px] text-slate-400", children: [\n              "(",\n              t.userRatingCount,\n              ")"\n            ] })\n          ] })\n        ] }),\n        /* @__PURE__ */ p.jsxs("div", { className: "flex items-center gap-2", children: [\n          u && n && /* @__PURE__ */ p.jsxs("div", { className: "flex items-center gap-1", children: [\n            /* @__PURE__ */ p.jsx(\n              "button",\n              {\n                onClick: (g) => h(g, "visited"),\n                disabled: a,\n                className: `w-7 h-7 rounded-lg flex items-center justify-center transition-all ${s === "visited" ? "bg-blue-600 text-white" : "bg-slate-50 text-slate-400 hover:bg-blue-50 hover:text-blue-600"}`,\n                title: "\u4F86\u904E",\n                children: /* @__PURE__ */ p.jsx("i", { className: "fas fa-check text-[9px]" })\n              }\n            ),\n            /* @__PURE__ */ p.jsx(\n              "button",\n              {\n                onClick: (g) => h(g, "want_to_visit"),\n                disabled: a,\n                className: `w-7 h-7 rounded-lg flex items-center justify-center transition-all ${s === "want_to_visit" ? "bg-emerald-600 text-white" : "bg-slate-50 text-slate-400 hover:bg-emerald-50 hover:text-emerald-600"}`,\n                title: "\u60F3\u4F86",\n                children: /* @__PURE__ */ p.jsx("i", { className: "fas fa-heart text-[9px]" })\n              }\n            ),\n            /* @__PURE__ */ p.jsx(\n              "button",\n              {\n                onClick: (g) => h(g, "want_to_revisit"),\n                disabled: a,\n                className: `w-7 h-7 rounded-lg flex items-center justify-center transition-all ${s === "want_to_revisit" ? "bg-purple-600 text-white" : "bg-slate-50 text-slate-400 hover:bg-purple-50 hover:text-purple-600"}`,\n                title: "\u60F3\u518D\u4F86",\n                children: /* @__PURE__ */ p.jsx("i", { className: "fas fa-redo text-[9px]" })\n              }\n            ),\n            /* @__PURE__ */ p.jsx(\n              "button",\n              {\n                onClick: f,\n                disabled: a,\n                className: `w-7 h-7 rounded-lg flex items-center justify-center transition-all ${r ? "bg-amber-500 text-white" : "bg-slate-50 text-slate-400 hover:bg-amber-50 hover:text-amber-500"}`,\n                title: "\u6536\u85CF",\n                children: /* @__PURE__ */ p.jsx("i", { className: "fas fa-star text-[9px]" })\n              }\n            )\n          ] }),\n          /* @__PURE__ */ p.jsx("div", { className: "w-8 h-8 rounded-full bg-slate-50 text-slate-300 flex items-center justify-center group-hover:bg-blue-600 group-hover:text-white transition-all", children: /* @__PURE__ */ p.jsx("i", { className: "fas fa-chevron-right text-[10px]" }) })\n        ] })\n      ] })\n    }\n  );\n}, ho = ({\n  item: t,\n  onRemove: e,\n  onTimeUpdate: n,\n  onClick: s,\n  isLast: i,\n  travelTimeToNext: r,\n  travelMode: o = "DRIVING",\n  nextPlace: a\n}) => {\n  const [l, u] = L(!1), [c, d] = L(t.startTime), h = j(null), {\n    attributes: f,\n    listeners: g,\n    setNodeRef: v,\n    transform: y,\n    transition: x,\n    isDragging: T\n  } = xu({ id: t.id }), b = {\n    transform: Ge.Transform.toString(y),\n    transition: x,\n    zIndex: T ? 50 : l ? 100 : 1,\n    opacity: T ? 0.3 : 1\n  }, P = o === "DRIVING" ? "blue" : "emerald", D = (S) => {\n    const [N, O] = S.split(":"), F = parseInt(N), G = F >= 12 ? "\u4E0B\u5348" : "\u4E0A\u5348", _ = F % 12 || 12;\n    return { ampm: G, h: _.toString().padStart(2, "0"), m: O };\n  }, { ampm: R, h: m, m: w } = D(t.startTime), C = () => {\n    u(!1), n && c !== t.startTime && n(t.id, c);\n  };\n  B(() => {\n    const S = (N) => {\n      h.current && !h.current.contains(N.target) && l && C();\n    };\n    return l && document.addEventListener("mousedown", S), () => document.removeEventListener("mousedown", S);\n  }, [l, c]);\n  const M = (S) => {\n    if (S.stopPropagation(), !a) return;\n    const N = t.place.location ? `${t.place.location.lat},${t.place.location.lng}` : encodeURIComponent(t.place.name), O = a.location ? `${a.location.lat},${a.location.lng}` : encodeURIComponent(a.name), F = o === "DRIVING" ? "driving" : "walking";\n    window.open(`https://www.google.com/maps/dir/?api=1&origin=${N}&destination=${O}&travelmode=${F}`, "_blank");\n  };\n  return /* @__PURE__ */ p.jsxs(\n    "div",\n    {\n      ref: v,\n      style: b,\n      className: "relative flex flex-col group w-full",\n      children: [\n        l && /* @__PURE__ */ p.jsx("div", { className: "fixed inset-0 bg-slate-900/5 backdrop-blur-[1px] z-[90] pointer-events-none" }),\n        /* @__PURE__ */ p.jsxs("div", { className: "flex items-start gap-4 sm:gap-6 w-full relative", children: [\n          /* @__PURE__ */ p.jsxs("div", { className: "relative flex flex-col items-center flex-shrink-0", children: [\n            /* @__PURE__ */ p.jsx("div", { className: "w-4 h-4 rounded-full bg-white border-4 border-blue-600 shadow-xl z-20 relative group-hover:scale-125 transition-all duration-500" }),\n            !i && /* @__PURE__ */ p.jsx("div", { className: "absolute top-12 bottom-[-54px] w-[2px] bg-gradient-to-b from-blue-600/30 via-slate-100 to-slate-100 z-10" })\n          ] }),\n          /* @__PURE__ */ p.jsxs("div", { className: "flex-1 min-w-0 flex flex-col gap-3", children: [\n            /* @__PURE__ */ p.jsx("div", { ref: h, className: "flex-shrink-0 relative z-[101]", children: l ? (\n              /* \u6642\u9593\u9078\u64C7\u5668\u5F48\u7A97 */\n              /* @__PURE__ */ p.jsxs("div", { className: "absolute top-0 left-0 z-[110] bg-[#1e1e1e] rounded-[2rem] p-4 shadow-[0_30px_60px_-12px_rgba(0,0,0,0.45)] border border-slate-700 w-44 animate-in fade-in zoom-in slide-in-from-left-4 duration-300", children: [\n                /* @__PURE__ */ p.jsx("div", { className: "absolute top-6 -left-2 w-4 h-4 bg-[#1e1e1e] border-l border-t border-slate-700 rotate-[-45deg]" }),\n                /* @__PURE__ */ p.jsxs("div", { className: "flex flex-col gap-4 relative", children: [\n                  /* @__PURE__ */ p.jsxs("div", { className: "flex items-center justify-between px-1", children: [\n                    /* @__PURE__ */ p.jsx("span", { className: "text-[10px] font-black text-slate-500 uppercase tracking-[0.2em]", children: "\u884C\u7A0B\u6642\u9593" }),\n                    /* @__PURE__ */ p.jsx("button", { onClick: C, className: "text-[10px] font-black text-blue-400 hover:text-white transition-colors", children: "\u5132\u5B58" })\n                  ] }),\n                  /* @__PURE__ */ p.jsxs("div", { className: "space-y-3", children: [\n                    /* @__PURE__ */ p.jsx("div", { className: "relative group", children: /* @__PURE__ */ p.jsx(\n                      "input",\n                      {\n                        type: "time",\n                        autoFocus: !0,\n                        value: c,\n                        onChange: (S) => d(S.target.value),\n                        className: "w-full bg-[#2a2d31] text-white border-2 border-transparent focus:border-blue-500 rounded-2xl py-3 px-4 text-2xl font-black tabular-nums outline-none transition-all shadow-inner text-center"\n                      }\n                    ) }),\n                    /* @__PURE__ */ p.jsxs("p", { className: "text-[9px] text-slate-500 font-bold leading-tight px-1", children: [\n                      /* @__PURE__ */ p.jsx("i", { className: "fas fa-info-circle mr-1" }),\n                      " \u4FEE\u6539\u5C07\u81EA\u52D5\u9806\u5EF6\u5F8C\u7E8C\u884C\u7A0B"\n                    ] })\n                  ] })\n                ] })\n              ] })\n            ) : /* @__PURE__ */ p.jsxs(\n              "button",\n              {\n                onClick: (S) => {\n                  S.stopPropagation(), u(!0);\n                },\n                className: "group/time relative flex items-center gap-3 px-4 py-2.5 rounded-2xl bg-slate-50 hover:bg-white hover:ring-2 hover:ring-blue-500 transition-all duration-300 w-fit shadow-sm",\n                children: [\n                  /* @__PURE__ */ p.jsx("span", { className: "text-[11px] font-black text-slate-400 uppercase tracking-tighter", children: R }),\n                  /* @__PURE__ */ p.jsxs("div", { className: "flex items-center gap-2", children: [\n                    /* @__PURE__ */ p.jsxs("span", { className: "text-[18px] font-black text-blue-600 tabular-nums leading-none tracking-tighter", children: [\n                      m,\n                      ":",\n                      w\n                    ] }),\n                    /* @__PURE__ */ p.jsx("div", { className: "w-5 h-5 rounded-lg bg-blue-50 flex items-center justify-center group-hover/time:bg-blue-600 transition-colors", children: /* @__PURE__ */ p.jsx("i", { className: "fas fa-pencil text-[8px] text-blue-400 group-hover/time:text-white" }) })\n                  ] })\n                ]\n              }\n            ) }),\n            /* @__PURE__ */ p.jsxs(\n              "div",\n              {\n                onClick: s,\n                className: `bg-white p-5 rounded-[2.5rem] shadow-[0_4px_30px_rgba(0,0,0,0.02)] border border-slate-100 flex items-center justify-between hover:border-blue-400 hover:shadow-[0_25px_60px_rgba(37,99,235,0.12)] transition-all duration-500 cursor-pointer active:scale-[0.98] overflow-hidden ${l ? "opacity-30" : ""}`,\n                children: [\n                  /* @__PURE__ */ p.jsx("div", { ...f, ...g, onClick: (S) => S.stopPropagation(), className: "cursor-grab active:cursor-grabbing mr-4 text-slate-200 hover:text-blue-500 transition-colors p-2 flex-shrink-0", children: /* @__PURE__ */ p.jsx("i", { className: "fas fa-grip-vertical text-sm" }) }),\n                  /* @__PURE__ */ p.jsxs("div", { className: "flex-1 min-w-0", children: [\n                    /* @__PURE__ */ p.jsx("h4", { className: "font-black text-slate-900 text-[16px] sm:text-[18px] leading-tight break-words whitespace-normal group-hover:text-blue-600 transition-colors tracking-tight", children: t.place.name }),\n                    /* @__PURE__ */ p.jsxs("div", { className: "flex flex-wrap items-center gap-x-4 gap-y-2 mt-3", children: [\n                      /* @__PURE__ */ p.jsxs("div", { className: "flex items-center gap-2 px-3 py-1.5 bg-blue-50/60 rounded-xl", children: [\n                        /* @__PURE__ */ p.jsx("i", { className: "fas fa-hourglass-start text-blue-500 text-[10px]" }),\n                        /* @__PURE__ */ p.jsx("span", { className: "text-[11px] text-blue-700 font-black", children: "\u505C\u7559 1.5h" })\n                      ] }),\n                      /* @__PURE__ */ p.jsxs("div", { className: "flex items-center gap-1.5", children: [\n                        /* @__PURE__ */ p.jsx("i", { className: "fas fa-location-dot text-slate-200 text-[11px]" }),\n                        /* @__PURE__ */ p.jsx("span", { className: "text-[11px] text-slate-400 font-bold truncate max-w-[160px]", children: t.place.address?.split(" ")[0] || "\u6F8E\u6E56\u7E23" })\n                      ] })\n                    ] })\n                  ] }),\n                  /* @__PURE__ */ p.jsx("button", { onClick: (S) => {\n                    S.stopPropagation(), e(t.id);\n                  }, className: "ml-4 w-10 h-10 rounded-2xl flex items-center justify-center text-slate-200 hover:bg-red-50 hover:text-red-500 transition-all duration-300 flex-shrink-0", children: /* @__PURE__ */ p.jsx("i", { className: "fas fa-trash-alt text-[12px]" }) })\n                ]\n              }\n            )\n          ] })\n        ] }),\n        !i && /* @__PURE__ */ p.jsxs("div", { className: "flex items-center gap-4 sm:gap-6 h-[100px] pointer-events-none w-full mt-2", children: [\n          /* @__PURE__ */ p.jsx("div", { className: "w-4 flex-shrink-0" }),\n          /* @__PURE__ */ p.jsx("div", { className: "relative flex-1 flex items-center justify-start min-w-0", children: r && /* @__PURE__ */ p.jsxs("button", { onClick: M, className: "pointer-events-auto group/nav relative flex items-center gap-4 bg-white border border-slate-50 py-3.5 px-6 rounded-[2rem] shadow-[0_12px_40px_rgba(0,0,0,0.06)] hover:shadow-2xl hover:border-blue-300 hover:-translate-y-1 transition-all duration-500 max-w-[260px]", children: [\n            /* @__PURE__ */ p.jsx("div", { className: `w-10 h-10 rounded-2xl bg-${P}-600 flex items-center justify-center text-white text-[13px] shadow-lg group-hover/nav:rotate-12 transition-all`, children: /* @__PURE__ */ p.jsx("i", { className: `fas fa-${o === "DRIVING" ? "car-side" : "person-walking"}` }) }),\n            /* @__PURE__ */ p.jsxs("div", { className: "flex flex-col items-start min-w-0", children: [\n              /* @__PURE__ */ p.jsxs("div", { className: "flex items-center gap-2", children: [\n                /* @__PURE__ */ p.jsx("span", { className: "text-[16px] font-black text-slate-900 tabular-nums leading-none", children: r }),\n                /* @__PURE__ */ p.jsx("div", { className: "w-2 h-2 rounded-full bg-blue-500 animate-pulse" })\n              ] }),\n              /* @__PURE__ */ p.jsx("span", { className: `text-[9px] font-black text-${P}-500 uppercase tracking-widest leading-none mt-1.5 whitespace-nowrap`, children: "\u9EDE\u64CA\u958B\u555F\u5C0E\u89BD" })\n            ] })\n          ] }) })\n        ] })\n      ]\n    }\n  );\n}, dm = ({\n  items: t,\n  center: e,\n  travelMode: n = "DRIVING",\n  onAddPlaceFromMap: s,\n  selectedPlace: i,\n  onInfoWindowClose: r,\n  onTravelDataUpdate: o\n}) => {\n  const a = j(null), l = j(null), u = j([]), c = j([]), d = j([]), h = j(null), [f, g] = L(!1), [v, y] = L(null);\n  B(() => {\n    (async () => {\n      try {\n        const w = await fetch("/api/itinerary/maps-api-key", {\n          method: "GET",\n          credentials: "include"\n        });\n        if (w.ok) {\n          const C = await w.json();\n          C.success && C.apiKey && y(C.apiKey);\n        }\n      } catch (w) {\n        console.error("[MapView] Failed to fetch Google Maps API key:", w);\n      }\n    })();\n  }, []), B(() => ((async () => {\n    if (!a.current || !v) return;\n    const w = (C) => {\n      var M, S, N, O = "The Google Maps JavaScript API", F = "google", G = "importLibrary", _ = "__googleMapsCallback__", k = document, U = window;\n      U = U[F] || (U[F] = {});\n      var H = U.maps || (U.maps = {}), tt = /* @__PURE__ */ new Set(), et = new URLSearchParams(), X = () => M || (M = new Promise(async (dt, xt) => {\n        await (S = k.createElement("script")), S.async = !0, et.set("libraries", [...tt] + "");\n        for (N in C) et.set(N.replace(/[A-Z]/g, (Ot) => "_" + Ot[0].toLowerCase()), C[N]);\n        et.set("callback", F + ".maps." + _), S.src = "https://maps.googleapis.com/maps/api/js?" + et, H[_] = dt, S.onerror = () => M = xt(Error(O + " could not load.")), k.head.append(S);\n      }));\n      H[G] ? console.warn(O + " only loads once. Re-trying:", C) : H[G] = (dt, ...xt) => tt.add(dt) && X().then(() => H[G](dt, ...xt));\n    };\n    window.google?.maps?.importLibrary || w({ key: v, v: "weekly", loading: "async" });\n    try {\n      const { Map: C, InfoWindow: M } = await window.google.maps.importLibrary("maps"), S = e || { lat: 23.5713, lng: 119.5793 };\n      l.current = new C(a.current, {\n        center: S,\n        zoom: 12,\n        mapId: "DEMO_MAP_ID",\n        disableDefaultUI: !0,\n        zoomControl: !0,\n        clickableIcons: !0,\n        gestureHandling: "greedy"\n        // \u5141\u8A31\u6EFE\u52D5\u7E2E\u653E\uFF0C\u4E0D\u9700\u8981\u6309 command\n      }), h.current = new M(), h.current.addListener("closeclick", () => {\n        r && r();\n      }), l.current.addListener("click", async (N) => {\n        N.placeId ? (N.stop(), x(N.placeId)) : r && r();\n      }), g(!0);\n    } catch (C) {\n      console.error("Failed to load Google Maps libraries:", C);\n    }\n  })(), () => b()), [v]), B(() => {\n    f && R();\n  }, [t, f, n]), B(() => {\n    (async () => {\n      if (!f || !l.current || !i) {\n        f && !i && h.current && h.current.close();\n        return;\n      }\n      if (i.location)\n        l.current.panTo(i.location), l.current.setZoom(16), T(i);\n      else\n        try {\n          const { Place: w } = await window.google.maps.importLibrary("places"), C = {\n            textQuery: i.name,\n            fields: ["displayName", "formattedAddress", "location", "id", "rating", "userRatingCount", "nationalPhoneNumber", "websiteURI", "types"],\n            maxResultCount: 1,\n            locationBias: l.current.getCenter()\n          }, { places: M } = await w.searchByText(C);\n          if (M && M.length > 0) {\n            const S = M[0], N = {\n              ...i,\n              id: S.id || i.id,\n              location: { lat: S.location.lat(), lng: S.location.lng() },\n              address: S.formattedAddress || i.address,\n              formatted_address: S.formattedAddress || i.address,\n              rating: S.rating,\n              userRatingCount: S.userRatingCount,\n              phoneNumber: S.nationalPhoneNumber,\n              website: S.websiteURI,\n              types: S.types,\n              // \u6DFB\u52A0 Google Place \u76F8\u95DC\u6B04\u4F4D\n              google_place_id: S.id || i.id,\n              place_id: S.id || i.id,\n              latitude: S.location.lat(),\n              longitude: S.location.lng(),\n              lat: S.location.lat(),\n              lng: S.location.lng(),\n              google_rating: S.rating,\n              user_ratings_total: S.userRatingCount\n            };\n            l.current.panTo(N.location), l.current.setZoom(16), T(N);\n          }\n        } catch (w) {\n          console.error("Resolve place error:", w);\n        }\n    })();\n  }, [i, f]);\n  const x = async (m) => {\n    try {\n      const { Place: w } = await window.google.maps.importLibrary("places"), C = new w({ id: m });\n      await C.fetchFields({\n        fields: ["displayName", "formattedAddress", "location", "rating", "userRatingCount", "nationalPhoneNumber", "websiteURI", "regularOpeningHours", "types", "priceLevel"]\n      });\n      const M = {\n        id: m,\n        name: C.displayName || "\u672A\u77E5\u5730\u9EDE",\n        address: C.formattedAddress,\n        formatted_address: C.formattedAddress,\n        rating: C.rating,\n        userRatingCount: C.userRatingCount,\n        phoneNumber: C.nationalPhoneNumber,\n        website: C.websiteURI,\n        types: C.types,\n        location: { lat: C.location.lat(), lng: C.location.lng() },\n        // \u6DFB\u52A0 Google Place \u76F8\u95DC\u6B04\u4F4D\n        google_place_id: m,\n        place_id: m,\n        latitude: C.location.lat(),\n        longitude: C.location.lng(),\n        lat: C.location.lat(),\n        lng: C.location.lng(),\n        google_rating: C.rating,\n        user_ratings_total: C.userRatingCount\n      };\n      T(M);\n    } catch (w) {\n      console.error("Error fetching place details:", w);\n    }\n  }, T = async (m) => {\n    if (!l.current || !h.current) return;\n    const w = vl.isAuthenticated();\n    let C = null, M = !1;\n    if (w && m.id)\n      try {\n        const _ = await _t.getUserLocationStatus(m.id);\n        _.success && _.data && (C = _.data.status);\n      } catch (_) {\n        console.error("[MapView] Error loading user status:", _);\n      }\n    const S = document.createElement("div");\n    S.className = "p-0 min-w-[300px] max-w-[340px] font-sans overflow-hidden rounded-3xl bg-white";\n    const N = m.rating ? Array(5).fill(0).map((_, k) => {\n      const U = Math.min(Math.max(m.rating - k, 0), 1);\n      return `<i class="fas fa-star ${U >= 0.8 ? "text-amber-400" : U >= 0.3 ? "text-amber-400/60" : "text-slate-100"}" style="font-size: 11px;"></i>`;\n    }).join("") : "", O = m.rating ? `<div class="flex items-center gap-2 mb-4 bg-amber-50/50 p-2.5 rounded-2xl border border-amber-100/50">\n           <div class="flex gap-0.5">${N}</div>\n           <span class="text-amber-700 text-xs font-black">${m.rating}</span>\n           <span class="text-amber-600/50 text-[10px] font-bold">/ ${m.userRatingCount?.toLocaleString()} \u5247\u8A55\u8AD6</span>\n         </div>` : "", F = m.types ? `<div class="flex flex-wrap gap-1.5 mb-5">\n           ${m.types.slice(0, 3).map((_) => `<span class="px-2.5 py-1 bg-slate-50 text-slate-500 rounded-xl text-[9px] font-black uppercase tracking-widest border border-slate-100 shadow-sm">${_.replace("_", " ")}</span>`).join("")}\n         </div>` : "", G = w && m.id ? `\n      <div class="flex items-center gap-2 mb-4 pt-4 border-t border-slate-50">\n        <button id="btn-status-visited-${m.id}" class="flex-1 py-2.5 px-3 rounded-xl text-[10px] font-black transition-all ${C === "visited" ? "bg-blue-600 text-white" : "bg-slate-50 text-slate-400 hover:bg-blue-50 hover:text-blue-600"}">\n          <i class="fas fa-check mr-1"></i>\u4F86\u904E\n        </button>\n        <button id="btn-status-want-${m.id}" class="flex-1 py-2.5 px-3 rounded-xl text-[10px] font-black transition-all ${C === "want_to_visit" ? "bg-emerald-600 text-white" : "bg-slate-50 text-slate-400 hover:bg-emerald-50 hover:text-emerald-600"}">\n          <i class="fas fa-heart mr-1"></i>\u60F3\u4F86\n        </button>\n        <button id="btn-status-revisit-${m.id}" class="flex-1 py-2.5 px-3 rounded-xl text-[10px] font-black transition-all ${C === "want_to_revisit" ? "bg-purple-600 text-white" : "bg-slate-50 text-slate-400 hover:bg-purple-50 hover:text-purple-600"}">\n          <i class="fas fa-redo mr-1"></i>\u60F3\u518D\u4F86\n        </button>\n        <button id="btn-favorite-${m.id}" class="w-10 h-10 rounded-xl flex items-center justify-center transition-all bg-slate-50 text-slate-400 hover:bg-amber-50 hover:text-amber-500">\n          <i class="fas fa-star text-[10px]"></i>\n        </button>\n      </div>\n    ` : "";\n    S.innerHTML = `\n      <div class="p-6">\n        <div class="flex justify-between items-start mb-5">\n           <div class="flex items-center gap-3">\n             <div class="w-10 h-10 rounded-2xl bg-gradient-to-br from-blue-600 to-indigo-700 flex items-center justify-center text-white text-[14px] shadow-xl shadow-blue-200">\n               <i class="fas fa-location-dot"></i>\n             </div>\n             <div class="flex flex-col">\n               <span class="text-blue-600 text-[10px] font-black uppercase tracking-[0.25em] leading-none mb-1">Discover Place</span>\n               <div class="w-8 h-1 bg-blue-100 rounded-full"></div>\n             </div>\n           </div>\n        </div>\n        <div class="font-black text-2xl text-slate-900 leading-tight mb-2 tracking-tighter">${m.name}</div>\n        ${O}\n        ${F}\n        <div class="space-y-4 pt-5 border-t border-slate-50">\n          ${m.phoneNumber ? `<div class="flex items-center gap-4 group"><div class="w-8 h-8 rounded-full bg-blue-50 flex items-center justify-center text-blue-600 shadow-sm"><i class="fas fa-phone text-[10px]"></i></div><span class="text-[13px] text-slate-700 font-bold">${m.phoneNumber}</span></div>` : ""}\n          ${m.website ? `<a href="${m.website}" target="_blank" class="flex items-center gap-4 group transition-all"><div class="w-8 h-8 rounded-full bg-indigo-50 flex items-center justify-center text-indigo-600 group-hover:bg-indigo-600 group-hover:text-white transition-all shadow-sm"><i class="fas fa-link text-[10px]"></i></div><span class="text-[13px] text-indigo-600 font-black group-hover:underline">\u9020\u8A2A\u5B98\u65B9\u7DB2\u7AD9</span></a>` : ""}\n          <div class="flex items-start gap-4"><div class="w-8 h-8 rounded-full bg-slate-50 flex items-center justify-center text-slate-400 shadow-sm"><i class="fas fa-map text-[10px]"></i></div><span class="text-[12px] text-slate-500 font-medium leading-relaxed">${m.address || "\u5730\u5740\u8CC7\u8A0A"}</span></div>\n        </div>\n        ${G}\n        <button id="btn-add-${m.id}" class="mt-4 w-full py-4.5 bg-slate-900 hover:bg-blue-600 text-white rounded-[1.25rem] text-[12px] font-black uppercase tracking-widest transition-all shadow-2xl shadow-slate-200 active:scale-[0.96] flex items-center justify-center gap-3 overflow-hidden group relative">\n          <span class="relative z-10"><i class="fas fa-plus-circle mr-1"></i> \u52A0\u5165\u6B64\u884C\u7A0B</span>\n          <div class="absolute inset-0 bg-gradient-to-r from-blue-600 to-indigo-600 opacity-0 group-hover:opacity-100 transition-opacity"></div>\n        </button>\n      </div>\n    `, h.current.setContent(S), h.current.setPosition(m.location), h.current.open(l.current), setTimeout(() => {\n      const _ = document.getElementById(`btn-add-${m.id}`);\n      if (_ && (_.onclick = (k) => {\n        k.preventDefault(), s(m), h.current.close();\n      }), w && m.id) {\n        const k = document.getElementById(`btn-status-visited-${m.id}`), U = document.getElementById(`btn-status-want-${m.id}`), H = document.getElementById(`btn-status-revisit-${m.id}`), tt = document.getElementById(`btn-favorite-${m.id}`);\n        k && (k.onclick = async (et) => {\n          et.preventDefault();\n          try {\n            await _t.setUserLocationStatus(m.id, "visited"), T(m);\n          } catch (X) {\n            console.error("[MapView] Error setting status:", X);\n          }\n        }), U && (U.onclick = async (et) => {\n          et.preventDefault();\n          try {\n            await _t.setUserLocationStatus(m.id, "want_to_visit"), T(m);\n          } catch (X) {\n            console.error("[MapView] Error setting status:", X);\n          }\n        }), H && (H.onclick = async (et) => {\n          et.preventDefault();\n          try {\n            await _t.setUserLocationStatus(m.id, "want_to_revisit"), T(m);\n          } catch (X) {\n            console.error("[MapView] Error setting status:", X);\n          }\n        }), tt && (tt.onclick = async (et) => {\n          et.preventDefault();\n          try {\n            M || await _t.favoriteLocation(m.id), T(m);\n          } catch (X) {\n            console.error("[MapView] Error toggling favorite:", X);\n          }\n        });\n      }\n    }, 10);\n  }, b = () => {\n    u.current.forEach((m) => m.setMap(null)), u.current = [], c.current.forEach((m) => m.setMap(null)), c.current = [], d.current.forEach((m) => m.setMap(null)), d.current = [];\n  }, P = (m, w) => {\n    const M = (w.lat - m.lat) * Math.PI / 180, S = (w.lng - m.lng) * Math.PI / 180, N = Math.sin(M / 2) * Math.sin(M / 2) + Math.cos(m.lat * Math.PI / 180) * Math.cos(w.lat * Math.PI / 180) * Math.sin(S / 2) * Math.sin(S / 2), k = 6371 * (2 * Math.atan2(Math.sqrt(N), Math.sqrt(1 - N))) * (n === "DRIVING" ? 1.45 : 1.2) / (n === "DRIVING" ? 40 : 5);\n    return { text: `${Math.max(3, Math.round(k * 60))} \u5206\u9418`, isEstimated: !0, status: "\u9810\u4F30" };\n  }, D = async (m) => {\n    if (m.length < 2) return [];\n    const w = [], C = new window.google.maps.DirectionsService();\n    for (let M = 0; M < m.length - 1; M++)\n      try {\n        const S = await new Promise((O, F) => {\n          C.route({\n            origin: m[M],\n            destination: m[M + 1],\n            travelMode: n === "DRIVING" ? google.maps.TravelMode.DRIVING : google.maps.TravelMode.WALKING\n          }, (G, _) => {\n            _ === "OK" ? O(G) : F(_);\n          });\n        }), N = S.routes[0].legs[0];\n        w.push({\n          index: M,\n          duration: N.duration.text,\n          status: n === "DRIVING" ? "\u884C\u8ECA" : "\u6B65\u884C",\n          isEstimated: !1,\n          midpoint: N.steps[Math.floor(N.steps.length / 2)].end_location,\n          overview_path: S.routes[0].overview_path\n        });\n      } catch {\n        const N = P(m[M], m[M + 1]);\n        w.push({\n          index: M,\n          duration: N.text,\n          status: "\u9810\u4F30",\n          isEstimated: !0,\n          midpoint: { lat: (m[M].lat + m[M + 1].lat) / 2, lng: (m[M].lng + m[M + 1].lng) / 2 },\n          overview_path: [m[M], m[M + 1]]\n        });\n      }\n    return w;\n  }, R = async () => {\n    if (!l.current || !f) return;\n    b();\n    const { AdvancedMarkerElement: m, PinElement: w } = await window.google.maps.importLibrary("marker"), { Polyline: C } = await window.google.maps.importLibrary("maps"), M = new window.google.maps.LatLngBounds(), S = [];\n    t.forEach((N, O) => {\n      if (N.place.location) {\n        const F = new w({ background: "#2563eb", borderColor: "#ffffff", glyphColor: "#ffffff", glyphText: (O + 1).toString(), scale: 1.1 }), G = new m({ map: l.current, position: N.place.location, title: N.place.name, content: F.element });\n        G.addListener("click", () => T(N.place)), u.current.push(G), S.push(N.place.location), M.extend(N.place.location);\n      }\n    }), S.length > 1 ? D(S).then((N) => {\n      o && o(N.map((O) => O.duration)), N.forEach((O) => {\n        const F = new C({\n          path: O.overview_path,\n          geodesic: !0,\n          strokeColor: n === "DRIVING" ? "#2563eb" : "#10b981",\n          strokeOpacity: 0.6,\n          strokeWeight: 6,\n          map: l.current\n        });\n        d.current.push(F);\n        const G = document.createElement("div");\n        G.className = "pointer-events-none group";\n        const _ = n === "DRIVING" ? "blue" : "emerald";\n        G.innerHTML = `\n            <div class="bg-white/95 backdrop-blur-md px-4 py-2 rounded-2xl shadow-2xl border border-${_}-100 flex items-center gap-3 transform transition-all duration-500 hover:scale-110">\n              <div class="w-7 h-7 rounded-xl bg-${_}-600 flex items-center justify-center shadow-lg">\n                <i class="fas fa-${n === "DRIVING" ? "car-side" : "person-walking"} text-[10px] text-white"></i>\n              </div>\n              <div class="flex flex-col">\n                <span class="text-[12px] font-black text-slate-800 leading-none mb-0.5">${O.duration}</span>\n                <span class="text-[8px] font-black text-${_}-500 uppercase tracking-widest leading-none">${O.status}\u8DEF\u5F91</span>\n              </div>\n            </div>`;\n        const k = new m({ map: l.current, position: O.midpoint, content: G, zIndex: 200 });\n        c.current.push(k);\n      });\n    }) : o && o([]), S.length > 0 && !i && l.current.fitBounds(M, { padding: 140 });\n  };\n  return /* @__PURE__ */ p.jsxs("div", { className: "absolute inset-0 bg-slate-100 overflow-hidden", children: [\n    /* @__PURE__ */ p.jsx("div", { ref: a, className: "w-full h-full" }),\n    !f && /* @__PURE__ */ p.jsx("div", { className: "absolute inset-0 flex items-center justify-center bg-slate-50/90 backdrop-blur-xl z-50", children: /* @__PURE__ */ p.jsxs("div", { className: "flex flex-col items-center gap-6", children: [\n      /* @__PURE__ */ p.jsxs("div", { className: "relative w-16 h-16", children: [\n        /* @__PURE__ */ p.jsx("div", { className: "absolute inset-0 border-4 border-blue-100 rounded-full" }),\n        /* @__PURE__ */ p.jsx("div", { className: "absolute inset-0 border-4 border-blue-600 border-t-transparent rounded-full animate-spin" })\n      ] }),\n      /* @__PURE__ */ p.jsxs("div", { className: "text-center", children: [\n        /* @__PURE__ */ p.jsx("p", { className: "text-sm font-black text-slate-800 uppercase tracking-[0.3em] mb-1", children: "PENGHU AI MAP" }),\n        /* @__PURE__ */ p.jsx("p", { className: "text-[10px] text-slate-400 font-bold uppercase tracking-widest animate-pulse", children: "Initializing Smart Interface..." })\n      ] })\n    ] }) })\n  ] });\n}, hs = (t) => {\n  const [e, n] = t.split(":").map(Number);\n  return e * 60 + n;\n}, hm = (t) => {\n  const e = (t % 1440 + 1440) % 1440, n = Math.floor(e / 60), s = e % 60;\n  return `${n.toString().padStart(2, "0")}:${s.toString().padStart(2, "0")}`;\n}, gm = ({\n  initialItinerary: t,\n  userItineraries: e = [],\n  currentUser: n,\n  onSave: s\n}) => {\n  const [i, r] = L(""), [o, a] = L([]), [l, u] = L(!1), [c, d] = L(!1), [h, f] = L(0), [g, v] = L("DRIVING"), [y, x] = L(() => {\n    if (t && t.dayPlans)\n      return t.dayPlans.map((V, E) => {\n        if (V.date && (V.date.includes("\u7B2C") || V.date.includes("\u5929"))) {\n          const z = /* @__PURE__ */ new Date();\n          return z.setDate(z.getDate() + E), { ...V, date: z.toISOString().split("T")[0] };\n        }\n        return V;\n      });\n    const A = /* @__PURE__ */ new Date();\n    return [\n      { date: A.toISOString().split("T")[0], items: [] },\n      { date: new Date(A.getTime() + 1440 * 60 * 1e3).toISOString().split("T")[0], items: [] },\n      { date: new Date(A.getTime() + 2880 * 60 * 1e3).toISOString().split("T")[0], items: [] }\n    ];\n  }), [T, b] = L([]), [P, D] = L(null), [R, m] = L(), [w, C] = L("low"), [M, S] = L(\n    t?.id || null\n  ), [N, O] = L(!1), F = mt.useRef(null), [G, _] = L(!1), [k, U] = L([]), [H, tt] = L(!1), et = Jl(\n    Oi(Xs, { activationConstraint: { distance: 8 } }),\n    Oi(Gs, { coordinateGetter: Tu })\n  );\n  B(() => {\n    navigator.geolocation && navigator.geolocation.getCurrentPosition(\n      (A) => m({ lat: A.coords.latitude, lng: A.coords.longitude }),\n      () => console.warn("Location permission denied")\n    );\n  }, []), B(() => {\n    if (!(!s || !n))\n      return F.current && clearTimeout(F.current), F.current = setTimeout(async () => {\n        if (!N) {\n          O(!0);\n          try {\n            const A = {\n              title: `\u6F8E\u6E56\u884C\u7A0B ${(/* @__PURE__ */ new Date()).toLocaleDateString("zh-TW")}`,\n              dayPlans: y\n            };\n            M && (A.id = M);\n            const V = await s(A);\n            V && V.id && (S(V.id), typeof window < "u" && window.showToast && window.showToast("\u884C\u7A0B\u5DF2\u81EA\u52D5\u5132\u5B58", "success"));\n          } catch (A) {\n            console.error("[App] Auto-save failed:", A), typeof window < "u" && window.showToast && window.showToast("\u81EA\u52D5\u5132\u5B58\u5931\u6557\uFF0C\u8ACB\u7A0D\u5F8C\u518D\u8A66", "error");\n          } finally {\n            O(!1);\n          }\n        }\n      }, 3e3), () => {\n        F.current && clearTimeout(F.current);\n      };\n  }, [y, s, n, M, N]);\n  const X = async () => {\n    if (!i.trim()) return;\n    u(!0);\n    const A = await co.searchPlaces(i, R?.lat, R?.lng);\n    a(A), u(!1);\n  }, dt = async () => {\n    if (n) {\n      tt(!0);\n      try {\n        const A = await _t.getPersonalLocations();\n        if (A.success && A.data) {\n          const V = A.data.map((E) => ({\n            id: E.id,\n            name: E.name,\n            address: E.address,\n            location: E.latitude && E.longitude ? {\n              lat: E.latitude,\n              lng: E.longitude\n            } : void 0,\n            rating: E.google_rating,\n            userRatingCount: E.google_user_ratings_total,\n            phoneNumber: E.phone_number,\n            website: E.website,\n            types: typeof E.google_types == "string" ? JSON.parse(E.google_types) : E.google_types,\n            thumbnail: E.thumbnail_url,\n            google_place_id: E.google_place_id,\n            place_id: E.google_place_id,\n            latitude: E.latitude,\n            longitude: E.longitude,\n            lat: E.latitude,\n            lng: E.longitude,\n            google_rating: E.google_rating,\n            user_ratings_total: E.google_user_ratings_total\n          }));\n          U(V), _(!0);\n        }\n      } catch (A) {\n        console.error("[App] Error loading personal locations:", A), typeof window < "u" && window.showToast && window.showToast("\u8F09\u5165\u500B\u4EBA\u5730\u9EDE\u5931\u6557", "error");\n      } finally {\n        tt(!1);\n      }\n    }\n  }, xt = (A) => {\n    const V = y[h].items;\n    let E = "09:00";\n    if (V.length > 0) {\n      const z = V[V.length - 1], [Z, rt] = z.startTime.split(":").map(Number);\n      E = `${((Z + 1) % 24).toString().padStart(2, "0")}:${rt.toString().padStart(2, "0")}`;\n    }\n    return {\n      id: `item-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,\n      place: A,\n      startTime: E,\n      duration: 60\n    };\n  }, Ot = (A) => {\n    x((V) => {\n      const E = [...V], z = E[h].items;\n      return z.some((Z) => Z.place.id === A.id) ? V : (E[h].items = [...z, xt(A)], E);\n    }), a([]), r(""), D(null);\n  }, pt = (A) => {\n    x((V) => {\n      const E = [...V];\n      return E[h].items = E[h].items.filter((z) => z.id !== A), E;\n    });\n  }, ie = (A, V) => {\n    x((E) => {\n      const z = [...E], Z = [...z[h].items], rt = Z.findIndex((Nt) => Nt.id === A);\n      if (rt === -1) return E;\n      const ot = hs(Z[rt].startTime), Dt = hs(V) - ot;\n      for (let Nt = rt; Nt < Z.length; Nt++) {\n        const an = hs(Z[Nt].startTime);\n        Z[Nt] = {\n          ...Z[Nt],\n          startTime: Nt === rt ? V : hm(an + Dt)\n        };\n      }\n      return z[h].items = Z, z;\n    });\n  }, Ft = (A) => {\n    const { active: V, over: E } = A;\n    E && V.id !== E.id && x((z) => {\n      const Z = [...z], rt = Z[h].items, ot = rt.findIndex((Dt) => Dt.id === V.id), Vt = rt.findIndex((Dt) => Dt.id === E.id);\n      return Z[h].items = Ys(rt, ot, Vt), Z;\n    });\n  }, Et = () => {\n    const A = y.length + 1, V = y.length > 0 && y[0].date ? new Date(y[0].date) : /* @__PURE__ */ new Date();\n    if (y.length > 0 && y[0].date && !y[0].date.includes("\u7B2C")) {\n      const E = new Date(y[0].date);\n      E.setDate(E.getDate() + (A - 1)), x((z) => [...z, { date: E.toISOString().split("T")[0], items: [] }]);\n    } else {\n      const E = new Date(V);\n      E.setDate(E.getDate() + (A - 1)), x((z) => [...z, { date: E.toISOString().split("T")[0], items: [] }]);\n    }\n    f(y.length);\n  }, K = (A, V) => {\n    x((E) => {\n      const z = [...E];\n      return z[A] = { ...z[A], date: V }, z;\n    });\n  }, re = (A) => {\n    if (!A) return "\u672A\u8A2D\u5B9A\u65E5\u671F";\n    if (A.includes("\u7B2C") && A.includes("\u5929")) return A;\n    try {\n      const V = new Date(A);\n      if (isNaN(V.getTime())) return A;\n      const E = V.getFullYear(), z = String(V.getMonth() + 1).padStart(2, "0"), Z = String(V.getDate()).padStart(2, "0"), ot = ["\u65E5", "\u4E00", "\u4E8C", "\u4E09", "\u56DB", "\u4E94", "\u516D"][V.getDay()];\n      return `${E}/${z}/${Z} (${ot})`;\n    } catch {\n      return A;\n    }\n  }, St = async () => {\n    const A = y[h].items;\n    if (A.length < 2) return;\n    d(!0);\n    const V = await co.optimizeDayPlan(A.map((E) => E.place));\n    V && V.itinerary && x((E) => {\n      const z = [...E], Z = [...z[h].items], rt = V.itinerary.map((ot) => {\n        const Vt = Z.find((Dt) => Dt.place.name === ot.placeName);\n        return Vt ? { ...Vt, startTime: ot.recommendedTime || Vt.startTime } : null;\n      }).filter(Boolean);\n      return rt.length > 0 && (z[h].items = rt), z;\n    }), d(!1);\n  }, Xt = () => {\n    D(null), a([]);\n  };\n  return /* @__PURE__ */ p.jsxs("div", { className: "flex flex-col lg:flex-row h-[100dvh] w-full bg-slate-50 overflow-hidden font-sans relative", children: [\n    N && /* @__PURE__ */ p.jsxs("div", { className: "fixed top-4 left-1/2 -translate-x-1/2 z-50 bg-blue-600 text-white px-4 py-2 rounded-full shadow-lg flex items-center gap-2 animate-pulse", children: [\n      /* @__PURE__ */ p.jsx("i", { className: "fas fa-spinner fa-spin text-sm" }),\n      /* @__PURE__ */ p.jsx("span", { className: "text-sm font-bold", children: "\u6B63\u5728\u5132\u5B58..." })\n    ] }),\n    /* @__PURE__ */ p.jsxs("aside", { className: "hidden lg:flex flex-col w-[30%] xl:w-[28%] bg-white border-r border-slate-100 shadow-2xl z-20 relative", children: [\n      /* @__PURE__ */ p.jsxs("div", { className: "p-6 xl:p-8 pb-4", children: [\n        /* @__PURE__ */ p.jsxs("div", { className: "flex items-center justify-between mb-8", children: [\n          /* @__PURE__ */ p.jsx("h1", { className: "text-2xl xl:text-3xl font-black text-blue-600 tracking-tighter leading-none", children: "\u884C\u7A0B\u898F\u5283" }),\n          /* @__PURE__ */ p.jsxs("div", { className: "flex items-center gap-1.5 overflow-x-auto no-scrollbar", children: [\n            y.map((A, V) => /* @__PURE__ */ p.jsxs("button", { onClick: () => {\n              f(V), b([]);\n            }, className: `px-4 py-2 rounded-full text-[11px] font-black transition-all duration-300 ${h === V ? "bg-blue-600 text-white shadow-xl shadow-blue-200" : "bg-slate-50 text-slate-400 hover:bg-slate-100"}`, children: [\n              "D",\n              V + 1\n            ] }, V)),\n            /* @__PURE__ */ p.jsx("button", { onClick: Et, className: "w-10 h-10 rounded-full bg-blue-50 text-blue-600 hover:bg-blue-600 hover:text-white transition-all flex items-center justify-center flex-shrink-0 shadow-sm", children: /* @__PURE__ */ p.jsx("i", { className: "fas fa-plus text-[10px]" }) })\n          ] })\n        ] }),\n        /* @__PURE__ */ p.jsxs("div", { className: "flex bg-slate-100 p-1.5 rounded-2xl mb-6", children: [\n          /* @__PURE__ */ p.jsxs("button", { onClick: () => v("DRIVING"), className: `flex-1 flex items-center justify-center gap-2 py-3 rounded-xl text-[11px] font-black transition-all ${g === "DRIVING" ? "bg-white text-blue-600 shadow-md" : "text-slate-400"}`, children: [\n            /* @__PURE__ */ p.jsx("i", { className: "fas fa-car-side" }),\n            " \u884C\u8ECA"\n          ] }),\n          /* @__PURE__ */ p.jsxs("button", { onClick: () => v("WALKING"), className: `flex-1 flex items-center justify-center gap-2 py-3 rounded-xl text-[11px] font-black transition-all ${g === "WALKING" ? "bg-white text-emerald-600 shadow-md" : "text-slate-400"}`, children: [\n            /* @__PURE__ */ p.jsx("i", { className: "fas fa-person-walking" }),\n            " \u6B65\u884C"\n          ] })\n        ] })\n      ] }),\n      /* @__PURE__ */ p.jsxs("div", { className: "flex-1 overflow-y-auto overflow-x-visible px-4 xl:px-8 py-4 custom-scrollbar bg-[#fdfdfe] relative", children: [\n        /* @__PURE__ */ p.jsxs("div", { className: "flex items-center justify-between mb-8 px-2", children: [\n          /* @__PURE__ */ p.jsxs("div", { className: "flex items-center gap-3", children: [\n            /* @__PURE__ */ p.jsxs("h2", { className: "text-[12px] font-black text-slate-400 uppercase tracking-[0.4em] whitespace-nowrap", children: [\n              re(y[h].date),\n              " \u884C\u7A0B\u898F\u5283"\n            ] }),\n            /* @__PURE__ */ p.jsx(\n              "input",\n              {\n                type: "date",\n                value: y[h].date.includes("\u7B2C") ? "" : y[h].date,\n                onChange: (A) => K(h, A.target.value),\n                className: "text-[10px] px-2 py-1 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent",\n                title: "\u9078\u64C7\u65E5\u671F"\n              }\n            )\n          ] }),\n          /* @__PURE__ */ p.jsx("div", { className: "h-[1px] flex-1 bg-slate-100 ml-4" })\n        ] }),\n        /* @__PURE__ */ p.jsx("div", { className: "w-full relative", children: y[h].items.length === 0 ? /* @__PURE__ */ p.jsxs("div", { className: "py-24 text-center border-2 border-dashed border-slate-100 rounded-[3.5rem] bg-white", children: [\n          /* @__PURE__ */ p.jsx("i", { className: "fas fa-map-location-dot text-slate-200 text-4xl mb-4" }),\n          /* @__PURE__ */ p.jsx("p", { className: "text-[12px] font-black text-slate-300 uppercase tracking-widest px-8", children: "\u641C\u5C0B\u666F\u9EDE\u958B\u59CB\u4F60\u7684\u6F8E\u6E56\u5192\u96AA" })\n        ] }) : /* @__PURE__ */ p.jsx(Qc, { sensors: et, collisionDetection: Ql, onDragEnd: Ft, children: /* @__PURE__ */ p.jsx(hu, { items: y[h].items.map((A) => A.id), strategy: uu, children: /* @__PURE__ */ p.jsx("div", { className: "space-y-0 w-full relative", children: y[h].items.map((A, V) => /* @__PURE__ */ p.jsx(ho, { item: A, onRemove: pt, onTimeUpdate: ie, onClick: () => D({ ...A.place }), isLast: V === y[h].items.length - 1, travelTimeToNext: T[V], travelMode: g, nextPlace: y[h].items[V + 1]?.place }, A.id)) }) }) }) })\n      ] }),\n      /* @__PURE__ */ p.jsx("div", { className: "p-8 bg-white border-t border-slate-50 relative z-30", children: /* @__PURE__ */ p.jsxs("button", { onClick: St, disabled: y[h].items.length < 2 || c, className: "w-full py-5 bg-slate-900 text-white rounded-[2rem] font-black text-xs uppercase tracking-widest shadow-2xl hover:bg-blue-600 transition-all flex items-center justify-center gap-3 active:scale-[0.97] disabled:opacity-30", children: [\n        c ? /* @__PURE__ */ p.jsx("i", { className: "fas fa-spinner fa-spin" }) : /* @__PURE__ */ p.jsx("i", { className: "fas fa-magic" }),\n        " AI \u667A\u6167\u512A\u5316\u6392\u5E8F"\n      ] }) })\n    ] }),\n    /* @__PURE__ */ p.jsxs("main", { className: "flex-1 relative bg-slate-100 overflow-hidden h-full", children: [\n      /* @__PURE__ */ p.jsxs("div", { className: "absolute top-8 left-1/2 -translate-x-1/2 w-[90%] lg:w-[540px] z-30", children: [\n        /* @__PURE__ */ p.jsxs("div", { className: "bg-white/95 backdrop-blur-3xl rounded-[2.5rem] shadow-[0_30px_80px_rgba(0,0,0,0.15)] border border-white p-2 flex items-center gap-4 transition-all focus-within:ring-4 focus-within:ring-blue-500/10", children: [\n          /* @__PURE__ */ p.jsx("div", { className: "w-14 h-14 rounded-3xl bg-gradient-to-br from-blue-600 to-indigo-700 text-white flex items-center justify-center flex-shrink-0 shadow-lg shadow-blue-200", children: /* @__PURE__ */ p.jsx("i", { className: "fas fa-search text-lg" }) }),\n          /* @__PURE__ */ p.jsx("input", { type: "text", placeholder: "\u641C\u5C0B\u6F8E\u6E56\u79D8\u5883\u3001\u7F8E\u98DF...", className: "flex-1 bg-transparent border-none outline-none text-base font-bold text-slate-700 placeholder:text-slate-400", value: i, onChange: (A) => r(A.target.value), onKeyDown: (A) => A.key === "Enter" && X() }),\n          /* @__PURE__ */ p.jsx(\n            "button",\n            {\n              onClick: dt,\n              disabled: H || !n,\n              className: "w-14 h-14 rounded-3xl bg-gradient-to-br from-emerald-500 to-teal-600 text-white flex items-center justify-center flex-shrink-0 shadow-lg shadow-emerald-200 hover:shadow-emerald-300 transition-all disabled:opacity-50",\n              title: "\u6211\u7684\u5730\u9EDE\u6536\u85CF",\n              children: H ? /* @__PURE__ */ p.jsx("i", { className: "fas fa-spinner fa-spin text-lg" }) : /* @__PURE__ */ p.jsx("i", { className: "fas fa-bookmark text-lg" })\n            }\n          )\n        ] }),\n        /* @__PURE__ */ p.jsxs(Ah, { children: [\n          o.length > 0 && /* @__PURE__ */ p.jsx(as.div, { initial: { opacity: 0, y: 15 }, animate: { opacity: 1, y: 0 }, exit: { opacity: 0, y: 15 }, className: "absolute top-full mt-5 w-full bg-white/95 rounded-[2.5rem] shadow-2xl border border-white overflow-hidden max-h-[50vh] flex flex-col p-4 gap-2", children: o.map((A) => /* @__PURE__ */ p.jsx(uo, { place: A, onClick: () => {\n            D({ ...A }), a([]), window.innerWidth < 1024 && C("low");\n          } }, A.id)) }),\n          G && k.length > 0 && /* @__PURE__ */ p.jsxs(as.div, { initial: { opacity: 0, y: 15 }, animate: { opacity: 1, y: 0 }, exit: { opacity: 0, y: 15 }, className: "absolute top-full mt-5 w-full bg-white/95 rounded-[2.5rem] shadow-2xl border border-white overflow-hidden max-h-[50vh] flex flex-col", children: [\n            /* @__PURE__ */ p.jsxs("div", { className: "p-4 border-b border-slate-100 flex items-center justify-between", children: [\n              /* @__PURE__ */ p.jsxs("h3", { className: "text-sm font-black text-slate-700", children: [\n                "\u6211\u7684\u5730\u9EDE\u6536\u85CF (",\n                k.length,\n                ")"\n              ] }),\n              /* @__PURE__ */ p.jsx(\n                "button",\n                {\n                  onClick: () => {\n                    _(!1), U([]);\n                  },\n                  className: "w-8 h-8 rounded-full bg-slate-100 text-slate-400 hover:bg-slate-200 flex items-center justify-center transition-all",\n                  children: /* @__PURE__ */ p.jsx("i", { className: "fas fa-times text-xs" })\n                }\n              )\n            ] }),\n            /* @__PURE__ */ p.jsx("div", { className: "overflow-y-auto max-h-[calc(50vh-60px)] p-4 gap-2 flex flex-col", children: k.map((A) => /* @__PURE__ */ p.jsx(uo, { place: A, onClick: () => {\n              Ot(A), _(!1), U([]), typeof window < "u" && window.showToast && window.showToast("\u5DF2\u52A0\u5165\u884C\u7A0B", "success");\n            } }, A.id)) })\n          ] })\n        ] })\n      ] }),\n      /* @__PURE__ */ p.jsx("div", { className: "w-full h-full", children: /* @__PURE__ */ p.jsx(dm, { items: y[h].items, center: R, travelMode: g, onAddPlaceFromMap: Ot, selectedPlace: P, onInfoWindowClose: Xt, onTravelDataUpdate: (A) => b(A) }) }),\n      /* @__PURE__ */ p.jsxs(as.div, { className: "lg:hidden fixed bottom-0 left-0 right-0 bg-white rounded-t-[3.5rem] shadow-2xl z-40 overflow-hidden flex flex-col", animate: { height: w === "high" ? "85%" : "25%" }, transition: { type: "spring", damping: 25 }, children: [\n        /* @__PURE__ */ p.jsx("div", { className: "w-full h-12 flex flex-col items-center justify-center cursor-pointer", onClick: () => C(w === "low" ? "high" : "low"), children: /* @__PURE__ */ p.jsx("div", { className: "w-14 h-1.5 bg-slate-100 rounded-full" }) }),\n        /* @__PURE__ */ p.jsxs("div", { className: "flex-1 overflow-y-auto px-6 pb-28 custom-scrollbar", children: [\n          /* @__PURE__ */ p.jsxs("div", { className: "flex items-center justify-between mb-8 px-2", children: [\n            /* @__PURE__ */ p.jsx("h2", { className: "text-2xl font-black text-slate-900", children: y[h].date }),\n            /* @__PURE__ */ p.jsx("div", { className: "flex gap-2", children: y.map((A, V) => /* @__PURE__ */ p.jsxs("button", { onClick: () => {\n              f(V), b([]);\n            }, className: `w-11 h-11 rounded-full text-[11px] font-black ${h === V ? "bg-blue-600 text-white shadow-lg shadow-blue-200" : "bg-slate-100 text-slate-400"}`, children: [\n              "D",\n              V + 1\n            ] }, V)) })\n          ] }),\n          /* @__PURE__ */ p.jsx("div", { className: "space-y-0 w-full relative", children: y[h].items.map((A, V) => /* @__PURE__ */ p.jsx(ho, { item: A, onRemove: pt, onTimeUpdate: ie, onClick: () => {\n            D({ ...A.place }), C("low");\n          }, isLast: V === y[h].items.length - 1, travelTimeToNext: T[V], travelMode: g, nextPlace: y[h].items[V + 1]?.place }, A.id)) })\n        ] })\n      ] })\n    ] }),\n    /* @__PURE__ */ p.jsx("style", { children: `\n        .custom-scrollbar::-webkit-scrollbar { width: 4px; }\n        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }\n        .no-scrollbar::-webkit-scrollbar { display: none; }\n      ` })\n  ] });\n};\nexport {\n  gm as App,\n  gm as default\n};\n',
      "styles/design-tokens.css": "/**\n * Design Tokens - \u7D71\u4E00\u8A2D\u8A08\u7CFB\u7D71\n * \u7528\u65BC\u78BA\u4FDD\u524D\u7AEF\u548C\u5F8C\u7AEF UI \u7684\u4E00\u81F4\u6027\n */\n\n:root {\n  /* \u8272\u5F69\u7CFB\u7D71 */\n  --color-primary: #2563eb;\n  --color-primary-light: #3b82f6;\n  --color-primary-dark: #1d4ed8;\n  --color-secondary: #10b981;\n  --color-accent: #8b5cf6;\n  \n  /* \u4E2D\u6027\u8272 */\n  --color-gray-50: #f9fafb;\n  --color-gray-100: #f3f4f6;\n  --color-gray-200: #e5e7eb;\n  --color-gray-300: #d1d5db;\n  --color-gray-400: #9ca3af;\n  --color-gray-500: #6b7280;\n  --color-gray-600: #4b5563;\n  --color-gray-700: #374151;\n  --color-gray-800: #1f2937;\n  --color-gray-900: #111827;\n  \n  /* \u8A9E\u7FA9\u8272\u5F69 */\n  --color-success: #10b981;\n  --color-error: #ef4444;\n  --color-warning: #f59e0b;\n  --color-info: #3b82f6;\n  \n  /* \u9593\u8DDD\u7CFB\u7D71 */\n  --spacing-xs: 0.25rem;   /* 4px */\n  --spacing-sm: 0.5rem;    /* 8px */\n  --spacing-md: 1rem;      /* 16px */\n  --spacing-lg: 1.5rem;    /* 24px */\n  --spacing-xl: 2rem;      /* 32px */\n  --spacing-2xl: 3rem;     /* 48px */\n  --spacing-3xl: 4rem;     /* 64px */\n  \n  /* \u5713\u89D2\u7CFB\u7D71 */\n  --radius-sm: 0.375rem;   /* 6px */\n  --radius-md: 0.5rem;     /* 8px */\n  --radius-lg: 0.75rem;    /* 12px */\n  --radius-xl: 1rem;      /* 16px */\n  --radius-2xl: 1.5rem;    /* 24px */\n  --radius-3xl: 2rem;      /* 32px */\n  --radius-full: 9999px;\n  \n  /* \u9670\u5F71\u7CFB\u7D71 */\n  --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);\n  --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);\n  --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);\n  --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);\n  --shadow-2xl: 0 25px 50px -12px rgba(0, 0, 0, 0.25);\n  \n  /* \u5B57\u9AD4\u7CFB\u7D71 */\n  --font-sans: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Noto Sans TC', 'Roboto', 'Helvetica Neue', Arial, sans-serif;\n  --font-mono: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, 'Courier New', monospace;\n  \n  /* \u5B57\u9AD4\u5927\u5C0F */\n  --text-xs: 0.75rem;      /* 12px */\n  --text-sm: 0.875rem;     /* 14px */\n  --text-base: 1rem;       /* 16px */\n  --text-lg: 1.125rem;     /* 18px */\n  --text-xl: 1.25rem;     /* 20px */\n  --text-2xl: 1.5rem;      /* 24px */\n  --text-3xl: 1.875rem;    /* 30px */\n  --text-4xl: 2.25rem;     /* 36px */\n  \n  /* \u5B57\u9AD4\u7C97\u7D30 */\n  --font-light: 300;\n  --font-normal: 400;\n  --font-medium: 500;\n  --font-semibold: 600;\n  --font-bold: 700;\n  --font-black: 900;\n  \n  /* \u52D5\u756B\u6642\u9593 */\n  --duration-fast: 150ms;\n  --duration-normal: 300ms;\n  --duration-slow: 500ms;\n  \n  /* \u52D5\u756B\u7DE9\u52D5 */\n  --ease-in: cubic-bezier(0.4, 0, 1, 1);\n  --ease-out: cubic-bezier(0, 0, 0.2, 1);\n  --ease-in-out: cubic-bezier(0.4, 0, 0.2, 1);\n  \n  /* Z-index \u5C64\u7D1A */\n  --z-base: 0;\n  --z-dropdown: 1000;\n  --z-sticky: 1020;\n  --z-fixed: 1030;\n  --z-modal-backdrop: 1040;\n  --z-modal: 1050;\n  --z-popover: 1060;\n  --z-tooltip: 1070;\n}\n\n/* \u6DF1\u8272\u6A21\u5F0F\u652F\u63F4\uFF08\u672A\u4F86\u64F4\u5C55\uFF09 */\n@media (prefers-color-scheme: dark) {\n  :root {\n    --color-gray-50: #111827;\n    --color-gray-100: #1f2937;\n    --color-gray-200: #374151;\n    --color-gray-300: #4b5563;\n    --color-gray-400: #6b7280;\n    --color-gray-500: #9ca3af;\n    --color-gray-600: #d1d5db;\n    --color-gray-700: #e5e7eb;\n    --color-gray-800: #f3f4f6;\n    --color-gray-900: #f9fafb;\n  }\n}\n\n",
      "styles/responsive.css": '/**\n * Responsive Design Utilities\n * \u97FF\u61C9\u5F0F\u8A2D\u8A08\u8F14\u52A9\u985E\u5225\u548C\u65B7\u9EDE\n */\n\n/* \u65B7\u9EDE\u5B9A\u7FA9 */\n/* sm: 640px, md: 768px, lg: 1024px, xl: 1280px, 2xl: 1536px */\n\n/* \u89F8\u63A7\u512A\u5316 */\n@media (hover: none) and (pointer: coarse) {\n  /* \u884C\u52D5\u88DD\u7F6E\u89F8\u63A7\u512A\u5316 */\n  button, a, [role="button"] {\n    min-height: 44px;\n    min-width: 44px;\n  }\n  \n  /* \u589E\u52A0\u9EDE\u64CA\u76EE\u6A19\u5927\u5C0F */\n  .touch-target {\n    min-height: 44px;\n    min-width: 44px;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n  }\n}\n\n/* \u5E73\u677F\u512A\u5316 */\n@media (min-width: 768px) and (max-width: 1023px) {\n  /* \u5E73\u677F\u7279\u5B9A\u6A23\u5F0F */\n  .tablet-optimized {\n    padding: 1.5rem;\n  }\n}\n\n/* \u884C\u52D5\u88DD\u7F6E\u512A\u5316 */\n@media (max-width: 767px) {\n  /* \u96B1\u85CF\u684C\u9762\u5C08\u7528\u5143\u7D20 */\n  .desktop-only {\n    display: none !important;\n  }\n  \n  /* \u884C\u52D5\u88DD\u7F6E\u5C08\u7528\u9593\u8DDD */\n  .mobile-spacing {\n    padding: 1rem;\n  }\n  \n  /* \u884C\u52D5\u88DD\u7F6E\u5B57\u9AD4\u5927\u5C0F\u8ABF\u6574 */\n  .mobile-text {\n    font-size: 0.875rem;\n  }\n  \n  /* \u884C\u52D5\u88DD\u7F6E\u6309\u9215\u5168\u5BEC */\n  .mobile-full-width {\n    width: 100%;\n  }\n}\n\n/* \u684C\u9762\u512A\u5316 */\n@media (min-width: 1024px) {\n  /* \u96B1\u85CF\u884C\u52D5\u88DD\u7F6E\u5C08\u7528\u5143\u7D20 */\n  .mobile-only {\n    display: none !important;\n  }\n  \n  /* \u684C\u9762\u5C08\u7528\u9593\u8DDD */\n  .desktop-spacing {\n    padding: 2rem;\n  }\n}\n\n/* \u5927\u87A2\u5E55\u512A\u5316 */\n@media (min-width: 1536px) {\n  /* \u9650\u5236\u6700\u5927\u5BEC\u5EA6\u4EE5\u4FDD\u6301\u53EF\u8B80\u6027 */\n  .container-xl {\n    max-width: 1400px;\n    margin: 0 auto;\n  }\n}\n\n/* \u6A6B\u5411\u6A21\u5F0F\u512A\u5316 */\n@media (orientation: landscape) and (max-height: 500px) {\n  /* \u6A6B\u5411\u6A21\u5F0F\u4E0B\u7684\u7279\u6B8A\u8655\u7406 */\n  .landscape-compact {\n    padding: 0.5rem;\n  }\n}\n\n/* \u9AD8\u89E3\u6790\u5EA6\u87A2\u5E55\u512A\u5316 */\n@media (-webkit-min-device-pixel-ratio: 2), (min-resolution: 192dpi) {\n  /* \u9AD8\u89E3\u6790\u5EA6\u87A2\u5E55\u7684\u908A\u6846\u548C\u9670\u5F71\u8ABF\u6574 */\n  .retina-border {\n    border-width: 0.5px;\n  }\n}\n\n/* \u53EF\u8A2A\u554F\u6027\u512A\u5316 */\n@media (prefers-reduced-motion: reduce) {\n  *,\n  *::before,\n  *::after {\n    animation-duration: 0.01ms !important;\n    animation-iteration-count: 1 !important;\n    transition-duration: 0.01ms !important;\n  }\n}\n\n/* \u5217\u5370\u6A23\u5F0F */\n@media print {\n  .no-print {\n    display: none !important;\n  }\n  \n  .print-break {\n    page-break-after: always;\n  }\n}\n\n'
    };
  }
});

// src/worker.js
init_AuthService();
init_UserService();
init_SessionService();
init_GoogleAuthService();
init_LocationService();
init_LocationInvitationService();
init_AIService();
init_BusinessVerificationService();

// src/templates/business-verification.html.js
function businessVerificationPage(user, message = "", placesForDropdown = []) {
  const loggedIn = user && user.email;
  return `
        <style>
            body {
                font-family: sans-serif;
                margin: 20px;
                background-color: #f4f4f4;
            }
            .container {
                background-color: #fff;
                padding: 20px;
                border-radius: 8px;
                box-shadow: 0 0 10px rgba(0,0,0,0.1);
                max-width: 700px;
                margin: auto;
            }
            h1, h2 {
                color: #333;
            }
            .form-section {
                margin-bottom: 30px;
                padding: 15px;
                border: 1px solid #ddd;
                border-radius: 5px;
            }
            label {
                display: block;
                margin-bottom: 5px;
                font-weight: bold;
            }
            input[type="text"], input[type="email"], select {
                width: calc(100% - 22px);
                padding: 10px;
                margin-bottom: 10px;
                border: 1px solid #ccc;
                border-radius: 4px;
            }
            button {
                background-color: #007bff;
                color: white;
                padding: 10px 15px;
                border: none;
                border-radius: 4px;
                cursor: pointer;
                font-size: 16px;
            }
            button:hover {
                background-color: #0056b3;
            }
            .message {
                padding: 10px;
                margin-bottom: 15px;
                border-radius: 4px;
                color: #fff;
            }
            .message.success {
                background-color: #28a745;
            }
            .message.error {
                background-color: #dc3545;
            }
            .user-info {
                margin-bottom: 20px;
                padding: 10px;
                background-color: #e9ecef;
                border-radius: 4px;
            }
        </style>
        <div class="container">
            <h1>\u5546\u5BB6\u9A57\u8B49\u6E2C\u8A66\u9801\u9762</h1>

            ${loggedIn ? `
                <div class="user-info">
                    \u5DF2\u767B\u5165\uFF1A${user.name} (${user.email})
                    <form action="/api/auth/logout" method="post" style="display: inline; margin-left: 10px;">
                        <button type="submit">\u767B\u51FA</button>
                    </form>
                </div>
            ` : `
                <div class="user-info">
                    \u5C1A\u672A\u767B\u5165\u3002
                    <form action="/api/auth/google" method="post" style="display: inline; margin-left: 10px;">
                        <button type="submit">\u4F7F\u7528 Google \u767B\u5165</button>
                    </form>
                </div>
            `}

            ${message ? `<div class="message ${message.type === "success" ? "success" : "error"}">${message.text}</div>` : ""}

            <div class="form-section">
                <h2>\u7DB2\u7AD9\u7BA1\u7406\u8005\uFF1A\u767C\u8D77\u9A57\u8B49</h2>
                <form id="adminInitiateForm" method="POST" action="/test/business-verification/admin-initiate">
                    <label for="adminPlaceId">\u9078\u64C7 Google \u5730\u6A19:</label>
                    ${placesForDropdown && placesForDropdown.length > 0 ? `
                        <select id="adminPlaceId" name="placeId" required class="w-full p-2 mb-2 border border-gray-300 rounded-md">
                            <option value="" disabled selected>-- \u8ACB\u9078\u64C7\u4E00\u500B\u5730\u6A19 --</option>
                            ${placesForDropdown.map((place) => `
                                <option value="${place.google_place_id}">${place.name} (ID: ${place.google_place_id ? place.google_place_id.substring(0, 10) : "N/A"}...)</option>
                            `).join("")}
                        </select>
                    ` : `
                        <p class="text-gray-500 mb-2">\u76EE\u524D\u6C92\u6709\u5DF2\u540C\u6B65\u7684 Google \u5730\u6A19\u53EF\u4F9B\u9078\u64C7\u3002\u8ACB\u5148\u900F\u904E\u300C\u65B0\u589E\u5730\u9EDE\u300D\u529F\u80FD\u52A0\u5165\u3002</p>
                        <input type="text" id="adminPlaceId_fallback" name="placeId" placeholder="\u6216\u624B\u52D5\u8F38\u5165 Place ID (\u5982\u679C\u5217\u8868\u70BA\u7A7A)" class="w-full p-2 mb-2 border border-gray-300 rounded-md">
                    `}
                    <button type="submit">\u7BA1\u7406\u8005\u767C\u8D77</button>
                </form>
            </div>

            <div class="form-section">
                <h2>Google \u767B\u5165\u4F7F\u7528\u8005\uFF1A\u7533\u8ACB\u9A57\u8B49</h2>
                ${loggedIn ? `
                    <form id="userRequestForm" method="POST" action="/test/business-verification/user-request">
                        <label for="userPlaceId">\u60A8\u7684 Google \u5730\u6A19 Place ID:</label>
                        <input type="text" id="userPlaceId" name="placeId" required>
                        <button type="submit">\u6211\u64C1\u6709\u6B64\u5730\u6A19\uFF0C\u7533\u8ACB\u9A57\u8B49</button>
                    </form>
                ` : `
                    <p>\u8ACB\u5148\u767B\u5165\u4EE5\u7533\u8ACB\u9A57\u8B49\u60A8\u7684\u5546\u5BB6\u5730\u6A19\u3002</p>
                `}
            </div>

            <div id="apiResponseArea" style="margin-top: 20px; padding:10px; border: 1px solid #eee; background: #f9f9f9; border-radius: 4px; white-space: pre-wrap;">
                API \u56DE\u61C9\u5C07\u986F\u793A\u65BC\u6B64...
            </div>
        </div>

        <script>
            async function handleFormSubmit(event) {
                event.preventDefault();
                const form = event.target;
                const formData = new FormData(form);
                const responseArea = document.getElementById('apiResponseArea');
                responseArea.textContent = '\u8655\u7406\u4E2D...';

                try {
                    const response = await fetch(form.action, {
                        method: 'POST',
                        body: formData
                    });
                    const result = await response.json();
                    responseArea.textContent = JSON.stringify(result, null, 2);
                    
                    if (result.flashMessage) {
                         const messageDiv = document.createElement('div');
                         messageDiv.className = 'message ' + (result.flashMessage.type || 'success');
                         messageDiv.textContent = result.flashMessage.text;
                         document.querySelector('.container').insertBefore(messageDiv, document.querySelector('.form-section'));
                    }

                } catch (error) {
                    console.error('Form submission error:', error);
                    responseArea.textContent = '\u767C\u751F\u932F\u8AA4\uFF1A' + error.message;
                }
            }

            document.addEventListener('DOMContentLoaded', () => {
                const adminForm = document.getElementById('adminInitiateForm');
                if (adminForm) adminForm.addEventListener('submit', handleFormSubmit);

                const userForm = document.getElementById('userRequestForm');
                if (userForm) userForm.addEventListener('submit', handleFormSubmit);
            });
        </script>
    `;
}

// src/routes/business-verification.js
init_BusinessVerificationService();
init_SessionService();
init_UserService();
init_LocationService();
function getCookie(request, name) {
  const cookieHeader = request.headers.get("cookie");
  if (!cookieHeader)
    return null;
  const cookies = cookieHeader.split(";");
  for (let cookie of cookies) {
    const [cookieName, cookieValue] = cookie.trim().split("=");
    if (cookieName === name) {
      return decodeURIComponent(cookieValue);
    }
  }
  return null;
}
async function getUser(request, env) {
  const sessionId = getCookie(request, "session");
  if (!sessionId)
    return null;
  const sessionService = new SessionService(env.DB);
  const userService = new UserService(env.DB);
  const session = await sessionService.getSession(sessionId);
  if (!session)
    return null;
  return await userService.findUserById(session.userId);
}
async function showBusinessVerificationPage(request, env, ctx) {
  const user = await getUser(request, env);
  let placesForDropdown = [];
  try {
    const locationService = new LocationService(env.DB, env.GOOGLE_MAPS_API_KEY);
    placesForDropdown = await locationService.getActiveGooglePlaceIds();
  } catch (error) {
    console.error("Error fetching places for dropdown:", error);
  }
  return new Response(businessVerificationPage(user, null, placesForDropdown), { headers: { "Content-Type": "text/html;charset=UTF-8" } });
}
async function handleAdminInitiate(request, env, ctx) {
  var _a;
  const user = await getUser(request, env);
  try {
    const formData = await request.formData();
    const placeId = formData.get("placeId");
    if (!placeId) {
      return new Response(JSON.stringify({ success: false, message: "Place ID is required." }), { status: 400, headers: { "Content-Type": "application/json" } });
    }
    const verificationService = ((_a = env.services) == null ? void 0 : _a.businessVerification) || new BusinessVerificationService(env.DB);
    const result = await verificationService.adminInitiateForPlaceId(placeId, user);
    return new Response(JSON.stringify(result), { headers: { "Content-Type": "application/json" } });
  } catch (error) {
    console.error("Admin initiate error:", error);
    return new Response(JSON.stringify({ success: false, message: "An error occurred.", error: error.message }), { status: 500, headers: { "Content-Type": "application/json" } });
  }
}
async function handleUserRequestVerification(request, env, ctx) {
  var _a;
  const user = await getUser(request, env);
  if (!user) {
    return new Response(JSON.stringify({ success: false, message: "User not logged in." }), { status: 401, headers: { "Content-Type": "application/json" } });
  }
  try {
    const formData = await request.formData();
    const placeId = formData.get("placeId");
    if (!placeId) {
      return new Response(JSON.stringify({ success: false, message: "Place ID is required." }), { status: 400, headers: { "Content-Type": "application/json" } });
    }
    const verificationService = ((_a = env.services) == null ? void 0 : _a.businessVerification) || new BusinessVerificationService(env.DB);
    const result = await verificationService.userRequestVerificationForPlaceId(placeId, user);
    return new Response(JSON.stringify(result), { headers: { "Content-Type": "application/json" } });
  } catch (error) {
    console.error("User request verification error:", error);
    return new Response(JSON.stringify({ success: false, message: "An error occurred.", error: error.message }), { status: 500, headers: { "Content-Type": "application/json" } });
  }
}

// src/pages/AdminKnowledgePage.js
init_layout();
init_auth();
async function renderAdminKnowledgePage(request, env, session, user, nonce, cssContent) {
  const authCheck = requireAdmin(user, request);
  if (authCheck)
    return authCheck;
  const content = `
    <div class="min-h-screen bg-gray-50 py-8">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <!-- Header -->
        <div class="mb-8 flex justify-between items-center">
          <div>
            <h1 class="text-3xl font-bold text-gray-900">\u6F8E\u6E56\u77E5\u8B58\u5EAB\u5BE9\u6838</h1>
            <p class="mt-2 text-sm text-gray-600">\u5BE9\u6838\u4F7F\u7528\u8005\u8CA2\u737B\u7684\u79C1\u623F\u666F\u9EDE\u8207\u6545\u4E8B\uFF0C\u8C50\u5BCC AI \u7684\u9577\u671F\u8A18\u61B6\u3002</p>
          </div>
          <div class="flex space-x-3">
             <a href="/admin/verifications" class="text-gray-600 hover:text-gray-900 px-3 py-2 rounded-md text-sm font-medium">
               \u8FD4\u56DE\u5546\u5BB6\u9A57\u8B49
             </a>
          </div>
        </div>

        <!-- Stats Card -->
        <div class="bg-white overflow-hidden shadow rounded-lg mb-8">
          <div class="px-4 py-5 sm:p-6">
            <dt class="text-sm font-medium text-gray-500 truncate">\u5F85\u5BE9\u6838\u9805\u76EE</dt>
            <dd class="mt-1 text-3xl font-semibold text-indigo-600" id="pending-count">-</dd>
          </div>
        </div>

        <!-- Pending List -->
        <div class="bg-white shadow overflow-hidden sm:rounded-md">
          <ul id="knowledge-list" class="divide-y divide-gray-200">
            <li class="p-6 text-center text-gray-500">\u8F09\u5165\u4E2D...</li>
          </ul>
        </div>
        
        <!-- Pagination -->
        <div class="mt-4 flex justify-between items-center" id="pagination-controls">
           <!-- Added dynamically -->
        </div>

      </div>
    </div>

    <script nonce="${nonce}">
      let currentOffset = 0;
      const limit = 20;

      async function fetchPendingKnowledge() {
        try {
          const response = await fetch(\`/api/admin/knowledge/pending?limit=\${limit}&offset=\${currentOffset}\`);
          const data = await response.json();
          
          if (data.success) {
            renderList(data.contributions);
            document.getElementById('pending-count').textContent = data.total;
          } else {
             document.getElementById('knowledge-list').innerHTML = '<li class="p-6 text-center text-red-500">\u8F09\u5165\u5931\u6557: ' + data.error + '</li>';
          }
        } catch (e) {
          console.error('Error:', e);
          document.getElementById('knowledge-list').innerHTML = '<li class="p-6 text-center text-red-500">\u767C\u751F\u932F\u8AA4</li>';
        }
      }

      function renderList(items) {
        const listEl = document.getElementById('knowledge-list');
        if (!items || items.length === 0) {
          listEl.innerHTML = '<li class="p-6 text-center text-gray-500">\u76EE\u524D\u6C92\u6709\u5F85\u5BE9\u6838\u7684\u9805\u76EE\u3002</li>';
          return;
        }

        listEl.innerHTML = items.map(item => \`
          <li>
            <div class="block hover:bg-gray-50">
              <div class="px-4 py-4 sm:px-6">
                <div class="flex items-center justify-between">
                  <p class="text-sm font-medium text-indigo-600 truncate">
                    \${item.category === 'food' ? '\u{1F35C} \u7F8E\u98DF' : item.category === 'spot' ? '\u{1F3DE}\uFE0F \u666F\u9EDE' : '\u{1F4D6} \u6545\u4E8B'}
                  </p>
                  <div class="ml-2 flex-shrink-0 flex">
                    <p class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-yellow-100 text-yellow-800">
                      \u5F85\u5BE9\u6838
                    </p>
                  </div>
                </div>
                <div class="mt-2 sm:flex sm:justify-between">
                  <div class="sm:flex">
                    <p class="flex items-center text-sm text-gray-500">
                      \u4F86\u6E90: \${item.user_id ? '\u6703\u54E1' : '\u8A2A\u5BA2'}
                    </p>
                  </div>
                  <div class="mt-2 flex items-center text-sm text-gray-500 sm:mt-0">
                    <p>
                      \u63D0\u4EA4\u65BC \${new Date(item.created_at).toLocaleString('zh-TW')}
                    </p>
                  </div>
                </div>
                <div class="mt-4">
                  <p class="text-sm text-gray-900 bg-gray-50 p-3 rounded">
                    \${item.content}
                  </p>
                  <p class="mt-2 text-xs text-gray-400">
                     \u63D0\u53D6\u8CC7\u6599: \${item.extracted_data || '\u7121'}
                  </p>
                </div>
                <div class="mt-4 flex justify-end space-x-3">
                  <button onclick="handleReject(\${item.id})" class="inline-flex items-center px-3 py-1.5 border border-transparent text-xs font-medium rounded text-red-700 bg-red-100 hover:bg-red-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                    \u62D2\u7D55
                  </button>
                  <button onclick="handleApprove(\${item.id})" class="inline-flex items-center px-3 py-1.5 border border-transparent text-xs font-medium rounded text-green-700 bg-green-100 hover:bg-green-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                    \u6279\u51C6\u4E26\u52A0\u5165\u8CC7\u6599\u5EAB
                  </button>
                </div>
              </div>
            </div>
          </li>
        \`).join('');
      }

      async function handleApprove(id) {
        if(!confirm('\u78BA\u5B9A\u8981\u6279\u51C6\u9019\u689D\u60C5\u5831\u55CE\uFF1F')) return;
        try {
          const res = await fetch(\`/api/admin/knowledge/\${id}/approve\`, { method: 'POST' });
          const data = await res.json();
          if(data.success) {
            alert('\u5DF2\u6279\u51C6\uFF01');
            fetchPendingKnowledge(); // Refresh
          } else {
            alert('\u5931\u6557: ' + data.message);
          }
        } catch(e) {
          alert('Error executing request');
        }
      }

      async function handleReject(id) {
        if(!confirm('\u78BA\u5B9A\u8981\u62D2\u7D55\u9019\u689D\u60C5\u5831\u55CE\uFF1F')) return;
        try {
          const res = await fetch(\`/api/admin/knowledge/\${id}/reject\`, { method: 'POST' });
          const data = await res.json();
          if(data.success) {
            alert('\u5DF2\u62D2\u7D55\u3002');
            fetchPendingKnowledge(); // Refresh
          } else {
            alert('\u5931\u6557: ' + data.message);
          }
        } catch(e) {
           alert('Error executing request');
        }
      }

      // Initial Load
      fetchPendingKnowledge();
    </script>
  `;
  return pageTemplate2({
    user,
    nonce,
    cssContent,
    content,
    title: "\u77E5\u8B58\u5EAB\u5BE9\u6838 | \u6F8E\u6E56\u597D\u670B\u53CB Admin"
  });
}

// src/api/admin-knowledge.js
init_AIKnowledgeService();
init_auth();
async function handleAdminKnowledgeRequest(request, env, user = null) {
  const url = new URL(request.url);
  const normalizedPath = pathname.endsWith("/") && pathname.length > 1 ? pathname.slice(0, -1) : pathname;
  console.log(`[AdminKnowledgeAPI] Handling ${request.method} ${normalizedPath}`);
  try {
    if (request.method === "GET" && normalizedPath === "/api/admin/knowledge/pending") {
      const limit = parseInt(url.searchParams.get("limit") || "20");
      const offset = parseInt(url.searchParams.get("offset") || "0");
      const result = await knowledgeService.getPendingContributions(limit, offset);
      return new Response(JSON.stringify({
        success: true,
        contributions: result.contributions,
        total: result.total
      }), {
        headers: { "Content-Type": "application/json" }
      });
    }
    const approveMatch = pathname.match(/^\/api\/admin\/knowledge\/(\d+)\/approve$/);
    if (request.method === "POST" && approveMatch) {
      const id = approveMatch[1];
      const success = await knowledgeService.approveContribution(id);
      return new Response(JSON.stringify({
        success,
        message: success ? "Contribution approved" : "Failed to approve contribution"
      }), {
        headers: { "Content-Type": "application/json" }
      });
    }
    const rejectMatch = pathname.match(/^\/api\/admin\/knowledge\/(\d+)\/reject$/);
    if (request.method === "POST" && rejectMatch) {
      const id = rejectMatch[1];
      const success = await knowledgeService.rejectContribution(id);
      return new Response(JSON.stringify({
        success,
        message: success ? "Contribution rejected" : "Failed to reject contribution"
      }), {
        headers: { "Content-Type": "application/json" }
      });
    }
    return new Response(JSON.stringify({ error: "Not Found" }), { status: 404 });
  } catch (error) {
    console.error("[AdminKnowledgeAPI] Error:", error);
    return new Response(JSON.stringify({
      success: false,
      error: error.message
    }), {
      status: 500,
      headers: { "Content-Type": "application/json" }
    });
  }
}

// src/pages/Home.js
init_layout();
async function renderHomePage(request, env, session, user, nonce, cssContent) {
  const content = `
    <div class="max-w-6xl mx-auto px-4 py-8">
      <div class="text-center py-12">
        <h1 class="text-4xl md:text-5xl font-bold text-gray-900 mb-4">\u597D\u6F8E\u6E56 HOPENGHU</h1>
        <p class="text-xl md:text-2xl text-gray-700 mb-2">\u559C\u6B61\u6F8E\u6E56\uFF0C\u56E0\u70BA\u6F8E\u6E56\u662F\u5E0C\u671B\u4E4B\u5CF6</p>
        <p class="text-lg text-gray-600 mb-8">HOPE PENGHU</p>
        
        <!-- AI \u52A9\u624B\u5165\u53E3 -->
        <div class="mt-8">
          <a href="/ai-chat" class="inline-flex items-center space-x-2 bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg shadow-lg transition-all duration-300 hover:scale-105">
            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
              <path d="M2 5a2 2 0 012-2h7a2 2 0 012 2v4a2 2 0 01-2 2H9l-3 3v-3H4a2 2 0 01-2-2V5z"></path>
              <path d="M15 7v2a4 4 0 01-4 4H9.828l-1.766 1.767c.28.149.599.233.938.233h2l3 3v-3h2a2 2 0 002-2V9a2 2 0 00-2-2h-1z"></path>
            </svg>
            <span class="font-semibold">\u958B\u555F\u6F8E\u6E56 AI \u52A9\u624B</span>
          </a>
        </div>
      </div>
    </div>
  `;
  const url = new URL(request.url);
  return new Response(pageTemplate2({
    title: "HOPENGHU - \u9996\u9801",
    content,
    user,
    nonce,
    cssContent,
    currentPath: url.pathname
  }), {
    headers: { "Content-Type": "text/html;charset=utf-8" }
  });
}

// src/pages/Login.js
init_layout();
async function renderLoginPage(request, env, session, user, nonce, cssContent) {
  const googleLoginUrl = `/api/auth/google`;
  const content = `
    <div class="min-h-[70vh] flex items-center justify-center p-4">
      <div class="bg-white p-8 rounded-lg shadow-md w-full max-w-sm">
        <h1 class="text-2xl font-bold mb-6 text-center">\u767B\u5165\u6216\u8A3B\u518A</h1>
        
        <a href="${googleLoginUrl}" 
           class="w-full flex items-center justify-center px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 mb-4">
          <svg class="w-5 h-5 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48" width="48px" height="48px">
            <path fill="#FFC107" d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12s5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24s8.955,20,20,20s20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z"/>
            <path fill="#FF3D00" d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"/>
            <path fill="#4CAF50" d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36c-5.202,0-9.619-3.317-11.283-7.946l-6.522,5.025C9.505,39.556,16.227,44,24,44z"/>
            <path fill="#1976D2" d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.574l6.19,5.238C39.712,34.495,44,28.756,44,24C44,22.659,43.862,21.35,43.611,20.083z"/>
          </svg>
          <span>\u4F7F\u7528 Google \u767B\u5165</span>
        </a>

        <p class="text-center text-xs text-gray-500">
          \u767B\u5165\u5373\u8868\u793A\u60A8\u540C\u610F\u6211\u5011\u7684\u670D\u52D9\u689D\u6B3E\u548C\u96B1\u79C1\u653F\u7B56\u3002
        </p>
      </div>
    </div>
  `;
  return new Response(pageTemplate2({
    title: "\u767B\u5165",
    content,
    user,
    nonce,
    cssContent
  }), {
    headers: { "Content-Type": "text/html;charset=utf-8" }
  });
}

// src/pages/notFound.js
init_layout();

// src/utils/nonce.js
function generateNonce() {
  const array = new Uint8Array(16);
  crypto.getRandomValues(array);
  return Array.from(array, (byte) => byte.toString(16).padStart(2, "0")).join("");
}

// src/pages/notFound.js
function renderNotFoundPage(request) {
  const nonce = generateNonce();
  const content = `
    <div class="not-found-container">
      <div class="not-found-content">
        <h1>404</h1>
        <p>\u627E\u4E0D\u5230\u9801\u9762</p>
        <a href="/" class="button button-primary">\u56DE\u5230\u9996\u9801</a>
      </div>
    </div>

    <style nonce="${nonce}">
      .not-found-container {
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: calc(100vh - 200px);
        text-align: center;
      }

      .not-found-content h1 {
        font-size: 6rem;
        font-weight: bold;
        color: var(--primary-color);
        margin-bottom: 1rem;
      }

      .not-found-content p {
        font-size: 1.5rem;
        margin-bottom: 2rem;
        color: var(--text-color);
      }
    </style>
  `;
  return new Response(
    pageTemplate2({
      title: "\u627E\u4E0D\u5230\u9801\u9762",
      content,
      user: null,
      nonce
    }),
    {
      status: 404,
      headers: {
        "Content-Type": "text/html;charset=utf-8"
      }
    }
  );
}

// src/pages/AIChatPage.js
init_layout();
async function renderAIChatPage(request, env, session, user, nonce, cssContent) {
  function getTimeBasedGreeting() {
    const hour = (/* @__PURE__ */ new Date()).getHours();
    if (hour >= 5 && hour < 12)
      return "\u65E9\u5B89\uFF01\u7F8E\u597D\u7684\u4E00\u5929\u958B\u59CB\u4E86\uFF01\u2600\uFE0F";
    if (hour >= 12 && hour < 18)
      return "\u5348\u5B89\uFF01\u4ECA\u5929\u904E\u5F97\u597D\u55CE\uFF1F\u2615";
    if (hour >= 18 && hour < 22)
      return "\u665A\u4E0A\u597D\uFF01\u5403\u904E\u665A\u9910\u4E86\u55CE\uFF1F\u{1F319}";
    return "\u9019\u9EBC\u665A\u9084\u5728\uFF1F\u8981\u6CE8\u610F\u4F11\u606F\u5594\uFF01\u2728";
  }
  const greeting = getTimeBasedGreeting();
  const messages = {
    confirmReset: "\u78BA\u5B9A\u8981\u6E05\u9664\u6240\u6709\u5C0D\u8A71\u7D00\u9304\u55CE\uFF1F\u9019\u5C07\u7121\u6CD5\u5FA9\u539F\u3002",
    linkCopied: "\u9023\u7D50\u5DF2\u8907\u88FD\uFF01",
    copiedToClipboard: "\u5DF2\u8907\u88FD\u5230\u526A\u8CBC\u677F\uFF01",
    copyFailed: "\u8907\u88FD\u5931\u6557\uFF0C\u8ACB\u624B\u52D5\u8907\u88FD"
  };
  const content = `
    <div class="ai-chat-container">
      <!-- \u9802\u90E8\u5C0E\u822A\u5217 -->
      <header class="ai-chat-header">
        <div class="ai-chat-header-left">
          <a href="/" class="ai-chat-logo">HOPE PENGHU</a>
          <span class="ai-chat-separator">|</span>
          <h1 class="ai-chat-title">\u6F8E\u6E56\u597D\u670B\u53CB AI</h1>
        </div>
        <div class="ai-chat-header-right">
          <button id="ai-chat-stats-button" class="ai-chat-header-button" title="\u5C0D\u8A71\u7D71\u8A08">
            <svg class="ai-chat-header-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
            </svg>
          </button>
          <button id="ai-chat-share-button" class="ai-chat-header-button" title="\u5206\u4EAB\u5C0D\u8A71">
            <svg class="ai-chat-header-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"></path>
            </svg>
          </button>
          ${user ? `
            <span class="ai-chat-user-name">${user.name || user.email}</span>
            <a href="/profile" class="ai-chat-link">\u6211\u7684\u5730\u9EDE</a>
          ` : `
            <a href="/login" class="ai-chat-link">\u767B\u5165</a>
          `}
        </div>
      </header>

      <!-- \u5C0D\u8A71\u5340\u57DF -->
      <div id="ai-chat-messages" class="ai-chat-messages">
        <!-- \u6B61\u8FCE\u8A0A\u606F -->
        <div class="ai-chat-welcome-message">
          <div class="ai-chat-avatar">
            <div class="ai-chat-avatar-text">\u{1F335}</div>
          </div>
          <div class="ai-chat-message-content">
            <div class="ai-chat-message-bubble">
              <p class="ai-chat-message-text" id="welcome-greeting">${greeting}</p>
              <p class="ai-chat-message-text">\u4E0D\u8AD6\u4F60\u662F\u525B\u8981\u4F86\u73A9\u3001\u5DF2\u7D93\u5728\u6F8E\u6E56\uFF0C\u9084\u662F\u5C31\u5728\u9019\u88E1\u751F\u6D3B\uFF0C\u6211\u90FD\u60F3\u8A8D\u8B58\u4F60\uFF0C\u8DDF\u4F60\u804A\u804A\u9019\u5EA7\u5CF6\u5DBC\u7684\u6545\u4E8B\u3002</p>
              <p class="ai-chat-message-text">\u6211\u5011\u53EF\u4EE5\uFF1A</p>
              <ul class="ai-chat-message-list">
                <li>\u{1F30A} \u804A\u804A\u5728\u5730\u79C1\u623F\u666F\u9EDE</li>
                <li>\u{1F5FA}\uFE0F \u898F\u5283\u6700\u9053\u5730\u7684\u884C\u7A0B</li>
                <li>\u{1F4D6} \u4EA4\u63DB\u5F7C\u6B64\u7684\u6F8E\u6E56\u6545\u4E8B</li>
                <li>\u{1F4AC} \u50CF\u670B\u53CB\u4E00\u6A23\u8F15\u9B06\u804A\u5929</li>
              </ul>
              <p class="ai-chat-message-subtext">\u5148\u5077\u5077\u544A\u8A34\u6211\uFF0C\u4F60\u662F...</p>
              <div class="ai-chat-options-container" id="welcome-options">
                <button class="ai-chat-option-button" data-option="\u6211\u662F\u6F8E\u6E56\u751F\u6D3B\u5C45\u6C11">
                  \u{1F3E0} \u6211\u662F\u6F8E\u6E56\u751F\u6D3B\u5C45\u6C11
                </button>
                <button class="ai-chat-option-button" data-option="\u6211\u4F86\u904E\u6F8E\u6E56">
                  \u2708\uFE0F \u6211\u4F86\u904E\u6F8E\u6E56
                </button>
                <button class="ai-chat-option-button" data-option="\u6211\u60F3\u4F86\u6F8E\u6E56">
                  \u{1F392} \u6211\u60F3\u4F86\u6F8E\u6E56\u73A9
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- \u5FEB\u901F\u56DE\u8986\u5EFA\u8B70 -->
      <div id="ai-quick-replies" class="ai-chat-quick-replies hidden">
        <div class="ai-chat-quick-replies-container">
          <p class="ai-chat-quick-replies-label">\u5FEB\u901F\u56DE\u8986\uFF1A</p>
          <div class="ai-chat-quick-replies-buttons" id="quick-replies-buttons">
            <!-- \u52D5\u614B\u751F\u6210\u5FEB\u901F\u56DE\u8986\u6309\u9215 -->
          </div>
        </div>
      </div>

      <!-- \u8F38\u5165\u5340\u57DF -->
      <div class="ai-chat-input-container">
        <div class="ai-chat-input-wrapper">
          <div class="ai-chat-input-box">
            <button 
              id="ai-emoji-button"
              class="ai-chat-emoji-button"
              title="\u6DFB\u52A0\u8868\u60C5"
            >
              <svg class="ai-chat-emoji-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
              </svg>
            </button>
            <textarea 
              id="ai-chat-input" 
              placeholder="\u8DDF\u6211\u804A\u804A\u6F8E\u6E56..."
              rows="1"
              class="ai-chat-textarea"
            ></textarea>
            <button 
              id="ai-send-button"
              disabled
              class="ai-chat-send-button"
            >
              <svg class="ai-chat-send-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
              </svg>
            </button>
          </div>
          <p class="ai-chat-status-text">
            ${user ? "\u5DF2\u767B\u5165" : "\u672A\u767B\u5165"} - \u60A8\u53EF\u4EE5\u67E5\u8A62\u8CC7\u8A0A\uFF0C${user ? "\u4E5F\u53EF\u4EE5\u63D0\u4F9B\u65B0\u8CC7\u8A0A" : "\u767B\u5165\u5F8C\u53EF\u63D0\u4F9B\u65B0\u8CC7\u8A0A"}
          </p>
        </div>
      </div>

      <!-- \u8868\u60C5\u9078\u64C7\u5668 -->
      <div id="ai-emoji-picker" class="ai-chat-emoji-picker hidden">
        <div class="ai-chat-emoji-grid">
          <button class="ai-chat-emoji-item" data-emoji="\u{1F60A}">\u{1F60A}</button>
          <button class="ai-chat-emoji-item" data-emoji="\u{1F604}">\u{1F604}</button>
          <button class="ai-chat-emoji-item" data-emoji="\u{1F601}">\u{1F601}</button>
          <button class="ai-chat-emoji-item" data-emoji="\u{1F917}">\u{1F917}</button>
          <button class="ai-chat-emoji-item" data-emoji="\u{1F44D}">\u{1F44D}</button>
          <button class="ai-chat-emoji-item" data-emoji="\u2764\uFE0F">\u2764\uFE0F</button>
          <button class="ai-chat-emoji-item" data-emoji="\u{1F389}">\u{1F389}</button>
          <button class="ai-chat-emoji-item" data-emoji="\u{1F30A}">\u{1F30A}</button>
          <button class="ai-chat-emoji-item" data-emoji="\u{1F335}">\u{1F335}</button>
          <button class="ai-chat-emoji-item" data-emoji="\u{1F3D6}\uFE0F">\u{1F3D6}\uFE0F</button>
          <button class="ai-chat-emoji-item" data-emoji="\u{1F35C}">\u{1F35C}</button>
          <button class="ai-chat-emoji-item" data-emoji="\u{1F99E}">\u{1F99E}</button>
        </div>
      </div>
      <!-- \u7D71\u8A08 Modal -->
      <div id="ai-chat-stats-modal" class="ai-chat-modal hidden">
        <div class="ai-chat-modal-content">
          <div class="ai-chat-modal-header">
            <h3 class="ai-chat-modal-title">\u5C0D\u8A71\u7D71\u8A08</h3>
            <button class="ai-chat-modal-close" id="ai-chat-stats-modal-close">\xD7</button>
          </div>
          <div class="ai-chat-modal-body">
            <div class="ai-chat-stats-grid">
              <div class="ai-chat-stat-card">
                <div class="ai-chat-stat-value" id="stats-total-messages">0</div>
                <div class="ai-chat-stat-label">\u7E3D\u8A0A\u606F\u6578</div>
              </div>
              <div class="ai-chat-stat-card">
                <div class="ai-chat-stat-value" id="stats-user-messages">0</div>
                <div class="ai-chat-stat-label">\u4F60\u7684\u767C\u8A00</div>
              </div>
            </div>
            <div class="ai-chat-stats-actions">
              <button class="ai-chat-stats-button" id="ai-chat-reset-conversation-button">
                <svg class="ai-chat-stats-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                </svg>
                \u6E05\u9664\u5C0D\u8A71\u7D00\u9304
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- \u5206\u4EAB Modal -->
      <div id="ai-chat-share-modal" class="ai-chat-modal hidden">
        <div class="ai-chat-modal-content">
          <div class="ai-chat-modal-header">
            <h3 class="ai-chat-modal-title">\u5206\u4EAB\u5C0D\u8A71</h3>
            <button class="ai-chat-modal-close" id="ai-chat-share-modal-close">\xD7</button>
          </div>
          <div class="ai-chat-modal-body">
            <div class="ai-chat-share-options">
              <button class="ai-chat-share-option" id="ai-chat-share-clipboard-button">
                <svg class="ai-chat-share-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"></path>
                </svg>
                \u8907\u88FD\u9023\u7D50
              </button>
              <button class="ai-chat-share-option" id="ai-chat-share-export-button">
                <svg class="ai-chat-share-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                </svg>
                \u4E0B\u8F09\u6587\u5B57\u6A94
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <style nonce="${nonce}">
      /* \u4E3B\u5BB9\u5668 */
      .ai-chat-container {
        display: flex;
        flex-direction: column;
        min-height: 100vh;
        height: 100vh;
        background-color: #f9fafb;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        width: 100%;
      }

      /* \u9802\u90E8\u5C0E\u822A\u5217 */
      .ai-chat-header {
        background-color: white;
        border-bottom: 1px solid #e5e7eb;
        padding: 12px 16px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        flex-shrink: 0;
      }

      .ai-chat-header-left {
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .ai-chat-logo {
        color: #2563eb;
        font-weight: 600;
        text-decoration: none;
      }

      .ai-chat-logo:hover {
        color: #1d4ed8;
      }

      .ai-chat-separator {
        color: #9ca3af;
      }

      .ai-chat-title {
        font-size: 18px;
        font-weight: 600;
        color: #1f2937;
        margin: 0;
      }

      .ai-chat-header-right {
        display: flex;
        align-items: center;
        gap: 16px;
      }

      .ai-chat-user-name {
        font-size: 14px;
        color: #4b5563;
      }

      .ai-chat-link {
        font-size: 14px;
        color: #2563eb;
        text-decoration: none;
      }

      .ai-chat-link:hover {
        color: #1d4ed8;
      }

      /* \u982D\u90E8\u6309\u9215 */
      .ai-chat-header-button {
        background-color: transparent;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        padding: 6px 10px;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #6b7280;
      }

      .ai-chat-header-button:hover {
        background-color: #f3f4f6;
        border-color: #3b82f6;
        color: #2563eb;
      }

      .ai-chat-header-icon {
        width: 18px;
        height: 18px;
      }

      /* Modal \u6A23\u5F0F */
      .ai-chat-modal {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        animation: fadeIn 0.2s ease-out;
      }

      .ai-chat-modal.hidden {
        display: none;
      }

      .ai-chat-modal-content {
        background-color: white;
        border-radius: 12px;
        width: 90%;
        max-width: 500px;
        max-height: 80vh;
        overflow-y: auto;
        animation: slideUp 0.3s ease-out;
      }

      @keyframes slideUp {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .ai-chat-modal-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 20px;
        border-bottom: 1px solid #e5e7eb;
      }

      .ai-chat-modal-title {
        font-size: 18px;
        font-weight: 600;
        color: #1f2937;
        margin: 0;
      }

      .ai-chat-modal-close {
        background-color: transparent;
        border: none;
        font-size: 24px;
        color: #6b7280;
        cursor: pointer;
        padding: 0;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 6px;
        transition: all 0.2s;
      }

      .ai-chat-modal-close:hover {
        background-color: #f3f4f6;
        color: #1f2937;
      }

      .ai-chat-modal-body {
        padding: 20px;
      }

      /* \u7D71\u8A08\u5361\u7247 */
      .ai-chat-stats-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 16px;
        margin-bottom: 24px;
      }

      .ai-chat-stat-card {
        background-color: #f9fafb;
        border-radius: 8px;
        padding: 16px;
        text-align: center;
      }

      .ai-chat-stat-value {
        font-size: 24px;
        font-weight: 700;
        color: #2563eb;
        margin-bottom: 4px;
      }

      .ai-chat-stat-label {
        font-size: 13px;
        color: #6b7280;
      }

      .ai-chat-stats-actions {
        display: flex;
        gap: 12px;
      }

      .ai-chat-stats-button {
        flex: 1;
        background-color: #2563eb;
        color: white;
        border: none;
        border-radius: 8px;
        padding: 12px 16px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
      }

      .ai-chat-stats-button:hover {
        background-color: #1d4ed8;
      }

      .ai-chat-stats-icon {
        width: 18px;
        height: 18px;
      }

      /* \u5206\u4EAB\u9078\u9805 */
      .ai-chat-share-options {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
      }

      .ai-chat-share-option {
        background-color: #f9fafb;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        padding: 16px;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 8px;
        font-size: 14px;
        color: #4b5563;
      }

      .ai-chat-share-option:hover {
        background-color: #eff6ff;
        border-color: #3b82f6;
        color: #2563eb;
      }

      .ai-chat-share-icon {
        width: 24px;
        height: 24px;
      }

      /* \u5C0D\u8A71\u5340\u57DF */
      .ai-chat-messages {
        flex: 1 1 auto;
        overflow-y: auto;
        padding: 24px 16px;
        max-height: calc(100vh - 180px);
      }

      .ai-chat-welcome-message {
        display: flex;
        align-items: flex-start;
        gap: 12px;
        max-width: 896px;
        margin: 0 auto;
      }

      .ai-chat-avatar {
        background-color: #dbeafe;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
      }

      .ai-chat-avatar-text {
        font-size: 24px;
        line-height: 1;
      }

      .ai-chat-avatar-icon {
        width: 20px;
        height: 20px;
        color: #2563eb;
        display: none; /* Hide SVG if using text */
      }

      .ai-chat-message-content {
        flex: 1;
      }

      .ai-chat-message-bubble {
        background-color: white;
        border-radius: 8px;
        padding: 16px;
        box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
      }

      .ai-chat-message-text {
        color: #374151;
        margin-bottom: 8px;
      }

      .ai-chat-message-list {
        color: #4b5563;
        font-size: 14px;
        list-style-type: disc;
        list-style-position: inside;
        margin-bottom: 8px;
      }

      .ai-chat-message-subtext {
        color: #4b5563;
        font-size: 14px;
      }

      /* \u8F38\u5165\u5340\u57DF */
      .ai-chat-input-container {
        background-color: white;
        border-top: 1px solid #e5e7eb;
        padding: 16px;
        flex-shrink: 0;
      }

      .ai-chat-input-wrapper {
        max-width: 896px;
        margin: 0 auto;
      }

      .ai-chat-input-box {
        display: flex;
        align-items: flex-end;
        gap: 12px;
        position: relative;
      }

      .ai-chat-textarea {
        flex: 1;
        width: 100%;
        border: 1px solid #d1d5db;
        border-radius: 8px;
        padding: 12px 48px 12px 48px;
        min-height: 48px;
        max-height: 200px;
        resize: none;
        font-family: inherit;
        font-size: 14px;
        line-height: 1.5;
      }

      .ai-chat-textarea:focus {
        outline: none;
        border-color: #2563eb;
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
      }

      .ai-chat-send-button {
        position: absolute;
        right: 8px;
        bottom: 8px;
        background-color: #2563eb;
        color: white;
        padding: 8px 16px;
        border-radius: 8px;
        border: none;
        cursor: pointer;
        opacity: 0.5;
        pointer-events: none;
        transition: background-color 0.2s, opacity 0.2s;
      }

      .ai-chat-send-button:not(:disabled) {
        opacity: 1;
        pointer-events: auto;
        cursor: pointer;
      }

      .ai-chat-send-button:not(:disabled):hover {
        background-color: #1d4ed8;
      }

      .ai-chat-send-icon {
        width: 20px;
        height: 20px;
      }

      .ai-chat-status-text {
        font-size: 12px;
        color: #6b7280;
        margin-top: 8px;
        text-align: center;
      }

      /* \u7528\u6236\u8A0A\u606F\u6A23\u5F0F */
      .ai-chat-user-message {
        display: flex;
        align-items: flex-start;
        gap: 12px;
        max-width: 896px;
        margin: 0 auto 24px;
        justify-content: flex-end;
      }

      /* User Bubble - Friendlier Style moved to main block */

      .ai-chat-user-text {
        font-size: 14px;
        white-space: pre-wrap;
      }

      /* AI \u8A0A\u606F\u6A23\u5F0F */
      .ai-chat-ai-message {
        display: flex;
        align-items: flex-start;
        gap: 12px;
        max-width: 896px;
        margin: 0 auto 24px;
      }

      /* Typing Indicator Animation */
      .typing-indicator span {
        animation: blink 1.4s infinite both;
        font-size: 24px;
        line-height: 10px;
        margin: 0 1px;
        display: inline-block;
      }

      .typing-indicator span:nth-child(2) {
        animation-delay: 0.2s;
      }

      .typing-indicator span:nth-child(3) {
        animation-delay: 0.4s;
      }

      @keyframes blink {
        0% { opacity: 0.2; }
        20% { opacity: 1; }
        100% { opacity: 0.2; }
      }

      /* AI Bubble - Friendlier Style */
      .ai-chat-ai-bubble {
        background-color: #ffffff;
        border-radius: 12px 12px 12px 2px; /* Bottom-left corner sharp */
        padding: 16px;
        box-shadow: 0 2px 4px 0 rgba(0, 0, 0, 0.05);
        border: 1px solid #f3f4f6;
        animation: messageSlideIn 0.3s ease-out;
      }

      @keyframes messageSlideIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* User Bubble - Friendlier Style */
      .ai-chat-user-bubble {
        background-color: #3b82f6; /* A slightly lighter, friendlier blue */
        color: white;
        border-radius: 12px 12px 2px 12px; /* Bottom-right corner sharp */
        padding: 16px;
        box-shadow: 0 2px 4px 0 rgba(0, 0, 0, 0.05);
        max-width: 80%;
        animation: messageSlideIn 0.3s ease-out;
      }
      
      .ai-chat-option-button {
        background-color: #ffffff;
        border: 1px solid #e5e7eb;
        border-radius: 20px; /* Pill shape */
        padding: 8px 16px;
        font-size: 14px;
        color: #4b5563;
        cursor: pointer;
        transition: all 0.2s;
        text-align: center; /* Center text */
        display: inline-block; /* Allow wrapping */
        margin-right: 8px;
        margin-bottom: 8px;
        box-shadow: 0 1px 2px rgba(0,0,0,0.05);
      }
      
      .ai-chat-option-button:hover {
        background-color: #eff6ff;
        border-color: #3b82f6;
        color: #2563eb;
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }

      .ai-chat-options-container {
        margin-top: 12px;
        display: flex;
        flex-wrap: wrap; /* Allow buttons to wrap */
        gap: 0; /* Handled by margin on buttons */
        flex-direction: row; /* Horizontal layout */
      }

      /* \u5FEB\u901F\u56DE\u8986\u5EFA\u8B70 */
      .ai-chat-quick-replies {
        background-color: white;
        border-top: 1px solid #e5e7eb;
        padding: 12px 16px;
        flex-shrink: 0;
      }

      .ai-chat-quick-replies-container {
        max-width: 896px;
        margin: 0 auto;
      }

      .ai-chat-quick-replies-label {
        font-size: 12px;
        color: #6b7280;
        margin-bottom: 8px;
      }

      .ai-chat-quick-replies-buttons {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
      }

      .ai-chat-quick-reply-button {
        background-color: #f3f4f6;
        border: 1px solid #e5e7eb;
        border-radius: 16px;
        padding: 6px 12px;
        font-size: 13px;
        color: #4b5563;
        cursor: pointer;
        transition: all 0.2s;
        white-space: nowrap;
      }

      .ai-chat-quick-reply-button:hover {
        background-color: #eff6ff;
        border-color: #3b82f6;
        color: #2563eb;
        transform: translateY(-1px);
      }

      /* \u8868\u60C5\u6309\u9215 */
      .ai-chat-emoji-button {
        position: absolute;
        left: 8px;
        bottom: 8px;
        background-color: transparent;
        color: #6b7280;
        padding: 8px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s;
        z-index: 10;
      }

      .ai-chat-emoji-button:hover {
        background-color: #f3f4f6;
        color: #2563eb;
      }

      .ai-chat-emoji-icon {
        width: 20px;
        height: 20px;
      }

      /* \u8868\u60C5\u9078\u64C7\u5668 */
      .ai-chat-emoji-picker {
        position: fixed;
        bottom: 100px;
        left: 50%;
        transform: translateX(-50%);
        max-width: 896px;
        width: calc(100% - 32px);
        background-color: white;
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        padding: 12px;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        z-index: 1000;
        animation: emojiPickerSlideUp 0.2s ease-out;
      }

      @keyframes emojiPickerSlideUp {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .ai-chat-emoji-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 8px;
      }

      .ai-chat-emoji-item {
        background-color: transparent;
        border: none;
        padding: 8px;
        font-size: 24px;
        cursor: pointer;
        border-radius: 8px;
        transition: all 0.2s;
      }

      .ai-chat-emoji-item:hover {
        background-color: #f3f4f6;
        transform: scale(1.2);
      }

      /* Hidden utility class */
      .hidden {
        display: none !important;
      }

      /* \u8A0A\u606F\u64CD\u4F5C\u6309\u9215 */
      .ai-chat-message-actions {
        display: flex;
        gap: 8px;
        margin-top: 8px;
        opacity: 0;
        transition: opacity 0.2s;
      }

      .ai-chat-ai-message:hover .ai-chat-message-actions {
        opacity: 1;
      }

      .ai-chat-action-button {
        background-color: #f3f4f6;
        border: 1px solid #e5e7eb;
        border-radius: 6px;
        padding: 4px 8px;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .ai-chat-action-button:hover {
        background-color: #eff6ff;
        border-color: #3b82f6;
        color: #2563eb;
      }

      .ai-chat-action-icon {
        width: 16px;
        height: 16px;
      }

      /* \u53CD\u61C9\u6309\u9215 */
      .ai-chat-reaction-button {
        font-size: 16px;
        padding: 4px 8px;
        min-width: 32px;
      }

      .ai-chat-reaction-button:hover {
        transform: scale(1.2);
      }

      .ai-chat-reaction-button.active {
        background-color: #dbeafe;
        border-color: #3b82f6;
      }

      /* \u53CD\u61C9\u986F\u793A */
      .ai-chat-reactions {
        display: flex;
        gap: 4px;
        margin-top: 8px;
        flex-wrap: wrap;
      }

      .ai-chat-reaction-badge {
        background-color: #f3f4f6;
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        padding: 2px 8px;
        font-size: 12px;
        display: flex;
        align-items: center;
        gap: 4px;
      }

      .ai-chat-reaction-badge.active {
        background-color: #dbeafe;
        border-color: #3b82f6;
      }

      /* \u5C0D\u8A71\u8A18\u61B6\u63D0\u793A */
      .ai-chat-context-hint {
        background-color: #eff6ff;
        border-left: 3px solid #3b82f6;
        padding: 8px 12px;
        margin-bottom: 12px;
        border-radius: 4px;
        font-size: 13px;
        color: #1e40af;
      }

      .ai-chat-context-hint strong {
        font-weight: 600;
      }

      /* \u8A0A\u606F\u6DE1\u5165\u52D5\u756B */
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .ai-chat-message-fade-in {
        animation: fadeIn 0.3s ease-out;
      }

      /* \u6539\u9032\u7684\u6253\u5B57\u6307\u793A\u5668 */
      .typing-indicator-enhanced {
        display: inline-flex;
        gap: 4px;
        margin-right: 8px;
      }

      .typing-indicator-enhanced span {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background-color: #9ca3af;
        animation: typingDot 1.4s infinite ease-in-out;
      }

      .typing-indicator-enhanced span:nth-child(1) {
        animation-delay: 0s;
      }

      .typing-indicator-enhanced span:nth-child(2) {
        animation-delay: 0.2s;
      }

      .typing-indicator-enhanced span:nth-child(3) {
        animation-delay: 0.4s;
      }

      @keyframes typingDot {
        0%, 60%, 100% {
          transform: translateY(0);
          opacity: 0.7;
        }
        30% {
          transform: translateY(-10px);
          opacity: 1;
        }
      }

      .typing-text {
        color: #6b7280;
        font-size: 13px;
        font-style: italic;
      }

      /* \u6642\u9593\u6233\u8A18\u548C\u5DF2\u8B80\u72C0\u614B */
      .ai-chat-message-footer {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-top: 8px;
        font-size: 11px;
        color: #9ca3af;
      }

      .ai-chat-timestamp {
        font-size: 11px;
        color: #9ca3af;
      }

      .ai-chat-read-status {
        font-size: 12px;
        color: #9ca3af;
        transition: color 0.2s;
      }

      .ai-chat-read-status.read {
        color: #3b82f6;
      }

      .ai-chat-user-bubble .ai-chat-timestamp {
        text-align: right;
        margin-top: 4px;
        font-size: 11px;
        color: #9ca3af;
      }

      /* \u6253\u5B57\u6307\u793A\u5668\u5BB9\u5668 */
      .ai-chat-typing-indicator {
        opacity: 0.8;
      }

      /* \u79FB\u52D5\u7AEF\u97FF\u61C9\u5F0F\u8A2D\u8A08 */
      @media (max-width: 768px) {
        .ai-chat-header {
          padding: 8px 12px;
        }

        .ai-chat-header-left {
          gap: 8px;
        }

        .ai-chat-title {
          font-size: 16px;
        }

        .ai-chat-separator {
          display: none;
        }

        .ai-chat-messages {
          padding: 16px 12px;
          max-height: calc(100vh - 160px);
        }

        .ai-chat-avatar {
          width: 32px;
          height: 32px;
        }

        .ai-chat-avatar-text {
          font-size: 20px;
        }

        .ai-chat-message-bubble,
        .ai-chat-ai-bubble,
        .ai-chat-user-bubble {
          padding: 12px;
          font-size: 14px;
        }

        .ai-chat-user-bubble {
          max-width: 85%;
        }

        .ai-chat-input-container {
          padding: 12px;
        }

        .ai-chat-textarea {
          padding: 10px 40px 10px 12px;
          font-size: 16px; /* \u9632\u6B62 iOS \u81EA\u52D5\u7E2E\u653E */
          min-height: 44px;
        }

        .ai-chat-send-button {
          padding: 6px 12px;
          right: 6px;
          bottom: 6px;
        }

        .ai-chat-emoji-button {
          left: 6px;
          bottom: 6px;
          padding: 6px;
        }

        .ai-chat-message-actions {
          gap: 4px;
        }

        .ai-chat-action-button {
          padding: 6px;
          min-width: 36px;
          min-height: 36px;
        }

        .ai-chat-reaction-button {
          font-size: 18px;
          min-width: 36px;
          min-height: 36px;
        }

        .ai-chat-option-button {
          padding: 10px 14px;
          font-size: 13px;
          margin-right: 6px;
          margin-bottom: 6px;
        }

        .ai-chat-quick-reply-button {
          padding: 8px 12px;
          font-size: 12px;
        }

        .ai-chat-emoji-picker {
          left: 16px;
          right: 16px;
          bottom: 100px;
          width: calc(100% - 32px);
          max-width: none;
          transform: none;
        }

        .ai-chat-emoji-grid {
          grid-template-columns: repeat(6, 1fr);
        }

        .ai-chat-timestamp {
          font-size: 10px;
        }

        .ai-chat-read-status {
          font-size: 11px;
        }

        /* \u79FB\u52D5\u7AEF\u512A\u5316\uFF1A\u9632\u6B62\u6587\u5B57\u9078\u64C7 */
        .ai-chat-user-message,
        .ai-chat-ai-message {
          -webkit-tap-highlight-color: transparent;
          user-select: none;
        }

        .ai-chat-user-text,
        .ai-chat-ai-text {
          user-select: text;
        }
      }

      /* \u8D85\u5C0F\u5C4F\u5E55\u512A\u5316 */
      @media (max-width: 480px) {
        .ai-chat-header {
          padding: 6px 8px;
        }

        .ai-chat-title {
          font-size: 14px;
        }

        .ai-chat-messages {
          padding: 12px 8px;
        }

        .ai-chat-avatar {
          width: 28px;
          height: 28px;
        }

        .ai-chat-avatar-text {
          font-size: 18px;
        }

        .ai-chat-message-bubble,
        .ai-chat-ai-bubble,
        .ai-chat-user-bubble {
          padding: 10px;
          font-size: 13px;
        }

        .ai-chat-user-bubble {
          max-width: 90%;
        }

        .ai-chat-input-container {
          padding: 8px;
        }

        .ai-chat-textarea {
          padding: 8px 36px 8px 10px;
          font-size: 16px;
        }
      }

      /* \u89F8\u6478\u8A2D\u5099\u512A\u5316 */
      @media (hover: none) and (pointer: coarse) {
        .ai-chat-action-button,
        .ai-chat-option-button,
        .ai-chat-quick-reply-button,
        .ai-chat-emoji-item {
          min-height: 44px; /* iOS \u63A8\u85A6\u7684\u6700\u5C0F\u89F8\u6478\u76EE\u6A19 */
          min-width: 44px;
        }

        .ai-chat-ai-message:hover .ai-chat-message-actions {
          opacity: 1; /* \u79FB\u52D5\u7AEF\u59CB\u7D42\u986F\u793A\u64CD\u4F5C\u6309\u9215 */
        }

        .ai-chat-message-actions {
          opacity: 1;
        }
      }

      /* \u6027\u80FD\u512A\u5316\uFF1A\u6E1B\u5C11\u52D5\u756B\u5728\u4F4E\u6027\u80FD\u8A2D\u5099\u4E0A */
      @media (prefers-reduced-motion: reduce) {
        .ai-chat-message-fade-in,
        .ai-chat-ai-bubble,
        .ai-chat-user-bubble,
        .typing-indicator-enhanced span {
          animation: none;
        }
      }

      /* \u6DF1\u8272\u6A21\u5F0F\u652F\u6301\uFF08\u53EF\u9078\uFF09 */
      @media (prefers-color-scheme: dark) {
        /* \u53EF\u4EE5\u5728\u6B64\u6DFB\u52A0\u6DF1\u8272\u6A21\u5F0F\u6A23\u5F0F */
      }

      /* \u5730\u5716\u5BB9\u5668\u6A23\u5F0F */
      .ai-chat-map-container {
        max-width: 896px;
        margin: 24px auto;
        background: white;
        border-radius: 12px;
        padding: 16px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        animation: messageSlideIn 0.3s ease-out;
      }

      .ai-chat-map-header {
        margin-bottom: 16px;
      }

      .ai-chat-map-header h3 {
        font-size: 18px;
        font-weight: 600;
        color: #1f2937;
        margin-bottom: 8px;
      }

      .ai-chat-map-header p {
        font-size: 14px;
        color: #6b7280;
      }

      .ai-chat-map-search {
        margin-bottom: 16px;
      }

      .ai-chat-map-search-input {
        width: 100%;
        padding: 12px 16px;
        border: 1px solid #d1d5db;
        border-radius: 8px;
        font-size: 14px;
        font-family: inherit;
      }

      .ai-chat-map-search-input:focus {
        outline: none;
        border-color: #2563eb;
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
      }

      .ai-chat-map {
        width: 100%;
        height: 400px;
        border-radius: 8px;
        overflow: hidden;
        margin-bottom: 16px;
      }

      .ai-chat-map-actions {
        display: flex;
        gap: 12px;
        justify-content: flex-end;
      }

      .ai-chat-map-button {
        padding: 10px 20px;
        border-radius: 8px;
        border: 1px solid #d1d5db;
        background: white;
        color: #4b5563;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
      }

      .ai-chat-map-button:hover:not(:disabled) {
        background: #f3f4f6;
        border-color: #9ca3af;
      }

      .ai-chat-map-button-primary {
        background: #2563eb;
        color: white;
        border-color: #2563eb;
      }

      .ai-chat-map-button-primary:hover:not(:disabled) {
        background: #1d4ed8;
        border-color: #1d4ed8;
      }

      .ai-chat-map-button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .ai-chat-map-selected-info {
        margin-top: 12px;
        padding: 12px;
        background: #eff6ff;
        border-radius: 8px;
        border-left: 3px solid #2563eb;
        font-size: 14px;
        color: #1e40af;
      }

      .ai-chat-map-error {
        padding: 16px;
        background: #fef2f2;
        border-radius: 8px;
        color: #dc2626;
        text-align: center;
      }

      @media (max-width: 768px) {
        .ai-chat-map-container {
          margin: 16px 12px;
          padding: 12px;
        }

        .ai-chat-map {
          height: 300px;
        }

        .ai-chat-map-actions {
          flex-direction: column;
        }

        .ai-chat-map-button {
          width: 100%;
        }
      }
    </style>

    <script nonce="${nonce}">
      // \u7ACB\u5373\u8A2D\u7F6E\u5168\u5C40\u932F\u8AA4\u8655\u7406\uFF0C\u907F\u514D\u7B2C\u4E09\u65B9\u8173\u672C\u932F\u8AA4\u5F71\u97FF\u61C9\u7528
      (function() {
        // \u6AA2\u67E5\u662F\u5426\u662F\u7B2C\u4E09\u65B9\u8173\u672C\u932F\u8AA4\u7684\u8F14\u52A9\u51FD\u6578
        function isThirdPartyError(errorSource, fileName, errorMessage, stack) {
          const sources = [
            errorSource || '',
            fileName || '',
            errorMessage || '',
            stack || ''
          ].join(' ').toLowerCase();
          
          return sources.includes('givefreely') ||
                 sources.includes('cloudflareinsights') ||
                 sources.includes('beacon') ||
                 (sources.includes('payload') && sources.includes('givefreely'));
        }
        
        // \u8655\u7406\u672A\u6355\u7372\u7684 Promise \u932F\u8AA4
        window.addEventListener('unhandledrejection', (event) => {
          const errorSource = event.reason?.stack || event.reason?.message || String(event.reason || '');
          const fileName = event.reason?.fileName || event.reason?.sourceURL || '';
          const errorMessage = event.reason?.message || String(event.reason || '');
          const stack = event.reason?.stack || '';
          
          // \u6AA2\u67E5\u932F\u8AA4\u5806\u68E7\u4E2D\u7684\u6587\u4EF6\u540D
          let stackFileName = '';
          if (stack) {
            const match = stack.match(/ats+.*?(([^)]+))/);
            if (match && match[1]) {
              stackFileName = match[1];
            }
          }
          
          // \u6AA2\u67E5\u662F\u5426\u662F\u7B2C\u4E09\u65B9\u8173\u672C\u7684\u932F\u8AA4
          if (isThirdPartyError(errorSource, fileName || stackFileName, errorMessage, stack)) {
            event.preventDefault(); // \u963B\u6B62\u932F\u8AA4\u986F\u793A\u5728\u63A7\u5236\u53F0
            return; // \u975C\u9ED8\u5FFD\u7565
          }
        });
        
        // \u8655\u7406\u672A\u6355\u7372\u7684\u540C\u6B65\u932F\u8AA4
        window.addEventListener('error', (event) => {
          const errorSource = event.filename || event.message || '';
          const errorMessage = event.message || '';
          const stack = event.error?.stack || '';
          
          // \u6AA2\u67E5\u662F\u5426\u662F\u7B2C\u4E09\u65B9\u8173\u672C\u7684\u932F\u8AA4
          if (isThirdPartyError(errorSource, event.filename || '', errorMessage, stack)) {
            event.preventDefault(); // \u963B\u6B62\u932F\u8AA4\u986F\u793A\u5728\u63A7\u5236\u53F0
            return; // \u975C\u9ED8\u5FFD\u7565
          }
        });
      })();
      
      // \u5F9E\u670D\u52D9\u5668\u7AEF\u50B3\u905E\u7684\u4E2D\u6587\u5B57\u7B26\u4E32\u6578\u64DA
      const MESSAGES = ${JSON.stringify(messages)};
      
      let aiSessionId = 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
      let isLoading = false;
      let retryCount = 0;
      const MAX_RETRIES = 3;

      // \u66F4\u65B0\u767C\u9001\u6309\u9215\u72C0\u614B\u7684\u7D71\u4E00\u51FD\u6578
      function updateSendButtonState() {
        const input = document.getElementById('ai-chat-input');
        const sendButton = document.getElementById('ai-send-button');
        if (input && sendButton) {
          const hasText = input.value.trim().length > 0;
          sendButton.disabled = !hasText || isLoading;
        }
      }

      // \u81EA\u52D5\u8ABF\u6574 textarea \u9AD8\u5EA6
      function autoResizeTextarea(textarea) {
        if (!textarea) return;
        textarea.style.height = 'auto';
        textarea.style.height = Math.min(textarea.scrollHeight, 200) + 'px';
        // \u66F4\u65B0\u6309\u9215\u72C0\u614B
        updateSendButtonState();
      }

      // \u767C\u9001\u8A0A\u606F
      async function sendAIMessage() {
        console.log('[AIChat] sendAIMessage called');
        const input = document.getElementById('ai-chat-input');
        if (!input) {
          console.error('[AIChat] Input element not found in sendAIMessage!');
          return;
        }
        
        const message = input.value.trim();
        const sendButton = document.getElementById('ai-send-button');
        
        console.log('[AIChat] Message:', message, 'isLoading:', isLoading);
        
        if (!message || isLoading) {
          console.log('[AIChat] Message empty or already loading, returning');
          return;
        }

        // \u6E05\u7A7A\u8F38\u5165\u6846\u4E26\u7981\u7528\u6309\u9215
        input.value = '';
        input.style.height = 'auto';
        isLoading = true;
        updateSendButtonState();
        
        // \u986F\u793A\u4F7F\u7528\u8005\u8A0A\u606F
        addMessage('user', message);
        
        // \u66F4\u65B0\u7D71\u8A08
        conversationStats.messageCount++;
        conversationStats.userMessages++;
        updateStats();
        
        // \u986F\u793A\u8F09\u5165\u4E2D\uFF08\u6539\u9032\u7684\u6253\u5B57\u6307\u793A\u5668\uFF09
        const loadingId = addTypingIndicator();
        scrollToBottom();

        try {
          console.log('[AIChat] Sending request to /api/ai/query with:', {
            message: message.substring(0, 50) + '...',
            sessionId: aiSessionId
          });
          
          const response = await fetch('/api/ai/query', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              message: message,
              sessionId: aiSessionId
            })
          });

          console.log('[AIChat] Response status:', response.status, response.statusText);
          
          if (!response.ok) {
            const errorText = await response.text();
            console.error('[AIChat] API response not OK:', errorText);
            removeMessage(loadingId);
            addMessage('assistant', '\u62B1\u6B49\uFF0C\u4F3A\u670D\u5668\u767C\u751F\u932F\u8AA4\uFF08\u72C0\u614B\u78BC\uFF1A' + response.status + '\uFF09\uFF0C\u8ACB\u7A0D\u5F8C\u518D\u8A66\u3002');
            isLoading = false;
            updateSendButtonState();
            input.focus();
            return;
          }

          const data = await response.json();
          console.log('[AIChat] Response data:', {
            success: data.success,
            hasMessage: !!data.message,
            messageLength: data.message?.length || 0,
            hasError: !!data.error
          });

          // \u79FB\u9664\u8F09\u5165\u4E2D\u8A0A\u606F
          removeMessage(loadingId);

          if (data.success) {
            // \u4F7F\u7528\u6253\u5B57\u52D5\u756B\u6548\u679C\u986F\u793A AI \u56DE\u8986
            addMessageWithTyping('assistant', data.message);
            // \u66F4\u65B0 sessionId\uFF08\u5982\u679C API \u8FD4\u56DE\u65B0\u7684\uFF09
            if (data.sessionId) {
              aiSessionId = data.sessionId;
            }
            
            // \u6AA2\u6E2C\u662F\u5426\u9700\u8981\u986F\u793A\u5730\u5716\uFF08\u5546\u5BB6\u76F8\u95DC\u554F\u984C\uFF09
            const shouldShowMap = detectMerchantQuery(message) || detectMerchantQuery(data.message);
            if (shouldShowMap) {
              setTimeout(() => {
                showMapInChat();
              }, 1000);
            }
            
            // AI \u56DE\u8986\u5F8C\u986F\u793A\u5FEB\u901F\u56DE\u8986\u5EFA\u8B70
            setTimeout(() => {
              const input = document.getElementById('ai-chat-input');
              if (input && input.value.trim().length === 0) {
                showQuickReplies();
              }
            }, 500);
          } else {
            console.error('[AIChat] AI API Error:', data);
            const errorMessage = data.message || data.error || '\u62B1\u6B49\uFF0C\u767C\u751F\u932F\u8AA4\uFF0C\u8ACB\u7A0D\u5F8C\u518D\u8A66\u3002';
            addMessage('assistant', errorMessage);
            if (data.error) {
              console.error('[AIChat] Error details:', data.error);
            }
          }
        } catch (error) {
          console.error('[AIChat] AI Chat Error:', error);
          console.error('[AIChat] Error stack:', error.stack);
          removeMessage(loadingId);
          
          // \u667A\u80FD\u932F\u8AA4\u8655\u7406\u548C\u91CD\u8A66
          if (retryCount < MAX_RETRIES && (error.message.includes('fetch') || error.message.includes('network'))) {
            retryCount++;
            addMessage('assistant', '\u54CE\u5440\uFF0C\u7DB2\u8DEF\u9023\u7DDA\u6709\u9EDE\u554F\u984C\u3002\u8B93\u6211\u518D\u8A66\u4E00\u6B21...\uFF08\u7B2C ' + retryCount + ' \u6B21\u91CD\u8A66\uFF09');
            setTimeout(() => {
              sendAIMessage();
            }, 2000);
            return;
          } else {
            retryCount = 0;
            addMessage('assistant', '\u62B1\u6B49\uFF0C\u9023\u7DDA\u767C\u751F\u554F\u984C\uFF1A' + (error.message || '\u672A\u77E5\u932F\u8AA4') + '\uFF0C\u8ACB\u7A0D\u5F8C\u518D\u8A66\u3002\u5982\u679C\u554F\u984C\u6301\u7E8C\uFF0C\u53EF\u4EE5\u91CD\u65B0\u6574\u7406\u9801\u9762\u3002');
          }
        } finally {
          if (retryCount === 0) {
            isLoading = false;
            updateSendButtonState();
            input.focus();
          }
        }
      }

      // \u89E3\u6790 AI \u8A0A\u606F\uFF0C\u63D0\u53D6\u53EF\u9EDE\u64CA\u7684\u9078\u9805
      function parseAIMessageOptions(content) {
        const options = [];
        
        // \u6AA2\u6E2C\u8EAB\u4EFD\u9078\u64C7\u554F\u984C
        if (content.includes('\u6F8E\u6E56\u751F\u6D3B\u5C45\u6C11') && (content.includes('\u4F86\u904E\u6F8E\u6E56\u7684\u65C5\u5BA2') || content.includes('\u4F86\u904E\u6F8E\u6E56')) && (content.includes('\u60F3\u4F86\u6F8E\u6E56\u7684\u65C5\u5BA2') || content.includes('\u60F3\u4F86\u6F8E\u6E56'))) {
          options.push(
            { text: '\u6211\u662F\u6F8E\u6E56\u751F\u6D3B\u5C45\u6C11', value: '\u6211\u662F\u6F8E\u6E56\u751F\u6D3B\u5C45\u6C11' },
            { text: '\u6211\u4F86\u904E\u6F8E\u6E56', value: '\u6211\u4F86\u904E\u6F8E\u6E56' },
            { text: '\u6211\u60F3\u4F86\u6F8E\u6E56', value: '\u6211\u60F3\u4F86\u6F8E\u6E56' }
          );
        }
        // \u6AA2\u6E2C\u7C21\u5316\u7248\u672C\u7684\u8EAB\u4EFD\u554F\u984C
        else if (content.includes('\u5C45\u6C11') && content.includes('\u65C5\u5BA2') && (content.includes('\u4F86\u904E') || content.includes('\u60F3\u4F86'))) {
          if (content.includes('\u4F86\u904E') && content.includes('\u60F3\u4F86')) {
            options.push(
              { text: '\u6211\u662F\u5C45\u6C11', value: '\u6211\u662F\u6F8E\u6E56\u751F\u6D3B\u5C45\u6C11' },
              { text: '\u6211\u4F86\u904E', value: '\u6211\u4F86\u904E\u6F8E\u6E56' },
              { text: '\u6211\u60F3\u4F86', value: '\u6211\u60F3\u4F86\u6F8E\u6E56' }
            );
          }
        }
        // \u6AA2\u6E2C\u662F/\u5426\u554F\u984C\uFF08\u4F7F\u7528\u5B57\u7B26\u4E32\u65B9\u6CD5\uFF0C\u907F\u514D\u6B63\u5247\u8868\u9054\u5F0F\uFF09
        else if (content.includes('\u55CE\uFF1F') || content.includes('\u55CE?') || content.includes('\uFF1F') || content.includes('?')) {
          // \u6AA2\u67E5\u662F\u5426\u70BA\u662F/\u5426\u554F\u984C\uFF08\u4F7F\u7528\u5B57\u7B26\u4E32\u65B9\u6CD5\uFF09
          const yesNoKeywords = ['\u662F\u5426', '\u6703\u4E0D\u6703', '\u6709\u6C92\u6709', '\u80FD\u4E0D\u80FD', '\u53EF\u4E0D\u53EF\u4EE5', '\u8981\u4E0D\u8981', '\u60F3\u4E0D\u60F3', '\u9084\u60F3\u4E0D\u60F3'];
          const hasYesNoKeyword = yesNoKeywords.some(keyword => content.includes(keyword));
          
          if (hasYesNoKeyword) {
            // \u63D0\u53D6\u554F\u984C\u7684\u6838\u5FC3\u90E8\u5206\uFF08\u4F7F\u7528\u5B57\u7B26\u4E32\u65B9\u6CD5\uFF09
            const questionEndIndex = Math.min(
              content.indexOf('\u55CE\uFF1F') !== -1 ? content.indexOf('\u55CE\uFF1F') : Infinity,
              content.indexOf('\u55CE?') !== -1 ? content.indexOf('\u55CE?') : Infinity,
              content.indexOf('\uFF1F') !== -1 ? content.indexOf('\uFF1F') : Infinity,
              content.indexOf('?') !== -1 ? content.indexOf('?') : Infinity
            );
            if (questionEndIndex !== Infinity && questionEndIndex > 0) {
              const questionText = content.substring(0, questionEndIndex).trim();
              if (questionText.length > 0) {
              options.push(
                { text: '\u662F', value: '\u662F' },
                { text: '\u4E0D\u662F', value: '\u4E0D\u662F' }
              );
            }
          }
        }
        }
        // \u6AA2\u6E2C\u6578\u5B57\u9078\u9805\uFF08\u4F8B\u5982\uFF1A1. 2. 3.\uFF09\uFF08\u4F7F\u7528\u5B57\u7B26\u4E32\u65B9\u6CD5\uFF09
        else {
          // \u4F7F\u7528\u5B57\u7B26\u4E32\u65B9\u6CD5\u67E5\u627E\u6578\u5B57\u958B\u982D\u7684\u9078\u9805
          const lines = content.split('
');
          const numberedOptions = [];
          for (let i = 0; i < lines.length; i++) {
            const line = lines[i].trim();
            if (line.length === 0) continue;
            
            // \u6AA2\u67E5\u662F\u5426\u4EE5\u6578\u5B57\u958B\u982D\uFF0C\u5F8C\u8DDF . \u6216 \u3001
            let numStart = -1;
            let numEnd = -1;
            for (let j = 0; j < line.length; j++) {
              const char = line.charAt(j);
              if (char >= '0' && char <= '9') {
                if (numStart === -1) numStart = j;
                numEnd = j + 1;
              } else if ((char === '.' || char === '\u3001') && numStart !== -1 && j === numEnd) {
                // \u627E\u5230\u6578\u5B57\u5F8C\u8DDF . \u6216 \u3001
                if (j + 1 < line.length && line.charAt(j + 1) === ' ') {
                  const optionText = line.substring(j + 2).trim();
                  if (optionText.length > 0) {
                    numberedOptions.push(optionText);
                  }
                }
                break;
              } else if (numStart !== -1) {
                break;
              }
            }
          }
          
          if (numberedOptions.length >= 2) {
            numberedOptions.forEach(optionText => {
                options.push({
                text: optionText,
                value: optionText
                });
            });
          }
        }
        
        return options;
      }

      // \u8655\u7406\u6309\u9215\u9EDE\u64CA
      function handleOptionClick(optionValue) {
        console.log('[AIChat] handleOptionClick called with:', optionValue);
        const input = document.getElementById('ai-chat-input');
        if (!input) {
          console.error('[AIChat] Input element not found in handleOptionClick!');
          return;
        }
        
        // \u5982\u679C\u6B63\u5728\u8F09\u5165\uFF0C\u4E0D\u8655\u7406\u65B0\u7684\u9EDE\u64CA
        if (isLoading) {
          console.log('[AIChat] Already loading, ignoring click');
          return;
        }
        
        // \u76F4\u63A5\u767C\u9001\u9078\u9805\u4F5C\u70BA\u8A0A\u606F
        console.log('[AIChat] Setting input value to:', optionValue);
        input.value = optionValue;
        // \u89F8\u767C input \u4E8B\u4EF6\u4EE5\u66F4\u65B0\u6309\u9215\u72C0\u614B
        input.dispatchEvent(new Event('input', { bubbles: true }));
        // \u7A0D\u5FAE\u5EF6\u9072\u4EE5\u78BA\u4FDD\u72C0\u614B\u66F4\u65B0
        setTimeout(() => {
          console.log('[AIChat] Calling sendAIMessage');
          sendAIMessage();
        }, 10);
      }

      // \u6DFB\u52A0\u8A0A\u606F\uFF08\u5E36\u6253\u5B57\u52D5\u756B\u6548\u679C\uFF09
      function addMessageWithTyping(type, content, speed = 30) {
        if (type !== 'assistant') {
          // \u7528\u6236\u8A0A\u606F\u76F4\u63A5\u986F\u793A\uFF0C\u4E0D\u9700\u8981\u6253\u5B57\u6548\u679C
          return addMessage(type, content);
        }

        const messagesContainer = document.getElementById('ai-chat-messages');
        const messageId = 'msg-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
        
        // \u5148\u5275\u5EFA\u4E00\u500B\u7A7A\u7684\u8A0A\u606F\u6846
        const messageDiv = document.createElement('div');
        messageDiv.id = messageId;
        messageDiv.className = 'ai-chat-ai-message';
        messageDiv.setAttribute('data-message-id', messageId);
        messageDiv.innerHTML = 
          '<div class="ai-chat-avatar">' +
            '<div class="ai-chat-avatar-text">\u{1F335}</div>' +
          '</div>' +
          '<div class="ai-chat-message-content">' +
            '<div class="ai-chat-ai-bubble">' +
              '<div class="ai-chat-ai-text markdown-body" id="typing-content-' + messageId + '"></div>' +
              '<div class="ai-chat-message-actions" data-message-id="' + messageId + '">' +
                '<button class="ai-chat-action-button" title="\u91CD\u65B0\u751F\u6210" data-action="regenerate" data-message-id="' + messageId + '">' +
                  '<svg class="ai-chat-action-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">' +
                    '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>' +
                  '</svg>' +
                '</button>' +
                '<button class="ai-chat-action-button" title="\u8907\u88FD" data-action="copy" data-message-id="' + messageId + '">' +
                  '<svg class="ai-chat-action-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">' +
                    '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>' +
                  '</svg>' +
                '</button>' +
              '</div>' +
            '</div>' +
          '</div>';
        
        messagesContainer.appendChild(messageDiv);
        scrollToBottom();
        
        // \u70BA\u6240\u6709\u6309\u9215\u6DFB\u52A0\u4E8B\u4EF6\u76E3\u807D\u5668\uFF08\u907F\u514D onclick \u4E2D\u7684\u8A9E\u6CD5\u932F\u8AA4\uFF09
        setTimeout(() => {
          const actionsDiv = messageDiv.querySelector('.ai-chat-message-actions');
          if (actionsDiv) {
            // \u53CD\u61C9\u6309\u9215
            const reactionButtons = actionsDiv.querySelectorAll('.ai-chat-reaction-button');
            reactionButtons.forEach(button => {
              button.addEventListener('click', function() {
                const msgId = this.getAttribute('data-message-id');
                const reaction = this.getAttribute('data-reaction');
                if (msgId && reaction) {
                  addReaction(msgId, reaction);
                }
              });
            });
            
            // \u91CD\u65B0\u751F\u6210\u6309\u9215
            const regenerateButton = actionsDiv.querySelector('[data-action="regenerate"]');
            if (regenerateButton) {
              regenerateButton.addEventListener('click', function() {
                const msgId = this.getAttribute('data-message-id');
                if (msgId) {
                  regenerateMessage(msgId);
                }
              });
            }
            
            // \u8907\u88FD\u6309\u9215
            const copyButton = actionsDiv.querySelector('[data-action="copy"]');
            if (copyButton) {
              copyButton.addEventListener('click', function() {
                const msgId = this.getAttribute('data-message-id');
                if (msgId) {
                  copyMessage(msgId);
                }
              });
            }
          }
        }, 0);
        
        // \u89E3\u6790\u9078\u9805\uFF08\u5728\u6253\u5B57\u524D\u5148\u89E3\u6790\uFF09
        const options = parseAIMessageOptions(content);
        let processedContent = content;
        
        // \u8655\u7406\u5167\u5BB9\uFF0C\u79FB\u9664\u9078\u9805\u6587\u5B57\uFF08\u4F7F\u7528\u5B57\u7B26\u4E32\u65B9\u6CD5\uFF0C\u907F\u514D\u6B63\u5247\u8868\u9054\u5F0F\uFF09
        if (options.length > 0) {
          if (content.includes('\u6F8E\u6E56\u751F\u6D3B\u5C45\u6C11') && (content.includes('\u4F86\u904E\u6F8E\u6E56\u7684\u65C5\u5BA2') || content.includes('\u4F86\u904E\u6F8E\u6E56')) && (content.includes('\u60F3\u4F86\u6F8E\u6E56\u7684\u65C5\u5BA2') || content.includes('\u60F3\u4F86\u6F8E\u6E56'))) {
            // \u4F7F\u7528\u5B57\u7B26\u4E32\u65B9\u6CD5\u79FB\u9664\u9078\u9805\u6587\u5B57
            processedContent = content;
            const keywords = ['\u6F8E\u6E56\u751F\u6D3B\u5C45\u6C11', '\u4F86\u904E\u6F8E\u6E56\u7684\u65C5\u5BA2', '\u4F86\u904E\u6F8E\u6E56', '\u60F3\u4F86\u6F8E\u6E56\u7684\u65C5\u5BA2', '\u60F3\u4F86\u6F8E\u6E56'];
            keywords.forEach(keyword => {
              const colonIndex = processedContent.indexOf('\uFF1A');
              const colonIndex2 = processedContent.indexOf(':');
              const startIndex = Math.min(
                colonIndex !== -1 ? colonIndex : Infinity,
                colonIndex2 !== -1 ? colonIndex2 : Infinity
              );
              if (startIndex !== Infinity) {
                const keywordIndex = processedContent.indexOf(keyword, startIndex);
                if (keywordIndex !== -1) {
                  // \u79FB\u9664\u5F9E\u5192\u865F\u5230\u95DC\u9375\u5B57\u5F8C\u7684\u9017\u865F\u6216\u9813\u865F
                  let endIndex = keywordIndex + keyword.length;
                  if (endIndex < processedContent.length) {
                    const nextChar = processedContent.charAt(endIndex);
                    if (nextChar === '\u3001' || nextChar === '\uFF0C' || nextChar === ',') {
                      endIndex++;
                    }
                  }
                  processedContent = processedContent.substring(0, startIndex) + processedContent.substring(endIndex);
                }
              }
            });
            // \u79FB\u9664 "\u9084\u662F" \u958B\u982D\u7684\u554F\u984C
            processedContent = processedContent.replace('\u9084\u662F\u60F3\u4F86\u6F8E\u6E56\u7684\u65C5\u5BA2', '\uFF1F');
            processedContent = processedContent.replace('\u9084\u662F\u60F3\u4F86\u6F8E\u6E56', '\uFF1F');
            processedContent = processedContent.replace('\u9084\u662F\u4F86\u904E\u6F8E\u6E56\u7684\u65C5\u5BA2', '\uFF1F');
            processedContent = processedContent.replace('\u9084\u662F\u4F86\u904E\u6F8E\u6E56', '\uFF1F');
          } else {
            // \u79FB\u9664\u6578\u5B57\u958B\u982D\u7684\u9078\u9805\uFF08\u4F7F\u7528\u5B57\u7B26\u4E32\u65B9\u6CD5\uFF09
            const lines = processedContent.split('
');
            const cleanedLines = [];
            for (let i = 0; i < lines.length; i++) {
              const line = lines[i].trim();
              if (line.length === 0) {
                cleanedLines.push(lines[i]);
                continue;
              }
              
              // \u6AA2\u67E5\u662F\u5426\u4EE5\u6578\u5B57\u958B\u982D\uFF0C\u5F8C\u8DDF . \u6216 \u3001
              let isNumberedOption = false;
              for (let j = 0; j < line.length; j++) {
                const char = line.charAt(j);
                if (char >= '0' && char <= '9') {
                  continue;
                } else if ((char === '.' || char === '\u3001') && j > 0) {
                  if (j + 1 < line.length && line.charAt(j + 1) === ' ') {
                    isNumberedOption = true;
                  }
                  break;
                } else {
                  break;
                }
              }
              
              if (!isNumberedOption) {
                cleanedLines.push(lines[i]);
              }
            }
            processedContent = cleanedLines.join('
');
          }
        }
        
        // \u6253\u5B57\u52D5\u756B
        const typingElement = document.getElementById('typing-content-' + messageId);
        if (!typingElement) {
          console.error('[AIChat] Typing element not found:', messageId);
          return messageId;
        }
        let currentIndex = 0;
        // \u78BA\u4FDD processedContent \u662F\u5B57\u7B26\u4E32\uFF0C\u4E26\u6E05\u7406\u53EF\u80FD\u5C0E\u81F4\u8A9E\u6CD5\u932F\u8AA4\u7684\u5B57\u7B26
        let safeContent = String(processedContent || '');
        // \u79FB\u9664\u53EF\u80FD\u5C0E\u81F4\u8A9E\u6CD5\u932F\u8AA4\u7684\u63A7\u5236\u5B57\u7B26\uFF08\u4FDD\u7559\u63DB\u884C\u7B26\u548C\u56DE\u8ECA\u7B26\uFF09
        // \u4F7F\u7528\u5B57\u7B26\u4EE3\u78BC\u6AA2\u67E5\uFF0C\u907F\u514D\u6B63\u5247\u8868\u9054\u5F0F\u5B57\u7B26\u985E\u7BC4\u570D\u554F\u984C
        let cleanedContent = '';
        for (let i = 0; i < safeContent.length; i++) {
          const charCode = safeContent.charCodeAt(i);
          // \u4FDD\u7559\u63DB\u884C\u7B26(10)\u3001\u56DE\u8ECA\u7B26(13)\u3001\u6C34\u5E73\u88FD\u8868\u7B26(9)
          // \u79FB\u9664\u5176\u4ED6\u63A7\u5236\u5B57\u7B26(0-8, 11-12, 14-31, 127)
          if (charCode === 9 || charCode === 10 || charCode === 13 || (charCode >= 32 && charCode !== 127)) {
            cleanedContent += safeContent.charAt(i);
          }
        }
        const fullText = cleanedContent;
        
        // \u78BA\u4FDD fullText.length \u662F\u6709\u6548\u7684\u6578\u5B57
        const fullTextLength = typeof fullText.length === 'number' ? fullText.length : 0;
        
        function typeNextChar() {
          if (currentIndex < fullTextLength) {
            const char = fullText.charAt(currentIndex);
            const nextChar = currentIndex + 1 < fullTextLength ? fullText.charAt(currentIndex + 1) : '';
            
            // \u5982\u679C\u662F\u63DB\u884C\u6216\u6A19\u9EDE\u7B26\u865F\uFF0C\u7A0D\u5FAE\u5EF6\u9072
            let delay = speed;
            const charCode = char.charCodeAt ? char.charCodeAt(0) : 0;
            // \u4F7F\u7528\u5B57\u7B26\u4EE3\u78BC\u6BD4\u8F03\uFF0C\u907F\u514D\u6A21\u677F\u5B57\u7B26\u4E32\u4E2D\u7684Unicode\u8F49\u7FA9\u554F\u984C
            // \u63DB\u884C\u7B26(10)\u3001\u53E5\u865F(12290)\u3001\u9A5A\u5606\u865F(65281)\u3001\u554F\u865F(65311)\u3001\u9017\u865F(65292)
            if (charCode === 10 || charCode === 12290 || charCode === 65281 || charCode === 65311 || charCode === 65292) {
              delay = speed * 2;
            } else if (char === ' ' && nextChar === ' ') {
              delay = speed * 1.5;
            }
            
            // \u5B89\u5168\u5730\u8A2D\u7F6E textContent
            try {
              const startPos = 0;
              const endPos = currentIndex + 1;
              const displayText = fullText.substring(startPos, endPos);
              if (typingElement) {
                typingElement.textContent = displayText;
              }
            } catch (e) {
              console.error('[AIChat] Error setting textContent:', e);
              if (typingElement) {
                typingElement.textContent = '';
              }
            }
            
            // \u4F7F\u7528\u7C21\u6613 Markdown \u6E32\u67D3\uFF08\u5728\u6253\u5B57\u5B8C\u6210\u5F8C\uFF09
            if (currentIndex >= fullTextLength - 1) {
              try {
                const content = typingElement.textContent || '';
                if (content) {
                  typingElement.innerHTML = parseMarkdown(content);
                }
              } catch (error) {
                console.error('[AIChat] parseMarkdown error:', error);
                // \u5982\u679C\u89E3\u6790\u5931\u6557\uFF0C\u76F4\u63A5\u4F7F\u7528\u539F\u59CB\u6587\u672C\u4E26\u8F49\u63DB\u63DB\u884C\uFF08\u4F7F\u7528\u5B57\u7B26\u4E32\u65B9\u6CD5\uFF09
                const originalText = typingElement.textContent || '';
                let safeHtml = '';
                for (let k = 0; k < originalText.length; k++) {
                  const ch = originalText.charAt(k);
                  if (ch === '
') {
                    safeHtml += '<br>';
                  } else {
                    safeHtml += ch;
                  }
                }
                typingElement.innerHTML = safeHtml;
              }
              // \u5982\u679C\u6709\u9078\u9805\uFF0C\u5728\u6253\u5B57\u5B8C\u6210\u5F8C\u6DFB\u52A0
              if (options.length > 0) {
                addOptionsToMessage(messageId, options);
              }
              
              // \u66F4\u65B0\u5DF2\u8B80\u72C0\u614B
              const readStatus = document.getElementById('read-status-' + messageId);
              if (readStatus) {
                readStatus.textContent = '\u2713';
                readStatus.setAttribute('title', '\u5DF2\u8B80');
                readStatus.classList.add('read');
              }
              
              // \u986F\u793A\u64CD\u4F5C\u6309\u9215\uFF08\u6253\u5B57\u5B8C\u6210\u5F8C\uFF09
              setTimeout(() => {
                const messageDiv = document.getElementById(messageId);
                if (messageDiv) {
                  const actionsDiv = messageDiv.querySelector('.ai-chat-message-actions');
                  if (actionsDiv) {
                    actionsDiv.style.opacity = '1';
                  }
                }
              }, 100);
            }
            
            currentIndex++;
            if (currentIndex < fullTextLength) {
              setTimeout(typeNextChar, delay);
            }
            scrollToBottom();
          }
        }
        
        // \u958B\u59CB\u6253\u5B57
        if (fullTextLength > 0) {
          typeNextChar();
        } else {
          // \u5982\u679C\u5167\u5BB9\u70BA\u7A7A\uFF0C\u76F4\u63A5\u986F\u793A
          typingElement.textContent = '';
        }
        
        return messageId;
      }

      // \u6DFB\u52A0\u9078\u9805\u5230\u8A0A\u606F
      function addOptionsToMessage(messageId, options) {
        const messageDiv = document.getElementById(messageId);
        if (!messageDiv) return;
        
        const bubble = messageDiv.querySelector('.ai-chat-ai-bubble');
        if (!bubble) return;
        
        const containerId = 'options-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
        let optionsHtml = '<div class="ai-chat-options-container" id="' + containerId + '">';
        options.forEach(option => {
          optionsHtml += '<button class="ai-chat-option-button" data-option="' + escapeHtml(option.value) + '">' + escapeHtml(option.text) + '</button>';
        });
        optionsHtml += '</div>';
        
        bubble.insertAdjacentHTML('beforeend', optionsHtml);
        
        // \u70BA\u6309\u9215\u6DFB\u52A0\u4E8B\u4EF6\u76E3\u807D\u5668
        setTimeout(() => {
          const container = document.getElementById(containerId);
          if (container) {
            const buttons = container.querySelectorAll('.ai-chat-option-button');
            buttons.forEach(button => {
              button.addEventListener('click', function() {
                const optionValue = this.getAttribute('data-option');
                if (optionValue) {
                  handleOptionClick(optionValue);
                }
              });
            });
          }
        }, 0);
      }

      // \u6DFB\u52A0\u6253\u5B57\u6307\u793A\u5668\uFF08\u6539\u9032\u7248\uFF09
      function addTypingIndicator() {
        const messagesContainer = document.getElementById('ai-chat-messages');
        const messageId = 'typing-' + Date.now();
        
        const messageDiv = document.createElement('div');
        messageDiv.id = messageId;
        messageDiv.className = 'ai-chat-ai-message ai-chat-typing-indicator';
        messageDiv.innerHTML = 
          '<div class="ai-chat-avatar">' +
            '<div class="ai-chat-avatar-text">\u{1F335}</div>' +
          '</div>' +
          '<div class="ai-chat-message-content">' +
            '<div class="ai-chat-ai-bubble">' +
              '<div class="typing-indicator-enhanced">' +
                '<span></span><span></span><span></span>' +
              '</div>' +
              '<span class="typing-text">\u6B63\u5728\u8F38\u5165...</span>' +
            '</div>' +
          '</div>';
        
        messagesContainer.appendChild(messageDiv);
        scrollToBottom();
        return messageId;
      }

      // \u6DFB\u52A0\u8A0A\u606F
      function addMessage(type, content, isTemporary = false) {
        const messagesContainer = document.getElementById('ai-chat-messages');
        const messageId = isTemporary ? 'temp-' + Date.now() : null;
        
        const messageDiv = document.createElement('div');
        if (messageId) messageDiv.id = messageId;
        messageDiv.classList.add('ai-chat-message-fade-in');
        
        // \u6DFB\u52A0\u6642\u9593\u6233\u8A18
        const timestamp = new Date().toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit' });
        
        if (type === 'user') {
          messageDiv.className = 'ai-chat-user-message ai-chat-message-fade-in';
          messageDiv.innerHTML = 
            '<div class="ai-chat-user-bubble">' +
              '<p class="ai-chat-user-text">' + escapeHtml(content) + '</p>' +
              '<span class="ai-chat-timestamp">' + timestamp + '</span>' +
            '</div>';
        } else {
          // \u89E3\u6790 AI \u8A0A\u606F\uFF0C\u63D0\u53D6\u53EF\u9EDE\u64CA\u7684\u9078\u9805
          const options = parseAIMessageOptions(content);
          
          // \u8655\u7406\u5167\u5BB9\uFF0C\u5C07\u9078\u9805\u90E8\u5206\u6A19\u8A18\u51FA\u4F86
          let processedContent = content;
          let optionsHtml = '';
          
          if (options.length > 0) {
            // ... (options logic unchanged) ...
            // \u5982\u679C\u6709\u9078\u9805\uFF0C\u751F\u6210\u6309\u9215 HTML\uFF08\u4F7F\u7528 data-option \u5C6C\u6027\u800C\u4E0D\u662F onclick\uFF09
            const containerId = 'options-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
            optionsHtml = '<div class="ai-chat-options-container" id="' + containerId + '">';
            options.forEach(option => {
              optionsHtml += '<button class="ai-chat-option-button" data-option="' + escapeHtml(option.value) + '">' + escapeHtml(option.text) + '</button>';
            });
            optionsHtml += '</div>';
            
            // \u5728\u8A0A\u606F\u6DFB\u52A0\u5F8C\uFF0C\u70BA\u6309\u9215\u6DFB\u52A0\u4E8B\u4EF6\u76E3\u807D\u5668
            setTimeout(() => {
              const container = document.getElementById(containerId);
              if (container) {
                const buttons = container.querySelectorAll('.ai-chat-option-button');
                buttons.forEach(button => {
                  button.addEventListener('click', function() {
                    const optionValue = this.getAttribute('data-option');
                    if (optionValue) {
                      handleOptionClick(optionValue);
                    }
                  });
                });
              }
            }, 0);
            
            // \u5F9E\u5167\u5BB9\u4E2D\u79FB\u9664\u9078\u9805\u6587\u5B57\uFF08\u907F\u514D\u91CD\u8907\u986F\u793A\uFF0C\u4F7F\u7528\u5B57\u7B26\u4E32\u65B9\u6CD5\uFF09
            if (content.includes('\u6F8E\u6E56\u751F\u6D3B\u5C45\u6C11') && (content.includes('\u4F86\u904E\u6F8E\u6E56\u7684\u65C5\u5BA2') || content.includes('\u4F86\u904E\u6F8E\u6E56')) && (content.includes('\u60F3\u4F86\u6F8E\u6E56\u7684\u65C5\u5BA2') || content.includes('\u60F3\u4F86\u6F8E\u6E56'))) {
              // \u4F7F\u7528\u5B57\u7B26\u4E32\u65B9\u6CD5\u79FB\u9664\u9078\u9805\u6587\u5B57
              processedContent = content;
              const keywords = ['\u6F8E\u6E56\u751F\u6D3B\u5C45\u6C11', '\u4F86\u904E\u6F8E\u6E56\u7684\u65C5\u5BA2', '\u4F86\u904E\u6F8E\u6E56', '\u60F3\u4F86\u6F8E\u6E56\u7684\u65C5\u5BA2', '\u60F3\u4F86\u6F8E\u6E56'];
              keywords.forEach(keyword => {
                const colonIndex = processedContent.indexOf('\uFF1A');
                const colonIndex2 = processedContent.indexOf(':');
                const startIndex = Math.min(
                  colonIndex !== -1 ? colonIndex : Infinity,
                  colonIndex2 !== -1 ? colonIndex2 : Infinity
                );
                if (startIndex !== Infinity) {
                  const keywordIndex = processedContent.indexOf(keyword, startIndex);
                  if (keywordIndex !== -1) {
                    // \u79FB\u9664\u5F9E\u5192\u865F\u5230\u95DC\u9375\u5B57\u5F8C\u7684\u9017\u865F\u6216\u9813\u865F
                    let endIndex = keywordIndex + keyword.length;
                    if (endIndex < processedContent.length) {
                      const nextChar = processedContent.charAt(endIndex);
                      if (nextChar === '\u3001' || nextChar === '\uFF0C' || nextChar === ',') {
                        endIndex++;
                      }
                    }
                    processedContent = processedContent.substring(0, startIndex) + processedContent.substring(endIndex);
                  }
                }
              });
              // \u79FB\u9664 "\u9084\u662F" \u958B\u982D\u7684\u554F\u984C
              processedContent = processedContent.replace('\u9084\u662F\u60F3\u4F86\u6F8E\u6E56\u7684\u65C5\u5BA2', '\uFF1F');
              processedContent = processedContent.replace('\u9084\u662F\u60F3\u4F86\u6F8E\u6E56', '\uFF1F');
              processedContent = processedContent.replace('\u9084\u662F\u4F86\u904E\u6F8E\u6E56\u7684\u65C5\u5BA2', '\uFF1F');
              processedContent = processedContent.replace('\u9084\u662F\u4F86\u904E\u6F8E\u6E56', '\uFF1F');
            } else {
              // \u79FB\u9664\u6578\u5B57\u958B\u982D\u7684\u9078\u9805\uFF08\u4F7F\u7528\u5B57\u7B26\u4E32\u65B9\u6CD5\uFF09
              const lines = processedContent.split('
');
              const cleanedLines = [];
              for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                if (line.length === 0) {
                  cleanedLines.push(lines[i]);
                  continue;
                }
                
                // \u6AA2\u67E5\u662F\u5426\u4EE5\u6578\u5B57\u958B\u982D\uFF0C\u5F8C\u8DDF . \u6216 \u3001
                let isNumberedOption = false;
                for (let j = 0; j < line.length; j++) {
                  const char = line.charAt(j);
                  if (char >= '0' && char <= '9') {
                    continue;
                  } else if ((char === '.' || char === '\u3001') && j > 0) {
                    if (j + 1 < line.length && line.charAt(j + 1) === ' ') {
                      isNumberedOption = true;
                    }
                    break;
                  } else {
                    break;
                  }
                }
                
                if (!isNumberedOption) {
                  cleanedLines.push(lines[i]);
                }
              }
              processedContent = cleanedLines.join('
');
            }
          }
          
          // \u4F7F\u7528\u7C21\u6613 Markdown \u6E32\u67D3\u5668
          const renderedContent = parseMarkdown(processedContent);
          
          messageDiv.className = 'ai-chat-ai-message';
          const messageId = 'msg-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
          messageDiv.setAttribute('data-message-id', messageId);
          messageDiv.innerHTML = 
            '<div class="ai-chat-avatar">' +
              '<div class="ai-chat-avatar-text">\u{1F335}</div>' +
            '</div>' +
            '<div class="ai-chat-message-content">' +
              '<div class="ai-chat-ai-bubble">' +
                '<div class="ai-chat-ai-text markdown-body">' + renderedContent + '</div>' +
                optionsHtml +
                '<div class="ai-chat-message-actions" data-message-id="' + messageId + '">' +
                  '<button class="ai-chat-action-button ai-chat-reaction-button" title="\u{1F44D}" data-reaction="\u{1F44D}" data-message-id="' + messageId + '">\u{1F44D}</button>' +
                  '<button class="ai-chat-action-button ai-chat-reaction-button" title="\u2764\uFE0F" data-reaction="\u2764\uFE0F" data-message-id="' + messageId + '">\u2764\uFE0F</button>' +
                  '<button class="ai-chat-action-button ai-chat-reaction-button" title="\u{1F604}" data-reaction="\u{1F604}" data-message-id="' + messageId + '">\u{1F604}</button>' +
                  '<button class="ai-chat-action-button" title="\u91CD\u65B0\u751F\u6210" data-action="regenerate" data-message-id="' + messageId + '">' +
                    '<svg class="ai-chat-action-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">' +
                      '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>' +
                    '</svg>' +
                  '</button>' +
                  '<button class="ai-chat-action-button" title="\u8907\u88FD" data-action="copy" data-message-id="' + messageId + '">' +
                    '<svg class="ai-chat-action-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">' +
                      '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>' +
                    '</svg>' +
                  '</button>' +
                '</div>' +
              '</div>' +
            '</div>';
        }
        
        messagesContainer.appendChild(messageDiv);
        scrollToBottom();
        
        // \u70BA\u6240\u6709\u6309\u9215\u6DFB\u52A0\u4E8B\u4EF6\u76E3\u807D\u5668\uFF08\u907F\u514D onclick \u4E2D\u7684\u8A9E\u6CD5\u932F\u8AA4\uFF09
        setTimeout(() => {
          const actionsDiv = messageDiv.querySelector('.ai-chat-message-actions');
          if (actionsDiv) {
            // \u53CD\u61C9\u6309\u9215
            const reactionButtons = actionsDiv.querySelectorAll('.ai-chat-reaction-button');
            reactionButtons.forEach(button => {
              button.addEventListener('click', function() {
                const msgId = this.getAttribute('data-message-id');
                const reaction = this.getAttribute('data-reaction');
                if (msgId && reaction) {
                  addReaction(msgId, reaction);
                }
              });
            });
            
            // \u91CD\u65B0\u751F\u6210\u6309\u9215
            const regenerateButton = actionsDiv.querySelector('[data-action="regenerate"]');
            if (regenerateButton) {
              regenerateButton.addEventListener('click', function() {
                const msgId = this.getAttribute('data-message-id');
                if (msgId) {
                  regenerateMessage(msgId);
                }
              });
            }
            
            // \u8907\u88FD\u6309\u9215
            const copyButton = actionsDiv.querySelector('[data-action="copy"]');
            if (copyButton) {
              copyButton.addEventListener('click', function() {
                const msgId = this.getAttribute('data-message-id');
                if (msgId) {
                  copyMessage(msgId);
                }
              });
            }
          }
        }, 0);
        
        return messageId;
      }

      // \u79FB\u9664\u8A0A\u606F
      function removeMessage(messageId) {
        if (messageId) {
          const message = document.getElementById(messageId);
          if (message) {
            message.remove();
          }
        }
      }

      // \u6EFE\u52D5\u5230\u5E95\u90E8\uFF08\u512A\u5316\u79FB\u52D5\u7AEF\uFF09
      function scrollToBottom() {
        const messagesContainer = document.getElementById('ai-chat-messages');
        if (!messagesContainer) return;
        
        // \u4F7F\u7528 requestAnimationFrame \u512A\u5316\u6027\u80FD
        requestAnimationFrame(() => {
          messagesContainer.scrollTop = messagesContainer.scrollHeight;
          
          // \u79FB\u52D5\u7AEF\u984D\u5916\u512A\u5316\uFF1A\u5E73\u6ED1\u6EFE\u52D5
          if (window.innerWidth <= 768) {
            messagesContainer.scrollTo({
              top: messagesContainer.scrollHeight,
              behavior: 'smooth'
            });
          }
        });
      }

      // \u6AA2\u6E2C\u79FB\u52D5\u7AEF\uFF08\u4F7F\u7528\u5B57\u7B26\u4E32\u65B9\u6CD5\uFF0C\u907F\u514D\u6B63\u5247\u8868\u9054\u5F0F\uFF09
      function isMobile() {
        if (window.innerWidth <= 768) return true;
        const ua = navigator.userAgent || '';
        const uaLower = ua.toLowerCase();
        const mobileKeywords = ['android', 'webos', 'iphone', 'ipad', 'ipod', 'blackberry', 'iemobile', 'opera mini'];
        return mobileKeywords.some(keyword => uaLower.indexOf(keyword) !== -1);
      }

      // \u79FB\u52D5\u7AEF\u9375\u76E4\u9069\u914D
      function handleMobileKeyboard() {
        if (!isMobile()) return;
        
        const input = document.getElementById('ai-chat-input');
        const messagesContainer = document.getElementById('ai-chat-messages');
        
        if (!input || !messagesContainer) return;
        
        // \u7576\u8F38\u5165\u6846\u7372\u5F97\u7126\u9EDE\u6642\uFF0C\u6EFE\u52D5\u5230\u5E95\u90E8
        input.addEventListener('focus', () => {
          setTimeout(() => {
            scrollToBottom();
          }, 300); // \u7B49\u5F85\u9375\u76E4\u5F48\u51FA
        });
        
        // \u76E3\u807D\u8996\u7A97\u5927\u5C0F\u8B8A\u5316\uFF08\u9375\u76E4\u5F48\u51FA/\u6536\u8D77\uFF09
        let lastHeight = window.innerHeight;
        window.addEventListener('resize', () => {
          const currentHeight = window.innerHeight;
          if (Math.abs(currentHeight - lastHeight) > 150) {
            // \u9375\u76E4\u5F48\u51FA\u6216\u6536\u8D77
            setTimeout(() => {
              scrollToBottom();
            }, 100);
            lastHeight = currentHeight;
          }
        });
      }

      // \u7D71\u8A08\u6578\u64DA
      const conversationStats = {
        messageCount: 0,
        userMessages: 0
      };

      // \u6839\u64DA\u6642\u9593\u7372\u53D6\u554F\u5019\u8A9E
      function getTimeBasedGreeting() {
        const hour = new Date().getHours();
        if (hour >= 5 && hour < 12) return '\u65E9\u5B89\uFF01\u7F8E\u597D\u7684\u4E00\u5929\u958B\u59CB\u4E86\uFF01\u2600\uFE0F';
        if (hour >= 12 && hour < 18) return '\u5348\u5B89\uFF01\u4ECA\u5929\u904E\u5F97\u597D\u55CE\uFF1F\u2615';
        if (hour >= 18 && hour < 22) return '\u665A\u4E0A\u597D\uFF01\u5403\u904E\u665A\u9910\u4E86\u55CE\uFF1F\u{1F319}';
        return '\u9019\u9EBC\u665A\u9084\u5728\uFF1F\u8981\u6CE8\u610F\u4F11\u606F\u5594\uFF01\u2728';
      }

      // \u66F4\u65B0\u7D71\u8A08\u986F\u793A
      function updateStats() {
        const totalEl = document.getElementById('stats-total-messages');
        const userEl = document.getElementById('stats-user-messages');
        if (totalEl) totalEl.textContent = conversationStats.messageCount;
        if (userEl) userEl.textContent = conversationStats.userMessages;
      }

      // Modal \u63A7\u5236\u51FD\u6578
      function showStatsModal() {
        const modal = document.getElementById('ai-chat-stats-modal');
        if (modal) {
          updateStats(); // \u6253\u958B\u6642\u66F4\u65B0\u6578\u64DA
          modal.classList.remove('hidden');
        }
      }

      function closeStatsModal() {
        const modal = document.getElementById('ai-chat-stats-modal');
        if (modal) modal.classList.add('hidden');
      }

      function showShareModal() {
        const modal = document.getElementById('ai-chat-share-modal');
        if (modal) modal.classList.remove('hidden');
      }

      function closeShareModal() {
        const modal = document.getElementById('ai-chat-share-modal');
        if (modal) modal.classList.add('hidden');
      }

      // \u5206\u4EAB\u529F\u80FD\u5BE6\u4F5C
      function shareToClipboard() {
        const url = window.location.href;
        navigator.clipboard.writeText(url).then(() => {
          if (window.showToast) window.showToast(MESSAGES.linkCopied, 'success');
          else alert(MESSAGES.linkCopied);
          closeShareModal();
        });
      }

       function exportToText() {
         const messages = [];
         document.querySelectorAll('.ai-chat-user-text, .ai-chat-ai-text').forEach(el => {
           const isUser = el.classList.contains('ai-chat-user-text');
           const text = el.textContent.trim();
           messages.push((isUser ? '\u6211' : 'AI') + ': ' + text);
         });
         
         const newline = String.fromCharCode(10);
         const text = messages.join(newline + newline);
         const blob = new Blob([text], { type: 'text/plain' });
         const a = document.createElement('a');
         a.href = URL.createObjectURL(blob);
         a.download = 'penghu-chat-' + new Date().toISOString().slice(0, 10) + '.txt';
         a.click();
         closeShareModal();
       }

      function resetConversation() {
        if (!confirm(MESSAGES.confirmReset)) return;
        window.location.reload();
      }

      // \u5C07\u51FD\u6578\u66B4\u9732\u7D66\u5168\u57DF\u4EE5\u4FBF HTML onclick \u8ABF\u7528
      window.closeStatsModal = closeStatsModal;
      window.closeShareModal = closeShareModal;
      window.shareToClipboard = shareToClipboard;
      window.exportToText = exportToText;
      window.resetConversation = resetConversation;
      window.regenerateMessage = regenerateMessage;
      window.copyMessage = copyMessage;
      window.addReaction = addReaction;
      window.showStatsModal = showStatsModal;
      window.showShareModal = showShareModal;

      // \u7C21\u6613 Markdown \u89E3\u6790\u5668\uFF08\u5B8C\u5168\u4F7F\u7528\u5B57\u7B26\u4E32\u65B9\u6CD5\uFF0C\u907F\u514D\u6B63\u5247\u8868\u9054\u5F0F\uFF09
      function parseMarkdown(text) {
        // \u9632\u79A6\u6027\u6AA2\u67E5
        if (!text) return '';
        if (text === null || text === undefined) return '';
        
        // \u78BA\u4FDD\u8F38\u5165\u662F\u5B57\u7B26\u4E32
        if (typeof text !== 'string') {
          try {
            text = String(text);
          } catch (e) {
            console.error('[AIChat] parseMarkdown: Failed to convert to string:', e);
            return '';
          }
        }
        
        // \u984D\u5916\u7684\u5B89\u5168\u6AA2\u67E5\uFF1A\u78BA\u4FDD text \u662F\u6709\u6548\u7684\u5B57\u7B26\u4E32
        if (typeof text !== 'string' || text.length === undefined) {
          console.error('[AIChat] parseMarkdown: Invalid text type:', typeof text);
          return '';
        }
        
        try {
          // \u4F7F\u7528\u5B89\u5168\u7684\u5B57\u7B26\u4E32\u65B9\u6CD5\u8655\u7406\uFF0C\u5B8C\u5168\u907F\u514D\u6B63\u5247\u8868\u9054\u5F0F\u89E3\u6790\u554F\u984C
          let html = '';
          
          // \u624B\u52D5\u8F49\u7FA9 HTML \u7279\u6B8A\u5B57\u7B26\uFF08\u907F\u514D\u6B63\u5247\u8868\u9054\u5F0F\uFF09
          // \u4F7F\u7528\u986F\u5F0F\u7684\u5B57\u7B26\u4EE3\u78BC\u6AA2\u67E5\uFF0C\u907F\u514D\u4EFB\u4F55\u53EF\u80FD\u7684\u89E3\u6790\u554F\u984C
          for (let i = 0; i < text.length; i++) {
            const char = text.charAt(i);
            const charCode = text.charCodeAt(i);
            
            // \u4F7F\u7528\u5B57\u7B26\u4EE3\u78BC\u9032\u884C\u7CBE\u78BA\u5339\u914D\uFF0C\u907F\u514D\u5B57\u7B26\u6BD4\u8F03\u554F\u984C
            if (charCode === 38) { // &
              html += '&amp;';
            } else if (charCode === 60) { // <
              html += '&lt;';
            } else if (charCode === 62) { // >
              html += '&gt;';
            } else if (charCode === 34) { // "
              html += '&quot;';
            } else if (charCode === 39) { // '
              html += '&#39;';
            } else {
              html += char;
            }
          }
          
          // \u6309\u884C\u8655\u7406
          const lines = html.split('
');
          const processedLines = [];
          
          for (let i = 0; i < lines.length; i++) {
            let line = lines[i];
            const trimmed = line.trim();
            
            // \u8655\u7406\u6A19\u984C\uFF08\u4F7F\u7528\u5B57\u7B26\u4E32\u65B9\u6CD5\uFF09
            if (trimmed.indexOf('### ') === 0) {
              const title = trimmed.substring(4);
              line = '<h3 class="font-bold text-lg my-2">' + title + '</h3>';
            } else if (trimmed.indexOf('## ') === 0) {
              const title = trimmed.substring(3);
              line = '<h2 class="font-bold text-xl my-2">' + title + '</h2>';
            } else if (trimmed.indexOf('# ') === 0) {
              const title = trimmed.substring(2);
              line = '<h1 class="font-bold text-2xl my-2">' + title + '</h1>';
            }
            // \u8655\u7406\u7121\u5E8F\u5217\u8868
            else if (trimmed.indexOf('- ') === 0) {
              const content = trimmed.substring(2);
              line = '<li class="ml-4 list-disc">' + content + '</li>';
            }
            // \u8655\u7406\u6709\u5E8F\u5217\u8868\uFF08\u4F7F\u7528\u7C21\u55AE\u7684\u5B57\u7B26\u4E32\u6AA2\u67E5\uFF09
            else {
              let numMatch = false;
              let numEnd = -1;
              for (let j = 0; j < trimmed.length; j++) {
                const c = trimmed.charAt(j);
                if (c >= '0' && c <= '9') {
                  continue;
                } else if (c === '.' && j > 0) {
                  numEnd = j;
                  if (j + 1 < trimmed.length && trimmed.charAt(j + 1) === ' ') {
                    const content = trimmed.substring(j + 2);
                    line = '<li class="ml-4 list-decimal">' + content + '</li>';
                    numMatch = true;
                    break;
                  }
                } else {
                  break;
                }
              }
            }
            
            processedLines.push(line);
          }
          
          html = processedLines.join('<br>');
          
          // \u8655\u7406\u7C97\u9AD4\uFF08\u4F7F\u7528\u5B57\u7B26\u4E32\u65B9\u6CD5\uFF0C\u907F\u514D\u6B63\u5247\u8868\u9054\u5F0F\uFF09
          let result = '';
          let inBold = false;
          let boldStart = -1;
          
          for (let i = 0; i < html.length; i++) {
            if (html.charAt(i) === '*' && i + 1 < html.length && html.charAt(i + 1) === '*') {
              if (!inBold) {
                inBold = true;
                boldStart = i + 2;
                i++; // \u8DF3\u904E\u7B2C\u4E8C\u500B *
              } else {
                inBold = false;
                const boldText = html.substring(boldStart, i);
                result += '<strong>' + boldText + '</strong>';
                i++; // \u8DF3\u904E\u7B2C\u4E8C\u500B *
              }
            } else if (!inBold) {
              result += html.charAt(i);
            }
          }
          
          // \u5982\u679C\u9084\u6709\u672A\u95DC\u9589\u7684\u7C97\u9AD4\u6A19\u7C64
          if (inBold) {
            result += html.substring(boldStart);
          }
          
          return result || html;
        } catch (error) {
          console.error('[AIChat] parseMarkdown error:', error);
          console.error('[AIChat] parseMarkdown error text:', typeof text, text ? text.substring(0, 100) : 'null');
          // \u5982\u679C\u89E3\u6790\u5931\u6557\uFF0C\u8FD4\u56DE\u8F49\u7FA9\u5F8C\u7684\u7D14\u6587\u672C\uFF08\u4F7F\u7528\u5B57\u7B26\u4E32\u65B9\u6CD5\uFF09
          let safe = '';
          try {
            const safeText = String(text || '');
            for (let i = 0; i < safeText.length; i++) {
              const charCode = safeText.charCodeAt(i);
              // \u4F7F\u7528\u5B57\u7B26\u4EE3\u78BC\u9032\u884C\u7CBE\u78BA\u5339\u914D
              if (charCode === 38) { // &
                safe += '&amp;';
              } else if (charCode === 60) { // <
                safe += '&lt;';
              } else if (charCode === 62) { // >
                safe += '&gt;';
              } else if (charCode === 34) { // "
                safe += '&quot;';
              } else if (charCode === 39) { // '
                safe += '&#39;';
              } else if (charCode === 10) { // 

                safe += '<br>';
              } else {
                safe += safeText.charAt(i);
              }
            }
          } catch (e) {
            console.error('[AIChat] parseMarkdown: Error in fallback:', e);
            return '';
          }
          return safe;
        }
      }

      // HTML \u8F49\u7FA9
      function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }

      // \u70BA\u6B61\u8FCE\u8A0A\u606F\u7684\u6309\u9215\u6DFB\u52A0\u4E8B\u4EF6\u76E3\u807D\u5668\uFF08\u5728 DOM \u8F09\u5165\u5F8C\uFF09
      function setupWelcomeButtons() {
        console.log('[AIChat] setupWelcomeButtons called');
        const welcomeOptions = document.getElementById('welcome-options');
        if (welcomeOptions) {
          console.log('[AIChat] Found welcome-options container');
          const buttons = welcomeOptions.querySelectorAll('.ai-chat-option-button');
          console.log('[AIChat] Found', buttons.length, 'buttons');
          buttons.forEach((button, index) => {
            // \u79FB\u9664\u820A\u7684\u4E8B\u4EF6\u76E3\u807D\u5668\uFF08\u5982\u679C\u6709\u7684\u8A71\uFF09
            const newButton = button.cloneNode(true);
            button.parentNode.replaceChild(newButton, button);
            
            newButton.addEventListener('click', function(e) {
              e.preventDefault();
              e.stopPropagation();
              console.log('[AIChat] Button clicked, index:', index);
              const optionValue = this.getAttribute('data-option');
              console.log('[AIChat] Button data-option:', optionValue);
              if (optionValue) {
                handleOptionClick(optionValue);
              } else {
                console.error('[AIChat] No data-option attribute found on button');
              }
            });
            console.log('[AIChat] Event listener added to button', index);
          });
        } else {
          console.warn('[AIChat] welcome-options container not found');
        }
      }

      // \u6AA2\u6E2C\u5546\u5BB6\u76F8\u95DC\u67E5\u8A62
      function detectMerchantQuery(text) {
        if (!text) return false;
        const lowerText = text.toLowerCase();
        const merchantKeywords = ['\u5546\u5BB6', '\u5E97\u5BB6', '\u767B\u5165', '\u65B0\u589E\u5730\u9EDE', 'google maps', 'google map', '\u5730\u5716', '\u9EDE\u9078\u5730\u9EDE', '\u9078\u64C7\u5730\u9EDE'];
        return merchantKeywords.some(keyword => lowerText.includes(keyword));
      }

      // \u5728\u804A\u5929\u4E2D\u986F\u793A\u5730\u5716
      function showMapInChat() {
        const messagesContainer = document.getElementById('ai-chat-messages');
        if (!messagesContainer) return;

        // \u6AA2\u67E5\u662F\u5426\u5DF2\u7D93\u6709\u5730\u5716
        if (document.getElementById('ai-chat-map-container')) {
          return;
        }

        // \u5275\u5EFA\u5730\u5716\u5BB9\u5668
        const mapContainer = document.createElement('div');
        mapContainer.id = 'ai-chat-map-container';
        mapContainer.className = 'ai-chat-map-container';
        mapContainer.innerHTML = 
          '<div class="ai-chat-map-header">' +
            '<h3>\u{1F5FA}\uFE0F \u9078\u64C7\u60A8\u7684\u5730\u9EDE\u4F4D\u7F6E</h3>' +
            '<p>\u8ACB\u5728\u5730\u5716\u4E0A\u9EDE\u64CA\u9078\u64C7\u60A8\u7684\u5730\u9EDE\uFF0C\u6216\u4F7F\u7528\u641C\u5C0B\u6846\u641C\u5C0B\u5730\u9EDE</p>' +
          '</div>' +
          '<div class="ai-chat-map-search">' +
            '<input type="text" id="ai-chat-map-search" placeholder="\u641C\u5C0B\u5730\u9EDE..." class="ai-chat-map-search-input">' +
          '</div>' +
          '<div id="ai-chat-map" class="ai-chat-map"></div>' +
          '<div class="ai-chat-map-actions">' +
            '<button id="ai-chat-map-confirm" class="ai-chat-map-button ai-chat-map-button-primary" disabled>\u78BA\u8A8D\u9078\u64C7</button>' +
            '<button id="ai-chat-map-cancel" class="ai-chat-map-button">\u53D6\u6D88</button>' +
          '</div>' +
          '<div id="ai-chat-map-selected-info" class="ai-chat-map-selected-info hidden"></div>';

        messagesContainer.appendChild(mapContainer);
        scrollToBottom();

        // \u521D\u59CB\u5316\u5730\u5716
        initChatMap();

        // \u53D6\u6D88\u6309\u9215
        document.getElementById('ai-chat-map-cancel').addEventListener('click', () => {
          mapContainer.remove();
        });
      }

      // \u521D\u59CB\u5316\u804A\u5929\u4E2D\u7684\u5730\u5716
      let chatMap = null;
      let chatMarker = null;
      let chatAutocomplete = null;
      let selectedPlace = null;

      async function initChatMap() {
        try {
          // \u8F09\u5165 Google Maps API
          if (typeof google === 'undefined' || !google.maps) {
            await loadGoogleMapsAPI();
          }

          const mapElement = document.getElementById('ai-chat-map');
          if (!mapElement) return;

          // \u521D\u59CB\u5316\u5730\u5716
          chatMap = new google.maps.Map(mapElement, {
            center: { lat: 23.5711, lng: 119.5794 }, // \u6F8E\u6E56\u4E2D\u5FC3
            zoom: 13,
            mapTypeControl: true,
            streetViewControl: true,
            fullscreenControl: true
          });

          // \u521D\u59CB\u5316\u6A19\u8A18
          chatMarker = new google.maps.Marker({
            map: chatMap,
            draggable: true
          });

          // \u5730\u5716\u9EDE\u64CA\u4E8B\u4EF6
          chatMap.addListener('click', (event) => {
            const location = event.latLng;
            chatMarker.setPosition(location);
            updateSelectedLocation(location);
          });

          // \u6A19\u8A18\u62D6\u62FD\u4E8B\u4EF6
          chatMarker.addListener('dragend', (event) => {
            updateSelectedLocation(event.latLng);
          });

          // \u521D\u59CB\u5316\u81EA\u52D5\u5B8C\u6210
          const searchInput = document.getElementById('ai-chat-map-search');
          if (searchInput) {
            chatAutocomplete = new google.maps.places.Autocomplete(searchInput, {
              fields: ['name', 'formatted_address', 'geometry', 'place_id'],
              types: ['establishment']
            });

            chatAutocomplete.addListener('place_changed', () => {
              const place = chatAutocomplete.getPlace();
              if (place.geometry) {
                chatMap.setCenter(place.geometry.location);
                chatMap.setZoom(16);
                chatMarker.setPosition(place.geometry.location);
                updateSelectedPlace(place);
              }
            });
          }

          // \u78BA\u8A8D\u6309\u9215
          document.getElementById('ai-chat-map-confirm').addEventListener('click', () => {
            if (selectedPlace) {
              confirmLocationSelection(selectedPlace);
            }
          });

        } catch (error) {
          console.error('[AIChat] Map initialization error:', error);
          const mapContainer = document.getElementById('ai-chat-map-container');
          if (mapContainer) {
            mapContainer.innerHTML = '<div class="ai-chat-map-error">\u5730\u5716\u8F09\u5165\u5931\u6557\uFF0C\u8ACB\u91CD\u65B0\u6574\u7406\u9801\u9762\u6216\u7A0D\u5F8C\u518D\u8A66\u3002</div>';
          }
        }
      }

      // \u8F09\u5165 Google Maps API
      function loadGoogleMapsAPI() {
        return new Promise((resolve, reject) => {
          if (typeof google !== 'undefined' && google.maps) {
            resolve();
            return;
          }

          const script = document.createElement('script');
          script.src = 'https://maps.googleapis.com/maps/api/js?key=YOUR_GOOGLE_MAPS_API_KEY_HERE&libraries=places&loading=async&callback=initChatMapCallback';
          script.async = true;
          script.defer = true;

          window.initChatMapCallback = () => {
            resolve();
            delete window.initChatMapCallback;
          };

          script.onerror = () => {
            reject(new Error('Failed to load Google Maps API'));
          };

          document.head.appendChild(script);
        });
      }

      // \u66F4\u65B0\u9078\u64C7\u7684\u4F4D\u7F6E
      function updateSelectedLocation(location) {
        const geocoder = new google.maps.Geocoder();
        geocoder.geocode({ location: location }, (results, status) => {
          if (status === 'OK' && results[0]) {
            const place = {
              name: results[0].formatted_address,
              address: results[0].formatted_address,
              location: {
                lat: location.lat(),
                lng: location.lng()
              },
              place_id: results[0].place_id
            };
            updateSelectedPlace(place);
          } else {
            const lat = location.lat().toFixed(6);
            const lng = location.lng().toFixed(6);
            const place = {
              name: '\u9078\u64C7\u7684\u4F4D\u7F6E',
              address: lat + ', ' + lng,
              location: {
                lat: location.lat(),
                lng: location.lng()
              }
            };
            updateSelectedPlace(place);
          }
        });
      }

      // \u66F4\u65B0\u9078\u64C7\u7684\u5730\u9EDE
      function updateSelectedPlace(place) {
        selectedPlace = place;
        const infoDiv = document.getElementById('ai-chat-map-selected-info');
        const confirmButton = document.getElementById('ai-chat-map-confirm');

        if (infoDiv && confirmButton) {
          const placeName = place.name || place.address || '';
          const placeAddress = place.address || '';
          infoDiv.innerHTML = 
            '<strong>\u5DF2\u9078\u64C7\uFF1A</strong>' + escapeHtml(placeName) + '<br>' +
            '<small>' + escapeHtml(placeAddress) + '</small>';
          infoDiv.classList.remove('hidden');
          confirmButton.disabled = false;
        }
      }

      // \u78BA\u8A8D\u5730\u9EDE\u9078\u64C7
      async function confirmLocationSelection(place) {
        try {
          // \u767C\u9001\u5730\u9EDE\u8CC7\u8A0A\u5230\u5F8C\u7AEF
          const response = await fetch('/api/ai/location-selected', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              place: place,
              sessionId: aiSessionId
            })
          });

          if (response.ok) {
            const data = await response.json();
            // \u79FB\u9664\u5730\u5716
            const mapContainer = document.getElementById('ai-chat-map-container');
            if (mapContainer) {
              mapContainer.remove();
            }
            // \u986F\u793A\u78BA\u8A8D\u8A0A\u606F
            const placeName = place.name || place.address || '\u9078\u64C7\u7684\u5730\u9EDE';
            addMessage('assistant', '\u592A\u597D\u4E86\uFF01\u6211\u5DF2\u7D93\u8A18\u9304\u4E86\u60A8\u9078\u64C7\u7684\u5730\u9EDE\uFF1A' + escapeHtml(placeName) + '\u3002\u63A5\u4E0B\u4F86\u6211\u53EF\u4EE5\u5E6B\u60A8\u505A\u4EC0\u9EBC\u55CE\uFF1F');
          } else {
            throw new Error('Failed to save location');
          }
        } catch (error) {
          console.error('[AIChat] Error confirming location:', error);
          addMessage('assistant', '\u62B1\u6B49\uFF0C\u5132\u5B58\u5730\u9EDE\u6642\u767C\u751F\u932F\u8AA4\uFF0C\u8ACB\u7A0D\u5F8C\u518D\u8A66\u3002');
        }
      }

      // \u521D\u59CB\u5316\uFF1A\u8A2D\u7F6E\u4E8B\u4EF6\u76E3\u807D\u5668
      function initializeAIChat() {
        console.log('[AIChat] Initializing...');
        const input = document.getElementById('ai-chat-input');
        const sendButton = document.getElementById('ai-send-button');
        
        console.log('[AIChat] Input element:', input);
        console.log('[AIChat] Send button:', sendButton);
        
        if (input) {
          // \u8655\u7406\u8F38\u5165\u4E8B\u4EF6
          input.addEventListener('input', function() {
            autoResizeTextarea(this);
          });
          
          // \u8655\u7406\u9375\u76E4\u4E8B\u4EF6 - Enter \u767C\u9001\uFF0CShift+Enter \u63DB\u884C
          input.addEventListener('keydown', function(event) {
            console.log('[AIChat] Keydown event:', event.key, 'Shift:', event.shiftKey);
            // Enter \u9375\u767C\u9001\uFF0CShift+Enter \u63DB\u884C
            if (event.key === 'Enter' && !event.shiftKey) {
              console.log('[AIChat] Enter pressed, sending message...');
              event.preventDefault();
              event.stopPropagation();
              event.stopImmediatePropagation();
              sendAIMessage();
              return false;
            }
          });
          
          input.focus();
          console.log('[AIChat] Event listeners attached to input');
        } else {
          console.error('[AIChat] Input element not found!');
        }
        
        if (sendButton) {
          // \u8655\u7406\u767C\u9001\u6309\u9215\u9EDE\u64CA
          sendButton.addEventListener('click', function(event) {
            event.preventDefault();
            event.stopPropagation();
            console.log('[AIChat] Send button clicked');
            sendAIMessage();
          });
          // \u521D\u59CB\u66F4\u65B0\u6309\u9215\u72C0\u614B
          updateSendButtonState();
          console.log('[AIChat] Event listener attached to send button');
        } else {
          console.error('[AIChat] Send button not found!');
        }
      }

      // \u5FEB\u901F\u56DE\u8986\u5EFA\u8B70
      const quickReplies = [
        '\u6F8E\u6E56\u6709\u4EC0\u9EBC\u597D\u5403\u7684\uFF1F',
        '\u63A8\u85A6\u5E7E\u500B\u5FC5\u53BB\u666F\u9EDE',
        '\u5929\u6C23\u600E\u9EBC\u6A23\uFF1F',
        '\u4EA4\u901A\u600E\u9EBC\u5B89\u6392\uFF1F',
        '\u6709\u4EC0\u9EBC\u79C1\u623F\u666F\u9EDE\uFF1F',
        '\u96E2\u5CF6\u600E\u9EBC\u53BB\uFF1F'
      ];

      // \u986F\u793A\u5FEB\u901F\u56DE\u8986\u5EFA\u8B70
      function showQuickReplies() {
        const quickRepliesContainer = document.getElementById('ai-quick-replies');
        const buttonsContainer = document.getElementById('quick-replies-buttons');
        
        if (!quickRepliesContainer || !buttonsContainer) return;
        
        // \u53EA\u5728\u8F38\u5165\u6846\u70BA\u7A7A\u6642\u986F\u793A
        const input = document.getElementById('ai-chat-input');
        if (input && input.value.trim().length > 0) {
          quickRepliesContainer.classList.add('hidden');
          return;
        }
        
        // \u6E05\u7A7A\u73FE\u6709\u6309\u9215
        buttonsContainer.innerHTML = '';
        
        // \u751F\u6210\u5FEB\u901F\u56DE\u8986\u6309\u9215
        quickReplies.forEach(reply => {
          const button = document.createElement('button');
          button.className = 'ai-chat-quick-reply-button';
          button.textContent = reply;
          button.addEventListener('click', () => {
            if (input) {
              input.value = reply;
              input.dispatchEvent(new Event('input', { bubbles: true }));
              quickRepliesContainer.classList.add('hidden');
              input.focus();
            }
          });
          buttonsContainer.appendChild(button);
        });
        
        quickRepliesContainer.classList.remove('hidden');
      }

      // \u96B1\u85CF\u5FEB\u901F\u56DE\u8986\u5EFA\u8B70
      function hideQuickReplies() {
        const quickRepliesContainer = document.getElementById('ai-quick-replies');
        if (quickRepliesContainer) {
          quickRepliesContainer.classList.add('hidden');
        }
      }

      // \u8868\u60C5\u9078\u64C7\u5668
      function setupEmojiPicker() {
        const emojiButton = document.getElementById('ai-emoji-button');
        const emojiPicker = document.getElementById('ai-emoji-picker');
        const input = document.getElementById('ai-chat-input');
        
        if (!emojiButton || !emojiPicker || !input) {
          console.warn('[AIChat] Emoji picker elements not found');
          return;
        }
        
        console.log('[AIChat] Setting up emoji picker');
        
        // \u5207\u63DB\u8868\u60C5\u9078\u64C7\u5668\u986F\u793A
        emojiButton.addEventListener('click', (e) => {
          e.preventDefault();
          e.stopPropagation();
          console.log('[AIChat] Emoji button clicked');
          const isHidden = emojiPicker.classList.contains('hidden');
          if (isHidden) {
            emojiPicker.classList.remove('hidden');
            // \u91CD\u7F6E\u5B9A\u4F4D\u6837\u5F0F\uFF0C\u4F7F\u7528 CSS \u4E2D\u5B9A\u4E49\u7684\u56FA\u5B9A\u5B9A\u4F4D
            emojiPicker.style.bottom = '';
            emojiPicker.style.left = '';
            emojiPicker.style.transform = '';
          } else {
            emojiPicker.classList.add('hidden');
          }
        });
        
        // \u9EDE\u64CA\u8868\u60C5\u63D2\u5165\u5230\u8F38\u5165\u6846
        const emojiItems = emojiPicker.querySelectorAll('.ai-chat-emoji-item');
        console.log('[AIChat] Found', emojiItems.length, 'emoji items');
        emojiItems.forEach((item, index) => {
          item.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            const emoji = item.getAttribute('data-emoji');
            console.log('[AIChat] Emoji clicked:', emoji);
            if (emoji && input) {
              const cursorPos = input.selectionStart || input.value.length;
              const textBefore = input.value.substring(0, cursorPos);
              const textAfter = input.value.substring(cursorPos);
              input.value = textBefore + emoji + textAfter;
              input.selectionStart = input.selectionEnd = cursorPos + emoji.length;
              input.dispatchEvent(new Event('input', { bubbles: true }));
              emojiPicker.classList.add('hidden');
              input.focus();
              // \u89F8\u767C\u6309\u9215\u72C0\u614B\u66F4\u65B0
              updateSendButtonState();
            }
          });
        });
        
        // \u9EDE\u64CA\u5916\u90E8\u95DC\u9589\u8868\u60C5\u9078\u64C7\u5668
        document.addEventListener('click', (e) => {
          if (emojiPicker && emojiButton) {
            if (!emojiPicker.contains(e.target) && !emojiButton.contains(e.target)) {
              emojiPicker.classList.add('hidden');
            }
          }
        });
        
        console.log('[AIChat] Emoji picker setup complete');
      }

      // \u91CD\u65B0\u751F\u6210\u8A0A\u606F
      async function regenerateMessage(messageId) {
        const messageDiv = document.querySelector('[data-message-id="' + messageId + '"]');
        if (!messageDiv) return;
        
        const messageText = messageDiv.querySelector('.ai-chat-ai-text')?.textContent || '';
        if (!messageText) return;
        
        // \u627E\u5230\u9019\u689D\u8A0A\u606F\u4E4B\u524D\u7684\u7528\u6236\u8A0A\u606F
        const allMessages = Array.from(document.querySelectorAll('.ai-chat-user-message, .ai-chat-ai-message'));
        const currentIndex = allMessages.findIndex(msg => msg === messageDiv);
        if (currentIndex <= 0) return;
        
        // \u627E\u5230\u5C0D\u61C9\u7684\u7528\u6236\u8A0A\u606F
        let userMessage = null;
        for (let i = currentIndex - 1; i >= 0; i--) {
          if (allMessages[i].classList.contains('ai-chat-user-message')) {
            userMessage = allMessages[i].querySelector('.ai-chat-user-text')?.textContent || '';
            break;
          }
        }
        
        if (!userMessage) return;
        
        // \u79FB\u9664\u820A\u7684 AI \u8A0A\u606F
        messageDiv.remove();
        
        // \u91CD\u65B0\u767C\u9001\u8ACB\u6C42
        const input = document.getElementById('ai-chat-input');
        if (input) {
          input.value = userMessage;
          input.dispatchEvent(new Event('input', { bubbles: true }));
          setTimeout(() => {
            sendAIMessage();
          }, 100);
        }
      }

      // \u8907\u88FD\u8A0A\u606F
      function copyMessage(messageId) {
        const messageDiv = document.querySelector('[data-message-id="' + messageId + '"]');
        if (!messageDiv) return;
        
        const messageText = messageDiv.querySelector('.ai-chat-ai-text')?.textContent || '';
        if (!messageText) return;
        
        navigator.clipboard.writeText(messageText).then(() => {
          // \u986F\u793A\u8907\u88FD\u6210\u529F\u63D0\u793A
          const button = messageDiv.querySelector('[onclick*="copyMessage"]');
          if (button) {
            const originalTitle = button.getAttribute('title');
            button.setAttribute('title', '\u5DF2\u8907\u88FD\uFF01');
            setTimeout(() => {
              button.setAttribute('title', originalTitle);
            }, 2000);
          }
          
          // \u986F\u793A Toast \u63D0\u793A\uFF08\u5982\u679C\u53EF\u7528\uFF09
          if (window.showToast) {
            window.showToast(MESSAGES.copiedToClipboard, 'success');
          }
        }).catch(err => {
          console.error('[AIChat] Failed to copy message:', err);
          if (window.showToast) {
            window.showToast(MESSAGES.copyFailed, 'error');
          }
        });
      }

      // \u6DFB\u52A0\u53CD\u61C9
      function addReaction(messageId, reaction) {
        const messageDiv = document.querySelector('[data-message-id="' + messageId + '"]');
        if (!messageDiv) return;
        
        // \u6AA2\u67E5\u662F\u5426\u5DF2\u7D93\u6709\u53CD\u61C9\u5340\u57DF
        let reactionsDiv = messageDiv.querySelector('.ai-chat-reactions');
        if (!reactionsDiv) {
          reactionsDiv = document.createElement('div');
          reactionsDiv.className = 'ai-chat-reactions';
          const bubble = messageDiv.querySelector('.ai-chat-ai-bubble');
          if (bubble) {
            bubble.appendChild(reactionsDiv);
          }
        }
        
        // \u6AA2\u67E5\u662F\u5426\u5DF2\u7D93\u6709\u9019\u500B\u53CD\u61C9
        const existingReaction = reactionsDiv.querySelector('[data-reaction="' + reaction + '"]');
        if (existingReaction) {
          // \u79FB\u9664\u53CD\u61C9
          existingReaction.remove();
        } else {
          // \u6DFB\u52A0\u53CD\u61C9
          const reactionBadge = document.createElement('div');
          reactionBadge.className = 'ai-chat-reaction-badge active';
          reactionBadge.setAttribute('data-reaction', reaction);
          reactionBadge.textContent = reaction;
          reactionsDiv.appendChild(reactionBadge);
        }
        
        // \u5207\u63DB\u6309\u9215\u72C0\u614B
        const button = messageDiv.querySelector('[data-reaction="' + reaction + '"]');
        if (button) {
          button.classList.toggle('active');
        }
      }

      // \u52A0\u8F09\u5C0D\u8A71\u6B77\u53F2
      async function loadConversationHistory() {
        try {
          // \u6AA2\u67E5\u662F\u5426\u5728\u7DDA\uFF08\u907F\u514D\u96E2\u7DDA\u6642\u986F\u793A\u932F\u8AA4\uFF09
          if (!navigator.onLine) {
            console.log('[AIChat] Offline mode: skipping conversation history load');
            return;
          }
          
          const response = await fetch('/api/ai/history?sessionId=' + encodeURIComponent(aiSessionId) + '&limit=50');
          if (!response.ok) return;
          
          const data = await response.json();
          if (!data.success || !data.history || data.history.length === 0) return;
          
          // \u6E05\u7A7A\u6B61\u8FCE\u8A0A\u606F
          const messagesContainer = document.getElementById('ai-chat-messages');
          const welcomeMessage = messagesContainer.querySelector('.ai-chat-welcome-message');
          if (welcomeMessage) {
            welcomeMessage.remove();
          }
          
          // \u986F\u793A\u6B77\u53F2\u5C0D\u8A71
          data.history.forEach(msg => {
            if (msg.message_type === 'user') {
              addMessage('user', msg.message_content);
            } else if (msg.message_type === 'assistant') {
              addMessage('assistant', msg.message_content);
            }
          });
          
          scrollToBottom();
        } catch (error) {
          // \u975C\u9ED8\u8655\u7406\u7DB2\u7D61\u932F\u8AA4\uFF08\u96E2\u7DDA\u6642\u6B63\u5E38\uFF09
          if (error.name === 'TypeError' && error.message.includes('Failed to fetch')) {
            console.log('[AIChat] Network error (likely offline):', error.message);
          } else {
            console.error('[AIChat] Error loading conversation history:', error);
          }
        }
      }

      // \u78BA\u4FDD\u5728 DOM \u5B8C\u5168\u8F09\u5165\u5F8C\u521D\u59CB\u5316
      function tryInitialize() {
        const input = document.getElementById('ai-chat-input');
        if (input) {
          console.log('[AIChat] DOM ready, initializing...');
          initializeAIChat();
          // \u8A2D\u7F6E\u6B61\u8FCE\u8A0A\u606F\u7684\u6309\u9215
          setupWelcomeButtons();
          // \u8A2D\u7F6E\u8868\u60C5\u9078\u64C7\u5668
          setupEmojiPicker();
          // \u521D\u59CB\u986F\u793A\u5FEB\u901F\u56DE\u8986
          showQuickReplies();
          // \u52A0\u8F09\u5C0D\u8A71\u6B77\u53F2\uFF08\u5982\u679C\u6709\uFF09
          loadConversationHistory();
          // \u79FB\u52D5\u7AEF\u512A\u5316
          handleMobileKeyboard();
          
          // \u8A2D\u7F6E\u7D71\u8A08\u548C\u5206\u4EAB\u6309\u9215
          const statsButton = document.getElementById('ai-chat-stats-button');
          const shareButton = document.getElementById('ai-chat-share-button');
          if (statsButton) {
            statsButton.addEventListener('click', showStatsModal);
          }
          if (shareButton) {
            shareButton.addEventListener('click', showShareModal);
          }
          
          // \u8A2D\u7F6E Modal \u95DC\u9589\u6309\u9215
          const statsModalClose = document.getElementById('ai-chat-stats-modal-close');
          const shareModalClose = document.getElementById('ai-chat-share-modal-close');
          if (statsModalClose) {
            statsModalClose.addEventListener('click', closeStatsModal);
          }
          if (shareModalClose) {
            shareModalClose.addEventListener('click', closeShareModal);
          }
          
          // \u8A2D\u7F6E\u91CD\u7F6E\u5C0D\u8A71\u6309\u9215
          const resetButton = document.getElementById('ai-chat-reset-conversation-button');
          if (resetButton) {
            resetButton.addEventListener('click', resetConversation);
          }
          
          // \u8A2D\u7F6E\u5206\u4EAB\u529F\u80FD\u6309\u9215
          const shareClipboardButton = document.getElementById('ai-chat-share-clipboard-button');
          const shareExportButton = document.getElementById('ai-chat-share-export-button');
          if (shareClipboardButton) {
            shareClipboardButton.addEventListener('click', shareToClipboard);
          }
          if (shareExportButton) {
            shareExportButton.addEventListener('click', exportToText);
          }
          
          // \u9EDE\u64CA Modal \u5916\u90E8\u95DC\u9589
          const statsModal = document.getElementById('ai-chat-stats-modal');
          const shareModal = document.getElementById('ai-chat-share-modal');
          if (statsModal) {
            statsModal.addEventListener('click', (e) => {
              if (e.target === statsModal) {
                closeStatsModal();
              }
            });
          }
          if (shareModal) {
            shareModal.addEventListener('click', (e) => {
              if (e.target === shareModal) {
                closeShareModal();
              }
            });
          }
          
          // \u79FB\u52D5\u7AEF\uFF1A\u9632\u6B62\u96D9\u64CA\u7E2E\u653E
          if (isMobile()) {
            let lastTouchEnd = 0;
            document.addEventListener('touchend', (event) => {
              const now = Date.now();
              if (now - lastTouchEnd <= 300) {
                event.preventDefault();
              }
              lastTouchEnd = now;
            }, false);
          }
        } else {
          console.log('[AIChat] DOM not ready yet, retrying...');
          setTimeout(tryInitialize, 100);
        }
      }

      // \u7ACB\u5373\u5617\u8A66\u521D\u59CB\u5316
      tryInitialize();
      
      // \u4E5F\u76E3\u807D DOMContentLoaded\uFF08\u5099\u7528\uFF09
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', function() {
          console.log('[AIChat] DOMContentLoaded fired');
          tryInitialize();
        });
      } else {
        // DOM \u5DF2\u7D93\u8F09\u5165\u5B8C\u6210
        console.log('[AIChat] DOM already loaded');
        tryInitialize();
      }

      // Register Service Worker for offline support
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('/sw.js')
            .then((registration) => {
              console.log('[Service Worker] Registration successful:', registration.scope);
            })
            .catch((error) => {
              // \u975C\u9ED8\u8655\u7406 Service Worker \u8A3B\u518A\u5931\u6557\uFF08\u67D0\u4E9B\u74B0\u5883\u53EF\u80FD\u4E0D\u652F\u6301\uFF09
              console.log('[Service Worker] Registration failed (non-critical):', error.message);
            });
        });
      }

      // \u8655\u7406\u5B57\u9AD4\u8F09\u5165\u5931\u6557\uFF08\u4F7F\u7528 JavaScript \u800C\u975E inline event handler\uFF0C\u907F\u514D CSP \u9055\u898F\uFF09
      window.addEventListener('load', () => {
        const fontLink = document.querySelector('link[href*="fonts.googleapis.com"]');
        if (fontLink) {
          fontLink.addEventListener('error', () => {
            // \u5B57\u9AD4\u8F09\u5165\u5931\u6557\u6642\uFF0CCSS \u56DE\u9000\u5B57\u9AD4\u6703\u81EA\u52D5\u751F\u6548
            console.log('[AIChat] Google Fonts failed to load, using fallback fonts');
          });
        }
      });

      // \u984D\u5916\u7684\u932F\u8AA4\u8655\u7406\uFF08\u4F5C\u70BA\u5099\u4EFD\uFF0C\u4E3B\u8981\u8655\u7406\u5728\u8173\u672C\u958B\u982D\uFF09
      window.addEventListener('unhandledrejection', (event) => {
        const errorSource = event.reason?.stack || event.reason?.message || String(event.reason || '');
        const fileName = event.reason?.fileName || '';
        // \u6AA2\u67E5\u662F\u5426\u662F\u7B2C\u4E09\u65B9\u8173\u672C\u7684\u932F\u8AA4
        if (errorSource.includes('giveFreely') || 
            errorSource.includes('givefreely') ||
            fileName.includes('giveFreely') ||
            fileName.includes('givefreely') ||
            errorSource.includes('cloudflareinsights') ||
            errorSource.includes('beacon') ||
            (errorSource.includes('payload') && (errorSource.includes('giveFreely') || fileName.includes('giveFreely')))) {
          event.preventDefault(); // \u963B\u6B62\u932F\u8AA4\u986F\u793A\u5728\u63A7\u5236\u53F0
          return; // \u975C\u9ED8\u5FFD\u7565
        }
        // \u5176\u4ED6\u932F\u8AA4\u6B63\u5E38\u8655\u7406
        console.error('[AIChat] Unhandled promise rejection:', event.reason);
      });
      
      // \u8655\u7406\u540C\u6B65\u932F\u8AA4
      window.addEventListener('error', (event) => {
        const errorSource = event.filename || event.message || '';
        if (errorSource.includes('giveFreely') || 
            errorSource.includes('givefreely') ||
            errorSource.includes('cloudflareinsights') ||
            errorSource.includes('beacon')) {
          event.preventDefault(); // \u963B\u6B62\u932F\u8AA4\u986F\u793A\u5728\u63A7\u5236\u53F0
          return; // \u975C\u9ED8\u5FFD\u7565
        }
      });
    </script>
  `;
  const csp = [
    "default-src 'self'",
    `script-src 'self' 'nonce-${nonce}' 'unsafe-inline' 'unsafe-eval' https://apis.google.com https://maps.googleapis.com https://accounts.google.com https://ajax.googleapis.com`,
    `style-src 'self' https://fonts.googleapis.com 'nonce-${nonce}' 'unsafe-inline'`,
    `style-src-attr 'self' 'nonce-${nonce}' 'unsafe-inline'`,
    "font-src 'self' data: https://fonts.gstatic.com",
    "img-src 'self' data: https: https://www.gstatic.com https://maps.googleapis.com https://maps.gstatic.com",
    "connect-src 'self' https://apis.google.com https://accounts.google.com https://maps.googleapis.com https://www.googleapis.com https://oauth2.googleapis.com https://generativelanguage.googleapis.com https://api.openai.com https://fonts.googleapis.com",
    "frame-src 'self' https://accounts.google.com",
    "base-uri 'self'",
    "form-action 'self'",
    "frame-ancestors 'none'",
    "object-src 'none'"
  ].join("; ");
  const securityHeaders = {
    "Content-Security-Policy": csp,
    "X-Content-Type-Options": "nosniff",
    "X-Frame-Options": "DENY",
    "X-XSS-Protection": "1; mode=block",
    "Referrer-Policy": "strict-origin-when-cross-origin",
    "Permissions-Policy": "geolocation=(), microphone=(), camera=()"
  };
  const html = `
    <!DOCTYPE html>
    <html lang="zh-TW">
    <head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <title>\u6F8E\u6E56 AI \u52A9\u624B - HOPENGHU</title>
      <link rel="icon" type="image/x-icon" href="/favicon.ico">
      <!-- \u7ACB\u5373\u8A2D\u7F6E\u5168\u5C40\u932F\u8AA4\u8655\u7406\uFF0C\u5728\u7B2C\u4E09\u65B9\u8173\u672C\u52A0\u8F09\u524D -->
      <script nonce="${nonce}">
        (function() {
          'use strict';
          // \u8655\u7406\u672A\u6355\u7372\u7684 Promise \u932F\u8AA4
          if (typeof window !== 'undefined') {
            window.addEventListener('unhandledrejection', function(event) {
              try {
                var errorSource = '';
                var fileName = '';
                var errorString = '';
                var errorMessage = '';
                
                if (event.reason) {
                  errorSource = (event.reason.stack || event.reason.message || String(event.reason) || '').toLowerCase();
                  fileName = (event.reason.fileName || event.reason.source || '').toLowerCase();
                  errorString = String(event.reason).toLowerCase();
                  errorMessage = (event.reason.message || String(event.reason) || '').toLowerCase();
                }
                
                // \u6AA2\u67E5\u932F\u8AA4\u4F86\u6E90\uFF08\u5305\u62EC\u6587\u4EF6\u540D\u3001\u5806\u68E7\u3001\u6D88\u606F\u3001payload \u932F\u8AA4\uFF09
                var isThirdPartyError = 
                  errorSource.indexOf('givefreely') !== -1 ||
                  fileName.indexOf('givefreely') !== -1 ||
                  errorString.indexOf('givefreely') !== -1 ||
                  errorMessage.indexOf('givefreely') !== -1 ||
                  errorSource.indexOf('cloudflareinsights') !== -1 ||
                  errorSource.indexOf('beacon') !== -1 ||
                  // \u6AA2\u67E5 payload \u76F8\u95DC\u932F\u8AA4\uFF08giveFreely \u5E38\u898B\u932F\u8AA4\uFF09
                  (errorMessage.indexOf('payload') !== -1 && errorMessage.indexOf('undefined') !== -1) ||
                  (errorSource.indexOf('payload') !== -1 && errorSource.indexOf('undefined') !== -1);
                
                // \u6AA2\u67E5\u932F\u8AA4\u5806\u68E7\u4E2D\u7684\u6587\u4EF6\u540D\uFF08giveFreely.tsx-4704fb7d.js\uFF09
                if (!isThirdPartyError && errorSource) {
                  isThirdPartyError = errorSource.indexOf('givefreely.tsx') !== -1 || 
                                     errorSource.indexOf('givefreely.js') !== -1 ||
                                     errorSource.indexOf('4704fb7d') !== -1; // \u6AA2\u67E5\u7279\u5B9A\u7684\u6587\u4EF6\u540D\u54C8\u5E0C
                }
                
                // \u6AA2\u67E5\u6587\u4EF6\u540D\u4E2D\u7684 givefreely
                if (!isThirdPartyError && event.target && event.target.location) {
                  var url = String(event.target.location.href || '').toLowerCase();
                  isThirdPartyError = url.indexOf('givefreely') !== -1;
                }
                
                if (isThirdPartyError) {
                  event.preventDefault();
                  event.stopPropagation();
                  event.stopImmediatePropagation();
                  return false;
                }
              } catch (e) {
                // \u5FFD\u7565\u932F\u8AA4\u8655\u7406\u672C\u8EAB\u7684\u932F\u8AA4
              }
            }, true);
            
            // \u8655\u7406\u672A\u6355\u7372\u7684\u540C\u6B65\u932F\u8AA4
            window.addEventListener('error', function(event) {
              try {
                var errorSource = ((event.filename || event.message || event.error?.stack || '') + '').toLowerCase();
                var errorMessage = (event.message || '').toLowerCase();
                
                // \u6AA2\u67E5\u932F\u8AA4\u4F86\u6E90\uFF08\u5305\u62EC\u6587\u4EF6\u540D\u3001\u6D88\u606F\u3001payload \u932F\u8AA4\uFF09
                var isThirdPartyError = 
                  errorSource.indexOf('givefreely') !== -1 ||
                  errorMessage.indexOf('givefreely') !== -1 ||
                  errorSource.indexOf('cloudflareinsights') !== -1 ||
                  errorSource.indexOf('beacon') !== -1 ||
                  // \u6AA2\u67E5 payload \u76F8\u95DC\u932F\u8AA4
                  (errorMessage.indexOf('payload') !== -1 && errorMessage.indexOf('undefined') !== -1) ||
                  (errorSource.indexOf('payload') !== -1 && errorSource.indexOf('undefined') !== -1);
                
                // \u6AA2\u67E5\u932F\u8AA4\u5806\u68E7\u4E2D\u7684\u6587\u4EF6\u540D
                if (!isThirdPartyError && event.error && event.error.stack) {
                  var stack = event.error.stack.toLowerCase();
                  isThirdPartyError = stack.indexOf('givefreely') !== -1 ||
                                     stack.indexOf('4704fb7d') !== -1;
                }
                
                // \u6AA2\u67E5\u6587\u4EF6\u540D\u4E2D\u7684 givefreely
                if (!isThirdPartyError && event.filename) {
                  isThirdPartyError = event.filename.toLowerCase().indexOf('givefreely') !== -1 ||
                                     event.filename.toLowerCase().indexOf('4704fb7d') !== -1;
                }
                
                if (isThirdPartyError) {
                  event.preventDefault();
                  event.stopPropagation();
                  event.stopImmediatePropagation();
                  return false;
                }
              } catch (e) {
                // \u5FFD\u7565\u932F\u8AA4\u8655\u7406\u672C\u8EAB\u7684\u932F\u8AA4
              }
            }, true);
          }
        })();
      </script>
      <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet" crossorigin="anonymous">
      <style nonce="${nonce}">
        ${cssContent || "/* CSS content not provided */"}
        * {
          box-sizing: border-box;
          margin: 0;
          padding: 0;
        }
        body {
          /* \u5B57\u9AD4\u56DE\u9000\uFF1A\u5982\u679C Google Fonts \u7121\u6CD5\u8F09\u5165\uFF0C\u4F7F\u7528\u7CFB\u7D71\u5B57\u9AD4 */
          font-family: 'Noto Sans TC', -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft JhengHei', 'PingFang TC', 'Helvetica Neue', Arial, sans-serif;
          margin: 0;
          padding: 0;
          overflow: hidden;
        }
      </style>
    </head>
    <body>
      ${content}
    </body>
    </html>
  `;
  return new Response(html, {
    headers: {
      "Content-Type": "text/html;charset=utf-8",
      ...securityHeaders
    }
  });
}

// src/pages/ImageManagement.js
init_auth();

// src/utils/errorHandler.js
init_layout();
var ServiceHealthChecker = class {
  /**
   * 檢查數據庫連接
   * @param {object} db - D1 數據庫實例
   * @returns {Promise<{healthy: boolean, error?: string}>}
   */
  static async checkDatabase(db) {
    if (!db) {
      return { healthy: false, error: "Database not initialized" };
    }
    try {
      await db.prepare("SELECT 1").first();
      return { healthy: true };
    } catch (error) {
      return {
        healthy: false,
        error: error.message || "Database connection failed"
      };
    }
  }
  /**
   * 檢查服務是否可用
   * @param {object} service - 服務實例
   * @param {string} serviceName - 服務名稱
   * @returns {{healthy: boolean, error?: string}}
   */
  static checkService(service, serviceName) {
    if (!service) {
      return {
        healthy: false,
        error: `${serviceName} not initialized`
      };
    }
    return { healthy: true };
  }
};
var ErrorResponseBuilder = class {
  /**
   * 生成友好的錯誤頁面
   * @param {object} options - 選項
   * @param {string} options.title - 錯誤標題
   * @param {string} options.message - 錯誤訊息
   * @param {number} options.statusCode - HTTP 狀態碼
   * @param {object} options.user - 當前用戶
   * @param {string} options.nonce - CSP nonce
   * @param {string} options.cssContent - CSS 內容
   * @param {string} options.suggestion - 建議操作
   * @returns {Response}
   */
  static buildErrorPage({
    title = "\u767C\u751F\u932F\u8AA4",
    message = "\u8655\u7406\u60A8\u7684\u8ACB\u6C42\u6642\u767C\u751F\u932F\u8AA4",
    statusCode = 500,
    user = null,
    nonce = "",
    cssContent = "",
    suggestion = null
  }) {
    const suggestionHtml = suggestion ? `
      <div class="mt-4 p-4 bg-blue-50 border border-blue-200 rounded-lg">
        <p class="text-sm text-blue-800"><strong>\u5EFA\u8B70\uFF1A</strong> ${suggestion}</p>
      </div>
    ` : "";
    const content = `
      <div class="min-h-screen bg-gray-50 flex items-center justify-center px-4">
        <div class="max-w-md w-full bg-white rounded-lg shadow-lg p-8 text-center">
          <div class="mb-6">
            <svg class="mx-auto h-16 w-16 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
            </svg>
          </div>
          <h1 class="text-2xl font-bold text-gray-900 mb-2">${title}</h1>
          <p class="text-gray-600 mb-6">${message}</p>
          ${suggestionHtml}
          <div class="mt-6">
            <a href="/" class="inline-block px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
              \u8FD4\u56DE\u9996\u9801
            </a>
          </div>
        </div>
      </div>
    `;
    return new Response(pageTemplate2({
      title,
      content,
      user,
      nonce,
      cssContent
    }), {
      status: statusCode,
      headers: { "Content-Type": "text/html;charset=utf-8" }
    });
  }
  /**
   * 生成 JSON 錯誤響應
   * @param {string} error - 錯誤訊息
   * @param {number} statusCode - HTTP 狀態碼
   * @param {object} details - 額外詳情
   * @returns {Response}
   */
  static buildJSONError(error, statusCode = 500, details = {}) {
    return new Response(JSON.stringify({
      success: false,
      error,
      ...details
    }), {
      status: statusCode,
      headers: { "Content-Type": "application/json; charset=utf-8" }
    });
  }
  /**
   * 生成服務不可用錯誤頁面
   * @param {object} options - 選項
   * @returns {Response}
   */
  static buildServiceUnavailablePage(options) {
    return this.buildErrorPage({
      title: "\u670D\u52D9\u66AB\u6642\u4E0D\u53EF\u7528",
      message: "\u7CFB\u7D71\u6B63\u5728\u7DAD\u8B77\u4E2D\uFF0C\u8ACB\u7A0D\u5F8C\u518D\u8A66\u3002",
      statusCode: 503,
      suggestion: "\u5982\u679C\u554F\u984C\u6301\u7E8C\u5B58\u5728\uFF0C\u8ACB\u806F\u7E6B\u7BA1\u7406\u54E1\u3002",
      ...options
    });
  }
  /**
   * 生成數據庫錯誤頁面
   * @param {object} options - 選項
   * @returns {Response}
   */
  static buildDatabaseErrorPage(options) {
    return this.buildErrorPage({
      title: "\u6578\u64DA\u5EAB\u9023\u63A5\u932F\u8AA4",
      message: "\u7121\u6CD5\u9023\u63A5\u5230\u6578\u64DA\u5EAB\uFF0C\u8ACB\u7A0D\u5F8C\u518D\u8A66\u3002",
      statusCode: 503,
      suggestion: "\u7CFB\u7D71\u7BA1\u7406\u54E1\u5DF2\u6536\u5230\u901A\u77E5\uFF0C\u6B63\u5728\u8655\u7406\u4E2D\u3002",
      ...options
    });
  }
};
function withErrorHandling(fn, options = {}) {
  return async (...args) => {
    try {
      return await fn(...args);
    } catch (error) {
      console.error(`[ErrorHandler] Error in ${fn.name || "anonymous"}:`, error);
      if (error.message && error.message.includes("no such table")) {
        return ErrorResponseBuilder.buildErrorPage({
          title: "\u6578\u64DA\u5EAB\u8868\u4E0D\u5B58\u5728",
          message: "\u7CFB\u7D71\u6B63\u5728\u521D\u59CB\u5316\uFF0C\u8ACB\u7A0D\u5F8C\u518D\u8A66\u3002",
          statusCode: 503,
          suggestion: "\u5982\u679C\u554F\u984C\u6301\u7E8C\u5B58\u5728\uFF0C\u8ACB\u806F\u7E6B\u7BA1\u7406\u54E1\u904B\u884C\u6578\u64DA\u5EAB\u9077\u79FB\u3002",
          ...options
        });
      }
      if (error.message && error.message.includes("Database")) {
        return ErrorResponseBuilder.buildDatabaseErrorPage(options);
      }
      return ErrorResponseBuilder.buildErrorPage({
        title: "\u767C\u751F\u932F\u8AA4",
        message: error.message || "\u8655\u7406\u60A8\u7684\u8ACB\u6C42\u6642\u767C\u751F\u672A\u77E5\u932F\u8AA4",
        statusCode: 500,
        ...options
      });
    }
  };
}

// src/templates/imageManagement.js
function escapeHtml(text) {
  if (text == null)
    return "";
  return String(text).replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#39;");
}
function renderPageHeader() {
  return `
    <div class="mb-8">
      <h1 class="text-3xl font-bold text-gray-900 mb-2">\u5716\u7247\u7BA1\u7406</h1>
      <p class="text-gray-600">\u7BA1\u7406Google Places API\u5716\u7247\u7DE9\u5B58\u548C\u76E3\u63A7\u5716\u7247\u72C0\u614B</p>
    </div>
  `;
}
function renderErrorAlert(error) {
  if (!error)
    return "";
  return `
    <div class="bg-red-50 border border-red-200 rounded-md p-4 mb-6">
      <div class="flex">
        <div class="flex-shrink-0">
          <svg class="h-5 w-5 text-red-400" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
          </svg>
        </div>
        <div class="ml-3">
          <h3 class="text-sm font-medium text-red-800">\u932F\u8AA4</h3>
          <div class="mt-2 text-sm text-red-700">
            <p>${escapeHtml(error)}</p>
          </div>
        </div>
      </div>
    </div>
  `;
}
function renderStatisticsCards(stats) {
  return `
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
      <div class="bg-white overflow-hidden shadow rounded-lg">
        <div class="p-5">
          <div class="flex items-center">
            <div class="flex-shrink-0">
              <svg class="h-6 w-6 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
              </svg>
            </div>
            <div class="ml-5 w-0 flex-1">
              <dl>
                <dt class="text-sm font-medium text-gray-500 truncate">\u7E3D\u7DE9\u5B58\u6578\u91CF</dt>
                <dd class="text-lg font-medium text-gray-900">${stats.total || 0}</dd>
              </dl>
            </div>
          </div>
        </div>
      </div>

      <div class="bg-white overflow-hidden shadow rounded-lg">
        <div class="p-5">
          <div class="flex items-center">
            <div class="flex-shrink-0">
              <svg class="h-6 w-6 text-green-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
            </div>
            <div class="ml-5 w-0 flex-1">
              <dl>
                <dt class="text-sm font-medium text-gray-500 truncate">\u6709\u6548\u7DE9\u5B58</dt>
                <dd class="text-lg font-medium text-gray-900">${stats.valid || 0}</dd>
              </dl>
            </div>
          </div>
        </div>
      </div>

      <div class="bg-white overflow-hidden shadow rounded-lg">
        <div class="p-5">
          <div class="flex items-center">
            <div class="flex-shrink-0">
              <svg class="h-6 w-6 text-red-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
            </div>
            <div class="ml-5 w-0 flex-1">
              <dl>
                <dt class="text-sm font-medium text-gray-500 truncate">\u904E\u671F\u7DE9\u5B58</dt>
                <dd class="text-lg font-medium text-gray-900">${stats.expired || 0}</dd>
              </dl>
            </div>
          </div>
        </div>
      </div>
    </div>
  `;
}
function renderActionButtons() {
  return `
    <div class="bg-white shadow rounded-lg p-6 mb-8">
      <h2 class="text-lg font-medium text-gray-900 mb-4">\u7DE9\u5B58\u7BA1\u7406</h2>
      <div class="flex flex-wrap gap-4">
        <button 
          onclick="cleanupExpiredCache()"
          class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500"
        >
          <svg class="mr-2 h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
          </svg>
          \u6E05\u7406\u904E\u671F\u7DE9\u5B58
        </button>
        
        <button 
          onclick="refreshAllImages()"
          class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500"
        >
          <svg class="mr-2 h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
          </svg>
          \u5237\u65B0\u6240\u6709\u5716\u7247
        </button>
        
        <button 
          onclick="refreshStats()"
          class="inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
        >
          <svg class="mr-2 h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
          </svg>
          \u5237\u65B0\u7D71\u8A08
        </button>
      </div>
    </div>
  `;
}
function renderInfoSection() {
  return `
    <div class="bg-blue-50 border border-blue-200 rounded-md p-4">
      <div class="flex">
        <div class="flex-shrink-0">
          <svg class="h-5 w-5 text-blue-400" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
          </svg>
        </div>
        <div class="ml-3">
          <h3 class="text-sm font-medium text-blue-800">\u5716\u7247\u7DE9\u5B58\u8AAA\u660E</h3>
          <div class="mt-2 text-sm text-blue-700">
            <ul class="list-disc list-inside space-y-1">
              <li>Google Places API\u7684\u5716\u7247URL\u5177\u6709\u6642\u6548\u6027\uFF0C\u6703\u5728\u4E00\u6BB5\u6642\u9593\u5F8C\u5931\u6548</li>
              <li>\u7CFB\u7D71\u6703\u81EA\u52D5\u7DE9\u5B58\u5716\u7247URL\uFF0C\u907F\u514D\u5716\u7247\u986F\u793A\u932F\u8AA4</li>
              <li>\u7DE9\u5B58\u6709\u6548\u671F\u70BA30\u5929\uFF0C\u904E\u671F\u7684\u7DE9\u5B58\u6703\u88AB\u81EA\u52D5\u6E05\u7406</li>
              <li>\u60A8\u53EF\u4EE5\u624B\u52D5\u6E05\u7406\u904E\u671F\u7684\u7DE9\u5B58\u4EE5\u91CB\u653E\u5B58\u5132\u7A7A\u9593</li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  `;
}

// src/pages/ImageManagement.js
async function renderImageManagementPage(request, env, session, user, nonce, cssContent) {
  const authCheck = requireAdmin(user, request);
  if (authCheck)
    return authCheck;
  const dbHealth = await ServiceHealthChecker.checkDatabase(env.DB);
  if (!dbHealth.healthy) {
    console.error("[ImageManagement] Database not available:", dbHealth.error);
    return ErrorResponseBuilder.buildDatabaseErrorPage({
      user,
      nonce,
      cssContent
    });
  }
  let stats = { total: 0, expired: 0, valid: 0 };
  let error = null;
  try {
    const response = await fetch(`${new URL(request.url).origin}/api/image/stats`);
    if (response.ok) {
      stats = await response.json();
    }
  } catch (e) {
    console.error("Error fetching image stats:", e);
    error = "\u7121\u6CD5\u7372\u53D6\u5716\u7247\u7D71\u8A08\u4FE1\u606F";
  }
  const content = `
        <div class="max-w-6xl mx-auto p-6">
            ${renderPageHeader()}
            ${renderErrorAlert(error)}
            ${renderStatisticsCards(stats)}
            ${renderActionButtons()}
            ${renderInfoSection()}
        </div>

        <script nonce="${nonce}">
            async function cleanupExpiredCache() {
                if (!confirm('\u78BA\u5B9A\u8981\u6E05\u7406\u904E\u671F\u7684\u5716\u7247\u7DE9\u5B58\u55CE\uFF1F')) {
                    return;
                }
                
                try {
                    const response = await fetch('/api/image/cleanup', {
                        method: 'POST'
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        if (window.showToast) {
                          window.showToast('\u6E05\u7406\u5B8C\u6210\uFF01\u5171\u6E05\u7406\u4E86 ' + (result.cleanedCount || 0) + ' \u500B\u904E\u671F\u7DE9\u5B58\u3002', 'success');
                        } else {
                        alert(\`\u6E05\u7406\u5B8C\u6210\uFF01\u5171\u6E05\u7406\u4E86 \${result.cleanedCount} \u500B\u904E\u671F\u7DE9\u5B58\u3002\`);
                        }
                        location.reload();
                    } else {
                        if (window.showToast) {
                          window.showToast('\u6E05\u7406\u5931\u6557\uFF0C\u8ACB\u7A0D\u5F8C\u518D\u8A66\u3002', 'error');
                    } else {
                        alert('\u6E05\u7406\u5931\u6557\uFF0C\u8ACB\u7A0D\u5F8C\u518D\u8A66\u3002');
                        }
                    }
                } catch (error) {
                    console.error('Error cleaning up cache:', error);
                    if (window.showToast) {
                      window.showToast('\u6E05\u7406\u5931\u6557\uFF0C\u8ACB\u7A0D\u5F8C\u518D\u8A66\u3002', 'error');
                    } else {
                    alert('\u6E05\u7406\u5931\u6557\uFF0C\u8ACB\u7A0D\u5F8C\u518D\u8A66\u3002');
                    }
                }
            }

            async function refreshStats() {
                location.reload();
            }

            async function refreshAllImages() {
                if (!confirm('\u78BA\u5B9A\u8981\u5237\u65B0\u6240\u6709\u5730\u9EDE\u7684\u5716\u7247\u55CE\uFF1F\u9019\u53EF\u80FD\u9700\u8981\u4E00\u4E9B\u6642\u9593\u3002')) {
                    return;
                }
                
                try {
                    const response = await fetch('/api/image/refresh-all', {
                        method: 'POST'
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        if (window.showToast) {
                          window.showToast('\u5237\u65B0\u5B8C\u6210\uFF01' + (result.message || ''), 'success');
                        } else {
                        alert(\`\u5237\u65B0\u5B8C\u6210\uFF01\${result.message}\`);
                        }
                        location.reload();
                    } else {
                        if (window.showToast) {
                          window.showToast('\u5237\u65B0\u5931\u6557\uFF0C\u8ACB\u7A0D\u5F8C\u518D\u8A66\u3002', 'error');
                    } else {
                        alert('\u5237\u65B0\u5931\u6557\uFF0C\u8ACB\u7A0D\u5F8C\u518D\u8A66\u3002');
                        }
                    }
                } catch (error) {
                    console.error('Error refreshing images:', error);
                    if (window.showToast) {
                      window.showToast('\u5237\u65B0\u5931\u6557\uFF0C\u8ACB\u7A0D\u5F8C\u518D\u8A66\u3002', 'error');
                    } else {
                    alert('\u5237\u65B0\u5931\u6557\uFF0C\u8ACB\u7A0D\u5F8C\u518D\u8A66\u3002');
                    }
                }
            }
        </script>
    `;
  return new Response(
    pageTemplate({
      title: "\u5716\u7247\u7BA1\u7406 - HOPE PENGHU",
      content,
      user,
      nonce,
      cssContent
    }),
    {
      headers: {
        "Content-Type": "text/html;charset=utf-8"
      }
    }
  );
}

// src/pages/AdminDashboard.js
init_layout();
init_auth();

// src/templates/adminDashboard.js
function renderPageHeader2() {
  return `
    <div class="mb-8">
      <h1 class="text-3xl font-bold text-gray-900">\u7BA1\u7406\u54E1\u5100\u8868\u677F</h1>
      <p class="mt-2 text-gray-600">\u7CFB\u7D71\u72C0\u614B\u76E3\u63A7\u548C\u7BA1\u7406</p>
    </div>
  `;
}
function renderSystemStatusCards() {
  return `
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
      <div class="bg-white overflow-hidden shadow rounded-lg">
        <div class="p-5">
          <div class="flex items-center">
            <div class="flex-shrink-0">
              <div class="w-8 h-8 bg-blue-500 rounded-md flex items-center justify-center">
                <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                </svg>
              </div>
            </div>
            <div class="ml-5 w-0 flex-1">
              <dl>
                <dt class="text-sm font-medium text-gray-500 truncate">\u7CFB\u7D71\u5065\u5EB7\u5EA6</dt>
                <dd class="flex items-baseline">
                  <div class="text-2xl font-semibold text-gray-900" id="system-health-score">--</div>
                  <div class="ml-2 flex items-baseline text-sm font-semibold text-green-600" id="system-health-status">
                    <span class="sr-only">\u72C0\u614B</span>
                  </div>
                </dd>
              </dl>
            </div>
          </div>
        </div>
      </div>

      <div class="bg-white overflow-hidden shadow rounded-lg">
        <div class="p-5">
          <div class="flex items-center">
            <div class="flex-shrink-0">
              <div class="w-8 h-8 bg-green-500 rounded-md flex items-center justify-center">
                <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                </svg>
              </div>
            </div>
            <div class="ml-5 w-0 flex-1">
              <dl>
                <dt class="text-sm font-medium text-gray-500 truncate">\u5716\u7247\u7DE9\u5B58</dt>
                <dd class="flex items-baseline">
                  <div class="text-2xl font-semibold text-gray-900" id="image-cache-count">--</div>
                  <div class="ml-2 flex items-baseline text-sm font-semibold text-green-600">
                    <span class="sr-only">\u6709\u6548\u5716\u7247</span>
                  </div>
                </dd>
              </dl>
            </div>
          </div>
        </div>
      </div>

      <div class="bg-white overflow-hidden shadow rounded-lg">
        <div class="p-5">
          <div class="flex items-center">
            <div class="flex-shrink-0">
              <div class="w-8 h-8 bg-yellow-500 rounded-md flex items-center justify-center">
                <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                </svg>
              </div>
            </div>
            <div class="ml-5 w-0 flex-1">
              <dl>
                <dt class="text-sm font-medium text-gray-500 truncate">API \u4F7F\u7528\u91CF</dt>
                <dd class="flex items-baseline">
                  <div class="text-2xl font-semibold text-gray-900" id="api-usage">--</div>
                  <div class="ml-2 flex items-baseline text-sm font-semibold text-green-600">
                    <span class="sr-only">\u4ECA\u65E5\u8ACB\u6C42</span>
                  </div>
                </dd>
              </dl>
            </div>
          </div>
        </div>
      </div>

      <div class="bg-white overflow-hidden shadow rounded-lg">
        <div class="p-5">
          <div class="flex items-center">
            <div class="flex-shrink-0">
              <div class="w-8 h-8 bg-red-500 rounded-md flex items-center justify-center">
                <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                </svg>
              </div>
            </div>
            <div class="ml-5 w-0 flex-1">
              <dl>
                <dt class="text-sm font-medium text-gray-500 truncate">\u5B89\u5168\u5206\u6578</dt>
                <dd class="flex items-baseline">
                  <div class="text-2xl font-semibold text-gray-900" id="security-score">--</div>
                  <div class="ml-2 flex items-baseline text-sm font-semibold text-green-600">
                    <span class="sr-only">\u5206\u6578</span>
                  </div>
                </dd>
              </dl>
            </div>
          </div>
        </div>
      </div>
    </div>
  `;
}
function renderFeatureCards() {
  return `
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
      <!-- \u5099\u4EFD\u7BA1\u7406 -->
      <div class="bg-white shadow rounded-lg">
        <div class="px-4 py-5 sm:p-6">
          <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">\u8CC7\u6599\u5EAB\u5099\u4EFD</h3>
          <div class="space-y-4">
            <div class="flex items-center justify-between">
              <span class="text-sm text-gray-500">\u5099\u4EFD\u72C0\u614B</span>
              <span class="text-sm font-medium" id="backup-status">\u6AA2\u67E5\u4E2D...</span>
            </div>
            <div class="flex items-center justify-between">
              <span class="text-sm text-gray-500">\u6700\u5F8C\u5099\u4EFD</span>
              <span class="text-sm font-medium" id="last-backup">--</span>
            </div>
            <div class="flex space-x-2">
              <button onclick="createBackup()" class="bg-blue-600 text-white px-4 py-2 rounded-md text-sm font-medium hover:bg-blue-700">
                \u5275\u5EFA\u5099\u4EFD
              </button>
              <button onclick="checkBackupHealth()" class="bg-gray-600 text-white px-4 py-2 rounded-md text-sm font-medium hover:bg-gray-700">
                \u6AA2\u67E5\u5065\u5EB7\u72C0\u614B
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- \u901F\u7387\u9650\u5236\u7BA1\u7406 -->
      <div class="bg-white shadow rounded-lg">
        <div class="px-4 py-5 sm:p-6">
          <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">API \u901F\u7387\u9650\u5236</h3>
          <div class="space-y-4">
            <div class="flex items-center justify-between">
              <span class="text-sm text-gray-500">Google Places API</span>
              <span class="text-sm font-medium" id="google-api-usage">\u6AA2\u67E5\u4E2D...</span>
            </div>
            <div class="flex items-center justify-between">
              <span class="text-sm text-gray-500">\u7E3D\u8ACB\u6C42\u6578 (24h)</span>
              <span class="text-sm font-medium" id="total-requests">--</span>
            </div>
            <div class="flex space-x-2">
              <button onclick="checkRateLimitStats()" class="bg-green-600 text-white px-4 py-2 rounded-md text-sm font-medium hover:bg-green-700">
                \u67E5\u770B\u7D71\u8A08
              </button>
              <button onclick="cleanupRateLimitLogs()" class="bg-yellow-600 text-white px-4 py-2 rounded-md text-sm font-medium hover:bg-yellow-700">
                \u6E05\u7406\u65E5\u8A8C
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- \u5B89\u5168\u5BE9\u8A08 -->
      <div class="bg-white shadow rounded-lg">
        <div class="px-4 py-5 sm:p-6">
          <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">\u5B89\u5168\u5BE9\u8A08</h3>
          <div class="space-y-4">
            <div class="flex items-center justify-between">
              <span class="text-sm text-gray-500">\u5B89\u5168\u5206\u6578</span>
              <span class="text-sm font-medium" id="audit-score">--</span>
            </div>
            <div class="flex items-center justify-between">
              <span class="text-sm text-gray-500">\u95DC\u9375\u554F\u984C</span>
              <span class="text-sm font-medium" id="critical-issues">--</span>
            </div>
            <div class="flex space-x-2">
              <button onclick="runSecurityAudit()" class="bg-red-600 text-white px-4 py-2 rounded-md text-sm font-medium hover:bg-red-700">
                \u57F7\u884C\u5BE9\u8A08
              </button>
              <button onclick="getSecurityStatus()" class="bg-purple-600 text-white px-4 py-2 rounded-md text-sm font-medium hover:bg-purple-700">
                \u67E5\u770B\u72C0\u614B
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- \u7CFB\u7D71\u76E3\u63A7 -->
      <div class="bg-white shadow rounded-lg">
        <div class="px-4 py-5 sm:p-6">
          <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">\u7CFB\u7D71\u76E3\u63A7</h3>
          <div class="space-y-4">
            <div class="flex items-center justify-between">
              <span class="text-sm text-gray-500">\u8CC7\u6599\u5EAB\u72C0\u614B</span>
              <span class="text-sm font-medium" id="db-status">\u6AA2\u67E5\u4E2D...</span>
            </div>
            <div class="flex items-center justify-between">
              <span class="text-sm text-gray-500">\u5716\u7247\u932F\u8AA4</span>
              <span class="text-sm font-medium" id="image-errors">--</span>
            </div>
            <div class="flex space-x-2">
              <button onclick="refreshSystemStatus()" class="bg-indigo-600 text-white px-4 py-2 rounded-md text-sm font-medium hover:bg-indigo-700">
                \u5237\u65B0\u72C0\u614B
              </button>
              <button onclick="refreshImageStats()" class="bg-teal-600 text-white px-4 py-2 rounded-md text-sm font-medium hover:bg-teal-700">
                \u5716\u7247\u7D71\u8A08
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- \u5546\u5BB6\u9A57\u8B49\u7BA1\u7406 -->
      <div class="bg-white shadow rounded-lg">
        <div class="px-4 py-5 sm:p-6">
          <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">\u5546\u5BB6\u9A57\u8B49</h3>
          <div class="space-y-4">
            <div class="flex items-center justify-between">
              <span class="text-sm text-gray-500">\u5F85\u5BE9\u6838\u7533\u8ACB</span>
              <span class="text-sm font-medium" id="pending-verifications-count">\u6AA2\u67E5\u4E2D...</span>
            </div>
            <div class="flex items-center justify-between">
              <span class="text-sm text-gray-500">\u9A57\u8B49\u72C0\u614B</span>
              <span class="text-sm font-medium" id="verification-status">--</span>
            </div>
            <div class="flex space-x-2">
              <a href="/admin/verifications" class="bg-purple-600 text-white px-4 py-2 rounded-md text-sm font-medium hover:bg-purple-700 text-center">
                \u5BE9\u6838\u9A57\u8B49\u7533\u8ACB
              </a>
            </div>
          </div>
        </div>
      </div>

      <!-- \u751F\u614B\u7CFB\u7D71\u76E3\u63A7 -->
      <div class="bg-white shadow rounded-lg">
        <div class="px-4 py-5 sm:p-6">
          <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">\u751F\u614B\u7CFB\u7D71\u76E3\u63A7</h3>
          <div class="space-y-4">
            <div class="flex items-center justify-between">
              <span class="text-sm text-gray-500">\u7E3D\u9AD4\u5206\u6578</span>
              <span class="text-sm font-medium" id="ecosystem-overall-score">--</span>
            </div>
            <div class="flex items-center justify-between">
              <span class="text-sm text-gray-500">\u72C0\u614B</span>
              <span class="text-sm font-medium" id="ecosystem-status">\u6AA2\u67E5\u4E2D...</span>
            </div>
            <div class="flex space-x-2">
              <a href="/admin/ecosystem" class="bg-indigo-600 text-white px-4 py-2 rounded-md text-sm font-medium hover:bg-indigo-700 text-center">
                \u67E5\u770B\u8A73\u7D30\u5831\u544A
              </a>
            </div>
          </div>
        </div>
      </div>
    </div>
  `;
}
function renderSystemLogSection() {
  return `
    <div class="mt-8 bg-white shadow rounded-lg">
      <div class="px-4 py-5 sm:p-6">
        <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">\u7CFB\u7D71\u65E5\u8A8C</h3>
        <div class="bg-gray-50 rounded-md p-4">
          <pre id="system-log" class="text-sm text-gray-700 whitespace-pre-wrap">\u8F09\u5165\u4E2D...</pre>
        </div>
      </div>
    </div>
  `;
}

// src/pages/AdminDashboard.js
async function renderAdminDashboardPage(request, env, session, user, nonce, cssContent) {
  const authCheck = requireAdmin(user, request);
  if (authCheck)
    return authCheck;
  const dbHealth = await ServiceHealthChecker.checkDatabase(env.DB);
  if (!dbHealth.healthy) {
    console.error("[AdminDashboard] Database not available:", dbHealth.error);
    return ErrorResponseBuilder.buildDatabaseErrorPage({
      user,
      nonce,
      cssContent
    });
  }
  const content = `
    <div class="min-h-screen bg-gray-50 py-8">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        ${renderPageHeader2()}
        ${renderSystemStatusCards()}
        ${renderFeatureCards()}
        ${renderSystemLogSection()}
      </div>
    </div>

    <script nonce="${nonce}">
      // \u7CFB\u7D71\u72C0\u614B\u7BA1\u7406
      let systemStatus = {};
      let logMessages = [];

      // \u6DFB\u52A0\u65E5\u8A8C\u6D88\u606F
      function addLog(message, type = 'info') {
        const timestamp = new Date().toLocaleString();
        const logEntry = \`[\${timestamp}] \${type.toUpperCase()}: \${message}\`;
        logMessages.unshift(logEntry);
        if (logMessages.length > 50) logMessages.pop();
        
        const logElement = document.getElementById('system-log');
        logElement.textContent = logMessages.join('\\n');
      }

      // \u66F4\u65B0\u7CFB\u7D71\u72C0\u614B\u986F\u793A
      function updateSystemStatus(data) {
        systemStatus = data;
        
        // \u66F4\u65B0\u6982\u89BD\u5361\u7247
        document.getElementById('system-health-score').textContent = data.overallHealth?.score || '--';
        document.getElementById('system-health-status').textContent = data.overallHealth?.status || '--';
        
        document.getElementById('image-cache-count').textContent = data.imageCache?.total || '--';
        document.getElementById('api-usage').textContent = data.apiUsage?.daily || '--';
        document.getElementById('security-score').textContent = data.security?.score || '--';
        
        // \u66F4\u65B0\u8A73\u7D30\u72C0\u614B
        document.getElementById('backup-status').textContent = data.backup?.healthy ? '\u6B63\u5E38' : '\u7570\u5E38';
        document.getElementById('last-backup').textContent = data.backup?.lastBackup || '--';
        document.getElementById('google-api-usage').textContent = data.googleApi?.usage || '--';
        document.getElementById('total-requests').textContent = data.rateLimit?.total || '--';
        document.getElementById('audit-score').textContent = data.security?.score || '--';
        document.getElementById('critical-issues').textContent = data.security?.criticalIssues || '--';
        document.getElementById('db-status').textContent = data.database?.status || '--';
        document.getElementById('image-errors').textContent = data.imageErrors?.count || '--';
        
        addLog('\u7CFB\u7D71\u72C0\u614B\u5DF2\u66F4\u65B0', 'info');
      }

      // API \u8ABF\u7528\u51FD\u6578
      async function apiCall(endpoint, method = 'GET', body = null) {
        try {
          const options = {
            method,
            headers: {
              'Content-Type': 'application/json'
            }
          };
          
          if (body) {
            options.body = JSON.stringify(body);
          }
          
          const response = await fetch(endpoint, options);
          const data = await response.json();
          
          if (!response.ok) {
            throw new Error(data.error || 'API \u8ABF\u7528\u5931\u6557');
          }
          
          return data;
        } catch (error) {
          addLog(\`API \u932F\u8AA4: \${error.message}\`, 'error');
          throw error;
        }
      }

      // \u5275\u5EFA\u5099\u4EFD
      async function createBackup() {
        try {
          addLog('\u958B\u59CB\u5275\u5EFA\u5099\u4EFD...', 'info');
          const result = await apiCall('/api/admin/backup/create', 'POST');
          addLog(\`\u5099\u4EFD\u5275\u5EFA\u6210\u529F: \${result.backupKey}\`, 'success');
          await refreshSystemStatus();
        } catch (error) {
          addLog(\`\u5099\u4EFD\u5275\u5EFA\u5931\u6557: \${error.message}\`, 'error');
        }
      }

      // \u6AA2\u67E5\u5099\u4EFD\u5065\u5EB7\u72C0\u614B
      async function checkBackupHealth() {
        try {
          addLog('\u6AA2\u67E5\u5099\u4EFD\u5065\u5EB7\u72C0\u614B...', 'info');
          const result = await apiCall('/api/admin/backup/health');
          addLog(\`\u5099\u4EFD\u5065\u5EB7\u72C0\u614B: \${result.healthy ? '\u6B63\u5E38' : '\u7570\u5E38'}\`, result.healthy ? 'success' : 'warning');
          updateSystemStatus({...systemStatus, backup: result});
        } catch (error) {
          addLog(\`\u5099\u4EFD\u5065\u5EB7\u6AA2\u67E5\u5931\u6557: \${error.message}\`, 'error');
        }
      }

      // \u6AA2\u67E5\u901F\u7387\u9650\u5236\u7D71\u8A08
      async function checkRateLimitStats() {
        try {
          addLog('\u6AA2\u67E5\u901F\u7387\u9650\u5236\u7D71\u8A08...', 'info');
          const result = await apiCall('/api/admin/rate-limit/stats');
          addLog(\`\u901F\u7387\u9650\u5236\u7D71\u8A08: \${result.totalRequests} \u500B\u8ACB\u6C42\`, 'info');
          updateSystemStatus({...systemStatus, rateLimit: result});
        } catch (error) {
          addLog(\`\u901F\u7387\u9650\u5236\u7D71\u8A08\u6AA2\u67E5\u5931\u6557: \${error.message}\`, 'error');
        }
      }

      // \u6E05\u7406\u901F\u7387\u9650\u5236\u65E5\u8A8C
      async function cleanupRateLimitLogs() {
        try {
          addLog('\u6E05\u7406\u901F\u7387\u9650\u5236\u65E5\u8A8C...', 'info');
          const result = await apiCall('/api/admin/rate-limit/cleanup', 'POST');
          addLog(\`\u6E05\u7406\u5B8C\u6210: \u522A\u9664 \${result.deletedCount} \u689D\u8A18\u9304\`, 'success');
        } catch (error) {
          addLog(\`\u6E05\u7406\u5931\u6557: \${error.message}\`, 'error');
        }
      }

      // \u57F7\u884C\u5B89\u5168\u5BE9\u8A08
      async function runSecurityAudit() {
        try {
          addLog('\u57F7\u884C\u5B89\u5168\u5BE9\u8A08...', 'info');
          const result = await apiCall('/api/admin/security/audit', 'POST');
          addLog(\`\u5B89\u5168\u5BE9\u8A08\u5B8C\u6210: \u5206\u6578 \${result.overallScore}/100\`, 'info');
          updateSystemStatus({...systemStatus, security: result});
        } catch (error) {
          addLog(\`\u5B89\u5168\u5BE9\u8A08\u5931\u6557: \${error.message}\`, 'error');
        }
      }

      // \u7372\u53D6\u5B89\u5168\u72C0\u614B
      async function getSecurityStatus() {
        try {
          addLog('\u7372\u53D6\u5B89\u5168\u72C0\u614B...', 'info');
          const result = await apiCall('/api/admin/security/status');
          addLog(\`\u5B89\u5168\u72C0\u614B: \${result.status}\`, 'info');
          updateSystemStatus({...systemStatus, security: result});
        } catch (error) {
          addLog(\`\u5B89\u5168\u72C0\u614B\u6AA2\u67E5\u5931\u6557: \${error.message}\`, 'error');
        }
      }

      // \u5237\u65B0\u7CFB\u7D71\u72C0\u614B
      async function refreshSystemStatus() {
        try {
          addLog('\u5237\u65B0\u7CFB\u7D71\u72C0\u614B...', 'info');
          const result = await apiCall('/api/admin/system/status');
          updateSystemStatus(result);
          addLog('\u7CFB\u7D71\u72C0\u614B\u5DF2\u5237\u65B0', 'success');
        } catch (error) {
          addLog(\`\u7CFB\u7D71\u72C0\u614B\u5237\u65B0\u5931\u6557: \${error.message}\`, 'error');
        }
      }

      // \u5237\u65B0\u5716\u7247\u7D71\u8A08
      async function refreshImageStats() {
        try {
          addLog('\u5237\u65B0\u5716\u7247\u7D71\u8A08...', 'info');
          const result = await apiCall('/api/image/stats');
          updateSystemStatus({...systemStatus, imageCache: result});
          addLog(\`\u5716\u7247\u7D71\u8A08: \${result.total} \u5F35\u5716\u7247\`, 'info');
        } catch (error) {
          addLog(\`\u5716\u7247\u7D71\u8A08\u5237\u65B0\u5931\u6557: \${error.message}\`, 'error');
        }
      }

      // \u9801\u9762\u8F09\u5165\u6642\u521D\u59CB\u5316
      // \u8F09\u5165\u5F85\u5BE9\u6838\u9A57\u8B49\u7533\u8ACB\u6578\u91CF
      async function loadPendingVerificationsCount() {
        try {
          const response = await fetch('/api/business/verify/pending?limit=1&offset=0', {
            credentials: 'include'
          });
          if (response.ok) {
            const data = await response.json();
            if (data.success) {
              document.getElementById('pending-verifications-count').textContent = data.total || 0;
              document.getElementById('verification-status').textContent = data.total > 0 ? '\u6709\u5F85\u5BE9\u6838' : '\u7121\u5F85\u5BE9\u6838';
            }
          }
        } catch (error) {
          console.error('\u8F09\u5165\u9A57\u8B49\u7533\u8ACB\u6578\u91CF\u5931\u6557:', error);
          document.getElementById('pending-verifications-count').textContent = '--';
        }
      }

      // \u8F09\u5165\u751F\u614B\u7CFB\u7D71\u7E3D\u9AD4\u5206\u6578
      async function loadEcosystemScore() {
        try {
          const response = await fetch('/api/admin/ecosystem/report?days=7', {
            credentials: 'include'
          });
          if (response.ok) {
            const data = await response.json();
            if (data.overallScore !== undefined) {
              document.getElementById('ecosystem-overall-score').textContent = data.overallScore;
              const statusElement = document.getElementById('ecosystem-status');
              if (data.overallScore >= 80) {
                statusElement.textContent = '\u5065\u5EB7';
                statusElement.className = 'text-sm font-medium text-green-600';
              } else if (data.overallScore >= 60) {
                statusElement.textContent = '\u826F\u597D';
                statusElement.className = 'text-sm font-medium text-yellow-600';
              } else {
                statusElement.textContent = '\u9700\u95DC\u6CE8';
                statusElement.className = 'text-sm font-medium text-red-600';
              }
            }
          }
        } catch (error) {
          console.error('\u8F09\u5165\u751F\u614B\u7CFB\u7D71\u5206\u6578\u5931\u6557:', error);
          document.getElementById('ecosystem-overall-score').textContent = '--';
          document.getElementById('ecosystem-status').textContent = '\u8F09\u5165\u5931\u6557';
        }
      }

      document.addEventListener('DOMContentLoaded', function() {
        addLog('\u7BA1\u7406\u54E1\u5100\u8868\u677F\u5DF2\u8F09\u5165', 'info');
        refreshSystemStatus();
        refreshImageStats();
        loadPendingVerificationsCount();
        loadEcosystemScore();
      });

      // \u5B9A\u671F\u5237\u65B0\u72C0\u614B
      setInterval(() => {
        refreshSystemStatus();
      }, 30000); // \u6BCF30\u79D2\u5237\u65B0\u4E00\u6B21
    </script>
  `;
  return new Response(pageTemplate2({
    title: "\u7BA1\u7406\u54E1\u5100\u8868\u677F",
    content,
    user,
    nonce,
    cssContent
  }), {
    headers: { "Content-Type": "text/html;charset=utf-8" }
  });
}

// src/pages/AIAdminPage.js
init_layout();
init_auth();

// src/templates/aiAdminPage.js
function renderPageHeader3() {
  return `
    <div class="mb-6">
      <h1 class="text-3xl font-bold text-gray-900 mb-2">AI \u7BA1\u7406\u5F8C\u53F0</h1>
      <p class="text-gray-600">\u76E3\u63A7\u4F7F\u7528\u3001\u6536\u96C6\u53CD\u994B\u3001\u512A\u5316\u56DE\u7B54\u54C1\u8CEA</p>
    </div>
  `;
}
function renderStatisticsCards2() {
  return `
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
      <div class="bg-white rounded-lg shadow p-4">
        <div class="text-sm text-gray-600 mb-1">\u7E3D\u5C0D\u8A71\u6578</div>
        <div id="total-conversations" class="text-2xl font-bold text-gray-900">-</div>
      </div>
      <div class="bg-white rounded-lg shadow p-4">
        <div class="text-sm text-gray-600 mb-1">\u4ECA\u65E5\u5C0D\u8A71</div>
        <div id="today-conversations" class="text-2xl font-bold text-blue-600">-</div>
      </div>
      <div class="bg-white rounded-lg shadow p-4">
        <div class="text-sm text-gray-600 mb-1">\u77E5\u8B58\u5EAB\u9805\u76EE</div>
        <div id="knowledge-base-count" class="text-2xl font-bold text-green-600">-</div>
      </div>
      <div class="bg-white rounded-lg shadow p-4">
        <div class="text-sm text-gray-600 mb-1">\u4F7F\u7528\u8005\u53CD\u994B</div>
        <div id="feedback-count" class="text-2xl font-bold text-purple-600">-</div>
      </div>
    </div>
  `;
}
function renderTabNavigation() {
  return `
    <div class="bg-white rounded-lg shadow mb-6">
      <div class="border-b border-gray-200">
        <nav class="flex -mb-px">
          <button onclick="showTab('conversations')" id="tab-conversations" class="tab-button active px-6 py-3 text-sm font-medium text-blue-600 border-b-2 border-blue-600">
            \u5C0D\u8A71\u8A18\u9304
          </button>
          <button onclick="showTab('knowledge')" id="tab-knowledge" class="tab-button px-6 py-3 text-sm font-medium text-gray-500 hover:text-gray-700">
            \u77E5\u8B58\u5EAB
          </button>
          <button onclick="showTab('feedback')" id="tab-feedback" class="tab-button px-6 py-3 text-sm font-medium text-gray-500 hover:text-gray-700">
            \u4F7F\u7528\u8005\u53CD\u994B
          </button>
          <button onclick="showTab('analytics')" id="tab-analytics" class="tab-button px-6 py-3 text-sm font-medium text-gray-500 hover:text-gray-700">
            \u4F7F\u7528\u5206\u6790
          </button>
          <button onclick="showTab('question-learning')" id="tab-question-learning" class="tab-button px-6 py-3 text-sm font-medium text-gray-500 hover:text-gray-700">
            \u554F\u984C\u5B78\u7FD2
          </button>
        </nav>
      </div>
  `;
}
function renderConversationsPanel() {
  return `
    <div id="panel-conversations" class="tab-panel p-6">
      <div class="mb-4 flex justify-between items-center">
        <h2 class="text-xl font-semibold">\u5C0D\u8A71\u8A18\u9304</h2>
        <div class="flex space-x-2">
          <input type="text" id="search-conversations" placeholder="\u641C\u5C0B\u5C0D\u8A71..." class="border border-gray-300 rounded px-3 py-1 text-sm" onkeyup="searchConversations()">
          <select id="filter-user" class="border border-gray-300 rounded px-3 py-1 text-sm" onchange="loadConversations()">
            <option value="">\u6240\u6709\u4F7F\u7528\u8005</option>
            <option value="logged-in">\u5DF2\u767B\u5165</option>
            <option value="anonymous">\u672A\u767B\u5165</option>
          </select>
        </div>
      </div>
      <div id="conversations-list" class="space-y-4">
        <div class="text-center text-gray-500 py-8">\u8F09\u5165\u4E2D...</div>
      </div>
      <div id="conversations-pagination" class="mt-4 flex justify-center space-x-2"></div>
    </div>
  `;
}
function renderKnowledgePanel() {
  return `
    <div id="panel-knowledge" class="tab-panel hidden p-6">
      <div class="mb-4 flex justify-between items-center">
        <h2 class="text-xl font-semibold">\u77E5\u8B58\u5EAB\u7BA1\u7406</h2>
        <button onclick="showAddKnowledgeModal()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
          \u65B0\u589E\u77E5\u8B58
        </button>
      </div>
      <div id="knowledge-list" class="space-y-4">
        <div class="text-center text-gray-500 py-8">\u8F09\u5165\u4E2D...</div>
      </div>
    </div>
  `;
}
function renderFeedbackPanel() {
  return `
    <div id="panel-feedback" class="tab-panel hidden p-6">
      <div class="mb-4">
        <h2 class="text-xl font-semibold">\u4F7F\u7528\u8005\u53CD\u994B</h2>
      </div>
      <div id="feedback-list" class="space-y-4">
        <div class="text-center text-gray-500 py-8">\u8F09\u5165\u4E2D...</div>
      </div>
    </div>
  `;
}
function renderAnalyticsPanel() {
  return `
    <div id="panel-analytics" class="tab-panel hidden p-6">
      <div class="mb-4">
        <h2 class="text-xl font-semibold">\u4F7F\u7528\u5206\u6790</h2>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
        <div class="bg-gray-50 rounded-lg p-4">
          <h3 class="font-semibold mb-2">\u71B1\u9580\u554F\u984C</h3>
          <div id="popular-questions" class="space-y-2">
            <div class="text-center text-gray-500 py-4">\u8F09\u5165\u4E2D...</div>
          </div>
        </div>
        <div class="bg-gray-50 rounded-lg p-4">
          <h3 class="font-semibold mb-2">\u4F7F\u7528\u6642\u6BB5</h3>
          <div id="usage-hours" class="space-y-2">
            <div class="text-center text-gray-500 py-4">\u8F09\u5165\u4E2D...</div>
          </div>
        </div>
      </div>
    </div>
  `;
}
function renderQuestionLearningPanel() {
  return `
    <div id="panel-question-learning" class="tab-panel hidden p-6">
      <div class="mb-6">
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-xl font-semibold">\u554F\u984C\u5B78\u7FD2\u7CFB\u7D71</h2>
          <button onclick="extractTemplates()" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 text-sm">
            \u63D0\u53D6\u554F\u984C\u6A21\u677F
          </button>
        </div>
        
        <!-- \u5B50\u6A19\u7C64\u9801 -->
        <div class="border-b border-gray-200 mb-4">
          <nav class="flex -mb-px">
            <button onclick="showQuestionLearningTab('learning')" id="qltab-learning" class="qltab-button active px-4 py-2 text-sm font-medium text-blue-600 border-b-2 border-blue-600">
              \u5B78\u7FD2\u8A18\u9304
            </button>
            <button onclick="showQuestionLearningTab('templates')" id="qltab-templates" class="qltab-button px-4 py-2 text-sm font-medium text-gray-500 hover:text-gray-700">
              \u554F\u984C\u6A21\u677F
            </button>
            <button onclick="showQuestionLearningTab('improvements')" id="qltab-improvements" class="qltab-button px-4 py-2 text-sm font-medium text-gray-500 hover:text-gray-700">
              \u6539\u9032\u8A18\u9304
            </button>
          </nav>
        </div>
      </div>

      <!-- \u5B78\u7FD2\u8A18\u9304\u9762\u677F -->
      <div id="qlpanel-learning" class="qlpanel">
        <div class="mb-4 flex space-x-2">
          <select id="filter-category" class="border border-gray-300 rounded px-3 py-1 text-sm" onchange="loadQuestionLearning()">
            <option value="">\u6240\u6709\u985E\u5225</option>
            <option value="location">\u5730\u9EDE</option>
            <option value="price">\u50F9\u683C</option>
            <option value="time">\u6642\u9593</option>
            <option value="distance">\u8DDD\u96E2</option>
            <option value="memory">\u56DE\u61B6</option>
            <option value="identity">\u8EAB\u4EFD</option>
            <option value="general">\u4E00\u822C</option>
          </select>
          <select id="filter-question-type" class="border border-gray-300 rounded px-3 py-1 text-sm" onchange="loadQuestionLearning()">
            <option value="">\u6240\u6709\u985E\u578B</option>
            <option value="user_query">\u7528\u6236\u554F\u984C</option>
            <option value="ai_question">AI\u554F\u984C</option>
          </select>
        </div>
        <div id="question-learning-list" class="space-y-4">
          <div class="text-center text-gray-500 py-8">\u8F09\u5165\u4E2D...</div>
        </div>
        <div id="question-learning-pagination" class="mt-4 flex justify-center space-x-2"></div>
      </div>

      <!-- \u554F\u984C\u6A21\u677F\u9762\u677F -->
      <div id="qlpanel-templates" class="qlpanel hidden">
        <div class="mb-4 flex space-x-2">
          <select id="filter-template-type" class="border border-gray-300 rounded px-3 py-1 text-sm" onchange="loadQuestionTemplates()">
            <option value="">\u6240\u6709\u985E\u578B</option>
            <option value="location">\u5730\u9EDE</option>
            <option value="price">\u50F9\u683C</option>
            <option value="time">\u6642\u9593</option>
            <option value="distance">\u8DDD\u96E2</option>
            <option value="memory">\u56DE\u61B6</option>
            <option value="identity">\u8EAB\u4EFD</option>
            <option value="general">\u4E00\u822C</option>
          </select>
        </div>
        <div id="question-templates-list" class="space-y-4">
          <div class="text-center text-gray-500 py-8">\u8F09\u5165\u4E2D...</div>
        </div>
      </div>

      <!-- \u6539\u9032\u8A18\u9304\u9762\u677F -->
      <div id="qlpanel-improvements" class="qlpanel hidden">
        <div id="question-improvements-list" class="space-y-4">
          <div class="text-center text-gray-500 py-8">\u8F09\u5165\u4E2D...</div>
        </div>
        <div id="question-improvements-pagination" class="mt-4 flex justify-center space-x-2"></div>
      </div>
    </div>
  `;
}
function renderAddKnowledgeModal() {
  return `
    <div id="add-knowledge-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
      <div class="bg-white rounded-lg p-6 max-w-2xl w-full mx-4">
        <h3 class="text-xl font-semibold mb-4">\u65B0\u589E\u77E5\u8B58\u5EAB\u9805\u76EE</h3>
        <form id="add-knowledge-form" onsubmit="addKnowledge(event)">
          <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-1">\u554F\u984C</label>
            <input type="text" id="knowledge-question" required class="w-full border border-gray-300 rounded px-3 py-2" placeholder="\u4F8B\u5982\uFF1A\u6F8E\u6E56\u54EA\u88E1\u53EF\u4EE5\u770B\u5915\u967D\uFF1F">
          </div>
          <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-1">\u7B54\u6848</label>
            <textarea id="knowledge-answer" required rows="5" class="w-full border border-gray-300 rounded px-3 py-2" placeholder="\u8A73\u7D30\u7B54\u6848..."></textarea>
          </div>
          <div class="flex justify-end space-x-2">
            <button type="button" onclick="closeAddKnowledgeModal()" class="px-4 py-2 border border-gray-300 rounded hover:bg-gray-50">
              \u53D6\u6D88
            </button>
            <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
              \u65B0\u589E
            </button>
          </div>
        </form>
      </div>
    </div>
  `;
}

// src/pages/AIAdminPage.js
async function renderAIAdminPage(request, env, session, user, nonce, cssContent) {
  const authCheck = requireAdmin(user, request);
  if (authCheck)
    return authCheck;
  const dbHealth = await ServiceHealthChecker.checkDatabase(env.DB);
  if (!dbHealth.healthy) {
    console.error("[AIAdminPage] Database not available:", dbHealth.error);
    return ErrorResponseBuilder.buildDatabaseErrorPage({
      user,
      nonce,
      cssContent
    });
  }
  const content = `
    <div class="max-w-7xl mx-auto px-4 py-8">
      ${renderPageHeader3()}
      ${renderStatisticsCards2()}
      ${renderTabNavigation()}
        ${renderConversationsPanel()}
        ${renderKnowledgePanel()}
        ${renderFeedbackPanel()}
        ${renderAnalyticsPanel()}
        ${renderQuestionLearningPanel()}
      </div>
    </div>
    ${renderAddKnowledgeModal()}

    <script nonce="${nonce}">
      let currentTab = 'conversations';
      let currentPage = 1;
      const pageSize = 20;

      // \u8F09\u5165\u7D71\u8A08\u8CC7\u6599
      async function loadStatistics() {
        try {
          console.log('[AI Admin] Loading statistics...');
          const response = await fetch('/api/ai/admin/statistics');
          console.log('[AI Admin] Statistics response status:', response.status);
          
          if (!response.ok) {
            console.error('[AI Admin] Statistics response not OK:', response.status, response.statusText);
            return;
          }
          
          const data = await response.json();
          console.log('[AI Admin] Statistics data:', data);
          
          if (data.success) {
            document.getElementById('total-conversations').textContent = data.totalConversations || 0;
            document.getElementById('today-conversations').textContent = data.todayConversations || 0;
            document.getElementById('knowledge-base-count').textContent = data.knowledgeBaseCount || 0;
            document.getElementById('feedback-count').textContent = data.feedbackCount || 0;
          } else {
            console.error('[AI Admin] Statistics API returned success=false:', data);
          }
        } catch (error) {
          console.error('[AI Admin] Error loading statistics:', error);
        }
      }

      // \u6A19\u7C64\u9801\u5207\u63DB
      function showTab(tabName) {
        currentTab = tabName;
        
        // \u66F4\u65B0\u6309\u9215\u72C0\u614B
        document.querySelectorAll('.tab-button').forEach(btn => {
          btn.classList.remove('active', 'text-blue-600', 'border-blue-600');
          btn.classList.add('text-gray-500');
        });
        document.getElementById('tab-' + tabName).classList.add('active', 'text-blue-600', 'border-blue-600');
        document.getElementById('tab-' + tabName).classList.remove('text-gray-500');
        
        // \u66F4\u65B0\u9762\u677F\u986F\u793A
        document.querySelectorAll('.tab-panel').forEach(panel => {
          panel.classList.add('hidden');
        });
        document.getElementById('panel-' + tabName).classList.remove('hidden');
        
        // \u8F09\u5165\u5C0D\u61C9\u8CC7\u6599
        if (tabName === 'conversations') {
          loadConversations();
        } else if (tabName === 'knowledge') {
          loadKnowledgeBase();
        } else if (tabName === 'feedback') {
          loadFeedback();
        } else if (tabName === 'analytics') {
          loadAnalytics();
        } else if (tabName === 'question-learning') {
          showQuestionLearningTab('learning');
        }
      }

      // \u8F09\u5165\u5C0D\u8A71\u8A18\u9304
      async function loadConversations() {
        const search = document.getElementById('search-conversations')?.value || '';
        const filter = document.getElementById('filter-user')?.value || '';
        
        console.log('[AI Admin] Loading conversations:', { page: currentPage, pageSize, search, filter });
        
        try {
          const url = '/api/ai/admin/conversations?page=' + currentPage + '&pageSize=' + pageSize + '&search=' + encodeURIComponent(search) + '&filter=' + filter;
          console.log('[AI Admin] Fetching:', url);
          
          const response = await fetch(url);
          console.log('[AI Admin] Response status:', response.status, response.statusText);
          
          if (!response.ok) {
            const errorText = await response.text();
            console.error('[AI Admin] Response error:', errorText);
            document.getElementById('conversations-list').innerHTML = '<div class="text-center text-red-500 py-8">\u8F09\u5165\u5931\u6557\uFF1A' + response.status + ' ' + response.statusText + '</div>';
            return;
          }
          
          const data = await response.json();
          console.log('[AI Admin] Response data:', {
            success: data.success,
            conversationsCount: data.conversations?.length || 0,
            totalPages: data.totalPages,
            currentPage: data.currentPage
          });
          
          if (data.success) {
            renderConversations(data.conversations || []);
            renderPagination(data.totalPages || 1);
          } else {
            console.error('[AI Admin] API returned success=false:', data);
            document.getElementById('conversations-list').innerHTML = '<div class="text-center text-red-500 py-8">\u8F09\u5165\u5931\u6557\uFF1A' + (data.error || '\u672A\u77E5\u932F\u8AA4') + '</div>';
          }
        } catch (error) {
          console.error('[AI Admin] Error loading conversations:', error);
          document.getElementById('conversations-list').innerHTML = '<div class="text-center text-red-500 py-8">\u8F09\u5165\u5931\u6557\uFF1A' + error.message + '</div>';
        }
      }

      // \u6E32\u67D3\u5C0D\u8A71\u8A18\u9304
      function renderConversations(conversations) {
        const container = document.getElementById('conversations-list');
        
        if (conversations.length === 0) {
          container.innerHTML = '<div class="text-center text-gray-500 py-8">\u6C92\u6709\u5C0D\u8A71\u8A18\u9304</div>';
          return;
        }
        
        container.innerHTML = conversations.map(conv => \`
          <div class="border border-gray-200 rounded-lg p-4">
            <div class="flex justify-between items-start mb-2">
              <div>
                <span class="text-sm font-medium text-gray-900">\${conv.message_type === 'user' ? '\u4F7F\u7528\u8005' : 'AI'}</span>
                <span class="text-xs text-gray-500 ml-2">\${new Date(conv.created_at).toLocaleString('zh-TW')}</span>
              </div>
              \${conv.user_id ? '<span class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded">\u5DF2\u767B\u5165</span>' : '<span class="text-xs bg-gray-100 text-gray-800 px-2 py-1 rounded">\u672A\u767B\u5165</span>'}
            </div>
            <p class="text-sm text-gray-700 whitespace-pre-wrap">\${escapeHtml(conv.message_content)}</p>
          </div>
        \`).join('');
      }

      // \u8F09\u5165\u77E5\u8B58\u5EAB
      async function loadKnowledgeBase() {
        try {
          const response = await fetch('/api/ai/admin/knowledge');
          const data = await response.json();
          
          if (data.success) {
            renderKnowledgeBase(data.knowledge || []);
          }
        } catch (error) {
          console.error('Error loading knowledge base:', error);
        }
      }

      // \u6E32\u67D3\u77E5\u8B58\u5EAB
      function renderKnowledgeBase(knowledge) {
        const container = document.getElementById('knowledge-list');
        
        if (knowledge.length === 0) {
          container.innerHTML = '<div class="text-center text-gray-500 py-8">\u77E5\u8B58\u5EAB\u70BA\u7A7A</div>';
          return;
        }
        
        container.innerHTML = knowledge.map(kb => \`
          <div class="border border-gray-200 rounded-lg p-4">
            <div class="flex justify-between items-start mb-2">
              <h3 class="font-medium text-gray-900">\${escapeHtml(kb.question)}</h3>
              <div class="flex space-x-2">
                <span class="text-xs text-gray-500">\u4F7F\u7528 \${kb.usage_count || 0} \u6B21</span>
                <button onclick="deleteKnowledge('\${kb.id}')" class="text-red-600 hover:text-red-700 text-sm">\u522A\u9664</button>
              </div>
            </div>
            <p class="text-sm text-gray-700">\${escapeHtml(kb.answer)}</p>
          </div>
        \`).join('');
      }

      // \u8F09\u5165\u53CD\u994B
      async function loadFeedback() {
        try {
          const response = await fetch('/api/ai/admin/feedback');
          const data = await response.json();
          
          if (data.success) {
            renderFeedback(data.feedback || []);
          }
        } catch (error) {
          console.error('Error loading feedback:', error);
        }
      }

      // \u6E32\u67D3\u53CD\u994B
      function renderFeedback(feedback) {
        const container = document.getElementById('feedback-list');
        
        if (feedback.length === 0) {
          container.innerHTML = '<div class="text-center text-gray-500 py-8">\u6C92\u6709\u53CD\u994B</div>';
          return;
        }
        
        container.innerHTML = feedback.map(fb => \`
          <div class="border border-gray-200 rounded-lg p-4">
            <div class="flex justify-between items-start mb-2">
              <span class="text-sm font-medium \${fb.feedback_type === 'helpful' ? 'text-green-600' : fb.feedback_type === 'not_helpful' ? 'text-red-600' : 'text-yellow-600'}">
                \${fb.feedback_type === 'helpful' ? '\u6709\u5E6B\u52A9' : fb.feedback_type === 'not_helpful' ? '\u6C92\u5E6B\u52A9' : fb.feedback_type === 'incorrect' ? '\u932F\u8AA4' : '\u5EFA\u8B70'}
              </span>
              <span class="text-xs text-gray-500">\${new Date(fb.created_at).toLocaleString('zh-TW')}</span>
            </div>
            \${fb.feedback_content ? '<p class="text-sm text-gray-700">' + escapeHtml(fb.feedback_content) + '</p>' : ''}
          </div>
        \`).join('');
      }

      // \u8F09\u5165\u5206\u6790
      async function loadAnalytics() {
        try {
          const response = await fetch('/api/ai/admin/analytics');
          const data = await response.json();
          
          if (data.success) {
            renderAnalytics(data);
          }
        } catch (error) {
          console.error('Error loading analytics:', error);
        }
      }

      // \u6E32\u67D3\u5206\u6790
      function renderAnalytics(data) {
        // \u71B1\u9580\u554F\u984C
        const popularQuestions = document.getElementById('popular-questions');
        if (data.popularQuestions && data.popularQuestions.length > 0) {
          popularQuestions.innerHTML = data.popularQuestions.map((q, i) => \`
            <div class="flex justify-between text-sm">
              <span>\${i + 1}. \${escapeHtml(q.question)}</span>
              <span class="text-gray-500">\${q.count} \u6B21</span>
            </div>
          \`).join('');
        } else {
          popularQuestions.innerHTML = '<div class="text-center text-gray-500 py-4">\u6C92\u6709\u8CC7\u6599</div>';
        }
      }

      // \u65B0\u589E\u77E5\u8B58
      async function addKnowledge(event) {
        event.preventDefault();
        const question = document.getElementById('knowledge-question').value;
        const answer = document.getElementById('knowledge-answer').value;
        
        try {
          const response = await fetch('/api/ai/admin/knowledge', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ question, answer })
          });
          
          const data = await response.json();
          if (data.success) {
            closeAddKnowledgeModal();
            if (window.showToast) {
              window.showToast('\u77E5\u8B58\u5EAB\u9805\u76EE\u5DF2\u65B0\u589E', 'success');
            }
            loadKnowledgeBase();
          } else {
            if (window.showToast) {
              window.showToast('\u65B0\u589E\u5931\u6557\uFF1A' + (data.error || '\u672A\u77E5\u932F\u8AA4'), 'error');
            } else {
              alert('\u65B0\u589E\u5931\u6557\uFF1A' + (data.error || '\u672A\u77E5\u932F\u8AA4'));
            }
          }
        } catch (error) {
          console.error('Error adding knowledge:', error);
          if (window.showToast) {
            window.showToast('\u65B0\u589E\u5931\u6557', 'error');
          } else {
            alert('\u65B0\u589E\u5931\u6557');
          }
        }
      }

      function showAddKnowledgeModal() {
        document.getElementById('add-knowledge-modal').classList.remove('hidden');
      }

      function closeAddKnowledgeModal() {
        document.getElementById('add-knowledge-modal').classList.add('hidden');
        document.getElementById('add-knowledge-form').reset();
      }

      function deleteKnowledge(id) {
        if (!confirm('\u78BA\u5B9A\u8981\u522A\u9664\u9019\u500B\u77E5\u8B58\u5EAB\u9805\u76EE\u55CE\uFF1F')) return;
        
        fetch(\`/api/ai/admin/knowledge/\${id}\`, {
          method: 'DELETE'
        }).then(() => {
          loadKnowledgeBase();
        });
      }

      function renderPagination(totalPages) {
        const container = document.getElementById('conversations-pagination');
        if (totalPages <= 1) {
          container.innerHTML = '';
          return;
        }
        
        let html = '';
        for (let i = 1; i <= totalPages; i++) {
          html += \`<button onclick="currentPage = \${i}; loadConversations();" class="px-3 py-1 border rounded \${i === currentPage ? 'bg-blue-600 text-white' : 'bg-white'}">\${i}</button>\`;
        }
        container.innerHTML = html;
      }

      function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }

      // \u554F\u984C\u5B78\u7FD2\u76F8\u95DC\u8B8A\u6578
      let currentQuestionLearningPage = 1;
      let currentImprovementsPage = 1;
      let currentQuestionLearningTab = 'learning';

      // \u554F\u984C\u5B78\u7FD2\u5B50\u6A19\u7C64\u9801\u5207\u63DB
      function showQuestionLearningTab(tabName) {
        currentQuestionLearningTab = tabName;
        
        // \u66F4\u65B0\u6309\u9215\u72C0\u614B
        document.querySelectorAll('.qltab-button').forEach(btn => {
          btn.classList.remove('active', 'text-blue-600', 'border-blue-600');
          btn.classList.add('text-gray-500');
        });
        document.getElementById('qltab-' + tabName).classList.add('active', 'text-blue-600', 'border-blue-600');
        document.getElementById('qltab-' + tabName).classList.remove('text-gray-500');
        
        // \u66F4\u65B0\u9762\u677F\u986F\u793A
        document.querySelectorAll('.qlpanel').forEach(panel => {
          panel.classList.add('hidden');
        });
        document.getElementById('qlpanel-' + tabName).classList.remove('hidden');
        
        // \u8F09\u5165\u5C0D\u61C9\u8CC7\u6599
        if (tabName === 'learning') {
          loadQuestionLearning();
        } else if (tabName === 'templates') {
          loadQuestionTemplates();
        } else if (tabName === 'improvements') {
          loadQuestionImprovements();
        }
      }

      // \u8F09\u5165\u554F\u984C\u5B78\u7FD2\u8A18\u9304
      async function loadQuestionLearning() {
        const category = document.getElementById('filter-category')?.value || '';
        const questionType = document.getElementById('filter-question-type')?.value || '';
        
        try {
          const params = new URLSearchParams({
            page: currentQuestionLearningPage,
            pageSize: pageSize
          });
          if (category) params.append('category', category);
          if (questionType) params.append('questionType', questionType);
          
          const response = await fetch(\`/api/ai/admin/question-learning?\${params}\`);
          const data = await response.json();
          
          if (data.success) {
            renderQuestionLearning(data.learning || []);
            renderQuestionLearningPagination(data.totalPages || 1);
          }
        } catch (error) {
          console.error('Error loading question learning:', error);
          document.getElementById('question-learning-list').innerHTML = '<div class="text-center text-red-500 py-8">\u8F09\u5165\u5931\u6557</div>';
        }
      }

      // \u6E32\u67D3\u554F\u984C\u5B78\u7FD2\u8A18\u9304
      function renderQuestionLearning(learning) {
        const container = document.getElementById('question-learning-list');
        
        if (learning.length === 0) {
          container.innerHTML = '<div class="text-center text-gray-500 py-8">\u6C92\u6709\u5B78\u7FD2\u8A18\u9304</div>';
          return;
        }
        
        container.innerHTML = learning.map(item => {
          const qualityScore = (item.question_quality_score * 100).toFixed(1);
          const clarityScore = (item.clarity_score * 100).toFixed(1);
          const specificityScore = (item.specificity_score * 100).toFixed(1);
          const successBadge = item.led_to_successful_answer 
            ? '<span class="text-xs bg-green-100 text-green-800 px-2 py-1 rounded">\u6210\u529F</span>'
            : '<span class="text-xs bg-gray-100 text-gray-800 px-2 py-1 rounded">\u672A\u6210\u529F</span>';
          
          return \`
            <div class="border border-gray-200 rounded-lg p-4">
              <div class="flex justify-between items-start mb-2">
                <div class="flex-1">
                  <div class="flex items-center space-x-2 mb-2">
                    <span class="text-sm font-medium text-gray-900">\${item.question_type === 'user_query' ? '\u7528\u6236\u554F\u984C' : 'AI\u554F\u984C'}</span>
                    <span class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded">\${item.question_category || 'general'}</span>
                    \${successBadge}
                  </div>
                  <p class="text-sm text-gray-700 mb-2">\${escapeHtml(item.original_question)}</p>
                  <div class="flex space-x-4 text-xs text-gray-500">
                    <span>\u54C1\u8CEA: \${qualityScore}%</span>
                    <span>\u6E05\u6670\u5EA6: \${clarityScore}%</span>
                    <span>\u5177\u9AD4\u6027: \${specificityScore}%</span>
                    \${item.answer_quality_score ? '<span>\u7B54\u6848\u54C1\u8CEA: ' + (item.answer_quality_score * 100).toFixed(1) + '%</span>' : ''}
                  </div>
                </div>
                <span class="text-xs text-gray-500 ml-4">\${new Date(item.created_at).toLocaleString('zh-TW')}</span>
              </div>
            </div>
          \`;
        }).join('');
      }

      // \u8F09\u5165\u554F\u984C\u6A21\u677F
      async function loadQuestionTemplates() {
        const templateType = document.getElementById('filter-template-type')?.value || '';
        
        try {
          const params = new URLSearchParams();
          if (templateType) params.append('templateType', templateType);
          
          const response = await fetch(\`/api/ai/admin/question-templates?\${params}\`);
          const data = await response.json();
          
          if (data.success) {
            renderQuestionTemplates(data.templates || []);
          }
        } catch (error) {
          console.error('Error loading question templates:', error);
          document.getElementById('question-templates-list').innerHTML = '<div class="text-center text-red-500 py-8">\u8F09\u5165\u5931\u6557</div>';
        }
      }

      // \u6E32\u67D3\u554F\u984C\u6A21\u677F
      function renderQuestionTemplates(templates) {
        const container = document.getElementById('question-templates-list');
        
        if (templates.length === 0) {
          container.innerHTML = '<div class="text-center text-gray-500 py-8">\u6C92\u6709\u554F\u984C\u6A21\u677F</div>';
          return;
        }
        
        container.innerHTML = templates.map(template => {
          const successRate = (template.success_rate * 100).toFixed(1);
          const avgQuality = (template.average_question_quality * 100).toFixed(1);
          
          return \`
            <div class="border border-gray-200 rounded-lg p-4">
              <div class="flex justify-between items-start mb-2">
                <div class="flex-1">
                  <div class="flex items-center space-x-2 mb-2">
                    <span class="text-sm font-medium text-gray-900">\${template.template_type || 'general'}</span>
                    \${template.context_type ? '<span class="text-xs bg-purple-100 text-purple-800 px-2 py-1 rounded">' + template.context_type + '</span>' : ''}
                    \${template.is_active ? '<span class="text-xs bg-green-100 text-green-800 px-2 py-1 rounded">\u555F\u7528</span>' : '<span class="text-xs bg-gray-100 text-gray-800 px-2 py-1 rounded">\u505C\u7528</span>'}
                  </div>
                  <p class="text-sm text-gray-700 mb-2">\${escapeHtml(template.template_text)}</p>
                  <div class="flex space-x-4 text-xs text-gray-500">
                    <span>\u6210\u529F\u7387: \${successRate}%</span>
                    <span>\u5E73\u5747\u54C1\u8CEA: \${avgQuality}%</span>
                    <span>\u4F7F\u7528\u6B21\u6578: \${template.usage_count || 0}</span>
                  </div>
                </div>
              </div>
            </div>
          \`;
        }).join('');
      }

      // \u8F09\u5165\u554F\u984C\u6539\u9032\u8A18\u9304
      async function loadQuestionImprovements() {
        try {
          const response = await fetch(\`/api/ai/admin/question-improvements?page=\${currentImprovementsPage}&pageSize=\${pageSize}\`);
          const data = await response.json();
          
          if (data.success) {
            renderQuestionImprovements(data.improvements || []);
            renderQuestionImprovementsPagination(data.totalPages || 1);
          }
        } catch (error) {
          console.error('Error loading question improvements:', error);
          document.getElementById('question-improvements-list').innerHTML = '<div class="text-center text-red-500 py-8">\u8F09\u5165\u5931\u6557</div>';
        }
      }

      // \u6E32\u67D3\u554F\u984C\u6539\u9032\u8A18\u9304
      function renderQuestionImprovements(improvements) {
        const container = document.getElementById('question-improvements-list');
        
        if (improvements.length === 0) {
          container.innerHTML = '<div class="text-center text-gray-500 py-8">\u6C92\u6709\u6539\u9032\u8A18\u9304</div>';
          return;
        }
        
        container.innerHTML = improvements.map(item => {
          const beforeScore = (item.before_score * 100).toFixed(1);
          const afterScore = (item.after_score * 100).toFixed(1);
          const improvement = ((item.after_score - item.before_score) * 100).toFixed(1);
          
          return \`
            <div class="border border-gray-200 rounded-lg p-4">
              <div class="mb-2">
                <div class="flex items-center space-x-2 mb-2">
                  <span class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded">\${item.improvement_type || 'structure'}</span>
                  \${item.was_effective ? '<span class="text-xs bg-green-100 text-green-800 px-2 py-1 rounded">\u6709\u6548</span>' : ''}
                </div>
                <p class="text-sm text-gray-600 mb-1"><strong>\u539F\u59CB\u554F\u984C\uFF1A</strong>\${escapeHtml(item.original_question_id ? '\u554F\u984CID: ' + item.original_question_id : 'N/A')}</p>
                <p class="text-sm text-gray-700 mb-2"><strong>\u6539\u9032\u5F8C\uFF1A</strong>\${escapeHtml(item.improved_question)}</p>
                <div class="flex space-x-4 text-xs text-gray-500">
                  <span>\u6539\u9032\u524D: \${beforeScore}%</span>
                  <span>\u6539\u9032\u5F8C: \${afterScore}%</span>
                  <span class="text-green-600">\u63D0\u5347: +\${improvement}%</span>
                </div>
                \${item.improvement_reason ? '<p class="text-xs text-gray-500 mt-1">\u539F\u56E0: ' + escapeHtml(item.improvement_reason) + '</p>' : ''}
              </div>
              <span class="text-xs text-gray-500">\${new Date(item.created_at).toLocaleString('zh-TW')}</span>
            </div>
          \`;
        }).join('');
      }

      // \u63D0\u53D6\u554F\u984C\u6A21\u677F
      async function extractTemplates() {
        if (!confirm('\u78BA\u5B9A\u8981\u63D0\u53D6\u554F\u984C\u6A21\u677F\u55CE\uFF1F\u9019\u5C07\u5F9E\u6210\u529F\u7684\u554F\u984C\u4E2D\u5B78\u7FD2\u4E26\u5EFA\u7ACB\u6A21\u677F\u3002')) return;
        
        try {
          const response = await fetch('/api/ai/admin/question-templates/extract', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              minSuccessRate: 0.7,
              minQualityScore: 0.7
            })
          });
          
          const data = await response.json();
          if (data.success) {
            if (window.showToast) {
              window.showToast('\u6210\u529F\u63D0\u53D6 ' + (data.count || 0) + ' \u500B\u554F\u984C\u6A21\u677F\uFF01', 'success');
            } else {
              alert(\`\u6210\u529F\u63D0\u53D6 \${data.count || 0} \u500B\u554F\u984C\u6A21\u677F\uFF01\`);
            }
            if (currentQuestionLearningTab === 'templates') {
              loadQuestionTemplates();
            }
          } else {
            if (window.showToast) {
              window.showToast('\u63D0\u53D6\u5931\u6557\uFF1A' + (data.error || '\u672A\u77E5\u932F\u8AA4'), 'error');
            } else {
              alert('\u63D0\u53D6\u5931\u6557\uFF1A' + (data.error || '\u672A\u77E5\u932F\u8AA4'));
            }
          }
        } catch (error) {
          console.error('Error extracting templates:', error);
          if (window.showToast) {
            window.showToast('\u63D0\u53D6\u5931\u6557', 'error');
          } else {
            alert('\u63D0\u53D6\u5931\u6557');
          }
        }
      }

      // \u554F\u984C\u5B78\u7FD2\u5206\u9801
      function renderQuestionLearningPagination(totalPages) {
        const container = document.getElementById('question-learning-pagination');
        if (totalPages <= 1) {
          container.innerHTML = '';
          return;
        }
        
        let html = '';
        for (let i = 1; i <= totalPages; i++) {
          html += \`<button onclick="currentQuestionLearningPage = \${i}; loadQuestionLearning();" class="px-3 py-1 border rounded \${i === currentQuestionLearningPage ? 'bg-blue-600 text-white' : 'bg-white'}">\${i}</button>\`;
        }
        container.innerHTML = html;
      }

      // \u6539\u9032\u8A18\u9304\u5206\u9801
      function renderQuestionImprovementsPagination(totalPages) {
        const container = document.getElementById('question-improvements-pagination');
        if (totalPages <= 1) {
          container.innerHTML = '';
          return;
        }
        
        let html = '';
        for (let i = 1; i <= totalPages; i++) {
          html += \`<button onclick="currentImprovementsPage = \${i}; loadQuestionImprovements();" class="px-3 py-1 border rounded \${i === currentImprovementsPage ? 'bg-blue-600 text-white' : 'bg-white'}">\${i}</button>\`;
        }
        container.innerHTML = html;
      }

      // \u521D\u59CB\u5316
      document.addEventListener('DOMContentLoaded', function() {
        loadStatistics();
        loadConversations();
      });
    </script>
  `;
  return new Response(pageTemplate2({
    title: "AI \u7BA1\u7406\u5F8C\u53F0 - HOPENGHU",
    content,
    user,
    nonce,
    cssContent
  }), {
    headers: { "Content-Type": "text/html;charset=utf-8" }
  });
}

// src/pages/BusinessVerificationAdmin.js
init_layout();
init_BusinessVerificationService();
init_auth();

// src/templates/businessVerificationAdmin.js
function escapeHtml2(text) {
  if (text == null)
    return "";
  return String(text).replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#39;");
}
function renderPageHeader4() {
  return `
    <div class="mb-8">
      <div class="flex items-center justify-between">
        <div>
          <h1 class="text-3xl font-bold text-gray-900">\u5546\u5BB6\u9A57\u8B49\u5BE9\u6838</h1>
          <p class="mt-2 text-gray-600">\u5BE9\u6838\u548C\u7BA1\u7406\u5546\u5BB6\u9A57\u8B49\u7533\u8ACB</p>
        </div>
        <a href="/admin" class="text-blue-600 hover:text-blue-800 text-sm">
          \u2190 \u8FD4\u56DE\u7BA1\u7406\u54E1\u5100\u8868\u677F
        </a>
      </div>
    </div>
  `;
}
function renderStatisticsCards3(totalPending) {
  return `
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
      <!-- \u5F85\u5BE9\u6838\u5361\u7247 -->
      <div class="bg-white overflow-hidden shadow rounded-lg">
        <div class="p-5">
          <div class="flex items-center">
            <div class="flex-shrink-0">
              <div class="w-8 h-8 bg-yellow-500 rounded-md flex items-center justify-center">
                <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
              </div>
            </div>
            <div class="ml-5 w-0 flex-1">
              <dl>
                <dt class="text-sm font-medium text-gray-500 truncate">\u5F85\u5BE9\u6838</dt>
                <dd class="text-2xl font-semibold text-gray-900">${totalPending}</dd>
              </dl>
            </div>
          </div>
        </div>
      </div>

      <!-- \u5DF2\u6279\u51C6\u5361\u7247 -->
      <div class="bg-white overflow-hidden shadow rounded-lg">
        <div class="p-5">
          <div class="flex items-center">
            <div class="flex-shrink-0">
              <div class="w-8 h-8 bg-green-500 rounded-md flex items-center justify-center">
                <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
              </div>
            </div>
            <div class="ml-5 w-0 flex-1">
              <dl>
                <dt class="text-sm font-medium text-gray-500 truncate">\u5DF2\u6279\u51C6</dt>
                <dd class="text-2xl font-semibold text-gray-900" id="approved-count">-</dd>
              </dl>
            </div>
          </div>
        </div>
      </div>

      <!-- \u5DF2\u62D2\u7D55\u5361\u7247 -->
      <div class="bg-white overflow-hidden shadow rounded-lg">
        <div class="p-5">
          <div class="flex items-center">
            <div class="flex-shrink-0">
              <div class="w-8 h-8 bg-red-500 rounded-md flex items-center justify-center">
                <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
              </div>
            </div>
            <div class="ml-5 w-0 flex-1">
              <dl>
                <dt class="text-sm font-medium text-gray-500 truncate">\u5DF2\u62D2\u7D55</dt>
                <dd class="text-2xl font-semibold text-gray-900" id="rejected-count">-</dd>
              </dl>
            </div>
          </div>
        </div>
      </div>
    </div>
  `;
}
function renderTabNavigation2(totalPending) {
  return `
    <div class="bg-white shadow rounded-lg mb-6">
      <div class="border-b border-gray-200">
        <nav class="flex -mb-px">
          <button onclick="showTab('pending')" id="tab-pending" class="tab-button active px-6 py-3 text-sm font-medium text-blue-600 border-b-2 border-blue-600">
            \u5F85\u5BE9\u6838 (${totalPending})
          </button>
          <button onclick="showTab('all')" id="tab-all" class="tab-button px-6 py-3 text-sm font-medium text-gray-500 hover:text-gray-700">
            \u5168\u90E8\u8A18\u9304
          </button>
        </nav>
      </div>
  `;
}
function renderVerificationCard(verification) {
  const safeValue = (val, def = "") => {
    if (val == null)
      return def;
    return escapeHtml2(String(val));
  };
  const locationName = safeValue(verification.location_name, "\u672A\u77E5\u5730\u9EDE");
  const verificationId = safeValue(verification.id, "");
  const userName = safeValue(verification.user_name || verification.user_email, "\u672A\u77E5\u7528\u6236");
  const address = safeValue(verification.location_address, "\u7121\u5730\u5740\u8CC7\u8A0A");
  const placeId = safeValue(verification.google_place_id, "\u7121");
  const requestedAt = verification.requested_at ? new Date(verification.requested_at).toLocaleString("zh-TW") : "\u672A\u77E5\u6642\u9593";
  return `
    <div class="border border-gray-200 rounded-lg p-6 hover:shadow-md transition-shadow" data-verification-id="${verificationId}">
      <div class="flex items-start gap-3">
        <input type="checkbox" class="verification-checkbox mt-1 h-4 w-4 text-blue-600 rounded focus:ring-blue-500" data-verification-id="${verificationId}" onchange="updateBatchActions()">
        <div class="flex-1">
          <div class="flex items-center gap-3 mb-3">
            <h3 class="text-lg font-semibold text-gray-900">${locationName}</h3>
            <span class="px-2 py-1 text-xs font-medium rounded-full bg-yellow-100 text-yellow-800">
              \u5F85\u5BE9\u6838
            </span>
          </div>
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
            <div>
              <p class="text-sm text-gray-500 mb-1">\u7533\u8ACB\u4EBA</p>
              <p class="text-sm font-medium text-gray-900">${userName}</p>
            </div>
            <div>
              <p class="text-sm text-gray-500 mb-1">\u7533\u8ACB\u6642\u9593</p>
              <p class="text-sm font-medium text-gray-900">${requestedAt}</p>
            </div>
            <div>
              <p class="text-sm text-gray-500 mb-1">\u5730\u9EDE\u5730\u5740</p>
              <p class="text-sm font-medium text-gray-900">${address}</p>
            </div>
            <div>
              <p class="text-sm text-gray-500 mb-1">Google Place ID</p>
              <p class="text-sm font-medium text-gray-900 font-mono">${placeId}</p>
            </div>
          </div>
        </div>
      </div>
      
      <div class="flex items-center gap-3 pt-4 border-t border-gray-200">
        <button 
          onclick="approveVerification('${verificationId}', '${locationName}')"
          class="flex-1 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors font-medium"
        >
          \u2713 \u6279\u51C6
        </button>
        <button 
          onclick="rejectVerification('${verificationId}', '${locationName}')"
          class="flex-1 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors font-medium"
        >
          \u2717 \u62D2\u7D55
        </button>
        <button 
          onclick="viewVerificationDetails('${verificationId}')"
          class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors font-medium"
        >
          \u67E5\u770B\u8A73\u60C5
        </button>
      </div>
    </div>
  `;
}
function renderEmptyState() {
  return `
    <div class="text-center text-gray-500 py-12">
      <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
      </svg>
      <p class="mt-4 text-lg font-medium">\u76EE\u524D\u6C92\u6709\u5F85\u5BE9\u6838\u7684\u7533\u8ACB</p>
      <p class="mt-2 text-sm">\u6240\u6709\u9A57\u8B49\u7533\u8ACB\u90FD\u5DF2\u8655\u7406\u5B8C\u6210</p>
    </div>
  `;
}
function renderBatchActions() {
  return `
    <div id="batch-actions" class="hidden flex items-center gap-2">
      <span id="selected-count" class="text-sm text-gray-600">\u5DF2\u9078\u64C7 0 \u9805</span>
      <button onclick="showBatchApproveModal()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors text-sm font-medium">
        \u6279\u91CF\u6279\u51C6
      </button>
      <button onclick="showBatchRejectModal()" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors text-sm font-medium">
        \u6279\u91CF\u62D2\u7D55
      </button>
    </div>
  `;
}
function renderPendingPanelHeader() {
  return `
    <div class="mb-4 flex items-center justify-between">
      <div>
        <h2 class="text-xl font-semibold text-gray-900">\u5F85\u5BE9\u6838\u7533\u8ACB</h2>
        <p class="text-sm text-gray-600 mt-1">\u8ACB\u4ED4\u7D30\u5BE9\u6838\u6BCF\u500B\u7533\u8ACB\uFF0C\u78BA\u4FDD\u5546\u5BB6\u64C1\u6709\u6B0A\u7684\u771F\u5BE6\u6027</p>
      </div>
      ${renderBatchActions()}
    </div>
  `;
}

// src/pages/BusinessVerificationAdmin.js
async function renderBusinessVerificationAdminPage(request, env, session, user, nonce, cssContent) {
  var _a;
  const authCheck = requireAdmin(user, request);
  if (authCheck)
    return authCheck;
  try {
    const dbHealth = await ServiceHealthChecker.checkDatabase(env.DB);
    if (!dbHealth.healthy) {
      console.error("[BusinessVerificationAdmin] Database not available:", dbHealth.error);
      return ErrorResponseBuilder.buildDatabaseErrorPage({
        user,
        nonce,
        cssContent
      });
    }
    const verificationService = ((_a = env.services) == null ? void 0 : _a.businessVerification) || new BusinessVerificationService(env.DB);
    let pendingVerifications = [];
    let totalPending = 0;
    try {
      const result = await verificationService.getPendingVerifications(50, 0);
      pendingVerifications = result.verifications || [];
      totalPending = result.total || 0;
    } catch (error) {
      console.error("[BusinessVerificationAdmin] Error loading pending verifications:", error);
      if (error.message && error.message.includes("no such table")) {
        console.warn("[BusinessVerificationAdmin] business_verifications table does not exist. Please run migration 0032.");
        pendingVerifications = [];
        totalPending = 0;
      } else {
        throw error;
      }
    }
    const content = `
    <div class="min-h-screen bg-gray-50 py-8">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        ${renderPageHeader4()}
        ${renderStatisticsCards3(totalPending)}
        ${renderTabNavigation2(totalPending)}

          <!-- \u5F85\u5BE9\u6838\u9762\u677F -->
          <div id="panel-pending" class="tab-panel p-6">
            ${renderPendingPanelHeader()}
            
            <div id="pending-verifications-list" class="space-y-4">
              ${Array.isArray(pendingVerifications) && pendingVerifications.length === 0 ? renderEmptyState() : Array.isArray(pendingVerifications) ? pendingVerifications.map((v) => renderVerificationCard(v)).join("") : ""}
            </div>
          </div>

          <!-- \u5168\u90E8\u8A18\u9304\u9762\u677F -->
          <div id="panel-all" class="tab-panel hidden p-6">
            <div class="mb-4">
              <h2 class="text-xl font-semibold text-gray-900">\u5168\u90E8\u9A57\u8B49\u8A18\u9304</h2>
              <p class="text-sm text-gray-600 mt-1">\u67E5\u770B\u6240\u6709\u9A57\u8B49\u7533\u8ACB\u7684\u6B77\u53F2\u8A18\u9304</p>
            </div>
            
            <div class="mb-4 flex space-x-2">
              <select id="filter-status" class="border border-gray-300 rounded px-3 py-2 text-sm" onchange="loadAllVerifications()">
                <option value="">\u6240\u6709\u72C0\u614B</option>
                <option value="pending">\u5F85\u5BE9\u6838</option>
                <option value="approved">\u5DF2\u6279\u51C6</option>
                <option value="rejected">\u5DF2\u62D2\u7D55</option>
                <option value="cancelled">\u5DF2\u53D6\u6D88</option>
              </select>
              <input 
                type="text" 
                id="search-all-verifications" 
                placeholder="\u641C\u5C0B\u5546\u5BB6\u540D\u7A31\u3001\u7533\u8ACB\u4EBA Email \u6216\u5730\u5740..." 
                class="border border-gray-300 rounded px-3 py-2 text-sm flex-1" 
                onkeyup="handleSearchInput(event)"
                onchange="loadAllVerifications()"
              >
              <button 
                onclick="clearSearch()" 
                id="clear-search-btn"
                class="px-4 py-2 bg-gray-200 text-gray-700 rounded hover:bg-gray-300 text-sm hidden"
              >
                \u6E05\u9664
              </button>
            </div>
            
            <div id="all-verifications-list" class="space-y-4">
              <div class="text-center text-gray-500 py-8">\u8F09\u5165\u4E2D...</div>
            </div>
            
            <!-- \u5206\u9801\u63A7\u5236 -->
            <div id="verifications-pagination" class="mt-6 flex justify-center space-x-2 hidden">
                 <button onclick="changePage(-1)" id="prev-page-btn" class="px-3 py-1 border border-gray-300 rounded hover:bg-gray-50 disabled:opacity-50">\u4E0A\u4E00\u9801</button>
                 <span id="page-info" class="px-3 py-1 text-gray-600">\u7B2C 1 \u9801</span>
                 <button onclick="changePage(1)" id="next-page-btn" class="px-3 py-1 border border-gray-300 rounded hover:bg-gray-50 disabled:opacity-50">\u4E0B\u4E00\u9801</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- \u6279\u51C6\u6A21\u614B\u6846 -->
    <div id="approve-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
      <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
        <h3 class="text-xl font-semibold mb-4">\u6279\u51C6\u9A57\u8B49\u7533\u8ACB</h3>
        <p class="text-gray-600 mb-4">\u78BA\u5B9A\u8981\u6279\u51C6 <span id="approve-location-name" class="font-semibold"></span> \u7684\u9A57\u8B49\u7533\u8ACB\u55CE\uFF1F</p>
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-1">\u5099\u8A3B\uFF08\u53EF\u9078\uFF09</label>
          <textarea id="approve-notes" rows="3" class="w-full border border-gray-300 rounded px-3 py-2 text-sm" placeholder="\u6DFB\u52A0\u6279\u51C6\u5099\u8A3B..."></textarea>
        </div>
        <div class="flex justify-end space-x-2">
          <button onclick="closeApproveModal()" class="px-4 py-2 border border-gray-300 rounded hover:bg-gray-50">
            \u53D6\u6D88
          </button>
          <button onclick="confirmApprove()" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">
            \u78BA\u8A8D\u6279\u51C6
          </button>
        </div>
      </div>
    </div>

    <!-- \u62D2\u7D55\u6A21\u614B\u6846 -->
    <div id="reject-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
      <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
        <h3 class="text-xl font-semibold mb-4">\u62D2\u7D55\u9A57\u8B49\u7533\u8ACB</h3>
        <p class="text-gray-600 mb-4">\u78BA\u5B9A\u8981\u62D2\u7D55 <span id="reject-location-name" class="font-semibold"></span> \u7684\u9A57\u8B49\u7533\u8ACB\u55CE\uFF1F</p>
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-1">\u62D2\u7D55\u539F\u56E0 <span class="text-red-500">*</span></label>
          <textarea id="reject-reason" rows="3" required class="w-full border border-gray-300 rounded px-3 py-2 text-sm" placeholder="\u8ACB\u8AAA\u660E\u62D2\u7D55\u539F\u56E0..."></textarea>
        </div>
        <div class="flex justify-end space-x-2">
          <button onclick="closeRejectModal()" class="px-4 py-2 border border-gray-300 rounded hover:bg-gray-50">
            \u53D6\u6D88
          </button>
          <button onclick="confirmReject()" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">
            \u78BA\u8A8D\u62D2\u7D55
          </button>
        </div>
      </div>
    </div>

    <!-- \u6279\u91CF\u6279\u51C6\u6A21\u614B\u6846 -->
    <div id="batch-approve-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
      <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
        <h3 class="text-xl font-semibold mb-4">\u6279\u91CF\u6279\u51C6\u9A57\u8B49\u7533\u8ACB</h3>
        <p class="text-gray-600 mb-4">\u78BA\u5B9A\u8981\u6279\u51C6 <span id="batch-approve-count" class="font-semibold">0</span> \u500B\u9A57\u8B49\u7533\u8ACB\u55CE\uFF1F</p>
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-1">\u5099\u8A3B\uFF08\u53EF\u9078\uFF09</label>
          <textarea id="batch-approve-notes" rows="3" class="w-full border border-gray-300 rounded px-3 py-2 text-sm" placeholder="\u6DFB\u52A0\u6279\u51C6\u5099\u8A3B..."></textarea>
        </div>
        <div class="flex justify-end space-x-2">
          <button onclick="closeBatchApproveModal()" class="px-4 py-2 border border-gray-300 rounded hover:bg-gray-50">
            \u53D6\u6D88
          </button>
          <button onclick="confirmBatchApprove()" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">
            \u78BA\u8A8D\u6279\u51C6
          </button>
        </div>
      </div>
    </div>

    <!-- \u6279\u91CF\u62D2\u7D55\u6A21\u614B\u6846 -->
    <div id="batch-reject-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
      <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
        <h3 class="text-xl font-semibold mb-4">\u6279\u91CF\u62D2\u7D55\u9A57\u8B49\u7533\u8ACB</h3>
        <p class="text-gray-600 mb-4">\u78BA\u5B9A\u8981\u62D2\u7D55 <span id="batch-reject-count" class="font-semibold">0</span> \u500B\u9A57\u8B49\u7533\u8ACB\u55CE\uFF1F</p>
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-1">\u62D2\u7D55\u539F\u56E0 <span class="text-red-500">*</span></label>
          <textarea id="batch-reject-reason" rows="3" required class="w-full border border-gray-300 rounded px-3 py-2 text-sm" placeholder="\u8ACB\u8AAA\u660E\u62D2\u7D55\u539F\u56E0..."></textarea>
        </div>
        <div class="flex justify-end space-x-2">
          <button onclick="closeBatchRejectModal()" class="px-4 py-2 border border-gray-300 rounded hover:bg-gray-50">
            \u53D6\u6D88
          </button>
          <button onclick="confirmBatchReject()" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">
            \u78BA\u8A8D\u62D2\u7D55
          </button>
        </div>
      </div>
    </div>

    <!-- \u8A73\u60C5\u6A21\u614B\u6846 -->
    <div id="details-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
      <div class="bg-white rounded-lg p-6 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-xl font-semibold">\u9A57\u8B49\u7533\u8ACB\u8A73\u60C5</h3>
          <button onclick="closeDetailsModal()" class="text-gray-400 hover:text-gray-600">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
          </button>
        </div>
        <div id="verification-details-content" class="space-y-4">
          <div class="text-center text-gray-500 py-8">\u8F09\u5165\u4E2D...</div>
        </div>
      </div>
    </div>

    <script nonce="${nonce}">
      let currentTab = 'pending';
      let currentVerificationId = null;
      let currentPage = 1;
      let totalPages = 1;
      const pageSize = 20;

      // \u6A19\u7C64\u9801\u5207\u63DB
      function showTab(tabName) {
        currentTab = tabName;
        
        // \u66F4\u65B0\u6309\u9215\u72C0\u614B
        document.querySelectorAll('.tab-button').forEach(btn => {
          btn.classList.remove('active', 'text-blue-600', 'border-blue-600');
          btn.classList.add('text-gray-500');
        });
        document.getElementById('tab-' + tabName).classList.add('active', 'text-blue-600', 'border-blue-600');
        document.getElementById('tab-' + tabName).classList.remove('text-gray-500');
        
        // \u66F4\u65B0\u9762\u677F\u986F\u793A
        document.querySelectorAll('.tab-panel').forEach(panel => {
          panel.classList.add('hidden');
        });
        document.getElementById('panel-' + tabName).classList.remove('hidden');
        
        // \u8F09\u5165\u5C0D\u61C9\u8CC7\u6599
        if (tabName === 'all') {
          loadAllVerifications();
        }
      }

      // \u6279\u51C6\u9A57\u8B49
      function approveVerification(verificationId, locationName) {
        currentVerificationId = verificationId;
        document.getElementById('approve-location-name').textContent = locationName;
        document.getElementById('approve-notes').value = '';
        document.getElementById('approve-modal').classList.remove('hidden');
      }

      function closeApproveModal() {
        document.getElementById('approve-modal').classList.add('hidden');
        currentVerificationId = null;
      }

      async function confirmApprove() {
        if (!currentVerificationId) return;

        const notes = document.getElementById('approve-notes').value.trim();
        
        try {
          const response = await fetch('/api/business/verify/approve', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({
              verification_id: currentVerificationId,
              notes: notes || null
            })
          });

          const data = await response.json();

          if (data.success) {
            if (window.showToast) {
              window.showToast('\u9A57\u8B49\u5DF2\u6279\u51C6', 'success');
            }
            closeApproveModal();
            // \u91CD\u65B0\u8F09\u5165\u9801\u9762
            setTimeout(() => location.reload(), 1000);
          } else {
            if (window.showToast) {
              window.showToast('\u6279\u51C6\u5931\u6557\uFF1A' + (data.error || data.message || '\u672A\u77E5\u932F\u8AA4'), 'error');
            } else {
              alert('\u6279\u51C6\u5931\u6557\uFF1A' + (data.error || data.message || '\u672A\u77E5\u932F\u8AA4'));
            }
          }
        } catch (error) {
          console.error('\u6279\u51C6\u9A57\u8B49\u5931\u6557:', error);
          if (window.showToast) {
            window.showToast('\u6279\u51C6\u5931\u6557\uFF0C\u8ACB\u7A0D\u5F8C\u518D\u8A66', 'error');
          } else {
            alert('\u6279\u51C6\u5931\u6557\uFF0C\u8ACB\u7A0D\u5F8C\u518D\u8A66');
          }
        }
      }

      // \u62D2\u7D55\u9A57\u8B49
      function rejectVerification(verificationId, locationName) {
        currentVerificationId = verificationId;
        document.getElementById('reject-location-name').textContent = locationName;
        document.getElementById('reject-reason').value = '';
        document.getElementById('reject-modal').classList.remove('hidden');
      }

      function closeRejectModal() {
        document.getElementById('reject-modal').classList.add('hidden');
        currentVerificationId = null;
      }

      async function confirmReject() {
        if (!currentVerificationId) return;

        const reason = document.getElementById('reject-reason').value.trim();
        if (!reason) {
          if (window.showToast) {
            window.showToast('\u8ACB\u586B\u5BEB\u62D2\u7D55\u539F\u56E0', 'warning');
          } else {
            alert('\u8ACB\u586B\u5BEB\u62D2\u7D55\u539F\u56E0');
          }
          return;
        }

        try {
          const response = await fetch('/api/business/verify/reject', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({
              verification_id: currentVerificationId,
              rejection_reason: reason
            })
          });

          const data = await response.json();

          if (data.success) {
            if (window.showToast) {
              window.showToast('\u9A57\u8B49\u5DF2\u62D2\u7D55', 'success');
            }
            closeRejectModal();
            // \u91CD\u65B0\u8F09\u5165\u9801\u9762
            setTimeout(() => location.reload(), 1000);
          } else {
            if (window.showToast) {
              window.showToast('\u62D2\u7D55\u5931\u6557\uFF1A' + (data.error || data.message || '\u672A\u77E5\u932F\u8AA4'), 'error');
            } else {
              alert('\u62D2\u7D55\u5931\u6557\uFF1A' + (data.error || data.message || '\u672A\u77E5\u932F\u8AA4'));
            }
          }
        } catch (error) {
          console.error('\u62D2\u7D55\u9A57\u8B49\u5931\u6557:', error);
          if (window.showToast) {
            window.showToast('\u62D2\u7D55\u5931\u6557\uFF0C\u8ACB\u7A0D\u5F8C\u518D\u8A66', 'error');
          } else {
            alert('\u62D2\u7D55\u5931\u6557\uFF0C\u8ACB\u7A0D\u5F8C\u518D\u8A66');
          }
        }
      }

      // \u67E5\u770B\u8A73\u60C5
      async function viewVerificationDetails(verificationId) {
        const contentEl = document.getElementById('verification-details-content');
        contentEl.innerHTML = '<div class="text-center text-gray-500 py-8">\u8F09\u5165\u4E2D...</div>';
        document.getElementById('details-modal').classList.remove('hidden');

        try {
          const response = await fetch('/api/business/verify/' + verificationId + '/details', {
            credentials: 'include'
          });

          const data = await response.json();

          if (data.success && data.verification) {
            const v = data.verification;
            
            // \u4F7F\u7528 DOM \u64CD\u4F5C\u800C\u975E innerHTML \u6A21\u677F\u5B57\u7B26\u4E32\uFF0C\u907F\u514D CSP \u554F\u984C
            contentEl.innerHTML = '';
            const container = document.createElement('div');
            container.className = 'space-y-4';
            
            // \u5730\u9EDE\u540D\u7A31
            const nameDiv = document.createElement('div');
            nameDiv.innerHTML = '<h4 class="text-sm font-medium text-gray-500 mb-1">\u5730\u9EDE\u540D\u7A31</h4><p class="text-base font-semibold text-gray-900">' + escapeHtml(v.location_name || '\u672A\u77E5\u5730\u9EDE') + '</p>';
            container.appendChild(nameDiv);
            
            // \u5730\u9EDE\u5730\u5740\uFF08\u5982\u679C\u6709\u5EA7\u6A19\uFF0C\u6DFB\u52A0\u5730\u5716\u9023\u7D50\uFF09
            const addressDiv = document.createElement('div');
            let addressContent = escapeHtml(v.location_address || '\u7121\u5730\u5740\u8CC7\u8A0A');
            if (v.location_latitude && v.location_longitude) {
              const mapsUrl = 'https://www.google.com/maps?q=' + encodeURIComponent(v.location_latitude + ',' + v.location_longitude);
              addressContent += ' <a href="' + mapsUrl + '" target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:text-blue-800 text-sm ml-2">\u{1F4CD} \u5728\u5730\u5716\u67E5\u770B</a>';
            }
            addressDiv.innerHTML = '<h4 class="text-sm font-medium text-gray-500 mb-1">\u5730\u9EDE\u5730\u5740</h4><p class="text-base text-gray-900">' + addressContent + '</p>';
            container.appendChild(addressDiv);
            
            // \u5730\u9EDE\u96FB\u8A71\uFF08\u5982\u679C\u6709\uFF09
            if (v.location_phone) {
              const phoneDiv = document.createElement('div');
              phoneDiv.innerHTML = '<h4 class="text-sm font-medium text-gray-500 mb-1">\u96FB\u8A71</h4><p class="text-base text-gray-900"><a href="tel:' + escapeHtml(v.location_phone) + '" class="text-blue-600 hover:text-blue-800">' + escapeHtml(v.location_phone) + '</a></p>';
              container.appendChild(phoneDiv);
            }
            
            // \u5730\u9EDE\u7DB2\u7AD9\uFF08\u5982\u679C\u6709\uFF09
            if (v.location_website) {
              const websiteDiv = document.createElement('div');
              websiteDiv.innerHTML = '<h4 class="text-sm font-medium text-gray-500 mb-1">\u7DB2\u7AD9</h4><p class="text-base text-gray-900"><a href="' + escapeHtml(v.location_website) + '" target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:text-blue-800 break-all">' + escapeHtml(v.location_website) + '</a></p>';
              container.appendChild(websiteDiv);
            }
            
            // \u7533\u8ACB\u4EBA
            const userDiv = document.createElement('div');
            userDiv.innerHTML = '<h4 class="text-sm font-medium text-gray-500 mb-1">\u7533\u8ACB\u4EBA</h4><p class="text-base text-gray-900">' + escapeHtml(v.user_name || v.user_email || '\u672A\u77E5\u7528\u6236') + '</p>';
            container.appendChild(userDiv);
            
            // \u7533\u8ACB\u6642\u9593
            const timeDiv = document.createElement('div');
            timeDiv.innerHTML = '<h4 class="text-sm font-medium text-gray-500 mb-1">\u7533\u8ACB\u6642\u9593</h4><p class="text-base text-gray-900">' + escapeHtml(new Date(v.requested_at).toLocaleString('zh-TW')) + '</p>';
            container.appendChild(timeDiv);
            
            // \u72C0\u614B
            const statusDiv = document.createElement('div');
            const statusClass = v.status === 'approved' ? 'bg-green-100 text-green-800' :
                              v.status === 'rejected' ? 'bg-red-100 text-red-800' :
                              v.status === 'cancelled' ? 'bg-gray-100 text-gray-800' :
                              'bg-yellow-100 text-yellow-800';
            const statusText = v.status === 'approved' ? '\u5DF2\u6279\u51C6' :
                              v.status === 'rejected' ? '\u5DF2\u62D2\u7D55' :
                              v.status === 'cancelled' ? '\u5DF2\u53D6\u6D88' :
                              '\u5F85\u5BE9\u6838';
            statusDiv.innerHTML = '<h4 class="text-sm font-medium text-gray-500 mb-1">\u72C0\u614B</h4><span class="px-2 py-1 text-xs font-medium rounded-full ' + statusClass + '">' + escapeHtml(statusText) + '</span>';
            container.appendChild(statusDiv);
            
            // Google Place ID \u548C Maps \u9023\u7D50
            const placeId = v.google_place_id || v.location_google_place_id;
            if (placeId) {
              const placeIdDiv = document.createElement('div');
              const googleMapsUrl = 'https://www.google.com/maps/place/?q=place_id:' + encodeURIComponent(placeId);
              placeIdDiv.innerHTML = 
                '<h4 class="text-sm font-medium text-gray-500 mb-1">Google Place ID</h4>' +
                '<div class="flex items-center gap-2 flex-wrap">' +
                  '<p class="text-base text-gray-900 font-mono text-sm flex-1 min-w-0 break-all">' + escapeHtml(placeId) + '</p>' +
                  '<a href="' + googleMapsUrl + '" target="_blank" rel="noopener noreferrer" class="px-3 py-1 bg-blue-600 text-white text-xs rounded hover:bg-blue-700 transition-colors whitespace-nowrap">\u5728 Google Maps \u67E5\u770B</a>' +
                '</div>';
              container.appendChild(placeIdDiv);
            }
            
            // \u64CD\u4F5C\u6309\u9215\u5340\u57DF
            const actionsDiv = document.createElement('div');
            actionsDiv.className = 'mt-6 pt-6 border-t border-gray-200 flex flex-wrap gap-3';
            
            // \u5730\u9EDE\u8A73\u60C5\u6309\u9215\uFF08\u5982\u679C\u6709 location_id\uFF09
            if (v.location_id) {
              const locationDetailBtn = document.createElement('a');
              locationDetailBtn.href = '/location/' + escapeHtml(v.location_id);
              locationDetailBtn.target = '_blank';
              locationDetailBtn.className = 'inline-flex items-center px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors text-sm font-medium';
              locationDetailBtn.innerHTML = 
                '<svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">' +
                  '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>' +
                '</svg>' +
                '\u67E5\u770B\u5730\u9EDE\u8A73\u60C5';
              actionsDiv.appendChild(locationDetailBtn);
            }
            
            // \u5982\u679C\u6709\u4EFB\u4F55\u64CD\u4F5C\u6309\u9215\uFF0C\u6DFB\u52A0\u5230\u5BB9\u5668
            if (actionsDiv.children.length > 0) {
              container.appendChild(actionsDiv);
            }
            
            // \u5BE9\u6838\u6642\u9593
            if (v.verified_at) {
              const verifiedAtDiv = document.createElement('div');
              verifiedAtDiv.innerHTML = '<h4 class="text-sm font-medium text-gray-500 mb-1">\u5BE9\u6838\u6642\u9593</h4><p class="text-base text-gray-900">' + escapeHtml(new Date(v.verified_at).toLocaleString('zh-TW')) + '</p>';
              container.appendChild(verifiedAtDiv);
            }
            
            // \u5BE9\u6838\u4EBA
            if (v.verified_by_name || v.verified_by_email) {
              const verifiedByDiv = document.createElement('div');
              verifiedByDiv.innerHTML = '<h4 class="text-sm font-medium text-gray-500 mb-1">\u5BE9\u6838\u4EBA</h4><p class="text-base text-gray-900">' + escapeHtml(v.verified_by_name || v.verified_by_email) + '</p>';
              container.appendChild(verifiedByDiv);
            }
            
            // \u5099\u8A3B
            if (v.notes) {
              const notesDiv = document.createElement('div');
              notesDiv.innerHTML = '<h4 class="text-sm font-medium text-gray-500 mb-1">\u5099\u8A3B</h4><p class="text-base text-gray-900">' + escapeHtml(v.notes) + '</p>';
              container.appendChild(notesDiv);
            }
            
            // \u62D2\u7D55\u539F\u56E0
            if (v.rejection_reason) {
              const reasonDiv = document.createElement('div');
              reasonDiv.innerHTML = '<h4 class="text-sm font-medium text-gray-500 mb-1">\u62D2\u7D55\u539F\u56E0</h4><p class="text-base text-red-600">' + escapeHtml(v.rejection_reason) + '</p>';
              container.appendChild(reasonDiv);
            }
            
            contentEl.appendChild(container);
          } else {
            contentEl.innerHTML = '<div class="text-center text-red-500 py-8">\u8F09\u5165\u5931\u6557</div>';
          }
        } catch (error) {
          console.error('\u8F09\u5165\u8A73\u60C5\u5931\u6557:', error);
          contentEl.innerHTML = '<div class="text-center text-red-500 py-8">\u8F09\u5165\u5931\u6557\uFF1A' + escapeHtml(error.message) + '</div>';
        }
      }
      
      // HTML \u8F49\u7FA9\u51FD\u6578
      function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }

      function closeDetailsModal() {
        document.getElementById('details-modal').classList.add('hidden');
      }

      // \u9AD8\u4EAE\u641C\u5C0B\u95DC\u9375\u5B57
      function highlightSearchTerm(text, searchTerm) {
        if (!searchTerm || !text) return escapeHtml(text);
        const escapedText = escapeHtml(text);
        // \u8F49\u7FA9\u6B63\u5247\u8868\u9054\u5F0F\u7279\u6B8A\u5B57\u7B26
        let escapedSearch = escapeHtml(searchTerm);
        const specialChars = ['.', '*', '+', '?', '^', '$', '{', '}', '(', ')', '|', '[', ']', '\\'];
        for (let i = 0; i < specialChars.length; i++) {
          const char = specialChars[i];
          escapedSearch = escapedSearch.split(char).join('\\' + char);
        }
        try {
          const regex = new RegExp('(' + escapedSearch + ')', 'gi');
          return escapedText.replace(regex, '<mark class="bg-yellow-200">$1</mark>');
        } catch (e) {
          // \u5982\u679C\u6B63\u5247\u8868\u9054\u5F0F\u69CB\u5EFA\u5931\u6557\uFF0C\u8FD4\u56DE\u539F\u59CB\u6587\u672C
          return escapedText;
        }
      }

      // \u8655\u7406\u641C\u5C0B\u8F38\u5165\uFF08\u9632\u6296\uFF09
      let searchTimeout = null;
      function handleSearchInput(event) {
        clearTimeout(searchTimeout);
        const searchInput = event.target;
        const clearBtn = document.getElementById('clear-search-btn');
        
        // \u986F\u793A/\u96B1\u85CF\u6E05\u9664\u6309\u9215
        if (searchInput.value.trim()) {
          clearBtn.classList.remove('hidden');
        } else {
          clearBtn.classList.add('hidden');
        }
        
        // \u9632\u6296\uFF1A500ms \u5F8C\u57F7\u884C\u641C\u5C0B
        searchTimeout = setTimeout(() => {
          currentPage = 1; // \u641C\u5C0B\u6642\u91CD\u7F6E\u5230\u7B2C\u4E00\u9801
          loadAllVerifications(1);
        }, 500);
      }

      // \u6E05\u9664\u641C\u5C0B
      function clearSearch() {
        document.getElementById('search-all-verifications').value = '';
        document.getElementById('clear-search-btn').classList.add('hidden');
        currentPage = 1;
        loadAllVerifications(1);
      }

      // \u8F09\u5165\u5168\u90E8\u9A57\u8B49\u8A18\u9304
      async function loadAllVerifications(page = 1) {
        const status = document.getElementById('filter-status')?.value || '';
        const search = document.getElementById('search-all-verifications')?.value?.trim() || '';
        const container = document.getElementById('all-verifications-list');
        const pagination = document.getElementById('verifications-pagination');
        
        // \u53EA\u6709\u7576\u4E0D\u662F\u7FFB\u9801\u64CD\u4F5C\u6642\u624D\u91CD\u7F6E\u52A0\u8F09\u6307\u793A\u5668\uFF0C\u512A\u5316\u9AD4\u9A57
        if (page === 1 || container.innerHTML.includes('\u8F09\u5165\u4E2D')) {
           container.innerHTML = '<div class="text-center text-gray-500 py-8">\u8F09\u5165\u4E2D...</div>';
        }

        try {
          // \u8A08\u7B97\u504F\u79FB\u91CF
          const offset = (page - 1) * pageSize;
          
          let url = '/api/business/verify/all?limit=' + pageSize + '&offset=' + offset;
          if (status) {
            url += '&status=' + encodeURIComponent(status);
          }
          if (search) {
            url += '&search=' + encodeURIComponent(search);
          }

          const response = await fetch(url, { credentials: 'include' });
          const data = await response.json();

          if (data.success) {
            const verifications = data.verifications;
            const total = data.total;
            
            // \u66F4\u65B0\u5206\u9801\u72C0\u614B
            currentPage = page;
            totalPages = Math.ceil(total / pageSize);
            
            updatePaginationUI(total);
            
            if (verifications.length === 0) {
              const noResultsMsg = search 
                ? '<div class="text-center text-gray-500 py-8"><p class="text-lg font-medium">\u6C92\u6709\u627E\u5230\u76F8\u95DC\u8A18\u9304</p><p class="text-sm mt-2">\u8ACB\u5617\u8A66\u8ABF\u6574\u641C\u5C0B\u689D\u4EF6\u6216\u7BE9\u9078\u5668</p></div>'
                : '<div class="text-center text-gray-500 py-8">\u6C92\u6709\u627E\u5230\u76F8\u95DC\u8A18\u9304</div>';
              container.innerHTML = noResultsMsg;
              return;
            }

            // \u7372\u53D6\u641C\u5C0B\u95DC\u9375\u5B57\u7528\u65BC\u9AD8\u4EAE
            const searchTerm = search || '';

            container.innerHTML = verifications.map(v => {
              const statusClass = v.status === 'approved' ? 'bg-green-100 text-green-800' :
                                v.status === 'rejected' ? 'bg-red-100 text-red-800' :
                                v.status === 'cancelled' ? 'bg-gray-100 text-gray-800' :
                                'bg-yellow-100 text-yellow-800';
              const statusText = v.status === 'approved' ? '\u5DF2\u6279\u51C6' :
                                v.status === 'rejected' ? '\u5DF2\u62D2\u7D55' :
                                v.status === 'cancelled' ? '\u5DF2\u53D6\u6D88' :
                                '\u5F85\u5BE9\u6838';
              
              return '<div class="border border-gray-200 rounded-lg p-4 hover:shadow-sm transition-shadow">' +
                '<div class="flex items-start justify-between">' +
                  '<div class="flex-1">' +
                    '<div class="flex items-center gap-3 mb-2">' +
                      '<h3 class="text-base font-semibold text-gray-900">' + highlightSearchTerm(v.location_name || '\u672A\u77E5\u5730\u9EDE', searchTerm) + '</h3>' +
                      '<span class="px-2 py-0.5 text-xs font-medium rounded-full ' + statusClass + '">' +
                        statusText +
                      '</span>' +
                    '</div>' +
                    '<div class="grid grid-cols-1 sm:grid-cols-3 gap-x-4 gap-y-2 text-sm">' +
                      '<div><span class="text-gray-500">\u7533\u8ACB\u4EBA\uFF1A</span> <span class="text-gray-900">' + highlightSearchTerm(v.user_name || v.user_email || '\u672A\u77E5', searchTerm) + '</span></div>' +
                      '<div><span class="text-gray-500">\u6642\u9593\uFF1A</span> <span class="text-gray-900">' + new Date(v.requested_at).toLocaleString('zh-TW') + '</span></div>' +
                      '<div><span class="text-gray-500">\u5BE9\u6838\u4EBA\uFF1A</span> <span class="text-gray-900">' + escapeHtml(v.verified_by_name || v.verified_by_email || '-') + '</span></div>' +
                    '</div>' +
                    (v.location_address ? '<div class="mt-2 text-sm text-gray-600"><span class="text-gray-500">\u5730\u5740\uFF1A</span> <span>' + highlightSearchTerm(v.location_address, searchTerm) + '</span></div>' : '') +
                  '</div>' +
                  '<button onclick="viewVerificationDetails(\\'' + v.id + '\\')" class="ml-4 text-blue-600 hover:text-blue-800 text-sm font-medium">\u8A73\u60C5</button>' +
                '</div>' +
              '</div>';
            }).join('');
            
          } else {
            container.innerHTML = '<div class="text-center text-red-500 py-8">\u8F09\u5165\u5931\u6557\uFF1A' + (data.error || '\u672A\u77E5\u932F\u8AA4') + '</div>';
          }
        } catch (error) {
          console.error('\u8F09\u5165\u9A57\u8B49\u8A18\u9304\u5931\u6557:', error);
          container.innerHTML = '<div class="text-center text-red-500 py-8">\u8F09\u5165\u5931\u6557\u8ACB\u7A0D\u5F8C\u518D\u8A66</div>';
        }
      }
      
      // \u66F4\u65B0\u5206\u9801 UI
      function updatePaginationUI(total) {
        const pagination = document.getElementById('verifications-pagination');
        if (total <= pageSize) {
            pagination.classList.add('hidden');
        } else {
            pagination.classList.remove('hidden');
            document.getElementById('page-info').textContent = '\u7B2C ' + currentPage + ' / ' + totalPages + ' \u9801';
            document.getElementById('prev-page-btn').disabled = currentPage <= 1;
            document.getElementById('next-page-btn').disabled = currentPage >= totalPages;
        }
      }
      
      // \u63DB\u9801
      function changePage(delta) {
        const newPage = currentPage + delta;
        if (newPage >= 1 && newPage <= totalPages) {
            loadAllVerifications(newPage);
        }
      }

      // \u6279\u91CF\u64CD\u4F5C\u76F8\u95DC\u51FD\u6578
      function updateBatchActions() {
        const checkboxes = document.querySelectorAll('.verification-checkbox:checked');
        const count = checkboxes.length;
        const batchActions = document.getElementById('batch-actions');
        const selectedCount = document.getElementById('selected-count');
        
        if (count > 0) {
          batchActions.classList.remove('hidden');
          selectedCount.textContent = '\u5DF2\u9078\u64C7 ' + count + ' \u9805';
        } else {
          batchActions.classList.add('hidden');
        }
      }

      function getSelectedVerificationIds() {
        const checkboxes = document.querySelectorAll('.verification-checkbox:checked');
        return Array.from(checkboxes).map(cb => cb.dataset.verificationId);
      }

      function showBatchApproveModal() {
        const ids = getSelectedVerificationIds();
        if (ids.length === 0) {
          if (window.showToast) {
            window.showToast('\u8ACB\u9078\u64C7\u81F3\u5C11\u4E00\u500B\u9A57\u8B49\u7533\u8ACB', 'warning');
          }
          return;
        }
        document.getElementById('batch-approve-count').textContent = ids.length;
        document.getElementById('batch-approve-notes').value = '';
        document.getElementById('batch-approve-modal').classList.remove('hidden');
      }

      function closeBatchApproveModal() {
        document.getElementById('batch-approve-modal').classList.add('hidden');
      }

      async function confirmBatchApprove() {
        const ids = getSelectedVerificationIds();
        if (ids.length === 0) return;

        const notes = document.getElementById('batch-approve-notes').value.trim();
        
        try {
          const response = await fetch('/api/business/verify/batch-approve', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({
              verification_ids: ids,
              notes: notes || null
            })
          });

          const data = await response.json();

          if (data.success) {
            if (window.showToast) {
              window.showToast(data.message || '\u6279\u91CF\u6279\u51C6\u6210\u529F', 'success');
            }
            closeBatchApproveModal();
            // \u6E05\u9664\u6240\u6709\u9078\u4E2D\u72C0\u614B
            document.querySelectorAll('.verification-checkbox').forEach(cb => cb.checked = false);
            updateBatchActions();
            // \u91CD\u65B0\u8F09\u5165\u9801\u9762
            setTimeout(() => location.reload(), 1000);
          } else {
            if (window.showToast) {
              window.showToast('\u6279\u91CF\u6279\u51C6\u5931\u6557\uFF1A' + (data.error || data.message || '\u672A\u77E5\u932F\u8AA4'), 'error');
            }
          }
        } catch (error) {
          console.error('\u6279\u91CF\u6279\u51C6\u5931\u6557:', error);
          if (window.showToast) {
            window.showToast('\u6279\u91CF\u6279\u51C6\u5931\u6557\uFF0C\u8ACB\u7A0D\u5F8C\u518D\u8A66', 'error');
          }
        }
      }

      function showBatchRejectModal() {
        const ids = getSelectedVerificationIds();
        if (ids.length === 0) {
          if (window.showToast) {
            window.showToast('\u8ACB\u9078\u64C7\u81F3\u5C11\u4E00\u500B\u9A57\u8B49\u7533\u8ACB', 'warning');
          }
          return;
        }
        document.getElementById('batch-reject-count').textContent = ids.length;
        document.getElementById('batch-reject-reason').value = '';
        document.getElementById('batch-reject-modal').classList.remove('hidden');
      }

      function closeBatchRejectModal() {
        document.getElementById('batch-reject-modal').classList.add('hidden');
      }

      async function confirmBatchReject() {
        const ids = getSelectedVerificationIds();
        if (ids.length === 0) return;

        const reason = document.getElementById('batch-reject-reason').value.trim();
        if (!reason) {
          if (window.showToast) {
            window.showToast('\u8ACB\u586B\u5BEB\u62D2\u7D55\u539F\u56E0', 'warning');
          }
          return;
        }

        try {
          const response = await fetch('/api/business/verify/batch-reject', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({
              verification_ids: ids,
              rejection_reason: reason
            })
          });

          const data = await response.json();

          if (data.success) {
            if (window.showToast) {
              window.showToast(data.message || '\u6279\u91CF\u62D2\u7D55\u6210\u529F', 'success');
            }
            closeBatchRejectModal();
            // \u6E05\u9664\u6240\u6709\u9078\u4E2D\u72C0\u614B
            document.querySelectorAll('.verification-checkbox').forEach(cb => cb.checked = false);
            updateBatchActions();
            // \u91CD\u65B0\u8F09\u5165\u9801\u9762
            setTimeout(() => location.reload(), 1000);
          } else {
            if (window.showToast) {
              window.showToast('\u6279\u91CF\u62D2\u7D55\u5931\u6557\uFF1A' + (data.error || data.message || '\u672A\u77E5\u932F\u8AA4'), 'error');
            }
          }
        } catch (error) {
          console.error('\u6279\u91CF\u62D2\u7D55\u5931\u6557:', error);
          if (window.showToast) {
            window.showToast('\u6279\u91CF\u62D2\u7D55\u5931\u6557\uFF0C\u8ACB\u7A0D\u5F8C\u518D\u8A66', 'error');
          }
        }
      }

      // \u8F09\u5165\u7D71\u8A08\u6578\u64DA
      async function loadStatistics() {
        try {
            const response = await fetch('/api/business/verify/stats', { credentials: 'include' });
            const data = await response.json();
            
            if (data.success && data.stats) {
                document.getElementById('approved-count').textContent = data.stats.approved;
                document.getElementById('rejected-count').textContent = data.stats.rejected;
                // \u66F4\u65B0 tab \u4E0A\u7684\u8A08\u6578\uFF08\u5982\u679C\u6709\u8B8A\u52D5\uFF09
                // \u9019\u88E1\u53EF\u4EE5\u9078\u64C7\u662F\u5426\u66F4\u65B0\u5F85\u5BE9\u6838\u6578\u91CF\uFF0C\u96D6\u7136\u5B83\u662F\u5F9E\u9801\u9762\u6E32\u67D3\u6578\u64DA\u4F86\u7684
            }
        } catch (error) {
            console.error('\u8F09\u5165\u7D71\u8A08\u6578\u64DA\u5931\u6557:', error);
        }
      }

      // \u9801\u9762\u8F09\u5165\u6642\u57F7\u884C
      document.addEventListener('DOMContentLoaded', function() {
        loadStatistics();
      });
    </script>
  `;
    return new Response(pageTemplate2({
      title: "\u5546\u5BB6\u9A57\u8B49\u5BE9\u6838 - \u7BA1\u7406\u54E1",
      content,
      user,
      nonce,
      cssContent
    }), {
      headers: { "Content-Type": "text/html;charset=utf-8" }
    });
  } catch (error) {
    console.error("[BusinessVerificationAdmin] Error rendering page:", error);
    return new Response("Error: " + error.message, { status: 500 });
  }
}

// src/pages/EcosystemDashboard.js
init_layout();
init_auth();
init_ServiceFactory();
async function renderEcosystemDashboardPage(request, env, session, user, nonce, cssContent) {
  var _a, _b, _c, _d, _e, _f, _g, _h, _i, _j, _k, _l, _m, _n, _o, _p, _q, _r, _s, _t, _u, _v, _w, _x, _y, _z, _A, _B, _C, _D, _E, _F, _G, _H, _I;
  const authCheck = requireAdmin(user, request);
  if (authCheck)
    return authCheck;
  const dbHealth = await ServiceHealthChecker.checkDatabase(env.DB);
  if (!dbHealth.healthy) {
    console.error("[EcosystemDashboard] Database not available:", dbHealth.error);
    return ErrorResponseBuilder.buildDatabaseErrorPage({
      user,
      nonce,
      cssContent
    });
  }
  const serviceFactory = new ServiceFactory(env);
  const ecosystemService = serviceFactory.getService("ecosystemService");
  const aiAgentFactory = serviceFactory.getService("aiAgentFactory");
  let ecosystemReport = null;
  let agentStats = null;
  try {
    ecosystemReport = await ecosystemService.getEcosystemReport({ days: 7 });
    agentStats = aiAgentFactory.getStats();
  } catch (error) {
    console.error("[EcosystemDashboard] Error fetching ecosystem data:", error);
  }
  const content = `
    <div class="min-h-screen bg-gray-50 py-8">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <!-- \u9801\u9762\u6A19\u984C -->
        <div class="mb-8">
          <h1 class="text-3xl font-bold text-gray-900">\u751F\u614B\u7CFB\u7D71\u76E3\u63A7</h1>
          <p class="mt-2 text-sm text-gray-600">
            \u76E3\u63A7\u7DB2\u7AD9\u751F\u614B\u5065\u5EB7\u72C0\u6CC1\uFF0C\u78BA\u4FDD\u300C\u670D\u52D9\u751F\u547D\uFF0C\u8B93\u4E16\u754C\u66F4\u597D\u66F4\u5E73\u8861\u300D
          </p>
        </div>

        <!-- \u7E3D\u9AD4\u5206\u6578\u5361\u7247 -->
        <div class="bg-white overflow-hidden shadow rounded-lg mb-8">
          <div class="p-6">
            <div class="flex items-center justify-between">
              <div>
                <h2 class="text-xl font-semibold text-gray-900">\u751F\u614B\u7CFB\u7D71\u7E3D\u9AD4\u5206\u6578</h2>
                <p class="mt-1 text-sm text-gray-500">\u57FA\u65BC\u7528\u6236\u798F\u7949\u3001\u8CC7\u6E90\u4F7F\u7528\u3001\u793E\u5340\u5065\u5EB7\u7684\u7D9C\u5408\u8A55\u4F30</p>
              </div>
              <div class="text-right">
                <div class="text-5xl font-bold" id="overall-score" style="color: #10b981;">
                  ${(ecosystemReport == null ? void 0 : ecosystemReport.overallScore) || "--"}
                </div>
                <div class="text-sm text-gray-500 mt-1">/ 100</div>
              </div>
            </div>
          </div>
        </div>

        <!-- \u4E09\u500B\u4E3B\u8981\u6307\u6A19 -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
          <!-- \u7528\u6236\u798F\u7949 -->
          <div class="bg-white overflow-hidden shadow rounded-lg">
            <div class="p-6">
              <div class="flex items-center">
                <div class="flex-shrink-0">
                  <div class="w-12 h-12 bg-blue-500 rounded-md flex items-center justify-center">
                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path>
                    </svg>
                  </div>
                </div>
                <div class="ml-4">
                  <h3 class="text-lg font-medium text-gray-900">\u7528\u6236\u798F\u7949</h3>
                  <p class="text-sm text-gray-500">User Wellbeing</p>
                </div>
              </div>
              <div class="mt-4">
                <div class="text-2xl font-semibold text-gray-900" id="wellbeing-score">
                  ${((_a = ecosystemReport == null ? void 0 : ecosystemReport.wellbeing) == null ? void 0 : _a.averageSatisfaction) ? Math.round(ecosystemReport.wellbeing.averageSatisfaction) : "--"}
                </div>
                <div class="text-sm text-gray-500 mt-1">
                  \u5E73\u5747\u6EFF\u610F\u5EA6 (${((_b = ecosystemReport == null ? void 0 : ecosystemReport.wellbeing) == null ? void 0 : _b.period) || "N/A"})
                </div>
              </div>
            </div>
          </div>

          <!-- \u8CC7\u6E90\u4F7F\u7528 -->
          <div class="bg-white overflow-hidden shadow rounded-lg">
            <div class="p-6">
              <div class="flex items-center">
                <div class="flex-shrink-0">
                  <div class="w-12 h-12 bg-green-500 rounded-md flex items-center justify-center">
                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                    </svg>
                  </div>
                </div>
                <div class="ml-4">
                  <h3 class="text-lg font-medium text-gray-900">\u8CC7\u6E90\u4F7F\u7528</h3>
                  <p class="text-sm text-gray-500">Resource Usage</p>
                </div>
              </div>
              <div class="mt-4">
                <div class="text-2xl font-semibold text-gray-900" id="resource-cost">
                  $${((_d = (_c = ecosystemReport == null ? void 0 : ecosystemReport.resourceUsage) == null ? void 0 : _c.totalCost) == null ? void 0 : _d.toFixed(2)) || "0.00"}
                </div>
                <div class="text-sm text-gray-500 mt-1">
                  \u7E3D\u6210\u672C (${((_e = ecosystemReport == null ? void 0 : ecosystemReport.resourceUsage) == null ? void 0 : _e.period) || "N/A"})
                </div>
              </div>
            </div>
          </div>

          <!-- \u793E\u5340\u5065\u5EB7 -->
          <div class="bg-white overflow-hidden shadow rounded-lg">
            <div class="p-6">
              <div class="flex items-center">
                <div class="flex-shrink-0">
                  <div class="w-12 h-12 bg-purple-500 rounded-md flex items-center justify-center">
                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 01 6 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                    </svg>
                  </div>
                </div>
                <div class="ml-4">
                  <h3 class="text-lg font-medium text-gray-900">\u793E\u5340\u5065\u5EB7</h3>
                  <p class="text-sm text-gray-500">Community Health</p>
                </div>
              </div>
              <div class="mt-4">
                <div class="text-2xl font-semibold text-gray-900" id="community-health-score">
                  ${((_f = ecosystemReport == null ? void 0 : ecosystemReport.communityHealth) == null ? void 0 : _f.healthScore) || "--"}
                </div>
                <div class="text-sm text-gray-500 mt-1">
                  \u5065\u5EB7\u5206\u6578 (${((_g = ecosystemReport == null ? void 0 : ecosystemReport.communityHealth) == null ? void 0 : _g.period) || "N/A"})
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- \u8A73\u7D30\u6578\u64DA -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
          <!-- \u7528\u6236\u798F\u7949\u8A73\u60C5 -->
          <div class="bg-white shadow rounded-lg">
            <div class="px-4 py-5 sm:p-6">
              <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">\u7528\u6236\u798F\u7949\u8A73\u60C5</h3>
              <div class="space-y-4">
                <div class="flex items-center justify-between">
                  <span class="text-sm text-gray-500">\u5E73\u5747\u6EFF\u610F\u5EA6</span>
                  <span class="text-sm font-medium" id="avg-satisfaction">
                    ${((_i = (_h = ecosystemReport == null ? void 0 : ecosystemReport.wellbeing) == null ? void 0 : _h.averageSatisfaction) == null ? void 0 : _i.toFixed(1)) || "--"} / 100
                  </span>
                </div>
                <div class="flex items-center justify-between">
                  <span class="text-sm text-gray-500">\u5E73\u5747\u53C3\u8207\u5EA6</span>
                  <span class="text-sm font-medium" id="avg-engagement">
                    ${((_k = (_j = ecosystemReport == null ? void 0 : ecosystemReport.wellbeing) == null ? void 0 : _j.averageEngagement) == null ? void 0 : _k.toFixed(1)) || "--"} / 100
                  </span>
                </div>
                <div class="flex items-center justify-between">
                  <span class="text-sm text-gray-500">\u5E73\u5747\u9AD4\u9A57\u5206\u6578</span>
                  <span class="text-sm font-medium" id="avg-experience">
                    ${((_m = (_l = ecosystemReport == null ? void 0 : ecosystemReport.wellbeing) == null ? void 0 : _l.averageExperience) == null ? void 0 : _m.toFixed(1)) || "--"} / 100
                  </span>
                </div>
                <div class="flex items-center justify-between">
                  <span class="text-sm text-gray-500">\u8FFD\u8E64\u6B21\u6578</span>
                  <span class="text-sm font-medium" id="tracking-count">
                    ${((_n = ecosystemReport == null ? void 0 : ecosystemReport.wellbeing) == null ? void 0 : _n.trackingCount) || 0}
                  </span>
                </div>
              </div>
            </div>
          </div>

          <!-- \u8CC7\u6E90\u4F7F\u7528\u8A73\u60C5 -->
          <div class="bg-white shadow rounded-lg">
            <div class="px-4 py-5 sm:p-6">
              <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">\u8CC7\u6E90\u4F7F\u7528\u8A73\u60C5</h3>
              <div class="space-y-4">
                <div class="flex items-center justify-between">
                  <span class="text-sm text-gray-500">API \u8ABF\u7528</span>
                  <span class="text-sm font-medium" id="api-calls">
                    ${((_p = (_o = ecosystemReport == null ? void 0 : ecosystemReport.resourceUsage) == null ? void 0 : _o.totalApiCalls) == null ? void 0 : _p.toLocaleString()) || "0"}
                  </span>
                </div>
                <div class="flex items-center justify-between">
                  <span class="text-sm text-gray-500">AI \u8ABF\u7528</span>
                  <span class="text-sm font-medium" id="ai-calls">
                    ${((_r = (_q = ecosystemReport == null ? void 0 : ecosystemReport.resourceUsage) == null ? void 0 : _q.totalAiCalls) == null ? void 0 : _r.toLocaleString()) || "0"}
                  </span>
                </div>
                <div class="flex items-center justify-between">
                  <span class="text-sm text-gray-500">\u5E73\u5747\u5B58\u5132</span>
                  <span class="text-sm font-medium" id="avg-storage">
                    ${((_t = (_s = ecosystemReport == null ? void 0 : ecosystemReport.resourceUsage) == null ? void 0 : _s.averageStorage) == null ? void 0 : _t.toFixed(2)) || "0"} MB
                  </span>
                </div>
                <div class="flex items-center justify-between">
                  <span class="text-sm text-gray-500">\u7E3D\u5E36\u5BEC</span>
                  <span class="text-sm font-medium" id="total-bandwidth">
                    ${((_v = (_u = ecosystemReport == null ? void 0 : ecosystemReport.resourceUsage) == null ? void 0 : _u.totalBandwidth) == null ? void 0 : _v.toFixed(2)) || "0"} MB
                  </span>
                </div>
                <div class="flex items-center justify-between">
                  <span class="text-sm text-gray-500">\u7E3D\u6210\u672C</span>
                  <span class="text-sm font-medium text-red-600" id="total-cost">
                    $${((_x = (_w = ecosystemReport == null ? void 0 : ecosystemReport.resourceUsage) == null ? void 0 : _w.totalCost) == null ? void 0 : _x.toFixed(2)) || "0.00"}
                  </span>
                </div>
              </div>
            </div>
          </div>

          <!-- \u793E\u5340\u5065\u5EB7\u8A73\u60C5 -->
          <div class="bg-white shadow rounded-lg">
            <div class="px-4 py-5 sm:p-6">
              <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">\u793E\u5340\u5065\u5EB7\u8A73\u60C5</h3>
              <div class="space-y-4">
                <div class="flex items-center justify-between">
                  <span class="text-sm text-gray-500">\u5E73\u5747\u6D3B\u8E8D\u7528\u6236</span>
                  <span class="text-sm font-medium" id="avg-active-users">
                    ${((_z = (_y = ecosystemReport == null ? void 0 : ecosystemReport.communityHealth) == null ? void 0 : _y.averageActiveUsers) == null ? void 0 : _z.toFixed(0)) || "0"}
                  </span>
                </div>
                <div class="flex items-center justify-between">
                  <span class="text-sm text-gray-500">\u7E3D\u4E92\u52D5\u6B21\u6578</span>
                  <span class="text-sm font-medium" id="total-interactions">
                    ${((_B = (_A = ecosystemReport == null ? void 0 : ecosystemReport.communityHealth) == null ? void 0 : _A.totalInteractions) == null ? void 0 : _B.toLocaleString()) || "0"}
                  </span>
                </div>
                <div class="flex items-center justify-between">
                  <span class="text-sm text-gray-500">\u5E73\u5747\u591A\u6A23\u6027</span>
                  <span class="text-sm font-medium" id="avg-diversity">
                    ${((_D = (_C = ecosystemReport == null ? void 0 : ecosystemReport.communityHealth) == null ? void 0 : _C.averageDiversity) == null ? void 0 : _D.toFixed(1)) || "0"} / 100
                  </span>
                </div>
                <div class="flex items-center justify-between">
                  <span class="text-sm text-gray-500">\u5E73\u5747\u53C3\u8207\u7387</span>
                  <span class="text-sm font-medium" id="avg-engagement-rate">
                    ${((_F = (_E = ecosystemReport == null ? void 0 : ecosystemReport.communityHealth) == null ? void 0 : _E.averageEngagementRate) == null ? void 0 : _F.toFixed(1)) || "0"}%
                  </span>
                </div>
                <div class="flex items-center justify-between">
                  <span class="text-sm text-gray-500">\u5065\u5EB7\u5206\u6578</span>
                  <span class="text-sm font-medium text-green-600" id="health-score">
                    ${((_G = ecosystemReport == null ? void 0 : ecosystemReport.communityHealth) == null ? void 0 : _G.healthScore) || "0"} / 100
                  </span>
                </div>
              </div>
            </div>
          </div>

          <!-- AI Agent \u7D71\u8A08 -->
          <div class="bg-white shadow rounded-lg">
            <div class="px-4 py-5 sm:p-6">
              <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">AI Agent \u7D71\u8A08</h3>
              <div class="space-y-4">
                <div class="flex items-center justify-between">
                  <span class="text-sm text-gray-500">\u7E3D Agent \u6578</span>
                  <span class="text-sm font-medium" id="total-agents">
                    ${(agentStats == null ? void 0 : agentStats.totalAgents) || 0}
                  </span>
                </div>
                <div class="flex items-center justify-between">
                  <span class="text-sm text-gray-500">\u7E3D\u4F7F\u7528\u6B21\u6578</span>
                  <span class="text-sm font-medium" id="total-usage">
                    ${((_H = agentStats == null ? void 0 : agentStats.totalUsage) == null ? void 0 : _H.toLocaleString()) || "0"}
                  </span>
                </div>
                <div class="mt-4">
                  <h4 class="text-sm font-medium text-gray-700 mb-2">\u6309\u985E\u578B\u7D71\u8A08</h4>
                  <div class="space-y-2" id="agents-by-type">
                    ${(agentStats == null ? void 0 : agentStats.agentsByType) ? Object.entries(agentStats.agentsByType).map(([type, data]) => `
                      <div class="flex items-center justify-between text-sm">
                        <span class="text-gray-500">${type}</span>
                        <span class="font-medium">${data.count} \u500B, ${data.totalUsage} \u6B21\u4F7F\u7528</span>
                      </div>
                    `).join("") : '<div class="text-sm text-gray-500">\u66AB\u7121\u6578\u64DA</div>'}
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- \u6539\u9032\u5EFA\u8B70 -->
        <div class="bg-white shadow rounded-lg mb-8">
          <div class="px-4 py-5 sm:p-6">
            <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">\u6539\u9032\u5EFA\u8B70</h3>
            <div class="space-y-3" id="recommendations">
              ${((_I = ecosystemReport == null ? void 0 : ecosystemReport.recommendations) == null ? void 0 : _I.length) > 0 ? ecosystemReport.recommendations.map((rec) => `
                  <div class="flex items-start p-3 rounded-md ${rec.priority === "high" ? "bg-red-50 border border-red-200" : rec.priority === "medium" ? "bg-yellow-50 border border-yellow-200" : "bg-blue-50 border border-blue-200"}">
                    <div class="flex-shrink-0">
                      <span class="text-sm font-medium ${rec.priority === "high" ? "text-red-800" : rec.priority === "medium" ? "text-yellow-800" : "text-blue-800"}">
                        ${rec.priority === "high" ? "\u{1F534} \u9AD8" : rec.priority === "medium" ? "\u{1F7E1} \u4E2D" : "\u{1F535} \u4F4E"}
                      </span>
                    </div>
                    <div class="ml-3 flex-1">
                      <p class="text-sm ${rec.priority === "high" ? "text-red-700" : rec.priority === "medium" ? "text-yellow-700" : "text-blue-700"}">
                        ${rec.message}
                      </p>
                      <p class="text-xs ${rec.priority === "high" ? "text-red-600" : rec.priority === "medium" ? "text-yellow-600" : "text-blue-600"} mt-1">
                        \u5EFA\u8B70\u64CD\u4F5C: ${rec.action}
                      </p>
                    </div>
                  </div>
                `).join("") : '<div class="text-sm text-gray-500">\u66AB\u7121\u5EFA\u8B70</div>'}
            </div>
          </div>
        </div>

        <!-- \u64CD\u4F5C\u6309\u9215 -->
        <div class="flex space-x-4 mb-8">
          <button onclick="refreshEcosystemReport()" class="bg-blue-600 text-white px-4 py-2 rounded-md text-sm font-medium hover:bg-blue-700">
            \u5237\u65B0\u5831\u544A
          </button>
          <a href="/admin/dashboard" class="bg-gray-600 text-white px-4 py-2 rounded-md text-sm font-medium hover:bg-gray-700 text-center">
            \u8FD4\u56DE\u7BA1\u7406\u5F8C\u53F0
          </a>
        </div>
      </div>
    </div>

    <script nonce="${nonce}">
      // API \u8ABF\u7528\u51FD\u6578
      async function apiCall(url, method = 'GET', body = null) {
        try {
          const options = {
            method,
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include'
          };
          if (body) {
            options.body = JSON.stringify(body);
          }
          const response = await fetch(url, options);
          if (!response.ok) {
            throw new Error(\`HTTP \${response.status}: \${response.statusText}\`);
          }
          return await response.json();
        } catch (error) {
          console.error('API call failed:', error);
          throw error;
        }
      }

      // \u5237\u65B0\u751F\u614B\u7CFB\u7D71\u5831\u544A
      async function refreshEcosystemReport() {
        try {
          const report = await apiCall('/api/admin/ecosystem/report?days=7');
          
          // \u66F4\u65B0\u7E3D\u9AD4\u5206\u6578
          document.getElementById('overall-score').textContent = report.overallScore || '--';
          
          // \u66F4\u65B0\u7528\u6236\u798F\u7949
          document.getElementById('wellbeing-score').textContent = 
            report.wellbeing?.averageSatisfaction ? Math.round(report.wellbeing.averageSatisfaction) : '--';
          document.getElementById('avg-satisfaction').textContent = 
            \`\${report.wellbeing?.averageSatisfaction?.toFixed(1) || '--'} / 100\`;
          document.getElementById('avg-engagement').textContent = 
            \`\${report.wellbeing?.averageEngagement?.toFixed(1) || '--'} / 100\`;
          document.getElementById('avg-experience').textContent = 
            \`\${report.wellbeing?.averageExperience?.toFixed(1) || '--'} / 100\`;
          document.getElementById('tracking-count').textContent = 
            report.wellbeing?.trackingCount || 0;
          
          // \u66F4\u65B0\u8CC7\u6E90\u4F7F\u7528
          document.getElementById('resource-cost').textContent = 
            \`$\${report.resourceUsage?.totalCost?.toFixed(2) || '0.00'}\`;
          document.getElementById('api-calls').textContent = 
            report.resourceUsage?.totalApiCalls?.toLocaleString() || '0';
          document.getElementById('ai-calls').textContent = 
            report.resourceUsage?.totalAiCalls?.toLocaleString() || '0';
          document.getElementById('avg-storage').textContent = 
            \`\${report.resourceUsage?.averageStorage?.toFixed(2) || '0'} MB\`;
          document.getElementById('total-bandwidth').textContent = 
            \`\${report.resourceUsage?.totalBandwidth?.toFixed(2) || '0'} MB\`;
          document.getElementById('total-cost').textContent = 
            \`$\${report.resourceUsage?.totalCost?.toFixed(2) || '0.00'}\`;
          
          // \u66F4\u65B0\u793E\u5340\u5065\u5EB7
          document.getElementById('community-health-score').textContent = 
            report.communityHealth?.healthScore || '--';
          document.getElementById('avg-active-users').textContent = 
            report.communityHealth?.averageActiveUsers?.toFixed(0) || '0';
          document.getElementById('total-interactions').textContent = 
            report.communityHealth?.totalInteractions?.toLocaleString() || '0';
          document.getElementById('avg-diversity').textContent = 
            \`\${report.communityHealth?.averageDiversity?.toFixed(1) || '0'} / 100\`;
          document.getElementById('avg-engagement-rate').textContent = 
            \`\${report.communityHealth?.averageEngagementRate?.toFixed(1) || '0'}%\`;
          document.getElementById('health-score').textContent = 
            \`\${report.communityHealth?.healthScore || '0'} / 100\`;
          
          // \u66F4\u65B0\u6539\u9032\u5EFA\u8B70
          const recommendationsDiv = document.getElementById('recommendations');
          if (report.recommendations && report.recommendations.length > 0) {
            recommendationsDiv.innerHTML = report.recommendations.map(rec => \`
              <div class="flex items-start p-3 rounded-md \${
                rec.priority === 'high' ? 'bg-red-50 border border-red-200' :
                rec.priority === 'medium' ? 'bg-yellow-50 border border-yellow-200' :
                'bg-blue-50 border border-blue-200'
              }">
                <div class="flex-shrink-0">
                  <span class="text-sm font-medium \${
                    rec.priority === 'high' ? 'text-red-800' :
                    rec.priority === 'medium' ? 'text-yellow-800' :
                    'text-blue-800'
                  }">
                    \${rec.priority === 'high' ? '\u{1F534} \u9AD8' : rec.priority === 'medium' ? '\u{1F7E1} \u4E2D' : '\u{1F535} \u4F4E'}
                  </span>
                </div>
                <div class="ml-3 flex-1">
                  <p class="text-sm \${
                    rec.priority === 'high' ? 'text-red-700' :
                    rec.priority === 'medium' ? 'text-yellow-700' :
                    'text-blue-700'
                  }">
                    \${rec.message}
                  </p>
                  <p class="text-xs \${
                    rec.priority === 'high' ? 'text-red-600' :
                    rec.priority === 'medium' ? 'text-yellow-600' :
                    'text-blue-600'
                  } mt-1">
                    \u5EFA\u8B70\u64CD\u4F5C: \${rec.action}
                  </p>
                </div>
              </div>
            \`).join('');
          } else {
            recommendationsDiv.innerHTML = '<div class="text-sm text-gray-500">\u66AB\u7121\u5EFA\u8B70</div>';
          }
          
          alert('\u5831\u544A\u5DF2\u5237\u65B0\uFF01');
        } catch (error) {
          console.error('\u5237\u65B0\u5831\u544A\u5931\u6557:', error);
          alert('\u5237\u65B0\u5931\u6557: ' + error.message);
        }
      }

      // \u5B9A\u671F\u81EA\u52D5\u5237\u65B0\uFF08\u6BCF5\u5206\u9418\uFF09
      setInterval(() => {
        refreshEcosystemReport();
      }, 300000);
    </script>
  `;
  return new Response(pageTemplate2({
    title: "\u751F\u614B\u7CFB\u7D71\u76E3\u63A7 - \u7BA1\u7406\u5F8C\u53F0",
    content,
    user,
    nonce,
    cssContent: cssContent + `
      /* \u751F\u614B\u7CFB\u7D71\u76E3\u63A7\u9801\u9762\u7279\u5B9A\u6A23\u5F0F */
      .bg-gray-50 { background-color: #f9fafb; }
    `,
    currentPath: "/admin/ecosystem"
  }), {
    headers: {
      "Content-Type": "text/html;charset=utf-8"
    }
  });
}

// src/pages/Profile.js
init_layout();
init_LocationService();
async function _renderProfilePage(request, env, session, user, nonce, cssContent) {
  console.log("[Profile.js] renderProfilePage called with user:", user ? user.email : "null");
  if (!user) {
    console.log("[Profile.js] No user, redirecting to login");
    return Response.redirect(new URL(request.url).origin + "/login", 302);
  }
  const dbHealth = await ServiceHealthChecker.checkDatabase(env.DB);
  if (!dbHealth.healthy) {
    console.error("[Profile] Database not available:", dbHealth.error);
    return ErrorResponseBuilder.buildDatabaseErrorPage({
      user,
      nonce,
      cssContent
    });
  }
  console.log("[Profile.js] Creating LocationService...");
  const locationService = new LocationService(env.DB, env.GOOGLE_MAPS_API_KEY);
  console.log("[Profile.js] Getting all user locations (optimized)...");
  const { userLocations, userCreatedLocations } = await locationService.getUserAllLocationsOptimized(user.id);
  console.log("[Profile.js] Found", userLocations.length, "user locations and", userCreatedLocations.length, "user created locations");
  const visitedLocations = userLocations.filter((loc) => loc.user_location_status === "visited");
  const wantToVisitLocations = userLocations.filter((loc) => loc.user_location_status === "want_to_visit");
  const wantToRevisitLocations = userLocations.filter((loc) => loc.user_location_status === "want_to_revisit");
  const createdLocations = userCreatedLocations;
  console.log("[Profile.js] Generating content...");
  const content = `
    <div class="max-w-6xl mx-auto px-4 py-8">
      <!-- \u7528\u6236\u8CC7\u8A0A\u5340\u57DF -->
      <div class="bg-white rounded-lg shadow-md p-6 mb-8">
        <div class="flex items-center space-x-4">
          ${user.avatar_url ? `<img src="${user.avatar_url}" alt="User Avatar" class="w-16 h-16 rounded-full object-cover">` : `<span class="w-16 h-16 rounded-full bg-blue-500 flex items-center justify-center text-2xl font-semibold text-white">${user.name ? user.name.charAt(0).toUpperCase() : "?"}</span>`}
          <div>
            <h1 class="text-2xl font-bold text-gray-900">${user.name || "\u4F7F\u7528\u8005"}</h1>
            <p class="text-gray-600">${user.email || "\u96FB\u5B50\u90F5\u4EF6\u672A\u63D0\u4F9B"}</p>
            <div class="flex space-x-4 mt-2 text-sm text-gray-500">
              <span>\u4F86\u904E: ${visitedLocations.length}</span>
              <span>\u60F3\u4F86: ${wantToVisitLocations.length}</span>
              <span>\u60F3\u518D\u4F86: ${wantToRevisitLocations.length}</span>
              <span>\u6211\u5EFA\u7ACB: ${createdLocations.length}</span>
            </div>
          </div>
        </div>
      </div>

      <!-- \u6211\u7684\u5730\u9EDE\u5206\u985E\u6A19\u7C64 -->
      <div class="bg-white rounded-lg shadow-md p-6 mb-8">
        <h2 class="text-xl font-semibold mb-4">\u6211\u7684\u5730\u9EDE</h2>
        <div class="flex flex-wrap gap-2 mb-6">
          <button onclick="showLocationCategory('visited')" class="location-tab active px-4 py-2 rounded-full bg-blue-500 text-white text-sm font-medium transition-colors">
            \u4F86\u904E (${visitedLocations.length})
          </button>
          <button onclick="showLocationCategory('want_to_visit')" class="location-tab px-4 py-2 rounded-full bg-gray-200 text-gray-700 text-sm font-medium transition-colors">
            \u60F3\u4F86 (${wantToVisitLocations.length})
          </button>
          <button onclick="showLocationCategory('want_to_revisit')" class="location-tab px-4 py-2 rounded-full bg-gray-200 text-gray-700 text-sm font-medium transition-colors">
            \u60F3\u518D\u4F86 (${wantToRevisitLocations.length})
          </button>
          <button onclick="showLocationCategory('created')" class="location-tab px-4 py-2 rounded-full bg-gray-200 text-gray-700 text-sm font-medium transition-colors">
            \u6211\u5EFA\u7ACB (${createdLocations.length})
          </button>
        </div>

        <!-- \u4F86\u904E\u7684\u5730\u9EDE -->
        <div id="visited-locations" class="location-category">
          ${renderLocationGridWithComponent(visitedLocations, "visited")}
        </div>

        <!-- \u60F3\u4F86\u7684\u5730\u9EDE -->
        <div id="want_to_visit-locations" class="location-category" style="display: none;">
          ${renderLocationGridWithComponent(wantToVisitLocations, "want_to_visit")}
        </div>

        <!-- \u60F3\u518D\u4F86\u7684\u5730\u9EDE -->
        <div id="want_to_revisit-locations" class="location-category" style="display: none;">
          ${renderLocationGridWithComponent(wantToRevisitLocations, "want_to_revisit")}
        </div>

        <!-- \u6211\u5EFA\u7ACB\u7684\u5730\u9EDE -->
        <div id="created-locations" class="location-category" style="display: none;">
          ${renderLocationGridWithComponent(createdLocations, "created")}
        </div>
      </div>
    </div>

    <script nonce="${nonce}">
      // \u5730\u9EDE\u8A73\u60C5\u7BA1\u7406\u5668
      let locationDetailManager = null;
      
      // \u7C21\u5316\u7684\u5730\u9EDE\u8A73\u60C5\u7BA1\u7406\u5668\uFF08\u4E0D\u4F9D\u8CF4\u5916\u90E8\u6A21\u7D44\uFF09
      class SimpleLocationDetailManager {
        constructor() {
          this.isVisible = false;
          this.currentLocation = null;
        }
        
        showLocationDetail(location) {
          this.currentLocation = location;
          this.isVisible = true;
          this.renderPanel();
        }
        
        hideLocationDetail() {
          this.isVisible = false;
          this.removePanel();
        }
        
        renderPanel() {
          if (!this.currentLocation) return;
          
          const panel = document.createElement('div');
          panel.id = 'location-detail-panel';
          panel.className = 'location-detail-panel visible';
          
          panel.innerHTML = this.createPanelHTML(this.currentLocation);
          document.body.appendChild(panel);
          
          // \u6DFB\u52A0\u4E8B\u4EF6\u76E3\u807D\u5668
          this.addEventListeners();
        }
        
        createPanelHTML(location) {
          return '<div class="detail-panel-overlay" onclick="closeLocationDetail()"></div>' +
            '<div class="detail-panel-content">' +
              '<button class="detail-panel-close-mobile" onclick="closeLocationDetail()">' +
                '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">' +
                  '<path d="M19 12H5M12 19l-7-7 7-7"/>' +
                '</svg>' +
              '</button>' +
              '<button class="detail-panel-close-desktop" onclick="closeLocationDetail()">' +
                '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">' +
                  '<path d="M18 6L6 18M6 6l12 12"/>' +
                '</svg>' +
              '</button>' +
              '<div class="detail-panel-image">' +
                '<img src="' + (location.thumbnail_url || 'https://placehold.co/600x400/6B7280/FFFFFF?text=Location+Image') + '" ' +
                     'alt="' + (location.name || '\u5730\u9EDE\u7167\u7247') + '" ' +
                     'class="detail-panel-img">' +
                this.renderStatusBadge(location.user_location_status) +
              '</div>' +
              '<div class="detail-panel-info">' +
                '<h2 class="detail-panel-title">' + (location.name || '\u672A\u547D\u540D\u5730\u9EDE') + '</h2>' +
                '<div class="detail-panel-meta">' +
                  '<div class="meta-item">' +
                    '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">' +
                      '<path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/>' +
                      '<circle cx="12" cy="10" r="3"/>' +
                    '</svg>' +
                    '<span>' + (location.address || '\u7121\u5730\u5740\u8CC7\u8A0A') + '</span>' +
                  '</div>' +
                '</div>' +
                '<div class="detail-panel-actions">' +
                  '<h3>\u6211\u7684\u72C0\u614B</h3>' +
                  '<div class="action-buttons">' +
                    this.renderStatusButtons(location) +
                  '</div>' +
                '</div>' +
              '</div>' +
            '</div>';
        }
        
        renderStatusBadge(status) {
          if (!status) return '';
          const statusConfig = {
            visited: { text: '\u4F86\u904E', class: 'bg-green-100 text-green-800' },
            want_to_visit: { text: '\u60F3\u4F86', class: 'bg-blue-100 text-blue-800' },
            want_to_revisit: { text: '\u60F3\u518D\u4F86', class: 'bg-purple-100 text-purple-800' }
          };
          const config = statusConfig[status];
          return config ? '<span class="status-badge ' + config.class + '">' + config.text + '</span>' : '';
        }
        
        renderStatusButtons(location) {
          const statuses = [
            { key: 'visited', text: '\u4F86\u904E', color: 'green' },
            { key: 'want_to_visit', text: '\u60F3\u4F86', color: 'blue' },
            { key: 'want_to_revisit', text: '\u60F3\u518D\u4F86', color: 'purple' }
          ];
          
          return statuses.map(status => {
            const isActive = location.user_location_status === status.key;
            const activeClass = isActive ? 'bg-' + status.color + '-500 text-white' : 'bg-gray-200 text-gray-700';
            return '<button onclick="updateLocationStatus('' + location.id + '', '' + status.key + '', event)" ' +
                    'class="status-btn ' + activeClass + '">' +
                    status.text +
                    '</button>';
          }).join('');
        }
        
        removePanel() {
          const panel = document.getElementById('location-detail-panel');
          if (panel) {
            panel.remove();
          }
        }
        
        addEventListeners() {
          document.addEventListener('keydown', this.handleKeyDown.bind(this));
        }
        
        handleKeyDown(event) {
          if (event.key === 'Escape') {
            this.hideLocationDetail();
          }
        }
      }
      
      // \u521D\u59CB\u5316\u8A73\u60C5\u7BA1\u7406\u5668
      function initLocationDetailManager() {
        if (!locationDetailManager) {
          locationDetailManager = new SimpleLocationDetailManager();
        }
      }
      
      // \u8655\u7406\u5730\u9EDE\u5361\u7247\u9EDE\u64CA
      function handleLocationCardClick(locationId, event) {
        event.preventDefault();
        event.stopPropagation();
        
        // \u7372\u53D6\u5730\u9EDE\u6578\u64DA
        const locationData = getLocationDataById(locationId);
        if (locationData) {
          initLocationDetailManager();
          locationDetailManager.showLocationDetail(locationData);
        }
      }
      
      // \u7372\u53D6\u5730\u9EDE\u6578\u64DA
      function getLocationDataById(locationId) {
        // \u5F9E DOM \u4E2D\u7372\u53D6\u5730\u9EDE\u5361\u7247\u7684\u6578\u64DA
        const card = document.querySelector('.location-card[data-location-id="' + locationId + '"]');
        if (!card) return null;
        
        const name = card.querySelector('h3').textContent.trim();
        const address = card.querySelector('div > p.text-sm').textContent.trim(); // \u7B2C\u4E00\u500B p \u662F\u5730\u5740
        // \u6CE8\u610F\uFF1A\u5716\u7247 URL \u53EF\u80FD\u5728 onerror \u4E2D\u88AB\u66FF\u63DB\uFF0C\u9019\u88E1\u5617\u8A66\u7372\u53D6\u539F\u59CB src
        const img = card.querySelector('img');
        const thumbnailUrl = img ? img.src : null;
        
        // \u5617\u8A66\u7372\u53D6\u985E\u578B\u8CC7\u8A0A
        const typeEl = Array.from(card.querySelectorAll('p')).find(p => p.textContent.includes('\u985E\u578B:'));
        const typesText = typeEl ? typeEl.textContent.replace('\u985E\u578B:', '').trim() : '';
        
        // \u5617\u8A66\u7372\u53D6\u7C21\u4ECB
        const summaryEl = card.querySelector('p.max-h-12');
        const summary = summaryEl ? summaryEl.textContent.trim() : null; // \u4F7F\u7528 textContent \u907F\u514D HTML \u5BE6\u9AD4\u554F\u984C
        
        // \u5617\u8A66\u5F9E\u6309\u9215\u72C0\u614B\u7372\u53D6\u7576\u524D\u7528\u6236\u72C0\u614B
        let status = null;
        if (card.querySelector('button.bg-green-500')) status = 'visited';
        else if (card.querySelector('button.bg-blue-500')) status = 'want_to_visit';
        else if (card.querySelector('button.bg-purple-500')) status = 'want_to_revisit';
        
        return {
          id: locationId,
          name: name,
          address: address,
          thumbnail_url: thumbnailUrl,
          google_types: JSON.stringify([typesText]), // \u7C21\u55AE\u5C01\u88DD\u4EE5\u7B26\u5408\u9810\u671F\u683C\u5F0F
          editorial_summary: summary,
          user_location_status: status
        };
      }
      
      // \u95DC\u9589\u5730\u9EDE\u8A73\u60C5
      function closeLocationDetail() {
        if (locationDetailManager) {
          locationDetailManager.hideLocationDetail();
        }
      }
      
      function showLocationCategory(category) {
        // \u96B1\u85CF\u6240\u6709\u5206\u985E
        document.querySelectorAll('.location-category').forEach(el => {
          el.style.display = 'none';
        });
        
        // \u986F\u793A\u9078\u4E2D\u7684\u5206\u985E
        const targetElement = document.getElementById(category + '-locations');
        if (targetElement) {
          targetElement.style.display = 'block';
        }
        
        // \u66F4\u65B0\u6A19\u7C64\u6A23\u5F0F
        document.querySelectorAll('.location-tab').forEach(tab => {
          tab.classList.remove('active', 'bg-blue-500', 'text-white');
          tab.classList.add('bg-gray-200', 'text-gray-700');
        });
        
        // \u6FC0\u6D3B\u9078\u4E2D\u7684\u6A19\u7C64
        const activeTab = event.target;
        activeTab.classList.remove('bg-gray-200', 'text-gray-700');
        activeTab.classList.add('active', 'bg-blue-500', 'text-white');
      }

      function updateLocationStatus(locationId, newStatus, event) {
        if (event) {
          event.preventDefault();
          event.stopPropagation();
        }
        
        fetch('/api/location/status', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            locationId: locationId,
            status: newStatus
          })
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            // \u66F4\u65B0\u6309\u9215\u72C0\u614B
            const button = event ? event.target.closest('button') : null;
            if (button) {
              // \u91CD\u7F6E\u6240\u6709\u6309\u9215
              const allButtons = button.parentElement.querySelectorAll('button');
              allButtons.forEach(btn => {
                btn.classList.remove('bg-green-500', 'bg-blue-500', 'bg-purple-500', 'text-white');
                btn.classList.add('bg-gray-200', 'text-gray-700');
              });
              
              // \u6FC0\u6D3B\u9078\u4E2D\u7684\u6309\u9215
              button.classList.remove('bg-gray-200', 'text-gray-700');
              if (newStatus === 'visited') {
                button.classList.add('bg-green-500', 'text-white');
              } else if (newStatus === 'want_to_visit') {
                button.classList.add('bg-blue-500', 'text-white');
              } else if (newStatus === 'want_to_revisit') {
                button.classList.add('bg-purple-500', 'text-white');
              }
            }
            
            // \u5982\u679C\u8A73\u60C5\u9762\u677F\u6253\u958B\uFF0C\u66F4\u65B0\u8A73\u60C5\u9762\u677F
            if (locationDetailManager && locationDetailManager.isVisible) {
              // \u91CD\u65B0\u8F09\u5165\u8A73\u60C5\u9762\u677F\u6578\u64DA
              const updatedLocation = getLocationDataById(locationId);
              if (updatedLocation) {
                updatedLocation.user_location_status = newStatus;
                locationDetailManager.showLocationDetail(updatedLocation);
              }
            }
            // \u986F\u793A\u6210\u529F\u63D0\u793A
            if (window.showToast) {
              const statusText = newStatus === 'visited' ? '\u4F86\u904E' : 
                               newStatus === 'want_to_visit' ? '\u60F3\u4F86' : '\u60F3\u518D\u4F86';
              window.showToast('\u5DF2\u6A19\u8A18\u70BA\u300C' + statusText + '\u300D', 'success');
            }
          } else {
            if (window.showToast) {
              window.showToast('\u66F4\u65B0\u5931\u6557: ' + data.error, 'error');
            } else {
              alert('\u66F4\u65B0\u5931\u6557: ' + data.error);
            }
          }
        })
        .catch(error => {
          console.error('Error:', error);
          if (window.showToast) {
            window.showToast('\u66F4\u65B0\u5931\u6557\uFF0C\u8ACB\u7A0D\u5F8C\u518D\u8A66', 'error');
          } else {
            alert('\u66F4\u65B0\u5931\u6557\uFF0C\u8ACB\u7A0D\u5F8C\u518D\u8A66');
          }
        });
      }
      
      // \u9801\u9762\u8F09\u5165\u5B8C\u6210\u5F8C\u521D\u59CB\u5316
      document.addEventListener('DOMContentLoaded', function() {
        initLocationDetailManager();
      });
    </script>
  `;
  try {
    const url = new URL(request.url);
    return new Response(pageTemplate2({
      title: "\u6211\u7684\u5730\u9EDE - HOPENGHU",
      content,
      user,
      nonce,
      cssContent,
      currentPath: url.pathname
    }), {
      headers: { "Content-Type": "text/html;charset=utf-8" }
    });
  } catch (error) {
    console.error("[Profile] Error:", error);
    return ErrorResponseBuilder.buildErrorPage({
      title: "\u8F09\u5165\u500B\u4EBA\u8CC7\u6599\u5931\u6557",
      message: error.message || "\u7121\u6CD5\u8F09\u5165\u500B\u4EBA\u8CC7\u6599\uFF0C\u8ACB\u7A0D\u5F8C\u518D\u8A66\u3002",
      statusCode: 500,
      user,
      nonce,
      cssContent
    });
  }
}
var renderProfilePage = withErrorHandling(_renderProfilePage, {
  user: null,
  nonce: "",
  cssContent: ""
});
function renderLocationGridWithComponent(locations, category) {
  if (locations.length === 0) {
    return `
      <div class="text-center py-12">
        <div class="text-gray-400 mb-4">
          <svg class="mx-auto h-12 w-12" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
          </svg>
        </div>
        <h3 class="text-lg font-medium text-gray-900 mb-2">\u9084\u6C92\u6709${getCategoryName(category)}\u7684\u5730\u9EDE</h3>
        <p class="text-gray-500 mb-6">\u958B\u59CB\u63A2\u7D22\u4E26\u8A18\u9304\u60A8\u7684\u5730\u9EDE\u5427\uFF01</p>
        <a href="/" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700">
          <svg class="mr-2 h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
          </svg>
          \u700F\u89BD\u5730\u9EDE
        </a>
      </div>
    `;
  }
  return `
    <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 md:gap-6">
      ${locations.map((location) => {
    let typesArray = [];
    try {
      if (location.google_types) {
        typesArray = JSON.parse(location.google_types);
      }
    } catch (e) {
      console.error("Error parsing google_types JSON:", e, location.google_types);
    }
    const displayTypes = translatePlaceTypes(typesArray);
    return `
        <div class="location-card bg-white rounded-lg shadow-md overflow-hidden border border-gray-200 flex flex-col cursor-pointer transition-transform hover:scale-105" 
             data-location-id="${location.id}"
             onclick="handleLocationCardClick('${location.id}')">
          ${createImageWithFallback(
      location.thumbnail_url || "https://placehold.co/400x268/png?text=No+Image",
      location.name || "\u5730\u9EDE\u7167\u7247",
      "w-full h-48 object-cover",
      location.name || "\u672A\u547D\u540D\u5730\u9EDE"
    )}
          <div class="p-4 flex-grow">
            <h3 class="text-lg font-semibold mb-1 truncate" title="${location.name || "\u672A\u547D\u540D\u5730\u9EDE"}">${location.name || "\u672A\u547D\u540D\u5730\u9EDE"}</h3>
            <p class="text-sm text-gray-600 mb-2 truncate" title="${location.address || "\u7121\u5730\u5740\u8CC7\u8A0A"}">${location.address || "\u7121\u5730\u5740\u8CC7\u8A0A"}</p>
            <p class="text-xs text-gray-500 mb-3">\u985E\u578B: ${displayTypes}</p>
            ${location.editorial_summary ? `<p class="text-xs text-gray-600 mb-3 leading-tight max-h-12 overflow-hidden" title="${location.editorial_summary}">${location.editorial_summary}</p>` : ""}
            
            <!-- \u4E92\u52D5\u6309\u9215 -->
            <div class="flex justify-between items-center mt-auto pt-2">
              <div class="flex space-x-2">
                <button 
                  onclick="event.stopPropagation(); updateLocationStatus('${location.id}', 'visited')"
                  class="flex items-center space-x-1 px-3 py-1 rounded text-sm transition-colors ${location.user_location_status === "visited" ? "bg-green-500 text-white" : "bg-gray-200 text-gray-700 hover:bg-green-100"}"
                >
                  <span>\u2713</span>
                  <span>\u4F86\u904E</span>
                </button>
                <button 
                  onclick="event.stopPropagation(); updateLocationStatus('${location.id}', 'want_to_visit')"
                  class="flex items-center space-x-1 px-3 py-1 rounded text-sm transition-colors ${location.user_location_status === "want_to_visit" ? "bg-blue-500 text-white" : "bg-gray-200 text-gray-700 hover:bg-blue-100"}"
                >
                  <span>\u2764</span>
                  <span>\u60F3\u4F86</span>
                </button>
                <button 
                  onclick="event.stopPropagation(); updateLocationStatus('${location.id}', 'want_to_revisit')"
                  class="flex items-center space-x-1 px-3 py-1 rounded text-sm transition-colors ${location.user_location_status === "want_to_revisit" ? "bg-purple-500 text-white" : "bg-gray-200 text-gray-700 hover:bg-purple-100"}"
                >
                  <span>\u{1F504}</span>
                  <span>\u60F3\u518D\u4F86</span>
                </button>
              </div>
            </div>
          </div>
        </div>
        `;
  }).join("")}
    </div>
  `;
}
function getCategoryName(category) {
  const names = {
    "visited": "\u4F86\u904E",
    "want_to_visit": "\u60F3\u4F86",
    "want_to_revisit": "\u60F3\u518D\u4F86",
    "created": "\u5EFA\u7ACB"
  };
  return names[category] || category;
}
function createImageWithFallback(src, alt, className, locationName) {
  const defaultImage = "https://placehold.co/400x268/6B7280/FFFFFF?text=Location+Image";
  if (!src || src === "null" || src === "undefined") {
    return `<img 
      src="${defaultImage}" 
      alt="${alt || "\u5730\u9EDE\u7167\u7247"}" 
      class="${className}" 
      style="opacity: 1; transition: opacity 0.3s ease-in-out;"
    >`;
  }
  if (src.includes("placehold.co")) {
    return `<img 
      src="${src}" 
      alt="${alt || "\u5730\u9EDE\u7167\u7247"}" 
      class="${className}" 
      style="opacity: 1; transition: opacity 0.3s ease-in-out;"
    >`;
  }
  return `<img 
    src="${src}" 
    alt="${alt || "\u5730\u9EDE\u7167\u7247"}" 
    class="${className}" 
    onerror="this.onerror=null; this.src='${defaultImage}'; this.style.opacity='1';"
    onload="this.style.opacity='1'"
    style="opacity: 0; transition: opacity 0.3s ease-in-out;"
  >`;
}
function translatePlaceTypes(types) {
  if (!types || !Array.isArray(types))
    return "\u672A\u77E5\u985E\u578B";
  const typeTranslations = {
    "restaurant": "\u9910\u5EF3",
    "cafe": "\u5496\u5561\u5EF3",
    "bar": "\u9152\u5427",
    "bakery": "\u9EB5\u5305\u5E97",
    "food": "\u7F8E\u98DF",
    "lodging": "\u4F4F\u5BBF",
    "hotel": "\u98EF\u5E97",
    "tourist_attraction": "\u89C0\u5149\u666F\u9EDE",
    "museum": "\u535A\u7269\u9928",
    "park": "\u516C\u5712",
    "natural_feature": "\u81EA\u7136\u666F\u89C0",
    "establishment": "\u5834\u6240",
    "point_of_interest": "\u666F\u9EDE"
  };
  return types.map((type) => typeTranslations[type] || type).join(", ");
}

// src/pages/DesignPreview.js
init_layout();
async function renderDesignPreviewPage(request, env, session, user, nonce, cssContent) {
  console.log("[DesignPreview.js] renderDesignPreviewPage called");
  const content = `
        <div class="min-h-screen bg-gray-50">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h1 class="text-2xl font-bold text-gray-900 mb-4">\u8A2D\u8A08\u9810\u89BD</h1>
                    <p class="text-gray-600">\u8A2D\u8A08\u9810\u89BD\u529F\u80FD\u958B\u767C\u4E2D...</p>
                </div>
            </div>
        </div>
    `;
  return new Response(pageTemplate2({
    title: "\u8A2D\u8A08\u9810\u89BD",
    content,
    user,
    nonce,
    cssContent
  }), {
    headers: { "Content-Type": "text/html;charset=utf-8" }
  });
}

// src/pages/GamePage.js
init_layout();

// src/services/PenghuGameService.js
init_LocationService();
var PenghuGameService = class {
  constructor(db) {
    this.db = db;
    this.locationService = new LocationService(db);
  }
  // 獲取用戶遊戲統計
  async getUserGameStats(userId) {
    try {
      const result = await this.db.prepare(`
                SELECT 
                    game_level,
                    game_points,
                    memory_count,
                    reply_count,
                    task_completed_count,
                    visit_count,
                    game_role,
                    created_at,
                    updated_at
                FROM user_game_stats 
                WHERE user_id = ?
            `).bind(userId).first();
      if (!result) {
        await this.createUserGameStats(userId);
        return await this.getUserGameStats(userId);
      }
      return result;
    } catch (error) {
      console.error("Error getting user game stats:", error);
      throw error;
    }
  }
  // 創建用戶遊戲統計
  async createUserGameStats(userId) {
    try {
      await this.db.prepare(`
                INSERT INTO user_game_stats (
                    user_id, game_level, game_points, memory_count, 
                    reply_count, task_completed_count, visit_count, game_role
                ) VALUES (?, 1, 0, 0, 0, 0, 0, 'visitor')
            `).bind(userId).run();
    } catch (error) {
      console.error("Error creating user game stats:", error);
      throw error;
    }
  }
  // 更新遊戲統計
  async updateGameStats(userId, updates) {
    try {
      const { points = 0, level = 0, memoryCount = 0, replyCount = 0, taskCompletedCount = 0, visitCount = 0 } = updates;
      await this.db.prepare(`
                UPDATE user_game_stats 
                SET 
                    game_level = game_level + ?,
                    game_points = game_points + ?,
                    memory_count = memory_count + ?,
                    reply_count = reply_count + ?,
                    task_completed_count = task_completed_count + ?,
                    visit_count = visit_count + ?,
                    updated_at = datetime('now')
                WHERE user_id = ?
            `).bind(level, points, memoryCount, replyCount, taskCompletedCount, visitCount, userId).run();
      const newLevel = await this.checkLevelUp(userId);
      return { newLevel, points, memoryCount, replyCount, taskCompletedCount, visitCount };
    } catch (error) {
      console.error("Error updating game stats:", error);
      throw error;
    }
  }
  // 檢查升級
  async checkLevelUp(userId) {
    try {
      const stats = await this.getUserGameStats(userId);
      const newLevel = Math.floor(stats.game_points / 100) + 1;
      if (newLevel > stats.game_level) {
        await this.db.prepare(`
                    UPDATE user_game_stats 
                    SET game_level = ?, updated_at = datetime('now')
                    WHERE user_id = ?
                `).bind(newLevel, userId).run();
        await this.checkBadges(userId);
        return newLevel;
      }
      return stats.game_level;
    } catch (error) {
      console.error("Error checking level up:", error);
      throw error;
    }
  }
  // 檢查勳章
  async checkBadges(userId) {
    try {
      const stats = await this.getUserGameStats(userId);
      const badges = await this.db.prepare(`
                SELECT * FROM game_badges
            `).all();
      for (const badge of badges.results) {
        const requirements = JSON.parse(badge.requirements);
        let earned = true;
        for (const [key, value] of Object.entries(requirements)) {
          if (stats[key] < value) {
            earned = false;
            break;
          }
        }
        if (earned) {
          const existing = await this.db.prepare(`
                        SELECT * FROM user_badges 
                        WHERE user_id = ? AND badge_id = ?
                    `).bind(userId, badge.id).first();
          if (!existing) {
            await this.db.prepare(`
                            INSERT INTO user_badges (user_id, badge_id, earned_at)
                            VALUES (?, ?, datetime('now'))
                        `).bind(userId, badge.id).run();
          }
        }
      }
    } catch (error) {
      console.error("Error checking badges:", error);
      throw error;
    }
  }
  // 創建記憶膠囊
  async createMemoryCapsule(userId, locationId, title, content, photoUrl, capsuleType = "memory") {
    try {
      const result = await this.db.prepare(`
                INSERT INTO memory_capsules (
                    user_id, location_id, title, content, photo_url, capsule_type, created_at
                ) VALUES (?, ?, ?, ?, ?, ?, datetime('now'))
            `).bind(userId, locationId, title, content, photoUrl, capsuleType).run();
      await this.updateGameStats(userId, {
        points: 10,
        memoryCount: 1
      });
      await this.checkTasks(userId, "memory_capsule");
      return result;
    } catch (error) {
      console.error("Error creating memory capsule:", error);
      throw error;
    }
  }
  // 獲取用戶記憶膠囊
  async getUserMemoryCapsules(userId, limit = 10) {
    try {
      const result = await this.db.prepare(`
                SELECT 
                    mc.*,
                    l.name as location_name,
                    l.latitude,
                    l.longitude,
                    l.category
                FROM memory_capsules mc
                LEFT JOIN locations l ON mc.location_id = l.id
                WHERE mc.user_id = ?
                ORDER BY mc.created_at DESC
                LIMIT ?
            `).bind(userId, limit).all();
      return result.results;
    } catch (error) {
      console.error("Error getting user memory capsules:", error);
      throw error;
    }
  }
  // 獲取所有記憶膠囊（用於探索）
  async getAllMemoryCapsules(limit = 20) {
    try {
      const result = await this.db.prepare(`
                SELECT 
                    mc.*,
                    l.name as location_name,
                    l.latitude,
                    l.longitude,
                    l.category,
                    u.name as user_name,
                    u.game_role
                FROM memory_capsules mc
                LEFT JOIN locations l ON mc.location_id = l.id
                LEFT JOIN users u ON mc.user_id = u.id
                ORDER BY mc.created_at DESC
                LIMIT ?
            `).bind(limit).all();
      return result.results;
    } catch (error) {
      console.error("Error getting all memory capsules:", error);
      throw error;
    }
  }
  // 回覆記憶膠囊
  async replyToMemoryCapsule(userId, capsuleId, replyContent) {
    try {
      const capsule = await this.db.prepare(`
                SELECT * FROM memory_capsules WHERE id = ?
            `).bind(capsuleId).first();
      if (!capsule) {
        throw new Error("Memory capsule not found");
      }
      const result = await this.db.prepare(`
                INSERT INTO merchant_replies (
                    memory_capsule_id, user_id, reply_content, created_at
                ) VALUES (?, ?, ?, datetime('now'))
            `).bind(capsuleId, userId, replyContent).run();
      await this.updateGameStats(userId, {
        points: 15,
        replyCount: 1
      });
      await this.checkTasks(userId, "reply_memory");
      return result;
    } catch (error) {
      console.error("Error replying to memory capsule:", error);
      throw error;
    }
  }
  // 檢查任務完成
  async checkTasks(userId, taskType) {
    try {
      const tasks = await this.db.prepare(`
                SELECT * FROM game_tasks WHERE task_type = ?
            `).bind(taskType).all();
      for (const task of tasks.results) {
        const requirements = JSON.parse(task.requirements);
        const stats = await this.getUserGameStats(userId);
        let completed = true;
        for (const [key, value] of Object.entries(requirements)) {
          if (stats[key] < value) {
            completed = false;
            break;
          }
        }
        if (completed) {
          const existing = await this.db.prepare(`
                        SELECT * FROM user_tasks 
                        WHERE user_id = ? AND task_id = ?
                    `).bind(userId, task.id).first();
          if (!existing) {
            await this.db.prepare(`
                            INSERT INTO user_tasks (user_id, task_id, completed_at)
                            VALUES (?, ?, datetime('now'))
                        `).bind(userId, task.id).run();
            await this.updateGameStats(userId, {
              points: task.points_reward,
              taskCompletedCount: 1
            });
          }
        }
      }
    } catch (error) {
      console.error("Error checking tasks:", error);
      throw error;
    }
  }
  // 獲取排行榜
  async getLeaderboard(limit = 10) {
    try {
      const result = await this.db.prepare(`
                SELECT 
                    ugs.*,
                    u.name as user_name,
                    u.email
                FROM user_game_stats ugs
                LEFT JOIN users u ON ugs.user_id = u.id
                ORDER BY ugs.game_points DESC, ugs.game_level DESC
                LIMIT ?
            `).bind(limit).all();
      return result.results;
    } catch (error) {
      console.error("Error getting leaderboard:", error);
      throw error;
    }
  }
  // 獲取用戶任務
  async getUserTasks(userId) {
    try {
      const result = await this.db.prepare(`
                SELECT 
                    gt.*,
                    ut.completed_at,
                    CASE WHEN ut.id IS NOT NULL THEN 1 ELSE 0 END as completed
                FROM game_tasks gt
                LEFT JOIN user_tasks ut ON gt.id = ut.task_id AND ut.user_id = ?
                ORDER BY gt.points_reward DESC
            `).bind(userId).all();
      return result.results;
    } catch (error) {
      console.error("Error getting user tasks:", error);
      throw error;
    }
  }
  // 獲取用戶勳章
  async getUserBadges(userId) {
    try {
      const result = await this.db.prepare(`
                SELECT 
                    gb.*,
                    ub.earned_at
                FROM game_badges gb
                LEFT JOIN user_badges ub ON gb.id = ub.badge_id AND ub.user_id = ?
                ORDER BY ub.earned_at DESC
            `).bind(userId).all();
      return result.results;
    } catch (error) {
      console.error("Error getting user badges:", error);
      throw error;
    }
  }
  // 獲取澎湖文化數據
  async getCulturalData(locationId = null) {
    try {
      let query = `
                SELECT 
                    cd.*,
                    l.name as location_name
                FROM cultural_data cd
                LEFT JOIN locations l ON cd.location_id = l.id
            `;
      let params = [];
      if (locationId) {
        query += " WHERE cd.location_id = ?";
        params.push(locationId);
      }
      query += " ORDER BY cd.created_at DESC";
      const result = await this.db.prepare(query).bind(...params).all();
      return result.results;
    } catch (error) {
      console.error("Error getting cultural data:", error);
      throw error;
    }
  }
  // 獲取澎湖地點
  async getPenghuLocations() {
    try {
      const result = await this.db.prepare(`
                SELECT * FROM locations 
                ORDER BY created_at DESC
            `).all();
      return result.results;
    } catch (error) {
      console.error("Error getting Penghu locations:", error);
      throw error;
    }
  }
};

// src/pages/GamePage.js
async function renderPenghuGamePage(request, env, session, user, nonce, cssContent) {
  if (!user) {
    return Response.redirect(new URL(request.url).origin + "/login", 302);
  }
  const gameService = new PenghuGameService(env.DB);
  let userStats = null;
  let userCapsules = [];
  let allCapsules = [];
  let locations = [];
  let tasks = [];
  let badges = [];
  let leaderboard = [];
  try {
    userStats = await gameService.getUserGameStats(user.id);
  } catch (error) {
    console.error("[PenghuGamePage.js] Error getting user game stats:", error);
  }
  try {
    userCapsules = await gameService.getUserMemoryCapsules(user.id, 10);
  } catch (error) {
    console.error("[PenghuGamePage.js] Error getting user capsules:", error);
  }
  try {
    allCapsules = await gameService.getAllMemoryCapsules(20);
  } catch (error) {
    console.error("[PenghuGamePage.js] Error getting all capsules:", error);
  }
  try {
    locations = await gameService.getPenghuLocations();
  } catch (error) {
    console.error("[PenghuGamePage.js] Error getting locations:", error);
  }
  try {
    tasks = await gameService.getUserTasks(user.id);
  } catch (error) {
    console.error("[PenghuGamePage.js] Error getting tasks:", error);
  }
  try {
    badges = await gameService.getUserBadges(user.id);
  } catch (error) {
    console.error("[PenghuGamePage.js] Error getting badges:", error);
  }
  try {
    leaderboard = await gameService.getLeaderboard(10);
  } catch (error) {
    console.error("[PenghuGamePage.js] Error getting leaderboard:", error);
  }
  const content = `
        <div class="min-h-screen bg-gradient-to-br from-blue-50 to-green-50">
            <!-- \u9801\u9762\u6A19\u984C -->
            <div class="bg-white shadow-sm border-b">
                <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <h1 class="text-3xl font-bold text-gray-900">\u{1F3DD}\uFE0F \u6F8E\u6E56\u6642\u5149\u5CF6\u4E3B</h1>
                            <p class="mt-2 text-gray-600">\u6536\u96C6\u8A18\u61B6\uFF0C\u5206\u4EAB\u6545\u4E8B\uFF0C\u6210\u70BA\u6F8E\u6E56\u7684\u6642\u5149\u5CF6\u4E3B</p>
                        </div>
                        <div class="flex items-center space-x-4">
                            <div class="text-right">
                                <div class="text-sm text-gray-500">\u6B61\u8FCE\u56DE\u4F86</div>
                                <div class="font-semibold text-gray-900">${user.name || "\u73A9\u5BB6"}</div>
                            </div>
                            <button onclick="showCreateCapsuleForm()" class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition-colors">
                                \u{1F4E6} \u5275\u5EFA\u8A18\u61B6\u81A0\u56CA
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- \u904A\u6232\u7D71\u8A08\u9762\u677F -->
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
                    <div class="bg-white rounded-lg shadow-md p-6 text-center">
                        <div class="text-3xl font-bold text-blue-600">${(userStats == null ? void 0 : userStats.game_level) || 1}</div>
                        <div class="text-sm text-gray-500">\u7B49\u7D1A</div>
                    </div>
                    <div class="bg-white rounded-lg shadow-md p-6 text-center">
                        <div class="text-3xl font-bold text-green-600">${(userStats == null ? void 0 : userStats.game_points) || 0}</div>
                        <div class="text-sm text-gray-500">\u9EDE\u6578</div>
                    </div>
                    <div class="bg-white rounded-lg shadow-md p-6 text-center">
                        <div class="text-3xl font-bold text-purple-600">${(userStats == null ? void 0 : userStats.memory_count) || 0}</div>
                        <div class="text-sm text-gray-500">\u8A18\u61B6\u81A0\u56CA</div>
                    </div>
                    <div class="bg-white rounded-lg shadow-md p-6 text-center">
                        <div class="text-3xl font-bold text-orange-600">${(userStats == null ? void 0 : userStats.visit_count) || 0}</div>
                        <div class="text-sm text-gray-500">\u8A2A\u554F\u6B21\u6578</div>
                    </div>
                </div>

                <!-- \u6A19\u7C64\u9801\u5C0E\u822A -->
                <div class="bg-white rounded-lg shadow-md mb-6">
                    <div class="border-b border-gray-200">
                        <nav class="-mb-px flex space-x-8 px-6">
                            <button id="tab-capsules" onclick="switchTab('capsules')" class="border-b-2 border-blue-500 text-blue-600 py-4 px-1 text-sm font-medium">
                                \u{1F4E6} \u6211\u7684\u8A18\u61B6\u81A0\u56CA
                            </button>
                            <button id="tab-explore" onclick="switchTab('explore')" class="border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 py-4 px-1 text-sm font-medium">
                                \u{1F50D} \u63A2\u7D22\u8A18\u61B6
                            </button>
                            <button id="tab-tasks" onclick="switchTab('tasks')" class="border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 py-4 px-1 text-sm font-medium">
                                \u{1F3AF} \u4EFB\u52D9\u5217\u8868
                            </button>
                            <button id="tab-badges" onclick="switchTab('badges')" class="border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 py-4 px-1 text-sm font-medium">
                                \u{1F3C6} \u52F3\u7AE0\u6536\u85CF
                            </button>
                            <button id="tab-leaderboard" onclick="switchTab('leaderboard')" class="border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 py-4 px-1 text-sm font-medium">
                                \u{1F3C5} \u6392\u884C\u699C
                            </button>
                        </nav>
                    </div>
                </div>

                <!-- \u5167\u5BB9\u5340\u57DF -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <div class="lg:col-span-2">
                        <!-- \u6211\u7684\u8A18\u61B6\u81A0\u56CA -->
                        <div id="content-capsules">
                            <div class="flex items-center justify-between mb-6">
                                <h2 class="text-2xl font-bold text-gray-900">\u6211\u7684\u8A18\u61B6\u81A0\u56CA</h2>
                                <span class="text-gray-500">${userCapsules.length} \u500B\u81A0\u56CA</span>
                            </div>
                            <div id="capsules-list" class="space-y-4">
                                ${userCapsules.length > 0 ? userCapsules.map((capsule) => {
    var _a;
    return `
                                        <div class="bg-white rounded-lg shadow-md p-6 mb-4 border-l-4 border-blue-500">
                                            <div class="flex items-start justify-between mb-4">
                                                <div class="flex items-center space-x-3">
                                                    <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center">
                                                        <span class="text-blue-600 font-bold text-sm">${((_a = user.name) == null ? void 0 : _a.charAt(0)) || "U"}</span>
                                                    </div>
                                                    <div>
                                                        <h3 class="font-semibold text-gray-900">${capsule.title}</h3>
                                                        <p class="text-sm text-gray-500">
                                                            ${user.name} \u2022 ${new Date(capsule.created_at).toLocaleDateString()}
                                                        </p>
                                                        <p class="text-sm text-blue-600">\u{1F4CD} ${capsule.location_name || "\u672A\u77E5\u5730\u9EDE"}</p>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="mb-4">
                                                <p class="text-gray-700 mb-3">${capsule.content || ""}</p>
                                                ${capsule.photo_url ? `<img src="${capsule.photo_url}" alt="${capsule.title}" class="w-full h-48 object-cover rounded-lg">` : ""}
                                            </div>
                                        </div>
                                    `;
  }).join("") : `<div class="bg-white rounded-lg shadow-md p-12 text-center">
                                        <div class="text-6xl mb-4">\u{1F4E6}</div>
                                        <h3 class="text-lg font-medium text-gray-900 mb-2">\u9084\u6C92\u6709\u8A18\u61B6\u81A0\u56CA</h3>
                                        <p class="text-gray-500 mb-6">\u958B\u59CB\u6536\u96C6\u4F60\u5728\u6F8E\u6E56\u7684\u7F8E\u597D\u56DE\u61B6\u5427\uFF01</p>
                                        <button onclick="showCreateCapsuleForm()" class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition-colors">
                                            \u5275\u5EFA\u7B2C\u4E00\u500B\u8A18\u61B6\u81A0\u56CA
                                        </button>
                                    </div>`}
                            </div>
                        </div>

                        <!-- \u63A2\u7D22\u8A18\u61B6 -->
                        <div id="content-explore" class="hidden">
                            <h2 class="text-2xl font-bold text-gray-900 mb-6">\u63A2\u7D22\u8A18\u61B6</h2>
                            <div class="space-y-4">
                                ${allCapsules.length > 0 ? allCapsules.map((capsule) => {
    var _a;
    return `
                                        <div class="bg-white rounded-lg shadow-md p-6 mb-4 border-l-4 border-green-500">
                                            <div class="flex items-start justify-between mb-4">
                                                <div class="flex items-center space-x-3">
                                                    <div class="w-10 h-10 bg-green-100 rounded-full flex items-center justify-center">
                                                        <span class="text-green-600 font-bold text-sm">${((_a = capsule.user_name) == null ? void 0 : _a.charAt(0)) || "U"}</span>
                                                    </div>
                                                    <div>
                                                        <h3 class="font-semibold text-gray-900">${capsule.title}</h3>
                                                        <p class="text-sm text-gray-500">
                                                            ${capsule.user_name || "\u533F\u540D"} \u2022 ${new Date(capsule.created_at).toLocaleDateString()}
                                                        </p>
                                                        <p class="text-sm text-green-600">\u{1F4CD} ${capsule.location_name || "\u672A\u77E5\u5730\u9EDE"}</p>
                                                        <span class="inline-block px-2 py-1 text-xs rounded-full ${capsule.game_role === "visitor" ? "bg-blue-100 text-blue-800" : capsule.game_role === "merchant" ? "bg-green-100 text-green-800" : "bg-purple-100 text-purple-800"}">
                                                            ${capsule.game_role === "visitor" ? "\u6E38\u5BA2" : capsule.game_role === "merchant" ? "\u5E97\u5BB6" : "\u5728\u5730\u4EBA"}
                                                        </span>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="mb-4">
                                                <p class="text-gray-700 mb-3">${capsule.content || ""}</p>
                                                ${capsule.photo_url ? `<img src="${capsule.photo_url}" alt="${capsule.title}" class="w-full h-48 object-cover rounded-lg">` : ""}
                                            </div>
                                            <div class="flex justify-end">
                                                <button onclick="showReplyForm(${capsule.id})" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors text-sm">
                                                    \u{1F4AC} \u56DE\u8986
                                                </button>
                                            </div>
                                        </div>
                                    `;
  }).join("") : `<div class="bg-white rounded-lg shadow-md p-12 text-center">
                                        <div class="text-6xl mb-4">\u{1F50D}</div>
                                        <h3 class="text-lg font-medium text-gray-900 mb-2">\u9084\u6C92\u6709\u8A18\u61B6\u81A0\u56CA</h3>
                                        <p class="text-gray-500">\u7B49\u5F85\u5176\u4ED6\u73A9\u5BB6\u5206\u4EAB\u4ED6\u5011\u7684\u6F8E\u6E56\u8A18\u61B6...</p>
                                    </div>`}
                            </div>
                        </div>

                        <!-- \u4EFB\u52D9\u5217\u8868 -->
                        <div id="content-tasks" class="hidden">
                            <h2 class="text-2xl font-bold text-gray-900 mb-6">\u4EFB\u52D9\u5217\u8868</h2>
                            <div class="space-y-4">
                                ${tasks.length > 0 ? tasks.map((task) => `
                                        <div class="bg-white rounded-lg shadow-md p-6 border-l-4 ${task.completed ? "border-green-500" : "border-yellow-500"}">
                                            <div class="flex items-center justify-between">
                                                <div class="flex-1">
                                                    <h3 class="font-semibold text-gray-900">${task.title}</h3>
                                                    <p class="text-gray-600 text-sm mt-1">${task.description}</p>
                                                    <div class="flex items-center mt-2">
                                                        <span class="text-sm text-gray-500">\u734E\u52F5: ${task.points_reward} \u9EDE\u6578</span>
                                                        ${task.completed ? '<span class="ml-4 text-sm text-green-600">\u2705 \u5DF2\u5B8C\u6210</span>' : '<span class="ml-4 text-sm text-yellow-600">\u23F3 \u9032\u884C\u4E2D</span>'}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    `).join("") : `<div class="bg-white rounded-lg shadow-md p-12 text-center">
                                        <div class="text-6xl mb-4">\u{1F3AF}</div>
                                        <h3 class="text-lg font-medium text-gray-900 mb-2">\u6C92\u6709\u4EFB\u52D9</h3>
                                        <p class="text-gray-500">\u4EFB\u52D9\u529F\u80FD\u958B\u767C\u4E2D...</p>
                                    </div>`}
                            </div>
                        </div>

                        <!-- \u52F3\u7AE0\u6536\u85CF -->
                        <div id="content-badges" class="hidden">
                            <h2 class="text-2xl font-bold text-gray-900 mb-6">\u52F3\u7AE0\u6536\u85CF</h2>
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                ${badges.length > 0 ? badges.map((badge) => `
                                        <div class="bg-white rounded-lg shadow-md p-6 text-center ${badge.earned_at ? "border-2 border-yellow-400" : "opacity-50"}">
                                            <div class="text-4xl mb-2">${badge.icon}</div>
                                            <h3 class="font-semibold text-gray-900">${badge.name}</h3>
                                            <p class="text-gray-600 text-sm mt-1">${badge.description}</p>
                                            ${badge.earned_at ? `<p class="text-green-600 text-xs mt-2">\u2705 \u5DF2\u7372\u5F97</p>` : `<p class="text-gray-500 text-xs mt-2">\u23F3 \u672A\u7372\u5F97</p>`}
                                        </div>
                                    `).join("") : `<div class="bg-white rounded-lg shadow-md p-12 text-center col-span-full">
                                        <div class="text-6xl mb-4">\u{1F3C6}</div>
                                        <h3 class="text-lg font-medium text-gray-900 mb-2">\u6C92\u6709\u52F3\u7AE0</h3>
                                        <p class="text-gray-500">\u52F3\u7AE0\u529F\u80FD\u958B\u767C\u4E2D...</p>
                                    </div>`}
                            </div>
                        </div>

                        <!-- \u6392\u884C\u699C -->
                        <div id="content-leaderboard" class="hidden">
                            <h2 class="text-2xl font-bold text-gray-900 mb-6">\u6392\u884C\u699C</h2>
                            <div class="bg-white rounded-lg shadow-md overflow-hidden">
                                <div class="px-6 py-4 bg-gray-50 border-b">
                                    <h3 class="text-lg font-semibold text-gray-900">\u6642\u5149\u5CF6\u4E3B\u6392\u884C\u699C</h3>
                                </div>
                                <div class="divide-y divide-gray-200">
                                    ${leaderboard.length > 0 ? leaderboard.map((player, index) => `
                                            <div class="px-6 py-4 flex items-center justify-between">
                                                <div class="flex items-center space-x-4">
                                                    <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center">
                                                        <span class="text-blue-600 font-bold text-sm">${index + 1}</span>
                                                    </div>
                                                    <div>
                                                        <h4 class="font-semibold text-gray-900">${player.user_name || "\u533F\u540D\u73A9\u5BB6"}</h4>
                                                        <p class="text-sm text-gray-500">\u7B49\u7D1A ${player.game_level} \u2022 ${player.game_points} \u9EDE\u6578</p>
                                                    </div>
                                                </div>
                                                <div class="text-right">
                                                    <span class="px-3 py-1 text-sm rounded-full ${player.game_role === "visitor" ? "bg-blue-100 text-blue-800" : player.game_role === "merchant" ? "bg-green-100 text-green-800" : "bg-purple-100 text-purple-800"}">
                                                        ${player.game_role === "visitor" ? "\u6E38\u5BA2" : player.game_role === "merchant" ? "\u5E97\u5BB6" : "\u5728\u5730\u4EBA"}
                                                    </span>
                                                </div>
                                            </div>
                                        `).join("") : `<div class="px-6 py-12 text-center">
                                            <div class="text-6xl mb-4">\u{1F3C5}</div>
                                            <h3 class="text-lg font-medium text-gray-900 mb-2">\u6392\u884C\u699C\u7A7A</h3>
                                            <p class="text-gray-500">\u7B49\u5F85\u73A9\u5BB6\u52A0\u5165\u904A\u6232...</p>
                                        </div>`}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- \u5074\u908A\u6B04 -->
                    <div class="space-y-6">
                        <!-- \u5FEB\u901F\u7D71\u8A08 -->
                        <div class="bg-white rounded-lg shadow-md p-6">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4">\u5FEB\u901F\u7D71\u8A08</h3>
                            <div class="space-y-3">
                                <div class="flex justify-between">
                                    <span class="text-gray-600">\u8A18\u61B6\u81A0\u56CA</span>
                                    <span class="font-medium">${(userStats == null ? void 0 : userStats.memory_count) || 0}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">\u7B49\u7D1A</span>
                                    <span class="font-medium">${(userStats == null ? void 0 : userStats.game_level) || 1}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">\u9EDE\u6578</span>
                                    <span class="font-medium">${(userStats == null ? void 0 : userStats.game_points) || 0}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">\u56DE\u8986\u6578</span>
                                    <span class="font-medium">${(userStats == null ? void 0 : userStats.reply_count) || 0}</span>
                                </div>
                            </div>
                        </div>

                        <!-- \u89D2\u8272\u9078\u64C7 -->
                        <div class="bg-white rounded-lg shadow-md p-6">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4">\u9078\u64C7\u89D2\u8272</h3>
                            <div class="space-y-2">
                                <button onclick="updateRole('visitor')" class="w-full text-left px-3 py-2 rounded-lg hover:bg-blue-50 ${(userStats == null ? void 0 : userStats.game_role) === "visitor" ? "bg-blue-100 text-blue-800" : "text-gray-700"}">
                                    \u{1F9F3} \u6E38\u5BA2
                                </button>
                                <button onclick="updateRole('merchant')" class="w-full text-left px-3 py-2 rounded-lg hover:bg-green-50 ${(userStats == null ? void 0 : userStats.game_role) === "merchant" ? "bg-green-100 text-green-800" : "text-gray-700"}">
                                    \u{1F3EA} \u5E97\u5BB6
                                </button>
                                <button onclick="updateRole('local')" class="w-full text-left px-3 py-2 rounded-lg hover:bg-purple-50 ${(userStats == null ? void 0 : userStats.game_role) === "local" ? "bg-purple-100 text-purple-800" : "text-gray-700"}">
                                    \u{1F468}\u200D\u{1F33E} \u5728\u5730\u4EBA
                                </button>
                            </div>
                        </div>

                        <!-- \u904A\u6232\u63D0\u793A -->
                        <div class="bg-blue-50 rounded-lg p-6">
                            <h3 class="text-lg font-semibold text-blue-900 mb-3">\u{1F3AE} \u904A\u6232\u63D0\u793A</h3>
                            <div class="space-y-2 text-sm text-blue-800">
                                <p>\u2022 \u4E0A\u50B3\u8A18\u61B6\u81A0\u56CA\u7372\u5F97\u9EDE\u6578</p>
                                <p>\u2022 \u5E97\u5BB6\u56DE\u8986\u904A\u5BA2\u8A18\u61B6\u7372\u5F97\u984D\u5916\u734E\u52F5</p>
                                <p>\u2022 \u5B8C\u6210\u4EFB\u52D9\u89E3\u9396\u52F3\u7AE0</p>
                                <p>\u2022 \u9054\u523010\u7D1A\u6210\u70BA\u6642\u5149\u5CF6\u4E3B</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- \u5275\u5EFA\u8A18\u61B6\u81A0\u56CA\u6A21\u614B\u6846 -->
            <div id="create-capsule-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50">
                <div class="bg-white rounded-lg max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                    <div class="p-6">
                        <div class="flex items-center justify-between mb-6">
                            <h3 class="text-xl font-semibold text-gray-900">\u5275\u5EFA\u8A18\u61B6\u81A0\u56CA</h3>
                            <button onclick="hideCreateCapsuleForm()" class="text-gray-400 hover:text-gray-600">\u2715</button>
                        </div>
                        <form id="create-capsule-form" onsubmit="handleCreateCapsule(event)" class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">\u5730\u9EDE *</label>
                                <select name="location_id" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                    <option value="">\u9078\u64C7\u5730\u9EDE</option>
                                    ${locations.map((location) => `
                                        <option value="${location.id}">${location.name}</option>
                                    `).join("")}
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">\u6A19\u984C *</label>
                                <input type="text" name="title" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="\u70BA\u4F60\u7684\u8A18\u61B6\u8D77\u500B\u6A19\u984C">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">\u5167\u5BB9</label>
                                <textarea name="content" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none" rows="4" placeholder="\u5206\u4EAB\u4F60\u5728\u9019\u500B\u5730\u9EDE\u7684\u6545\u4E8B..."></textarea>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">\u7167\u7247URL</label>
                                <input type="url" name="photo_url" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="https://example.com/photo.jpg">
                            </div>
                            <div class="flex justify-end space-x-3 pt-4">
                                <button type="button" onclick="hideCreateCapsuleForm()" class="px-6 py-3 text-gray-600 hover:text-gray-800">\u53D6\u6D88</button>
                                <button type="submit" class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">\u5275\u5EFA\u81A0\u56CA</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- \u56DE\u8986\u6A21\u614B\u6846 -->
            <div id="reply-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50">
                <div class="bg-white rounded-lg max-w-lg w-full">
                    <div class="p-6">
                        <div class="flex items-center justify-between mb-6">
                            <h3 class="text-xl font-semibold text-gray-900">\u56DE\u8986\u8A18\u61B6\u81A0\u56CA</h3>
                            <button onclick="hideReplyForm()" class="text-gray-400 hover:text-gray-600">\u2715</button>
                        </div>
                        <form id="reply-form" onsubmit="handleReply(event)" class="space-y-4">
                            <input type="hidden" id="reply-capsule-id" name="capsule_id">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">\u56DE\u8986\u5167\u5BB9 *</label>
                                <textarea name="reply_content" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent resize-none" rows="4" placeholder="\u5206\u4EAB\u4F60\u7684\u60F3\u6CD5\u6216\u5EFA\u8B70..."></textarea>
                            </div>
                            <div class="flex justify-end space-x-3 pt-4">
                                <button type="button" onclick="hideReplyForm()" class="px-6 py-3 text-gray-600 hover:text-gray-800">\u53D6\u6D88</button>
                                <button type="submit" class="px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">\u767C\u9001\u56DE\u8986</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <script nonce="${nonce}">
            let currentTab = 'capsules';
            
            function switchTab(tabName) {
                document.querySelectorAll('[id^="content-"]').forEach(el => el.classList.add('hidden'));
                document.querySelectorAll('[id^="tab-"]').forEach(el => {
                    el.classList.remove('border-blue-500', 'text-blue-600');
                    el.classList.add('border-transparent', 'text-gray-500');
                });
                
                document.getElementById('content-' + tabName).classList.remove('hidden');
                const tabButton = document.getElementById('tab-' + tabName);
                tabButton.classList.remove('border-transparent', 'text-gray-500');
                tabButton.classList.add('border-blue-500', 'text-blue-600');
                
                currentTab = tabName;
            }
            
            function showCreateCapsuleForm() {
                document.getElementById('create-capsule-modal').classList.remove('hidden');
                document.getElementById('create-capsule-modal').classList.add('flex');
            }
            
            function hideCreateCapsuleForm() {
                document.getElementById('create-capsule-modal').classList.add('hidden');
                document.getElementById('create-capsule-modal').classList.remove('flex');
                document.getElementById('create-capsule-form').reset();
            }
            
            function showReplyForm(capsuleId) {
                document.getElementById('reply-capsule-id').value = capsuleId;
                document.getElementById('reply-modal').classList.remove('hidden');
                document.getElementById('reply-modal').classList.add('flex');
            }
            
            function hideReplyForm() {
                document.getElementById('reply-modal').classList.add('hidden');
                document.getElementById('reply-modal').classList.remove('flex');
                document.getElementById('reply-form').reset();
            }
            
            async function handleCreateCapsule(event) {
                event.preventDefault();
                
                const formData = new FormData(event.target);
                const data = {
                    location_id: formData.get('location_id'),
                    title: formData.get('title'),
                    content: formData.get('content'),
                    photo_url: formData.get('photo_url'),
                    capsule_type: 'memory'
                };
                
                try {
                    const response = await fetch('/api/penghu-game/memory-capsules', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(data)
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        if (window.showToast) window.showToast(result.message || '\u8A18\u61B6\u81A0\u56CA\u5275\u5EFA\u6210\u529F\uFF01', 'success');
                        else alert(result.message || '\u8A18\u61B6\u81A0\u56CA\u5275\u5EFA\u6210\u529F\uFF01');
                        hideCreateCapsuleForm();
                        setTimeout(() => window.location.reload(), 1000);
                    } else {
                        const error = await response.json();
                        if (window.showToast) window.showToast('\u5275\u5EFA\u5931\u6557: ' + (error.error || '\u672A\u77E5\u932F\u8AA4'), 'error');
                        else alert('\u5275\u5EFA\u5931\u6557: ' + (error.error || '\u672A\u77E5\u932F\u8AA4'));
                    }
                } catch (error) {
                    console.error('\u5275\u5EFA\u8A18\u61B6\u81A0\u56CA\u5931\u6557:', error);
                    if (window.showToast) window.showToast('\u5275\u5EFA\u5931\u6557: ' + error.message, 'error');
                    else alert('\u5275\u5EFA\u5931\u6557: ' + error.message);
                }
            }
            
            async function handleReply(event) {
                event.preventDefault();
                
                const formData = new FormData(event.target);
                const capsuleId = formData.get('capsule_id');
                const data = {
                    reply_content: formData.get('reply_content')
                };
                
                try {
                    const response = await fetch(\`/api/penghu-game/memory-capsules/\${capsuleId}/reply\`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(data)
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        if (window.showToast) window.showToast(result.message || '\u56DE\u8986\u6210\u529F\uFF01', 'success');
                        else alert(result.message || '\u56DE\u8986\u6210\u529F\uFF01');
                        hideReplyForm();
                        setTimeout(() => window.location.reload(), 1000);
                    } else {
                        const error = await response.json();
                        if (window.showToast) window.showToast('\u56DE\u8986\u5931\u6557: ' + (error.error || '\u672A\u77E5\u932F\u8AA4'), 'error');
                        else alert('\u56DE\u8986\u5931\u6557: ' + (error.error || '\u672A\u77E5\u932F\u8AA4'));
                    }
                } catch (error) {
                    console.error('\u56DE\u8986\u5931\u6557:', error);
                    if (window.showToast) window.showToast('\u56DE\u8986\u5931\u6557: ' + error.message, 'error');
                    else alert('\u56DE\u8986\u5931\u6557: ' + error.message);
                }
            }
            
            async function updateRole(role) {
                try {
                    const response = await fetch('/api/penghu-game/role', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ role })
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        if (window.showToast) window.showToast(result.message || '\u89D2\u8272\u66F4\u65B0\u6210\u529F\uFF01', 'success');
                        else alert(result.message || '\u89D2\u8272\u66F4\u65B0\u6210\u529F\uFF01');
                        setTimeout(() => window.location.reload(), 1000);
                    } else {
                        const error = await response.json();
                        if (window.showToast) window.showToast('\u89D2\u8272\u66F4\u65B0\u5931\u6557: ' + (error.error || '\u672A\u77E5\u932F\u8AA4'), 'error');
                        else alert('\u89D2\u8272\u66F4\u65B0\u5931\u6557: ' + (error.error || '\u672A\u77E5\u932F\u8AA4'));
                    }
                } catch (error) {
                    console.error('\u89D2\u8272\u66F4\u65B0\u5931\u6557:', error);
                    if (window.showToast) window.showToast('\u89D2\u8272\u66F4\u65B0\u5931\u6557: ' + error.message, 'error');
                    else alert('\u89D2\u8272\u66F4\u65B0\u5931\u6557: ' + error.message);
                }
            }
        </script>
    `;
  return new Response(pageTemplate2({
    title: "\u6F8E\u6E56\u6642\u5149\u5CF6\u4E3B - \u904A\u6232",
    content,
    user,
    nonce,
    cssContent
  }), {
    headers: { "Content-Type": "text/html;charset=utf-8" }
  });
}

// src/pages/SimpleTestPage.js
init_layout();
async function renderSimpleTestPage(request, env, session, user, nonce, cssContent) {
  const content = `
        <div class="min-h-screen bg-gradient-to-br from-blue-50 to-green-50 p-8">
            <div class="max-w-4xl mx-auto">
                <div class="bg-white rounded-lg shadow-md p-8 text-center">
                    <h1 class="text-4xl font-bold text-gray-900 mb-6">\u{1F3DD}\uFE0F \u6F8E\u6E56\u6642\u5149\u5CF6\u4E3B - \u6E2C\u8A66\u9801\u9762</h1>
                    <p class="text-lg text-gray-700 mb-8">\u9019\u662F\u4E00\u500B\u7C21\u55AE\u7684\u6E2C\u8A66\u9801\u9762\uFF0C\u7528\u4F86\u9A57\u8B49\u8DEF\u7531\u662F\u5426\u6B63\u5E38\u5DE5\u4F5C\u3002</p>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                        <div class="bg-blue-50 rounded-lg p-6">
                            <h2 class="text-xl font-semibold text-blue-900 mb-3">\u{1F3AE} \u904A\u6232\u529F\u80FD\u6E2C\u8A66</h2>
                            <div class="space-y-2">
                                <button onclick="testFunction('\u5275\u5EFA\u8A18\u61B6\u81A0\u56CA')" class="w-full bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition-colors">
                                    \u{1F4E6} \u6E2C\u8A66\u5275\u5EFA\u8A18\u61B6\u81A0\u56CA
                                </button>
                                <button onclick="testFunction('\u63A2\u7D22\u5730\u9EDE')" class="w-full bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 transition-colors">
                                    \u{1F5FA}\uFE0F \u6E2C\u8A66\u63A2\u7D22\u5730\u9EDE
                                </button>
                                <button onclick="testFunction('\u5B8C\u6210\u4EFB\u52D9')" class="w-full bg-purple-600 text-white px-4 py-2 rounded hover:bg-purple-700 transition-colors">
                                    \u{1F3AF} \u6E2C\u8A66\u5B8C\u6210\u4EFB\u52D9
                                </button>
                                <button onclick="testFunction('\u7372\u5F97\u52F3\u7AE0')" class="w-full bg-yellow-600 text-white px-4 py-2 rounded hover:bg-yellow-700 transition-colors">
                                    \u{1F3C6} \u6E2C\u8A66\u7372\u5F97\u52F3\u7AE0
                                </button>
                            </div>
                        </div>
                        
                        <div class="bg-green-50 rounded-lg p-6">
                            <h2 class="text-xl font-semibold text-green-900 mb-3">\u{1F4CA} \u6E2C\u8A66\u7D50\u679C</h2>
                            <div id="test-results" class="space-y-2 text-sm">
                                <div class="text-gray-600">\u7B49\u5F85\u6E2C\u8A66\u64CD\u4F5C...</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-yellow-50 rounded-lg p-6">
                        <h2 class="text-xl font-semibold text-yellow-900 mb-3">\u2705 \u6E2C\u8A66\u72C0\u614B</h2>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <div class="text-center">
                                <div class="text-2xl font-bold text-blue-600" id="test-points">0</div>
                                <div class="text-sm text-gray-500">\u9EDE\u6578</div>
                            </div>
                            <div class="text-center">
                                <div class="text-2xl font-bold text-green-600" id="test-level">1</div>
                                <div class="text-sm text-gray-500">\u7B49\u7D1A</div>
                            </div>
                            <div class="text-center">
                                <div class="text-2xl font-bold text-purple-600" id="test-memories">0</div>
                                <div class="text-sm text-gray-500">\u8A18\u61B6\u81A0\u56CA</div>
                            </div>
                            <div class="text-center">
                                <div class="text-2xl font-bold text-orange-600" id="test-visits">0</div>
                                <div class="text-sm text-gray-500">\u8A2A\u554F\u6B21\u6578</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <script nonce="${nonce}">
            let testStats = {
                points: 0,
                level: 1,
                memories: 0,
                visits: 0
            };

            function testFunction(action) {
                // \u66F4\u65B0\u7D71\u8A08
                testStats.points += 10;
                testStats.memories += 1;
                testStats.visits += 1;
                
                // \u6AA2\u67E5\u5347\u7D1A
                if (testStats.points >= 100) {
                    testStats.level += 1;
                    testStats.points = 0;
                }
                
                // \u66F4\u65B0\u986F\u793A
                updateStats();
                
                // \u6DFB\u52A0\u6E2C\u8A66\u7D50\u679C
                addTestResult(\`\u2705 \${action} \u6E2C\u8A66\u6210\u529F\uFF01\u7372\u5F97 10 \u9EDE\u6578\`);
                
                // \u986F\u793A\u6210\u529F\u63D0\u793A
                showSuccess(\`\${action} \u6E2C\u8A66\u6210\u529F\uFF01\`);
            }

            function updateStats() {
                document.getElementById('test-points').textContent = testStats.points;
                document.getElementById('test-level').textContent = testStats.level;
                document.getElementById('test-memories').textContent = testStats.memories;
                document.getElementById('test-visits').textContent = testStats.visits;
            }

            function addTestResult(message) {
                const results = document.getElementById('test-results');
                const result = document.createElement('div');
                result.className = 'text-green-600';
                result.textContent = \`[\${new Date().toLocaleTimeString()}] \${message}\`;
                results.insertBefore(result, results.firstChild);
                
                // \u9650\u5236\u7D50\u679C\u6578\u91CF
                while (results.children.length > 5) {
                    results.removeChild(results.lastChild);
                }
            }

            function showSuccess(message) {
                // \u5275\u5EFA\u6210\u529F\u63D0\u793A
                const success = document.createElement('div');
                success.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50';
                success.textContent = message;
                document.body.appendChild(success);
                
                // 3\u79D2\u5F8C\u79FB\u9664
                setTimeout(() => {
                    document.body.removeChild(success);
                }, 3000);
            }

            // \u9801\u9762\u8F09\u5165\u5B8C\u6210
            document.addEventListener('DOMContentLoaded', function() {
                console.log('\u7C21\u55AE\u6E2C\u8A66\u9801\u9762\u5DF2\u8F09\u5165\uFF01');
                addTestResult('\u6E2C\u8A66\u9801\u9762\u8F09\u5165\u5B8C\u6210');
            });
        </script>
    `;
  return new Response(pageTemplate2({
    title: "\u6F8E\u6E56\u6642\u5149\u5CF6\u4E3B - \u7C21\u55AE\u6E2C\u8A66",
    content,
    user: null,
    nonce,
    cssContent
  }), {
    headers: { "Content-Type": "text/html;charset=utf-8" }
  });
}

// src/pages/TestPage.js
init_layout();
async function renderTestPage(request, env, session, user, nonce, cssContent) {
  const content = `
        <div class="min-h-screen bg-blue-50 p-8">
            <div class="max-w-2xl mx-auto">
                <div class="bg-white rounded-lg shadow-md p-8 text-center">
                    <h1 class="text-4xl font-bold text-gray-900 mb-6">\u{1F3DD}\uFE0F \u6F8E\u6E56\u6642\u5149\u5CF6\u4E3B - \u6E2C\u8A66\u9801\u9762</h1>
                    <p class="text-lg text-gray-700 mb-8">\u9019\u662F\u4E00\u500B\u7C21\u55AE\u7684\u6E2C\u8A66\u9801\u9762\uFF0C\u7528\u4F86\u9A57\u8B49\u8DEF\u7531\u662F\u5426\u6B63\u5E38\u5DE5\u4F5C\u3002</p>
                    
                    <div class="space-y-4">
                        <button onclick="testFunction()" class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition-colors">
                            \u{1F3AE} \u6E2C\u8A66\u6309\u9215
                        </button>
                        
                        <div id="test-result" class="text-gray-600">
                            \u7B49\u5F85\u6E2C\u8A66...
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <script nonce="${nonce}">
            function testFunction() {
                document.getElementById('test-result').innerHTML = '\u2705 \u6E2C\u8A66\u6210\u529F\uFF01\u529F\u80FD\u6B63\u5E38\u904B\u4F5C\uFF01';
                document.getElementById('test-result').className = 'text-green-600 font-semibold';
            }
        </script>
    `;
  return new Response(pageTemplate2({
    title: "\u6F8E\u6E56\u6642\u5149\u5CF6\u4E3B - \u6E2C\u8A66",
    content,
    user: null,
    nonce,
    cssContent
  }), {
    headers: { "Content-Type": "text/html;charset=utf-8" }
  });
}

// src/pages/Footprints.js
init_layout();
init_LocationService();

// src/components/ImagePreview.js
var ImagePreview = class {
  constructor(options = {}) {
    this.imageUrl = options.imageUrl;
    this.alt = options.alt || "\u5716\u7247";
    this.thumbnailUrl = options.thumbnailUrl || options.imageUrl;
    this.nonce = options.nonce || "";
  }
  /**
   * 渲染圖片預覽組件
   * @returns {string} HTML 字串
   */
  render() {
    if (!this.imageUrl) {
      return "";
    }
    return `
      <div class="image-preview-container relative cursor-pointer group" 
           onclick="event.stopPropagation(); openImagePreview('${this.imageUrl}', '${this.alt.replace(/'/g, "\\'")}')">
        <img 
          src="${this.thumbnailUrl}" 
          alt="${this.alt}"
          class="image-preview-thumbnail w-full h-full object-cover transition-transform group-hover:scale-105"
          loading="lazy"
        >
        <div class="image-preview-overlay absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-20 transition-opacity flex items-center justify-center">
          <svg class="w-8 h-8 text-white opacity-0 group-hover:opacity-100 transition-opacity" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 7v6m3-3H7" />
          </svg>
        </div>
      </div>
    `;
  }
  /**
   * 獲取圖片預覽的 JavaScript 代碼
   * @param {string} nonce - CSP nonce
   * @returns {string}
   */
  static getScript(nonce = "") {
    const nonceAttr = nonce ? ` nonce="${nonce}"` : "";
    return `
      <script${nonceAttr}>
        // \u5716\u7247\u9810\u89BD\u529F\u80FD
        function openImagePreview(imageUrl, alt) {
          // \u5275\u5EFA\u9810\u89BD\u6A21\u614B\u6846
          const modal = document.createElement('div');
          modal.id = 'image-preview-modal';
          modal.className = 'image-preview-modal fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-90';
          modal.onclick = function(e) {
            if (e.target === modal) {
              closeImagePreview();
            }
          };
          
          // \u5275\u5EFA\u5716\u7247\u5BB9\u5668
          const imageContainer = document.createElement('div');
          imageContainer.className = 'image-preview-content relative max-w-7xl max-h-[90vh] p-4';
          
          // \u5275\u5EFA\u5716\u7247
          const img = document.createElement('img');
          img.src = imageUrl;
          img.alt = alt || '\u9810\u89BD\u5716\u7247';
          img.className = 'max-w-full max-h-[90vh] object-contain';
          
          // \u5275\u5EFA\u95DC\u9589\u6309\u9215
          const closeBtn = document.createElement('button');
          closeBtn.className = 'image-preview-close absolute top-4 right-4 w-10 h-10 bg-white bg-opacity-20 hover:bg-opacity-30 rounded-full flex items-center justify-center text-white transition-colors';
          closeBtn.innerHTML = '<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>';
          closeBtn.onclick = closeImagePreview;
          
          // \u5275\u5EFA\u4E0B\u8F09\u6309\u9215
          const downloadBtn = document.createElement('a');
          downloadBtn.href = imageUrl;
          downloadBtn.download = alt || 'image';
          downloadBtn.className = 'image-preview-download absolute top-4 left-4 w-10 h-10 bg-white bg-opacity-20 hover:bg-opacity-30 rounded-full flex items-center justify-center text-white transition-colors';
          downloadBtn.innerHTML = '<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>';
          downloadBtn.title = '\u4E0B\u8F09\u5716\u7247';
          
          imageContainer.appendChild(img);
          imageContainer.appendChild(closeBtn);
          imageContainer.appendChild(downloadBtn);
          modal.appendChild(imageContainer);
          
          document.body.appendChild(modal);
          document.body.style.overflow = 'hidden';
          
          // ESC \u9375\u95DC\u9589
          const escHandler = function(e) {
            if (e.key === 'Escape') {
              closeImagePreview();
              document.removeEventListener('keydown', escHandler);
            }
          };
          document.addEventListener('keydown', escHandler);
        }
        
        function closeImagePreview() {
          const modal = document.getElementById('image-preview-modal');
          if (modal) {
            modal.remove();
            document.body.style.overflow = '';
          }
        }
        
        // \u4F7F\u51FD\u6578\u5168\u5C40\u53EF\u7528
        window.openImagePreview = openImagePreview;
        window.closeImagePreview = closeImagePreview;
      </script>
    `;
  }
};

// src/pages/Footprints.js
async function _renderFootprintsPage(request, env, session, user, nonce, cssContent) {
  const dbHealth = await ServiceHealthChecker.checkDatabase(env.DB);
  if (!dbHealth.healthy) {
    console.error("[Footprints] Database not available:", dbHealth.error);
    return ErrorResponseBuilder.buildDatabaseErrorPage({
      user,
      nonce,
      cssContent
    });
  }
  const locationService = new LocationService(env.DB, env.GOOGLE_MAPS_API_KEY);
  const initialLimit = 12;
  const initialLocations = await locationService.getLocationsPaginated(initialLimit, 0, (user == null ? void 0 : user.id) || null);
  const translatePlaceTypes3 = (types) => {
    if (!types || !Array.isArray(types))
      return "\u672A\u77E5\u985E\u578B";
    const typeTranslations = {
      "restaurant": "\u9910\u5EF3",
      "cafe": "\u5496\u5561\u5EF3",
      "bar": "\u9152\u5427",
      "bakery": "\u9EB5\u5305\u5E97",
      "food": "\u7F8E\u98DF",
      "lodging": "\u4F4F\u5BBF",
      "hotel": "\u98EF\u5E97",
      "tourist_attraction": "\u89C0\u5149\u666F\u9EDE",
      "museum": "\u535A\u7269\u9928",
      "park": "\u516C\u5712",
      "natural_feature": "\u81EA\u7136\u666F\u89C0",
      "establishment": "\u5834\u6240",
      "point_of_interest": "\u666F\u9EDE"
    };
    return types.map((type) => typeTranslations[type] || type).join(", ");
  };
  const createImageWithFallback3 = (src, alt, className, locationName) => {
    const defaultImage = "https://placehold.co/400x268/6B7280/FFFFFF?text=Location+Image";
    const imageId = `img-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
    const containerId = `img-container-${imageId}`;
    if (!src || src === "null" || src === "undefined") {
      return `<div id="${containerId}" class="image-loader-container">
        <img 
          id="${imageId}"
          src="${defaultImage}" 
          alt="${alt || "\u5730\u9EDE\u7167\u7247"}" 
          class="${className}" 
          style="opacity: 1; transition: opacity 0.3s ease-in-out;"
        >
      </div>`;
    }
    if (src.includes("placehold.co")) {
      return `<div id="${containerId}" class="image-loader-container">
        <img 
          id="${imageId}"
          src="${src}" 
          alt="${alt || "\u5730\u9EDE\u7167\u7247"}" 
          class="${className}" 
          style="opacity: 1; transition: opacity 0.3s ease-in-out;"
        >
      </div>`;
    }
    return `
      <div id="${containerId}" class="image-loader-container relative">
        <!-- \u9AA8\u67B6\u5C4F -->
        <div class="image-skeleton absolute inset-0 bg-gray-200 rounded">
          <div class="w-full h-full bg-gradient-to-r from-gray-200 via-gray-300 to-gray-200 bg-[length:200%_100%] animate-shimmer"></div>
        </div>
        <!-- \u8F09\u5165\u9032\u5EA6\u6307\u793A\u5668 -->
        <div class="image-progress absolute inset-0 flex items-center justify-center bg-gray-100 bg-opacity-50">
          <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
        </div>
        <!-- \u5716\u7247 -->
        <img 
          id="${imageId}"
          src="${src}" 
          alt="${alt || "\u5730\u9EDE\u7167\u7247"}" 
          class="${className} image-loader-img"
          style="opacity: 0; transition: opacity 0.3s ease-in-out; position: relative; z-index: 1;"
          onerror="handleImageError('${imageId}', '${containerId}', '${defaultImage}')"
          onload="handleImageLoad('${imageId}', '${containerId}')"
          loading="lazy"
        >
        <!-- \u932F\u8AA4\u8A0A\u606F\uFF08\u6539\u9032\u7684\u8996\u89BA\u56DE\u994B\uFF09 -->
        <div id="error-${imageId}" class="image-error-message hidden absolute inset-0 z-10">
          <div class="error-state-icon">
            <svg class="w-8 h-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
          </div>
          <p class="error-state-title">\u5716\u7247\u8F09\u5165\u5931\u6557</p>
          <p class="error-state-message">\u6B63\u5728\u5617\u8A66\u8F09\u5165\u9810\u8A2D\u5716\u7247...</p>
        </div>
      </div>
    `;
  };
  const renderLocationCard = (location) => {
    let typesArray = [];
    try {
      if (location.google_types) {
        typesArray = typeof location.google_types === "string" ? JSON.parse(location.google_types) : location.google_types;
      }
    } catch (e) {
      console.error("Error parsing google_types JSON:", e, location.google_types);
    }
    const displayTypes = translatePlaceTypes3(typesArray);
    const isFavorited = location.is_favorited || false;
    const imageUrl = location.thumbnail_url || "https://placehold.co/400x268/png?text=No+Image";
    const locationName = location.name || "\u672A\u547D\u540D\u5730\u9EDE";
    const locationAlt = location.name || "\u5730\u9EDE\u7167\u7247";
    return `
      <div class="location-card bg-white rounded-lg shadow-md overflow-hidden border border-gray-200 flex flex-col cursor-pointer transition-transform hover:scale-105" 
           data-location-id="${location.id}"
           onclick="window.location.href='/location/${location.id}'">
        <div class="relative">
          ${new ImagePreview({
      imageUrl,
      thumbnailUrl: imageUrl,
      alt: locationAlt,
      nonce
    }).render()}
          ${user ? `
            <button 
              class="location-card-favorite-btn ${isFavorited ? "favorited" : ""}"
              data-location-id="${location.id}"
              data-is-favorited="${isFavorited}"
              onclick="event.stopPropagation(); handleFavoriteToggle('${location.id}', event)"
              title="${isFavorited ? "\u53D6\u6D88\u6536\u85CF" : "\u52A0\u5165\u6536\u85CF"}"
            >
              <svg class="w-5 h-5 fill-current" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z" clip-rule="evenodd" />
              </svg>
            </button>
          ` : ""}
        </div>
        <div class="p-4 flex-grow">
          <h3 class="text-lg font-semibold mb-1 truncate" title="${location.name || "\u672A\u547D\u540D\u5730\u9EDE"}">${location.name || "\u672A\u547D\u540D\u5730\u9EDE"}</h3>
          <p class="text-sm text-gray-600 mb-2 truncate" title="${location.address || "\u7121\u5730\u5740\u8CC7\u8A0A"}">${location.address || "\u7121\u5730\u5740\u8CC7\u8A0A"}</p>
          <p class="text-xs text-gray-500 mb-3">\u985E\u578B: ${displayTypes}</p>
          ${location.editorial_summary ? `<p class="text-xs text-gray-600 mb-3 leading-tight max-h-12 overflow-hidden" title="${location.editorial_summary}">${location.editorial_summary}</p>` : ""}
          
          <!-- \u4E92\u52D5\u6309\u9215 -->
          <div class="flex justify-between items-center mt-auto pt-2">
            <div class="flex space-x-2">
              <button 
                onclick="event.stopPropagation(); updateLocationStatus('${location.id}', 'visited')"
                class="flex items-center space-x-1 px-3 py-1 rounded text-sm transition-colors ${location.user_location_status === "visited" ? "bg-green-500 text-white" : "bg-gray-200 text-gray-700 hover:bg-green-100"}"
              >
                <span>\u2713</span>
                <span>\u4F86\u904E</span>
              </button>
              <button 
                onclick="event.stopPropagation(); updateLocationStatus('${location.id}', 'want_to_visit')"
                class="flex items-center space-x-1 px-3 py-1 rounded text-sm transition-colors ${location.user_location_status === "want_to_visit" ? "bg-blue-500 text-white" : "bg-gray-200 text-gray-700 hover:bg-blue-100"}"
              >
                <span>\u2764</span>
                <span>\u60F3\u4F86</span>
              </button>
              <button 
                onclick="event.stopPropagation(); updateLocationStatus('${location.id}', 'want_to_revisit')"
                class="flex items-center space-x-1 px-3 py-1 rounded text-sm transition-colors ${location.user_location_status === "want_to_revisit" ? "bg-purple-500 text-white" : "bg-gray-200 text-gray-700 hover:bg-purple-100"}"
              >
                <span>\u{1F504}</span>
                <span>\u60F3\u518D\u4F86</span>
              </button>
            </div>
          </div>
        </div>
      </div>
    `;
  };
  const content = `
    <div class="max-w-6xl mx-auto px-4 py-8">
      <div class="bg-white rounded-lg shadow-md p-6 mb-8">
        <h1 class="text-2xl font-bold text-gray-900">\u8DB3\u8DE1</h1>
        <p class="text-gray-600 mt-2">\u63A2\u7D22\u6240\u6709\u6F8E\u6E56\u5730\u9EDE</p>
      </div>

      <!-- \u5730\u9EDE\u7DB2\u683C\u5BB9\u5668 -->
      <div id="locations-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 md:gap-6">
        ${initialLocations.map((location) => renderLocationCard(location)).join("")}
      </div>

      <!-- \u8F09\u5165\u66F4\u591A\u6307\u793A\u5668 -->
      <div id="loading-indicator" class="text-center py-8 hidden">
        <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-gray-900"></div>
        <p class="mt-2 text-gray-600">\u8F09\u5165\u4E2D...</p>
      </div>

      <!-- \u6C92\u6709\u66F4\u591A\u5167\u5BB9\u63D0\u793A -->
      <div id="no-more-indicator" class="text-center py-8 hidden">
        <p class="text-gray-500">\u5DF2\u986F\u793A\u6240\u6709\u5730\u9EDE</p>
      </div>
    </div>

    <script nonce="${nonce}">
      // \u5716\u7247\u8F09\u5165\u8655\u7406\u51FD\u6578
      function handleImageLoad(imageId, containerId) {
        const img = document.getElementById(imageId);
        const container = document.getElementById(containerId);
        if (img && container) {
          const skeleton = container.querySelector('.image-skeleton');
          const progress = container.querySelector('.image-progress');
          const errorMsg = container.querySelector('#error-' + imageId);
          if (skeleton) skeleton.classList.add('hidden');
          if (progress) progress.classList.add('hidden');
          if (errorMsg) errorMsg.classList.add('hidden');
          img.style.opacity = '1';
        }
      }

      function handleImageError(imageId, containerId, defaultImage) {
        const img = document.getElementById(imageId);
        const container = document.getElementById(containerId);
        if (img && container) {
          const skeleton = container.querySelector('.image-skeleton');
          const progress = container.querySelector('.image-progress');
          if (skeleton) skeleton.classList.add('hidden');
          if (progress) progress.classList.add('hidden');
          const errorMsg = container.querySelector('#error-' + imageId);
          if (errorMsg) errorMsg.classList.remove('hidden');
          if (img.src !== defaultImage) {
            img.onerror = null;
            img.src = defaultImage;
            img.style.opacity = '1';
          } else {
            img.style.opacity = '0.3';
          }
        }
      }

      let currentOffset = ${initialLocations.length};
      let isLoading = false;
      let hasMore = ${initialLocations.length === 12}; // \u5982\u679C\u521D\u59CB\u8F09\u5165\u6EFF12\u500B\uFF0C\u53EF\u80FD\u9084\u6709\u66F4\u591A
      const locationsGrid = document.getElementById('locations-grid');
      const loadingIndicator = document.getElementById('loading-indicator');
      const noMoreIndicator = document.getElementById('no-more-indicator');
      
      // \u8A08\u7B97\u6BCF\u5C4F\u53EF\u5BB9\u7D0D\u7684\u5730\u9EDE\u6578\u91CF
      function calculateVisibleLocations() {
        const viewportHeight = window.innerHeight;
        const headerHeight = 80; // \u4F30\u7B97header\u9AD8\u5EA6
        const footerHeight = 60; // \u4F30\u7B97footer\u9AD8\u5EA6
        const padding = 64; // \u4E0A\u4E0Bpadding
        const availableHeight = viewportHeight - headerHeight - footerHeight - padding;
        
        // \u6BCF\u500B\u5730\u9EDE\u5361\u7247\u9AD8\u5EA6\u7D04\u70BA 400px\uFF08\u5305\u542B\u5716\u7247\u3001\u6587\u5B57\u3001\u6309\u9215\uFF09
        const cardHeight = 400;
        const gap = 24; // \u7DB2\u683C\u9593\u8DDD
        
        // \u8A08\u7B97\u53EF\u986F\u793A\u7684\u884C\u6578
        const rows = Math.floor(availableHeight / (cardHeight + gap));
        
        // \u6839\u64DA\u5C4F\u5E55\u5BEC\u5EA6\u8A08\u7B97\u5217\u6578
        let cols = 2; // \u9ED8\u8A8D\u624B\u6A5F
        if (window.innerWidth >= 1024) {
          cols = 4; // \u684C\u9762
        } else if (window.innerWidth >= 768) {
          cols = 3; // \u5E73\u677F
        }
        
        // \u8FD4\u56DE\u53EF\u5BB9\u7D0D\u7684\u6578\u91CF\uFF08\u81F3\u5C11\u986F\u793A\u4E00\u884C\uFF09
        return Math.max(rows * cols, cols);
      }
      
      // \u4F7F\u7528 Intersection Observer \u5BE6\u73FE\u66F4\u7CBE\u78BA\u7684\u61F6\u52A0\u8F09
      let observer;
      const loadMoreTrigger = document.createElement('div');
      loadMoreTrigger.id = 'load-more-trigger';
      loadMoreTrigger.style.height = '1px';
      loadMoreTrigger.style.width = '100%';
      locationsGrid.parentElement.appendChild(loadMoreTrigger);

      // \u6536\u85CF\u5207\u63DB\u51FD\u6578
      async function handleFavoriteToggle(locationId, event) {
        if (event) {
          event.preventDefault();
          event.stopPropagation();
        }
        
        const button = event ? event.target.closest('.location-card-favorite-btn') : null;
        if (!button) return;
        
        const isFavorited = button.getAttribute('data-is-favorited') === 'true';
        
        try {
          const response = await fetch('/api/favorites/toggle', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            credentials: 'include',
            body: JSON.stringify({
              location_id: locationId,
              favorite: !isFavorited
            })
          });
          
          const data = await response.json();
          
          if (data.success) {
            // \u66F4\u65B0\u6309\u9215\u72C0\u614B
            if (data.is_favorited) {
              button.setAttribute('data-is-favorited', 'true');
              button.classList.add('favorited');
              button.setAttribute('title', '\u53D6\u6D88\u6536\u85CF');
              if (window.showToast) {
                window.showToast('\u5DF2\u6536\u85CF\uFF01', 'success');
              }
            } else {
              button.setAttribute('data-is-favorited', 'false');
              button.classList.remove('favorited');
              button.setAttribute('title', '\u52A0\u5165\u6536\u85CF');
              if (window.showToast) {
                window.showToast('\u5DF2\u53D6\u6D88\u6536\u85CF', 'success');
              }
            }
          } else {
            window.showToast('\u64CD\u4F5C\u5931\u6557: ' + (data.error || '\u672A\u77E5\u932F\u8AA4'), 'error');
          }
        } catch (error) {
          console.error('Error:', error);
          window.showToast('\u64CD\u4F5C\u5931\u6557\uFF0C\u8ACB\u7A0D\u5F8C\u518D\u8A66', 'error');
        }
      }

      // \u66F4\u65B0\u5730\u9EDE\u72C0\u614B\u51FD\u6578
      async function updateLocationStatus(locationId, newStatus, event) {
        if (event) {
          event.preventDefault();
          event.stopPropagation();
        }
        
        try {
          const response = await fetch('/api/location/status', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              locationId: locationId,
              status: newStatus
            })
          });
          
          const data = await response.json();
          
          if (data.success) {
            // \u66F4\u65B0\u6309\u9215\u72C0\u614B
            const button = event ? event.target.closest('button') : null;
            if (button) {
              // \u91CD\u7F6E\u6240\u6709\u6309\u9215
              const allButtons = button.parentElement.querySelectorAll('button');
              allButtons.forEach(btn => {
                btn.classList.remove('bg-green-500', 'bg-blue-500', 'bg-purple-500', 'text-white');
                btn.classList.add('bg-gray-200', 'text-gray-700');
              });
              
              // \u6FC0\u6D3B\u9078\u4E2D\u7684\u6309\u9215
              button.classList.remove('bg-gray-200', 'text-gray-700');
              let statusText = '';
              if (newStatus === 'visited') {
                button.classList.add('bg-green-500', 'text-white');
                statusText = '\u4F86\u904E';
              } else if (newStatus === 'want_to_visit') {
                button.classList.add('bg-blue-500', 'text-white');
                statusText = '\u60F3\u4F86';
              } else if (newStatus === 'want_to_revisit') {
                button.classList.add('bg-purple-500', 'text-white');
                statusText = '\u60F3\u518D\u4F86';
              }
              
              // \u986F\u793A\u6210\u529F\u901A\u77E5
              if (window.showToast && statusText) {
                window.showToast('\u5730\u9EDE\u72C0\u614B\u5DF2\u66F4\u65B0\u70BA\u300C' + statusText + '\u300D', 'success');
              }
            }
          } else {
            window.showToast('\u66F4\u65B0\u5931\u6557: ' + data.error, 'error');
          }
        } catch (error) {
          console.error('Error:', error);
          window.showToast('\u66F4\u65B0\u5931\u6557\uFF0C\u8ACB\u7A0D\u5F8C\u518D\u8A66', 'error');
        }
      }

      // \u8F09\u5165\u66F4\u591A\u5730\u9EDE
      async function loadMoreLocations() {
        if (isLoading || !hasMore) return;
        
        isLoading = true;
        loadingIndicator.classList.remove('hidden');
        
        // \u6839\u64DA\u5C4F\u5E55\u5927\u5C0F\u6C7A\u5B9A\u6BCF\u6B21\u8F09\u5165\u7684\u6578\u91CF
        const loadLimit = calculateVisibleLocations();
        
        try {
          const apiUrl = '/api/locations/paginated?limit=' + loadLimit + '&offset=' + currentOffset;
          console.log('Loading more locations from:', apiUrl);
          const response = await fetch(apiUrl);
          
          if (!response.ok) {
            throw new Error('API request failed with status: ' + response.status);
          }
          
          const data = await response.json();
          
          if (!data) {
            throw new Error('Invalid response data');
          }
          
          if (data.success && data.locations && data.locations.length > 0) {
            // \u6E32\u67D3\u65B0\u5730\u9EDE
            data.locations.forEach(location => {
              const card = document.createElement('div');
              card.className = 'location-card bg-white rounded-lg shadow-md overflow-hidden border border-gray-200 flex flex-col cursor-pointer transition-transform hover:scale-105';
              card.setAttribute('data-location-id', location.id);
              card.onclick = function() {
                window.location.href = '/location/' + locationId;
              };
              
              // \u89E3\u6790\u985E\u578B
              let typesArray = [];
              try {
                if (location.google_types) {
                  typesArray = typeof location.google_types === 'string' 
                    ? JSON.parse(location.google_types) 
                    : location.google_types;
                }
              } catch (e) {
                console.error('Error parsing types:', e);
              }
              
              const typeTranslations = {
                'restaurant': '\u9910\u5EF3', 'cafe': '\u5496\u5561\u5EF3', 'bar': '\u9152\u5427', 'bakery': '\u9EB5\u5305\u5E97',
                'food': '\u7F8E\u98DF', 'lodging': '\u4F4F\u5BBF', 'hotel': '\u98EF\u5E97', 'tourist_attraction': '\u89C0\u5149\u666F\u9EDE',
                'museum': '\u535A\u7269\u9928', 'park': '\u516C\u5712', 'natural_feature': '\u81EA\u7136\u666F\u89C0',
                'establishment': '\u5834\u6240', 'point_of_interest': '\u666F\u9EDE'
              };
              const displayTypes = typesArray.map(type => typeTranslations[type] || type).join(', ') || '\u672A\u77E5\u985E\u578B';
              
              const defaultImage = 'https://placehold.co/400x268/6B7280/FFFFFF?text=Location+Image';
              const imageSrc = location.thumbnail_url || defaultImage;
              const locationName = (location.name || '\u672A\u547D\u540D\u5730\u9EDE').replace(/"/g, '&quot;').replace(/'/g, '&#039;');
              const locationAddress = (location.address || '\u7121\u5730\u5740\u8CC7\u8A0A').replace(/"/g, '&quot;').replace(/'/g, '&#039;');
              const locationId = location.id;
              const isFavorited = location.is_favorited || false;
              const visitedClass = location.user_location_status === 'visited' ? 'bg-green-500 text-white' : 'bg-gray-200 text-gray-700 hover:bg-green-100';
              const wantToVisitClass = location.user_location_status === 'want_to_visit' ? 'bg-blue-500 text-white' : 'bg-gray-200 text-gray-700 hover:bg-blue-100';
              const wantToRevisitClass = location.user_location_status === 'want_to_revisit' ? 'bg-purple-500 text-white' : 'bg-gray-200 text-gray-700 hover:bg-purple-100';
              const summaryHtml = location.editorial_summary ? 
                '<p class="text-xs text-gray-600 mb-3 leading-tight max-h-12 overflow-hidden" title="' + 
                location.editorial_summary.replace(/"/g, '&quot;').replace(/'/g, '&#039;') + 
                '">' + location.editorial_summary.replace(/</g, '&lt;').replace(/>/g, '&gt;') + '</p>' : '';
              
              // \u4F7F\u7528 DOM API \u521B\u5EFA\u5143\u7D20\uFF0C\u907F\u514D\u5B57\u7B26\u4E32\u8F6C\u4E49\u95EE\u9898
              const imageContainer = document.createElement('div');
              imageContainer.className = 'relative';
              
              // Create image preview container
              const previewContainer = document.createElement('div');
              previewContainer.className = 'image-preview-container relative cursor-pointer group';
              previewContainer.onclick = function(e) {
                e.stopPropagation();
                if (window.openImagePreview) {
                  window.openImagePreview(imageSrc, locationName);
                }
              };
              
              const img = document.createElement('img');
              img.src = imageSrc;
              img.alt = locationName;
              img.className = 'image-preview-thumbnail w-full h-48 object-cover transition-transform group-hover:scale-105';
              img.loading = 'lazy';
              img.onerror = function() {
                this.onerror = null;
                this.src = defaultImage;
              };
              
              // Create overlay
              const overlay = document.createElement('div');
              overlay.className = 'image-preview-overlay absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-20 transition-opacity flex items-center justify-center';
              overlay.innerHTML = '<svg class="w-8 h-8 text-white opacity-0 group-hover:opacity-100 transition-opacity" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 7v6m3-3H7" /></svg>';
              
              previewContainer.appendChild(img);
              previewContainer.appendChild(overlay);
              imageContainer.appendChild(previewContainer);
              
              // \u6DFB\u52A0\u6536\u85CF\u6309\u9215\uFF08\u5982\u679C\u7528\u6236\u5DF2\u767B\u5165\uFF09
              ${user ? `
                const favoriteBtn = document.createElement('button');
                favoriteBtn.className = 'location-card-favorite-btn ' + (isFavorited ? 'favorited' : '');
                favoriteBtn.setAttribute('data-location-id', locationId);
                favoriteBtn.setAttribute('data-is-favorited', isFavorited);
                favoriteBtn.setAttribute('title', isFavorited ? '\u53D6\u6D88\u6536\u85CF' : '\u52A0\u5165\u6536\u85CF');
                favoriteBtn.onclick = function(e) {
                  e.stopPropagation();
                  handleFavoriteToggle(locationId, e);
                };
                favoriteBtn.innerHTML = '<svg class="w-5 h-5 fill-current" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z" clip-rule="evenodd" /></svg>';
                imageContainer.appendChild(favoriteBtn);
              ` : ""}
              
              const contentDiv = document.createElement('div');
              contentDiv.className = 'p-4 flex-grow';
              contentDiv.innerHTML = 
                '<h3 class="text-lg font-semibold mb-1 truncate" title="' + locationName + '">' + locationName + '</h3>' +
                '<p class="text-sm text-gray-600 mb-2 truncate" title="' + locationAddress + '">' + locationAddress + '</p>' +
                '<p class="text-xs text-gray-500 mb-3">\u985E\u578B: ' + displayTypes + '</p>' +
                summaryHtml +
                '<div class="flex justify-between items-center mt-auto pt-2">' +
                '<div class="flex space-x-2">' +
                '<button onclick="event.stopPropagation(); updateLocationStatus(&quot;' + locationId + '&quot;, &quot;visited&quot;)" ' +
                'class="flex items-center space-x-1 px-3 py-1 rounded text-sm transition-colors ' + visitedClass + '">' +
                '<span>\u2713</span><span>\u4F86\u904E</span></button>' +
                '<button onclick="event.stopPropagation(); updateLocationStatus(&quot;' + locationId + '&quot;, &quot;want_to_visit&quot;)" ' +
                'class="flex items-center space-x-1 px-3 py-1 rounded text-sm transition-colors ' + wantToVisitClass + '">' +
                '<span>\u2764</span><span>\u60F3\u4F86</span></button>' +
                '<button onclick="event.stopPropagation(); updateLocationStatus(&quot;' + locationId + '&quot;, &quot;want_to_revisit&quot;)" ' +
                'class="flex items-center space-x-1 px-3 py-1 rounded text-sm transition-colors ' + wantToRevisitClass + '">' +
                '<span>\u{1F504}</span><span>\u60F3\u518D\u4F86</span></button>' +
                '</div></div></div>';
              
              card.appendChild(imageContainer);
              card.appendChild(contentDiv);
              
              locationsGrid.appendChild(card);
            });
            
            currentOffset += data.locations.length;
            hasMore = data.locations.length === loadLimit; // \u5982\u679C\u8FD4\u56DE\u6EFF\u8F09\u5165\u6578\u91CF\uFF0C\u53EF\u80FD\u9084\u6709\u66F4\u591A
            
            // \u5C07\u89F8\u767C\u5668\u79FB\u5230\u6700\u5F8C\u4E00\u500B\u5143\u7D20\u5F8C\u9762
            if (loadMoreTrigger.parentElement) {
              loadMoreTrigger.remove();
            }
            locationsGrid.appendChild(loadMoreTrigger);
            
            if (!hasMore) {
              noMoreIndicator.classList.remove('hidden');
              loadMoreTrigger.remove();
            }
          } else {
            hasMore = false;
            noMoreIndicator.classList.remove('hidden');
            loadMoreTrigger.remove();
          }
        } catch (error) {
          console.error('Error loading more locations:', error);
          console.error('Error details:', {
            message: error.message,
            stack: error.stack,
            loadLimit: loadLimit,
            currentOffset: currentOffset
          });
          
          // \u5982\u679C\u9519\u8BEF\u662F\u7F51\u7EDC\u9519\u8BEF\u6216 API \u9519\u8BEF\uFF0C\u663E\u793A\u66F4\u8BE6\u7EC6\u7684\u9519\u8BEF\u4FE1\u606F
          if (error.message.includes('API request failed')) {
            window.showToast('\u8F09\u5165\u5931\u6557\uFF1A\u4F3A\u670D\u5668\u932F\u8AA4\uFF0C\u8ACB\u7A0D\u5F8C\u518D\u8A66', 'error');
          } else if (error.message.includes('fetch')) {
            window.showToast('\u8F09\u5165\u5931\u6557\uFF1A\u7DB2\u8DEF\u9023\u7DDA\u554F\u984C\uFF0C\u8ACB\u6AA2\u67E5\u60A8\u7684\u7DB2\u8DEF\u9023\u7DDA', 'error');
          } else {
            window.showToast('\u8F09\u5165\u5931\u6557\uFF0C\u8ACB\u7A0D\u5F8C\u518D\u8A66', 'error');
          }
          
          // \u6807\u8BB0\u4E3A\u6CA1\u6709\u66F4\u591A\u5185\u5BB9\uFF0C\u907F\u514D\u91CD\u590D\u5C1D\u8BD5
          hasMore = false;
        } finally {
          isLoading = false;
          loadingIndicator.classList.add('hidden');
        }
      }

      // \u4F7F\u7528 Intersection Observer \u5BE6\u73FE\u66F4\u7CBE\u78BA\u7684\u61F6\u52A0\u8F09
      if ('IntersectionObserver' in window) {
        observer = new IntersectionObserver((entries) => {
          entries.forEach(entry => {
            if (entry.isIntersecting && !isLoading && hasMore) {
              console.log('Intersection Observer triggered, loading more locations...');
              loadMoreLocations();
            }
          });
        }, {
          rootMargin: '200px' // \u63D0\u524D200px\u958B\u59CB\u8F09\u5165
        });
        
        observer.observe(loadMoreTrigger);
        console.log('Intersection Observer initialized, observing loadMoreTrigger');
      } else {
        // \u964D\u7D1A\u65B9\u6848\uFF1A\u4F7F\u7528\u6EFE\u52D5\u4E8B\u4EF6
        let scrollTimeout;
        window.addEventListener('scroll', () => {
          clearTimeout(scrollTimeout);
          scrollTimeout = setTimeout(() => {
            if (window.innerHeight + window.scrollY >= document.body.offsetHeight - 200) {
              loadMoreLocations();
            }
          }, 100);
        });
      }

      // \u521D\u59CB\u6AA2\u67E5\u662F\u5426\u9700\u8981\u8F09\u5165\u66F4\u591A\uFF08\u5982\u679C\u5167\u5BB9\u4E0D\u8DB3\u4E00\u5C4F\uFF09
      if (window.innerHeight >= document.body.offsetHeight && hasMore) {
        loadMoreLocations();
      }
      
      // \u76E3\u807D\u7A97\u53E3\u5927\u5C0F\u8B8A\u5316\uFF0C\u91CD\u65B0\u8A08\u7B97\u53EF\u898B\u6578\u91CF
      let resizeTimeout;
      window.addEventListener('resize', () => {
        clearTimeout(resizeTimeout);
        resizeTimeout = setTimeout(() => {
          // \u5982\u679C\u5167\u5BB9\u4E0D\u8DB3\u4E00\u5C4F\u4E14\u6709\u66F4\u591A\u5167\u5BB9\uFF0C\u8F09\u5165\u66F4\u591A
          if (window.innerHeight >= document.body.offsetHeight && hasMore && !isLoading) {
            loadMoreLocations();
          }
        }, 300);
      });
    </script>
    ${ImagePreview.getScript(nonce)}
  `;
  try {
    const url = new URL(request.url);
    return new Response(pageTemplate2({
      title: "\u8DB3\u8DE1 - HOPENGHU",
      content,
      user,
      nonce,
      cssContent
    }), {
      headers: { "Content-Type": "text/html;charset=utf-8" }
    });
  } catch (error) {
    console.error("[Footprints] Error:", error);
    return ErrorResponseBuilder.buildErrorPage({
      title: "\u8F09\u5165\u8DB3\u8DE1\u9801\u9762\u5931\u6557",
      message: error.message || "\u7121\u6CD5\u8F09\u5165\u8DB3\u8DE1\u9801\u9762\uFF0C\u8ACB\u7A0D\u5F8C\u518D\u8A66\u3002",
      statusCode: 500,
      user,
      nonce,
      cssContent
    });
  }
}
var renderFootprintsPage = withErrorHandling(_renderFootprintsPage, {
  user: null,
  nonce: "",
  cssContent: ""
});

// src/pages/StoryTimeline.js
init_layout();
init_StoryModule();
init_PersonModule();
async function renderStoryTimelinePage(request, env, session, user, nonce, cssContent) {
  var _a, _b, _c, _d;
  if (!user || !user.id) {
    return Response.redirect(new URL(request.url).origin + "/", 302);
  }
  try {
    const storyModule = new StoryModule(env.DB);
    const personModule = new PersonModule(env.DB);
    const timeline = await storyModule.getPersonTimeline(user.id);
    const stats = await storyModule.getStoryStatistics(user.id, null);
    const personProfile = await personModule.getPersonProfile(user.id);
    const content = `
      <div class="min-h-screen bg-gray-50">
        <!-- Header -->
        <div class="bg-white shadow-sm border-b">
          <div class="max-w-4xl mx-auto px-4 py-6">
            <h1 class="text-3xl font-bold text-gray-900">\u6211\u7684\u6545\u4E8B\u6642\u9593\u7DDA</h1>
            <p class="text-gray-600 mt-2">\u8A18\u9304\u60A8\u5728\u6F8E\u6E56\u7684\u6BCF\u4E00\u500B\u8DB3\u8DE1\u8207\u56DE\u61B6</p>
          </div>
        </div>

        <!-- Statistics -->
        <div class="max-w-4xl mx-auto px-4 py-6">
          <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
            <div class="bg-white rounded-lg shadow p-4">
              <div class="text-2xl font-bold text-blue-600">${((_a = stats == null ? void 0 : stats.actionStats) == null ? void 0 : _a.total) || 0}</div>
              <div class="text-sm text-gray-600">\u7E3D\u6545\u4E8B\u6578</div>
            </div>
            <div class="bg-white rounded-lg shadow p-4">
              <div class="text-2xl font-bold text-green-600">${((_b = stats == null ? void 0 : stats.actionStats) == null ? void 0 : _b.visited) || 0}</div>
              <div class="text-sm text-gray-600">\u4F86\u904E</div>
            </div>
            <div class="bg-white rounded-lg shadow p-4">
              <div class="text-2xl font-bold text-purple-600">${((_c = stats == null ? void 0 : stats.actionStats) == null ? void 0 : _c.want_to_visit) || 0}</div>
              <div class="text-sm text-gray-600">\u60F3\u4F86</div>
            </div>
            <div class="bg-white rounded-lg shadow p-4">
              <div class="text-2xl font-bold text-orange-600">${((_d = stats == null ? void 0 : stats.actionStats) == null ? void 0 : _d.want_to_revisit) || 0}</div>
              <div class="text-sm text-gray-600">\u60F3\u518D\u4F86</div>
            </div>
          </div>

          <!-- Timeline -->
          <div class="bg-white rounded-lg shadow">
            <div class="p-6">
              <h2 class="text-xl font-semibold mb-4">\u6642\u9593\u7DDA</h2>
              <div id="timeline-container" class="space-y-4">
                ${timeline.length === 0 ? `
                  <div class="text-center py-12 text-gray-500">
                    <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    <p class="mt-4">\u9084\u6C92\u6709\u4EFB\u4F55\u6545\u4E8B\u8A18\u9304</p>
                    <p class="text-sm mt-2">\u958B\u59CB\u63A2\u7D22\u6F8E\u6E56\uFF0C\u8A18\u9304\u60A8\u7684\u8DB3\u8DE1\u5427\uFF01</p>
                  </div>
                ` : timeline.map((story) => `
                  <div class="border-l-4 border-blue-500 pl-4 py-2 hover:bg-gray-50 transition-colors">
                    <div class="flex items-start justify-between">
                      <div class="flex-1">
                        <div class="flex items-center gap-2 mb-1">
                          <span class="text-lg">${story.actionIcon || "\u2022"}</span>
                          <span class="font-semibold text-gray-900">${story.actionName || story.action_type}</span>
                          <span class="text-sm text-gray-500">${story.timeDescription || ""}</span>
                        </div>
                        ${story.actionDescription ? `
                          <p class="text-gray-700 mb-2">${story.actionDescription}</p>
                        ` : ""}
                        ${story.user_description ? `
                          <p class="text-gray-600 text-sm italic">"${story.user_description}"</p>
                        ` : ""}
                        ${story._location ? `
                          <div class="mt-2">
                            <a href="/location/${story.location_id}" class="text-blue-600 hover:underline text-sm">
                              \u{1F4CD} ${story._location.name || "\u672A\u77E5\u5730\u9EDE"}
                            </a>
                          </div>
                        ` : ""}
                        <div class="mt-2 flex gap-2">
                          <button 
                            onclick="shareStory('${story.id}', '${story.actionDescription || story.actionName}')" 
                            class="text-sm text-blue-600 hover:text-blue-800 flex items-center gap-1"
                            data-story-id="${story.id}"
                          >
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z" />
                            </svg>
                            \u5206\u4EAB
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                `).join("")}
              </div>
            </div>
          </div>
        </div>
      </div>

      <script nonce="${nonce}">
        // \u5206\u4EAB\u6545\u4E8B\u529F\u80FD
        async function shareStory(storyId, storyTitle) {
          try {
            // \u5617\u8A66\u4F7F\u7528 Web Share API
            if (navigator.share) {
              const shareUrl = window.location.origin + '/story/' + storyId;
              await navigator.share({
                title: '\u6211\u7684\u6F8E\u6E56\u6545\u4E8B',
                text: storyTitle,
                url: shareUrl
              });
              
              // \u540C\u6642\u8A18\u9304\u5206\u4EAB\u5230\u5F8C\u7AEF
              await fetch('/api/story/share', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify({ story_id: storyId, share_type: 'public' })
              });
            } else {
              // \u964D\u7D1A\u65B9\u6848\uFF1A\u8907\u88FD\u9023\u7D50\u5230\u526A\u8CBC\u677F
              const shareUrl = window.location.origin + '/story/' + storyId;
              await navigator.clipboard.writeText(shareUrl);
              
              // \u986F\u793A\u63D0\u793A
              if (window.showToast) {
                window.showToast('\u9023\u7D50\u5DF2\u8907\u88FD\u5230\u526A\u8CBC\u677F\uFF01', 'success');
              } else {
                alert('\u9023\u7D50\u5DF2\u8907\u88FD\u5230\u526A\u8CBC\u677F\uFF01');
              }
              
              // \u8A18\u9304\u5206\u4EAB\u5230\u5F8C\u7AEF
              await fetch('/api/story/share', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify({ story_id: storyId, share_type: 'link' })
              });
            }
          } catch (error) {
            console.error('\u5206\u4EAB\u5931\u6557:', error);
            // \u964D\u7D1A\u65B9\u6848\uFF1A\u8907\u88FD\u9023\u7D50
            const shareUrl = window.location.origin + '/story/' + storyId;
            try {
              await navigator.clipboard.writeText(shareUrl);
              if (window.showToast) {
                window.showToast('\u9023\u7D50\u5DF2\u8907\u88FD\u5230\u526A\u8CBC\u677F\uFF01', 'success');
              } else {
                alert('\u9023\u7D50\u5DF2\u8907\u88FD\u5230\u526A\u8CBC\u677F\uFF01');
              }
            } catch (clipboardError) {
              if (window.showToast) {
                window.showToast('\u5206\u4EAB\u529F\u80FD\u66AB\u6642\u7121\u6CD5\u4F7F\u7528\uFF0C\u8ACB\u624B\u52D5\u8907\u88FD\u9023\u7D50', 'warning');
              } else {
                alert('\u5206\u4EAB\u529F\u80FD\u66AB\u6642\u7121\u6CD5\u4F7F\u7528\uFF0C\u8ACB\u624B\u52D5\u8907\u88FD\u9023\u7D50\uFF1A' + shareUrl);
              }
            }
          }
        }
        
        // \u70BA\u6240\u6709\u5206\u4EAB\u6309\u9215\u6DFB\u52A0\u4E8B\u4EF6\u76E3\u807D\u5668\uFF08CSP \u517C\u5BB9\uFF09
        document.addEventListener('DOMContentLoaded', function() {
          const shareButtons = document.querySelectorAll('[data-story-id]');
          shareButtons.forEach(button => {
            button.addEventListener('click', function() {
              const storyId = this.getAttribute('data-story-id');
              const storyTitle = this.closest('.border-l-4').querySelector('.font-semibold')?.textContent || '\u6211\u7684\u6F8E\u6E56\u6545\u4E8B';
              shareStory(storyId, storyTitle);
            });
          });
        });
      </script>
    `;
    return pageTemplate2({
      title: "\u6211\u7684\u6545\u4E8B\u6642\u9593\u7DDA - \u6F8E\u6E56\u6642\u5149\u6A5F",
      content,
      user,
      nonce,
      cssContent
    });
  } catch (error) {
    console.error("[StoryTimeline] Error:", error);
    return new Response("Internal Server Error", { status: 500 });
  }
}

// src/pages/Recommendations.js
init_layout();
init_RecommendationService();
init_LocationService();
async function renderRecommendationsPage(request, env, session, user, nonce, cssContent) {
  if (!user || !user.id) {
    return Response.redirect(new URL(request.url).origin + "/", 302);
  }
  try {
    const recommendationService = new RecommendationService(
      env.DB,
      env.GOOGLE_MAPS_API_KEY
    );
    const locationService = new LocationService(env.DB, env.GOOGLE_MAPS_API_KEY);
    const recommendations = await recommendationService.recommendLocationsByStories(user.id, 12);
    const popularLocations = recommendations.length < 6 ? await recommendationService.getPopularLocations(12 - recommendations.length) : [];
    const translatePlaceTypes3 = (types) => {
      if (!types || !Array.isArray(types))
        return "\u672A\u77E5\u985E\u578B";
      const typeTranslations = {
        "restaurant": "\u9910\u5EF3",
        "cafe": "\u5496\u5561\u5EF3",
        "bar": "\u9152\u5427",
        "bakery": "\u9EB5\u5305\u5E97",
        "food": "\u7F8E\u98DF",
        "lodging": "\u4F4F\u5BBF",
        "hotel": "\u98EF\u5E97",
        "tourist_attraction": "\u89C0\u5149\u666F\u9EDE",
        "museum": "\u535A\u7269\u9928",
        "park": "\u516C\u5712",
        "natural_feature": "\u81EA\u7136\u666F\u89C0",
        "establishment": "\u5834\u6240",
        "point_of_interest": "\u666F\u9EDE"
      };
      return types.map((type) => typeTranslations[type] || type).join(", ");
    };
    const createImagePreview = (src, alt) => {
      const defaultImage = "https://placehold.co/400x268/6B7280/FFFFFF?text=Location+Image";
      const imageUrl = src && src !== "null" && src !== "undefined" ? src : defaultImage;
      return new ImagePreview({
        imageUrl,
        thumbnailUrl: imageUrl,
        alt: alt || "\u5730\u9EDE\u7167\u7247",
        nonce
      }).render();
    };
    const allRecommendations = [...recommendations, ...popularLocations];
    const content = `
      <div class="min-h-screen bg-gray-50">
        <!-- Header -->
        <div class="bg-white shadow-sm border-b">
          <div class="max-w-6xl mx-auto px-4 py-6">
            <h1 class="text-3xl font-bold text-gray-900">\u70BA\u60A8\u63A8\u85A6</h1>
            <p class="text-gray-600 mt-2">\u6839\u64DA\u60A8\u7684\u6545\u4E8B\u548C\u504F\u597D\uFF0C\u70BA\u60A8\u63A8\u85A6\u6F8E\u6E56\u7684\u7CBE\u5F69\u5730\u9EDE</p>
          </div>
        </div>

        <!-- Recommendations -->
        <div class="max-w-6xl mx-auto px-4 py-6">
          ${allRecommendations.length === 0 ? `
            <div class="text-center py-12 bg-white rounded-lg shadow">
              <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" />
              </svg>
              <p class="mt-4 text-gray-500">\u9084\u6C92\u6709\u8DB3\u5920\u7684\u8CC7\u6599\u4F86\u70BA\u60A8\u63A8\u85A6</p>
              <p class="text-sm mt-2 text-gray-400">\u958B\u59CB\u63A2\u7D22\u6F8E\u6E56\uFF0C\u8A18\u9304\u60A8\u7684\u8DB3\u8DE1\uFF0C\u6211\u5011\u6703\u70BA\u60A8\u63A8\u85A6\u66F4\u591A\u7CBE\u5F69\u5730\u9EDE\uFF01</p>
            </div>
          ` : `
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
              ${allRecommendations.map((location) => `
                <div class="bg-white rounded-lg shadow-md overflow-hidden hover:shadow-lg transition-shadow">
                  <div class="aspect-w-16 aspect-h-9 bg-gray-200">
                    ${createImagePreview(
      location.thumbnail_url,
      location.name || "\u5730\u9EDE\u7167\u7247"
    )}
                  </div>
                  <div class="p-4">
                    <h3 class="text-lg font-semibold text-gray-900 mb-2">
                      <a href="/location/${location.id}" class="hover:text-blue-600">
                        ${location.name || "\u672A\u77E5\u5730\u9EDE"}
                      </a>
                    </h3>
                    <p class="text-sm text-gray-600 mb-2">${location.address || ""}</p>
                    ${location.recommendation_reason ? `
                      <div class="mb-2">
                        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                          \u{1F4A1} ${location.recommendation_reason}
                        </span>
                      </div>
                    ` : ""}
                    ${location.recommendation_score ? `
                      <div class="mb-2">
                        <span class="text-xs text-gray-500">\u63A8\u85A6\u5206\u6578: ${location.recommendation_score.toFixed(1)}</span>
                      </div>
                    ` : ""}
                    <div class="flex items-center justify-between mt-3">
                      ${location.google_rating ? `
                        <div class="flex items-center gap-1">
                          <span class="text-yellow-500">\u2B50</span>
                          <span class="text-sm font-medium">${location.google_rating.toFixed(1)}</span>
                          ${location.google_user_ratings_total ? `
                            <span class="text-xs text-gray-500">(${location.google_user_ratings_total})</span>
                          ` : ""}
                        </div>
                      ` : ""}
                      <a href="/location/${location.id}" class="text-blue-600 hover:text-blue-800 text-sm font-medium">
                        \u67E5\u770B\u8A73\u60C5 \u2192
                      </a>
                    </div>
                  </div>
                </div>
              `).join("")}
            </div>
          `}
        </div>
      </div>
      ${ImagePreview.getScript(nonce)}
    `;
    return pageTemplate2({
      title: "\u70BA\u60A8\u63A8\u85A6 - \u6F8E\u6E56\u6642\u5149\u6A5F",
      content,
      user,
      nonce,
      cssContent
    });
  } catch (error) {
    console.error("[Recommendations] Error:", error);
    return new Response("Internal Server Error", { status: 500 });
  }
}

// src/pages/Search.js
init_layout();
init_SearchService();
init_Location();
async function renderSearchPage(request, env, session, user, nonce, cssContent) {
  try {
    const url = new URL(request.url);
    const query = url.searchParams.get("q") || "";
    const sortBy = url.searchParams.get("sort_by") || "relevance";
    const types = url.searchParams.get("types") ? url.searchParams.get("types").split(",") : [];
    const minRating = url.searchParams.get("min_rating") ? parseFloat(url.searchParams.get("min_rating")) : void 0;
    const page = parseInt(url.searchParams.get("page") || "1");
    const limit = 20;
    const offset = (page - 1) * limit;
    const searchService = new SearchService(env.DB);
    const results = await searchService.searchLocations(
      query,
      { types, minRating },
      { sortBy, sortOrder: "DESC" },
      limit,
      offset
    );
    const filters = await searchService.getSearchFilters();
    const popularTerms = await searchService.getPopularSearchTerms(10);
    const translatePlaceTypes3 = (types2) => {
      if (!types2 || !Array.isArray(types2))
        return "\u672A\u77E5\u985E\u578B";
      const typeTranslations = {
        "restaurant": "\u9910\u5EF3",
        "cafe": "\u5496\u5561\u5EF3",
        "bar": "\u9152\u5427",
        "bakery": "\u9EB5\u5305\u5E97",
        "food": "\u7F8E\u98DF",
        "lodging": "\u4F4F\u5BBF",
        "hotel": "\u98EF\u5E97",
        "tourist_attraction": "\u89C0\u5149\u666F\u9EDE",
        "museum": "\u535A\u7269\u9928",
        "park": "\u516C\u5712",
        "natural_feature": "\u81EA\u7136\u666F\u89C0",
        "establishment": "\u5834\u6240",
        "point_of_interest": "\u666F\u9EDE"
      };
      return types2.map((type) => typeTranslations[type] || type).join(", ");
    };
    const createImagePreview = (src, alt) => {
      const defaultImage = "https://placehold.co/400x268/6B7280/FFFFFF?text=Location+Image";
      const imageUrl = src && src !== "null" && src !== "undefined" ? src : defaultImage;
      return new ImagePreview({
        imageUrl,
        thumbnailUrl: imageUrl,
        alt: alt || "\u5730\u9EDE\u7167\u7247",
        nonce
      }).render();
    };
    const content = `
      <div class="min-h-screen bg-gray-50">
        <!-- Header -->
        <div class="bg-white shadow-sm border-b">
          <div class="max-w-6xl mx-auto px-4 py-6">
            <h1 class="text-3xl font-bold text-gray-900 mb-4">\u641C\u5C0B\u5730\u9EDE</h1>
            
            <!-- Search Form -->
            <form method="GET" action="/search" class="mb-4">
              <div class="flex gap-2">
                <input 
                  type="text" 
                  name="q" 
                  value="${query.replace(/"/g, "&quot;")}" 
                  placeholder="\u641C\u5C0B\u5730\u9EDE\u540D\u7A31\u3001\u5730\u5740..." 
                  class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                  autocomplete="off"
                >
                <button 
                  type="submit" 
                  class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors"
                >
                  \u641C\u5C0B
                </button>
              </div>
            </form>

            <!-- Filters -->
            <div class="flex flex-wrap gap-2 mb-4">
              <select name="sort_by" onchange="updateSearch()" class="px-3 py-1 border border-gray-300 rounded text-sm">
                <option value="relevance" ${sortBy === "relevance" ? "selected" : ""}>\u76F8\u95DC\u6027</option>
                <option value="rating" ${sortBy === "rating" ? "selected" : ""}>\u8A55\u5206</option>
                <option value="popularity" ${sortBy === "popularity" ? "selected" : ""}>\u71B1\u9580\u5EA6</option>
                <option value="name" ${sortBy === "name" ? "selected" : ""}>\u540D\u7A31</option>
              </select>
              
              ${minRating !== void 0 ? `
                <input 
                  type="number" 
                  name="min_rating" 
                  value="${minRating}" 
                  min="0" 
                  max="5" 
                  step="0.1" 
                  placeholder="\u6700\u4F4E\u8A55\u5206" 
                  onchange="updateSearch()"
                  class="px-3 py-1 border border-gray-300 rounded text-sm w-24"
                >
              ` : ""}
            </div>

            <!-- Popular Terms -->
            ${!query && popularTerms.length > 0 ? `
              <div class="mt-4">
                <p class="text-sm text-gray-600 mb-2">\u71B1\u9580\u641C\u5C0B\uFF1A</p>
                <div class="flex flex-wrap gap-2">
                  ${popularTerms.map((term) => `
                    <a href="/search?q=${encodeURIComponent(term)}" class="px-3 py-1 bg-gray-100 text-gray-700 rounded-full text-sm hover:bg-gray-200 transition-colors">
                      ${term}
                    </a>
                  `).join("")}
                </div>
              </div>
            ` : ""}
          </div>
        </div>

        <!-- Results -->
        <div class="max-w-6xl mx-auto px-4 py-6">
          ${query ? `
            <div class="mb-4 text-gray-600">
              \u627E\u5230 <strong>${results.total}</strong> \u500B\u7D50\u679C
            </div>
          ` : ""}

          ${results.locations.length === 0 ? `
            <div class="text-center py-12 bg-white rounded-lg shadow">
              <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
              </svg>
              <p class="mt-4 text-gray-500">${query ? "\u6C92\u6709\u627E\u5230\u7B26\u5408\u689D\u4EF6\u7684\u5730\u9EDE" : "\u8ACB\u8F38\u5165\u641C\u5C0B\u95DC\u9375\u5B57"}</p>
            </div>
          ` : `
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
              ${results.locations.map((location) => `
                <div class="bg-white rounded-lg shadow-md overflow-hidden hover:shadow-lg transition-shadow">
                  <div class="aspect-w-16 aspect-h-9 bg-gray-200">
                    ${createImagePreview(
      location.thumbnail_url,
      location.name || "\u5730\u9EDE\u7167\u7247"
    )}
                  </div>
                  <div class="p-4">
                    <h3 class="text-lg font-semibold text-gray-900 mb-2">
                      <a href="/location/${location.id}" class="hover:text-blue-600">
                        ${location.name || "\u672A\u77E5\u5730\u9EDE"}
                      </a>
                    </h3>
                    <p class="text-sm text-gray-600 mb-2">${location.address || ""}</p>
                    <div class="flex items-center justify-between mt-3">
                      ${location.google_rating ? `
                        <div class="flex items-center gap-1">
                          <span class="text-yellow-500">\u2B50</span>
                          <span class="text-sm font-medium">${location.google_rating.toFixed(1)}</span>
                          ${location.google_user_ratings_total ? `
                            <span class="text-xs text-gray-500">(${location.google_user_ratings_total})</span>
                          ` : ""}
                        </div>
                      ` : ""}
                      <a href="/location/${location.id}" class="text-blue-600 hover:text-blue-800 text-sm font-medium">
                        \u67E5\u770B\u8A73\u60C5 \u2192
                      </a>
                    </div>
                  </div>
                </div>
              `).join("")}
            </div>

            <!-- Pagination -->
            ${results.total > limit ? `
              <div class="mt-6 flex justify-center gap-2">
                ${page > 1 ? `
                  <a href="/search?q=${encodeURIComponent(query)}&page=${page - 1}&sort_by=${sortBy}" class="px-4 py-2 bg-white border border-gray-300 rounded-lg hover:bg-gray-50">
                    \u4E0A\u4E00\u9801
                  </a>
                ` : ""}
                <span class="px-4 py-2 text-gray-600">
                  \u7B2C ${page} \u9801\uFF0C\u5171 ${Math.ceil(results.total / limit)} \u9801
                </span>
                ${results.hasMore ? `
                  <a href="/search?q=${encodeURIComponent(query)}&page=${page + 1}&sort_by=${sortBy}" class="px-4 py-2 bg-white border border-gray-300 rounded-lg hover:bg-gray-50">
                    \u4E0B\u4E00\u9801
                  </a>
                ` : ""}
              </div>
            ` : ""}
          `}
        </div>
      </div>

      <script nonce="${nonce}">
        function updateSearch() {
          const form = document.querySelector('form');
          const sortBy = document.querySelector('[name="sort_by"]').value;
          const minRating = document.querySelector('[name="min_rating"]')?.value;
          const query = document.querySelector('[name="q"]').value;
          
          let url = '/search?q=' + encodeURIComponent(query) + '&sort_by=' + sortBy;
          if (minRating) {
            url += '&min_rating=' + minRating;
          }
          
          window.location.href = url;
        }
      </script>
      ${ImagePreview.getScript(nonce)}
    `;
    return pageTemplate2({
      title: query ? `\u641C\u5C0B\u300C${query}\u300D- \u6F8E\u6E56\u6642\u5149\u6A5F` : "\u641C\u5C0B\u5730\u9EDE - \u6F8E\u6E56\u6642\u5149\u6A5F",
      content,
      user,
      nonce,
      cssContent
    });
  } catch (error) {
    console.error("[Search] Error:", error);
    return new Response("Internal Server Error", { status: 500 });
  }
}

// src/pages/Favorites.js
init_layout();
init_FavoritesService();
async function renderFavoritesPage(request, env, session, user, nonce, cssContent) {
  if (!user || !user.id) {
    return Response.redirect(new URL(request.url).origin + "/", 302);
  }
  try {
    const url = new URL(request.url);
    const page = parseInt(url.searchParams.get("page") || "1");
    const limit = 20;
    const offset = (page - 1) * limit;
    const favoritesService = new FavoritesService(env.DB);
    const result = await favoritesService.getUserFavorites(user.id, limit, offset);
    const createImageWithFallback3 = (src, alt, className) => {
      const defaultImage = "https://placehold.co/400x268/6B7280/FFFFFF?text=Location+Image";
      if (!src || src === "null" || src === "undefined") {
        return `<img src="${defaultImage}" alt="${alt || "\u5730\u9EDE\u7167\u7247"}" class="${className}" loading="lazy">`;
      }
      return `<img src="${src}" alt="${alt || "\u5730\u9EDE\u7167\u7247"}" class="${className}" loading="lazy" onerror="this.src='${defaultImage}'">`;
    };
    const content = `
      <div class="min-h-screen bg-gray-50">
        <!-- Header -->
        <div class="bg-white shadow-sm border-b">
          <div class="max-w-6xl mx-auto px-4 py-6">
            <h1 class="text-3xl font-bold text-gray-900">\u6211\u7684\u6536\u85CF</h1>
            <p class="text-gray-600 mt-2">\u60A8\u6536\u85CF\u7684 ${result.total} \u500B\u5730\u9EDE</p>
          </div>
        </div>

        <!-- Favorites List -->
        <div class="max-w-6xl mx-auto px-4 py-6">
          ${result.locations.length === 0 ? `
            <div class="text-center py-12 bg-white rounded-lg shadow">
              <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" />
              </svg>
              <p class="mt-4 text-gray-500">\u9084\u6C92\u6709\u6536\u85CF\u4EFB\u4F55\u5730\u9EDE</p>
              <p class="text-sm mt-2 text-gray-400">\u958B\u59CB\u63A2\u7D22\u6F8E\u6E56\uFF0C\u6536\u85CF\u60A8\u559C\u6B61\u7684\u5730\u9EDE\u5427\uFF01</p>
              <a href="/footprints" class="mt-4 inline-block px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                \u63A2\u7D22\u5730\u9EDE
              </a>
            </div>
          ` : `
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
              ${result.locations.map((location) => `
                <div class="bg-white rounded-lg shadow-md overflow-hidden hover:shadow-lg transition-shadow">
                  <div class="aspect-w-16 aspect-h-9 bg-gray-200">
                    ${createImageWithFallback3(
      location.thumbnail_url,
      location.name,
      "w-full h-48 object-cover"
    )}
                  </div>
                  <div class="p-4">
                    <h3 class="text-lg font-semibold text-gray-900 mb-2">
                      <a href="/location/${location.id}" class="hover:text-blue-600">
                        ${location.name || "\u672A\u77E5\u5730\u9EDE"}
                      </a>
                    </h3>
                    <p class="text-sm text-gray-600 mb-2">${location.address || ""}</p>
                    <div class="flex items-center justify-between mt-3">
                      ${location.google_rating ? `
                        <div class="flex items-center gap-1">
                          <span class="text-yellow-500">\u2B50</span>
                          <span class="text-sm font-medium">${location.google_rating.toFixed(1)}</span>
                          ${location.google_user_ratings_total ? `
                            <span class="text-xs text-gray-500">(${location.google_user_ratings_total})</span>
                          ` : ""}
                        </div>
                      ` : ""}
                      <div class="flex gap-2">
                        <button 
                          class="favorite-btn text-red-500 hover:text-red-700"
                          data-location-id="${location.id}"
                          data-is-favorited="true"
                          title="\u53D6\u6D88\u6536\u85CF"
                        >
                          <svg class="w-5 h-5 fill-current" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z" clip-rule="evenodd" />
                          </svg>
                        </button>
                        <a href="/location/${location.id}" class="text-blue-600 hover:text-blue-800 text-sm font-medium">
                          \u67E5\u770B\u8A73\u60C5 \u2192
                        </a>
                      </div>
                    </div>
                  </div>
                </div>
              `).join("")}
            </div>

            <!-- Pagination -->
            ${result.total > limit ? `
              <div class="mt-6 flex justify-center gap-2">
                ${page > 1 ? `
                  <a href="/favorites?page=${page - 1}" class="px-4 py-2 bg-white border border-gray-300 rounded-lg hover:bg-gray-50">
                    \u4E0A\u4E00\u9801
                  </a>
                ` : ""}
                <span class="px-4 py-2 text-gray-600">
                  \u7B2C ${page} \u9801\uFF0C\u5171 ${Math.ceil(result.total / limit)} \u9801
                </span>
                ${result.hasMore ? `
                  <a href="/favorites?page=${page + 1}" class="px-4 py-2 bg-white border border-gray-300 rounded-lg hover:bg-gray-50">
                    \u4E0B\u4E00\u9801
                  </a>
                ` : ""}
              </div>
            ` : ""}
          `}
        </div>
      </div>

      <script nonce="${nonce}">
        // \u6536\u85CF\u6309\u9215\u529F\u80FD
        document.addEventListener('DOMContentLoaded', function() {
          const favoriteButtons = document.querySelectorAll('.favorite-btn');
          
          favoriteButtons.forEach(button => {
            button.addEventListener('click', async function() {
              const locationId = this.getAttribute('data-location-id');
              const isFavorited = this.getAttribute('data-is-favorited') === 'true';
              
              try {
                const response = await fetch('/api/favorites/toggle', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  credentials: 'include',
                  body: JSON.stringify({ location_id: locationId })
                });
                
                const data = await response.json();
                
                if (data.success) {
                  // \u66F4\u65B0\u6309\u9215\u72C0\u614B
                  if (data.is_favorited) {
                    this.setAttribute('data-is-favorited', 'true');
                    this.classList.add('text-red-500');
                    this.classList.remove('text-gray-400');
                    this.setAttribute('title', '\u53D6\u6D88\u6536\u85CF');
                    if (window.showToast) {
                      window.showToast('\u5DF2\u6536\u85CF\uFF01', 'success');
                    }
                  } else {
                    this.setAttribute('data-is-favorited', 'false');
                    this.classList.remove('text-red-500');
                    this.classList.add('text-gray-400');
                    this.setAttribute('title', '\u52A0\u5165\u6536\u85CF');
                    
                    // \u5982\u679C\u4E0D\u5728\u6536\u85CF\u9801\u9762\uFF0C\u79FB\u9664\u5361\u7247
                    if (window.location.pathname === '/favorites') {
                      this.closest('.bg-white.rounded-lg').remove();
                    }
                    if (window.showToast) {
                      window.showToast('\u5DF2\u53D6\u6D88\u6536\u85CF', 'success');
                    }
                  }
                } else {
                  if (window.showToast) {
                    window.showToast('\u64CD\u4F5C\u5931\u6557\uFF1A' + (data.error || '\u672A\u77E5\u932F\u8AA4'), 'error');
                  } else {
                    alert('\u64CD\u4F5C\u5931\u6557\uFF1A' + (data.error || '\u672A\u77E5\u932F\u8AA4'));
                  }
                }
              } catch (error) {
                console.error('\u6536\u85CF\u64CD\u4F5C\u5931\u6557:', error);
                if (window.showToast) {
                  window.showToast('\u64CD\u4F5C\u5931\u6557\uFF0C\u8ACB\u7A0D\u5F8C\u518D\u8A66', 'error');
                } else {
                  alert('\u64CD\u4F5C\u5931\u6557\uFF0C\u8ACB\u7A0D\u5F8C\u518D\u8A66');
                }
              }
            });
          });
        });
      </script>
    `;
    return pageTemplate2({
      title: "\u6211\u7684\u6536\u85CF - \u6F8E\u6E56\u6642\u5149\u6A5F",
      content,
      user,
      nonce,
      cssContent
    });
  } catch (error) {
    console.error("[Favorites] Error:", error);
    return new Response("Internal Server Error", { status: 500 });
  }
}

// src/pages/LocationDetail.js
init_layout();
init_LocationModule();
init_FavoritesService();
init_BusinessVerificationService();

// src/services/LocationDetailService.js
var LocationDetailService = class {
  constructor(db) {
    if (!db) {
      throw new Error("Database connection is required for LocationDetailService");
    }
    this.db = db;
  }
  /**
   * 批量獲取地點詳情所需的所有數據
   * 這將多個查詢合併為更少的查詢，提高性能
   * 
   * @param {string} locationId - 地點 ID
   * @param {string|null} userId - 用戶 ID（可選）
   * @returns {Promise<object>} 包含所有地點詳情數據的對象
   */
  async getLocationDetailData(locationId, userId = null) {
    try {
      const [
        locationResult,
        favoriteData,
        ratingData,
        commentsResult
      ] = await Promise.all([
        // 1. 獲取地點基本信息
        this.db.prepare(
          `SELECT * FROM locations WHERE id = ?`
        ).bind(locationId).first(),
        // 2. 獲取收藏數據（收藏數量和用戶是否收藏）
        userId ? this.db.prepare(
          `SELECT 
                COUNT(*) as total_favorites,
                MAX(CASE WHEN user_id = ? THEN 1 ELSE 0 END) as is_favorited
              FROM location_favorites
              WHERE location_id = ?`
        ).bind(userId, locationId).first() : this.db.prepare(
          `SELECT COUNT(*) as total_favorites, 0 as is_favorited
               FROM location_favorites
               WHERE location_id = ?`
        ).bind(locationId).first(),
        // 3. 獲取評分數據（平均評分、總評分數、評分分布、用戶評分）
        userId ? this.db.prepare(
          `SELECT 
                AVG(rating) as average_rating,
                COUNT(*) as rating_count,
                COUNT(CASE WHEN rating = 5 THEN 1 END) as five_star,
                COUNT(CASE WHEN rating = 4 THEN 1 END) as four_star,
                COUNT(CASE WHEN rating = 3 THEN 1 END) as three_star,
                COUNT(CASE WHEN rating = 2 THEN 1 END) as two_star,
                COUNT(CASE WHEN rating = 1 THEN 1 END) as one_star,
                MAX(CASE WHEN user_id = ? THEN rating ELSE NULL END) as user_rating,
                MAX(CASE WHEN user_id = ? THEN comment ELSE NULL END) as user_rating_comment
              FROM location_ratings
              WHERE location_id = ?`
        ).bind(userId, userId, locationId).first() : this.db.prepare(
          `SELECT 
                AVG(rating) as average_rating,
                COUNT(*) as rating_count,
                COUNT(CASE WHEN rating = 5 THEN 1 END) as five_star,
                COUNT(CASE WHEN rating = 4 THEN 1 END) as four_star,
                COUNT(CASE WHEN rating = 3 THEN 1 END) as three_star,
                COUNT(CASE WHEN rating = 2 THEN 1 END) as two_star,
                COUNT(CASE WHEN rating = 1 THEN 1 END) as one_star,
                NULL as user_rating,
                NULL as user_rating_comment
              FROM location_ratings
              WHERE location_id = ?`
        ).bind(locationId).first(),
        // 4. 獲取評論（前10條）
        this.db.prepare(
          `SELECT 
            lc.*,
            u.name as user_name,
            u.email as user_email,
            u.avatar_url as user_avatar
          FROM location_comments lc
          LEFT JOIN users u ON lc.user_id = u.id
          WHERE lc.location_id = ?
          ORDER BY lc.created_at DESC
          LIMIT 10`
        ).bind(locationId).all()
      ]);
      const location = locationResult;
      const favoriteCount = (favoriteData == null ? void 0 : favoriteData.total_favorites) || 0;
      const isFavorited = ((favoriteData == null ? void 0 : favoriteData.is_favorited) || 0) === 1;
      const ratingInfo = {
        average: (ratingData == null ? void 0 : ratingData.average_rating) ? parseFloat(ratingData.average_rating).toFixed(1) : null,
        total: (ratingData == null ? void 0 : ratingData.total_ratings) || 0,
        userRating: (ratingData == null ? void 0 : ratingData.user_rating) || null
      };
      const comments = ((commentsResult == null ? void 0 : commentsResult.results) || []).map((comment) => ({
        id: comment.id,
        content: comment.content,
        created_at: comment.created_at,
        user_name: comment.user_name || comment.user_email || "\u533F\u540D\u7528\u6236",
        user_avatar: comment.user_avatar
      }));
      return {
        location,
        favoriteCount,
        isFavorited,
        ratingInfo,
        comments
      };
    } catch (error) {
      console.error("[LocationDetailService] Error getting location detail data:", error);
      throw error;
    }
  }
  /**
   * 批量獲取驗證相關數據
   * @param {string} locationId - 地點 ID
   * @param {string|null} userId - 用戶 ID（可選）
   * @returns {Promise<object>} 驗證相關數據
   */
  async getVerificationData(locationId, userId = null) {
    try {
      if (!userId) {
        const verificationStatus2 = await this.db.prepare(
          `SELECT 
            COUNT(CASE WHEN status = 'approved' THEN 1 END) as approved_count,
            COUNT(CASE WHEN status = 'pending' THEN 1 END) as pending_count,
            COUNT(*) as total_verifications
          FROM business_verifications
          WHERE location_id = ?`
        ).bind(locationId).first();
        return {
          verificationStatus: {
            approved: ((verificationStatus2 == null ? void 0 : verificationStatus2.approved_count) || 0) > 0,
            pending: ((verificationStatus2 == null ? void 0 : verificationStatus2.pending_count) || 0) > 0,
            total: (verificationStatus2 == null ? void 0 : verificationStatus2.total_verifications) || 0
          },
          userVerification: null,
          isUserVerified: false
        };
      }
      const [
        verificationStatus,
        userVerifications,
        isUserVerifiedResult
      ] = await Promise.all([
        // 地點的驗證狀態
        this.db.prepare(
          `SELECT 
            COUNT(CASE WHEN status = 'approved' THEN 1 END) as approved_count,
            COUNT(CASE WHEN status = 'pending' THEN 1 END) as pending_count,
            COUNT(*) as total_verifications
          FROM business_verifications
          WHERE location_id = ?`
        ).bind(locationId).first(),
        // 用戶的所有驗證申請
        this.db.prepare(
          `SELECT * FROM business_verifications
           WHERE user_id = ?`
        ).bind(userId).all(),
        // 用戶是否已驗證此地點
        this.db.prepare(
          `SELECT 1 FROM business_verifications
           WHERE user_id = ? AND location_id = ? AND status = 'approved'
           LIMIT 1`
        ).bind(userId, locationId).first()
      ]);
      const userVerification = ((userVerifications == null ? void 0 : userVerifications.results) || []).find(
        (v) => v.location_id === locationId
      ) || null;
      return {
        verificationStatus: {
          approved: ((verificationStatus == null ? void 0 : verificationStatus.approved_count) || 0) > 0,
          pending: ((verificationStatus == null ? void 0 : verificationStatus.pending_count) || 0) > 0,
          total: (verificationStatus == null ? void 0 : verificationStatus.total_verifications) || 0
        },
        userVerification,
        isUserVerified: !!isUserVerifiedResult
      };
    } catch (error) {
      console.error("[LocationDetailService] Error getting verification data:", error);
      throw error;
    }
  }
};

// src/components/RatingComponent.js
var RatingComponent = class {
  constructor(options = {}) {
    this.locationId = options.locationId;
    this.userRating = options.userRating || null;
    this.averageRating = options.averageRating || null;
    this.ratingCount = options.ratingCount || 0;
    this.ratingDistribution = options.ratingDistribution || { 5: 0, 4: 0, 3: 0, 2: 0, 1: 0 };
    this.onRatingChange = options.onRatingChange || null;
    this.nonce = options.nonce || "";
  }
  /**
   * 渲染評分組件
   * @returns {string} HTML 字串
   */
  render() {
    return `
      <div class="rating-component border-t border-gray-200 pt-6 mt-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">\u8A55\u5206\u8207\u8A55\u8AD6</h3>
        
        <!-- \u5E73\u5747\u8A55\u5206\u986F\u793A -->
        ${this.renderAverageRating()}
        
        <!-- \u8A55\u5206\u5206\u4F48 -->
        ${this.ratingCount > 0 ? this.renderRatingDistribution() : ""}
        
        <!-- \u7528\u6236\u8A55\u5206 -->
        ${this.renderUserRating()}
      </div>
    `;
  }
  /**
   * 渲染平均評分
   * @returns {string}
   */
  renderAverageRating() {
    var _a;
    if (!this.averageRating && this.ratingCount === 0) {
      return `
        <div class="mb-4">
          <p class="text-gray-600">\u9084\u6C92\u6709\u8A55\u5206</p>
          <p class="text-sm text-gray-500 mt-1">\u6210\u70BA\u7B2C\u4E00\u500B\u8A55\u5206\u7684\u4EBA\u5427\uFF01</p>
        </div>
      `;
    }
    return `
      <div class="mb-4 flex items-center gap-4">
        <div class="text-center">
          <div class="text-4xl font-bold text-gray-900">${((_a = this.averageRating) == null ? void 0 : _a.toFixed(1)) || "0.0"}</div>
          <div class="flex items-center justify-center mt-1 gap-1">
            ${this.renderStars(this.averageRating, false)}
          </div>
          <div class="text-sm text-gray-500 mt-1">${this.ratingCount} \u500B\u8A55\u5206</div>
        </div>
      </div>
    `;
  }
  /**
   * 渲染評分分佈
   * @returns {string}
   */
  renderRatingDistribution() {
    const maxCount = Math.max(...Object.values(this.ratingDistribution));
    return `
      <div class="mb-4">
        <h4 class="text-sm font-medium text-gray-700 mb-2">\u8A55\u5206\u5206\u4F48</h4>
        <div class="space-y-2">
          ${[5, 4, 3, 2, 1].map((rating) => {
      const count = this.ratingDistribution[rating] || 0;
      const percentage = maxCount > 0 ? count / maxCount * 100 : 0;
      return `
              <div class="flex items-center gap-2">
                <span class="text-sm text-gray-600 w-8">${rating} \u661F</span>
                <div class="flex-1 bg-gray-200 rounded-full h-2">
                  <div class="bg-yellow-400 h-2 rounded-full" style="width: ${percentage}%"></div>
                </div>
                <span class="text-sm text-gray-500 w-12 text-right">${count}</span>
              </div>
            `;
    }).join("")}
        </div>
      </div>
    `;
  }
  /**
   * 渲染用戶評分
   * @returns {string}
   */
  renderUserRating() {
    return `
      <div class="mb-4">
        <h4 class="text-sm font-medium text-gray-700 mb-2">\u6211\u7684\u8A55\u5206</h4>
        <div class="flex items-center gap-3">
          <div class="flex gap-1" id="rating-stars-${this.locationId}">
            ${[1, 2, 3, 4, 5].map((star) => `
              <button 
                class="rating-star-btn text-2xl transition-all duration-200 ${this.getStarClass(star)}"
                data-rating="${star}"
                data-location-id="${this.locationId}"
                title="${star} \u661F"
                aria-label="${star} \u661F\u8A55\u5206"
              >
                \u2605
              </button>
            `).join("")}
          </div>
          ${this.userRating ? `
            <span class="text-sm text-gray-600 font-medium">\u60A8\u7D66\u4E86 ${this.userRating.rating} \u661F</span>
          ` : `
            <span class="text-sm text-gray-500">\u9EDE\u64CA\u661F\u661F\u9032\u884C\u8A55\u5206</span>
          `}
        </div>
        ${this.userRating && this.userRating.comment ? `
          <div class="mt-2 p-3 bg-gray-50 rounded-lg border border-gray-200">
            <p class="text-sm text-gray-700">${this.userRating.comment.replace(/</g, "&lt;").replace(/>/g, "&gt;")}</p>
          </div>
        ` : ""}
      </div>
    `;
  }
  /**
   * 渲染星星（用於顯示平均評分）
   * @param {number} rating - 評分
   * @param {boolean} interactive - 是否可互動
   * @returns {string}
   */
  renderStars(rating, interactive = false) {
    const fullStars = Math.floor(rating);
    const hasHalfStar = rating % 1 >= 0.5;
    const emptyStars = 5 - fullStars - (hasHalfStar ? 1 : 0);
    let stars = "";
    for (let i = 0; i < fullStars; i++) {
      stars += '<span class="text-yellow-400 text-xl">\u2605</span>';
    }
    if (hasHalfStar) {
      stars += '<span class="text-yellow-400 opacity-50 text-xl">\u2605</span>';
    }
    for (let i = 0; i < emptyStars; i++) {
      stars += '<span class="text-gray-300 text-xl">\u2605</span>';
    }
    return stars;
  }
  /**
   * 獲取星星的 CSS 類別
   * @param {number} star - 星星編號（1-5）
   * @returns {string}
   */
  getStarClass(star) {
    if (!this.userRating) {
      return "text-gray-300 hover:text-yellow-400";
    }
    return star <= this.userRating.rating ? "text-yellow-400" : "text-gray-300 hover:text-yellow-400";
  }
  /**
   * 獲取評分組件的 JavaScript 代碼
   * @returns {string}
   */
  getScript() {
    return `
      <script nonce="${this.nonce}">
        // \u8A55\u5206\u529F\u80FD
        document.addEventListener('DOMContentLoaded', function() {
          const ratingButtons = document.querySelectorAll('.rating-star-btn[data-location-id="${this.locationId}"]');
          
          ratingButtons.forEach(button => {
            button.addEventListener('click', async function() {
              const rating = parseInt(this.getAttribute('data-rating'));
              const locationId = this.getAttribute('data-location-id');
              
              try {
                const response = await fetch('/api/favorites/rating', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  credentials: 'include',
                  body: JSON.stringify({
                    location_id: locationId,
                    rating: rating
                  })
                });
                
                const data = await response.json();
                
                if (data.success) {
                  // \u66F4\u65B0\u661F\u661F\u986F\u793A
                  const allStars = document.querySelectorAll('.rating-star-btn[data-location-id="' + locationId + '"]');
                  allStars.forEach((star, index) => {
                    if (index < rating) {
                      star.classList.remove('text-gray-300');
                      star.classList.add('text-yellow-400');
                    } else {
                      star.classList.remove('text-yellow-400');
                      star.classList.add('text-gray-300');
                    }
                  });
                  
                  // \u91CD\u65B0\u8F09\u5165\u8A55\u5206\u8CC7\u8A0A
                  if (window.loadLocationRating) {
                    await window.loadLocationRating(locationId);
                  }
                  
                  // \u986F\u793A\u6210\u529F\u8A0A\u606F
                  if (window.showToast) {
                    window.showToast('\u8A55\u5206\u5DF2\u66F4\u65B0', 'success');
                  } else if (window.showNotification) {
                    window.showNotification('\u8A55\u5206\u5DF2\u66F4\u65B0', 'success');
                  } else {
                    alert('\u8A55\u5206\u5DF2\u66F4\u65B0');
                  }
                } else {
                  if (window.showToast) {
                    window.showToast('\u8A55\u5206\u5931\u6557\uFF1A' + (data.error || '\u672A\u77E5\u932F\u8AA4'), 'error');
                  } else {
                    alert('\u8A55\u5206\u5931\u6557\uFF1A' + (data.error || '\u672A\u77E5\u932F\u8AA4'));
                  }
                }
              } catch (error) {
                console.error('\u8A55\u5206\u64CD\u4F5C\u5931\u6557:', error);
                if (window.showToast) {
                  window.showToast('\u8A55\u5206\u5931\u6557\uFF0C\u8ACB\u7A0D\u5F8C\u518D\u8A66', 'error');
                } else {
                  alert('\u8A55\u5206\u5931\u6557\uFF0C\u8ACB\u7A0D\u5F8C\u518D\u8A66');
                }
              }
            });
            
            // \u61F8\u505C\u6548\u679C
            button.addEventListener('mouseenter', function() {
              const rating = parseInt(this.getAttribute('data-rating'));
              const allStars = document.querySelectorAll('.rating-star-btn[data-location-id="' + this.getAttribute('data-location-id') + '"]');
              allStars.forEach((star, index) => {
                if (index < rating) {
                  star.classList.add('text-yellow-400');
                  star.classList.remove('text-gray-300');
                }
              });
            });
            
            button.addEventListener('mouseleave', function() {
              const locationId = this.getAttribute('data-location-id');
              const userRating = ${this.userRating ? this.userRating.rating : "null"};
              const allStars = document.querySelectorAll('.rating-star-btn[data-location-id="' + locationId + '"]');
              allStars.forEach((star, index) => {
                if (userRating && index < userRating) {
                  star.classList.add('text-yellow-400');
                  star.classList.remove('text-gray-300');
                } else {
                  star.classList.remove('text-yellow-400');
                  star.classList.add('text-gray-300');
                }
              });
            });
          });
        });
      </script>
    `;
  }
};

// src/components/CommentsComponent.js
var CommentsComponent = class {
  constructor(options = {}) {
    this.locationId = options.locationId;
    this.comments = options.comments || [];
    this.total = options.total || 0;
    this.limit = options.limit || 20;
    this.offset = options.offset || 0;
    this.hasMore = options.hasMore || false;
    this.onCommentAdded = options.onCommentAdded || null;
    this.nonce = options.nonce || "";
  }
  /**
   * 渲染評論組件
   * @returns {string} HTML 字串
   */
  render() {
    return `
      <div class="comments-component border-t border-gray-200 pt-6 mt-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">
          \u8A55\u8AD6 (${this.total})
        </h3>
        
        <!-- \u6DFB\u52A0\u8A55\u8AD6\u8868\u55AE -->
        ${this.renderCommentForm()}
        
        <!-- \u8A55\u8AD6\u5217\u8868 -->
        ${this.renderCommentsList()}
        
        <!-- \u8F09\u5165\u66F4\u591A -->
        ${this.hasMore ? this.renderLoadMore() : ""}
      </div>
    `;
  }
  /**
   * 渲染評論表單
   * @returns {string}
   */
  renderCommentForm() {
    return `
      <div class="mb-6 bg-gray-50 rounded-lg p-4">
        <h4 class="text-sm font-medium text-gray-700 mb-3">\u767C\u8868\u8A55\u8AD6</h4>
        <form id="comment-form-${this.locationId}" class="space-y-3">
          <textarea 
            id="comment-content-${this.locationId}"
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all"
            rows="3"
            placeholder="\u5206\u4EAB\u60A8\u5C0D\u9019\u500B\u5730\u9EDE\u7684\u60F3\u6CD5\u3001\u9AD4\u9A57\u6216\u5EFA\u8B70..."
            required
          ></textarea>
          <div class="flex justify-between items-center">
            <span class="text-xs text-gray-500">\u60A8\u7684\u8A55\u8AD6\u5C07\u516C\u958B\u986F\u793A</span>
            <button 
              type="submit"
              class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-medium shadow-sm hover:shadow-md"
            >
              \u767C\u5E03\u8A55\u8AD6
            </button>
          </div>
        </form>
      </div>
    `;
  }
  /**
   * 渲染評論列表
   * @returns {string}
   */
  renderCommentsList() {
    if (this.comments.length === 0) {
      return `
        <div class="text-center py-8 text-gray-500">
          <p>\u9084\u6C92\u6709\u8A55\u8AD6</p>
          <p class="text-sm mt-2">\u6210\u70BA\u7B2C\u4E00\u500B\u8A55\u8AD6\u7684\u4EBA\u5427\uFF01</p>
        </div>
      `;
    }
    return `
      <div class="space-y-4">
        ${this.comments.map((comment) => this.renderComment(comment)).join("")}
      </div>
    `;
  }
  /**
   * 渲染單個評論
   * @param {object} comment - 評論物件
   * @returns {string}
   */
  renderComment(comment) {
    const formatTime = (timeString) => {
      if (!timeString)
        return "\u672A\u77E5\u6642\u9593";
      const date = new Date(timeString);
      const now = /* @__PURE__ */ new Date();
      const diffMs = now.getTime() - date.getTime();
      const diffSeconds = Math.floor(diffMs / 1e3);
      const diffMinutes = Math.floor(diffSeconds / 60);
      const diffHours = Math.floor(diffMinutes / 60);
      const diffDays = Math.floor(diffHours / 24);
      if (diffSeconds < 60)
        return "\u525B\u525B";
      if (diffMinutes < 60)
        return `${diffMinutes} \u5206\u9418\u524D`;
      if (diffHours < 24)
        return `${diffHours} \u5C0F\u6642\u524D`;
      if (diffDays === 0)
        return "\u4ECA\u5929";
      if (diffDays === 1)
        return "\u6628\u5929";
      if (diffDays < 7)
        return `${diffDays} \u5929\u524D`;
      if (diffDays < 30)
        return `${Math.floor(diffDays / 7)} \u9031\u524D`;
      if (diffDays < 365)
        return `${Math.floor(diffDays / 30)} \u500B\u6708\u524D`;
      return `${Math.floor(diffDays / 365)} \u5E74\u524D`;
    };
    return `
      <div class="comment-item bg-white border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow">
        <div class="flex items-start gap-3">
          ${comment.userAvatarUrl ? `
            <img 
              src="${comment.userAvatarUrl}" 
              alt="${comment.userName || "\u7528\u6236"}"
              class="w-10 h-10 rounded-full object-cover flex-shrink-0"
            >
          ` : `
            <div class="w-10 h-10 rounded-full bg-gradient-to-br from-blue-400 to-purple-500 flex items-center justify-center flex-shrink-0">
              <span class="text-white text-sm font-medium">${(comment.userName || "\u7528")[0].toUpperCase()}</span>
            </div>
          `}
          <div class="flex-1 min-w-0">
            <div class="flex items-center gap-2 mb-2">
              <span class="font-medium text-gray-900">${comment.userName || "\u533F\u540D\u7528\u6236"}</span>
              <span class="text-xs text-gray-500">${formatTime(comment.createdAt)}</span>
            </div>
            <p class="text-gray-700 whitespace-pre-wrap leading-relaxed">${comment.content.replace(/</g, "&lt;").replace(/>/g, "&gt;")}</p>
          </div>
        </div>
      </div>
    `;
  }
  /**
   * 渲染載入更多按鈕
   * @returns {string}
   */
  renderLoadMore() {
    return `
      <div class="mt-4 text-center">
        <button 
          id="load-more-comments-${this.locationId}"
          class="px-4 py-2 text-blue-600 hover:text-blue-800 border border-blue-600 rounded-lg hover:bg-blue-50 transition-colors"
        >
          \u8F09\u5165\u66F4\u591A\u8A55\u8AD6
        </button>
      </div>
    `;
  }
  /**
   * 獲取評論組件的 JavaScript 代碼
   * @returns {string}
   */
  getScript() {
    return `
      <script nonce="${this.nonce}">
        // \u8A55\u8AD6\u529F\u80FD
        document.addEventListener('DOMContentLoaded', function() {
          const commentForm = document.getElementById('comment-form-${this.locationId}');
          const commentContent = document.getElementById('comment-content-${this.locationId}');
          const loadMoreBtn = document.getElementById('load-more-comments-${this.locationId}');
          
          // \u63D0\u4EA4\u8A55\u8AD6
          if (commentForm) {
            commentForm.addEventListener('submit', async function(e) {
              e.preventDefault();
              
              const content = commentContent.value.trim();
              if (!content) {
                if (window.showToast) {
                  window.showToast('\u8ACB\u8F38\u5165\u8A55\u8AD6\u5167\u5BB9', 'warning');
                } else {
                  alert('\u8ACB\u8F38\u5165\u8A55\u8AD6\u5167\u5BB9');
                }
                return;
              }
              
              try {
                const response = await fetch('/api/favorites/comment', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  credentials: 'include',
                  body: JSON.stringify({
                    location_id: '${this.locationId}',
                    content: content
                  })
                });
                
                const data = await response.json();
                
                if (data.success) {
                  // \u6E05\u7A7A\u8868\u55AE
                  commentContent.value = '';
                  
                  // \u91CD\u65B0\u8F09\u5165\u8A55\u8AD6
                  if (window.loadLocationComments) {
                    await window.loadLocationComments('${this.locationId}');
                  } else {
                    location.reload();
                  }
                  
                  // \u986F\u793A\u6210\u529F\u8A0A\u606F
                  if (window.showToast) {
                    window.showToast('\u8A55\u8AD6\u5DF2\u767C\u5E03', 'success');
                  } else if (window.showNotification) {
                    window.showNotification('\u8A55\u8AD6\u5DF2\u767C\u5E03', 'success');
                  } else {
                    alert('\u8A55\u8AD6\u5DF2\u767C\u5E03');
                  }
                } else {
                  if (window.showToast) {
                    window.showToast('\u767C\u5E03\u5931\u6557\uFF1A' + (data.error || '\u672A\u77E5\u932F\u8AA4'), 'error');
                  } else {
                    alert('\u767C\u5E03\u5931\u6557\uFF1A' + (data.error || '\u672A\u77E5\u932F\u8AA4'));
                  }
                }
              } catch (error) {
                console.error('\u8A55\u8AD6\u767C\u5E03\u5931\u6557:', error);
                if (window.showToast) {
                  window.showToast('\u767C\u5E03\u5931\u6557\uFF0C\u8ACB\u7A0D\u5F8C\u518D\u8A66', 'error');
                } else {
                  alert('\u767C\u5E03\u5931\u6557\uFF0C\u8ACB\u7A0D\u5F8C\u518D\u8A66');
                }
              }
            });
          }
          
          // \u8F09\u5165\u66F4\u591A\u8A55\u8AD6
          if (loadMoreBtn) {
            loadMoreBtn.addEventListener('click', async function() {
              // \u52D5\u614B\u8A08\u7B97 offset
              let currentOffset = parseInt(this.getAttribute('data-offset'));
              if (isNaN(currentOffset)) {
                currentOffset = ${this.offset} + ${this.limit};
              }
              
              try {
                const response = await fetch('/api/favorites/comments?location_id=${this.locationId}&limit=${this.limit}&offset=' + currentOffset);
                const data = await response.json();
                
                if (data.success && data.comments.length > 0) {
                  // \u6DFB\u52A0\u65B0\u8A55\u8AD6\u5230\u5217\u8868
                  const commentsContainer = loadMoreBtn.closest('.comments-component').querySelector('.space-y-4');
                  data.comments.forEach(comment => {
                    const commentHtml = renderCommentItem(comment);
                    commentsContainer.insertAdjacentHTML('beforeend', commentHtml);
                  });
                  
                  // \u66F4\u65B0\u8F09\u5165\u66F4\u591A\u6309\u9215
                  if (!data.hasMore) {
                    loadMoreBtn.remove();
                  } else {
                    // \u66F4\u65B0\u4E0B\u4E00\u6B21\u7684 offset
                    this.setAttribute('data-offset', currentOffset + ${this.limit});
                  }
                } else {
                  loadMoreBtn.remove();
                }
              } catch (error) {
                console.error('\u8F09\u5165\u8A55\u8AD6\u5931\u6557:', error);
                if (window.showToast) {
                  window.showToast('\u8F09\u5165\u5931\u6557\uFF0C\u8ACB\u7A0D\u5F8C\u518D\u8A66', 'error');
                } else {
                  alert('\u8F09\u5165\u5931\u6557\uFF0C\u8ACB\u7A0D\u5F8C\u518D\u8A66');
                }
              }
            });
          }
          
          // \u6E32\u67D3\u55AE\u500B\u8A55\u8AD6\u7684\u8F14\u52A9\u51FD\u6578
          function renderCommentItem(comment) {
            const formatTime = (timeString) => {
              if (!timeString) return '\u672A\u77E5\u6642\u9593';
              const date = new Date(timeString);
              const now = new Date();
              const diffMs = now.getTime() - date.getTime();
              const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
              
              if (diffDays === 0) return '\u4ECA\u5929';
              if (diffDays === 1) return '\u6628\u5929';
              if (diffDays < 7) return diffDays + ' \u5929\u524D';
              if (diffDays < 30) return Math.floor(diffDays / 7) + ' \u9031\u524D';
              if (diffDays < 365) return Math.floor(diffDays / 30) + ' \u500B\u6708\u524D';
              return Math.floor(diffDays / 365) + ' \u5E74\u524D';
            };
            
            return '<div class="comment-item bg-gray-50 rounded-lg p-4">' +
              '<div class="flex items-start gap-3">' +
              (comment.userAvatarUrl ? 
                '<img src="' + comment.userAvatarUrl + '" alt="' + (comment.userName || '\u7528\u6236') + '" class="w-10 h-10 rounded-full object-cover">' :
                '<div class="w-10 h-10 rounded-full bg-gray-300 flex items-center justify-center"><span class="text-gray-600 text-sm">' + (comment.userName || '\u7528')[0] + '</span></div>'
              ) +
              '<div class="flex-1">' +
              '<div class="flex items-center gap-2 mb-1">' +
              '<span class="font-medium text-gray-900">' + (comment.userName || '\u533F\u540D\u7528\u6236') + '</span>' +
              '<span class="text-xs text-gray-500">' + formatTime(comment.createdAt) + '</span>' +
              '</div>' +
              '<p class="text-gray-700 whitespace-pre-wrap">' + comment.content.replace(/</g, '&lt;').replace(/>/g, '&gt;') + '</p>' +
              '</div>' +
              '</div>' +
              '</div>';
          }
        });
      </script>
    `;
  }
};

// src/pages/LocationDetail.js
async function _renderLocationDetailPage(request, env, session, user, nonce, cssContent) {
  const dbHealth = await ServiceHealthChecker.checkDatabase(env.DB);
  if (!dbHealth.healthy) {
    console.error("[LocationDetail] Database not available:", dbHealth.error);
    return ErrorResponseBuilder.buildDatabaseErrorPage({
      user,
      nonce,
      cssContent
    });
  }
  try {
    const url = new URL(request.url);
    const pathParts = url.pathname.split("/");
    const locationId = pathParts[pathParts.length - 1];
    if (!locationId) {
      return Response.redirect(new URL(request.url).origin + "/footprints", 302);
    }
    const locationModule = new LocationModule(env.DB, env.GOOGLE_MAPS_API_KEY);
    const locationDetailService = new LocationDetailService(env.DB);
    const verificationService = new BusinessVerificationService(env.DB);
    const [detailData, verificationData] = await Promise.all([
      locationDetailService.getLocationDetailData(locationId, (user == null ? void 0 : user.id) || null),
      locationDetailService.getVerificationData(locationId, (user == null ? void 0 : user.id) || null)
    ]);
    const location = detailData.location;
    if (!location) {
      return new Response("Location not found", { status: 404 });
    }
    const locationObj = locationModule.getLocationById ? await locationModule.getLocationById(locationId, (user == null ? void 0 : user.id) || null) : location;
    const isFavorited = detailData.isFavorited;
    const favoriteCount = detailData.favoriteCount;
    const ratingInfo = detailData.ratingInfo;
    const userRating = ratingInfo.userRating;
    const commentsResult = {
      comments: detailData.comments,
      total: detailData.comments.length
      // 這裡可以改進為獲取總數
    };
    const verificationStatus = verificationData.verificationStatus;
    const userVerification = verificationData.userVerification;
    const isUserVerified = verificationData.isUserVerified;
    const ratingComponent = new RatingComponent({
      locationId,
      userRating,
      averageRating: ratingInfo.averageRating,
      ratingCount: ratingInfo.ratingCount,
      ratingDistribution: ratingInfo.distribution,
      nonce
    });
    const commentsComponent = new CommentsComponent({
      locationId,
      comments: commentsResult.comments,
      total: commentsResult.total,
      limit: commentsResult.limit,
      offset: commentsResult.offset,
      hasMore: commentsResult.hasMore,
      nonce
    });
    const translatePlaceTypes3 = (types) => {
      if (!types || !Array.isArray(types))
        return "\u672A\u77E5\u985E\u578B";
      const typeTranslations = {
        "restaurant": "\u9910\u5EF3",
        "cafe": "\u5496\u5561\u5EF3",
        "bar": "\u9152\u5427",
        "bakery": "\u9EB5\u5305\u5E97",
        "food": "\u7F8E\u98DF",
        "lodging": "\u4F4F\u5BBF",
        "hotel": "\u98EF\u5E97",
        "tourist_attraction": "\u89C0\u5149\u666F\u9EDE",
        "museum": "\u535A\u7269\u9928",
        "park": "\u516C\u5712",
        "natural_feature": "\u81EA\u7136\u666F\u89C0",
        "establishment": "\u5834\u6240",
        "point_of_interest": "\u666F\u9EDE"
      };
      return types.map((type) => typeTranslations[type] || type).join(", ");
    };
    const locationTypes = location.googleTypes ? Array.isArray(location.googleTypes) ? location.googleTypes : JSON.parse(location.googleTypes || "[]") : [];
    const content = `
      <div class="min-h-screen bg-gray-50">
        <!-- Header -->
        <div class="bg-white shadow-sm border-b">
          <div class="max-w-4xl mx-auto px-4 py-4">
            <a href="/footprints" class="text-blue-600 hover:text-blue-800 text-sm mb-2 inline-block">
              \u2190 \u8FD4\u56DE\u5730\u9EDE\u5217\u8868
            </a>
          </div>
        </div>

        <!-- Location Detail -->
        <div class="max-w-4xl mx-auto px-4 py-6">
          <div class="bg-white rounded-lg shadow-md overflow-hidden">
            <!-- Location Image -->
            <div class="relative aspect-w-16 aspect-h-9 bg-gray-200">
              ${new ImagePreview({
      imageUrl: location.thumbnail_url || "https://placehold.co/800x450/6B7280/FFFFFF?text=Location+Image",
      thumbnailUrl: location.thumbnail_url || "https://placehold.co/800x450/6B7280/FFFFFF?text=Location+Image",
      alt: location.name || "\u5730\u9EDE\u7167\u7247",
      nonce
    }).render()}
              ${location.user_location_status ? `
                <div class="absolute top-4 right-4">
                  <span class="px-3 py-1 rounded-full text-sm font-medium ${location.user_location_status === "visited" ? "bg-green-100 text-green-800" : location.user_location_status === "want_to_visit" ? "bg-blue-100 text-blue-800" : "bg-purple-100 text-purple-800"}">
                    ${location.user_location_status === "visited" ? "\u4F86\u904E" : location.user_location_status === "want_to_visit" ? "\u60F3\u4F86" : "\u60F3\u518D\u4F86"}
                  </span>
                </div>
              ` : ""}
            </div>

            <!-- Location Info -->
            <div class="p-6">
              <div class="flex items-start justify-between mb-4">
                <div class="flex-1">
                  <h1 class="text-3xl font-bold text-gray-900 mb-2">${location.name || "\u672A\u77E5\u5730\u9EDE"}</h1>
                  <p class="text-gray-600 mb-2">\u{1F4CD} ${location.address || "\u7121\u5730\u5740\u8CC7\u8A0A"}</p>
                  <p class="text-sm text-gray-500">\u985E\u578B: ${translatePlaceTypes3(locationTypes)}</p>
                </div>
                ${user ? `
                  <button 
                    class="favorite-btn ml-4 ${isFavorited ? "text-red-500" : "text-gray-400"} hover:text-red-600 transition-colors"
                    data-location-id="${locationId}"
                    data-is-favorited="${isFavorited}"
                    title="${isFavorited ? "\u53D6\u6D88\u6536\u85CF" : "\u52A0\u5165\u6536\u85CF"}"
                  >
                    <svg class="w-6 h-6 fill-current" viewBox="0 0 20 20">
                      <path fill-rule="evenodd" d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z" clip-rule="evenodd" />
                    </svg>
                  </button>
                ` : ""}
              </div>

              ${location.editorial_summary ? `
                <div class="mb-6">
                  <h3 class="text-lg font-semibold text-gray-900 mb-2">\u7C21\u4ECB</h3>
                  <p class="text-gray-700 leading-relaxed">${location.editorial_summary}</p>
                </div>
              ` : ""}

              <!-- \u5546\u5BB6\u9A57\u8B49\u72C0\u614B -->
              <div class="mb-6 border-t border-gray-200 pt-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-3">\u5546\u5BB6\u9A57\u8B49</h3>
                ${verificationStatus ? `
                  <div class="flex items-center gap-2 mb-3">
                    <span class="px-3 py-1 rounded-full text-sm font-medium bg-green-100 text-green-800">
                      \u2713 \u5DF2\u9A57\u8B49
                    </span>
                    <span class="text-sm text-gray-600">
                      \u9A57\u8B49\u8005\uFF1A${verificationStatus.user_name || verificationStatus.user_email || "\u672A\u77E5"}
                    </span>
                  </div>
                ` : `
                  <div class="flex items-center gap-2 mb-3">
                    <span class="px-3 py-1 rounded-full text-sm font-medium bg-gray-100 text-gray-800">
                      \u672A\u9A57\u8B49
                    </span>
                  </div>
                `}
                ${user && user.id ? `
                  ${userVerification ? `
                    <div class="mt-3">
                      <p class="text-sm text-gray-600 mb-2">
                        \u60A8\u7684\u9A57\u8B49\u7533\u8ACB\u72C0\u614B\uFF1A
                        <span class="font-medium ${userVerification.status === "approved" ? "text-green-600" : userVerification.status === "rejected" ? "text-red-600" : "text-yellow-600"}">
                          ${userVerification.status === "approved" ? "\u5DF2\u6279\u51C6" : userVerification.status === "rejected" ? "\u5DF2\u62D2\u7D55" : "\u5F85\u5BE9\u6838"}
                        </span>
                      </p>
                      ${userVerification.rejection_reason ? `
                        <p class="text-sm text-red-600 mt-1">\u62D2\u7D55\u539F\u56E0\uFF1A${userVerification.rejection_reason}</p>
                      ` : ""}
                    </div>
                  ` : !isUserVerified ? `
                    <button 
                      id="request-verification-btn"
                      onclick="requestBusinessVerification('${locationId}', '${location.google_place_id || ""}')"
                      class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors text-sm font-medium"
                    >
                      \u7533\u8ACB\u5546\u5BB6\u9A57\u8B49
                    </button>
                  ` : ""}
                ` : `
                  <p class="text-sm text-gray-500">\u8ACB\u767B\u5165\u5F8C\u7533\u8ACB\u5546\u5BB6\u9A57\u8B49</p>
                `}
              </div>

              <!-- Google Rating -->
              ${location.google_rating ? `
                <div class="mb-6 flex items-center gap-2">
                  <div class="flex items-center gap-1">
                    <span class="text-yellow-500">\u2B50</span>
                    <span class="text-lg font-semibold">${location.google_rating.toFixed(1)}</span>
                  </div>
                  ${location.google_user_ratings_total ? `
                    <span class="text-sm text-gray-500">(${location.google_user_ratings_total} \u500B Google \u8A55\u5206)</span>
                  ` : ""}
                </div>
              ` : ""}

              <!-- Status Buttons -->
              ${user ? `
                <div class="border-t border-gray-200 pt-6 mb-6">
                  <h3 class="text-lg font-semibold text-gray-900 mb-4">\u6211\u7684\u72C0\u614B</h3>
                  <div class="flex flex-wrap gap-3">
                    <button 
                      onclick="updateLocationStatus('${locationId}', 'visited')"
                      class="px-4 py-2 rounded-full text-sm transition-colors ${location.user_location_status === "visited" ? "bg-green-500 text-white" : "bg-gray-200 text-gray-700 hover:bg-gray-300"}"
                    >
                      \u4F86\u904E
                    </button>
                    <button 
                      onclick="updateLocationStatus('${locationId}', 'want_to_visit')"
                      class="px-4 py-2 rounded-full text-sm transition-colors ${location.user_location_status === "want_to_visit" ? "bg-blue-500 text-white" : "bg-gray-200 text-gray-700 hover:bg-gray-300"}"
                    >
                      \u60F3\u4F86
                    </button>
                    <button 
                      onclick="updateLocationStatus('${locationId}', 'want_to_revisit')"
                      class="px-4 py-2 rounded-full text-sm transition-colors ${location.user_location_status === "want_to_revisit" ? "bg-purple-500 text-white" : "bg-gray-200 text-gray-700 hover:bg-gray-300"}"
                    >
                      \u60F3\u518D\u4F86
                    </button>
                  </div>
                </div>
              ` : ""}

              <!-- Rating Component -->
              ${user ? ratingComponent.render() : ""}

              <!-- Comments Component -->
              ${commentsComponent.render()}
            </div>
          </div>
        </div>
      </div>

      <script nonce="${nonce}">
        // \u6536\u85CF\u529F\u80FD
        document.addEventListener('DOMContentLoaded', function() {
          const favoriteBtn = document.querySelector('.favorite-btn');
          if (favoriteBtn) {
            favoriteBtn.addEventListener('click', async function() {
              const locationId = this.getAttribute('data-location-id');
              
              try {
                const response = await fetch('/api/favorites/toggle', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  credentials: 'include',
                  body: JSON.stringify({ location_id: locationId })
                });
                
                const data = await response.json();
                
                if (data.success) {
                  if (data.is_favorited) {
                    this.setAttribute('data-is-favorited', 'true');
                    this.classList.add('text-red-500');
                    this.classList.remove('text-gray-400');
                    this.setAttribute('title', '\u53D6\u6D88\u6536\u85CF');
                    if (window.showToast) {
                      window.showToast('\u5DF2\u6536\u85CF\uFF01', 'success');
                    }
                  } else {
                    this.setAttribute('data-is-favorited', 'false');
                    this.classList.remove('text-red-500');
                    this.classList.add('text-gray-400');
                    this.setAttribute('title', '\u52A0\u5165\u6536\u85CF');
                    if (window.showToast) {
                      window.showToast('\u5DF2\u53D6\u6D88\u6536\u85CF', 'success');
                    }
                  }
                } else {
                  if (window.showToast) {
                    window.showToast('\u64CD\u4F5C\u5931\u6557\uFF1A' + (data.error || '\u672A\u77E5\u932F\u8AA4'), 'error');
                  } else {
                    alert('\u64CD\u4F5C\u5931\u6557\uFF1A' + (data.error || '\u672A\u77E5\u932F\u8AA4'));
                  }
                }
              } catch (error) {
                console.error('\u6536\u85CF\u64CD\u4F5C\u5931\u6557:', error);
                if (window.showToast) {
                  window.showToast('\u64CD\u4F5C\u5931\u6557\uFF0C\u8ACB\u7A0D\u5F8C\u518D\u8A66', 'error');
                } else {
                  alert('\u64CD\u4F5C\u5931\u6557\uFF0C\u8ACB\u7A0D\u5F8C\u518D\u8A66');
                }
              }
            });
          }
        });

        // \u7533\u8ACB\u5546\u5BB6\u9A57\u8B49
        async function requestBusinessVerification(locationId, googlePlaceId) {
          if (!${user ? "true" : "false"}) {
            if (window.showToast) {
              window.showToast('\u8ACB\u5148\u767B\u5165\u624D\u80FD\u7533\u8ACB\u5546\u5BB6\u9A57\u8B49', 'warning');
            } else {
              alert('\u8ACB\u5148\u767B\u5165\u624D\u80FD\u7533\u8ACB\u5546\u5BB6\u9A57\u8B49');
            }
            window.location.href = '/login';
            return;
          }

          try {
            const response = await fetch('/api/business/verify/request', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              credentials: 'include',
              body: JSON.stringify({
                location_id: locationId,
                google_place_id: googlePlaceId || null
              })
            });

            const data = await response.json();

            if (data.success) {
              if (window.showToast) {
                window.showToast(data.message || '\u9A57\u8B49\u7533\u8ACB\u5DF2\u63D0\u4EA4\uFF0C\u7B49\u5F85\u7BA1\u7406\u54E1\u5BE9\u6838', 'success');
              } else {
                alert(data.message || '\u9A57\u8B49\u7533\u8ACB\u5DF2\u63D0\u4EA4\uFF0C\u7B49\u5F85\u7BA1\u7406\u54E1\u5BE9\u6838');
              }
              // \u91CD\u65B0\u8F09\u5165\u9801\u9762\u4EE5\u66F4\u65B0\u9A57\u8B49\u72C0\u614B
              setTimeout(() => location.reload(), 1500);
            } else {
              if (window.showToast) {
                window.showToast('\u7533\u8ACB\u5931\u6557\uFF1A' + (data.error || data.message || '\u672A\u77E5\u932F\u8AA4'), 'error');
              } else {
                alert('\u7533\u8ACB\u5931\u6557\uFF1A' + (data.error || data.message || '\u672A\u77E5\u932F\u8AA4'));
              }
            }
          } catch (error) {
            console.error('\u7533\u8ACB\u5546\u5BB6\u9A57\u8B49\u5931\u6557:', error);
            if (window.showToast) {
              window.showToast('\u7533\u8ACB\u5931\u6557\uFF0C\u8ACB\u7A0D\u5F8C\u518D\u8A66', 'error');
            } else {
              alert('\u7533\u8ACB\u5931\u6557\uFF0C\u8ACB\u7A0D\u5F8C\u518D\u8A66');
            }
          }
        }

        // \u66F4\u65B0\u5730\u9EDE\u72C0\u614B
        function updateLocationStatus(locationId, newStatus) {
          fetch('/api/location/status', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({
              locationId: locationId,
              status: newStatus
            })
          })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              if (window.showToast) {
                let statusText = '';
                if (newStatus === 'visited') statusText = '\u4F86\u904E';
                else if (newStatus === 'want_to_visit') statusText = '\u60F3\u4F86';
                else if (newStatus === 'want_to_revisit') statusText = '\u60F3\u518D\u4F86';
                if (statusText) {
                  window.showToast('\u5730\u9EDE\u72C0\u614B\u5DF2\u66F4\u65B0\u70BA\u300C' + statusText + '\u300D', 'success');
                }
              }
              location.reload();
            } else {
              if (window.showToast) {
                window.showToast('\u66F4\u65B0\u5931\u6557: ' + data.error, 'error');
              } else {
                alert('\u66F4\u65B0\u5931\u6557: ' + data.error);
              }
            }
          })
          .catch(error => {
            console.error('Error:', error);
            if (window.showToast) {
              window.showToast('\u66F4\u65B0\u5931\u6557\uFF0C\u8ACB\u7A0D\u5F8C\u518D\u8A66', 'error');
            } else {
              alert('\u66F4\u65B0\u5931\u6557\uFF0C\u8ACB\u7A0D\u5F8C\u518D\u8A66');
            }
          });
        }

        // \u8F09\u5165\u8A55\u5206\u8CC7\u8A0A
        window.loadLocationRating = async function(locationId) {
          try {
            const response = await fetch('/api/favorites/rating?location_id=' + locationId);
            const data = await response.json();
            
            if (data.success) {
              // \u66F4\u65B0\u8A55\u5206\u986F\u793A
              const ratingComponent = document.querySelector('.rating-component');
              if (ratingComponent && window.updateRatingDisplay) {
                window.updateRatingDisplay(data.rating);
              } else {
                location.reload();
              }
            }
          } catch (error) {
            console.error('\u8F09\u5165\u8A55\u5206\u5931\u6557:', error);
          }
        };

        // \u8F09\u5165\u8A55\u8AD6
        window.loadLocationComments = async function(locationId) {
          try {
            const response = await fetch('/api/favorites/comments?location_id=' + locationId + '&limit=10&offset=0');
            const data = await response.json();
            
            if (data.success) {
              location.reload();
            }
          } catch (error) {
            console.error('\u8F09\u5165\u8A55\u8AD6\u5931\u6557:', error);
          }
        };
      </script>
      ${user ? ratingComponent.getScript() : ""}
      ${commentsComponent.getScript()}
      ${ImagePreview.getScript(nonce)}
    `;
    return pageTemplate2({
      title: `${location.name || "\u5730\u9EDE\u8A73\u60C5"} - \u6F8E\u6E56\u6642\u5149\u6A5F`,
      content,
      user,
      nonce,
      cssContent
    });
  } catch (error) {
    console.error("[LocationDetail] Error:", error);
    if (error.message && error.message.includes("no such table")) {
      return ErrorResponseBuilder.buildErrorPage({
        title: "\u6578\u64DA\u5EAB\u8868\u4E0D\u5B58\u5728",
        message: "\u7CFB\u7D71\u6B63\u5728\u521D\u59CB\u5316\uFF0C\u8ACB\u7A0D\u5F8C\u518D\u8A66\u3002",
        statusCode: 503,
        suggestion: "\u5982\u679C\u554F\u984C\u6301\u7E8C\u5B58\u5728\uFF0C\u8ACB\u806F\u7E6B\u7BA1\u7406\u54E1\u904B\u884C\u6578\u64DA\u5EAB\u9077\u79FB\u3002",
        user,
        nonce,
        cssContent
      });
    }
    return ErrorResponseBuilder.buildErrorPage({
      title: "\u8F09\u5165\u5730\u9EDE\u8A73\u60C5\u5931\u6557",
      message: error.message || "\u7121\u6CD5\u8F09\u5165\u5730\u9EDE\u8A73\u60C5\uFF0C\u8ACB\u7A0D\u5F8C\u518D\u8A66\u3002",
      statusCode: 500,
      user,
      nonce,
      cssContent
    });
  }
}
var renderLocationDetailPage = withErrorHandling(_renderLocationDetailPage, {
  user: null,
  nonce: "",
  cssContent: ""
});

// src/routes/index.js
init_TripPlanner();

// src/api/auth.js
init_SessionService();
import { randomBytes } from "node:crypto";
function generateSessionId() {
  return randomBytes(32).toString("hex");
}
async function handleAuthRequest(request, env) {
  var _a, _b;
  const url = new URL(request.url);
  const pathParts = url.pathname.split("/").filter((p) => p);
  if (pathParts.length < 3 || pathParts[0] !== "api" || pathParts[1] !== "auth") {
    return new Response("Not Found", { status: 404 });
  }
  const action = pathParts[2];
  const subAction = pathParts[3];
  console.log(`[Auth] Request received: ${request.method} ${url.pathname}`);
  console.log(`[Auth] Action: ${action}, SubAction: ${subAction}`);
  if (action === "google") {
    if (request.method === "GET" && !subAction) {
      try {
        console.log("[Auth Google] Initiating flow...");
        const clientId = env.GOOGLE_CLIENT_ID;
        if (!clientId)
          throw new Error("Google Client ID not configured");
        const redirectUri = `${url.origin}/api/auth/google/callback`;
        const scope = "openid email profile";
        const state = crypto.randomUUID();
        const stateCookie = `google_oauth_state=${state}; Path=/; HttpOnly; Secure; SameSite=Lax; Max-Age=300`;
        console.log("[Auth Google] Setting state cookie header:", stateCookie);
        const authUrl = new URL("https://accounts.google.com/o/oauth2/v2/auth");
        authUrl.searchParams.set("client_id", clientId);
        authUrl.searchParams.set("redirect_uri", redirectUri);
        authUrl.searchParams.set("response_type", "code");
        authUrl.searchParams.set("scope", scope);
        authUrl.searchParams.set("state", state);
        console.log(`[Auth Google] Redirecting to: ${authUrl.toString()}`);
        const headers = new Headers({
          "Location": authUrl.toString(),
          "Content-Type": "text/plain",
          "Set-Cookie": stateCookie
        });
        return new Response(null, { status: 302, headers });
      } catch (error) {
        console.error("[Auth Google] Initiation Error:", error);
        return new Response("Google Auth Initiation Failed", { status: 500 });
      }
    }
    if (request.method === "GET" && subAction === "callback") {
      const callbackStateCookieHeader = new Headers();
      try {
        console.log("[Auth Google Callback] Entering handler...");
        const stateParam = url.searchParams.get("state");
        const cookieHeader = request.headers.get("Cookie") || "";
        console.log("[Auth Google Callback] Received Cookie header:", cookieHeader);
        const stateCookieMatch = cookieHeader.match(/google_oauth_state=([^;]+)/);
        const storedState = stateCookieMatch ? stateCookieMatch[1] : null;
        callbackStateCookieHeader.append("Set-Cookie", "google_oauth_state=; Path=/; Expires=Thu, 01 Jan 1970 00:00:00 GMT; HttpOnly; Secure; SameSite=Lax");
        console.log(`[Auth Google Callback] State validation: URL='${stateParam}', Cookie='${storedState}'`);
        if (!stateParam || !storedState || stateParam !== storedState) {
          throw new Error("OAuth state validation failed.");
        }
        console.log("[Auth Google Callback] State validation successful.");
        const code = url.searchParams.get("code");
        if (!code)
          throw new Error("Missing code parameter in callback.");
        console.log("[Auth Google Callback] Exchanging code for token...");
        const tokenResponse = await fetch("https://oauth2.googleapis.com/token", {
          method: "POST",
          headers: { "Content-Type": "application/x-www-form-urlencoded" },
          body: new URLSearchParams({
            code,
            client_id: env.GOOGLE_CLIENT_ID,
            client_secret: env.GOOGLE_CLIENT_SECRET,
            redirect_uri: `${url.origin}/api/auth/google/callback`,
            grant_type: "authorization_code"
          })
        });
        if (!tokenResponse.ok) {
          const errorBody = await tokenResponse.text();
          throw new Error(`Failed to get access token: ${tokenResponse.status} ${tokenResponse.statusText} - ${errorBody}`);
        }
        const tokenData = await tokenResponse.json();
        const accessToken = tokenData.access_token;
        if (!accessToken)
          throw new Error("Access token not found in Google response.");
        console.log("[Auth Google Callback] Token exchange successful.");
        console.log("[Auth Google Callback] Fetching user info...");
        const userInfoResponse = await fetch("https://www.googleapis.com/oauth2/v2/userinfo", {
          headers: { Authorization: `Bearer ${accessToken}` }
        });
        if (!userInfoResponse.ok) {
          const errorBody = await userInfoResponse.text();
          throw new Error(`Failed to get user info: ${userInfoResponse.status} ${userInfoResponse.statusText} - ${errorBody}`);
        }
        const userInfo = await userInfoResponse.json();
        if (!userInfo || !userInfo.id || !userInfo.email) {
          console.error("[Auth Google Callback] Incomplete user info received:", userInfo);
          throw new Error("Incomplete user info received from Google.");
        }
        console.log("[Auth Google Callback] Raw user info fetched:", userInfo);
        const userEmail = userInfo.email;
        const googleId = String(userInfo.id);
        const userName = userInfo.name || "Google User";
        const avatarUrl = userInfo.picture || "";
        const now = Math.floor(Date.now() / 1e3);
        let userId;
        console.log(`[Auth Google Callback] Looking up user by email: ${userEmail}`);
        const existingUser = await env.DB.prepare("SELECT id FROM users WHERE email = ?").bind(userEmail).first();
        if (existingUser) {
          userId = existingUser.id;
          console.log(`[Auth Google Callback] Found existing user: ${userId}. Updating...`);
          const stmt = env.DB.prepare(
            "UPDATE users SET name = ?, google_id = ?, avatar_url = ?, updated_at = ? WHERE id = ?"
          );
          console.log("[Auth Google Callback] Binding UPDATE values:", { name: userName, google_id: googleId, avatar_url: avatarUrl, updated_at: now, id: userId });
          await stmt.bind(userName, googleId, avatarUrl, now, userId).run();
          console.log(`[Auth Google Callback] User ${userId} updated.`);
        } else {
          userId = crypto.randomUUID();
          console.log(`[Auth Google Callback] User not found. Creating new user: ${userId}...`);
          const stmt = env.DB.prepare(
            "INSERT INTO users (id, email, name, google_id, avatar_url, created_at, updated_at) VALUES (?, ?, ?, ?, ?, ?, ?)"
          );
          console.log("[Auth Google Callback] Binding INSERT values:", { id: userId, email: userEmail, name: userName, google_id: googleId, avatar_url: avatarUrl, created_at: now, updated_at: now });
          await stmt.bind(userId, userEmail, userName, googleId, avatarUrl, now, now).run();
          console.log(`[Auth Google Callback] New user ${userId} created.`);
        }
        console.log(`[Auth Google Callback] Creating session for user: ${userId}...`);
        const sessionId = generateSessionId();
        const expiresAt = now + 7 * 24 * 60 * 60;
        const sessionStmt = env.DB.prepare(
          "INSERT INTO sessions (id, user_id, expires_at, created_at) VALUES (?, ?, ?, ?)"
        );
        console.log("[Auth Google Callback] Binding session INSERT values:", { id: sessionId, user_id: userId, expires_at: expiresAt, created_at: now });
        await sessionStmt.bind(sessionId, userId, expiresAt, now).run();
        console.log(`[Auth Google Callback] Session ${sessionId} created.`);
        const sessionCookie = `session=${sessionId}; Path=/; HttpOnly; Secure; SameSite=Lax; Max-Age=${7 * 24 * 60 * 60}`;
        callbackStateCookieHeader.append("Set-Cookie", sessionCookie);
        callbackStateCookieHeader.append("Location", "/google-info");
        console.log("[Auth Google Callback] Login successful. Redirecting to /google-info...");
        return new Response(null, { status: 302, headers: callbackStateCookieHeader });
      } catch (error) {
        console.error("[Auth Google Callback] Error:", error);
        callbackStateCookieHeader.set("Content-Type", "text/plain");
        return new Response(`Google Authentication Failed: ${error.message}`, { status: 500, headers: callbackStateCookieHeader });
      }
    }
    console.warn(`[Auth Google] Invalid request: ${request.method} ${url.pathname}`);
    return new Response("Invalid Google auth request", { status: 404 });
  }
  if (action === "logout" && request.method === "POST") {
    console.log("[Auth Logout] Handling logout...");
    const sessionCookieVal = (_b = (_a = request.headers.get("Cookie")) == null ? void 0 : _a.match(/session=([^;]+)/)) == null ? void 0 : _b[1];
    if (sessionCookieVal) {
      try {
        console.log(`[Auth Logout] Deleting session: ${sessionCookieVal}`);
        await deleteSession(env.DB, sessionCookieVal);
        console.log(`[Auth Logout] Session ${sessionCookieVal} deleted.`);
      } catch (e) {
        console.error("[Auth Logout] Error deleting session:", e);
      }
    }
    const logoutHeaders = new Headers();
    logoutHeaders.append("Set-Cookie", "session=; Path=/; Expires=Thu, 01 Jan 1970 00:00:00 GMT; HttpOnly; Secure; SameSite=Lax");
    logoutHeaders.append("Location", "/");
    console.log("[Auth Logout] Logout complete. Redirecting...");
    return new Response(null, { status: 302, headers: logoutHeaders });
  }
  console.warn(`[Auth] Action not found or method not allowed: ${action} ${request.method}`);
  return new Response("Auth action not found or method not allowed", { status: 404 });
}

// src/api/csp.js
async function handleCspReport(request, env) {
  try {
    if (request.method !== "POST") {
      return new Response("Method not allowed", { status: 405 });
    }
    const report = await request.json();
    console.error("CSP Violation:", JSON.stringify(report, null, 2));
    return new Response(null, { status: 204 });
  } catch (error) {
    console.error("Error handling CSP report:", error);
    return new Response("Internal server error", { status: 500 });
  }
}

// src/routes/index.js
init_image();
init_admin();

// src/api/location.js
init_LocationService();
init_cacheHelper();
async function handleLocationRequest(request, env, user) {
  const url = new URL(request.url);
  const path = url.pathname;
  if (path === "/api/locations/paginated" && request.method === "GET") {
    try {
      const cachedHandler = withCache(handleLocationsPaginated, {
        cacheKey: "locations",
        ttl: CACHE_TTL.SHORT,
        // 1 分鐘
        keyGenerator: (request2, env2, user2) => {
          const url2 = new URL(request2.url);
          const limit = url2.searchParams.get("limit") || "20";
          const offset = url2.searchParams.get("offset") || "0";
          const userId = (user2 == null ? void 0 : user2.id) || "anonymous";
          return `paginated:${limit}:${offset}:${userId}`;
        }
      });
      return await cachedHandler(request, env, user);
    } catch (error) {
      console.error("[Location API] Error:", error);
      return new Response(JSON.stringify({ error: "Internal server error" }), {
        status: 500,
        headers: { "Content-Type": "application/json" }
      });
    }
  }
  if (!user) {
    return new Response(JSON.stringify({ error: "Unauthorized" }), {
      status: 401,
      headers: { "Content-Type": "application/json" }
    });
  }
  try {
    if (path === "/api/location/status" && request.method === "POST") {
      return await handleLocationStatusUpdate(request, env, user);
    }
    return new Response(JSON.stringify({ error: "API endpoint not found" }), {
      status: 404,
      headers: { "Content-Type": "application/json" }
    });
  } catch (error) {
    console.error("[Location API] Error:", error);
    return new Response(JSON.stringify({ error: "Internal server error" }), {
      status: 500,
      headers: { "Content-Type": "application/json" }
    });
  }
}
async function handleLocationStatusUpdate(request, env, user) {
  try {
    const body = await request.json();
    const { locationId, status } = body;
    if (!locationId || !status) {
      return new Response(JSON.stringify({
        success: false,
        error: "Missing locationId or status"
      }), {
        status: 400,
        headers: { "Content-Type": "application/json" }
      });
    }
    const validStatuses = ["visited", "want_to_visit", "want_to_revisit", "created"];
    if (!validStatuses.includes(status)) {
      return new Response(JSON.stringify({
        success: false,
        error: "Invalid status value"
      }), {
        status: 400,
        headers: { "Content-Type": "application/json" }
      });
    }
    const locationService = new LocationService(env.DB, env.GOOGLE_MAPS_API_KEY);
    const location = await locationService.getLocationById(locationId);
    if (!location) {
      return new Response(JSON.stringify({
        success: false,
        error: "Location not found"
      }), {
        status: 404,
        headers: { "Content-Type": "application/json" }
      });
    }
    await locationService.updateUserLocationStatus(user.id, locationId, status);
    return new Response(JSON.stringify({
      success: true,
      message: "Location status updated successfully"
    }), {
      status: 200,
      headers: { "Content-Type": "application/json" }
    });
  } catch (error) {
    console.error("[Location API] Error updating location status:", error);
    return new Response(JSON.stringify({
      success: false,
      error: "Failed to update location status"
    }), {
      status: 500,
      headers: { "Content-Type": "application/json" }
    });
  }
}
async function handleLocationsPaginated(request, env, user) {
  try {
    const url = new URL(request.url);
    const limit = parseInt(url.searchParams.get("limit") || "20", 10);
    const offset = parseInt(url.searchParams.get("offset") || "0", 10);
    if (isNaN(limit) || isNaN(offset) || limit < 1 || offset < 0) {
      return new Response(JSON.stringify({
        success: false,
        error: "Invalid limit or offset parameters"
      }), {
        status: 400,
        headers: { "Content-Type": "application/json" }
      });
    }
    const locationService = new LocationService(env.DB, env.GOOGLE_MAPS_API_KEY);
    const locations = await locationService.getLocationsPaginated(limit, offset, user ? user.id : null);
    if (user && user.id && locations && locations.length > 0) {
      const { FavoritesService: FavoritesService2 } = await Promise.resolve().then(() => (init_FavoritesService(), FavoritesService_exports));
      const favoritesService = new FavoritesService2(env.DB);
      const locationIds = locations.map((loc) => loc.id);
      const favoriteStatuses = await favoritesService.getBatchFavoriteStatuses(user.id, locationIds);
      locations.forEach((location) => {
        location.is_favorited = favoriteStatuses[location.id] || false;
      });
    }
    return new Response(JSON.stringify({
      success: true,
      locations: locations || [],
      count: locations ? locations.length : 0
    }), {
      status: 200,
      headers: { "Content-Type": "application/json" }
    });
  } catch (error) {
    console.error("[Location API] Error fetching paginated locations:", error);
    return new Response(JSON.stringify({
      success: false,
      error: "Failed to fetch locations"
    }), {
      status: 500,
      headers: { "Content-Type": "application/json" }
    });
  }
}

// src/routes/index.js
init_ai();

// src/services/GameService.js
var GameService = class {
  constructor(db) {
    if (!db) {
      throw new Error("Database connection is required for GameService.");
    }
    this.db = db;
  }
  /**
   * 創建記憶膠囊
   * @param {string} userId - 用戶ID
   * @param {string} locationId - 地點ID
   * @param {object} capsuleData - 膠囊數據
   * @returns {Promise<object>} 創建的記憶膠囊
   */
  async createMemoryCapsule(userId, locationId, capsuleData) {
    const { title, content, photo_url, capsule_type = "memory" } = capsuleData;
    if (!userId || !locationId || !title) {
      throw new Error("\u7528\u6236ID\u3001\u5730\u9EDEID\u548C\u6A19\u984C\u662F\u5FC5\u9700\u7684");
    }
    const capsuleId = crypto.randomUUID();
    const now = (/* @__PURE__ */ new Date()).toISOString();
    try {
      const stmt = this.db.prepare(
        `INSERT INTO memory_capsules 
                 (id, user_id, location_id, title, content, photo_url, capsule_type, created_at, updated_at)
                 VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)`
      );
      await stmt.bind(
        capsuleId,
        userId,
        locationId,
        title,
        content,
        photo_url,
        capsule_type,
        now,
        now
      ).run();
      const capsule = await this.getMemoryCapsule(capsuleId);
      await this.checkAndCompleteTasks(userId, "memory_upload");
      await this.addUserPoints(userId, 10);
      console.log(`[GameService] \u6210\u529F\u5275\u5EFA\u8A18\u61B6\u81A0\u56CA: ${capsuleId}`);
      return capsule;
    } catch (error) {
      console.error(`[GameService] \u5275\u5EFA\u8A18\u61B6\u81A0\u56CA\u5931\u6557:`, error);
      throw new Error("\u5275\u5EFA\u8A18\u61B6\u81A0\u56CA\u5931\u6557");
    }
  }
  /**
   * 獲取記憶膠囊
   * @param {string} capsuleId - 膠囊ID
   * @returns {Promise<object|null>} 記憶膠囊對象
   */
  async getMemoryCapsule(capsuleId) {
    try {
      const stmt = this.db.prepare(
        `SELECT mc.*, u.name as user_name, u.avatar_url, u.game_role,
                        l.name as location_name, l.address, l.thumbnail_url
                 FROM memory_capsules mc
                 JOIN users u ON mc.user_id = u.id
                 JOIN locations l ON mc.location_id = l.id
                 WHERE mc.id = ? AND mc.status = 'active'`
      );
      const capsule = await stmt.bind(capsuleId).first();
      return capsule || null;
    } catch (error) {
      console.error(`[GameService] \u7372\u53D6\u8A18\u61B6\u81A0\u56CA\u5931\u6557:`, error);
      throw new Error("\u7372\u53D6\u8A18\u61B6\u81A0\u56CA\u5931\u6557");
    }
  }
  /**
   * 獲取用戶的記憶膠囊列表
   * @param {string} userId - 用戶ID
   * @param {number} limit - 限制數量
   * @returns {Promise<Array>} 記憶膠囊列表
   */
  async getUserMemoryCapsules(userId, limit = 20) {
    try {
      const stmt = this.db.prepare(
        `SELECT mc.*, l.name as location_name, l.address, l.thumbnail_url
                 FROM memory_capsules mc
                 JOIN locations l ON mc.location_id = l.id
                 WHERE mc.user_id = ? AND mc.status = 'active'
                 ORDER BY mc.created_at DESC
                 LIMIT ?`
      );
      const { results } = await stmt.bind(userId, limit).all();
      return results || [];
    } catch (error) {
      console.error(`[GameService] \u7372\u53D6\u7528\u6236\u8A18\u61B6\u81A0\u56CA\u5931\u6557:`, error);
      throw new Error("\u7372\u53D6\u7528\u6236\u8A18\u61B6\u81A0\u56CA\u5931\u6557");
    }
  }
  /**
   * 獲取地點的記憶膠囊列表
   * @param {string} locationId - 地點ID
   * @param {number} limit - 限制數量
   * @returns {Promise<Array>} 記憶膠囊列表
   */
  async getLocationMemoryCapsules(locationId, limit = 20) {
    try {
      const stmt = this.db.prepare(
        `SELECT mc.*, u.name as user_name, u.avatar_url, u.game_role
                 FROM memory_capsules mc
                 JOIN users u ON mc.user_id = u.id
                 WHERE mc.location_id = ? AND mc.status = 'active'
                 ORDER BY mc.created_at DESC
                 LIMIT ?`
      );
      const { results } = await stmt.bind(locationId, limit).all();
      return results || [];
    } catch (error) {
      console.error(`[GameService] \u7372\u53D6\u5730\u9EDE\u8A18\u61B6\u81A0\u56CA\u5931\u6557:`, error);
      throw new Error("\u7372\u53D6\u5730\u9EDE\u8A18\u61B6\u81A0\u56CA\u5931\u6557");
    }
  }
  /**
   * 店家回覆記憶膠囊
   * @param {string} merchantUserId - 店家用戶ID
   * @param {string} capsuleId - 膠囊ID
   * @param {object} replyData - 回覆數據
   * @returns {Promise<object>} 創建的回覆
   */
  async createMerchantReply(merchantUserId, capsuleId, replyData) {
    const { reply_content, reply_type = "greeting", special_offer } = replyData;
    if (!merchantUserId || !capsuleId || !reply_content) {
      throw new Error("\u5E97\u5BB6\u7528\u6236ID\u3001\u81A0\u56CAID\u548C\u56DE\u8986\u5167\u5BB9\u662F\u5FC5\u9700\u7684");
    }
    const capsule = await this.getMemoryCapsule(capsuleId);
    if (!capsule) {
      throw new Error("\u8A18\u61B6\u81A0\u56CA\u4E0D\u5B58\u5728");
    }
    const replyId = crypto.randomUUID();
    const now = (/* @__PURE__ */ new Date()).toISOString();
    try {
      const stmt = this.db.prepare(
        `INSERT INTO merchant_replies 
                 (id, capsule_id, merchant_user_id, reply_content, reply_type, special_offer, created_at, updated_at)
                 VALUES (?, ?, ?, ?, ?, ?, ?, ?)`
      );
      await stmt.bind(
        replyId,
        capsuleId,
        merchantUserId,
        reply_content,
        reply_type,
        special_offer,
        now,
        now
      ).run();
      const reply = await this.getMerchantReply(replyId);
      await this.checkAndCompleteTasks(merchantUserId, "merchant_reply");
      await this.addUserPoints(merchantUserId, 15);
      console.log(`[GameService] \u6210\u529F\u5275\u5EFA\u5E97\u5BB6\u56DE\u8986: ${replyId}`);
      return reply;
    } catch (error) {
      console.error(`[GameService] \u5275\u5EFA\u5E97\u5BB6\u56DE\u8986\u5931\u6557:`, error);
      throw new Error("\u5275\u5EFA\u5E97\u5BB6\u56DE\u8986\u5931\u6557");
    }
  }
  /**
   * 獲取店家回覆
   * @param {string} replyId - 回覆ID
   * @returns {Promise<object|null>} 回覆對象
   */
  async getMerchantReply(replyId) {
    try {
      const stmt = this.db.prepare(
        `SELECT mr.*, u.name as merchant_name, u.avatar_url, u.game_role
                 FROM merchant_replies mr
                 JOIN users u ON mr.merchant_user_id = u.id
                 WHERE mr.id = ? AND mr.status = 'active'`
      );
      const reply = await stmt.bind(replyId).first();
      return reply || null;
    } catch (error) {
      console.error(`[GameService] \u7372\u53D6\u5E97\u5BB6\u56DE\u8986\u5931\u6557:`, error);
      throw new Error("\u7372\u53D6\u5E97\u5BB6\u56DE\u8986\u5931\u6557");
    }
  }
  /**
   * 獲取記憶膠囊的所有回覆
   * @param {string} capsuleId - 膠囊ID
   * @returns {Promise<Array>} 回覆列表
   */
  async getCapsuleReplies(capsuleId) {
    try {
      const stmt = this.db.prepare(
        `SELECT mr.*, u.name as merchant_name, u.avatar_url, u.game_role
                 FROM merchant_replies mr
                 JOIN users u ON mr.merchant_user_id = u.id
                 WHERE mr.capsule_id = ? AND mr.status = 'active'
                 ORDER BY mr.created_at ASC`
      );
      const { results } = await stmt.bind(capsuleId).all();
      return results || [];
    } catch (error) {
      console.error(`[GameService] \u7372\u53D6\u81A0\u56CA\u56DE\u8986\u5931\u6557:`, error);
      throw new Error("\u7372\u53D6\u81A0\u56CA\u56DE\u8986\u5931\u6557");
    }
  }
  /**
   * 更新用戶遊戲角色
   * @param {string} userId - 用戶ID
   * @param {string} gameRole - 遊戲角色 (visitor, merchant, local)
   * @returns {Promise<boolean>} 更新成功狀態
   */
  async updateUserGameRole(userId, gameRole) {
    if (!["visitor", "merchant", "local"].includes(gameRole)) {
      throw new Error("\u7121\u6548\u7684\u904A\u6232\u89D2\u8272");
    }
    try {
      const stmt = this.db.prepare(
        `UPDATE users SET game_role = ?, updated_at = CURRENT_TIMESTAMP WHERE id = ?`
      );
      const result = await stmt.bind(gameRole, userId).run();
      return result.meta.changes > 0;
    } catch (error) {
      console.error(`[GameService] \u66F4\u65B0\u7528\u6236\u904A\u6232\u89D2\u8272\u5931\u6557:`, error);
      throw new Error("\u66F4\u65B0\u7528\u6236\u904A\u6232\u89D2\u8272\u5931\u6557");
    }
  }
  /**
   * 添加用戶遊戲點數
   * @param {string} userId - 用戶ID
   * @param {number} points - 點數
   * @returns {Promise<boolean>} 更新成功狀態
   */
  async addUserPoints(userId, points) {
    try {
      const stmt = this.db.prepare(
        `UPDATE users SET game_points = game_points + ?, updated_at = CURRENT_TIMESTAMP WHERE id = ?`
      );
      const result = await stmt.bind(points, userId).run();
      if (result.meta.changes > 0) {
        await this.checkUserLevelUp(userId);
        return true;
      }
      return false;
    } catch (error) {
      console.error(`[GameService] \u6DFB\u52A0\u7528\u6236\u9EDE\u6578\u5931\u6557:`, error);
      throw new Error("\u6DFB\u52A0\u7528\u6236\u9EDE\u6578\u5931\u6557");
    }
  }
  /**
   * 檢查用戶是否可以升級
   * @param {string} userId - 用戶ID
   * @returns {Promise<boolean>} 是否升級成功
   */
  async checkUserLevelUp(userId) {
    try {
      const user = await this.db.prepare(
        "SELECT game_level, game_points FROM users WHERE id = ?"
      ).bind(userId).first();
      if (!user)
        return false;
      const currentLevel = user.game_level || 1;
      const currentPoints = user.game_points || 0;
      const requiredPoints = currentLevel * 100;
      if (currentPoints >= requiredPoints) {
        const newLevel = currentLevel + 1;
        const stmt = this.db.prepare(
          `UPDATE users SET game_level = ?, updated_at = CURRENT_TIMESTAMP WHERE id = ?`
        );
        await stmt.bind(newLevel, userId).run();
        if (newLevel >= 10) {
          await this.awardBadge(userId, "island_master");
        }
        console.log(`[GameService] \u7528\u6236 ${userId} \u5347\u7D1A\u5230\u7B49\u7D1A ${newLevel}`);
        return true;
      }
      return false;
    } catch (error) {
      console.error(`[GameService] \u6AA2\u67E5\u7528\u6236\u5347\u7D1A\u5931\u6557:`, error);
      return false;
    }
  }
  /**
   * 頒發勳章給用戶
   * @param {string} userId - 用戶ID
   * @param {string} badgeId - 勳章ID
   * @returns {Promise<boolean>} 頒發成功狀態
   */
  async awardBadge(userId, badgeId) {
    try {
      const existing = await this.db.prepare(
        "SELECT 1 FROM user_badges WHERE user_id = ? AND badge_id = ?"
      ).bind(userId, badgeId).first();
      if (existing) {
        return false;
      }
      const badgeAwardId = crypto.randomUUID();
      const stmt = this.db.prepare(
        `INSERT INTO user_badges (id, user_id, badge_id, earned_at) VALUES (?, ?, ?, CURRENT_TIMESTAMP)`
      );
      await stmt.bind(badgeAwardId, userId, badgeId).run();
      const badge = await this.db.prepare(
        "SELECT points_reward FROM badges WHERE id = ?"
      ).bind(badgeId).first();
      if (badge && badge.points_reward > 0) {
        await this.addUserPoints(userId, badge.points_reward);
      }
      console.log(`[GameService] \u6210\u529F\u9812\u767C\u52F3\u7AE0 ${badgeId} \u7D66\u7528\u6236 ${userId}`);
      return true;
    } catch (error) {
      console.error(`[GameService] \u9812\u767C\u52F3\u7AE0\u5931\u6557:`, error);
      return false;
    }
  }
  /**
   * 檢查並完成任務
   * @param {string} userId - 用戶ID
   * @param {string} taskType - 任務類型
   * @returns {Promise<void>}
   */
  async checkAndCompleteTasks(userId, taskType) {
    try {
      const user = await this.db.prepare(
        "SELECT game_role, game_level, game_points FROM users WHERE id = ?"
      ).bind(userId).first();
      if (!user)
        return;
      const tasks = await this.db.prepare(
        `SELECT * FROM game_tasks 
                 WHERE task_type = ? AND is_active = 1 
                 AND (target_role = ? OR target_role = 'all')`
      ).bind(taskType, user.game_role).all();
      for (const task of tasks.results || []) {
        const completed = await this.db.prepare(
          "SELECT 1 FROM user_task_completions WHERE user_id = ? AND task_id = ?"
        ).bind(userId, task.id).first();
        if (completed)
          continue;
        const requirements = JSON.parse(task.requirements || "{}");
        let canComplete = true;
        switch (taskType) {
          case "memory_upload":
            const memoryCount = await this.getUserMemoryCount(userId);
            canComplete = memoryCount >= (requirements.memory_count || 1);
            break;
          case "merchant_reply":
            const replyCount = await this.getUserReplyCount(userId);
            canComplete = replyCount >= (requirements.reply_count || 1);
            break;
        }
        if (canComplete) {
          const completionId = crypto.randomUUID();
          await this.db.prepare(
            `INSERT INTO user_task_completions (id, user_id, task_id, completed_at) 
                         VALUES (?, ?, ?, CURRENT_TIMESTAMP)`
          ).bind(completionId, userId, task.id).run();
          if (task.points_reward > 0) {
            await this.addUserPoints(userId, task.points_reward);
          }
          if (task.badge_reward) {
            await this.awardBadge(userId, task.badge_reward);
          }
          console.log(`[GameService] \u7528\u6236 ${userId} \u5B8C\u6210\u4EFB\u52D9 ${task.id}`);
        }
      }
    } catch (error) {
      console.error(`[GameService] \u6AA2\u67E5\u4EFB\u52D9\u5B8C\u6210\u5931\u6557:`, error);
    }
  }
  /**
   * 獲取用戶記憶數量
   * @param {string} userId - 用戶ID
   * @returns {Promise<number>} 記憶數量
   */
  async getUserMemoryCount(userId) {
    try {
      const result = await this.db.prepare(
        'SELECT COUNT(*) as count FROM memory_capsules WHERE user_id = ? AND status = "active"'
      ).bind(userId).first();
      return (result == null ? void 0 : result.count) || 0;
    } catch (error) {
      console.error(`[GameService] \u7372\u53D6\u7528\u6236\u8A18\u61B6\u6578\u91CF\u5931\u6557:`, error);
      return 0;
    }
  }
  /**
   * 獲取用戶回覆數量
   * @param {string} userId - 用戶ID
   * @returns {Promise<number>} 回覆數量
   */
  async getUserReplyCount(userId) {
    try {
      const result = await this.db.prepare(
        'SELECT COUNT(*) as count FROM merchant_replies WHERE merchant_user_id = ? AND status = "active"'
      ).bind(userId).first();
      return (result == null ? void 0 : result.count) || 0;
    } catch (error) {
      console.error(`[GameService] \u7372\u53D6\u7528\u6236\u56DE\u8986\u6578\u91CF\u5931\u6557:`, error);
      return 0;
    }
  }
  /**
   * 獲取用戶遊戲統計
   * @param {string} userId - 用戶ID
   * @returns {Promise<object>} 遊戲統計
   */
  async getUserGameStats(userId) {
    try {
      const user = await this.db.prepare(
        `SELECT game_role, game_level, game_points, game_badges, visit_count, last_visit_date
                 FROM users WHERE id = ?`
      ).bind(userId).first();
      if (!user)
        return null;
      const memoryCount = await this.getUserMemoryCount(userId);
      const replyCount = await this.getUserReplyCount(userId);
      const badges = await this.db.prepare(
        `SELECT b.* FROM user_badges ub
                 JOIN badges b ON ub.badge_id = b.id
                 WHERE ub.user_id = ?
                 ORDER BY ub.earned_at DESC`
      ).bind(userId).all();
      return {
        game_role: user.game_role,
        game_level: user.game_level,
        game_points: user.game_points,
        visit_count: user.visit_count,
        last_visit_date: user.last_visit_date,
        memory_count: memoryCount,
        reply_count: replyCount,
        badges: badges.results || []
      };
    } catch (error) {
      console.error(`[GameService] \u7372\u53D6\u7528\u6236\u904A\u6232\u7D71\u8A08\u5931\u6557:`, error);
      throw new Error("\u7372\u53D6\u7528\u6236\u904A\u6232\u7D71\u8A08\u5931\u6557");
    }
  }
};

// src/api/game.js
init_SessionService();
function createGameRoutes(app, db) {
  const gameService = new GameService(db);
  const sessionService = new SessionService(db);
  async function requireAuth(request) {
    var _a, _b;
    const sessionId = (_b = (_a = request.headers.get("Cookie")) == null ? void 0 : _a.match(/session=([^;]+)/)) == null ? void 0 : _b[1];
    if (!sessionId) {
      return { error: "\u672A\u767B\u5165", status: 401 };
    }
    const session = await sessionService.getSession(sessionId);
    if (!session || session.expires_at < (/* @__PURE__ */ new Date()).toISOString()) {
      return { error: "\u6703\u8A71\u5DF2\u904E\u671F", status: 401 };
    }
    return { user: session };
  }
  app.post("/api/game/memory-capsules", async (c) => {
    try {
      const auth = await requireAuth(c.req);
      if (auth.error) {
        return c.json({ error: auth.error }, auth.status);
      }
      const body = await c.req.json();
      const { location_id, title, content, photo_url, capsule_type } = body;
      if (!location_id || !title) {
        return c.json({ error: "\u5730\u9EDEID\u548C\u6A19\u984C\u662F\u5FC5\u9700\u7684" }, 400);
      }
      const capsule = await gameService.createMemoryCapsule(
        auth.user.user_id,
        location_id,
        { title, content, photo_url, capsule_type }
      );
      return c.json({ success: true, capsule });
    } catch (error) {
      console.error("[Game API] \u5275\u5EFA\u8A18\u61B6\u81A0\u56CA\u932F\u8AA4:", error);
      return c.json({ error: "\u5275\u5EFA\u8A18\u61B6\u81A0\u56CA\u5931\u6557" }, 500);
    }
  });
  app.get("/api/game/memory-capsules/:id", async (c) => {
    try {
      const capsuleId = c.req.param("id");
      const capsule = await gameService.getMemoryCapsule(capsuleId);
      if (!capsule) {
        return c.json({ error: "\u8A18\u61B6\u81A0\u56CA\u4E0D\u5B58\u5728" }, 404);
      }
      const replies = await gameService.getCapsuleReplies(capsuleId);
      return c.json({
        success: true,
        capsule: { ...capsule, replies }
      });
    } catch (error) {
      console.error("[Game API] \u7372\u53D6\u8A18\u61B6\u81A0\u56CA\u932F\u8AA4:", error);
      return c.json({ error: "\u7372\u53D6\u8A18\u61B6\u81A0\u56CA\u5931\u6557" }, 500);
    }
  });
  app.get("/api/game/users/:userId/memory-capsules", async (c) => {
    try {
      const userId = c.req.param("userId");
      const limit = parseInt(c.req.query("limit")) || 20;
      const capsules = await gameService.getUserMemoryCapsules(userId, limit);
      return c.json({ success: true, capsules });
    } catch (error) {
      console.error("[Game API] \u7372\u53D6\u7528\u6236\u8A18\u61B6\u81A0\u56CA\u5217\u8868\u932F\u8AA4:", error);
      return c.json({ error: "\u7372\u53D6\u8A18\u61B6\u81A0\u56CA\u5217\u8868\u5931\u6557" }, 500);
    }
  });
  app.get("/api/game/locations/:locationId/memory-capsules", async (c) => {
    try {
      const locationId = c.req.param("locationId");
      const limit = parseInt(c.req.query("limit")) || 20;
      const capsules = await gameService.getLocationMemoryCapsules(locationId, limit);
      return c.json({ success: true, capsules });
    } catch (error) {
      console.error("[Game API] \u7372\u53D6\u5730\u9EDE\u8A18\u61B6\u81A0\u56CA\u5217\u8868\u932F\u8AA4:", error);
      return c.json({ error: "\u7372\u53D6\u5730\u9EDE\u8A18\u61B6\u81A0\u56CA\u5217\u8868\u5931\u6557" }, 500);
    }
  });
  app.post("/api/game/memory-capsules/:capsuleId/replies", async (c) => {
    try {
      const auth = await requireAuth(c.req);
      if (auth.error) {
        return c.json({ error: auth.error }, auth.status);
      }
      const capsuleId = c.req.param("capsuleId");
      const body = await c.req.json();
      const { reply_content, reply_type, special_offer } = body;
      if (!reply_content) {
        return c.json({ error: "\u56DE\u8986\u5167\u5BB9\u662F\u5FC5\u9700\u7684" }, 400);
      }
      const reply = await gameService.createMerchantReply(
        auth.user.user_id,
        capsuleId,
        { reply_content, reply_type, special_offer }
      );
      return c.json({ success: true, reply });
    } catch (error) {
      console.error("[Game API] \u5275\u5EFA\u5E97\u5BB6\u56DE\u8986\u932F\u8AA4:", error);
      return c.json({ error: "\u5275\u5EFA\u5E97\u5BB6\u56DE\u8986\u5931\u6557" }, 500);
    }
  });
  app.put("/api/game/users/:userId/role", async (c) => {
    try {
      const auth = await requireAuth(c.req);
      if (auth.error) {
        return c.json({ error: auth.error }, auth.status);
      }
      const userId = c.req.param("userId");
      if (auth.user.user_id !== userId) {
        return c.json({ error: "\u7121\u6B0A\u9650\u4FEE\u6539\u5176\u4ED6\u7528\u6236\u89D2\u8272" }, 403);
      }
      const body = await c.req.json();
      const { game_role } = body;
      if (!["visitor", "merchant", "local"].includes(game_role)) {
        return c.json({ error: "\u7121\u6548\u7684\u904A\u6232\u89D2\u8272" }, 400);
      }
      const success = await gameService.updateUserGameRole(userId, game_role);
      if (success) {
        return c.json({ success: true, message: "\u89D2\u8272\u66F4\u65B0\u6210\u529F" });
      } else {
        return c.json({ error: "\u89D2\u8272\u66F4\u65B0\u5931\u6557" }, 500);
      }
    } catch (error) {
      console.error("[Game API] \u66F4\u65B0\u7528\u6236\u89D2\u8272\u932F\u8AA4:", error);
      return c.json({ error: "\u66F4\u65B0\u7528\u6236\u89D2\u8272\u5931\u6557" }, 500);
    }
  });
  app.get("/api/game/users/:userId/stats", async (c) => {
    try {
      const userId = c.req.param("userId");
      const stats = await gameService.getUserGameStats(userId);
      if (!stats) {
        return c.json({ error: "\u7528\u6236\u4E0D\u5B58\u5728" }, 404);
      }
      return c.json({ success: true, stats });
    } catch (error) {
      console.error("[Game API] \u7372\u53D6\u7528\u6236\u904A\u6232\u7D71\u8A08\u932F\u8AA4:", error);
      return c.json({ error: "\u7372\u53D6\u7528\u6236\u904A\u6232\u7D71\u8A08\u5931\u6557" }, 500);
    }
  });
  app.get("/api/game/badges", async (c) => {
    try {
      const badges = await db.prepare(
        "SELECT * FROM badges ORDER BY badge_type, points_reward ASC"
      ).all();
      return c.json({ success: true, badges: badges.results || [] });
    } catch (error) {
      console.error("[Game API] \u7372\u53D6\u52F3\u7AE0\u5217\u8868\u932F\u8AA4:", error);
      return c.json({ error: "\u7372\u53D6\u52F3\u7AE0\u5217\u8868\u5931\u6557" }, 500);
    }
  });
  app.get("/api/game/tasks", async (c) => {
    try {
      const tasks = await db.prepare(
        "SELECT * FROM game_tasks WHERE is_active = 1 ORDER BY points_reward ASC"
      ).all();
      return c.json({ success: true, tasks: tasks.results || [] });
    } catch (error) {
      console.error("[Game API] \u7372\u53D6\u4EFB\u52D9\u5217\u8868\u932F\u8AA4:", error);
      return c.json({ error: "\u7372\u53D6\u4EFB\u52D9\u5217\u8868\u5931\u6557" }, 500);
    }
  });
  app.get("/api/game/users/:userId/tasks", async (c) => {
    try {
      const userId = c.req.param("userId");
      const tasks = await db.prepare(
        `SELECT t.*, 
                        CASE WHEN utc.id IS NOT NULL THEN 1 ELSE 0 END as is_completed,
                        utc.completed_at
                 FROM game_tasks t
                 LEFT JOIN user_task_completions utc ON t.id = utc.task_id AND utc.user_id = ?
                 WHERE t.is_active = 1
                 ORDER BY t.points_reward ASC`
      ).bind(userId).all();
      return c.json({ success: true, tasks: tasks.results || [] });
    } catch (error) {
      console.error("[Game API] \u7372\u53D6\u7528\u6236\u4EFB\u52D9\u932F\u8AA4:", error);
      return c.json({ error: "\u7372\u53D6\u7528\u6236\u4EFB\u52D9\u5931\u6557" }, 500);
    }
  });
  app.post("/api/game/users/:userId/badges/:badgeId", async (c) => {
    try {
      const auth = await requireAuth(c.req);
      if (auth.error) {
        return c.json({ error: auth.error }, auth.status);
      }
      const user = await db.prepare(
        "SELECT role FROM users WHERE id = ?"
      ).bind(auth.user.user_id).first();
      if ((user == null ? void 0 : user.role) !== "admin") {
        return c.json({ error: "\u9700\u8981\u7BA1\u7406\u54E1\u6B0A\u9650" }, 403);
      }
      const userId = c.req.param("userId");
      const badgeId = c.req.param("badgeId");
      const success = await gameService.awardBadge(userId, badgeId);
      if (success) {
        return c.json({ success: true, message: "\u52F3\u7AE0\u9812\u767C\u6210\u529F" });
      } else {
        return c.json({ error: "\u52F3\u7AE0\u9812\u767C\u5931\u6557\uFF0C\u53EF\u80FD\u5DF2\u7D93\u64C1\u6709\u8A72\u52F3\u7AE0" }, 400);
      }
    } catch (error) {
      console.error("[Game API] \u9812\u767C\u52F3\u7AE0\u932F\u8AA4:", error);
      return c.json({ error: "\u9812\u767C\u52F3\u7AE0\u5931\u6557" }, 500);
    }
  });
  app.get("/api/game/leaderboard", async (c) => {
    try {
      const type = c.req.query("type") || "points";
      const limit = parseInt(c.req.query("limit")) || 10;
      let query;
      switch (type) {
        case "level":
          query = `SELECT id, name, avatar_url, game_role, game_level, game_points 
                             FROM users 
                             WHERE game_level > 0 
                             ORDER BY game_level DESC, game_points DESC 
                             LIMIT ?`;
          break;
        case "memories":
          query = `SELECT u.id, u.name, u.avatar_url, u.game_role, u.game_level, u.game_points,
                                    COUNT(mc.id) as memory_count
                             FROM users u
                             LEFT JOIN memory_capsules mc ON u.id = mc.user_id AND mc.status = 'active'
                             WHERE u.game_level > 0
                             GROUP BY u.id
                             ORDER BY memory_count DESC, u.game_points DESC
                             LIMIT ?`;
          break;
        default:
          query = `SELECT id, name, avatar_url, game_role, game_level, game_points 
                             FROM users 
                             WHERE game_points > 0 
                             ORDER BY game_points DESC, game_level DESC 
                             LIMIT ?`;
      }
      const leaderboard = await db.prepare(query).bind(limit).all();
      return c.json({ success: true, leaderboard: leaderboard.results || [] });
    } catch (error) {
      console.error("[Game API] \u7372\u53D6\u6392\u884C\u699C\u932F\u8AA4:", error);
      return c.json({ error: "\u7372\u53D6\u6392\u884C\u699C\u5931\u6557" }, 500);
    }
  });
}

// src/api/penghu-game.js
init_dist();
function createPenghuGameRoutes(app, db) {
  const gameService = new PenghuGameService(db);
  app.use("/api/penghu-game/*", async (c, next) => {
    var _a, _b;
    const sessionId = (_b = (_a = c.req.header("Cookie")) == null ? void 0 : _a.match(/session=([^;]+)/)) == null ? void 0 : _b[1];
    if (!sessionId) {
      return c.json({ error: "Unauthorized" }, 401);
    }
    await next();
  });
  app.get("/api/penghu-game/stats", async (c) => {
    var _a, _b;
    try {
      const sessionId = (_b = (_a = c.req.header("Cookie")) == null ? void 0 : _a.match(/session=([^;]+)/)) == null ? void 0 : _b[1];
      const user = await getUserFromSession(sessionId, db);
      if (!user) {
        return c.json({ error: "User not found" }, 404);
      }
      const stats = await gameService.getUserGameStats(user.id);
      return c.json({ success: true, data: stats });
    } catch (error) {
      console.error("Error getting game stats:", error);
      return c.json({ error: error.message }, 500);
    }
  });
  app.post("/api/penghu-game/memory-capsules", async (c) => {
    var _a, _b;
    try {
      const sessionId = (_b = (_a = c.req.header("Cookie")) == null ? void 0 : _a.match(/session=([^;]+)/)) == null ? void 0 : _b[1];
      const user = await getUserFromSession(sessionId, db);
      if (!user) {
        return c.json({ error: "User not found" }, 404);
      }
      const { location_id, title, content, photo_url, capsule_type } = await c.req.json();
      if (!location_id || !title) {
        return c.json({ error: "Location ID and title are required" }, 400);
      }
      const result = await gameService.createMemoryCapsule(
        user.id,
        location_id,
        title,
        content,
        photo_url,
        capsule_type
      );
      return c.json({
        success: true,
        data: { id: result.meta.last_row_id },
        message: "\u8A18\u61B6\u81A0\u56CA\u5275\u5EFA\u6210\u529F\uFF01\u7372\u5F97 10 \u9EDE\u6578\uFF01"
      });
    } catch (error) {
      console.error("Error creating memory capsule:", error);
      return c.json({ error: error.message }, 500);
    }
  });
  app.get("/api/penghu-game/memory-capsules/my", async (c) => {
    var _a, _b;
    try {
      const sessionId = (_b = (_a = c.req.header("Cookie")) == null ? void 0 : _a.match(/session=([^;]+)/)) == null ? void 0 : _b[1];
      const user = await getUserFromSession(sessionId, db);
      if (!user) {
        return c.json({ error: "User not found" }, 404);
      }
      const limit = parseInt(c.req.query("limit")) || 10;
      const capsules = await gameService.getUserMemoryCapsules(user.id, limit);
      return c.json({ success: true, data: capsules });
    } catch (error) {
      console.error("Error getting user memory capsules:", error);
      return c.json({ error: error.message }, 500);
    }
  });
  app.get("/api/penghu-game/memory-capsules/explore", async (c) => {
    try {
      const limit = parseInt(c.req.query("limit")) || 20;
      const capsules = await gameService.getAllMemoryCapsules(limit);
      return c.json({ success: true, data: capsules });
    } catch (error) {
      console.error("Error getting all memory capsules:", error);
      return c.json({ error: error.message }, 500);
    }
  });
  app.post("/api/penghu-game/memory-capsules/:id/reply", async (c) => {
    var _a, _b;
    try {
      const sessionId = (_b = (_a = c.req.header("Cookie")) == null ? void 0 : _a.match(/session=([^;]+)/)) == null ? void 0 : _b[1];
      const user = await getUserFromSession(sessionId, db);
      if (!user) {
        return c.json({ error: "User not found" }, 404);
      }
      const capsuleId = c.req.param("id");
      const { reply_content } = await c.req.json();
      if (!reply_content) {
        return c.json({ error: "Reply content is required" }, 400);
      }
      const result = await gameService.replyToMemoryCapsule(user.id, capsuleId, reply_content);
      return c.json({
        success: true,
        data: { id: result.meta.last_row_id },
        message: "\u56DE\u8986\u6210\u529F\uFF01\u7372\u5F97 15 \u9EDE\u6578\uFF01"
      });
    } catch (error) {
      console.error("Error replying to memory capsule:", error);
      return c.json({ error: error.message }, 500);
    }
  });
  app.get("/api/penghu-game/leaderboard", async (c) => {
    try {
      const limit = parseInt(c.req.query("limit")) || 10;
      const leaderboard = await gameService.getLeaderboard(limit);
      return c.json({ success: true, data: leaderboard });
    } catch (error) {
      console.error("Error getting leaderboard:", error);
      return c.json({ error: error.message }, 500);
    }
  });
  app.get("/api/penghu-game/tasks", async (c) => {
    var _a, _b;
    try {
      const sessionId = (_b = (_a = c.req.header("Cookie")) == null ? void 0 : _a.match(/session=([^;]+)/)) == null ? void 0 : _b[1];
      const user = await getUserFromSession(sessionId, db);
      if (!user) {
        return c.json({ error: "User not found" }, 404);
      }
      const tasks = await gameService.getUserTasks(user.id);
      return c.json({ success: true, data: tasks });
    } catch (error) {
      console.error("Error getting user tasks:", error);
      return c.json({ error: error.message }, 500);
    }
  });
  app.get("/api/penghu-game/badges", async (c) => {
    var _a, _b;
    try {
      const sessionId = (_b = (_a = c.req.header("Cookie")) == null ? void 0 : _a.match(/session=([^;]+)/)) == null ? void 0 : _b[1];
      const user = await getUserFromSession(sessionId, db);
      if (!user) {
        return c.json({ error: "User not found" }, 404);
      }
      const badges = await gameService.getUserBadges(user.id);
      return c.json({ success: true, data: badges });
    } catch (error) {
      console.error("Error getting user badges:", error);
      return c.json({ error: error.message }, 500);
    }
  });
  app.get("/api/penghu-game/cultural-data", async (c) => {
    try {
      const locationId = c.req.query("location_id");
      const culturalData = await gameService.getCulturalData(locationId);
      return c.json({ success: true, data: culturalData });
    } catch (error) {
      console.error("Error getting cultural data:", error);
      return c.json({ error: error.message }, 500);
    }
  });
  app.get("/api/penghu-game/locations", async (c) => {
    try {
      const locations = await gameService.getPenghuLocations();
      return c.json({ success: true, data: locations });
    } catch (error) {
      console.error("Error getting Penghu locations:", error);
      return c.json({ error: error.message }, 500);
    }
  });
  app.post("/api/penghu-game/role", async (c) => {
    var _a, _b;
    try {
      const sessionId = (_b = (_a = c.req.header("Cookie")) == null ? void 0 : _a.match(/session=([^;]+)/)) == null ? void 0 : _b[1];
      const user = await getUserFromSession(sessionId, db);
      if (!user) {
        return c.json({ error: "User not found" }, 404);
      }
      const { role } = await c.req.json();
      if (!["visitor", "merchant", "local"].includes(role)) {
        return c.json({ error: "Invalid role" }, 400);
      }
      await db.prepare(`
                UPDATE users SET game_role = ? WHERE id = ?
            `).bind(role, user.id).run();
      await db.prepare(`
                UPDATE user_game_stats SET game_role = ? WHERE user_id = ?
            `).bind(role, user.id).run();
      return c.json({
        success: true,
        message: `\u89D2\u8272\u5DF2\u66F4\u65B0\u70BA ${role === "visitor" ? "\u6E38\u5BA2" : role === "merchant" ? "\u5E97\u5BB6" : "\u5728\u5730\u4EBA"}\uFF01`
      });
    } catch (error) {
      console.error("Error updating user role:", error);
      return c.json({ error: error.message }, 500);
    }
  });
}
async function getUserFromSession(sessionId, db) {
  try {
    if (!sessionId)
      return null;
    const session = await db.prepare(`
            SELECT * FROM sessions WHERE id = ? AND expires_at > datetime('now')
        `).bind(sessionId).first();
    if (!session)
      return null;
    const user = await db.prepare(`
            SELECT * FROM users WHERE id = ?
        `).bind(session.user_id).first();
    return user;
  } catch (error) {
    console.error("Error getting user from session:", error);
    return null;
  }
}

// src/api/simple-game.js
init_dist();

// src/services/SimpleGameService.js
var SimpleGameService = class {
  constructor(db) {
    this.db = db;
  }
  // 獲取用戶遊戲統計
  async getUserGameStats(userId) {
    try {
      const result = await this.db.prepare(`
                SELECT 
                    game_level,
                    game_points,
                    memory_count,
                    reply_count,
                    task_completed_count,
                    visit_count,
                    game_role,
                    created_at,
                    updated_at
                FROM user_game_stats 
                WHERE user_id = ?
            `).bind(userId).first();
      if (!result) {
        await this.createUserGameStats(userId);
        return await this.getUserGameStats(userId);
      }
      return result;
    } catch (error) {
      console.error("Error getting user game stats:", error);
      return {
        game_level: 1,
        game_points: 0,
        memory_count: 0,
        reply_count: 0,
        task_completed_count: 0,
        visit_count: 0,
        game_role: "visitor"
      };
    }
  }
  // 創建用戶遊戲統計
  async createUserGameStats(userId) {
    try {
      await this.db.prepare(`
                INSERT INTO user_game_stats (
                    user_id, game_level, game_points, memory_count, 
                    reply_count, task_completed_count, visit_count, game_role
                ) VALUES (?, 1, 0, 0, 0, 0, 0, 'visitor')
            `).bind(userId).run();
    } catch (error) {
      console.error("Error creating user game stats:", error);
    }
  }
  // 更新遊戲統計
  async updateGameStats(userId, updates) {
    try {
      const { points = 0, level = 0, memoryCount = 0, replyCount = 0, taskCompletedCount = 0, visitCount = 0 } = updates;
      await this.db.prepare(`
                UPDATE user_game_stats 
                SET 
                    game_level = game_level + ?,
                    game_points = game_points + ?,
                    memory_count = memory_count + ?,
                    reply_count = reply_count + ?,
                    task_completed_count = task_completed_count + ?,
                    visit_count = visit_count + ?,
                    updated_at = datetime('now')
                WHERE user_id = ?
            `).bind(level, points, memoryCount, replyCount, taskCompletedCount, visitCount, userId).run();
      return { success: true, points, memoryCount, replyCount, taskCompletedCount, visitCount };
    } catch (error) {
      console.error("Error updating game stats:", error);
      return { success: false, error: error.message };
    }
  }
  // 創建記憶膠囊
  async createMemoryCapsule(userId, locationId, title, content, photoUrl, capsuleType = "memory") {
    try {
      const result = await this.db.prepare(`
                INSERT INTO memory_capsules (
                    user_id, location_id, title, content, photo_url, capsule_type, created_at
                ) VALUES (?, ?, ?, ?, ?, ?, datetime('now'))
            `).bind(userId, locationId, title, content, photoUrl, capsuleType).run();
      await this.updateGameStats(userId, {
        points: 10,
        memoryCount: 1
      });
      return { success: true, id: result.meta.last_row_id, points: 10 };
    } catch (error) {
      console.error("Error creating memory capsule:", error);
      return { success: false, error: error.message };
    }
  }
  // 獲取澎湖地點
  async getPenghuLocations() {
    try {
      const result = await this.db.prepare(`
                SELECT * FROM locations 
                WHERE editorial_summary IS NOT NULL
                ORDER BY created_at DESC
                LIMIT 10
            `).all();
      return result.results || [];
    } catch (error) {
      console.error("Error getting Penghu locations:", error);
      return [];
    }
  }
  // 獲取用戶任務
  async getUserTasks(userId) {
    try {
      const result = await this.db.prepare(`
                SELECT 
                    gt.*,
                    ut.completed_at,
                    CASE WHEN ut.id IS NOT NULL THEN 1 ELSE 0 END as completed
                FROM game_tasks gt
                LEFT JOIN user_tasks ut ON gt.id = ut.task_id AND ut.user_id = ?
                ORDER BY gt.points_reward DESC
                LIMIT 5
            `).bind(userId).all();
      return result.results || [];
    } catch (error) {
      console.error("Error getting user tasks:", error);
      return [];
    }
  }
  // 獲取用戶勳章
  async getUserBadges(userId) {
    try {
      const result = await this.db.prepare(`
                SELECT 
                    gb.*,
                    ub.earned_at
                FROM game_badges gb
                LEFT JOIN user_badges ub ON gb.id = ub.badge_id AND ub.user_id = ?
                ORDER BY ub.earned_at DESC
                LIMIT 6
            `).bind(userId).all();
      return result.results || [];
    } catch (error) {
      console.error("Error getting user badges:", error);
      return [];
    }
  }
  // 模擬地點訪問
  async visitLocation(userId, locationId) {
    try {
      const result = await this.updateGameStats(userId, {
        points: 5,
        visitCount: 1
      });
      return { success: true, points: 5 };
    } catch (error) {
      console.error("Error visiting location:", error);
      return { success: false, error: error.message };
    }
  }
  // 模擬任務完成
  async completeTask(userId, taskId) {
    try {
      const result = await this.updateGameStats(userId, {
        points: 20,
        taskCompletedCount: 1
      });
      return { success: true, points: 20 };
    } catch (error) {
      console.error("Error completing task:", error);
      return { success: false, error: error.message };
    }
  }
};

// src/api/simple-game.js
function createSimpleGameRoutes(app, db) {
  const gameService = new SimpleGameService(db);
  app.use("/api/simple-game/*", async (c, next) => {
    var _a, _b;
    const sessionId = (_b = (_a = c.req.header("Cookie")) == null ? void 0 : _a.match(/session=([^;]+)/)) == null ? void 0 : _b[1];
    if (!sessionId) {
      return c.json({ error: "Unauthorized" }, 401);
    }
    await next();
  });
  app.get("/api/simple-game/stats", async (c) => {
    var _a, _b;
    try {
      const sessionId = (_b = (_a = c.req.header("Cookie")) == null ? void 0 : _a.match(/session=([^;]+)/)) == null ? void 0 : _b[1];
      const user = await getUserFromSession2(sessionId, db);
      if (!user) {
        return c.json({ error: "User not found" }, 404);
      }
      const stats = await gameService.getUserGameStats(user.id);
      return c.json({ success: true, data: stats });
    } catch (error) {
      console.error("Error getting game stats:", error);
      return c.json({ error: error.message }, 500);
    }
  });
  app.post("/api/simple-game/memory-capsules", async (c) => {
    var _a, _b;
    try {
      const sessionId = (_b = (_a = c.req.header("Cookie")) == null ? void 0 : _a.match(/session=([^;]+)/)) == null ? void 0 : _b[1];
      const user = await getUserFromSession2(sessionId, db);
      if (!user) {
        return c.json({ error: "User not found" }, 404);
      }
      const { location_id, title, content, photo_url, capsule_type } = await c.req.json();
      if (!location_id || !title) {
        return c.json({ error: "Location ID and title are required" }, 400);
      }
      const result = await gameService.createMemoryCapsule(
        user.id,
        location_id,
        title,
        content,
        photo_url,
        capsule_type
      );
      if (result.success) {
        return c.json({
          success: true,
          data: { id: result.id },
          message: `\u8A18\u61B6\u81A0\u56CA\u5275\u5EFA\u6210\u529F\uFF01\u7372\u5F97 ${result.points} \u9EDE\u6578\uFF01`
        });
      } else {
        return c.json({ error: result.error }, 500);
      }
    } catch (error) {
      console.error("Error creating memory capsule:", error);
      return c.json({ error: error.message }, 500);
    }
  });
  app.post("/api/simple-game/visit-location", async (c) => {
    var _a, _b;
    try {
      const sessionId = (_b = (_a = c.req.header("Cookie")) == null ? void 0 : _a.match(/session=([^;]+)/)) == null ? void 0 : _b[1];
      const user = await getUserFromSession2(sessionId, db);
      if (!user) {
        return c.json({ error: "User not found" }, 404);
      }
      const { location_id } = await c.req.json();
      if (!location_id) {
        return c.json({ error: "Location ID is required" }, 400);
      }
      const result = await gameService.visitLocation(user.id, location_id);
      if (result.success) {
        return c.json({
          success: true,
          message: `\u5730\u9EDE\u63A2\u7D22\u6210\u529F\uFF01\u7372\u5F97 ${result.points} \u9EDE\u6578\uFF01`
        });
      } else {
        return c.json({ error: result.error }, 500);
      }
    } catch (error) {
      console.error("Error visiting location:", error);
      return c.json({ error: error.message }, 500);
    }
  });
  app.post("/api/simple-game/complete-task", async (c) => {
    var _a, _b;
    try {
      const sessionId = (_b = (_a = c.req.header("Cookie")) == null ? void 0 : _a.match(/session=([^;]+)/)) == null ? void 0 : _b[1];
      const user = await getUserFromSession2(sessionId, db);
      if (!user) {
        return c.json({ error: "User not found" }, 404);
      }
      const { task_id } = await c.req.json();
      if (!task_id) {
        return c.json({ error: "Task ID is required" }, 400);
      }
      const result = await gameService.completeTask(user.id, task_id);
      if (result.success) {
        return c.json({
          success: true,
          message: `\u4EFB\u52D9\u5B8C\u6210\uFF01\u7372\u5F97 ${result.points} \u9EDE\u6578\uFF01`
        });
      } else {
        return c.json({ error: result.error }, 500);
      }
    } catch (error) {
      console.error("Error completing task:", error);
      return c.json({ error: error.message }, 500);
    }
  });
  app.get("/api/simple-game/locations", async (c) => {
    try {
      const locations = await gameService.getPenghuLocations();
      return c.json({ success: true, data: locations });
    } catch (error) {
      console.error("Error getting locations:", error);
      return c.json({ error: error.message }, 500);
    }
  });
  app.get("/api/simple-game/tasks", async (c) => {
    var _a, _b;
    try {
      const sessionId = (_b = (_a = c.req.header("Cookie")) == null ? void 0 : _a.match(/session=([^;]+)/)) == null ? void 0 : _b[1];
      const user = await getUserFromSession2(sessionId, db);
      if (!user) {
        return c.json({ error: "User not found" }, 404);
      }
      const tasks = await gameService.getUserTasks(user.id);
      return c.json({ success: true, data: tasks });
    } catch (error) {
      console.error("Error getting tasks:", error);
      return c.json({ error: error.message }, 500);
    }
  });
  app.get("/api/simple-game/badges", async (c) => {
    var _a, _b;
    try {
      const sessionId = (_b = (_a = c.req.header("Cookie")) == null ? void 0 : _a.match(/session=([^;]+)/)) == null ? void 0 : _b[1];
      const user = await getUserFromSession2(sessionId, db);
      if (!user) {
        return c.json({ error: "User not found" }, 404);
      }
      const badges = await gameService.getUserBadges(user.id);
      return c.json({ success: true, data: badges });
    } catch (error) {
      console.error("Error getting badges:", error);
      return c.json({ error: error.message }, 500);
    }
  });
}
async function getUserFromSession2(sessionId, db) {
  try {
    if (!sessionId)
      return null;
    const session = await db.prepare(`
            SELECT * FROM sessions WHERE id = ? AND expires_at > datetime('now')
        `).bind(sessionId).first();
    if (!session)
      return null;
    const user = await db.prepare(`
            SELECT * FROM users WHERE id = ?
        `).bind(session.user_id).first();
    return user;
  } catch (error) {
    console.error("Error getting user from session:", error);
    return null;
  }
}

// src/routes/index.js
init_layout();

// src/pages/ErrorPage.js
init_layout();
function renderErrorPage(request, env, session, user, nonce, cssContent, error) {
  const content = `
    <div class="min-h-screen flex items-center justify-center bg-gray-50 px-4 sm:px-6 lg:px-8">
      <div class="max-w-md w-full space-y-8 text-center bg-white p-10 rounded-xl shadow-2xl">
        <div>
          <span class="text-6xl">\u{1F915}</span>
          <h2 class="mt-6 text-3xl font-extrabold text-gray-900">
            \u54CE\u5440\uFF01\u51FA\u4E86\u4E00\u9EDE\u5C0F\u72C0\u6CC1
          </h2>
          <p class="mt-2 text-sm text-gray-600">
            \u6211\u5011\u7684\u4F3A\u670D\u5668\u9047\u5230\u4E86\u4E00\u4E9B\u9810\u671F\u4E4B\u5916\u7684\u932F\u8AA4\u3002
          </p>
          ${error ? `
            <div class="mt-4 p-4 bg-red-50 rounded-lg text-left overflow-hidden">
               <p class="text-xs text-red-500 font-mono break-all">${error.message || error.toString()}</p>
            </div>
          ` : ""}
        </div>
        <div class="mt-5 sm:mt-8 sm:flex sm:justify-center">
          <div class="rounded-md shadow">
            <a href="/" class="w-full flex items-center justify-center px-8 py-3 border border-transparent text-base font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 md:py-4 md:text-lg transition duration-150 ease-in-out">
              \u56DE\u9996\u9801
            </a>
          </div>
          <div class="mt-3 sm:mt-0 sm:ml-3">
            <button onclick="window.location.reload()" class="w-full flex items-center justify-center px-8 py-3 border border-transparent text-base font-medium rounded-md text-blue-700 bg-blue-100 hover:bg-blue-200 md:py-4 md:text-lg transition duration-150 ease-in-out">
              \u91CD\u8A66
            </button>
          </div>
        </div>
        <div class="mt-6 text-xs text-gray-400">
          <p>\u5982\u679C\u662F\u6301\u7E8C\u6027\u554F\u984C\uFF0C\u8ACB\u806F\u7E6B\u7BA1\u7406\u54E1\u3002</p>
        </div>
      </div>
    </div>
  `;
  return new Response(pageTemplate2({
    title: "500 - \u4F3A\u670D\u5668\u932F\u8AA4",
    content,
    user,
    nonce,
    cssContent,
    useContainer: false
    // 全螢幕佈局
  }), {
    status: 500,
    headers: { "Content-Type": "text/html;charset=utf-8" }
  });
}

// src/routes/index.js
async function renderGoogleInfoPage(request, env, session, user, nonce, cssContent) {
  if (!user) {
    return Response.redirect(new URL(request.url).origin + "/login", 302);
  }
  const escapeHtml3 = (unsafe) => {
    if (!unsafe)
      return "";
    return unsafe.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
  };
  const userName = escapeHtml3(user.name);
  const userEmail = escapeHtml3(user.email);
  const userAvatar = user.avatar_url ? escapeHtml3(user.avatar_url) : null;
  const content = `
    <div class="p-6 bg-white rounded-lg shadow-md">
      <h1 class="text-2xl font-bold mb-6">\u6211\u7684 Google \u5E33\u865F\u8CC7\u8A0A</h1>
      <div class="flex items-center space-x-4 mb-6">
        ${userAvatar ? `<img src="${userAvatar}" alt="User Avatar" class="w-16 h-16 rounded-full object-cover">` : `<span class="w-16 h-16 rounded-full bg-gray-300 flex items-center justify-center text-2xl font-semibold text-white">${userName ? userName.charAt(0).toUpperCase() : "?"}</span>`}
        <div>
          <h2 class="text-xl font-semibold">${userName || "\u4F7F\u7528\u8005\u540D\u7A31\u672A\u63D0\u4F9B"}</h2>
          <p class="text-gray-600">${userEmail || "\u96FB\u5B50\u90F5\u4EF6\u672A\u63D0\u4F9B"}</p>
        </div>
      </div>
      <h3 class="text-lg font-semibold mb-2 border-t pt-4">\u5E33\u865F\u8A73\u60C5</h3>
      <pre class="bg-gray-100 p-4 rounded overflow-x-auto text-sm"><code>${JSON.stringify(user, null, 2)}</code></pre>
      <p class="mt-6 text-sm text-gray-500">\u9019\u662F\u5F9E\u60A8\u7684 Google \u5E33\u865F\u548C\u6211\u5011\u7684\u8CC7\u6599\u5EAB\u4E2D\u8B80\u53D6\u7684\u8CC7\u8A0A\u3002</p>
    </div>
  `;
  return new Response(pageTemplate2({
    title: "Google \u5E33\u865F\u8CC7\u8A0A",
    content,
    user,
    nonce,
    cssContent
  }), {
    headers: { "Content-Type": "text/html;charset=utf-8" }
  });
}
async function routePageRequest(request, env, session, user, nonce, cssContent) {
  const url = new URL(request.url);
  const pathname2 = url.pathname;
  try {
    if (pathname2 === "/" || pathname2 === "/index.html") {
      return await renderHomePage(request, env, session, user, nonce, cssContent);
    }
    if (pathname2 === "/login") {
      if (user) {
        return Response.redirect(url.origin + "/", 302);
      }
      return await renderLoginPage(request, env, session, user, nonce, cssContent);
    }
    if (pathname2.startsWith("/trip-planner/shared/")) {
      const shareToken = pathname2.split("/").pop();
      if (shareToken && shareToken !== "shared") {
        const { renderSharedTripPage: renderSharedTripPage2 } = await Promise.resolve().then(() => (init_TripPlanner(), TripPlanner_exports));
        return await renderSharedTripPage2(request, env, session, user, nonce, cssContent, shareToken);
      }
    }
    if (pathname2.startsWith("/location/")) {
      const locationId = pathname2.split("/").pop();
      if (locationId && locationId !== "location") {
        return await renderLocationDetailPage(request, env, session, user, nonce, cssContent);
      }
    }
    if (pathname2 === "/test") {
      return await renderSimpleTestPage(request, env, session, user, nonce, cssContent);
    }
    if (pathname2 === "/test-simple") {
      return await renderTestPage(request, env, session, user, nonce, cssContent);
    }
    if (!user) {
      return Response.redirect(url.origin + "/login", 302);
    }
    if (pathname2 === "/profile") {
      return await renderProfilePage(request, env, session, user, nonce, cssContent);
    }
    if (pathname2 === "/google-info") {
      return await renderGoogleInfoPage(request, env, session, user, nonce, cssContent);
    }
    if (pathname2 === "/footprints") {
      return await renderFootprintsPage(request, env, session, user, nonce, cssContent);
    }
    if (pathname2 === "/trip-planner") {
      return await renderTripPlannerPage(request, env, session, user, nonce, cssContent);
    }
    if (pathname2 === "/ai-chat") {
      return await renderAIChatPage(request, env, session, user, nonce, cssContent);
    }
    if (pathname2 === "/story-timeline" || pathname2 === "/timeline") {
      return await renderStoryTimelinePage(request, env, session, user, nonce, cssContent);
    }
    if (pathname2 === "/recommendations" || pathname2 === "/recommend") {
      return await renderRecommendationsPage(request, env, session, user, nonce, cssContent);
    }
    if (pathname2 === "/search") {
      return await renderSearchPage(request, env, session, user, nonce, cssContent);
    }
    if (pathname2 === "/favorites") {
      return await renderFavoritesPage(request, env, session, user, nonce, cssContent);
    }
    if (pathname2 === "/game") {
      return await renderPenghuGamePage(request, env, session, user, nonce, cssContent);
    }
    if (pathname2 === "/design-preview") {
      return await renderDesignPreviewPage(request, env, session, user, nonce, cssContent);
    }
    if (pathname2 === "/admin" || pathname2 === "/admin/") {
      return Response.redirect(url.origin + "/admin/dashboard", 302);
    }
    if (pathname2 === "/admin/dashboard") {
      return await renderAdminDashboardPage(request, env, session, user, nonce, cssContent);
    }
    if (pathname2 === "/admin/images") {
      return await renderImageManagementPage(request, env, session, user, nonce, cssContent);
    }
    if (pathname2 === "/admin/ai" || pathname2 === "/ai-admin") {
      return await renderAIAdminPage(request, env, session, user, nonce, cssContent);
    }
    if (pathname2 === "/admin/verifications" || pathname2 === "/admin/business-verification") {
      return await renderBusinessVerificationAdminPage(request, env, session, user, nonce, cssContent);
    }
    if (pathname2 === "/admin/ecosystem") {
      return await renderEcosystemDashboardPage(request, env, session, user, nonce, cssContent);
    }
    return await renderNotFoundPage(request, env, session, user, nonce, cssContent);
  } catch (error) {
    console.error("Route Error:", error);
    return renderErrorPage(request, env, session, user, nonce, cssContent, error);
  }
}
async function handleApiRequest(request, env, session, user, ctx = null) {
  const url = new URL(request.url);
  const path = url.pathname;
  if (path.startsWith("/api/story/")) {
    const { handleStoryRequest: handleStoryRequest2 } = await Promise.resolve().then(() => (init_story(), story_exports));
    return await handleStoryRequest2(request, env, user);
  }
  if (path.startsWith("/api/")) {
    const resource = path.split("/")[2];
    try {
      switch (resource) {
        case "auth":
          return await handleAuthRequest(request, env);
        case "csp-report":
          return await handleCspReport(request, env);
        case "image":
          return await handleImageRequest(request, env, ctx);
        case "admin":
          return await handleAdminRequest(request, env, user);
        case "location":
        case "locations":
          return await handleLocationRequest(request, env, user);
        case "story":
          const { handleStoryRequest: handleStoryRequest2 } = await Promise.resolve().then(() => (init_story(), story_exports));
          return await handleStoryRequest2(request, env, user);
        case "recommendation":
          const { handleRecommendationRequest: handleRecommendationRequest2 } = await Promise.resolve().then(() => (init_recommendation(), recommendation_exports));
          return await handleRecommendationRequest2(request, env, user);
        case "search":
          const { handleSearchRequest: handleSearchRequest2 } = await Promise.resolve().then(() => (init_search(), search_exports));
          return await handleSearchRequest2(request, env, user);
        case "favorites":
          const { handleFavoritesRequest: handleFavoritesRequest2 } = await Promise.resolve().then(() => (init_favorites(), favorites_exports));
          return await handleFavoritesRequest2(request, env, user);
        case "itinerary":
          const { handleItineraryRequest: handleItineraryRequest2 } = await Promise.resolve().then(() => (init_itinerary(), itinerary_exports));
          return await handleItineraryRequest2(request, env, user);
        case "trip-planner":
          const { handleTripPlannerRequest: handleTripPlannerRequest2 } = await Promise.resolve().then(() => (init_trip_planner(), trip_planner_exports));
          return await handleTripPlannerRequest2(request, env, user);
        case "business":
          if (path.startsWith("/api/business/verify/")) {
            const { handleBusinessVerificationRequest: handleBusinessVerificationRequest2 } = await Promise.resolve().then(() => (init_business_verification(), business_verification_exports));
            return await handleBusinessVerificationRequest2(request, env, user);
          }
          return new Response("API resource not Found", { status: 404 });
        case "ai":
          if (path.startsWith("/api/ai/admin/")) {
            const { handleAIAdminRequest: handleAIAdminRequest2 } = await Promise.resolve().then(() => (init_ai_admin(), ai_admin_exports));
            return await handleAIAdminRequest2(request, env, user);
          }
          return await handleAIRequest(request, env, user);
        case "game":
          const { Hono: Hono3 } = await Promise.resolve().then(() => (init_dist(), dist_exports));
          const app = new Hono3();
          createGameRoutes(app, env.DB);
          return await app.fetch(request);
        case "penghu-game":
          const { Hono: PenghuHono } = await Promise.resolve().then(() => (init_dist(), dist_exports));
          const penghuApp = new PenghuHono();
          createPenghuGameRoutes(penghuApp, env.DB);
          return await penghuApp.fetch(request);
        case "simple-game":
          const { Hono: SimpleHono } = await Promise.resolve().then(() => (init_dist(), dist_exports));
          const simpleApp = new SimpleHono();
          createSimpleGameRoutes(simpleApp, env.DB);
          return await simpleApp.fetch(request);
        case "digital-cards":
          return new Response("API temporarily disabled", { status: 503 });
        default:
          return new Response("API resource not Found", { status: 404 });
      }
    } catch (error) {
      console.error("API Error:", error);
      return new Response(JSON.stringify({ error: "Internal server error" }), {
        status: 500,
        headers: { "Content-Type": "application/json" }
      });
    }
  }
  console.warn("Request reached end of handleApiRequest without matching API route:", path);
  return new Response("API route not Found", { status: 404 });
}

// src/modules/auth/google.js
function generateSecureId(length = 32) {
  const randomBytes2 = new Uint8Array(length);
  crypto.getRandomValues(randomBytes2);
  return Array.from(randomBytes2).map((b) => b.toString(16).padStart(2, "0")).join("");
}
function initiateGoogleAuth(requestUrl, env) {
  console.log("[Auth Google Module] Initiating flow...");
  const clientId = env.GOOGLE_CLIENT_ID;
  if (!clientId)
    throw new Error("[Auth Google Module] GOOGLE_CLIENT_ID missing in environment.");
  const redirectUri = `${requestUrl.origin}/api/auth/google/callback`;
  const scope = "openid email profile";
  const state = crypto.randomUUID();
  const stateCookie = `google_oauth_state=${state}; Path=/; HttpOnly; Secure; SameSite=Lax; Max-Age=300`;
  console.log("[Auth Google Module] Setting state cookie header (No SameSite):", stateCookie);
  const authUrl = new URL("https://accounts.google.com/o/oauth2/v2/auth");
  authUrl.searchParams.set("client_id", clientId);
  authUrl.searchParams.set("redirect_uri", redirectUri);
  authUrl.searchParams.set("response_type", "code");
  authUrl.searchParams.set("scope", scope);
  authUrl.searchParams.set("state", state);
  console.log(`[Auth Google Module] Redirecting user to: ${authUrl.toString()}`);
  const headers = new Headers({
    "Location": authUrl.toString(),
    "Content-Type": "text/plain",
    // 302 responses don't strictly need a content-type, but good practice
    "Set-Cookie": stateCookie
  });
  return new Response(null, { status: 302, headers });
}
function initiateGmbAuth(requestUrl, env, existingUserId = null) {
  console.log("[Auth Google Module] Initiating GMB scope request flow...");
  const clientId = env.GOOGLE_CLIENT_ID;
  if (!clientId)
    throw new Error("[Auth Google Module] GOOGLE_CLIENT_ID missing in environment.");
  const redirectUri = "https://www.hopenghu.cc/api/auth/google/callback";
  const scope = "openid email profile https://www.googleapis.com/auth/business.manage";
  const state = crypto.randomUUID();
  const stateCookie = `google_gmb_state=${state}; Path=/; HttpOnly; Secure; Max-Age=300`;
  console.log("[Auth Google Module] Setting GMB state cookie header:", stateCookie);
  const authUrl = new URL("https://accounts.google.com/o/oauth2/v2/auth");
  authUrl.searchParams.set("client_id", clientId);
  authUrl.searchParams.set("redirect_uri", redirectUri);
  authUrl.searchParams.set("response_type", "code");
  authUrl.searchParams.set("scope", scope);
  authUrl.searchParams.set("state", state);
  console.log(`[Auth Google Module] Redirecting user for GMB scope to: ${authUrl.toString()}`);
  const headers = new Headers({
    "Location": authUrl.toString(),
    "Set-Cookie": stateCookie
  });
  return new Response(null, { status: 302, headers });
}
async function handleGoogleCallback(request, env) {
  const url = new URL(request.url);
  const responseHeaders = new Headers();
  console.log("[Auth Google Callback Module] Handling callback...");
  try {
    const stateParam = url.searchParams.get("state");
    const cookieHeader = request.headers.get("Cookie") || "";
    console.log("[Auth Google Callback Module] Received Cookie header:", cookieHeader);
    const stateCookieMatch = cookieHeader.match(/google_oauth_state=([^;]+)/);
    const storedState = stateCookieMatch ? stateCookieMatch[1] : null;
    responseHeaders.set("Set-Cookie", "google_oauth_state=; Path=/; Expires=Thu, 01 Jan 1970 00:00:00 GMT; HttpOnly; Secure");
    console.log(`[Auth Google Callback Module] State validation: URL='${stateParam}', Cookie='${storedState}'`);
    if (!stateParam || !storedState || stateParam !== storedState) {
      throw new Error("OAuth state validation failed.");
    }
    console.log("[Auth Google Callback Module] State validation successful.");
    const code = url.searchParams.get("code");
    if (!code)
      throw new Error("Missing code parameter.");
    console.log("[Auth Google Callback Module] Exchanging code for token...");
    const tokenResponse = await fetch("https://oauth2.googleapis.com/token", {
      method: "POST",
      headers: { "Content-Type": "application/x-www-form-urlencoded" },
      body: new URLSearchParams({
        code,
        client_id: env.GOOGLE_CLIENT_ID,
        client_secret: env.GOOGLE_CLIENT_SECRET,
        redirect_uri: `${url.origin}/api/auth/google/callback`,
        grant_type: "authorization_code"
      })
    });
    if (!tokenResponse.ok) {
      const errorBody = await tokenResponse.text();
      throw new Error(`Token exchange failed: ${tokenResponse.status} - ${errorBody}`);
    }
    const tokenData = await tokenResponse.json();
    const accessToken = tokenData.access_token;
    if (!accessToken)
      throw new Error("Access token not found in response.");
    console.log("[Auth Google Callback Module] Token exchange successful.");
    console.log("[Auth Google Callback Module] Fetching user info...");
    const userInfoResponse = await fetch("https://www.googleapis.com/oauth2/v2/userinfo", {
      headers: { Authorization: `Bearer ${accessToken}` }
    });
    if (!userInfoResponse.ok) {
      const errorBody = await userInfoResponse.text();
      throw new Error(`Fetching user info failed: ${userInfoResponse.status} - ${errorBody}`);
    }
    const userInfo = await userInfoResponse.json();
    if (!userInfo || !userInfo.id || !userInfo.email) {
      console.error("[Auth Google Callback Module] Incomplete user info received:", userInfo);
      throw new Error("Incomplete user info from Google.");
    }
    console.log("[Auth Google Callback Module] Raw user info:", userInfo);
    const db = env.DB;
    if (!db)
      throw new Error("Database binding (DB) not found in environment.");
    const userEmail = userInfo.email;
    const googleId = String(userInfo.id);
    const userName = userInfo.name || "Google User";
    const avatarUrl = userInfo.picture || "";
    const now = /* @__PURE__ */ new Date();
    const nowIso = now.toISOString();
    let userId;
    let isNewUser = false;
    console.log(`[Auth Google Callback Module] Checking for user: ${userEmail}`);
    const existingUser = await db.prepare("SELECT id FROM users WHERE email = ?").bind(userEmail).first();
    if (existingUser) {
      userId = existingUser.id;
      console.log(`[Auth Google Callback Module] Updating existing user: ${userId}`);
      const stmt = db.prepare("UPDATE users SET name = ?, google_id = ?, avatar_url = ?, updated_at = ? WHERE id = ?");
      await stmt.bind(userName, googleId, avatarUrl, nowIso, userId).run();
    } else {
      isNewUser = true;
      console.log(`[Auth Google Callback Module] Creating new user (Auto-ID)`);
      const stmt = db.prepare("INSERT INTO users (email, name, google_id, avatar_url, created_at, updated_at) VALUES (?, ?, ?, ?, ?, ?)");
      console.log("[Auth Google Callback Module] Binding INSERT values:", { email: userEmail, name: userName, google_id: googleId, avatar_url: avatarUrl, created_at: nowIso, updated_at: nowIso });
      const result = await stmt.bind(userEmail, userName, googleId, avatarUrl, nowIso, nowIso).run();
      if (result.meta && result.meta.last_row_id) {
        userId = result.meta.last_row_id;
        console.log("[Auth Google Callback Module] New user created successfully. ID:", userId);
      } else {
        console.error("[Auth Google Callback Module] Failed to retrieve new user ID from insert result:", result);
        throw new Error("Failed to create new user: Could not retrieve ID.");
      }
    }
    console.log(`[Auth Google Callback Module] Creating session for user: ${userId}`);
    const sessionId = generateSecureId();
    const expiresAt = new Date(now.getTime() + 7 * 24 * 60 * 60 * 1e3);
    const expiresAtIso = expiresAt.toISOString();
    const sessionStmt = db.prepare("INSERT INTO sessions (id, user_id, expires_at, created_at) VALUES (?, ?, ?, ?)");
    await sessionStmt.bind(sessionId, userId, expiresAtIso, nowIso).run();
    console.log(`[Auth Google Callback Module] Session created: ${sessionId}`);
    const sessionCookie = `session=${sessionId}; Path=/; HttpOnly; Secure; SameSite=Lax; Max-Age=${7 * 24 * 60 * 60}`;
    responseHeaders.append("Set-Cookie", sessionCookie);
    responseHeaders.append("Location", "/");
    console.log("[Auth Google Callback Module] Success. Session created:", sessionId);
    console.log("[Auth Google Callback Module] User created/updated:", { userId, email: userEmail, name: userName, avatar_url: avatarUrl });
    console.log("[Auth Google Callback Module] Redirecting to homepage with session cookie...");
    return new Response(null, { status: 302, headers: responseHeaders });
  } catch (error) {
    console.error("[Auth Google Callback Module] Error:", error);
    responseHeaders.set("Content-Type", "text/plain");
    return new Response(`Authentication Failed: ${error.message}`, { status: 500, headers: responseHeaders });
  }
}

// src/worker.js
init_html2();

// src/styles/tailwind.output.css
var tailwind_output_default = '*,::backdrop,:after,:before{--tw-border-spacing-x:0;--tw-border-spacing-y:0;--tw-translate-x:0;--tw-translate-y:0;--tw-rotate:0;--tw-skew-x:0;--tw-skew-y:0;--tw-scale-x:1;--tw-scale-y:1;--tw-pan-x: ;--tw-pan-y: ;--tw-pinch-zoom: ;--tw-scroll-snap-strictness:proximity;--tw-gradient-from-position: ;--tw-gradient-via-position: ;--tw-gradient-to-position: ;--tw-ordinal: ;--tw-slashed-zero: ;--tw-numeric-figure: ;--tw-numeric-spacing: ;--tw-numeric-fraction: ;--tw-ring-inset: ;--tw-ring-offset-width:0px;--tw-ring-offset-color:#fff;--tw-ring-color:#3b82f680;--tw-ring-offset-shadow:0 0 #0000;--tw-ring-shadow:0 0 #0000;--tw-shadow:0 0 #0000;--tw-shadow-colored:0 0 #0000;--tw-blur: ;--tw-brightness: ;--tw-contrast: ;--tw-grayscale: ;--tw-hue-rotate: ;--tw-invert: ;--tw-saturate: ;--tw-sepia: ;--tw-drop-shadow: ;--tw-backdrop-blur: ;--tw-backdrop-brightness: ;--tw-backdrop-contrast: ;--tw-backdrop-grayscale: ;--tw-backdrop-hue-rotate: ;--tw-backdrop-invert: ;--tw-backdrop-opacity: ;--tw-backdrop-saturate: ;--tw-backdrop-sepia: ;--tw-contain-size: ;--tw-contain-layout: ;--tw-contain-paint: ;--tw-contain-style: }/*! tailwindcss v3.4.19 | MIT License | https://tailwindcss.com*/*,:after,:before{box-sizing:border-box;border:0 solid #e5e7eb}:after,:before{--tw-content:""}:host,html{line-height:1.5;-webkit-text-size-adjust:100%;tab-size:4;font-family:Noto Sans TC,sans-serif;font-feature-settings:normal;font-variation-settings:normal;-webkit-tap-highlight-color:transparent}body{margin:0;line-height:inherit}hr{height:0;color:inherit;border-top-width:1px}abbr:where([title]){-webkit-text-decoration:underline dotted;text-decoration:underline dotted}h1,h2,h3,h4,h5,h6{font-size:inherit;font-weight:inherit}a{color:inherit;text-decoration:inherit}b,strong{font-weight:bolder}code,kbd,pre,samp{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,Liberation Mono,Courier New,monospace;font-feature-settings:normal;font-variation-settings:normal;font-size:1em}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:initial}sub{bottom:-.25em}sup{top:-.5em}table{text-indent:0;border-color:inherit;border-collapse:collapse}button,input,optgroup,select,textarea{font-family:inherit;font-feature-settings:inherit;font-variation-settings:inherit;font-size:100%;font-weight:inherit;line-height:inherit;letter-spacing:inherit;color:inherit;margin:0;padding:0}button,select{text-transform:none}button,input:where([type=button]),input:where([type=reset]),input:where([type=submit]){-webkit-appearance:button;background-color:initial;background-image:none}:-moz-focusring{outline:auto}:-moz-ui-invalid{box-shadow:none}progress{vertical-align:initial}::-webkit-inner-spin-button,::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}summary{display:list-item}blockquote,dd,dl,figure,h1,h2,h3,h4,h5,h6,hr,p,pre{margin:0}fieldset{margin:0}fieldset,legend{padding:0}menu,ol,ul{list-style:none;margin:0;padding:0}dialog{padding:0}textarea{resize:vertical}input::placeholder,textarea::placeholder{opacity:1;color:#9ca3af}[role=button],button{cursor:pointer}:disabled{cursor:default}audio,canvas,embed,iframe,img,object,svg,video{display:block;vertical-align:middle}img,video{max-width:100%;height:auto}[hidden]:where(:not([hidden=until-found])){display:none}:root{--primary-color:#1a73e8;--primary-light:#4ecdc4;--accent-color:#ff6b6b;--background-color:#fff;--text-color:#333;--border-color:#e0e0e0;--shadow-color:#0000001a;--font-family:"Noto Sans TC",sans-serif}*{margin:0;box-sizing:border-box;padding:0}html{-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}body{font-family:var(--font-family);line-height:1.6}h1,h2,h3,h4,h5,h6{font-family:Noto Serif TC,serif}.\\!container{width:100%!important}.container{width:100%}@media (min-width:640px){.\\!container{max-width:640px!important}.container{max-width:640px}}@media (min-width:768px){.\\!container{max-width:768px!important}.container{max-width:768px}}@media (min-width:1024px){.\\!container{max-width:1024px!important}.container{max-width:1024px}}@media (min-width:1280px){.\\!container{max-width:1280px!important}.container{max-width:1280px}}@media (min-width:1536px){.\\!container{max-width:1536px!important}.container{max-width:1536px}}.\\!container{margin-left:auto;margin-right:auto;max-width:80rem;padding-left:1rem;padding-right:1rem}@media (min-width:640px){.\\!container{padding-left:1.5rem;padding-right:1.5rem}}@media (min-width:1024px){.\\!container{padding-left:2rem;padding-right:2rem}}.container{margin-left:auto;margin-right:auto;max-width:80rem;padding-left:1rem;padding-right:1rem}@media (min-width:640px){.container{padding-left:1.5rem;padding-right:1.5rem}}@media (min-width:1024px){.container{padding-left:2rem;padding-right:2rem}}.header{position:-webkit-sticky;position:sticky;top:0;z-index:100;border-bottom-width:1px;--tw-border-opacity:1;border-color:rgb(224 224 224/var(--tw-border-opacity,1));background-color:#fffc;padding-top:1rem;padding-bottom:1rem;--tw-backdrop-blur:blur(12px);-webkit-backdrop-filter:var(--tw-backdrop-blur) var(--tw-backdrop-brightness) var(--tw-backdrop-contrast) var(--tw-backdrop-grayscale) var(--tw-backdrop-hue-rotate) var(--tw-backdrop-invert) var(--tw-backdrop-opacity) var(--tw-backdrop-saturate) var(--tw-backdrop-sepia);backdrop-filter:var(--tw-backdrop-blur) var(--tw-backdrop-brightness) var(--tw-backdrop-contrast) var(--tw-backdrop-grayscale) var(--tw-backdrop-hue-rotate) var(--tw-backdrop-invert) var(--tw-backdrop-opacity) var(--tw-backdrop-saturate) var(--tw-backdrop-sepia)}.nav{display:flex;align-items:center;justify-content:space-between}.nav-logo{font-size:1.5rem;line-height:2rem;font-weight:700;--tw-text-opacity:1;color:rgb(26 115 232/var(--tw-text-opacity,1));-webkit-text-decoration-line:none;text-decoration-line:none;color:var(--primary-color)}.image-error-message.nav-menu{display:none}.nav-menu{display:none;list-style-type:none;align-items:center;gap:1.5rem}@media (min-width:768px){.nav-menu{display:flex}}.nav-link-active{font-weight:500;--tw-text-opacity:1;color:rgb(0 102 204/var(--tw-text-opacity,1))}.mobile-menu-toggle{cursor:pointer;border-style:none;background-image:none;font-size:1.5rem;line-height:2rem;--tw-text-opacity:1;color:rgb(51 51 51/var(--tw-text-opacity,1))}@media (min-width:768px){.mobile-menu-toggle,.mobile-menu-toggle.image-error-message{display:none}}.\\!button,.button{display:inline-block;cursor:pointer;border-radius:.25rem;padding:.5rem 1rem;font-weight:500;-webkit-text-decoration-line:none;text-decoration-line:none;transition-property:all;transition-timing-function:cubic-bezier(.4,0,.2,1);transition-duration:.3s}.\\!button{padding:.5rem 1rem!important;border-radius:.25rem!important}.button{padding:.5rem 1rem;border-radius:.25rem}.button-primary{border-style:none;--tw-bg-opacity:1;background-color:rgb(37 99 235/var(--tw-bg-opacity,1));--tw-text-opacity:1;color:rgb(255 255 255/var(--tw-text-opacity,1))}.button-primary:hover{--tw-bg-opacity:1;background-color:rgb(29 78 216/var(--tw-bg-opacity,1))}.button-primary{background-color:var(--primary-color)}.button-primary:hover{background-color:#1558b0}.button-secondary{border-style:none;--tw-bg-opacity:1;background-color:rgb(107 114 128/var(--tw-bg-opacity,1));--tw-text-opacity:1;color:rgb(255 255 255/var(--tw-text-opacity,1))}.button-secondary:hover{--tw-bg-opacity:1;background-color:rgb(75 85 99/var(--tw-bg-opacity,1))}.button-secondary:hover{background-color:#5a6268}.footer{margin-top:4rem;border-top-width:1px;--tw-border-opacity:1;border-color:rgb(224 224 224/var(--tw-border-opacity,1));--tw-bg-opacity:1;background-color:rgb(243 244 246/var(--tw-bg-opacity,1));padding-top:1rem;padding-bottom:1rem;text-align:center}@media (max-width:768px){.image-error-message.nav-menu,.nav-menu{display:none}.nav-menu{position:absolute;top:100%;left:0;right:0;flex-direction:column;align-items:stretch;gap:1rem;border-bottom-width:1px;--tw-border-opacity:1;border-color:rgb(224 224 224/var(--tw-border-opacity,1));--tw-bg-opacity:1;background-color:rgb(255 255 255/var(--tw-bg-opacity,1));padding:1rem;--tw-shadow:0 4px 6px -1px #0000001a,0 2px 4px -1px #0000000f;--tw-shadow-colored:0 4px 6px -1px var(--tw-shadow-color),0 2px 4px -1px var(--tw-shadow-color);box-shadow:var(--tw-ring-offset-shadow,0 0 #0000),var(--tw-ring-shadow,0 0 #0000),var(--tw-shadow)}.nav-menu.active{display:flex}.nav-menu .\\!button,.nav-menu .button{width:100%;text-align:center}}.nav-menu-item-avatar{position:relative;display:flex;align-items:center}.avatar-container-div{cursor:pointer;border-style:none;background-color:initial;padding:0}.user-avatar{display:inline-block;height:2rem;width:2rem;cursor:pointer;border-radius:9999px;border-width:2px;border-color:#0000;object-fit:cover;vertical-align:middle;transition-property:color,background-color,border-color,fill,stroke,-webkit-text-decoration-color;transition-property:color,background-color,border-color,text-decoration-color,fill,stroke;transition-property:color,background-color,border-color,text-decoration-color,fill,stroke,-webkit-text-decoration-color;transition-timing-function:cubic-bezier(.4,0,.2,1);transition-duration:.2s}.avatar-container-div:focus .user-avatar,.user-avatar:hover{border-color:var(--primary-color)}.avatar-fallback{height:2rem;width:2rem;border-radius:9999px;text-align:center;font-size:1rem;font-weight:700;line-height:2rem;--tw-text-opacity:1;color:rgb(255 255 255/var(--tw-text-opacity,1));background-color:#4ecdc4}.image-error-message.user-dropdown{display:none}.user-dropdown{position:absolute;top:100%;right:0;z-index:50;margin-top:.5rem;display:none;min-width:160px;border-radius:.375rem;border-width:1px;--tw-border-opacity:1;border-color:rgb(224 224 224/var(--tw-border-opacity,1));--tw-bg-opacity:1;background-color:rgb(255 255 255/var(--tw-bg-opacity,1));padding-top:.25rem;padding-bottom:.25rem;--tw-shadow:0 4px 6px -1px #0000001a,0 2px 4px -1px #0000000f;--tw-shadow-colored:0 4px 6px -1px var(--tw-shadow-color),0 2px 4px -1px var(--tw-shadow-color);box-shadow:var(--tw-ring-offset-shadow,0 0 #0000),var(--tw-ring-shadow,0 0 #0000),var(--tw-shadow)}.user-dropdown.dropdown-active{display:block}.dropdown-header{border-bottom-width:1px;--tw-border-opacity:1;border-color:rgb(224 224 224/var(--tw-border-opacity,1));padding:.5rem 1rem}.dropdown-header-name{font-size:.875rem;line-height:1.25rem;font-weight:500;color:rgb(17 24 39/var(--tw-text-opacity,1))}.dropdown-header-email,.dropdown-header-name{margin:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;--tw-text-opacity:1}.dropdown-header-email{font-size:.75rem;line-height:1rem;color:rgb(107 114 128/var(--tw-text-opacity,1))}.dropdown-item{display:block;white-space:nowrap;padding:.5rem 1rem;font-size:.875rem;line-height:1.25rem;--tw-text-opacity:1;color:rgb(51 51 51/var(--tw-text-opacity,1));-webkit-text-decoration-line:none;text-decoration-line:none}.dropdown-item:hover{--tw-bg-opacity:1;background-color:rgb(243 244 246/var(--tw-bg-opacity,1));--tw-text-opacity:1;color:rgb(26 115 232/var(--tw-text-opacity,1))}.dropdown-item{color:var(--text-color)}.dropdown-divider{margin-top:.25rem;margin-bottom:.25rem;height:1px;--tw-bg-opacity:1;background-color:rgb(224 224 224/var(--tw-bg-opacity,1))}#logout-button{width:100%;cursor:pointer;border-style:none;background-color:initial;text-align:left;--tw-text-opacity:1;color:rgb(220 38 38/var(--tw-text-opacity,1))}#logout-button:hover{--tw-bg-opacity:1;background-color:rgb(254 242 242/var(--tw-bg-opacity,1))}.category-label.active{--tw-border-opacity:1;border-color:rgb(0 102 204/var(--tw-border-opacity,1));--tw-bg-opacity:1;background-color:rgb(0 102 204/var(--tw-bg-opacity,1));--tw-text-opacity:1;color:rgb(255 255 255/var(--tw-text-opacity,1))}.error-message{margin-bottom:1rem;border-radius:.375rem;--tw-bg-opacity:1;background-color:rgb(254 226 226/var(--tw-bg-opacity,1));padding:1rem;--tw-text-opacity:1;color:rgb(185 28 28/var(--tw-text-opacity,1))}.error-state-icon{margin-bottom:.5rem;--tw-text-opacity:1;color:rgb(239 68 68/var(--tw-text-opacity,1))}.error-state-title{margin-bottom:.25rem;font-weight:600;--tw-text-opacity:1;color:rgb(153 27 27/var(--tw-text-opacity,1))}.error-state-message{font-size:.875rem;line-height:1.25rem;--tw-text-opacity:1;color:rgb(220 38 38/var(--tw-text-opacity,1))}.image-error-message{display:flex;flex-direction:column;align-items:center;justify-content:center;-webkit-backdrop-filter:blur(4px);backdrop-filter:blur(4px)}.image-error-message svg{margin-bottom:.5rem;height:2rem;width:2rem;--tw-text-opacity:1;color:rgb(156 163 175/var(--tw-text-opacity,1))}.image-error-message p{font-size:.75rem;line-height:1rem;--tw-text-opacity:1;color:rgb(107 114 128/var(--tw-text-opacity,1))}.loading-spinner{animation:spin 1s linear infinite;border-radius:9999px;border-bottom-width:2px;--tw-border-opacity:1;border-color:rgb(37 99 235/var(--tw-border-opacity,1));width:40px;height:40px}.location-detail-panel{position:fixed;top:0;left:0;width:100%;height:100%;z-index:1000;display:flex;align-items:center;justify-content:center;opacity:0;visibility:hidden;transition:all .3s ease}.location-detail-panel.visible{opacity:1;visibility:visible}.detail-panel-overlay{position:absolute;top:0;left:0;width:100%;height:100%;background:#00000080;-webkit-backdrop-filter:blur(4px);backdrop-filter:blur(4px);cursor:pointer}.detail-panel-content{position:relative;background:#fff;border-radius:16px;overflow:hidden;box-shadow:0 20px 60px #0000004d;max-width:90vw;max-height:90vh;width:100%;height:100%;transform:translateX(100%);transition:transform .3s ease;display:flex;flex-direction:column}.location-detail-panel.visible .detail-panel-content{transform:translateX(0)}@media (min-width:1024px){.detail-panel-content{width:400px;height:90vh;max-width:25vw;margin-left:auto;margin-right:0}.location-detail-panel{justify-content:flex-end}}@media (max-width:1023px){.detail-panel-content{width:100%;height:100%;max-width:100vw;max-height:100vh;border-radius:0}.location-detail-panel{justify-content:center}}.detail-panel-close-mobile{position:absolute;top:16px;left:16px;width:40px;height:40px;border:none;background:#ffffffe6;border-radius:50%;display:flex;align-items:center;justify-content:center;cursor:pointer;z-index:10;-webkit-backdrop-filter:blur(10px);backdrop-filter:blur(10px);transition:all .2s ease}.detail-panel-close-mobile:hover{background:#fff;transform:scale(1.1)}.detail-panel-close-desktop{position:absolute;top:16px;right:16px;width:32px;height:32px;border:none;background:#0000001a;border-radius:50%;display:flex;align-items:center;justify-content:center;cursor:pointer;z-index:10;transition:all .2s ease}.detail-panel-close-desktop:hover{background:#0003;transform:scale(1.1)}@media (max-width:1023px){.detail-panel-close-desktop{display:none}}@media (min-width:1024px){.detail-panel-close-mobile{display:none}}.detail-panel-image{position:relative;width:100%;height:250px;overflow:hidden;background:#f5f5f5}.detail-panel-img{width:100%;height:100%;object-fit:cover}.status-badge{position:absolute;top:12px;right:12px;padding:6px 12px;border-radius:16px;font-size:14px;font-weight:600;color:#fff;z-index:2;-webkit-backdrop-filter:blur(10px);backdrop-filter:blur(10px)}.detail-panel-info{flex:1;padding:24px;overflow-y:auto}.detail-panel-title{font-size:24px;font-weight:700;color:#1f2937;margin:0 0 16px;line-height:1.3}.detail-panel-meta{margin-bottom:20px}.meta-item{display:flex;align-items:center;gap:8px;margin-bottom:8px;color:#6b7280;font-size:14px}.meta-item svg{flex-shrink:0;color:#9ca3af}.meta-item a{color:#3b82f6;text-decoration:none}.meta-item a:hover{text-decoration:underline}.detail-panel-actions{margin-top:24px}.detail-panel-actions h3{font-size:16px;font-weight:600;color:#374151;margin:0 0 12px}.action-buttons{display:flex;gap:8px;flex-wrap:wrap}.status-btn{padding:8px 16px;border:none;border-radius:8px;font-size:14px;font-weight:500;cursor:pointer;transition:all .2s ease;display:flex;align-items:center;gap:4px}.status-btn:hover{transform:translateY(-1px);box-shadow:0 4px 8px #0000001a}.status-btn:active{transform:translateY(0)}@media (max-width:640px){.detail-panel-info{padding:16px}.detail-panel-title{font-size:20px}.detail-panel-image{height:200px}.action-buttons{flex-direction:column}.status-btn{justify-content:center}}@keyframes slideInFromRight{0%{transform:translateX(100%)}to{transform:translateX(0)}}@keyframes slideOutToRight{0%{transform:translateX(0)}to{transform:translateX(100%)}}.location-card{transition:transform .2s ease,box-shadow .2s ease}.location-card:hover{transform:translateY(-2px);box-shadow:0 8px 25px #00000026}.image-loader-container{position:relative;width:100%;height:100%;overflow:hidden}.image-loader-img{width:100%;height:100%;object-fit:cover}.image-skeleton{position:absolute;top:0;left:0;width:100%;height:100%;background:linear-gradient(90deg,#f0f0f0 25%,#e0e0e0 50%,#f0f0f0 75%);background-size:200% 100%;animation:shimmer 1.5s infinite;z-index:1}@keyframes shimmer{0%{background-position:-200% 0}to{background-position:200% 0}}.image-progress{position:absolute;top:0;left:0;width:100%;height:100%;justify-content:center;background:#fffc;z-index:2}.image-progress,.image-progress-spinner{display:flex;align-items:center}.image-preview-container{position:relative;overflow:hidden}.image-preview-thumbnail{transition:transform .3s ease}.image-preview-overlay{transition:opacity .3s ease}.image-preview-modal{animation:fadeIn .3s ease}@keyframes fadeIn{0%{opacity:0}to{opacity:1}}.image-preview-content{animation:zoomIn .3s ease}@keyframes zoomIn{0%{transform:scale(.9);opacity:0}to{transform:scale(1);opacity:1}}.image-preview-close,.image-preview-download{-webkit-backdrop-filter:blur(4px);backdrop-filter:blur(4px)}.image-preview-close:hover,.image-preview-download:hover{transform:scale(1.1)}.image-error-message{position:absolute;top:0;left:0;width:100%;height:100%;display:flex;flex-direction:column;align-items:center;justify-content:center;background:#f9fafbf2;z-index:3}.image-error-message.hidden{display:none}@media (max-width:640px){.image-progress,.image-skeleton{border-radius:8px}}.sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border-width:0}.pointer-events-none{pointer-events:none}.pointer-events-auto{pointer-events:auto}.visible{visibility:visible}.collapse{visibility:collapse}.static{position:static}.fixed{position:fixed}.absolute{position:absolute}.relative{position:relative}.inset-0{inset:0}.-left-2{left:-.5rem}.bottom-0{bottom:0}.bottom-4{bottom:1rem}.bottom-\\[-54px\\]{bottom:-54px}.bottom-full{bottom:100%}.left-0{left:0}.left-1\\/2{left:50%}.left-2{left:.5rem}.left-4{left:1rem}.right-0{right:0}.right-4{right:1rem}.top-0{top:0}.top-12{top:3rem}.top-2{top:.5rem}.top-4{top:1rem}.top-6{top:1.5rem}.top-8{top:2rem}.top-full{top:100%}.z-10{z-index:10}.z-20{z-index:20}.z-30{z-index:30}.z-40{z-index:40}.z-50{z-index:50}.z-\\[101\\]{z-index:101}.z-\\[110\\]{z-index:110}.z-\\[90\\]{z-index:90}.col-span-full{grid-column:1/-1}.mx-4{margin-left:1rem;margin-right:1rem}.mx-auto{margin-left:auto;margin-right:auto}.my-1{margin-top:.25rem;margin-bottom:.25rem}.my-2{margin-top:.5rem;margin-bottom:.5rem}.-mb-px{margin-bottom:-1px}.mb-0{margin-bottom:0}.mb-0\\.5{margin-bottom:.125rem}.mb-1{margin-bottom:.25rem}.mb-2{margin-bottom:.5rem}.mb-3{margin-bottom:.75rem}.mb-4{margin-bottom:1rem}.mb-5{margin-bottom:1.25rem}.mb-6{margin-bottom:1.5rem}.mb-8{margin-bottom:2rem}.ml-2{margin-left:.5rem}.ml-3{margin-left:.75rem}.ml-4{margin-left:1rem}.ml-5{margin-left:1.25rem}.mr-1{margin-right:.25rem}.mr-2{margin-right:.5rem}.mr-4{margin-right:1rem}.mt-1{margin-top:.25rem}.mt-1\\.5{margin-top:.375rem}.mt-2{margin-top:.5rem}.mt-3{margin-top:.75rem}.mt-4{margin-top:1rem}.mt-5{margin-top:1.25rem}.mt-6{margin-top:1.5rem}.mt-8{margin-top:2rem}.mt-auto{margin-top:auto}.line-clamp-1{-webkit-line-clamp:1}.line-clamp-1,.line-clamp-2{overflow:hidden;display:-webkit-box;-webkit-box-orient:vertical}.line-clamp-2{-webkit-line-clamp:2}.line-clamp-3{overflow:hidden;display:-webkit-box;-webkit-box-orient:vertical;-webkit-line-clamp:3}.block{display:block}.inline-block{display:inline-block}.inline{display:inline}.flex{display:flex}.inline-flex{display:inline-flex}.table{display:table}.grid{display:grid}.contents{display:contents}.hidden{display:none}.aspect-\\[3\\/4\\]{aspect-ratio:3/4}.aspect-\\[4\\/3\\]{aspect-ratio:4/3}.h-1{height:.25rem}.h-1\\.5{height:.375rem}.h-10{height:2.5rem}.h-11{height:2.75rem}.h-12{height:3rem}.h-14{height:3.5rem}.h-16{height:4rem}.h-2{height:.5rem}.h-3{height:.75rem}.h-4{height:1rem}.h-48{height:12rem}.h-5{height:1.25rem}.h-6{height:1.5rem}.h-7{height:1.75rem}.h-8{height:2rem}.h-\\[100dvh\\]{height:100dvh}.h-\\[100px\\]{height:100px}.h-\\[1px\\]{height:1px}.h-auto{height:auto}.h-full{height:100%}.max-h-12{max-height:3rem}.max-h-48{max-height:12rem}.max-h-\\[50vh\\]{max-height:50vh}.max-h-\\[90vh\\]{max-height:90vh}.max-h-\\[calc\\(50vh-60px\\)\\]{max-height:calc(50vh - 60px)}.max-h-full{max-height:100%}.min-h-0{min-height:0}.min-h-\\[70vh\\]{min-height:70vh}.min-h-screen{min-height:100vh}.w-0{width:0}.w-1\\/2{width:50%}.w-1\\/3{width:33.333333%}.w-1\\/4{width:25%}.w-10{width:2.5rem}.w-11{width:2.75rem}.w-12{width:3rem}.w-14{width:3.5rem}.w-16{width:4rem}.w-2{width:.5rem}.w-24{width:6rem}.w-4{width:1rem}.w-44{width:11rem}.w-5{width:1.25rem}.w-5\\/6{width:83.333333%}.w-6{width:1.5rem}.w-7{width:1.75rem}.w-8{width:2rem}.w-\\[2px\\]{width:2px}.w-\\[30\\%\\]{width:30%}.w-\\[90\\%\\]{width:90%}.w-fit{width:-webkit-fit-content;width:fit-content}.w-full{width:100%}.min-w-0{min-width:0}.min-w-\\[180px\\]{min-width:180px}.min-w-\\[300px\\]{min-width:300px}.max-w-2xl{max-width:42rem}.max-w-4xl{max-width:56rem}.max-w-6xl{max-width:72rem}.max-w-7xl{max-width:80rem}.max-w-\\[160px\\]{max-width:160px}.max-w-\\[260px\\]{max-width:260px}.max-w-\\[340px\\]{max-width:340px}.max-w-full{max-width:100%}.max-w-lg{max-width:32rem}.max-w-md{max-width:28rem}.max-w-sm{max-width:24rem}.flex-1{flex:1 1 0%}.flex-shrink{flex-shrink:1}.flex-shrink-0{flex-shrink:0}.flex-grow{flex-grow:1}.border-collapse{border-collapse:collapse}.-translate-x-1\\/2{--tw-translate-x:-50%}.-translate-x-1\\/2,.translate-x-full{transform:translate(var(--tw-translate-x),var(--tw-translate-y)) rotate(var(--tw-rotate)) skewX(var(--tw-skew-x)) skewY(var(--tw-skew-y)) scaleX(var(--tw-scale-x)) scaleY(var(--tw-scale-y))}.translate-x-full{--tw-translate-x:100%}.translate-y-full{--tw-translate-y:100%}.rotate-\\[-45deg\\],.translate-y-full{transform:translate(var(--tw-translate-x),var(--tw-translate-y)) rotate(var(--tw-rotate)) skewX(var(--tw-skew-x)) skewY(var(--tw-skew-y)) scaleX(var(--tw-scale-x)) scaleY(var(--tw-scale-y))}.rotate-\\[-45deg\\]{--tw-rotate:-45deg}.transform{transform:translate(var(--tw-translate-x),var(--tw-translate-y)) rotate(var(--tw-rotate)) skewX(var(--tw-skew-x)) skewY(var(--tw-skew-y)) scaleX(var(--tw-scale-x)) scaleY(var(--tw-scale-y))}@keyframes pulse{50%{opacity:.5}}.animate-pulse{animation:pulse 2s cubic-bezier(.4,0,.6,1) infinite}@keyframes spin{to{transform:rotate(1turn)}}.animate-spin{animation:spin 1s linear infinite}.cursor-grab{cursor:grab}.cursor-pointer{cursor:pointer}.resize-none{resize:none}.resize{resize:both}.list-inside{list-style-position:inside}.list-decimal{list-style-type:decimal}.list-disc{list-style-type:disc}.grid-cols-1{grid-template-columns:repeat(1,minmax(0,1fr))}.grid-cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}.flex-col{flex-direction:column}.flex-wrap{flex-wrap:wrap}.items-start{align-items:flex-start}.items-center{align-items:center}.items-baseline{align-items:baseline}.justify-start{justify-content:flex-start}.justify-end{justify-content:flex-end}.justify-center{justify-content:center}.justify-between{justify-content:space-between}.justify-around{justify-content:space-around}.gap-0{gap:0}.gap-0\\.5{gap:.125rem}.gap-1{gap:.25rem}.gap-1\\.5{gap:.375rem}.gap-2{gap:.5rem}.gap-3{gap:.75rem}.gap-4{gap:1rem}.gap-6{gap:1.5rem}.gap-8{gap:2rem}.gap-x-4{column-gap:1rem}.gap-y-2{row-gap:.5rem}.space-x-1>:not([hidden])~:not([hidden]){--tw-space-x-reverse:0;margin-right:calc(.25rem*var(--tw-space-x-reverse));margin-left:calc(.25rem*(1 - var(--tw-space-x-reverse)))}.space-x-2>:not([hidden])~:not([hidden]){--tw-space-x-reverse:0;margin-right:calc(.5rem*var(--tw-space-x-reverse));margin-left:calc(.5rem*(1 - var(--tw-space-x-reverse)))}.space-x-3>:not([hidden])~:not([hidden]){--tw-space-x-reverse:0;margin-right:calc(.75rem*var(--tw-space-x-reverse));margin-left:calc(.75rem*(1 - var(--tw-space-x-reverse)))}.space-x-4>:not([hidden])~:not([hidden]){--tw-space-x-reverse:0;margin-right:calc(1rem*var(--tw-space-x-reverse));margin-left:calc(1rem*(1 - var(--tw-space-x-reverse)))}.space-x-8>:not([hidden])~:not([hidden]){--tw-space-x-reverse:0;margin-right:calc(2rem*var(--tw-space-x-reverse));margin-left:calc(2rem*(1 - var(--tw-space-x-reverse)))}.space-y-0>:not([hidden])~:not([hidden]){--tw-space-y-reverse:0;margin-top:calc(0px*(1 - var(--tw-space-y-reverse)));margin-bottom:calc(0px*var(--tw-space-y-reverse))}.space-y-1>:not([hidden])~:not([hidden]){--tw-space-y-reverse:0;margin-top:calc(.25rem*(1 - var(--tw-space-y-reverse)));margin-bottom:calc(.25rem*var(--tw-space-y-reverse))}.space-y-2>:not([hidden])~:not([hidden]){--tw-space-y-reverse:0;margin-top:calc(.5rem*(1 - var(--tw-space-y-reverse)));margin-bottom:calc(.5rem*var(--tw-space-y-reverse))}.space-y-3>:not([hidden])~:not([hidden]){--tw-space-y-reverse:0;margin-top:calc(.75rem*(1 - var(--tw-space-y-reverse)));margin-bottom:calc(.75rem*var(--tw-space-y-reverse))}.space-y-4>:not([hidden])~:not([hidden]){--tw-space-y-reverse:0;margin-top:calc(1rem*(1 - var(--tw-space-y-reverse)));margin-bottom:calc(1rem*var(--tw-space-y-reverse))}.space-y-6>:not([hidden])~:not([hidden]){--tw-space-y-reverse:0;margin-top:calc(1.5rem*(1 - var(--tw-space-y-reverse)));margin-bottom:calc(1.5rem*var(--tw-space-y-reverse))}.space-y-8>:not([hidden])~:not([hidden]){--tw-space-y-reverse:0;margin-top:calc(2rem*(1 - var(--tw-space-y-reverse)));margin-bottom:calc(2rem*var(--tw-space-y-reverse))}.divide-y>:not([hidden])~:not([hidden]){--tw-divide-y-reverse:0;border-top-width:calc(1px*(1 - var(--tw-divide-y-reverse)));border-bottom-width:calc(1px*var(--tw-divide-y-reverse))}.divide-gray-200>:not([hidden])~:not([hidden]){--tw-divide-opacity:1;border-color:rgb(229 231 235/var(--tw-divide-opacity,1))}.overflow-hidden{overflow:hidden}.overflow-x-auto{overflow-x:auto}.overflow-y-auto{overflow-y:auto}.overflow-x-visible{overflow-x:visible}.truncate{overflow:hidden;text-overflow:ellipsis;white-space:nowrap}.whitespace-normal{white-space:normal}.whitespace-nowrap{white-space:nowrap}.whitespace-pre-wrap{white-space:pre-wrap}.break-words{overflow-wrap:break-word}.break-all{word-break:break-all}.rounded{border-radius:.25rem}.rounded-2xl{border-radius:1rem}.rounded-3xl{border-radius:1.5rem}.rounded-\\[1\\.25rem\\]{border-radius:1.25rem}.rounded-\\[2\\.5rem\\]{border-radius:2.5rem}.rounded-\\[2rem\\]{border-radius:2rem}.rounded-\\[3\\.5rem\\]{border-radius:3.5rem}.rounded-full{border-radius:9999px}.rounded-lg{border-radius:.5rem}.rounded-md{border-radius:.375rem}.rounded-xl{border-radius:.75rem}.rounded-t-\\[3\\.5rem\\]{border-top-left-radius:3.5rem;border-top-right-radius:3.5rem}.border{border-width:1px}.border-2{border-width:2px}.border-4{border-width:4px}.border-b{border-bottom-width:1px}.border-b-2{border-bottom-width:2px}.border-l{border-left-width:1px}.border-l-4{border-left-width:4px}.border-r{border-right-width:1px}.border-t{border-top-width:1px}.border-dashed{border-style:dashed}.border-none{border-style:none}.border-amber-100\\/50{border-color:#fef3c780}.border-blue-100{--tw-border-opacity:1;border-color:rgb(219 234 254/var(--tw-border-opacity,1))}.border-blue-200{--tw-border-opacity:1;border-color:rgb(191 219 254/var(--tw-border-opacity,1))}.border-blue-500{--tw-border-opacity:1;border-color:rgb(59 130 246/var(--tw-border-opacity,1))}.border-blue-600{--tw-border-opacity:1;border-color:rgb(37 99 235/var(--tw-border-opacity,1))}.border-gray-100{--tw-border-opacity:1;border-color:rgb(243 244 246/var(--tw-border-opacity,1))}.border-gray-200{--tw-border-opacity:1;border-color:rgb(229 231 235/var(--tw-border-opacity,1))}.border-gray-300{--tw-border-opacity:1;border-color:rgb(209 213 219/var(--tw-border-opacity,1))}.border-gray-900{--tw-border-opacity:1;border-color:rgb(17 24 39/var(--tw-border-opacity,1))}.border-green-200{--tw-border-opacity:1;border-color:rgb(187 247 208/var(--tw-border-opacity,1))}.border-green-400{--tw-border-opacity:1;border-color:rgb(74 222 128/var(--tw-border-opacity,1))}.border-green-500{--tw-border-opacity:1;border-color:rgb(34 197 94/var(--tw-border-opacity,1))}.border-red-200{--tw-border-opacity:1;border-color:rgb(254 202 202/var(--tw-border-opacity,1))}.border-red-300{--tw-border-opacity:1;border-color:rgb(252 165 165/var(--tw-border-opacity,1))}.border-slate-100{--tw-border-opacity:1;border-color:rgb(241 245 249/var(--tw-border-opacity,1))}.border-slate-200{--tw-border-opacity:1;border-color:rgb(226 232 240/var(--tw-border-opacity,1))}.border-slate-50{--tw-border-opacity:1;border-color:rgb(248 250 252/var(--tw-border-opacity,1))}.border-slate-700{--tw-border-opacity:1;border-color:rgb(51 65 85/var(--tw-border-opacity,1))}.border-transparent{border-color:#0000}.border-white{--tw-border-opacity:1;border-color:rgb(255 255 255/var(--tw-border-opacity,1))}.border-yellow-200{--tw-border-opacity:1;border-color:rgb(254 240 138/var(--tw-border-opacity,1))}.border-yellow-300{--tw-border-opacity:1;border-color:rgb(253 224 71/var(--tw-border-opacity,1))}.border-yellow-400{--tw-border-opacity:1;border-color:rgb(250 204 21/var(--tw-border-opacity,1))}.border-yellow-500{--tw-border-opacity:1;border-color:rgb(234 179 8/var(--tw-border-opacity,1))}.border-t-transparent{border-top-color:#0000}.bg-\\[\\#1e1e1e\\]{--tw-bg-opacity:1;background-color:rgb(30 30 30/var(--tw-bg-opacity,1))}.bg-\\[\\#2a2d31\\]{--tw-bg-opacity:1;background-color:rgb(42 45 49/var(--tw-bg-opacity,1))}.bg-\\[\\#fdfdfe\\]{--tw-bg-opacity:1;background-color:rgb(253 253 254/var(--tw-bg-opacity,1))}.bg-amber-50\\/50{background-color:#fffbeb80}.bg-amber-500{--tw-bg-opacity:1;background-color:rgb(245 158 11/var(--tw-bg-opacity,1))}.bg-black{--tw-bg-opacity:1;background-color:rgb(0 0 0/var(--tw-bg-opacity,1))}.bg-blue-100{--tw-bg-opacity:1;background-color:rgb(219 234 254/var(--tw-bg-opacity,1))}.bg-blue-50{--tw-bg-opacity:1;background-color:rgb(239 246 255/var(--tw-bg-opacity,1))}.bg-blue-50\\/60{background-color:#eff6ff99}.bg-blue-500{--tw-bg-opacity:1;background-color:rgb(59 130 246/var(--tw-bg-opacity,1))}.bg-blue-600{--tw-bg-opacity:1;background-color:rgb(37 99 235/var(--tw-bg-opacity,1))}.bg-emerald-600{--tw-bg-opacity:1;background-color:rgb(5 150 105/var(--tw-bg-opacity,1))}.bg-gray-100{--tw-bg-opacity:1;background-color:rgb(243 244 246/var(--tw-bg-opacity,1))}.bg-gray-200{--tw-bg-opacity:1;background-color:rgb(229 231 235/var(--tw-bg-opacity,1))}.bg-gray-300{--tw-bg-opacity:1;background-color:rgb(209 213 219/var(--tw-bg-opacity,1))}.bg-gray-50{--tw-bg-opacity:1;background-color:rgb(249 250 251/var(--tw-bg-opacity,1))}.bg-gray-600{--tw-bg-opacity:1;background-color:rgb(75 85 99/var(--tw-bg-opacity,1))}.bg-gray-800{--tw-bg-opacity:1;background-color:rgb(31 41 55/var(--tw-bg-opacity,1))}.bg-green-100{--tw-bg-opacity:1;background-color:rgb(220 252 231/var(--tw-bg-opacity,1))}.bg-green-50{--tw-bg-opacity:1;background-color:rgb(240 253 244/var(--tw-bg-opacity,1))}.bg-green-500{--tw-bg-opacity:1;background-color:rgb(34 197 94/var(--tw-bg-opacity,1))}.bg-green-600{--tw-bg-opacity:1;background-color:rgb(22 163 74/var(--tw-bg-opacity,1))}.bg-indigo-50{--tw-bg-opacity:1;background-color:rgb(238 242 255/var(--tw-bg-opacity,1))}.bg-indigo-600{--tw-bg-opacity:1;background-color:rgb(79 70 229/var(--tw-bg-opacity,1))}.bg-purple-100{--tw-bg-opacity:1;background-color:rgb(243 232 255/var(--tw-bg-opacity,1))}.bg-purple-500{--tw-bg-opacity:1;background-color:rgb(168 85 247/var(--tw-bg-opacity,1))}.bg-purple-600{--tw-bg-opacity:1;background-color:rgb(147 51 234/var(--tw-bg-opacity,1))}.bg-red-100{--tw-bg-opacity:1;background-color:rgb(254 226 226/var(--tw-bg-opacity,1))}.bg-red-50{--tw-bg-opacity:1;background-color:rgb(254 242 242/var(--tw-bg-opacity,1))}.bg-red-500{--tw-bg-opacity:1;background-color:rgb(239 68 68/var(--tw-bg-opacity,1))}.bg-red-600{--tw-bg-opacity:1;background-color:rgb(220 38 38/var(--tw-bg-opacity,1))}.bg-slate-100{--tw-bg-opacity:1;background-color:rgb(241 245 249/var(--tw-bg-opacity,1))}.bg-slate-50{--tw-bg-opacity:1;background-color:rgb(248 250 252/var(--tw-bg-opacity,1))}.bg-slate-50\\/90{background-color:#f8fafce6}.bg-slate-900{--tw-bg-opacity:1;background-color:rgb(15 23 42/var(--tw-bg-opacity,1))}.bg-slate-900\\/5{background-color:#0f172a0d}.bg-teal-600{--tw-bg-opacity:1;background-color:rgb(13 148 136/var(--tw-bg-opacity,1))}.bg-transparent{background-color:initial}.bg-white{--tw-bg-opacity:1;background-color:rgb(255 255 255/var(--tw-bg-opacity,1))}.bg-white\\/95{background-color:#fffffff2}.bg-yellow-100{--tw-bg-opacity:1;background-color:rgb(254 249 195/var(--tw-bg-opacity,1))}.bg-yellow-200{--tw-bg-opacity:1;background-color:rgb(254 240 138/var(--tw-bg-opacity,1))}.bg-yellow-400{--tw-bg-opacity:1;background-color:rgb(250 204 21/var(--tw-bg-opacity,1))}.bg-yellow-50{--tw-bg-opacity:1;background-color:rgb(254 252 232/var(--tw-bg-opacity,1))}.bg-yellow-500{--tw-bg-opacity:1;background-color:rgb(234 179 8/var(--tw-bg-opacity,1))}.bg-yellow-600{--tw-bg-opacity:1;background-color:rgb(202 138 4/var(--tw-bg-opacity,1))}.bg-opacity-0{--tw-bg-opacity:0}.bg-opacity-20{--tw-bg-opacity:0.2}.bg-opacity-25{--tw-bg-opacity:0.25}.bg-opacity-50{--tw-bg-opacity:0.5}.bg-opacity-90{--tw-bg-opacity:0.9}.bg-gradient-to-b{background-image:linear-gradient(to bottom,var(--tw-gradient-stops))}.bg-gradient-to-br{background-image:linear-gradient(to bottom right,var(--tw-gradient-stops))}.bg-gradient-to-r{background-image:linear-gradient(to right,var(--tw-gradient-stops))}.from-blue-400{--tw-gradient-from:#60a5fa var(--tw-gradient-from-position);--tw-gradient-to:#60a5fa00 var(--tw-gradient-to-position);--tw-gradient-stops:var(--tw-gradient-from),var(--tw-gradient-to)}.from-blue-50{--tw-gradient-from:#eff6ff var(--tw-gradient-from-position);--tw-gradient-to:#eff6ff00 var(--tw-gradient-to-position);--tw-gradient-stops:var(--tw-gradient-from),var(--tw-gradient-to)}.from-blue-600{--tw-gradient-from:#2563eb var(--tw-gradient-from-position);--tw-gradient-to:#2563eb00 var(--tw-gradient-to-position);--tw-gradient-stops:var(--tw-gradient-from),var(--tw-gradient-to)}.from-blue-600\\/30{--tw-gradient-from:#2563eb4d var(--tw-gradient-from-position);--tw-gradient-to:#2563eb00 var(--tw-gradient-to-position);--tw-gradient-stops:var(--tw-gradient-from),var(--tw-gradient-to)}.from-emerald-500{--tw-gradient-from:#10b981 var(--tw-gradient-from-position);--tw-gradient-to:#10b98100 var(--tw-gradient-to-position);--tw-gradient-stops:var(--tw-gradient-from),var(--tw-gradient-to)}.from-gray-200{--tw-gradient-from:#e5e7eb var(--tw-gradient-from-position);--tw-gradient-to:#e5e7eb00 var(--tw-gradient-to-position);--tw-gradient-stops:var(--tw-gradient-from),var(--tw-gradient-to)}.from-purple-50{--tw-gradient-from:#faf5ff var(--tw-gradient-from-position);--tw-gradient-to:#faf5ff00 var(--tw-gradient-to-position);--tw-gradient-stops:var(--tw-gradient-from),var(--tw-gradient-to)}.via-gray-300{--tw-gradient-to:#d1d5db00 var(--tw-gradient-to-position);--tw-gradient-stops:var(--tw-gradient-from),#d1d5db var(--tw-gradient-via-position),var(--tw-gradient-to)}.via-slate-100{--tw-gradient-to:#f1f5f900 var(--tw-gradient-to-position);--tw-gradient-stops:var(--tw-gradient-from),#f1f5f9 var(--tw-gradient-via-position),var(--tw-gradient-to)}.to-blue-50{--tw-gradient-to:#eff6ff var(--tw-gradient-to-position)}.to-gray-200{--tw-gradient-to:#e5e7eb var(--tw-gradient-to-position)}.to-green-50{--tw-gradient-to:#f0fdf4 var(--tw-gradient-to-position)}.to-indigo-600{--tw-gradient-to:#4f46e5 var(--tw-gradient-to-position)}.to-indigo-700{--tw-gradient-to:#4338ca var(--tw-gradient-to-position)}.to-purple-500{--tw-gradient-to:#a855f7 var(--tw-gradient-to-position)}.to-slate-100{--tw-gradient-to:#f1f5f9 var(--tw-gradient-to-position)}.to-teal-600{--tw-gradient-to:#0d9488 var(--tw-gradient-to-position)}.bg-\\[length\\:200\\%_100\\%\\]{background-size:200% 100%}.fill-current{fill:currentColor}.object-contain{object-fit:contain}.object-cover{object-fit:cover}.p-0{padding:0}.p-1\\.5{padding:.375rem}.p-10{padding:2.5rem}.p-12{padding:3rem}.p-2{padding:.5rem}.p-2\\.5{padding:.625rem}.p-3{padding:.75rem}.p-4{padding:1rem}.p-5{padding:1.25rem}.p-6{padding:1.5rem}.p-8{padding:2rem}.px-1{padding-left:.25rem;padding-right:.25rem}.px-2{padding-left:.5rem;padding-right:.5rem}.px-2\\.5{padding-left:.625rem;padding-right:.625rem}.px-3{padding-left:.75rem;padding-right:.75rem}.px-4{padding-left:1rem;padding-right:1rem}.px-6{padding-left:1.5rem;padding-right:1.5rem}.px-8{padding-left:2rem;padding-right:2rem}.py-0\\.5{padding-top:.125rem;padding-bottom:.125rem}.py-1{padding-top:.25rem;padding-bottom:.25rem}.py-1\\.5{padding-top:.375rem;padding-bottom:.375rem}.py-12{padding-top:3rem;padding-bottom:3rem}.py-2{padding-top:.5rem;padding-bottom:.5rem}.py-2\\.5{padding-top:.625rem;padding-bottom:.625rem}.py-24{padding-top:6rem;padding-bottom:6rem}.py-3{padding-top:.75rem;padding-bottom:.75rem}.py-3\\.5{padding-top:.875rem;padding-bottom:.875rem}.py-4{padding-top:1rem;padding-bottom:1rem}.py-4\\.5{padding-top:1.125rem;padding-bottom:1.125rem}.py-5{padding-top:1.25rem;padding-bottom:1.25rem}.py-6{padding-top:1.5rem;padding-bottom:1.5rem}.py-8{padding-top:2rem;padding-bottom:2rem}.pb-20{padding-bottom:5rem}.pb-28{padding-bottom:7rem}.pb-4{padding-bottom:1rem}.pl-4{padding-left:1rem}.pt-2{padding-top:.5rem}.pt-4{padding-top:1rem}.pt-5{padding-top:1.25rem}.pt-6{padding-top:1.5rem}.text-left{text-align:left}.text-center{text-align:center}.text-right{text-align:right}.font-mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,Liberation Mono,Courier New,monospace}.font-sans{font-family:Noto Sans TC,sans-serif}.text-2xl{font-size:1.5rem;line-height:2rem}.text-3xl{font-size:1.875rem;line-height:2.25rem}.text-4xl{font-size:2.25rem;line-height:2.5rem}.text-5xl{font-size:3rem;line-height:1}.text-6xl{font-size:3.75rem;line-height:1}.text-\\[10px\\]{font-size:10px}.text-\\[11px\\]{font-size:11px}.text-\\[12px\\]{font-size:12px}.text-\\[13px\\]{font-size:13px}.text-\\[14px\\]{font-size:14px}.text-\\[16px\\]{font-size:16px}.text-\\[18px\\]{font-size:18px}.text-\\[8px\\]{font-size:8px}.text-\\[9px\\]{font-size:9px}.text-base{font-size:1rem;line-height:1.5rem}.text-lg{font-size:1.125rem;line-height:1.75rem}.text-sm{font-size:.875rem;line-height:1.25rem}.text-xl{font-size:1.25rem;line-height:1.75rem}.text-xs{font-size:.75rem;line-height:1rem}.font-black{font-weight:900}.font-bold{font-weight:700}.font-extrabold{font-weight:800}.font-medium{font-weight:500}.font-semibold{font-weight:600}.uppercase{text-transform:uppercase}.lowercase{text-transform:lowercase}.italic{font-style:italic}.tabular-nums{--tw-numeric-spacing:tabular-nums;font-variant-numeric:var(--tw-ordinal) var(--tw-slashed-zero) var(--tw-numeric-figure) var(--tw-numeric-spacing) var(--tw-numeric-fraction)}.leading-5{line-height:1.25rem}.leading-6{line-height:1.5rem}.leading-8{line-height:2rem}.leading-none{line-height:1}.leading-relaxed{line-height:1.625}.leading-tight{line-height:1.25}.tracking-\\[0\\.25em\\]{letter-spacing:.25em}.tracking-\\[0\\.2em\\]{letter-spacing:.2em}.tracking-\\[0\\.3em\\]{letter-spacing:.3em}.tracking-\\[0\\.4em\\]{letter-spacing:.4em}.tracking-tight{letter-spacing:-.025em}.tracking-tighter{letter-spacing:-.05em}.tracking-widest{letter-spacing:.1em}.text-amber-400{--tw-text-opacity:1;color:rgb(251 191 36/var(--tw-text-opacity,1))}.text-amber-400\\/60{color:#fbbf2499}.text-amber-600\\/50{color:#d9770680}.text-amber-700{--tw-text-opacity:1;color:rgb(180 83 9/var(--tw-text-opacity,1))}.text-blue-400{--tw-text-opacity:1;color:rgb(96 165 250/var(--tw-text-opacity,1))}.text-blue-500{--tw-text-opacity:1;color:rgb(59 130 246/var(--tw-text-opacity,1))}.text-blue-600{--tw-text-opacity:1;color:rgb(37 99 235/var(--tw-text-opacity,1))}.text-blue-700{--tw-text-opacity:1;color:rgb(29 78 216/var(--tw-text-opacity,1))}.text-blue-800{--tw-text-opacity:1;color:rgb(30 64 175/var(--tw-text-opacity,1))}.text-blue-900{--tw-text-opacity:1;color:rgb(30 58 138/var(--tw-text-opacity,1))}.text-emerald-600{--tw-text-opacity:1;color:rgb(5 150 105/var(--tw-text-opacity,1))}.text-gray-300{--tw-text-opacity:1;color:rgb(209 213 219/var(--tw-text-opacity,1))}.text-gray-400{--tw-text-opacity:1;color:rgb(156 163 175/var(--tw-text-opacity,1))}.text-gray-500{--tw-text-opacity:1;color:rgb(107 114 128/var(--tw-text-opacity,1))}.text-gray-600{--tw-text-opacity:1;color:rgb(75 85 99/var(--tw-text-opacity,1))}.text-gray-700{--tw-text-opacity:1;color:rgb(55 65 81/var(--tw-text-opacity,1))}.text-gray-800{--tw-text-opacity:1;color:rgb(31 41 55/var(--tw-text-opacity,1))}.text-gray-900{--tw-text-opacity:1;color:rgb(17 24 39/var(--tw-text-opacity,1))}.text-green-400{--tw-text-opacity:1;color:rgb(74 222 128/var(--tw-text-opacity,1))}.text-green-600{--tw-text-opacity:1;color:rgb(22 163 74/var(--tw-text-opacity,1))}.text-green-700{--tw-text-opacity:1;color:rgb(21 128 61/var(--tw-text-opacity,1))}.text-green-800{--tw-text-opacity:1;color:rgb(22 101 52/var(--tw-text-opacity,1))}.text-green-900{--tw-text-opacity:1;color:rgb(20 83 45/var(--tw-text-opacity,1))}.text-indigo-600{--tw-text-opacity:1;color:rgb(79 70 229/var(--tw-text-opacity,1))}.text-orange-600{--tw-text-opacity:1;color:rgb(234 88 12/var(--tw-text-opacity,1))}.text-purple-600{--tw-text-opacity:1;color:rgb(147 51 234/var(--tw-text-opacity,1))}.text-purple-800{--tw-text-opacity:1;color:rgb(107 33 168/var(--tw-text-opacity,1))}.text-red-400{--tw-text-opacity:1;color:rgb(248 113 113/var(--tw-text-opacity,1))}.text-red-500{--tw-text-opacity:1;color:rgb(239 68 68/var(--tw-text-opacity,1))}.text-red-600{--tw-text-opacity:1;color:rgb(220 38 38/var(--tw-text-opacity,1))}.text-red-700{--tw-text-opacity:1;color:rgb(185 28 28/var(--tw-text-opacity,1))}.text-red-800{--tw-text-opacity:1;color:rgb(153 27 27/var(--tw-text-opacity,1))}.text-slate-100{--tw-text-opacity:1;color:rgb(241 245 249/var(--tw-text-opacity,1))}.text-slate-200{--tw-text-opacity:1;color:rgb(226 232 240/var(--tw-text-opacity,1))}.text-slate-300{--tw-text-opacity:1;color:rgb(203 213 225/var(--tw-text-opacity,1))}.text-slate-400{--tw-text-opacity:1;color:rgb(148 163 184/var(--tw-text-opacity,1))}.text-slate-500{--tw-text-opacity:1;color:rgb(100 116 139/var(--tw-text-opacity,1))}.text-slate-700{--tw-text-opacity:1;color:rgb(51 65 85/var(--tw-text-opacity,1))}.text-slate-800{--tw-text-opacity:1;color:rgb(30 41 59/var(--tw-text-opacity,1))}.text-slate-900{--tw-text-opacity:1;color:rgb(15 23 42/var(--tw-text-opacity,1))}.text-white{--tw-text-opacity:1;color:rgb(255 255 255/var(--tw-text-opacity,1))}.text-yellow-400{--tw-text-opacity:1;color:rgb(250 204 21/var(--tw-text-opacity,1))}.text-yellow-500{--tw-text-opacity:1;color:rgb(234 179 8/var(--tw-text-opacity,1))}.text-yellow-600{--tw-text-opacity:1;color:rgb(202 138 4/var(--tw-text-opacity,1))}.text-yellow-700{--tw-text-opacity:1;color:rgb(161 98 7/var(--tw-text-opacity,1))}.text-yellow-800{--tw-text-opacity:1;color:rgb(133 77 14/var(--tw-text-opacity,1))}.text-yellow-900{--tw-text-opacity:1;color:rgb(113 63 18/var(--tw-text-opacity,1))}.underline{-webkit-text-decoration-line:underline;text-decoration-line:underline}.no-underline{-webkit-text-decoration-line:none;text-decoration-line:none}.opacity-0{opacity:0}.opacity-30{opacity:.3}.opacity-50{opacity:.5}.shadow{--tw-shadow:0 1px 3px 0 #0000001a,0 1px 2px 0 #0000000f;--tw-shadow-colored:0 1px 3px 0 var(--tw-shadow-color),0 1px 2px 0 var(--tw-shadow-color)}.shadow,.shadow-2xl{box-shadow:var(--tw-ring-offset-shadow,0 0 #0000),var(--tw-ring-shadow,0 0 #0000),var(--tw-shadow)}.shadow-2xl{--tw-shadow:0 25px 50px -12px #00000040;--tw-shadow-colored:0 25px 50px -12px var(--tw-shadow-color)}.shadow-\\[0_12px_40px_rgba\\(0\\2c 0\\2c 0\\2c 0\\.06\\)\\]{--tw-shadow:0 12px 40px #0000000f;--tw-shadow-colored:0 12px 40px var(--tw-shadow-color);box-shadow:var(--tw-ring-offset-shadow,0 0 #0000),var(--tw-ring-shadow,0 0 #0000),var(--tw-shadow)}.shadow-\\[0_30px_60px_-12px_rgba\\(0\\2c 0\\2c 0\\2c 0\\.45\\)\\]{--tw-shadow:0 30px 60px -12px #00000073;--tw-shadow-colored:0 30px 60px -12px var(--tw-shadow-color);box-shadow:var(--tw-ring-offset-shadow,0 0 #0000),var(--tw-ring-shadow,0 0 #0000),var(--tw-shadow)}.shadow-\\[0_30px_80px_rgba\\(0\\2c 0\\2c 0\\2c 0\\.15\\)\\]{--tw-shadow:0 30px 80px #00000026;--tw-shadow-colored:0 30px 80px var(--tw-shadow-color);box-shadow:var(--tw-ring-offset-shadow,0 0 #0000),var(--tw-ring-shadow,0 0 #0000),var(--tw-shadow)}.shadow-\\[0_4px_30px_rgba\\(0\\2c 0\\2c 0\\2c 0\\.02\\)\\]{--tw-shadow:0 4px 30px #00000005;--tw-shadow-colored:0 4px 30px var(--tw-shadow-color)}.shadow-\\[0_4px_30px_rgba\\(0\\2c 0\\2c 0\\2c 0\\.02\\)\\],.shadow-inner{box-shadow:var(--tw-ring-offset-shadow,0 0 #0000),var(--tw-ring-shadow,0 0 #0000),var(--tw-shadow)}.shadow-inner{--tw-shadow:inset 0 2px 4px 0 #0000000d;--tw-shadow-colored:inset 0 2px 4px 0 var(--tw-shadow-color)}.shadow-lg{--tw-shadow:0 10px 15px -3px #0000001a,0 4px 6px -2px #0000000d;--tw-shadow-colored:0 10px 15px -3px var(--tw-shadow-color),0 4px 6px -2px var(--tw-shadow-color)}.shadow-lg,.shadow-md{box-shadow:var(--tw-ring-offset-shadow,0 0 #0000),var(--tw-ring-shadow,0 0 #0000),var(--tw-shadow)}.shadow-md{--tw-shadow:0 4px 6px -1px #0000001a,0 2px 4px -1px #0000000f;--tw-shadow-colored:0 4px 6px -1px var(--tw-shadow-color),0 2px 4px -1px var(--tw-shadow-color)}.shadow-sm{--tw-shadow:0 1px 2px 0 #0000000d;--tw-shadow-colored:0 1px 2px 0 var(--tw-shadow-color)}.shadow-sm,.shadow-xl{box-shadow:var(--tw-ring-offset-shadow,0 0 #0000),var(--tw-ring-shadow,0 0 #0000),var(--tw-shadow)}.shadow-xl{--tw-shadow:0 20px 25px -5px #0000001a,0 10px 10px -5px #0000000a;--tw-shadow-colored:0 20px 25px -5px var(--tw-shadow-color),0 10px 10px -5px var(--tw-shadow-color)}.shadow-blue-200{--tw-shadow-color:#bfdbfe;--tw-shadow:var(--tw-shadow-colored)}.shadow-emerald-200{--tw-shadow-color:#a7f3d0;--tw-shadow:var(--tw-shadow-colored)}.shadow-slate-200{--tw-shadow-color:#e2e8f0;--tw-shadow:var(--tw-shadow-colored)}.outline-none{outline:2px solid #0000;outline-offset:2px}.outline{outline-style:solid}.blur{--tw-blur:blur(8px)}.blur,.drop-shadow{filter:var(--tw-blur) var(--tw-brightness) var(--tw-contrast) var(--tw-grayscale) var(--tw-hue-rotate) var(--tw-invert) var(--tw-saturate) var(--tw-sepia) var(--tw-drop-shadow)}.drop-shadow{--tw-drop-shadow:drop-shadow(0 1px 2px #0000001a) drop-shadow(0 1px 1px #0000000f)}.filter{filter:var(--tw-blur) var(--tw-brightness) var(--tw-contrast) var(--tw-grayscale) var(--tw-hue-rotate) var(--tw-invert) var(--tw-saturate) var(--tw-sepia) var(--tw-drop-shadow)}.backdrop-blur-3xl{--tw-backdrop-blur:blur(64px)}.backdrop-blur-3xl,.backdrop-blur-\\[1px\\]{-webkit-backdrop-filter:var(--tw-backdrop-blur) var(--tw-backdrop-brightness) var(--tw-backdrop-contrast) var(--tw-backdrop-grayscale) var(--tw-backdrop-hue-rotate) var(--tw-backdrop-invert) var(--tw-backdrop-opacity) var(--tw-backdrop-saturate) var(--tw-backdrop-sepia);backdrop-filter:var(--tw-backdrop-blur) var(--tw-backdrop-brightness) var(--tw-backdrop-contrast) var(--tw-backdrop-grayscale) var(--tw-backdrop-hue-rotate) var(--tw-backdrop-invert) var(--tw-backdrop-opacity) var(--tw-backdrop-saturate) var(--tw-backdrop-sepia)}.backdrop-blur-\\[1px\\]{--tw-backdrop-blur:blur(1px)}.backdrop-blur-md{--tw-backdrop-blur:blur(12px)}.backdrop-blur-md,.backdrop-blur-xl{-webkit-backdrop-filter:var(--tw-backdrop-blur) var(--tw-backdrop-brightness) var(--tw-backdrop-contrast) var(--tw-backdrop-grayscale) var(--tw-backdrop-hue-rotate) var(--tw-backdrop-invert) var(--tw-backdrop-opacity) var(--tw-backdrop-saturate) var(--tw-backdrop-sepia);backdrop-filter:var(--tw-backdrop-blur) var(--tw-backdrop-brightness) var(--tw-backdrop-contrast) var(--tw-backdrop-grayscale) var(--tw-backdrop-hue-rotate) var(--tw-backdrop-invert) var(--tw-backdrop-opacity) var(--tw-backdrop-saturate) var(--tw-backdrop-sepia)}.backdrop-blur-xl{--tw-backdrop-blur:blur(24px)}.backdrop-filter{-webkit-backdrop-filter:var(--tw-backdrop-blur) var(--tw-backdrop-brightness) var(--tw-backdrop-contrast) var(--tw-backdrop-grayscale) var(--tw-backdrop-hue-rotate) var(--tw-backdrop-invert) var(--tw-backdrop-opacity) var(--tw-backdrop-saturate) var(--tw-backdrop-sepia);backdrop-filter:var(--tw-backdrop-blur) var(--tw-backdrop-brightness) var(--tw-backdrop-contrast) var(--tw-backdrop-grayscale) var(--tw-backdrop-hue-rotate) var(--tw-backdrop-invert) var(--tw-backdrop-opacity) var(--tw-backdrop-saturate) var(--tw-backdrop-sepia)}.transition{transition-property:color,background-color,border-color,fill,stroke,opacity,box-shadow,transform,filter,-webkit-text-decoration-color,-webkit-backdrop-filter;transition-property:color,background-color,border-color,text-decoration-color,fill,stroke,opacity,box-shadow,transform,filter,backdrop-filter;transition-property:color,background-color,border-color,text-decoration-color,fill,stroke,opacity,box-shadow,transform,filter,backdrop-filter,-webkit-text-decoration-color,-webkit-backdrop-filter;transition-timing-function:cubic-bezier(.4,0,.2,1);transition-duration:.15s}.transition-all{transition-property:all;transition-timing-function:cubic-bezier(.4,0,.2,1);transition-duration:.15s}.transition-colors{transition-property:color,background-color,border-color,fill,stroke,-webkit-text-decoration-color;transition-property:color,background-color,border-color,text-decoration-color,fill,stroke;transition-property:color,background-color,border-color,text-decoration-color,fill,stroke,-webkit-text-decoration-color;transition-timing-function:cubic-bezier(.4,0,.2,1);transition-duration:.15s}.transition-opacity{transition-property:opacity;transition-timing-function:cubic-bezier(.4,0,.2,1);transition-duration:.15s}.transition-shadow{transition-property:box-shadow;transition-timing-function:cubic-bezier(.4,0,.2,1);transition-duration:.15s}.transition-transform{transition-property:transform;transition-timing-function:cubic-bezier(.4,0,.2,1)}.duration-150,.transition-transform{transition-duration:.15s}.duration-200{transition-duration:.2s}.duration-300{transition-duration:.3s}.duration-500{transition-duration:.5s}.ease-in{transition-timing-function:cubic-bezier(.4,0,1,1)}.ease-in-out{transition-timing-function:cubic-bezier(.4,0,.2,1)}.ease-out{transition-timing-function:cubic-bezier(0,0,.2,1)}@media (min-width:768px){.md\\:hidden.image-error-message{display:none}}@media (min-width:1024px){.lg\\:hidden.image-error-message{display:none}}.placeholder\\:text-slate-400::placeholder{--tw-text-opacity:1;color:rgb(148 163 184/var(--tw-text-opacity,1))}.focus-within\\:ring-4:focus-within{--tw-ring-offset-shadow:var(--tw-ring-inset) 0 0 0 var(--tw-ring-offset-width) var(--tw-ring-offset-color);--tw-ring-shadow:var(--tw-ring-inset) 0 0 0 calc(4px + var(--tw-ring-offset-width)) var(--tw-ring-color);box-shadow:var(--tw-ring-offset-shadow),var(--tw-ring-shadow),var(--tw-shadow,0 0 #0000)}.focus-within\\:ring-blue-500\\/10:focus-within{--tw-ring-color:#3b82f61a}.hover\\:-translate-y-1:hover{--tw-translate-y:-0.25rem}.hover\\:-translate-y-1:hover,.hover\\:scale-105:hover{transform:translate(var(--tw-translate-x),var(--tw-translate-y)) rotate(var(--tw-rotate)) skewX(var(--tw-skew-x)) skewY(var(--tw-skew-y)) scaleX(var(--tw-scale-x)) scaleY(var(--tw-scale-y))}.hover\\:scale-105:hover{--tw-scale-x:1.05;--tw-scale-y:1.05}.hover\\:scale-110:hover{--tw-scale-x:1.1;--tw-scale-y:1.1;transform:translate(var(--tw-translate-x),var(--tw-translate-y)) rotate(var(--tw-rotate)) skewX(var(--tw-skew-x)) skewY(var(--tw-skew-y)) scaleX(var(--tw-scale-x)) scaleY(var(--tw-scale-y))}.hover\\:border-blue-200:hover{--tw-border-opacity:1;border-color:rgb(191 219 254/var(--tw-border-opacity,1))}.hover\\:border-blue-300:hover{--tw-border-opacity:1;border-color:rgb(147 197 253/var(--tw-border-opacity,1))}.hover\\:border-blue-400:hover{--tw-border-opacity:1;border-color:rgb(96 165 250/var(--tw-border-opacity,1))}.hover\\:border-blue-600:hover{--tw-border-opacity:1;border-color:rgb(37 99 235/var(--tw-border-opacity,1))}.hover\\:border-gray-300:hover{--tw-border-opacity:1;border-color:rgb(209 213 219/var(--tw-border-opacity,1))}.hover\\:bg-amber-50:hover{--tw-bg-opacity:1;background-color:rgb(255 251 235/var(--tw-bg-opacity,1))}.hover\\:bg-blue-100:hover{--tw-bg-opacity:1;background-color:rgb(219 234 254/var(--tw-bg-opacity,1))}.hover\\:bg-blue-200:hover{--tw-bg-opacity:1;background-color:rgb(191 219 254/var(--tw-bg-opacity,1))}.hover\\:bg-blue-50:hover{--tw-bg-opacity:1;background-color:rgb(239 246 255/var(--tw-bg-opacity,1))}.hover\\:bg-blue-600:hover{--tw-bg-opacity:1;background-color:rgb(37 99 235/var(--tw-bg-opacity,1))}.hover\\:bg-blue-700:hover{--tw-bg-opacity:1;background-color:rgb(29 78 216/var(--tw-bg-opacity,1))}.hover\\:bg-emerald-50:hover{--tw-bg-opacity:1;background-color:rgb(236 253 245/var(--tw-bg-opacity,1))}.hover\\:bg-gray-100:hover{--tw-bg-opacity:1;background-color:rgb(243 244 246/var(--tw-bg-opacity,1))}.hover\\:bg-gray-200:hover{--tw-bg-opacity:1;background-color:rgb(229 231 235/var(--tw-bg-opacity,1))}.hover\\:bg-gray-300:hover{--tw-bg-opacity:1;background-color:rgb(209 213 219/var(--tw-bg-opacity,1))}.hover\\:bg-gray-50:hover{--tw-bg-opacity:1;background-color:rgb(249 250 251/var(--tw-bg-opacity,1))}.hover\\:bg-gray-700:hover{--tw-bg-opacity:1;background-color:rgb(55 65 81/var(--tw-bg-opacity,1))}.hover\\:bg-green-100:hover{--tw-bg-opacity:1;background-color:rgb(220 252 231/var(--tw-bg-opacity,1))}.hover\\:bg-green-200:hover{--tw-bg-opacity:1;background-color:rgb(187 247 208/var(--tw-bg-opacity,1))}.hover\\:bg-green-50:hover{--tw-bg-opacity:1;background-color:rgb(240 253 244/var(--tw-bg-opacity,1))}.hover\\:bg-green-600:hover{--tw-bg-opacity:1;background-color:rgb(22 163 74/var(--tw-bg-opacity,1))}.hover\\:bg-green-700:hover{--tw-bg-opacity:1;background-color:rgb(21 128 61/var(--tw-bg-opacity,1))}.hover\\:bg-indigo-700:hover{--tw-bg-opacity:1;background-color:rgb(67 56 202/var(--tw-bg-opacity,1))}.hover\\:bg-purple-100:hover{--tw-bg-opacity:1;background-color:rgb(243 232 255/var(--tw-bg-opacity,1))}.hover\\:bg-purple-50:hover{--tw-bg-opacity:1;background-color:rgb(250 245 255/var(--tw-bg-opacity,1))}.hover\\:bg-purple-600:hover{--tw-bg-opacity:1;background-color:rgb(147 51 234/var(--tw-bg-opacity,1))}.hover\\:bg-purple-700:hover{--tw-bg-opacity:1;background-color:rgb(126 34 206/var(--tw-bg-opacity,1))}.hover\\:bg-red-200:hover{--tw-bg-opacity:1;background-color:rgb(254 202 202/var(--tw-bg-opacity,1))}.hover\\:bg-red-50:hover{--tw-bg-opacity:1;background-color:rgb(254 242 242/var(--tw-bg-opacity,1))}.hover\\:bg-red-700:hover{--tw-bg-opacity:1;background-color:rgb(185 28 28/var(--tw-bg-opacity,1))}.hover\\:bg-slate-100:hover{--tw-bg-opacity:1;background-color:rgb(241 245 249/var(--tw-bg-opacity,1))}.hover\\:bg-slate-200:hover{--tw-bg-opacity:1;background-color:rgb(226 232 240/var(--tw-bg-opacity,1))}.hover\\:bg-slate-50:hover{--tw-bg-opacity:1;background-color:rgb(248 250 252/var(--tw-bg-opacity,1))}.hover\\:bg-teal-700:hover{--tw-bg-opacity:1;background-color:rgb(15 118 110/var(--tw-bg-opacity,1))}.hover\\:bg-white:hover{--tw-bg-opacity:1;background-color:rgb(255 255 255/var(--tw-bg-opacity,1))}.hover\\:bg-yellow-700:hover{--tw-bg-opacity:1;background-color:rgb(161 98 7/var(--tw-bg-opacity,1))}.hover\\:bg-opacity-30:hover{--tw-bg-opacity:0.3}.hover\\:text-amber-500:hover{--tw-text-opacity:1;color:rgb(245 158 11/var(--tw-text-opacity,1))}.hover\\:text-blue-500:hover{--tw-text-opacity:1;color:rgb(59 130 246/var(--tw-text-opacity,1))}.hover\\:text-blue-600:hover{--tw-text-opacity:1;color:rgb(37 99 235/var(--tw-text-opacity,1))}.hover\\:text-blue-800:hover{--tw-text-opacity:1;color:rgb(30 64 175/var(--tw-text-opacity,1))}.hover\\:text-emerald-600:hover{--tw-text-opacity:1;color:rgb(5 150 105/var(--tw-text-opacity,1))}.hover\\:text-gray-600:hover{--tw-text-opacity:1;color:rgb(75 85 99/var(--tw-text-opacity,1))}.hover\\:text-gray-700:hover{--tw-text-opacity:1;color:rgb(55 65 81/var(--tw-text-opacity,1))}.hover\\:text-gray-800:hover{--tw-text-opacity:1;color:rgb(31 41 55/var(--tw-text-opacity,1))}.hover\\:text-gray-900:hover{--tw-text-opacity:1;color:rgb(17 24 39/var(--tw-text-opacity,1))}.hover\\:text-indigo-800:hover{--tw-text-opacity:1;color:rgb(55 48 163/var(--tw-text-opacity,1))}.hover\\:text-purple-600:hover{--tw-text-opacity:1;color:rgb(147 51 234/var(--tw-text-opacity,1))}.hover\\:text-red-500:hover{--tw-text-opacity:1;color:rgb(239 68 68/var(--tw-text-opacity,1))}.hover\\:text-red-600:hover{--tw-text-opacity:1;color:rgb(220 38 38/var(--tw-text-opacity,1))}.hover\\:text-red-700:hover{--tw-text-opacity:1;color:rgb(185 28 28/var(--tw-text-opacity,1))}.hover\\:text-white:hover{--tw-text-opacity:1;color:rgb(255 255 255/var(--tw-text-opacity,1))}.hover\\:text-yellow-400:hover{--tw-text-opacity:1;color:rgb(250 204 21/var(--tw-text-opacity,1))}.hover\\:underline:hover{-webkit-text-decoration-line:underline;text-decoration-line:underline}.hover\\:shadow-2xl:hover{--tw-shadow:0 25px 50px -12px #00000040;--tw-shadow-colored:0 25px 50px -12px var(--tw-shadow-color);box-shadow:var(--tw-ring-offset-shadow,0 0 #0000),var(--tw-ring-shadow,0 0 #0000),var(--tw-shadow)}.hover\\:shadow-\\[0_25px_60px_rgba\\(37\\2c 99\\2c 235\\2c 0\\.12\\)\\]:hover{--tw-shadow:0 25px 60px #2563eb1f;--tw-shadow-colored:0 25px 60px var(--tw-shadow-color);box-shadow:var(--tw-ring-offset-shadow,0 0 #0000),var(--tw-ring-shadow,0 0 #0000),var(--tw-shadow)}.hover\\:shadow-lg:hover{--tw-shadow:0 10px 15px -3px #0000001a,0 4px 6px -2px #0000000d;--tw-shadow-colored:0 10px 15px -3px var(--tw-shadow-color),0 4px 6px -2px var(--tw-shadow-color)}.hover\\:shadow-lg:hover,.hover\\:shadow-md:hover{box-shadow:var(--tw-ring-offset-shadow,0 0 #0000),var(--tw-ring-shadow,0 0 #0000),var(--tw-shadow)}.hover\\:shadow-md:hover{--tw-shadow:0 4px 6px -1px #0000001a,0 2px 4px -1px #0000000f;--tw-shadow-colored:0 4px 6px -1px var(--tw-shadow-color),0 2px 4px -1px var(--tw-shadow-color)}.hover\\:shadow-sm:hover{--tw-shadow:0 1px 2px 0 #0000000d;--tw-shadow-colored:0 1px 2px 0 var(--tw-shadow-color);box-shadow:var(--tw-ring-offset-shadow,0 0 #0000),var(--tw-ring-shadow,0 0 #0000),var(--tw-shadow)}.hover\\:shadow-emerald-300:hover{--tw-shadow-color:#6ee7b7;--tw-shadow:var(--tw-shadow-colored)}.hover\\:ring-2:hover{--tw-ring-offset-shadow:var(--tw-ring-inset) 0 0 0 var(--tw-ring-offset-width) var(--tw-ring-offset-color);--tw-ring-shadow:var(--tw-ring-inset) 0 0 0 calc(2px + var(--tw-ring-offset-width)) var(--tw-ring-color);box-shadow:var(--tw-ring-offset-shadow),var(--tw-ring-shadow),var(--tw-shadow,0 0 #0000)}.hover\\:ring-blue-500:hover{--tw-ring-opacity:1;--tw-ring-color:rgb(59 130 246/var(--tw-ring-opacity,1))}.focus\\:border-blue-500:focus{--tw-border-opacity:1;border-color:rgb(59 130 246/var(--tw-border-opacity,1))}.focus\\:border-indigo-500:focus{--tw-border-opacity:1;border-color:rgb(99 102 241/var(--tw-border-opacity,1))}.focus\\:border-transparent:focus{border-color:#0000}.focus\\:outline-none:focus{outline:2px solid #0000;outline-offset:2px}.focus\\:ring-2:focus{--tw-ring-offset-shadow:var(--tw-ring-inset) 0 0 0 var(--tw-ring-offset-width) var(--tw-ring-offset-color);--tw-ring-shadow:var(--tw-ring-inset) 0 0 0 calc(2px + var(--tw-ring-offset-width)) var(--tw-ring-color);box-shadow:var(--tw-ring-offset-shadow),var(--tw-ring-shadow),var(--tw-shadow,0 0 #0000)}.focus\\:ring-blue-500:focus{--tw-ring-opacity:1;--tw-ring-color:rgb(59 130 246/var(--tw-ring-opacity,1))}.focus\\:ring-green-500:focus{--tw-ring-opacity:1;--tw-ring-color:rgb(34 197 94/var(--tw-ring-opacity,1))}.focus\\:ring-indigo-500:focus{--tw-ring-opacity:1;--tw-ring-color:rgb(99 102 241/var(--tw-ring-opacity,1))}.focus\\:ring-red-500:focus{--tw-ring-opacity:1;--tw-ring-color:rgb(239 68 68/var(--tw-ring-opacity,1))}.focus\\:ring-offset-2:focus{--tw-ring-offset-width:2px}.active\\:scale-\\[0\\.96\\]:active{--tw-scale-x:0.96;--tw-scale-y:0.96}.active\\:scale-\\[0\\.96\\]:active,.active\\:scale-\\[0\\.97\\]:active{transform:translate(var(--tw-translate-x),var(--tw-translate-y)) rotate(var(--tw-rotate)) skewX(var(--tw-skew-x)) skewY(var(--tw-skew-y)) scaleX(var(--tw-scale-x)) scaleY(var(--tw-scale-y))}.active\\:scale-\\[0\\.97\\]:active{--tw-scale-x:0.97;--tw-scale-y:0.97}.active\\:scale-\\[0\\.98\\]:active{--tw-scale-x:0.98;--tw-scale-y:0.98;transform:translate(var(--tw-translate-x),var(--tw-translate-y)) rotate(var(--tw-rotate)) skewX(var(--tw-skew-x)) skewY(var(--tw-skew-y)) scaleX(var(--tw-scale-x)) scaleY(var(--tw-scale-y))}.active\\:cursor-grabbing:active{cursor:grabbing}.disabled\\:cursor-not-allowed:disabled{cursor:not-allowed}.disabled\\:opacity-30:disabled{opacity:.3}.disabled\\:opacity-50:disabled{opacity:.5}.group\\/nav:hover .group-hover\\/nav\\:rotate-12{--tw-rotate:12deg}.group:hover .group-hover\\:scale-105,.group\\/nav:hover .group-hover\\/nav\\:rotate-12{transform:translate(var(--tw-translate-x),var(--tw-translate-y)) rotate(var(--tw-rotate)) skewX(var(--tw-skew-x)) skewY(var(--tw-skew-y)) scaleX(var(--tw-scale-x)) scaleY(var(--tw-scale-y))}.group:hover .group-hover\\:scale-105{--tw-scale-x:1.05;--tw-scale-y:1.05}.group:hover .group-hover\\:scale-125{--tw-scale-x:1.25;--tw-scale-y:1.25;transform:translate(var(--tw-translate-x),var(--tw-translate-y)) rotate(var(--tw-rotate)) skewX(var(--tw-skew-x)) skewY(var(--tw-skew-y)) scaleX(var(--tw-scale-x)) scaleY(var(--tw-scale-y))}.group:hover .group-hover\\:bg-blue-600,.group\\/time:hover .group-hover\\/time\\:bg-blue-600{--tw-bg-opacity:1;background-color:rgb(37 99 235/var(--tw-bg-opacity,1))}.group:hover .group-hover\\:bg-indigo-600{--tw-bg-opacity:1;background-color:rgb(79 70 229/var(--tw-bg-opacity,1))}.group:hover .group-hover\\:bg-opacity-20{--tw-bg-opacity:0.2}.group\\/time:hover .group-hover\\/time\\:text-white{--tw-text-opacity:1;color:rgb(255 255 255/var(--tw-text-opacity,1))}.group:hover .group-hover\\:text-blue-600{--tw-text-opacity:1;color:rgb(37 99 235/var(--tw-text-opacity,1))}.group:hover .group-hover\\:text-white{--tw-text-opacity:1;color:rgb(255 255 255/var(--tw-text-opacity,1))}.group:hover .group-hover\\:underline{-webkit-text-decoration-line:underline;text-decoration-line:underline}.group:hover .group-hover\\:opacity-100{opacity:1}@media (min-width:640px){.sm\\:ml-3{margin-left:.75rem}.sm\\:mt-0{margin-top:0}.sm\\:mt-8{margin-top:2rem}.sm\\:flex{display:flex}.sm\\:grid-cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}.sm\\:grid-cols-3{grid-template-columns:repeat(3,minmax(0,1fr))}.sm\\:justify-center{justify-content:center}.sm\\:justify-between{justify-content:space-between}.sm\\:gap-6{gap:1.5rem}.sm\\:rounded-md{border-radius:.375rem}.sm\\:p-6{padding:1.5rem}.sm\\:px-6{padding-left:1.5rem;padding-right:1.5rem}.sm\\:text-\\[18px\\]{font-size:18px}.sm\\:text-sm{font-size:.875rem;line-height:1.25rem}}@media (min-width:768px){.md\\:block{display:block}.md\\:hidden{display:none}.md\\:w-1\\/4{width:25%}.md\\:w-3\\/4{width:75%}.md\\:grid-cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}.md\\:grid-cols-3{grid-template-columns:repeat(3,minmax(0,1fr))}.md\\:grid-cols-4{grid-template-columns:repeat(4,minmax(0,1fr))}.md\\:flex-row{flex-direction:row}.md\\:gap-3{gap:.75rem}.md\\:gap-6{gap:1.5rem}.md\\:py-4{padding-top:1rem;padding-bottom:1rem}.md\\:text-2xl{font-size:1.5rem;line-height:2rem}.md\\:text-5xl{font-size:3rem;line-height:1}.md\\:text-lg{font-size:1.125rem;line-height:1.75rem}}@media (min-width:1024px){.lg\\:col-span-2{grid-column:span 2/span 2}.lg\\:block{display:block}.lg\\:flex{display:flex}.lg\\:hidden{display:none}.lg\\:w-\\[540px\\]{width:540px}.lg\\:grid-cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}.lg\\:grid-cols-3{grid-template-columns:repeat(3,minmax(0,1fr))}.lg\\:grid-cols-4{grid-template-columns:repeat(4,minmax(0,1fr))}.lg\\:flex-row{flex-direction:row}.lg\\:gap-4{gap:1rem}.lg\\:px-8{padding-left:2rem;padding-right:2rem}}@media (min-width:1280px){.xl\\:w-\\[28\\%\\]{width:28%}.xl\\:p-8{padding:2rem}.xl\\:px-8{padding-left:2rem;padding-right:2rem}.xl\\:text-3xl{font-size:1.875rem;line-height:2.25rem}}';

// src/api/debug.js
async function handleDebugRequest(request, env) {
  const url = new URL(request.url);
  const pathname2 = url.pathname;
  if (pathname2 === "/api/debug/locations") {
    return await handleDebugLocations(request, env);
  }
  if (pathname2 === "/api/debug/users") {
    return await handleDebugUsers(request, env);
  }
  if (pathname2 === "/api/debug/test-user-counts") {
    return await handleTestUserCounts(request, env);
  }
  if (pathname2 === "/api/debug/test-profile-data") {
    return await handleTestProfileData(request, env);
  }
  if (pathname2 === "/api/debug/test-profile-simple") {
    return await handleTestProfileSimple(request, env);
  }
  if (pathname2 === "/api/debug/test-profile-full") {
    return await handleTestProfileFull(request, env);
  }
  if (pathname2 === "/api/debug/test-profile-request") {
    return await handleTestProfileRequest(request, env);
  }
  if (pathname2 === "/api/debug/test-session") {
    return await handleTestSession(request, env);
  }
  if (pathname2 === "/api/debug/test-profile-logged-in") {
    return await handleTestProfileLoggedIn(request, env);
  }
  if (pathname2 === "/api/debug/test-homepage-data") {
    return await handleTestHomepageData(request, env);
  }
  if (pathname2 === "/api/debug/test-xiaohongshu-layout") {
    return await handleTestXiaohongshuLayout(request, env);
  }
  if (pathname2 === "/api/debug/test-process-images") {
    return await handleTestProcessImages(request, env);
  }
  return new Response("Not Found", { status: 404 });
}
async function handleDebugLocations(request, env) {
  if (!env.DB) {
    return new Response("Database not available", { status: 500 });
  }
  try {
    const { LocationService: LocationService2 } = await Promise.resolve().then(() => (init_LocationService(), LocationService_exports));
    const locationService = new LocationService2(env.DB, env.GOOGLE_MAPS_API_KEY);
    const locations = await locationService.getRecentLocationsWithThumbnails(5);
    return new Response(JSON.stringify({
      success: true,
      locations: locations || [],
      count: locations ? locations.length : 0
    }), {
      status: 200,
      headers: {
        "Content-Type": "application/json",
        "Cache-Control": "no-cache"
      }
    });
  } catch (error) {
    console.error("[Debug API] Error:", error);
    return new Response(JSON.stringify({
      success: false,
      error: error.message
    }), {
      status: 500,
      headers: {
        "Content-Type": "application/json",
        "Cache-Control": "no-cache"
      }
    });
  }
}
async function handleDebugUsers(request, env) {
  if (!env.DB) {
    return new Response("Database not available", { status: 500 });
  }
  try {
    const stmt = env.DB.prepare(`
            SELECT id, email, name, role, created_at
            FROM users 
            ORDER BY created_at DESC 
            LIMIT 5
        `);
    const { results } = await stmt.all();
    return new Response(JSON.stringify({
      success: true,
      users: results || [],
      count: results ? results.length : 0
    }), {
      status: 200,
      headers: {
        "Content-Type": "application/json",
        "Cache-Control": "no-cache"
      }
    });
  } catch (error) {
    console.error("[Debug API] Error:", error);
    return new Response(JSON.stringify({
      success: false,
      error: error.message
    }), {
      status: 500,
      headers: {
        "Content-Type": "application/json",
        "Cache-Control": "no-cache"
      }
    });
  }
}
async function handleTestProcessImages(request, env) {
  if (!env.DB) {
    return new Response("Database not available", { status: 500 });
  }
  try {
    const stmt = env.DB.prepare(`
            SELECT id, name, google_place_id, thumbnail_url, created_at
            FROM locations 
            ORDER BY created_at DESC 
            LIMIT 3
        `);
    const { results } = await stmt.all();
    const { ImageCacheService: ImageCacheService2 } = await Promise.resolve().then(() => (init_ImageCacheService(), ImageCacheService_exports));
    const imageCacheService = new ImageCacheService2(env.DB);
    const testResults = results.map((location) => ({
      id: location.id,
      name: location.name,
      original_thumbnail_url: location.thumbnail_url,
      is_google_places_url: imageCacheService.isGooglePlacesImageUrl(location.thumbnail_url),
      photo_reference: imageCacheService.extractPhotoReference(location.thumbnail_url)
    }));
    const processedResults = await imageCacheService.processLocationsImages(results);
    return new Response(JSON.stringify({
      success: true,
      original_locations: results,
      test_results: testResults,
      processed_locations: processedResults,
      count: results ? results.length : 0
    }), {
      status: 200,
      headers: {
        "Content-Type": "application/json",
        "Cache-Control": "no-cache"
      }
    });
  } catch (error) {
    console.error("[Debug API] Error testing process images:", error);
    return new Response(JSON.stringify({
      success: false,
      error: error.message
    }), {
      status: 500,
      headers: {
        "Content-Type": "application/json",
        "Cache-Control": "no-cache"
      }
    });
  }
}
async function handleTestUserCounts(request, env) {
  if (!env.DB) {
    return new Response("Database not available", { status: 500 });
  }
  try {
    const { LocationService: LocationService2 } = await Promise.resolve().then(() => (init_LocationService(), LocationService_exports));
    const locationService = new LocationService2(env.DB, env.GOOGLE_MAPS_API_KEY);
    const userId = 3;
    const userCounts = await locationService.getUserLocationCounts(userId);
    const userCreatedLocations = await locationService.getUserCreatedLocations(userId);
    return new Response(JSON.stringify({
      success: true,
      userId,
      userEmail: "blackie.hsieh@gmail.com",
      userCounts,
      userCreatedLocations,
      createdLocationsCount: userCreatedLocations.length
    }), {
      status: 200,
      headers: {
        "Content-Type": "application/json",
        "Cache-Control": "no-cache"
      }
    });
  } catch (error) {
    console.error("[Debug API] Error testing user counts:", error);
    return new Response(JSON.stringify({
      success: false,
      error: error.message
    }), {
      status: 500,
      headers: {
        "Content-Type": "application/json",
        "Cache-Control": "no-cache"
      }
    });
  }
}
async function handleTestProfileData(request, env) {
  if (!env.DB) {
    return new Response("Database not available", { status: 500 });
  }
  try {
    const { LocationService: LocationService2 } = await Promise.resolve().then(() => (init_LocationService(), LocationService_exports));
    const locationService = new LocationService2(env.DB, env.GOOGLE_MAPS_API_KEY);
    const userId = 3;
    const userLocations = await locationService.getUserLocations(userId);
    const userCreatedLocations = await locationService.getUserCreatedLocations(userId);
    const allLocations = [...userLocations, ...userCreatedLocations];
    const userLocationCounts = await locationService.getUserLocationCounts(userId);
    const locationInteractionCounts = {};
    const userLocationStatuses = {};
    for (const location of allLocations) {
      const counts = await locationService.getLocationInteractionCounts(location.id);
      locationInteractionCounts[location.id] = counts;
      const status = await locationService.getUserLocationStatus(userId, location.id);
      if (status) {
        userLocationStatuses[location.id] = status;
      }
    }
    const visitedLocations = allLocations.filter((loc) => userLocationStatuses[loc.id] === "visited");
    const wantToVisitLocations = allLocations.filter((loc) => userLocationStatuses[loc.id] === "want_to_visit");
    const wantToRevisitLocations = allLocations.filter((loc) => userLocationStatuses[loc.id] === "want_to_revisit");
    const createdLocations = allLocations.filter((loc) => loc.created_by_user_id === userId);
    return new Response(JSON.stringify({
      success: true,
      userId,
      userEmail: "blackie.hsieh@gmail.com",
      userLocationCounts,
      allLocationsCount: allLocations.length,
      userLocationsCount: userLocations.length,
      userCreatedLocationsCount: userCreatedLocations.length,
      visitedLocationsCount: visitedLocations.length,
      wantToVisitLocationsCount: wantToVisitLocations.length,
      wantToRevisitLocationsCount: wantToRevisitLocations.length,
      createdLocationsCount: createdLocations.length,
      createdLocations: createdLocations.map((loc) => ({
        id: loc.id,
        name: loc.name,
        created_by_user_id: loc.created_by_user_id,
        created_at: loc.created_at
      }))
    }), {
      status: 200,
      headers: {
        "Content-Type": "application/json",
        "Cache-Control": "no-cache"
      }
    });
  } catch (error) {
    console.error("[Debug API] Error testing profile data:", error);
    return new Response(JSON.stringify({
      success: false,
      error: error.message
    }), {
      status: 500,
      headers: {
        "Content-Type": "application/json",
        "Cache-Control": "no-cache"
      }
    });
  }
}
async function handleTestProfileSimple(request, env) {
  if (!env.DB) {
    return new Response("Database not available", { status: 500 });
  }
  try {
    const mockUser = {
      id: 3,
      email: "blackie.hsieh@gmail.com",
      name: "blackie hsieh",
      role: "admin"
    };
    const { getProfilePageHtml: getProfilePageHtml2 } = await Promise.resolve().then(() => (init_html2(), html_exports));
    const html = getProfilePageHtml2(
      mockUser,
      "",
      // 空的 CSS
      [],
      // 空的地點數組
      { visited: 0, want_to_visit: 0, want_to_revisit: 0, created: 3, owner: 0 },
      // 模擬統計
      {},
      // 空的互動統計
      {}
      // 空的用戶狀態
    );
    return new Response(JSON.stringify({
      success: true,
      message: "Profile page HTML generated successfully",
      htmlLength: html.length,
      htmlPreview: html.substring(0, 500) + "..."
    }), {
      status: 200,
      headers: {
        "Content-Type": "application/json",
        "Cache-Control": "no-cache"
      }
    });
  } catch (error) {
    console.error("[Debug API] Error testing profile simple:", error);
    return new Response(JSON.stringify({
      success: false,
      error: error.message,
      stack: error.stack
    }), {
      status: 500,
      headers: {
        "Content-Type": "application/json",
        "Cache-Control": "no-cache"
      }
    });
  }
}
async function handleTestProfileFull(request, env) {
  if (!env.DB) {
    return new Response("Database not available", { status: 500 });
  }
  try {
    const results = {
      success: true,
      steps: [],
      errors: []
    };
    try {
      const { UserService: UserService2 } = await Promise.resolve().then(() => (init_UserService(), UserService_exports));
      const { SessionService: SessionService2 } = await Promise.resolve().then(() => (init_SessionService(), SessionService_exports));
      const { GoogleAuthService: GoogleAuthService2 } = await Promise.resolve().then(() => (init_GoogleAuthService(), GoogleAuthService_exports));
      const { AuthService: AuthService2 } = await Promise.resolve().then(() => (init_AuthService(), AuthService_exports));
      const { LocationService: LocationService2 } = await Promise.resolve().then(() => (init_LocationService(), LocationService_exports));
      const userService = new UserService2(env.DB);
      const sessionService = new SessionService2(env.DB);
      const googleAuthService = new GoogleAuthService2(env);
      const authService = new AuthService2(userService, sessionService, googleAuthService);
      const locationService = new LocationService2(env.DB, env.GOOGLE_MAPS_API_KEY);
      results.steps.push("\u2705 \u6240\u6709\u670D\u52D9\u5BE6\u4F8B\u5316\u6210\u529F");
    } catch (error) {
      results.steps.push("\u274C \u670D\u52D9\u5BE6\u4F8B\u5316\u5931\u6557");
      results.errors.push(`\u670D\u52D9\u5BE6\u4F8B\u5316\u932F\u8AA4: ${error.message}`);
    }
    try {
      const { UserService: UserService2 } = await Promise.resolve().then(() => (init_UserService(), UserService_exports));
      const userService = new UserService2(env.DB);
      const user = await userService.findUserById(3);
      if (user) {
        results.steps.push("\u2705 \u7528\u6236\u6578\u64DA\u7372\u53D6\u6210\u529F");
        results.user = {
          id: user.id,
          email: user.email,
          name: user.name,
          role: user.role
        };
      } else {
        results.steps.push("\u274C \u7528\u6236\u6578\u64DA\u7372\u53D6\u5931\u6557");
        results.errors.push("\u627E\u4E0D\u5230\u7528\u6236 ID 3");
      }
    } catch (error) {
      results.steps.push("\u274C \u7528\u6236\u6578\u64DA\u7372\u53D6\u5931\u6557");
      results.errors.push(`\u7528\u6236\u6578\u64DA\u7372\u53D6\u932F\u8AA4: ${error.message}`);
    }
    try {
      const { LocationService: LocationService2 } = await Promise.resolve().then(() => (init_LocationService(), LocationService_exports));
      const locationService = new LocationService2(env.DB, env.GOOGLE_MAPS_API_KEY);
      const userLocations = await locationService.getUserLocations(3);
      const userCreatedLocations = await locationService.getUserCreatedLocations(3);
      const userLocationCounts = await locationService.getUserLocationCounts(3);
      results.steps.push("\u2705 \u5730\u9EDE\u6578\u64DA\u7372\u53D6\u6210\u529F");
      results.locationData = {
        userLocationsCount: userLocations.length,
        userCreatedLocationsCount: userCreatedLocations.length,
        userLocationCounts
      };
    } catch (error) {
      results.steps.push("\u274C \u5730\u9EDE\u6578\u64DA\u7372\u53D6\u5931\u6557");
      results.errors.push(`\u5730\u9EDE\u6578\u64DA\u7372\u53D6\u932F\u8AA4: ${error.message}`);
    }
    try {
      const { getProfilePageHtml: getProfilePageHtml2 } = await Promise.resolve().then(() => (init_html2(), html_exports));
      const mockUser = {
        id: 3,
        email: "blackie.hsieh@gmail.com",
        name: "blackie hsieh",
        role: "admin"
      };
      const html = getProfilePageHtml2(
        mockUser,
        "",
        [],
        { visited: 0, want_to_visit: 0, want_to_revisit: 0, created: 3, owner: 0 },
        {},
        {}
      );
      results.steps.push("\u2705 \u6A21\u677F\u751F\u6210\u6210\u529F");
      results.htmlLength = html.length;
    } catch (error) {
      results.steps.push("\u274C \u6A21\u677F\u751F\u6210\u5931\u6557");
      results.errors.push(`\u6A21\u677F\u751F\u6210\u932F\u8AA4: ${error.message}`);
    }
    return new Response(JSON.stringify(results), {
      status: 200,
      headers: {
        "Content-Type": "application/json",
        "Cache-Control": "no-cache"
      }
    });
  } catch (error) {
    console.error("[Debug API] Error testing profile full:", error);
    return new Response(JSON.stringify({
      success: false,
      error: error.message,
      stack: error.stack
    }), {
      status: 500,
      headers: {
        "Content-Type": "application/json",
        "Cache-Control": "no-cache"
      }
    });
  }
}
async function handleTestProfileRequest(request, env) {
  if (!env.DB) {
    return new Response("Database not available", { status: 500 });
  }
  try {
    const results = {
      success: true,
      steps: [],
      errors: []
    };
    try {
      const { UserService: UserService2 } = await Promise.resolve().then(() => (init_UserService(), UserService_exports));
      const { SessionService: SessionService2 } = await Promise.resolve().then(() => (init_SessionService(), SessionService_exports));
      const { GoogleAuthService: GoogleAuthService2 } = await Promise.resolve().then(() => (init_GoogleAuthService(), GoogleAuthService_exports));
      const { AuthService: AuthService2 } = await Promise.resolve().then(() => (init_AuthService(), AuthService_exports));
      const { LocationService: LocationService2 } = await Promise.resolve().then(() => (init_LocationService(), LocationService_exports));
      const userService = new UserService2(env.DB);
      const sessionService = new SessionService2(env.DB);
      const googleAuthService = new GoogleAuthService2(env);
      const authService = new AuthService2(userService, sessionService, googleAuthService);
      const locationService = new LocationService2(env.DB, env.GOOGLE_MAPS_API_KEY);
      results.steps.push("\u2705 \u670D\u52D9\u5BE6\u4F8B\u5316\u6210\u529F");
    } catch (error) {
      results.steps.push("\u274C \u670D\u52D9\u5BE6\u4F8B\u5316\u5931\u6557");
      results.errors.push(`\u670D\u52D9\u5BE6\u4F8B\u5316\u932F\u8AA4: ${error.message}`);
      throw error;
    }
    try {
      const { UserService: UserService2 } = await Promise.resolve().then(() => (init_UserService(), UserService_exports));
      const { SessionService: SessionService2 } = await Promise.resolve().then(() => (init_SessionService(), SessionService_exports));
      const { GoogleAuthService: GoogleAuthService2 } = await Promise.resolve().then(() => (init_GoogleAuthService(), GoogleAuthService_exports));
      const { AuthService: AuthService2 } = await Promise.resolve().then(() => (init_AuthService(), AuthService_exports));
      const userService = new UserService2(env.DB);
      const sessionService = new SessionService2(env.DB);
      const googleAuthService = new GoogleAuthService2(env);
      const authService = new AuthService2(userService, sessionService, googleAuthService);
      const user = await userService.findUserById(3);
      if (!user) {
        throw new Error("\u627E\u4E0D\u5230\u7528\u6236 ID 3");
      }
      results.steps.push("\u2705 \u7528\u6236\u8A8D\u8B49\u6210\u529F");
      results.user = {
        id: user.id,
        email: user.email,
        name: user.name,
        role: user.role
      };
    } catch (error) {
      results.steps.push("\u274C \u7528\u6236\u8A8D\u8B49\u5931\u6557");
      results.errors.push(`\u8A8D\u8B49\u932F\u8AA4: ${error.message}`);
      throw error;
    }
    try {
      const { LocationService: LocationService2 } = await Promise.resolve().then(() => (init_LocationService(), LocationService_exports));
      const locationService = new LocationService2(env.DB, env.GOOGLE_MAPS_API_KEY);
      const userLocations = await locationService.getUserLocations(3);
      const userCreatedLocations = await locationService.getUserCreatedLocations(3);
      const allLocations = [...userLocations, ...userCreatedLocations];
      const locationInteractionCounts = {};
      const userLocationStatuses = {};
      for (const location of allLocations) {
        const counts = await locationService.getLocationInteractionCounts(location.id);
        locationInteractionCounts[location.id] = counts;
      }
      for (const location of allLocations) {
        const status = await locationService.getUserLocationStatus(3, location.id);
        if (status) {
          userLocationStatuses[location.id] = status;
        }
      }
      const userLocationCounts = await locationService.getUserLocationCounts(3);
      results.steps.push("\u2705 Profile \u6578\u64DA\u7372\u53D6\u6210\u529F");
      results.profileData = {
        userLocationsCount: userLocations.length,
        userCreatedLocationsCount: userCreatedLocations.length,
        allLocationsCount: allLocations.length,
        userLocationCounts,
        locationInteractionCountsKeys: Object.keys(locationInteractionCounts).length,
        userLocationStatusesKeys: Object.keys(userLocationStatuses).length
      };
    } catch (error) {
      results.steps.push("\u274C Profile \u6578\u64DA\u7372\u53D6\u5931\u6557");
      results.errors.push(`\u6578\u64DA\u7372\u53D6\u932F\u8AA4: ${error.message}`);
      throw error;
    }
    try {
      const { getProfilePageHtml: getProfilePageHtml2 } = await Promise.resolve().then(() => (init_html2(), html_exports));
      const { LocationService: LocationService2 } = await Promise.resolve().then(() => (init_LocationService(), LocationService_exports));
      const locationService = new LocationService2(env.DB, env.GOOGLE_MAPS_API_KEY);
      const userLocations = await locationService.getUserLocations(3);
      const userCreatedLocations = await locationService.getUserCreatedLocations(3);
      const allLocations = [...userLocations, ...userCreatedLocations];
      const userLocationCounts = await locationService.getUserLocationCounts(3);
      const locationInteractionCounts = {};
      const userLocationStatuses = {};
      for (const location of allLocations) {
        const counts = await locationService.getLocationInteractionCounts(location.id);
        locationInteractionCounts[location.id] = counts;
        const status = await locationService.getUserLocationStatus(3, location.id);
        if (status) {
          userLocationStatuses[location.id] = status;
        }
      }
      const html = getProfilePageHtml2(
        results.user,
        "",
        // 空的 CSS
        allLocations,
        userLocationCounts,
        locationInteractionCounts,
        userLocationStatuses
      );
      results.steps.push("\u2705 Profile \u9801\u9762 HTML \u751F\u6210\u6210\u529F");
      results.htmlLength = html.length;
      results.htmlPreview = html.substring(0, 200) + "...";
    } catch (error) {
      results.steps.push("\u274C Profile \u9801\u9762 HTML \u751F\u6210\u5931\u6557");
      results.errors.push(`HTML \u751F\u6210\u932F\u8AA4: ${error.message}`);
      throw error;
    }
    return new Response(JSON.stringify(results), {
      status: 200,
      headers: {
        "Content-Type": "application/json",
        "Cache-Control": "no-cache"
      }
    });
  } catch (error) {
    console.error("[Debug API] Error testing profile request:", error);
    return new Response(JSON.stringify({
      success: false,
      error: error.message,
      stack: error.stack
    }), {
      status: 500,
      headers: {
        "Content-Type": "application/json",
        "Cache-Control": "no-cache"
      }
    });
  }
}
async function handleTestSession(request, env) {
  if (!env.DB) {
    return new Response("Database not available", { status: 500 });
  }
  try {
    const results = {
      success: true,
      steps: [],
      errors: []
    };
    try {
      const { UserService: UserService2 } = await Promise.resolve().then(() => (init_UserService(), UserService_exports));
      const { SessionService: SessionService2 } = await Promise.resolve().then(() => (init_SessionService(), SessionService_exports));
      const { GoogleAuthService: GoogleAuthService2 } = await Promise.resolve().then(() => (init_GoogleAuthService(), GoogleAuthService_exports));
      const { AuthService: AuthService2 } = await Promise.resolve().then(() => (init_AuthService(), AuthService_exports));
      const userService = new UserService2(env.DB);
      const sessionService = new SessionService2(env.DB);
      const googleAuthService = new GoogleAuthService2(env);
      const authService = new AuthService2(userService, sessionService, googleAuthService);
      results.steps.push("\u2705 \u670D\u52D9\u5BE6\u4F8B\u5316\u6210\u529F");
    } catch (error) {
      results.steps.push("\u274C \u670D\u52D9\u5BE6\u4F8B\u5316\u5931\u6557");
      results.errors.push(`\u670D\u52D9\u5BE6\u4F8B\u5316\u932F\u8AA4: ${error.message}`);
      throw error;
    }
    try {
      const { SessionService: SessionService2 } = await Promise.resolve().then(() => (init_SessionService(), SessionService_exports));
      const sessionService = new SessionService2(env.DB);
      const session = await sessionService.createSession(3);
      results.steps.push("\u2705 \u6703\u8A71\u5275\u5EFA\u6210\u529F");
      results.session = {
        id: session.id,
        userId: session.userId,
        expiresAt: session.expiresAt
      };
    } catch (error) {
      results.steps.push("\u274C \u6703\u8A71\u5275\u5EFA\u5931\u6557");
      results.errors.push(`\u6703\u8A71\u5275\u5EFA\u932F\u8AA4: ${error.message}`);
      throw error;
    }
    try {
      const { SessionService: SessionService2 } = await Promise.resolve().then(() => (init_SessionService(), SessionService_exports));
      const sessionService = new SessionService2(env.DB);
      const retrievedSession = await sessionService.getSession(results.session.id);
      if (retrievedSession) {
        results.steps.push("\u2705 \u6703\u8A71\u7372\u53D6\u6210\u529F");
        results.retrievedSession = {
          id: retrievedSession.id,
          userId: retrievedSession.userId,
          expiresAt: retrievedSession.expiresAt
        };
      } else {
        results.steps.push("\u274C \u6703\u8A71\u7372\u53D6\u5931\u6557");
        results.errors.push("\u7121\u6CD5\u7372\u53D6\u525B\u5275\u5EFA\u7684\u6703\u8A71");
      }
    } catch (error) {
      results.steps.push("\u274C \u6703\u8A71\u7372\u53D6\u5931\u6557");
      results.errors.push(`\u6703\u8A71\u7372\u53D6\u932F\u8AA4: ${error.message}`);
      throw error;
    }
    try {
      const { UserService: UserService2 } = await Promise.resolve().then(() => (init_UserService(), UserService_exports));
      const { SessionService: SessionService2 } = await Promise.resolve().then(() => (init_SessionService(), SessionService_exports));
      const { GoogleAuthService: GoogleAuthService2 } = await Promise.resolve().then(() => (init_GoogleAuthService(), GoogleAuthService_exports));
      const { AuthService: AuthService2 } = await Promise.resolve().then(() => (init_AuthService(), AuthService_exports));
      const userService = new UserService2(env.DB);
      const sessionService = new SessionService2(env.DB);
      const googleAuthService = new GoogleAuthService2(env);
      const authService = new AuthService2(userService, sessionService, googleAuthService);
      const user = await authService.getUserFromSession(results.session.id);
      if (user) {
        results.steps.push("\u2705 AuthService.getUserFromSession \u6210\u529F");
        results.user = {
          id: user.id,
          email: user.email,
          name: user.name,
          role: user.role
        };
      } else {
        results.steps.push("\u274C AuthService.getUserFromSession \u5931\u6557");
        results.errors.push("\u7121\u6CD5\u5F9E\u6703\u8A71\u7372\u53D6\u7528\u6236");
      }
    } catch (error) {
      results.steps.push("\u274C AuthService.getUserFromSession \u5931\u6557");
      results.errors.push(`AuthService \u932F\u8AA4: ${error.message}`);
      throw error;
    }
    try {
      const { SessionService: SessionService2 } = await Promise.resolve().then(() => (init_SessionService(), SessionService_exports));
      const sessionService = new SessionService2(env.DB);
      await sessionService.deleteSession(results.session.id);
      results.steps.push("\u2705 \u6703\u8A71\u6E05\u7406\u6210\u529F");
    } catch (error) {
      results.steps.push("\u274C \u6703\u8A71\u6E05\u7406\u5931\u6557");
      results.errors.push(`\u6703\u8A71\u6E05\u7406\u932F\u8AA4: ${error.message}`);
    }
    return new Response(JSON.stringify(results), {
      status: 200,
      headers: {
        "Content-Type": "application/json",
        "Cache-Control": "no-cache"
      }
    });
  } catch (error) {
    console.error("[Debug API] Error testing session:", error);
    return new Response(JSON.stringify({
      success: false,
      error: error.message,
      stack: error.stack
    }), {
      status: 500,
      headers: {
        "Content-Type": "application/json",
        "Cache-Control": "no-cache"
      }
    });
  }
}
async function handleTestProfileLoggedIn(request, env) {
  if (!env.DB) {
    return new Response("Database not available", { status: 500 });
  }
  try {
    const results = {
      success: true,
      steps: [],
      errors: []
    };
    try {
      const { UserService: UserService2 } = await Promise.resolve().then(() => (init_UserService(), UserService_exports));
      const { SessionService: SessionService2 } = await Promise.resolve().then(() => (init_SessionService(), SessionService_exports));
      const { GoogleAuthService: GoogleAuthService2 } = await Promise.resolve().then(() => (init_GoogleAuthService(), GoogleAuthService_exports));
      const { AuthService: AuthService2 } = await Promise.resolve().then(() => (init_AuthService(), AuthService_exports));
      const { LocationService: LocationService2 } = await Promise.resolve().then(() => (init_LocationService(), LocationService_exports));
      const userService = new UserService2(env.DB);
      const sessionService = new SessionService2(env.DB);
      const googleAuthService = new GoogleAuthService2(env);
      const authService = new AuthService2(userService, sessionService, googleAuthService);
      const locationService = new LocationService2(env.DB, env.GOOGLE_MAPS_API_KEY);
      results.steps.push("\u2705 \u670D\u52D9\u5BE6\u4F8B\u5316\u6210\u529F");
    } catch (error) {
      results.steps.push("\u274C \u670D\u52D9\u5BE6\u4F8B\u5316\u5931\u6557");
      results.errors.push(`\u670D\u52D9\u5BE6\u4F8B\u5316\u932F\u8AA4: ${error.message}`);
      throw error;
    }
    try {
      const { UserService: UserService2 } = await Promise.resolve().then(() => (init_UserService(), UserService_exports));
      const userService = new UserService2(env.DB);
      const user = await userService.findUserById(3);
      if (!user) {
        throw new Error("\u627E\u4E0D\u5230\u7528\u6236 ID 3");
      }
      results.steps.push("\u2705 \u7528\u6236\u7372\u53D6\u6210\u529F");
      results.user = {
        id: user.id,
        email: user.email,
        name: user.name,
        role: user.role
      };
    } catch (error) {
      results.steps.push("\u274C \u7528\u6236\u7372\u53D6\u5931\u6557");
      results.errors.push(`\u7528\u6236\u7372\u53D6\u932F\u8AA4: ${error.message}`);
      throw error;
    }
    try {
      const { LocationService: LocationService2 } = await Promise.resolve().then(() => (init_LocationService(), LocationService_exports));
      const locationService = new LocationService2(env.DB, env.GOOGLE_MAPS_API_KEY);
      let userLocations = [];
      let userCreatedLocations = [];
      let allLocations = [];
      let userLocationCounts = null;
      let locationInteractionCounts = {};
      let userLocationStatuses = {};
      try {
        userLocations = await locationService.getUserLocations(3);
        userCreatedLocations = await locationService.getUserCreatedLocations(3);
        allLocations = [...userLocations, ...userCreatedLocations];
        for (const location of allLocations) {
          const counts = await locationService.getLocationInteractionCounts(location.id);
          locationInteractionCounts[location.id] = counts;
        }
        for (const location of allLocations) {
          const status = await locationService.getUserLocationStatus(3, location.id);
          if (status) {
            userLocationStatuses[location.id] = status;
          }
        }
        userLocationCounts = await locationService.getUserLocationCounts(3);
      } catch (error) {
        console.error("[Debug API] Error in try block:", error);
        userLocations = [];
        userCreatedLocations = [];
        allLocations = [];
        userLocationCounts = { visited: 0, want_to_visit: 0, want_to_revisit: 0, created: 0, owner: 0 };
        locationInteractionCounts = {};
        userLocationStatuses = {};
      }
      results.steps.push("\u2705 Profile \u6578\u64DA\u7372\u53D6\u6210\u529F\uFF08\u5305\u542B\u932F\u8AA4\u8655\u7406\uFF09");
      results.profileData = {
        userLocationsCount: userLocations.length,
        userCreatedLocationsCount: userCreatedLocations.length,
        allLocationsCount: allLocations.length,
        userLocationCounts,
        locationInteractionCountsKeys: Object.keys(locationInteractionCounts).length,
        userLocationStatusesKeys: Object.keys(userLocationStatuses).length
      };
    } catch (error) {
      results.steps.push("\u274C Profile \u6578\u64DA\u7372\u53D6\u5931\u6557");
      results.errors.push(`\u6578\u64DA\u7372\u53D6\u932F\u8AA4: ${error.message}`);
      throw error;
    }
    try {
      const { getProfilePageHtml: getProfilePageHtml2 } = await Promise.resolve().then(() => (init_html2(), html_exports));
      const { LocationService: LocationService2 } = await Promise.resolve().then(() => (init_LocationService(), LocationService_exports));
      const locationService = new LocationService2(env.DB, env.GOOGLE_MAPS_API_KEY);
      let userLocations = [];
      let userCreatedLocations = [];
      let allLocations = [];
      let userLocationCounts = null;
      let locationInteractionCounts = {};
      let userLocationStatuses = {};
      try {
        userLocations = await locationService.getUserLocations(3);
        userCreatedLocations = await locationService.getUserCreatedLocations(3);
        allLocations = [...userLocations, ...userCreatedLocations];
        userLocationCounts = await locationService.getUserLocationCounts(3);
        for (const location of allLocations) {
          const counts = await locationService.getLocationInteractionCounts(location.id);
          locationInteractionCounts[location.id] = counts;
          const status = await locationService.getUserLocationStatus(3, location.id);
          if (status) {
            userLocationStatuses[location.id] = status;
          }
        }
      } catch (error) {
        console.error("[Debug API] Error in HTML generation try block:", error);
        userLocations = [];
        userCreatedLocations = [];
        allLocations = [];
        userLocationCounts = { visited: 0, want_to_visit: 0, want_to_revisit: 0, created: 0, owner: 0 };
        locationInteractionCounts = {};
        userLocationStatuses = {};
      }
      const html = getProfilePageHtml2(
        results.user,
        "",
        // 空的 CSS
        allLocations,
        userLocationCounts,
        locationInteractionCounts,
        userLocationStatuses
      );
      results.steps.push("\u2705 Profile \u9801\u9762 HTML \u751F\u6210\u6210\u529F\uFF08\u5305\u542B\u932F\u8AA4\u8655\u7406\uFF09");
      results.htmlLength = html.length;
      results.htmlPreview = html.substring(0, 200) + "...";
    } catch (error) {
      results.steps.push("\u274C Profile \u9801\u9762 HTML \u751F\u6210\u5931\u6557");
      results.errors.push(`HTML \u751F\u6210\u932F\u8AA4: ${error.message}`);
      throw error;
    }
    return new Response(JSON.stringify(results), {
      status: 200,
      headers: {
        "Content-Type": "application/json",
        "Cache-Control": "no-cache"
      }
    });
  } catch (error) {
    console.error("[Debug API] Error testing profile logged in:", error);
    return new Response(JSON.stringify({
      success: false,
      error: error.message,
      stack: error.stack
    }), {
      status: 500,
      headers: {
        "Content-Type": "application/json",
        "Cache-Control": "no-cache"
      }
    });
  }
}
async function handleTestHomepageData(request, env) {
  if (!env.DB) {
    return new Response("Database not available", { status: 500 });
  }
  try {
    const results = {
      success: true,
      steps: [],
      errors: []
    };
    try {
      const { LocationService: LocationService2 } = await Promise.resolve().then(() => (init_LocationService(), LocationService_exports));
      const locationService = new LocationService2(env.DB, env.GOOGLE_MAPS_API_KEY);
      results.steps.push("\u2705 \u670D\u52D9\u5BE6\u4F8B\u5316\u6210\u529F");
    } catch (error) {
      results.steps.push("\u274C \u670D\u52D9\u5BE6\u4F8B\u5316\u5931\u6557");
      results.errors.push(`\u670D\u52D9\u5BE6\u4F8B\u5316\u932F\u8AA4: ${error.message}`);
      throw error;
    }
    try {
      const { LocationService: LocationService2 } = await Promise.resolve().then(() => (init_LocationService(), LocationService_exports));
      const locationService = new LocationService2(env.DB, env.GOOGLE_MAPS_API_KEY);
      const generalLocations = await locationService.getRecentLocationsWithThumbnails(12);
      const locationInteractionCounts = {};
      const userLocationStatuses = {};
      for (const location of generalLocations) {
        const counts = await locationService.getLocationInteractionCounts(location.id);
        locationInteractionCounts[location.id] = counts;
      }
      results.steps.push("\u2705 \u9996\u9801\u6578\u64DA\u7372\u53D6\u6210\u529F");
      results.homepageData = {
        generalLocationsCount: generalLocations.length,
        locationInteractionCountsKeys: Object.keys(locationInteractionCounts).length,
        userLocationStatusesKeys: Object.keys(userLocationStatuses).length,
        sampleLocation: generalLocations.length > 0 ? {
          id: generalLocations[0].id,
          name: generalLocations[0].name,
          interactionCounts: locationInteractionCounts[generalLocations[0].id]
        } : null
      };
    } catch (error) {
      results.steps.push("\u274C \u9996\u9801\u6578\u64DA\u7372\u53D6\u5931\u6557");
      results.errors.push(`\u6578\u64DA\u7372\u53D6\u932F\u8AA4: ${error.message}`);
      throw error;
    }
    try {
      const { getHomePageContent: getHomePageContent2 } = await Promise.resolve().then(() => (init_html2(), html_exports));
      const { LocationService: LocationService2 } = await Promise.resolve().then(() => (init_LocationService(), LocationService_exports));
      const locationService = new LocationService2(env.DB, env.GOOGLE_MAPS_API_KEY);
      const generalLocations = await locationService.getRecentLocationsWithThumbnails(12);
      const locationInteractionCounts = {};
      const userLocationStatuses = {};
      for (const location of generalLocations) {
        const counts = await locationService.getLocationInteractionCounts(location.id);
        locationInteractionCounts[location.id] = counts;
      }
      const html = getHomePageContent2(generalLocations, null, locationInteractionCounts, userLocationStatuses);
      results.steps.push("\u2705 \u9996\u9801 HTML \u751F\u6210\u6210\u529F");
      results.htmlLength = html.length;
      results.htmlPreview = html.substring(0, 200) + "...";
    } catch (error) {
      results.steps.push("\u274C \u9996\u9801 HTML \u751F\u6210\u5931\u6557");
      results.errors.push(`HTML \u751F\u6210\u932F\u8AA4: ${error.message}`);
      throw error;
    }
    return new Response(JSON.stringify(results), {
      status: 200,
      headers: {
        "Content-Type": "application/json",
        "Cache-Control": "no-cache"
      }
    });
  } catch (error) {
    console.error("[Debug API] Error testing homepage data:", error);
    return new Response(JSON.stringify({
      success: false,
      error: error.message,
      stack: error.stack
    }), {
      status: 500,
      headers: {
        "Content-Type": "application/json",
        "Cache-Control": "no-cache"
      }
    });
  }
}
async function handleTestXiaohongshuLayout(request, env) {
  if (!env.DB) {
    return new Response("Database not available", { status: 500 });
  }
  try {
    const results = {
      success: true,
      steps: [],
      errors: []
    };
    try {
      const { LocationService: LocationService2 } = await Promise.resolve().then(() => (init_LocationService(), LocationService_exports));
      const locationService = new LocationService2(env.DB, env.GOOGLE_MAPS_API_KEY);
      results.steps.push("\u2705 \u670D\u52D9\u5BE6\u4F8B\u5316\u6210\u529F");
    } catch (error) {
      results.steps.push("\u274C \u670D\u52D9\u5BE6\u4F8B\u5316\u5931\u6557");
      results.errors.push(`\u670D\u52D9\u5BE6\u4F8B\u5316\u932F\u8AA4: ${error.message}`);
      throw error;
    }
    try {
      const { LocationService: LocationService2 } = await Promise.resolve().then(() => (init_LocationService(), LocationService_exports));
      const locationService = new LocationService2(env.DB, env.GOOGLE_MAPS_API_KEY);
      const userLocations = await locationService.getUserLocations(3);
      const userCreatedLocations = await locationService.getUserCreatedLocations(3);
      const allLocations = [...userLocations, ...userCreatedLocations];
      const userLocationCounts = await locationService.getUserLocationCounts(3);
      const locationInteractionCounts = {};
      const userLocationStatuses = {};
      for (const location of allLocations) {
        const counts = await locationService.getLocationInteractionCounts(location.id);
        locationInteractionCounts[location.id] = counts;
      }
      for (const location of allLocations) {
        const status = await locationService.getUserLocationStatus(3, location.id);
        if (status) {
          userLocationStatuses[location.id] = status;
        }
      }
      results.steps.push("\u2705 \u5C0F\u7D05\u66F8\u98A8\u683C\u4F48\u5C40\u6578\u64DA\u7372\u53D6\u6210\u529F");
      results.xiaohongshuData = {
        userLocationsCount: userLocations.length,
        userCreatedLocationsCount: userCreatedLocations.length,
        allLocationsCount: allLocations.length,
        userLocationCounts,
        locationInteractionCountsKeys: Object.keys(locationInteractionCounts).length,
        userLocationStatusesKeys: Object.keys(userLocationStatuses).length
      };
    } catch (error) {
      results.steps.push("\u274C \u5C0F\u7D05\u66F8\u98A8\u683C\u4F48\u5C40\u6578\u64DA\u7372\u53D6\u5931\u6557");
      results.errors.push(`\u6578\u64DA\u7372\u53D6\u932F\u8AA4: ${error.message}`);
      throw error;
    }
    try {
      const { getXiaohongshuLayoutHtml } = await Promise.resolve().then(() => (init_html2(), html_exports));
      const { LocationService: LocationService2 } = await Promise.resolve().then(() => (init_LocationService(), LocationService_exports));
      const locationService = new LocationService2(env.DB, env.GOOGLE_MAPS_API_KEY);
      const userLocations = await locationService.getUserLocations(3);
      const userCreatedLocations = await locationService.getUserCreatedLocations(3);
      const allLocations = [...userLocations, ...userCreatedLocations];
      const userLocationCounts = await locationService.getUserLocationCounts(3);
      const locationInteractionCounts = {};
      const userLocationStatuses = {};
      for (const location of allLocations) {
        const counts = await locationService.getLocationInteractionCounts(location.id);
        locationInteractionCounts[location.id] = counts;
        const status = await locationService.getUserLocationStatus(3, location.id);
        if (status) {
          userLocationStatuses[location.id] = status;
        }
      }
      const html = getXiaohongshuLayoutHtml(
        results.user,
        allLocations,
        userLocationCounts,
        locationInteractionCounts,
        userLocationStatuses
      );
      results.steps.push("\u2705 \u5C0F\u7D05\u66F8\u98A8\u683C\u4F48\u5C40 HTML \u751F\u6210\u6210\u529F");
      results.htmlLength = html.length;
      results.htmlPreview = html.substring(0, 200) + "...";
    } catch (error) {
      results.steps.push("\u274C \u5C0F\u7D05\u66F8\u98A8\u683C\u4F48\u5C40 HTML \u751F\u6210\u5931\u6557");
      results.errors.push(`HTML \u751F\u6210\u932F\u8AA4: ${error.message}`);
      throw error;
    }
    return new Response(JSON.stringify(results), {
      status: 200,
      headers: {
        "Content-Type": "application/json",
        "Cache-Control": "no-cache"
      }
    });
  } catch (error) {
    console.error("[Debug API] Error testing xiaohongshu layout:", error);
    return new Response(JSON.stringify({
      success: false,
      error: error.message,
      stack: error.stack
    }), {
      status: 500,
      headers: {
        "Content-Type": "application/json",
        "Cache-Control": "no-cache"
      }
    });
  }
}

// src/worker.js
init_auth();
function getCookie2(request, name) {
  const cookieHeader = request.headers.get("cookie");
  if (!cookieHeader)
    return null;
  const cookies = cookieHeader.split(";");
  for (let cookie of cookies) {
    const [cookieName, cookieValue] = cookie.trim().split("=");
    if (cookieName === name) {
      return decodeURIComponent(cookieValue);
    }
  }
  return null;
}
var worker_default = {
  async fetch(request, env, ctx) {
    const url = new URL(request.url);
    const pathname2 = url.pathname;
    console.log(`[Worker] Received request: ${request.method} ${pathname2}`);
    let authService, userService, sessionService, googleAuthService, locationService, locationInvitationService, businessVerificationService;
    try {
      console.log("[Worker INSTANTIATION_ATTEMPT] Attempting to instantiate UserService...");
      userService = new UserService(env.DB);
      console.log("[Worker INSTANTIATION_SUCCESS] UserService instantiated.");
      console.log("[Worker INSTANTIATION_ATTEMPT] Attempting to instantiate SessionService...");
      sessionService = new SessionService(env.DB);
      console.log("[Worker INSTANTIATION_SUCCESS] SessionService instantiated.");
      console.log("[Worker INSTANTIATION_ATTEMPT] Attempting to instantiate GoogleAuthService...");
      googleAuthService = new GoogleAuthService(env);
      console.log("[Worker INSTANTIATION_SUCCESS] GoogleAuthService instantiated.");
      if (!googleAuthService.enabled) {
        console.warn("[Worker] GoogleAuthService is disabled - Google authentication will not work");
      }
      console.log("[Worker INSTANTIATION_ATTEMPT] Attempting to instantiate LocationService. env.DB defined:", !!env.DB, "env.GOOGLE_MAPS_API_KEY defined:", !!env.GOOGLE_MAPS_API_KEY);
      if (!env.GOOGLE_MAPS_API_KEY) {
        console.error("[Worker PRE-INSTANTIATION_ERROR] GOOGLE_MAPS_API_KEY is not defined in env!");
      }
      locationService = new LocationService(env.DB, env.GOOGLE_MAPS_API_KEY);
      console.log("[Worker INSTANTIATION_SUCCESS] LocationService instantiated. locationService defined:", !!locationService, "locationService.db defined:", !!(locationService && locationService.db));
      console.log("[Worker INSTANTIATION_ATTEMPT] Attempting to instantiate LocationInvitationService...");
      locationInvitationService = new LocationInvitationService(env.DB);
      console.log("[Worker INSTANTIATION_SUCCESS] LocationInvitationService instantiated.");
      console.log("[Worker INSTANTIATION_ATTEMPT] Attempting to instantiate BusinessVerificationService...");
      businessVerificationService = new BusinessVerificationService(env.DB);
      console.log("[Worker INSTANTIATION_SUCCESS] BusinessVerificationService instantiated.");
      console.log("[Worker INSTANTIATION_ATTEMPT] Attempting to instantiate AuthService...");
      authService = new AuthService(userService, sessionService, googleAuthService);
      console.log("[Worker INSTANTIATION_SUCCESS] AuthService instantiated. All services ready.");
    } catch (err) {
      console.error("[Worker INSTANTIATION_FAILURE] Failed to instantiate one or more services:", err);
      console.error("[Worker INSTANTIATION_FAILURE] Error name:", err.name);
      console.error("[Worker INSTANTIATION_FAILURE] Error message:", err.message);
      console.error("[Worker INSTANTIATION_FAILURE] Error stack:", err.stack);
      userService = null;
      sessionService = null;
      googleAuthService = null;
      locationService = null;
      locationInvitationService = null;
      authService = null;
      if (err.message && err.message.includes("mapsApiKey")) {
        console.error("[Worker INSTANTIATION_FAILURE_DETAIL] GOOGLE_MAPS_API_KEY secret might be missing or LocationService constructor threw an error related to it.");
      }
      if (err.message && err.message.includes("Database connection (db) is required")) {
        console.error("[Worker INSTANTIATION_FAILURE_DETAIL] Database connection (env.DB) was likely undefined when passed to a service constructor.");
      }
      console.warn("[Worker] Continuing with limited functionality due to service initialization failure");
    }
    let user = null;
    let session = null;
    if (authService) {
      const cookieHeader = request.headers.get("cookie") || "";
      console.log("[Worker] Cookie header:", cookieHeader.substring(0, 200));
      const sessionId = getCookie2(request, "session");
      console.log("[Worker] Extracted sessionId:", sessionId ? sessionId.substring(0, 20) + "..." : "null");
      console.log("[Worker] Pathname:", pathname2, "Method:", request.method);
      if (sessionId) {
        user = await authService.getUserFromSession(sessionId);
        console.log("[Worker] User from session:", user ? { id: user.id, email: user.email, name: user.name, avatar_url: user.avatar_url } : "null");
      } else {
        console.log("[Worker] No sessionId found in cookies");
      }
      if (sessionId && sessionService) {
        try {
          session = await sessionService.getSessionById(sessionId);
        } catch (error) {
          console.warn("[Worker] Could not get session object:", error.message);
        }
      }
    } else {
      console.warn("[Worker] AuthService not available, user will be null");
    }
    env.services = {
      user: userService,
      session: sessionService,
      googleAuth: googleAuthService,
      location: locationService,
      locationInvitation: locationInvitationService,
      auth: authService,
      businessVerification: businessVerificationService
    };
    const nonce = crypto.randomUUID();
    if (pathname2 === "/favicon.ico") {
      const faviconBase64 = "iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAYAAACqaXHeAAAACXBIWXMAAA7EAAAOxAGVKw4bAAASDUlEQVR42s2beUBU5frHP7Owr7KaLOIuggJ6TSIxTcWlbonrRc0lM5fMtKx+VFbeUrr266d5NW2zNNvcxrTccQsFXFOEEASURRbZ93Xm98cZhjnMMDOAdu/z15xz3ved93nOs37f50h42BQe6QMEA0FAf8AHcAMcAUv1qFqgFMgD7gDJwDUgDkVU5sPcnuQhMCwFhgPTgIlAz06ueBs4DOwBLqCIUv53CiA80gV4EViofssPg9KBz4GvUEQV/3cIQGD8TWAxYMtfQ5XAZuDjzgpC0gnG5cBSYI3anv8TVAysBrZ11DQkHWR+ALAD+FtHph9/dz6+nm5YWZgBUFPXwI07uTy1bmdHBREHzEURldLeidIOMP88cKmjzAPYWVng6eKAs501znbWeLo4YGNl0RlNCAauEB45p70T5e1U+U/Vat8punu/lOB+3uJ7BSWdXdYW2EF45BBgpakmITWReUtA8SCYFwRQolcoD4iWA3vUe34AAhAWOgQ83SEnI9F1M3cKSk0Sir65JtJkQGGKEKQmqP0eYEx7/t1MJmPOE0HEfbSEJeMeNYlZfUJZ8VQIF9YtYlZoAHJZu93VeOB7dWLWYR/waXvevEQiYVZoAB9EjMXHvYuQ49Y38tnReNG4pKwCvjpxicraerVTNCc5577OetMfH0hwP28e69+dNRFjeOf7E/x8/gaq9mnCJ8DK9odBwdt/3R6RO9lacWvzq7jY22juNSlVeL3wEbmlFe16fd4uDtz5/A2RGeSVVND/5Q2UVde2VxueQxG1S98DmYE4rwDM2vMvNfWN5JVUEB7s12JjEgl3Ckq4eDsbuVSKv7c7o/x7Mi6oD+MC+zDSvyeDe3rg5eKAVCKhqKIGlUrFgtFDGRfUV7T+gi37uZp+T+9/RwwfxJwngjhx47a+x2H4hu4jOabIuAYIdh/bmTh/bPV8woL6aK4TM/NJuVfI6EG9sLc27JfKqmo5cf02/t3d6e/hqrl/6NKfPBP1nd4500MG8v3KGchlUlZ9e5hPDsboG3YBCG0dHnU1wDd0GbDAFEb9vd0pKKvSuX8++S4vjBmKuVxY3s3BFl9PNyzMjKcdluZyBni5icyooqaOp9buoLy6TtfIh/nxw2szMJMJ/zV6UG/iU7JIy9MpEbyAPJJjLrctAKGw2a9Vp7dJ788Yzc5XpnE1PYfUXLFmlVbVUtfQSFhgH9F9pVLFjTt5HLmawoH4JA7EJ3L0WgpxKVncLShBKpHi6mCjE/5e//aIXtV+Zqgvu1dFYCaXiUwuLLAPu85e0zhZUcboG/olyTG1bUWBN00pbGY8PpB3p49GIoF9b8zm2ajvOH49VRw+fr1ARGgAQ3p5AJCWV0RI5Da9GqNNXR1tif/XUrxdhW3E3cpky7E4nXFPDenHnlUzRcw3k5uDLUvHB/PuTydbP3IBXgfe1s0DhLe/2Bjzvbs68eXSyTS/JEtzOQciZzN6YC/RuEalkoWfKWhsEkyuh5sTclnLZv283Ni5fCo7Xp5Kv24uLSZgJsfLxQGA+sYmFm5VoFSKA9/4wD7sfWMW5ma6zBeWV7Fg8z7e+zm6LRaWER7pqC8RetFYPS+RSPj6pSnYtSpcrMzNOPjWc4z06yG6fy3jHhvUDkkqlTBVKzrIZVKeGzmYOaMGi1R+ashAzfV6xVluZuaL1hwzqDf7/2c2lnr8SUFZJb4vb2D7qSuoVG1mC/bA82IBCNnSQmNvf1ZoACNaMdlM1hbmHHp7LqG+YjDo/d3RGoc0LWSgVvEjZH4qlYrMwpYscFqIPwC3cu6zdu8Z0Vqj/HvyS+RzWJnrj85uDraM8jcJgVvUWgOGG4OxzGQyPogYq7l+78eTvLnzCFVajsbW0pzf3plLiFalV13XwJJtB1ABIf27062LneAoq2sprarhflkV1XUNAPi4OjK0tycqlYpFWxXUNjSK9hDq64O1hZkoOrz2zWHe/eGE5t7aWWHIpEbT5r6ERwa3RAHf0FXAo4ZmzB4RyPzRQwRgLq+YiA0/cS7pDrvO/kEPty709xRitoWZnGkh/pxOSCOnuFwYn19MY2MT6w+c4/rdPK3kJYDiymq+PClEprKaOi6mZJGYmc/3v1/XjAv0eYTSqlpOJaTh5+XGAC939sXe5O/rdnLsj1QupmYzZ2QQDjaWONtZk5iZT2JWgTEhlJMcc7xZAJuBLoZGf74kHE9nwTm9ufMol25nC5uuruXn8ze4kpZDSF9vHG2tsDCTMzXEn+gbadwrEVLg3/+8Q1q+ODZPGNyXosoa9ly42QIB5xURk3y3JW719SJ6zQJ8PV3ZF5fIyeu3qaypY9lXhyivqdM43MamJiYO6QeAu4Mt356+akwAXUiO2SJV4/YGDadvNxeG9fUCoKSyhl3n/tAZ8+vlZPxWbOR0QhoAjjZWHFk9DwdrC4PAyN2CUoO1xeF35mFvbcnMEYHMHTmYkqpaPtx3RmfsjtNXqVALJHSAD91djUbz/oRHdpOq4SSDNOnRASK7mxzsh42Fuc44CzM5gT26aa43HjpPWavsbfIwP8KHDdCUwM2l8ZRhfkwcLM79iytr2Hw4VnP98dwJ2OuBzmwtzZk0zE8jAIlEwrNDfU2C0qQIJzYGacyglhjv7erIrhXTydseyY6XpzJmUC9kUiFsLZsQTBdbKwAupWbzkeJsi3DkMn5YMYN9b86il7uTBhdoxgH6erjw2zvz+GJJOHItJ/bPPae4npELgKuDDYvV+IJMKiUsoDffLZ9G7va32PnKNLo52WvmjQ7obYoAguQIx1UGY/+jfbx0pW5lwZxRQhzPLirjh3PXiQgdpHn+zg/HadJKYL5ZNpWIEQE6JlDXytMvHDsUpVLJ4s9/Eey7ScnqH09w8C0B71wUNgxXe1tmjggQMazzavXsWZ8ZSI2FPy9nexxsDJcGns4OvBE+Ai8XR02U0M7dJw/z02FeMIESvVjgonHDRFr325VbZBeVAdCzqxOrJoUaZB7AzdEWNwcbo7CDHOGgsk0qrKhmzHtf4+Fkj4ezPd2c7DW/PZzscXe004Grjly9hXYitmpSaJtrt0Wrng3l5A3BoSpVKo5dS2HBmKHidLtJSX5pBTnF5eQUlZNTXM49rd/NPsFQ6SE3VvxU1zUQrfbsejE1qRQ3Bxu1QBzwcLLXhMhmTx7c1yR1FGd9A3thaSbXJEPbo69wLT1XYLa4jJyicgrKqmhUduqs1FFuSulriBqVSu6VVHCvpIJL5Og87+7i2CF011wuw8vZgdQ8odS+cCuTC7ce+Em5pZSHTA1Num+oOVKIY761zj1Ve+DPDpIcoTmhw1pgYSanWxe7Ft/gZE9cSiaxKVkAZBQU09DUpEFsAOY9OYRNv8WSX1YJgIeTPXNGiqNxbUMjWYVlmuvhvt0Z2stTbQKCneeWlFPX2NQZ/mvlCJ0ZXfWFP2dbKx2n5+GkdoRqm3e2t0baSsW3Ho3TCKCqroHTCekidKibkz3XPnmZb09fQSaRMPfJIbg5iivxk9dvi5ibN2oIC8aIYUqlSkVReZXICeYUl3NP/ftsUoam0GqDSuUIbSkiAXy1JJxZTwRiaW7WIbFOGNwPiUSiqcn/pTirA4894mRH5JSReuerVCrWayVRMqmECa0Q4mb4y9XBFlcHW1EG2kzu89caE0CeFKEnR4zMVte2i/mM/BI+3HNKc8Dp49aF8VoMn0pIZ/NvsSavt+FgDL//2VIQ/f1v/enmLMT9tNwi1u09o/d0SQSOlFYahd+AO3KEhqRWSE6u0U2WVtWw98JNvjt7jd//vItKpaKmvpG1s8IA+HDmWI5fv02TOkyt+OZXkMCyiY+1uaZKpWLDwRhe33lUC4eQinCIrcfi+eRgDKt/PMGIAT4890QQU0L8cWgFt8epTdAIJcvwDXVGaGjSUGVtHa88/XibFdyLW/fz4tYDKOKTRJlcQmYeC8cOxdrCjEec7FEqlZxNzFAzB0euphCTlIG7oy3ero4a4KKuoZGj11JY+Nl+vjx5WeT7184cy+THBJQov7SSeZv2UN/YhAq4c7+Ug5f+5NNfL5BwNw8rczN6uHdBJpWy5UgcF1OzjQlgoxyhu0JE6fklpOUV0aurMwBX03II6uWBBHC0tuS3K7d00JrmzOxq+j3GqguRpROC2XDovKZuB4hOSCc6IV0DfqpUKrIKy/R6cydbK14Ma8FpEu7moVTpO5Fq4OfzCfx8PgE3BxsihgdwID7JFA2Ik5EcU4Zv6GzASZQhmMm5mJrNoq0K1u07S1hAb7xcHLE0l5NdWMblNHHSMyXYj1/fmktQT8EZFVdUM/b97dwtLG0zgSqurKG4skZUNLU+ajuVkMb0xwdiaW5Gz65OzHoikIz8Ym7dK9Q7p6qugfjULJHQ26AkFFHrmxGh3sAw8elOJqcS0jX5el1DI5OD/dWQtjtbj8XTpFTR092JXSum8/a0UZpjr5LKGsLWbBf5kjUzRmNrZcHt3KI20xuZVKjjp4cM5GyS4JvvlVRw5mYG0x8fiIWZHEcbS/4RGsCQnt2IvZVJafsPSjUYCskxJyRqVHg48LthUFRK8r9fpWdXQVHe+f44EomEt6aOFKG0ZVW1hK3ZzkWtemBCUF8Or54HQHZhGUevpfBHRq4mEerqKISx8UF98XC2R6WCMe9/xamEdM0aIf28OfrufBEkX11Xzwe7T/N/h2Kob39CNAxF1EWJFiyeagwaixg+iB9e/Uebzytq6ghbs13kgW0tzUnY+Ao+bl3atbvbuUUMWrmJmvoGESp8ePU8bC3FaFRSVgFLv/hF43BN8f4oonxbUOHkGBW+oZbAWEOzErPyGTGgBz3cdZmprKlj4gff6hQsH80ex4TB/TSmYWUkv2ge42RnjUwqJfpGSyWaWVhKbPJdpj8+UHQk5upgw9xRgymtqiU+1aTwt5bkmLjWJ0NfIXRgGojT8MJn+ylvZXdVtfU8vXanCM0FGNrLg+VPhwBCo4TfKxvxW76RF7bs50Bcombc3gsJLNi8D9+XNxD46r81GeRrzw4n0OcR0ZpnEjN4Zt13Is1oPpDdr7WmoRQG2K57NCa0nG42Njs9v5gFW/ZrNlld18Az63ZyNilDx2d8sXSyJtbHJGWQW1JBUnYBX0df5oyWukbfSGP7qSsk59wns7BUY0JmMhlfLAnXOeiITkhj0ke7qK1v1NQEczftIauozBQBbEIRVa7vbBDgY4T2U4O0N/Ym7/54ktr6RiZFfcepm+k6Y159ZjiBPVre3u4LCWKcQAu27t7KP+zRGju0jyfL9WSPx/9IZcr6XdQ1NPLGjiMcupxsCvMFCD1D6BeAoAWrTVnpw72nCXp1k95z+95dnXlvxmjNdZNSqaOe2ky3xvD3xt5EqYWp/XPmWHz04PyHr6YQsHJTWx0h+uht7bevTwMAtunLDvW6Uj3JiEQCny+eJHJ25xLvkFda2aYGtGYuq7CMOC1namtpzmeLntW7h7YSIj10Ttv22xaA0EMz15hDbIvmjRzMk4N6tanS+pjuridEah+XNZfYM0MDOpr0lAPz9bXP6ofEhK7rl9r7L8621vzvvImie01KJfvjxepvZ2mOk10LZN3V0U6nf6i1GQBseP4pnarPRFqEIipd34O2MUFF1E5gU3v+pbiymsXbDpCqpZbnEjPIb6X+3q6OaINIUqkEb/XBazNlF5URm9xiBsnZ91m87UBHegTXo4j6yRAmaIhWAp4IHZdGSQXsib2JIj6JKY/58dKEYHaf16f+uirf3c1RgwBrIsf5GzQ0NbHlSByK+MQ2iyYDtBuINHjyZXSJlk7x8Q8KiV06fhhbXhQ7tRe27Ofr6Ms6m+sELnwQmIYiqt7QIOOwuCKqFghHaJ97INRdjwb4uDnq1agO0m5TmDdNAC1CmAZsfBAC0BfT9Qmlg7QeiDCFeVN8QOvwuJLwyCvAVjrxhZi+sGdCQ4MpoW6RIYfXcQ0QC2IXMASh97ZDVFxRTXpeMbnF5eQWl5OeV0xJZU1nmD8HBLWXedOcYNvOUYrQW/gBQgfmf4IKELo+t/+1n82JBeGI0H66DKEJ8a+gUnWO8knr3P6vF4BYEM8jNCH2fUiMJyN8Oru9s4w/eAGIhRFMy8fT/Tu5WhLNH08roi4+6K1KHrqyhkd2Q/z5vDfCWaSpn8/nPczt/T/LvAR5fDfiUAAAAABJRU5ErkJggg==";
      const faviconBuffer = Uint8Array.from(atob(faviconBase64), (c) => c.charCodeAt(0));
      return new Response(faviconBuffer, {
        headers: {
          "Content-Type": "image/x-icon",
          "Cache-Control": "public, max-age=31536000"
        }
      });
    }
    try {
      if (request.method === "GET" && (pathname2 === "/" || pathname2 === "/index.html")) {
        console.log("[Worker] Serving homepage via routePageRequest (with Time Machine UI).");
        try {
          return await routePageRequest(request, env, session, user, nonce, tailwind_output_default);
        } catch (error) {
          console.error("[Worker] Error in routePageRequest for homepage:", error);
          return new Response("Homepage Error: " + error.message, {
            status: 500,
            headers: { "Content-Type": "text/plain" }
          });
        }
      }
      if (request.method === "GET" && pathname2 === "/api/auth/google") {
        console.log("[Worker] Handling /api/auth/google route");
        try {
          return initiateGoogleAuth(url, env);
        } catch (error) {
          console.error("[Worker] Error in initiateGoogleAuth:", error);
          return new Response(`Google Auth Error: ${error.message}`, { status: 500 });
        }
      }
      if (request.method === "GET" && pathname2 === "/api/auth/google/request-gmb-scope") {
        console.log("[Worker] Handling request for GMB scope...");
        if (!user) {
          console.log("[Worker] User not logged in. Redirecting to login for GMB scope request.");
          return Response.redirect(url.origin + "/api/auth/google", 302);
        }
        return initiateGmbAuth(url, env, user.id);
      }
      if (request.method === "GET" && pathname2 === "/api/auth/google/callback") {
        console.log("[Worker] Handling Google callback...");
        console.log(`[Worker] Callback URL: ${url.toString()}`);
        try {
          const response = await handleGoogleCallback(request, env);
          if (response.status === 302) {
            const location = response.headers.get("Location");
            const setCookieHeader = response.headers.get("Set-Cookie");
            console.log("[Worker] Callback response - Location:", location);
            console.log("[Worker] Callback response - Set-Cookie present:", !!setCookieHeader);
            if (setCookieHeader) {
              console.log("[Worker] Set-Cookie value:", setCookieHeader.substring(0, 100));
            }
            const newHeaders = new Headers();
            response.headers.forEach((value, key) => {
              newHeaders.append(key, value);
            });
            newHeaders.set("Location", "/");
            console.log("[Worker] Redirecting to homepage with preserved headers. Set-Cookie present:", newHeaders.has("Set-Cookie"));
            return new Response(null, { status: 302, headers: newHeaders });
          }
          return response;
        } catch (error) {
          console.error("[Worker] Google callback error:", error);
          const headers = new Headers();
          headers.append("Location", "/?error=google_auth_failed");
          return new Response(null, { status: 302, headers });
        }
      }
      if (pathname2.startsWith("/api/admin/knowledge")) {
        return await handleAdminKnowledgeRequest(request, env, user);
      }
      if (request.method === "GET" && (pathname2 === "/admin/knowledge" || pathname2 === "/admin/knowledge/")) {
        const nonce2 = crypto.randomUUID();
        const html = await renderAdminKnowledgePage(request, env, session, user, nonce2, tailwind_output_default);
        return new Response(html, {
          headers: {
            "Content-Type": "text/html;charset=UTF-8",
            "Content-Security-Policy": `default-src 'self'; script-src 'self' 'nonce-${nonce2}' https://static.cloudflareinsights.com; style-src 'self' 'nonce-${nonce2}'; img-src 'self' data: https:; connect-src 'self' https://maps.googleapis.com; frame-src 'self' https://www.google.com;`
          }
        });
      }
      if (request.method === "POST" && pathname2 === "/api/auth/logout") {
        console.log("[Worker] Handling logout...");
        const currentSessionId = getCookie2(request, "session");
        if (currentSessionId) {
          try {
            if (!authService) {
              console.error("[Worker] AuthService not available for logout");
              return new Response("Authentication service unavailable", { status: 500 });
            }
            await authService.logout(currentSessionId);
            console.log("[Worker] Logout successful for session:", currentSessionId);
          } catch (error) {
            console.error("[Worker] Logout error:", error);
          }
        }
        const cookieValue = `session=; HttpOnly; Path=/; SameSite=Lax; Max-Age=0`;
        const headers = new Headers();
        headers.append("Set-Cookie", cookieValue);
        headers.append("Location", "/");
        return new Response(null, { status: 302, headers });
      }
      if (request.method === "GET" && pathname2 === "/google-info") {
        console.log("[Worker] Serving Google Info page.");
        const html = getGoogleInfoPageHtml(user, tailwind_output_default);
        return new Response(html, { headers: { "Content-Type": "text/html;charset=UTF-8" } });
      }
      if (request.method === "GET" && pathname2 === "/profile") {
        console.log("[Worker] Profile route matched, pathname:", pathname2, "method:", request.method);
        console.log("[Worker] Profile route matched, checking user authentication...");
        console.log("[Worker] User object:", user ? "exists" : "null");
        if (!user) {
          console.log("[Worker] User not logged in, redirecting from /profile to /");
          return Response.redirect(url.origin + "/", 302);
        }
        console.log("[Worker] User authenticated, serving profile page for:", user.email);
        let userLocations = [];
        let userCreatedLocations = [];
        let allLocations = [];
        let userLocationCounts = null;
        let locationInteractionCounts = {};
        let userLocationStatuses = {};
        try {
          if (!locationService) {
            console.error("[Worker /profile] LocationService not available");
            return new Response("Location service unavailable", { status: 500 });
          }
          console.log("[Worker /profile] Getting user locations...");
          userLocations = await locationService.getUserLocations(user.id);
          console.log("[Worker /profile] Found", userLocations.length, "user locations");
          userCreatedLocations = await locationService.getUserCreatedLocations(user.id);
          console.log("[Worker /profile] Found", userCreatedLocations.length, "user created locations");
          allLocations = [...userLocations, ...userCreatedLocations];
          console.log("[Worker /profile] Total locations:", allLocations.length);
          if (allLocations.length > 0) {
            const locationIds = allLocations.map((loc) => loc.id);
            const [batchCounts, batchStatuses] = await Promise.all([
              locationService.getBatchLocationInteractionCounts(locationIds),
              locationService.getBatchUserLocationStatuses(user.id, locationIds)
            ]);
            locationInteractionCounts = batchCounts;
            userLocationStatuses = batchStatuses;
            console.log("[Worker /profile] Batch loaded interaction counts and user statuses");
          }
          userLocationCounts = await locationService.getUserLocationCounts(user.id);
          console.log("[Worker /profile] User location counts:", userLocationCounts);
        } catch (error) {
          console.error("[Worker /profile] Error fetching user data:", error);
          userLocations = [];
          userCreatedLocations = [];
          allLocations = [];
          userLocationCounts = { visited: 0, want_to_visit: 0, want_to_revisit: 0, created: 0, owner: 0 };
          locationInteractionCounts = {};
          userLocationStatuses = {};
        }
        console.log("[Worker /profile] Generating HTML...");
        const html = getProfilePageHtml(user, tailwind_output_default, allLocations, userLocationCounts, locationInteractionCounts, userLocationStatuses);
        console.log("[Worker /profile] HTML generated, length:", html.length);
        return new Response(html, { headers: { "Content-Type": "text/html;charset=UTF-8" } });
      }
      if (request.method === "GET" && pathname2 === "/api/maps/config") {
        console.log("[Worker] Providing Maps API config");
        const apiKey = env.GOOGLE_MAPS_API_KEY;
        if (!apiKey) {
          console.error("[Worker] GOOGLE_MAPS_API_KEY is not configured in environment secrets.");
          return new Response(JSON.stringify({ error: "Maps configuration unavailable." }), { status: 500, headers: { "Content-Type": "application/json" } });
        }
        return new Response(JSON.stringify({ apiKey }), {
          status: 200,
          headers: { "Content-Type": "application/json" }
        });
      }
      if (request.method === "POST" && pathname2 === "/api/locations/reverse-geocode") {
        console.log("[Worker] Handling POST /api/locations/reverse-geocode");
        let requestBody;
        let lat, lng;
        try {
          requestBody = await request.json();
          lat = requestBody.lat;
          lng = requestBody.lng;
          if (lat == null || lng == null || typeof lat !== "number" || typeof lng !== "number") {
            throw new Error("Missing or invalid latitude/longitude.");
          }
        } catch (e) {
          console.error("[Worker] Invalid JSON or missing coordinates in reverse-geocode request:", e);
          return new Response(JSON.stringify({ error: "Invalid request body: latitude and longitude required." }), { status: 400, headers: { "Content-Type": "application/json" } });
        }
        try {
          const result = await locationService.reverseGeocodeCoordinates(lat, lng);
          if (result.error) {
            const statusCode = result.error === "ZERO_RESULTS" ? 404 : 500;
            console.warn(`[Worker] Reverse geocode failed: ${result.error}`);
            return new Response(JSON.stringify({ error: `Reverse geocoding failed: ${result.error}` }), { status: statusCode, headers: { "Content-Type": "application/json" } });
          } else {
            console.log(`[Worker] Reverse geocode successful for ${lat}, ${lng}.`);
            return new Response(JSON.stringify(result), { status: 200, headers: { "Content-Type": "application/json" } });
          }
        } catch (serviceError) {
          console.error("[Worker] Error calling LocationService.reverseGeocodeCoordinates:", serviceError);
          console.error("[Worker] Full serviceError object:", JSON.stringify(serviceError, Object.getOwnPropertyNames(serviceError)));
          return new Response(JSON.stringify({ error: "Internal server error during reverse geocoding." }), { status: 500, headers: { "Content-Type": "application/json" } });
        }
      }
      if (request.method === "GET" && pathname2.startsWith("/api/locations/google-details/")) {
        console.log("[Worker] Handling GET /api/locations/google-details/:placeId");
        const placeId = pathname2.split("/").pop();
        if (!placeId) {
          console.error("[Worker] Missing placeId in google-details request path.");
          return new Response(JSON.stringify({ error: "Missing Place ID in request path." }), { status: 400, headers: { "Content-Type": "application/json" } });
        }
        try {
          const locationDetails = await locationService.fetchPlaceDetails(placeId);
          if (!locationDetails) {
            console.warn(`[Worker] No details found or error fetching details for placeId: ${placeId}`);
            return new Response(JSON.stringify({ error: "Place details not found or unable to fetch." }), { status: 404, headers: { "Content-Type": "application/json" } });
          }
          console.log(`[Worker] Successfully fetched Google details for placeId: ${placeId}`);
          return new Response(JSON.stringify(locationDetails), { status: 200, headers: { "Content-Type": "application/json" } });
        } catch (error) {
          console.error(`[Worker] Error calling LocationService.fetchPlaceDetails for placeId ${placeId}:`, error);
          return new Response(JSON.stringify({ error: "Internal server error fetching place details." }), { status: 500, headers: { "Content-Type": "application/json" } });
        }
      }
      if (request.method === "GET" && pathname2.startsWith("/api/locations/details-by-placeid/")) {
        console.log("[Worker] Handling GET /api/locations/details-by-placeid/:placeId");
        const placeId = pathname2.split("/").pop();
        if (!placeId) {
          console.error("[Worker] Missing placeId in details-by-placeid request path.");
          return new Response(JSON.stringify({ error: "Missing Place ID in request path." }), { status: 400, headers: { "Content-Type": "application/json" } });
        }
        try {
          const locationDetails = await locationService.fetchPlaceDetails(placeId);
          if (!locationDetails) {
            console.warn(`[Worker] No details found or error fetching details for placeId: ${placeId}`);
            return new Response(JSON.stringify({ error: "Place details not found or unable to fetch." }), { status: 404, headers: { "Content-Type": "application/json" } });
          }
          console.log(`[Worker] Successfully fetched details (incl. photos) for placeId: ${placeId}`);
          return new Response(JSON.stringify(locationDetails), { status: 200, headers: { "Content-Type": "application/json" } });
        } catch (error) {
          console.error(`[Worker] Error calling LocationService.fetchPlaceDetails for placeId ${placeId} (details-by-placeid route):`, error);
          return new Response(JSON.stringify({ error: "Internal server error fetching place details." }), { status: 500, headers: { "Content-Type": "application/json" } });
        }
      }
      if (request.method === "GET" && pathname2 === "/api/locations/existing") {
        console.log("[Worker] Handling GET /api/locations/existing");
        try {
          const stmt = locationService.db.prepare(`
                SELECT id, name, address, latitude, longitude, google_place_id, 
                       google_types, phone_number, website, google_rating, 
                       google_user_ratings_total, business_status, thumbnail_url, 
                       editorial_summary
                FROM locations 
                WHERE latitude IS NOT NULL AND longitude IS NOT NULL
                ORDER BY created_at DESC 
                LIMIT 100
            `);
          const result = await stmt.all();
          console.log(`[Worker] Found ${result.results.length} existing locations`);
          return new Response(JSON.stringify(result.results), {
            status: 200,
            headers: { "Content-Type": "application/json" }
          });
        } catch (error) {
          console.error("[Worker] Error fetching existing locations:", error);
          return new Response(JSON.stringify({ error: "Internal server error fetching existing locations." }), {
            status: 500,
            headers: { "Content-Type": "application/json" }
          });
        }
      }
      if (request.method === "POST" && pathname2 === "/api/locations/import/google-place") {
        console.log("[Worker] Handling POST /api/locations/import/google-place");
        if (!user || !user.id) {
          console.log("[Worker] Unauthorized attempt to import location.");
          return new Response(JSON.stringify({ error: "Unauthorized" }), { status: 401, headers: { "Content-Type": "application/json" } });
        }
        const userId = user.id;
        let requestBody;
        try {
          requestBody = await request.json();
        } catch (e) {
          console.error("[Worker] Invalid JSON in request body:", e);
          return new Response(JSON.stringify({ error: "Invalid request body" }), { status: 400, headers: { "Content-Type": "application/json" } });
        }
        const { googlePlaceId, coordinate } = requestBody;
        let location = null;
        let sourceDescription = "";
        try {
          if (googlePlaceId && typeof googlePlaceId === "string") {
            sourceDescription = `Google Place ID: ${googlePlaceId}`;
            console.log(`[Worker] Processing import for ${sourceDescription}`);
            location = await locationService.findLocationByPlaceId(googlePlaceId);
            if (!location) {
              console.log(`[Worker] Location ${googlePlaceId} not found locally. Fetching from Google...`);
              const locationDetails = await locationService.fetchPlaceDetails(googlePlaceId);
              if (!locationDetails) {
                console.error(`[Worker] Failed to fetch details for ${googlePlaceId} from Google.`);
                return new Response(JSON.stringify({ error: "Failed to fetch location details from Google." }), { status: 502, headers: { "Content-Type": "application/json" } });
              }
              locationDetails.createdByUser = userId;
              console.log(`[Worker] Creating new local location record for ${googlePlaceId}`);
              try {
                location = await locationService.createLocation(locationDetails);
              } catch (createError) {
                if (createError.message.includes("already exists")) {
                  console.warn(`[Worker] Race condition? Location ${googlePlaceId} was created between check and insert. Fetching existing.`);
                  location = await locationService.findLocationByPlaceId(googlePlaceId);
                  if (!location) {
                    console.error(`[Worker] CRITICAL: Failed to find location ${googlePlaceId} after creation race condition.`);
                    throw new Error("Failed to resolve location after creation conflict.");
                  }
                } else {
                  throw createError;
                }
              }
            } else {
              console.log(`[Worker] Location ${googlePlaceId} found locally (ID: ${location.id}).`);
            }
          } else if (coordinate && typeof coordinate === "object" && coordinate.lat != null && coordinate.lng != null) {
            sourceDescription = `Coordinates: ${coordinate.lat}, ${coordinate.lng}`;
            console.log(`[Worker] Processing import for ${sourceDescription}`);
            const coordinateData = {
              latitude: coordinate.lat,
              longitude: coordinate.lng,
              createdByUser: userId
            };
            location = await locationService.createCoordinateLocation(coordinateData);
          } else {
            console.log("[Worker] Invalid request body. Requires googlePlaceId (string) or coordinate ({lat, lng}). Body:", requestBody);
            return new Response(JSON.stringify({ error: "Invalid request body. Requires googlePlaceId or coordinate." }), { status: 400, headers: { "Content-Type": "application/json" } });
          }
          if (!location || !location.id) {
            console.error("[Worker] Failed to obtain valid location object after processing.", { googlePlaceId, coordinate });
            throw new Error("Failed to obtain location information.");
          }
          let userLocationLink = null;
          const isLinked = await locationService.checkUserLocationLink(userId, location.id);
          if (!isLinked) {
            console.log(`[Worker] Linking user ${userId} to location ${location.id} (${location.name})`);
            try {
              userLocationLink = await locationService.linkUserToLocation(userId, location.id, {});
            } catch (linkError) {
              if (linkError.message.includes("already associated")) {
                console.warn(`[Worker] User ${userId} already linked to location ${location.id} (detected during link attempt).`);
              } else {
                throw linkError;
              }
            }
          } else {
            console.log(`[Worker] User ${userId} is already linked to location ${location.id}.`);
          }
          console.log(`[Worker] Successfully processed import for ${sourceDescription} by user ${userId}.`);
          return new Response(JSON.stringify({
            message: `\u5730\u9EDE '${location.name}' \u5DF2${isLinked ? "\u5728" : "\u52A0\u5165"}\u60A8\u7684\u5217\u8868\uFF01`,
            // Indicate if it was added or already there
            locationId: location.id,
            userLocationLinkId: userLocationLink ? userLocationLink.id : null
            // Return link ID if newly created
          }), { status: 200, headers: { "Content-Type": "application/json" } });
        } catch (error) {
          console.error(`[Worker] Error processing location import for ${sourceDescription}:`, error);
          const errorMessage = error.message || "Failed to process location import.";
          let statusCode = 500;
          if (errorMessage.includes("already exists") || errorMessage.includes("already associated")) {
          }
          return new Response(JSON.stringify({ error: errorMessage }), { status: statusCode, headers: { "Content-Type": "application/json" } });
        }
      }
      if (request.method === "GET" && pathname2 === "/add-place") {
        if (!user) {
          console.log("[Worker] User not logged in, redirecting from /add-place to /");
          return Response.redirect(url.origin + "/", 302);
        }
        console.log("[Worker] Serving Add Place page for:", user.email);
        const html = getAddPlacePageHtml(user, tailwind_output_default);
        return new Response(html, { headers: { "Content-Type": "text/html;charset=UTF-8" } });
      }
      if (request.method === "GET" && pathname2 === "/admin/manage-invitations") {
        const authCheck = requireAdmin(user, request);
        if (authCheck) {
          console.log("[Worker] Non-admin attempt to access /admin/manage-invitations. Redirecting.");
          return authCheck;
        }
        console.log("[Worker] Serving Admin Manage Invitations page for:", user.email);
        let initialLocations = [];
        try {
          initialLocations = await locationService.getLocationsForAdminInvitation(user.id);
        } catch (error) {
          console.error("[Worker /admin/manage-invitations] Error fetching initial locations:", error);
        }
        const html = getAdminInvitationsPageHtml(user, tailwind_output_default, initialLocations);
        return new Response(html, { headers: { "Content-Type": "text/html;charset=UTF-8" } });
      }
      if (request.method === "GET" && pathname2 === "/claim-location") {
        console.log("[Worker /claim-location] Received request.");
        const token = url.searchParams.get("token");
        if (!token) {
          console.log("[Worker /claim-location] Token missing.");
          return new Response(getClaimLocationPageHtml(user, tailwind_output_default, { error: "missing_token", message: "\u7121\u6548\u7684\u8A8D\u9818\u9023\u7D50\uFF0C\u7F3A\u5C11\u6B0A\u6756\u3002" }), { status: 400, headers: { "Content-Type": "text/html;charset=UTF-8" } });
        }
        try {
          console.log(`[Worker /claim-location] Verifying token: ${token}`);
          const verificationResult = await locationInvitationService.verifyInvitationToken(token);
          console.log("[Worker /claim-location] Verification result:", verificationResult);
          if (!verificationResult.isValid) {
            let pageData2 = { error: verificationResult.error || "invalid_token", message: verificationResult.message || "\u8A8D\u9818\u6B0A\u6756\u7121\u6548\u6216\u5DF2\u904E\u671F\u3002" };
            if (verificationResult.error === "expired") {
              pageData2.message = "\u6B64\u8A8D\u9818\u9023\u7D50\u5DF2\u904E\u671F\u3002\u8ACB\u806F\u7E6B\u7BA1\u7406\u54E1\u4EE5\u7372\u53D6\u65B0\u7684\u9023\u7D50\u3002";
            } else if (verificationResult.error === "already_used") {
              pageData2.message = "\u6B64\u8A8D\u9818\u9023\u7D50\u5DF2\u88AB\u4F7F\u7528\u6216\u5DF2\u5931\u6548\u3002\u5982\u679C\u60A8\u8A8D\u70BA\u9019\u662F\u932F\u8AA4\uFF0C\u8ACB\u806F\u7E6B\u7BA1\u7406\u54E1\u3002";
            }
            return new Response(getClaimLocationPageHtml(user, tailwind_output_default, pageData2), { status: 400, headers: { "Content-Type": "text/html;charset=UTF-8" } });
          }
          const invitation = verificationResult.invitation;
          console.log(`[Worker /claim-location] Token valid for invitation:`, invitation);
          if (!user) {
            console.log("[Worker /claim-location] User not logged in. Redirecting to login.");
            const redirectUrl = new URL(url.origin + "/api/auth/google");
            redirectUrl.searchParams.set("redirectUrl", `/claim-location?token=${token}`);
            return Response.redirect(redirectUrl.toString(), 302);
          }
          console.log(`[Worker /claim-location] User ${user.email} is logged in. Comparing with invitation merchant_email: ${invitation.merchant_email}`);
          if (user.email.toLowerCase() !== invitation.merchant_email.toLowerCase()) {
            console.log("[Worker /claim-location] Email mismatch.");
            const pageData2 = {
              error: "email_mismatch",
              message: `\u6B64\u8A8D\u9818\u9023\u7D50\u662F\u8A2D\u8A08\u7D66 ${invitation.merchant_email} \u7684\u3002\u60A8\u76EE\u524D\u767B\u5165\u7684\u5E33\u865F\u662F ${user.email}\u3002\u8ACB\u767B\u51FA\u4E26\u4F7F\u7528\u6B63\u78BA\u7684 Google \u5E33\u865F\u767B\u5165\u5F8C\u518D\u8A66\u4E00\u6B21\u3002`
            };
            return new Response(getClaimLocationPageHtml(user, tailwind_output_default, pageData2), { status: 403, headers: { "Content-Type": "text/html;charset=UTF-8" } });
          }
          console.log(`[Worker /claim-location] Email matches. Proceeding to claim location ID: ${invitation.location_id} for user ID: ${user.id}`);
          let locationName = "\u8A72\u5730\u9EDE";
          try {
            const locationDetails = await locationService.findLocationByInternalId(invitation.location_id);
            if (locationDetails) {
              locationName = locationDetails.name;
            }
          } catch (locError) {
            console.error(`[Worker /claim-location] Error fetching location name for ${invitation.location_id}:`, locError);
          }
          const claimResult = await locationService.claimLocation(invitation.location_id, user.id, user.email);
          console.log("[Worker /claim-location] Location claim result:", claimResult);
          if (!claimResult.success) {
            const pageData2 = {
              error: claimResult.error || "claim_failed",
              message: claimResult.message || "\u8A8D\u9818\u5730\u9EDE\u6642\u767C\u751F\u932F\u8AA4\u3002\u8ACB\u7A0D\u5F8C\u518D\u8A66\u6216\u806F\u7E6B\u7BA1\u7406\u54E1\u3002"
            };
            return new Response(getClaimLocationPageHtml(user, tailwind_output_default, pageData2), { status: 500, headers: { "Content-Type": "text/html;charset=UTF-8" } });
          }
          console.log(`[Worker /claim-location] Marking invitation ID: ${invitation.id} as claimed by user ID: ${user.id}`);
          const markClaimedResult = await locationInvitationService.markInvitationAsClaimed(invitation.id, user.id);
          console.log("[Worker /claim-location] Mark invitation claimed result:", markClaimedResult);
          if (!markClaimedResult.success) {
            console.error(`[Worker /claim-location] CRITICAL: Location ${invitation.location_id} claimed by ${user.id}, BUT FAILED to mark invitation ${invitation.id} as claimed. Error: ${markClaimedResult.error}`);
            const pageData2 = {
              success_with_warning: true,
              locationName,
              message: `\u5730\u9EDE ${locationName} \u5DF2\u6210\u529F\u7531\u60A8\u8A8D\u9818\uFF01\u7136\u800C\uFF0C\u66F4\u65B0\u9080\u8ACB\u72C0\u614B\u6642\u9047\u5230\u554F\u984C\uFF0C\u8ACB\u901A\u77E5\u7BA1\u7406\u54E1\u6B64\u60C5\u6CC1\u3002`
            };
            return new Response(getClaimLocationPageHtml(user, tailwind_output_default, pageData2), { status: 200, headers: { "Content-Type": "text/html;charset=UTF-8" } });
          }
          console.log(`[Worker /claim-location] Location ${invitation.location_id} successfully claimed by ${user.email} and invitation ${invitation.id} marked as claimed.`);
          const pageData = {
            success: true,
            locationName,
            message: `\u606D\u559C\uFF01\u5730\u9EDE ${locationName} \u5DF2\u6210\u529F\u7531\u60A8\u8A8D\u9818\u3002\u60A8\u53EF\u4EE5\u524D\u5F80\u60A8\u7684\u500B\u4EBA\u8CC7\u6599\u9801\u9762\u67E5\u770B\u3002`
          };
          return new Response(getClaimLocationPageHtml(user, tailwind_output_default, pageData), { status: 200, headers: { "Content-Type": "text/html;charset=UTF-8" } });
        } catch (error) {
          console.error("[Worker /claim-location] General error during claim process:", error);
          const pageData = {
            error: "server_error",
            message: "\u8655\u7406\u60A8\u7684\u8A8D\u9818\u8ACB\u6C42\u6642\u767C\u751F\u672A\u9810\u671F\u7684\u932F\u8AA4\u3002\u8ACB\u7A0D\u5F8C\u518D\u8A66\u6216\u806F\u7E6B\u7BA1\u7406\u54E1\u3002"
          };
          return new Response(getClaimLocationPageHtml(user, tailwind_output_default, pageData), { status: 500, headers: { "Content-Type": "text/html;charset=UTF-8" } });
        }
      }
      if (request.method === "POST" && pathname2 === "/api/locations/nearby-search") {
        console.log("[Worker] Handling POST /api/locations/nearby-search");
        let requestBody;
        let lat, lng;
        try {
          requestBody = await request.json();
          lat = requestBody.lat;
          lng = requestBody.lng;
          if (lat == null || lng == null || typeof lat !== "number" || typeof lng !== "number") {
            throw new Error("Missing or invalid latitude/longitude.");
          }
        } catch (e) {
          console.error("[Worker] Invalid JSON or missing coordinates in nearby-search request:", e);
          return new Response(JSON.stringify({ error: "Invalid request body: latitude and longitude required." }), { status: 400, headers: { "Content-Type": "application/json" } });
        }
        try {
          const result = await locationService.findNearbyPlace(lat, lng);
          if (result) {
            console.log(`[Worker] Nearby search successful for ${lat}, ${lng}. Found: ${result.name}`);
            return new Response(JSON.stringify(result), { status: 200, headers: { "Content-Type": "application/json" } });
          } else {
            console.log(`[Worker] Nearby search for ${lat}, ${lng} did not find a suitable place or failed to get details.`);
            return new Response(JSON.stringify({ error: "No nearby place found or details unavailable." }), { status: 404, headers: { "Content-Type": "application/json" } });
          }
        } catch (serviceError) {
          console.error("[Worker] Error calling LocationService.findNearbyPlace:", serviceError);
          console.error("[Worker] Full serviceError object (nearby):", JSON.stringify(serviceError, Object.getOwnPropertyNames(serviceError)));
          return new Response(JSON.stringify({ error: "Internal server error during nearby search." }), { status: 500, headers: { "Content-Type": "application/json" } });
        }
      }
      if (request.method === "GET" && pathname2 === "/api/user/locations") {
        console.log("[Worker] Handling GET /api/user/locations");
        if (!user || !user.id) {
          console.log("[Worker] Unauthorized attempt to access user locations.");
          return new Response(JSON.stringify({ error: "Unauthorized" }), { status: 401, headers: { "Content-Type": "application/json" } });
        }
        const userId = user.id;
        try {
          const locations = await locationService.getUserLocations(userId);
          console.log(`[Worker] Returning ${locations.length} locations for user ${userId}.`);
          return new Response(JSON.stringify(locations), { status: 200, headers: { "Content-Type": "application/json" } });
        } catch (error) {
          console.error(`[Worker] Error fetching locations for user ${userId} via API:`, error);
          return new Response(JSON.stringify({ error: "Failed to fetch user locations." }), { status: 500, headers: { "Content-Type": "application/json" } });
        }
      }
      if (request.method === "POST" && pathname2 === "/api/location/status") {
        console.log("[Worker] Handling POST /api/location/status");
        if (!user || !user.id) {
          console.log("[Worker] Unauthorized attempt to update location status.");
          return new Response(JSON.stringify({ error: "Unauthorized" }), { status: 401, headers: { "Content-Type": "application/json" } });
        }
        try {
          const body = await request.json();
          const { locationId, status } = body;
          if (!locationId || !status) {
            return new Response(JSON.stringify({
              success: false,
              error: "Missing locationId or status"
            }), {
              status: 400,
              headers: { "Content-Type": "application/json" }
            });
          }
          const validStatuses = ["visited", "want_to_visit", "want_to_revisit", "created"];
          if (!validStatuses.includes(status)) {
            return new Response(JSON.stringify({
              success: false,
              error: "Invalid status value"
            }), {
              status: 400,
              headers: { "Content-Type": "application/json" }
            });
          }
          const location = await locationService.getLocationById(locationId);
          if (!location) {
            return new Response(JSON.stringify({
              success: false,
              error: "Location not found"
            }), {
              status: 404,
              headers: { "Content-Type": "application/json" }
            });
          }
          await locationService.updateUserLocationStatus(user.id, locationId, status);
          return new Response(JSON.stringify({
            success: true,
            message: "Location status updated successfully"
          }), {
            status: 200,
            headers: { "Content-Type": "application/json" }
          });
        } catch (error) {
          console.error("[Worker] Error updating location status:", error);
          return new Response(JSON.stringify({
            success: false,
            error: "Failed to update location status"
          }), {
            status: 500,
            headers: { "Content-Type": "application/json" }
          });
        }
      }
      if (request.method === "GET" && pathname2 === "/api/user/location-counts") {
        console.log("[Worker] Handling GET /api/user/location-counts");
        if (!user || !user.id) {
          console.log("[Worker] Unauthorized attempt to get location counts.");
          return new Response(JSON.stringify({ error: "Unauthorized" }), { status: 401, headers: { "Content-Type": "application/json" } });
        }
        try {
          const counts = await locationService.getUserLocationCounts(user.id);
          return new Response(JSON.stringify(counts), {
            status: 200,
            headers: { "Content-Type": "application/json" }
          });
        } catch (error) {
          console.error("[Worker] Error getting user location counts:", error);
          return new Response(JSON.stringify({
            error: "Failed to get user location counts"
          }), {
            status: 500,
            headers: { "Content-Type": "application/json" }
          });
        }
      }
      if (request.method === "GET" && pathname2 === "/api/location/global-counts") {
        console.log("[Worker] Handling GET /api/location/global-counts");
        try {
          const counts = await locationService.getGlobalLocationCounts();
          return new Response(JSON.stringify(counts), {
            status: 200,
            headers: { "Content-Type": "application/json" }
          });
        } catch (error) {
          console.error("[Worker] Error getting global location counts:", error);
          return new Response(JSON.stringify({
            error: "Failed to get global location counts"
          }), {
            status: 500,
            headers: { "Content-Type": "application/json" }
          });
        }
      }
      if (request.method === "GET" && pathname2.match(/^\/api\/location\/[^\/]+\/interaction-counts$/)) {
        console.log("[Worker] Handling GET /api/location/:locationId/interaction-counts");
        const locationId = pathname2.split("/")[3];
        if (!locationId) {
          console.error("[Worker] Missing locationId in interaction-counts request path.");
          return new Response(JSON.stringify({ error: "Missing Location ID in request path." }), { status: 400, headers: { "Content-Type": "application/json" } });
        }
        try {
          const counts = await locationService.getLocationInteractionCounts(locationId);
          return new Response(JSON.stringify(counts), {
            status: 200,
            headers: { "Content-Type": "application/json" }
          });
        } catch (error) {
          console.error("[Worker] Error getting location interaction counts:", error);
          return new Response(JSON.stringify({
            error: "Failed to get location interaction counts"
          }), {
            status: 500,
            headers: { "Content-Type": "application/json" }
          });
        }
      }
      if (request.method === "POST" && pathname2 === "/api/admin/locations/generate-claim-link") {
        console.log("[Worker] Handling POST /api/admin/locations/generate-claim-link");
        const authCheck = requireAdminAPI(user);
        if (authCheck) {
          console.log("[Worker] Non-admin attempt to access /api/admin/locations/generate-claim-link");
          return authCheck;
        }
        const adminUserId = user.id;
        try {
          const body = await request.json();
          const { location_id, merchant_email } = body;
          if (!location_id || !merchant_email) {
            return new Response(JSON.stringify({ error: "Missing required fields: location_id and merchant_email." }), { status: 400, headers: { "Content-Type": "application/json" } });
          }
          if (typeof merchant_email !== "string" || !merchant_email.includes("@")) {
            return new Response(JSON.stringify({ error: "Invalid merchant_email format." }), { status: 400, headers: { "Content-Type": "application/json" } });
          }
          const location = await locationService.findLocationByInternalId(location_id);
          if (!location) {
            return new Response(JSON.stringify({ error: `Location with ID ${location_id} not found.` }), { status: 404, headers: { "Content-Type": "application/json" } });
          }
          if (location.claimed_by_user_id) {
            return new Response(JSON.stringify({ error: `Location '${location.name || location_id}' is already claimed.` }), { status: 409, headers: { "Content-Type": "application/json" } });
          }
          const result = await locationInvitationService.generateClaimLink(location_id, merchant_email, adminUserId);
          if (result.error) {
            return new Response(JSON.stringify({ error: result.error }), { status: result.status || 500, headers: { "Content-Type": "application/json" } });
          }
          return new Response(JSON.stringify(result), { status: 201, headers: { "Content-Type": "application/json" } });
        } catch (error) {
          console.error("Error in /api/admin/locations/generate-claim-link:", error);
          if (error instanceof SyntaxError) {
            return new Response(JSON.stringify({ error: "Invalid JSON request body." }), { status: 400, headers: { "Content-Type": "application/json" } });
          }
          return new Response(JSON.stringify({ error: "An unexpected server error occurred." }), { status: 500, headers: { "Content-Type": "application/json" } });
        }
      }
      if (request.method === "GET" && pathname2 === "/api/admin/locations-for-invitation") {
        console.log("[Worker] Handling GET /api/admin/locations-for-invitation");
        const authCheck = requireAdminAPI(user);
        if (authCheck) {
          console.log("[Worker] Non-admin attempt to access /api/admin/locations-for-invitation");
          return authCheck;
        }
        try {
          const locations = await locationService.getLocationsForAdminInvitation(user.id);
          return new Response(JSON.stringify(locations), { status: 200, headers: { "Content-Type": "application/json" } });
        } catch (error) {
          console.error("Error in /api/admin/locations-for-invitation:", error);
          return new Response(JSON.stringify({ error: "Failed to fetch locations for invitation." }), { status: 500, headers: { "Content-Type": "application/json" } });
        }
      }
      if (request.method === "GET" && pathname2.startsWith("/admin/")) {
        const authCheck = requireAdmin(user, request);
        if (authCheck) {
          console.log("[Worker] Non-admin attempt to access admin page. Redirecting.");
          return authCheck;
        }
        console.log("[Worker] Serving admin page via routePageRequest:", pathname2);
        try {
          return await routePageRequest(request, env, session, user, nonce, tailwind_output_default);
        } catch (error) {
          console.error("[Worker] Error in routePageRequest for admin page:", error);
          return new Response("Admin Page Error: " + error.message, {
            status: 500,
            headers: { "Content-Type": "text/plain" }
          });
        }
      }
      if (request.method === "GET" && pathname2 === "/admin/dashboard") {
        const authCheck = requireAdmin(user, request);
        if (authCheck) {
          console.log("[Worker] Non-admin attempt to access /admin/dashboard. Redirecting.");
          return authCheck;
        }
        console.log("[Worker] Serving Admin Dashboard page for:", user.email);
        const html = `
          <!DOCTYPE html>
          <html lang="zh-TW">
          <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>\u7BA1\u7406\u54E1\u5100\u8868\u677F - HOPE PENGHU</title>
            <style>
              body { 
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
                margin: 0; 
                padding: 20px; 
                background: #f5f5f5; 
              }
              .container { 
                max-width: 1200px; 
                margin: 0 auto; 
              }
              .header { 
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
                color: white; 
                padding: 30px; 
                border-radius: 12px; 
                margin-bottom: 30px; 
                box-shadow: 0 4px 6px rgba(0,0,0,0.1); 
              }
              .header h1 { margin: 0 0 10px 0; font-size: 2.5em; }
              .header p { margin: 0; opacity: 0.9; }
              .grid { 
                display: grid; 
                grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); 
                gap: 20px; 
                margin-bottom: 30px; 
              }
              .card { 
                background: white; 
                padding: 25px; 
                border-radius: 12px; 
                box-shadow: 0 2px 10px rgba(0,0,0,0.1); 
                transition: transform 0.2s; 
              }
              .card:hover { transform: translateY(-2px); }
              .card h3 { 
                margin: 0 0 15px 0; 
                color: #333; 
                border-bottom: 2px solid #667eea; 
                padding-bottom: 10px; 
              }
              .status { 
                padding: 15px; 
                margin: 10px 0; 
                border-radius: 8px; 
                font-weight: 500; 
              }
              .success { background: #d4edda; color: #155724; border-left: 4px solid #28a745; }
              .warning { background: #fff3cd; color: #856404; border-left: 4px solid #ffc107; }
              .info { background: #d1ecf1; color: #0c5460; border-left: 4px solid #17a2b8; }
              .danger { background: #f8d7da; color: #721c24; border-left: 4px solid #dc3545; }
              .btn { 
                display: inline-block; 
                padding: 10px 20px; 
                margin: 5px; 
                border: none; 
                border-radius: 6px; 
                cursor: pointer; 
                text-decoration: none; 
                font-weight: 500; 
                transition: all 0.2s; 
              }
              .btn-primary { background: #667eea; color: white; }
              .btn-primary:hover { background: #5a6fd8; }
              .btn-success { background: #28a745; color: white; }
              .btn-success:hover { background: #218838; }
              .btn-warning { background: #ffc107; color: #212529; }
              .btn-warning:hover { background: #e0a800; }
              .btn-danger { background: #dc3545; color: white; }
              .btn-danger:hover { background: #c82333; }
              .stats { 
                display: grid; 
                grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); 
                gap: 15px; 
                margin: 15px 0; 
              }
              .stat { 
                text-align: center; 
                padding: 15px; 
                background: #f8f9fa; 
                border-radius: 8px; 
              }
              .stat-value { 
                font-size: 1.5em; 
                font-weight: bold; 
                color: #667eea; 
              }
              .stat-label { 
                font-size: 0.9em; 
                color: #666; 
                margin-top: 5px; 
              }
              .loading { 
                text-align: center; 
                padding: 20px; 
                color: #666; 
              }
              .log { 
                background: #f8f9fa; 
                padding: 15px; 
                border-radius: 8px; 
                font-family: monospace; 
                font-size: 0.9em; 
                max-height: 200px; 
                overflow-y: auto; 
                margin-top: 15px; 
              }
            </style>
          </head>
          <body>
            <div class="container">
              <div class="header">
                <h1>\u{1F680} \u7BA1\u7406\u54E1\u5100\u8868\u677F</h1>
                <p>\u6B61\u8FCE\u56DE\u4F86\uFF0C${user.name || user.email}\uFF01\u7CFB\u7D71\u76E3\u63A7\u8207\u7BA1\u7406\u4E2D\u5FC3</p>
              </div>
              
              <div class="grid">
                <!-- \u7CFB\u7D71\u72C0\u614B\u5361\u7247 -->
                <div class="card">
                  <h3>\u{1F4CA} \u7CFB\u7D71\u72C0\u614B</h3>
                  <div id="system-status" class="loading">\u8F09\u5165\u4E2D...</div>
                  <div class="stats" id="system-stats"></div>
                  <button class="btn btn-primary" onclick="refreshSystemStatus()">\u5237\u65B0\u72C0\u614B</button>
                </div>
                
                <!-- \u5099\u4EFD\u7BA1\u7406\u5361\u7247 -->
                <div class="card">
                  <h3>\u{1F4BE} \u5099\u4EFD\u7BA1\u7406</h3>
                  <div id="backup-status" class="loading">\u8F09\u5165\u4E2D...</div>
                  <div class="stats" id="backup-stats"></div>
                  <button class="btn btn-success" onclick="createBackup()">\u5275\u5EFA\u5099\u4EFD</button>
                  <button class="btn btn-primary" onclick="checkBackupHealth()">\u5065\u5EB7\u6AA2\u67E5</button>
                </div>
                
                <!-- API \u4F7F\u7528\u91CF\u5361\u7247 -->
                <div class="card">
                  <h3>\u{1F4C8} API \u4F7F\u7528\u91CF</h3>
                  <div id="api-status" class="loading">\u8F09\u5165\u4E2D...</div>
                  <div class="stats" id="api-stats"></div>
                  <button class="btn btn-primary" onclick="refreshApiStats()">\u5237\u65B0\u7D71\u8A08</button>
                </div>
                
                <!-- \u5B89\u5168\u5BE9\u8A08\u5361\u7247 -->
                <div class="card">
                  <h3>\u{1F512} \u5B89\u5168\u5BE9\u8A08</h3>
                  <div id="security-status" class="loading">\u8F09\u5165\u4E2D...</div>
                  <div class="stats" id="security-stats"></div>
                  <button class="btn btn-warning" onclick="runSecurityAudit()">\u57F7\u884C\u5BE9\u8A08</button>
                  <button class="btn btn-primary" onclick="getSecurityStatus()">\u67E5\u770B\u72C0\u614B</button>
                </div>
              </div>
              
              <!-- \u5FEB\u901F\u64CD\u4F5C\u5340\u57DF -->
              <div class="card">
                <h3>\u26A1 \u5FEB\u901F\u64CD\u4F5C</h3>
                <div style="display: flex; flex-wrap: wrap; gap: 10px;">
                  <a href="/admin/manage-invitations" class="btn btn-primary">\u7BA1\u7406\u9080\u8ACB</a>
                  <a href="/api/admin/system/status" class="btn btn-info" target="_blank">\u7CFB\u7D71\u72C0\u614B API</a>
                  <a href="/api/admin/backup/health" class="btn btn-info" target="_blank">\u5099\u4EFD\u5065\u5EB7\u6AA2\u67E5</a>
                  <a href="/api/admin/rate-limit/stats" class="btn btn-info" target="_blank">\u901F\u7387\u9650\u5236\u7D71\u8A08</a>
                  <button class="btn btn-warning" onclick="cleanupRateLimitLogs()">\u6E05\u7406\u65E5\u8A8C</button>
                </div>
              </div>
              
              <!-- \u7CFB\u7D71\u65E5\u8A8C\u5340\u57DF -->
              <div class="card">
                <h3>\u{1F4DD} \u7CFB\u7D71\u65E5\u8A8C</h3>
                <div id="system-log" class="log">\u7CFB\u7D71\u65E5\u8A8C\u5C07\u5728\u9019\u88E1\u986F\u793A...</div>
                <button class="btn btn-primary" onclick="clearLog()">\u6E05\u9664\u65E5\u8A8C</button>
              </div>
            </div>

            <script>
              let logMessages = [];
              
              function addLog(message, type = 'info') {
                const timestamp = new Date().toLocaleString();
                const logEntry = \`[\${timestamp}] \${type.toUpperCase()}: \${message}\`;
                logMessages.unshift(logEntry);
                if (logMessages.length > 50) logMessages.pop();
                
                const logElement = document.getElementById('system-log');
                logElement.textContent = logMessages.join('\\n');
              }
              
              async function apiCall(endpoint, method = 'GET', body = null) {
                try {
                  const options = {
                    method,
                    headers: { 'Content-Type': 'application/json' }
                  };
                  
                  if (body) {
                    options.body = JSON.stringify(body);
                  }
                  
                  const response = await fetch(endpoint, options);
                  const data = await response.json();
                  
                  if (!response.ok) {
                    throw new Error(data.error || 'API \u8ABF\u7528\u5931\u6557');
                  }
                  
                  return data;
                } catch (error) {
                  addLog(\`API \u932F\u8AA4: \${error.message}\`, 'error');
                  throw error;
                }
              }
              
              async function refreshSystemStatus() {
                try {
                  addLog('\u5237\u65B0\u7CFB\u7D71\u72C0\u614B...', 'info');
                  const data = await apiCall('/api/admin/system/status');
                  
                  // \u66F4\u65B0\u7CFB\u7D71\u72C0\u614B
                  const statusElement = document.getElementById('system-status');
                  const statusClass = data.overallHealth.status === 'healthy' ? 'success' : 
                                    data.overallHealth.status === 'warning' ? 'warning' : 'danger';
                  statusElement.className = \`status \${statusClass}\`;
                  statusElement.innerHTML = \`
                    <strong>\u6574\u9AD4\u5065\u5EB7\u5EA6\uFF1A</strong>\${data.overallHealth.score}/100 (\${data.overallHealth.status})
                  \`;
                  
                  // \u66F4\u65B0\u7D71\u8A08
                  const statsElement = document.getElementById('system-stats');
                  statsElement.innerHTML = \`
                    <div class="stat">
                      <div class="stat-value">\${data.database.tableCount}</div>
                      <div class="stat-label">\u8CC7\u6599\u8868</div>
                    </div>
                    <div class="stat">
                      <div class="stat-value">\${data.database.status}</div>
                      <div class="stat-label">\u8CC7\u6599\u5EAB</div>
                    </div>
                    <div class="stat">
                      <div class="stat-value">\${data.security.overallScore}</div>
                      <div class="stat-label">\u5B89\u5168\u5206\u6578</div>
                    </div>
                  \`;
                  
                  addLog('\u7CFB\u7D71\u72C0\u614B\u5DF2\u66F4\u65B0', 'success');
                } catch (error) {
                  addLog(\`\u7CFB\u7D71\u72C0\u614B\u5237\u65B0\u5931\u6557: \${error.message}\`, 'error');
                }
              }
              
              async function createBackup() {
                try {
                  addLog('\u958B\u59CB\u5275\u5EFA\u5099\u4EFD...', 'info');
                  const result = await apiCall('/api/admin/backup/create', 'POST');
                  addLog(\`\u5099\u4EFD\u5275\u5EFA\u6210\u529F: \${result.backupKey}\`, 'success');
                  await checkBackupHealth();
                } catch (error) {
                  addLog(\`\u5099\u4EFD\u5275\u5EFA\u5931\u6557: \${error.message}\`, 'error');
                }
              }
              
              async function checkBackupHealth() {
                try {
                  addLog('\u6AA2\u67E5\u5099\u4EFD\u5065\u5EB7\u72C0\u614B...', 'info');
                  const data = await apiCall('/api/admin/backup/health');
                  
                  const statusElement = document.getElementById('backup-status');
                  const statusClass = data.healthy ? 'success' : 'warning';
                  statusElement.className = \`status \${statusClass}\`;
                  statusElement.innerHTML = \`
                    <strong>\u5099\u4EFD\u72C0\u614B\uFF1A</strong>\${data.healthy ? '\u6B63\u5E38' : '\u9700\u8981\u95DC\u6CE8'}
                    \${data.lastBackup ? \`<br>\u6700\u5F8C\u5099\u4EFD\uFF1A\${new Date(data.lastBackup).toLocaleString()}\` : '<br>\u5C1A\u672A\u57F7\u884C\u5099\u4EFD'}
                  \`;
                  
                  const statsElement = document.getElementById('backup-stats');
                  statsElement.innerHTML = \`
                    <div class="stat">
                      <div class="stat-value">\${data.weeklyStats.total}</div>
                      <div class="stat-label">\u7E3D\u5099\u4EFD</div>
                    </div>
                    <div class="stat">
                      <div class="stat-value">\${data.weeklyStats.successful}</div>
                      <div class="stat-label">\u6210\u529F</div>
                    </div>
                    <div class="stat">
                      <div class="stat-value">\${data.weeklyStats.failed}</div>
                      <div class="stat-label">\u5931\u6557</div>
                    </div>
                  \`;
                  
                  addLog(\`\u5099\u4EFD\u5065\u5EB7\u72C0\u614B: \${data.healthy ? '\u6B63\u5E38' : '\u7570\u5E38'}\`, data.healthy ? 'success' : 'warning');
                } catch (error) {
                  addLog(\`\u5099\u4EFD\u5065\u5EB7\u6AA2\u67E5\u5931\u6557: \${error.message}\`, 'error');
                }
              }
              
              async function refreshApiStats() {
                try {
                  addLog('\u5237\u65B0 API \u7D71\u8A08...', 'info');
                  const data = await apiCall('/api/admin/rate-limit/stats');
                  
                  const statusElement = document.getElementById('api-status');
                  statusElement.className = 'status info';
                  statusElement.innerHTML = \`
                    <strong>API \u4F7F\u7528\u91CF\u7D71\u8A08</strong><br>
                    \u671F\u9593\uFF1A\${data.period}
                  \`;
                  
                  const statsElement = document.getElementById('api-stats');
                  statsElement.innerHTML = \`
                    <div class="stat">
                      <div class="stat-value">\${data.totalRequests}</div>
                      <div class="stat-label">\u7E3D\u8ACB\u6C42</div>
                    </div>
                    <div class="stat">
                      <div class="stat-value">\${data.uniqueClients}</div>
                      <div class="stat-label">\u552F\u4E00\u5BA2\u6236</div>
                    </div>
                  \`;
                  
                  addLog(\`API \u7D71\u8A08: \${data.totalRequests} \u500B\u8ACB\u6C42\`, 'info');
                } catch (error) {
                  addLog(\`API \u7D71\u8A08\u5237\u65B0\u5931\u6557: \${error.message}\`, 'error');
                }
              }
              
              async function runSecurityAudit() {
                try {
                  addLog('\u57F7\u884C\u5B89\u5168\u5BE9\u8A08...', 'info');
                  const result = await apiCall('/api/admin/security/audit', 'POST');
                  addLog(\`\u5B89\u5168\u5BE9\u8A08\u5B8C\u6210: \u5206\u6578 \${result.overallScore}/100\`, 'success');
                  await refreshSystemStatus();
                } catch (error) {
                  addLog(\`\u5B89\u5168\u5BE9\u8A08\u5931\u6557: \${error.message}\`, 'error');
                }
              }
              
              async function getSecurityStatus() {
                try {
                  addLog('\u7372\u53D6\u5B89\u5168\u72C0\u614B...', 'info');
                  const result = await apiCall('/api/admin/security/status');
                  
                  const statusElement = document.getElementById('security-status');
                  const statusClass = result.overallScore >= 80 ? 'success' : 
                                    result.overallScore >= 60 ? 'warning' : 'danger';
                  statusElement.className = \`status \${statusClass}\`;
                  statusElement.innerHTML = \`
                    <strong>\u5B89\u5168\u5206\u6578\uFF1A</strong>\${result.overallScore}/100
                    <br>\u95DC\u9375\u554F\u984C\uFF1A\${result.criticalIssuesCount} \u500B
                    <br>\u8B66\u544A\uFF1A\${result.warningsCount} \u500B
                  \`;
                  
                  const statsElement = document.getElementById('security-stats');
                  statsElement.innerHTML = \`
                    <div class="stat">
                      <div class="stat-value">\${result.overallScore}</div>
                      <div class="stat-label">\u5B89\u5168\u5206\u6578</div>
                    </div>
                    <div class="stat">
                      <div class="stat-value">\${result.criticalIssuesCount}</div>
                      <div class="stat-label">\u95DC\u9375\u554F\u984C</div>
                    </div>
                    <div class="stat">
                      <div class="stat-value">\${result.warningsCount}</div>
                      <div class="stat-label">\u8B66\u544A</div>
                    </div>
                  \`;
                  
                  addLog(\`\u5B89\u5168\u72C0\u614B: \${result.status}\`, 'info');
                } catch (error) {
                  addLog(\`\u5B89\u5168\u72C0\u614B\u6AA2\u67E5\u5931\u6557: \${error.message}\`, 'error');
                }
              }
              
              async function cleanupRateLimitLogs() {
                try {
                  addLog('\u6E05\u7406\u901F\u7387\u9650\u5236\u65E5\u8A8C...', 'info');
                  const result = await apiCall('/api/admin/rate-limit/cleanup', 'POST');
                  addLog(\`\u6E05\u7406\u5B8C\u6210: \u522A\u9664 \${result.deletedCount} \u689D\u8A18\u9304\`, 'success');
                } catch (error) {
                  addLog(\`\u6E05\u7406\u5931\u6557: \${error.message}\`, 'error');
                }
              }
              
              function clearLog() {
                logMessages = [];
                document.getElementById('system-log').textContent = '\u65E5\u8A8C\u5DF2\u6E05\u9664';
              }
              
              // \u9801\u9762\u8F09\u5165\u6642\u521D\u59CB\u5316
              document.addEventListener('DOMContentLoaded', function() {
                addLog('\u7BA1\u7406\u54E1\u5100\u8868\u677F\u5DF2\u8F09\u5165', 'info');
                refreshSystemStatus();
                checkBackupHealth();
                refreshApiStats();
                getSecurityStatus();
              });
              
              // \u5B9A\u671F\u5237\u65B0\u72C0\u614B
              setInterval(() => {
                refreshSystemStatus();
              }, 60000); // \u6BCF\u5206\u9418\u5237\u65B0\u4E00\u6B21
            </script>
          </body>
          </html>
        `;
        return new Response(html, { headers: { "Content-Type": "text/html;charset=UTF-8" } });
      }
      if (pathname2.startsWith("/api/debug/")) {
        console.log("[Worker] Handling debug API request:", pathname2);
        return await handleDebugRequest(request, env);
      }
      if (pathname2.startsWith("/api/image/")) {
        console.log("[Worker] Handling image API request:", pathname2);
        const { handleImageRequest: handleImageRequest2 } = await Promise.resolve().then(() => (init_image(), image_exports));
        return await handleImageRequest2(request, env);
      }
      if (pathname2.startsWith("/api/admin/")) {
        console.log("[Worker] Handling admin API request:", pathname2);
        const { handleAdminRequest: handleAdminRequest2 } = await Promise.resolve().then(() => (init_admin(), admin_exports));
        return await handleAdminRequest2(request, env, user);
      }
      if (request.method === "GET" && pathname2 === "/test/business-verification") {
        console.log("[Worker] Serving Business Verification Test Page.");
        return showBusinessVerificationPage(request, env, ctx);
      }
      if (request.method === "POST" && pathname2 === "/test/business-verification/admin-initiate") {
        console.log("[Worker] Handling Business Verification Admin Initiate.");
        return handleAdminInitiate(request, env, ctx);
      }
      if (request.method === "POST" && pathname2 === "/test/business-verification/user-request") {
        console.log("[Worker] Handling Business Verification User Request.");
        return handleUserRequestVerification(request, env, ctx);
      }
      if (pathname2.startsWith("/api/ai/")) {
        console.log("[Worker] Handling AI API request (Specific Route):", pathname2);
        try {
          const { handleAIRequest: handleAIRequest2 } = await Promise.resolve().then(() => (init_ai(), ai_exports));
          console.log("[Worker] Passing locationService to AI API. locationService defined:", !!locationService);
          const aiEnv = {
            ...env,
            locationService,
            OPENAI_API_KEY: env.OPENAI_API_KEY,
            GEMINI_API_KEY: env.GEMINI_API_KEY
          };
          return await handleAIRequest2(request, aiEnv, user, ctx);
        } catch (error) {
          console.error("[Worker] Error handling AI API request:", error);
          return new Response(JSON.stringify({
            error: "Internal server error",
            message: error.message
          }), {
            status: 500,
            headers: { "Content-Type": "application/json" }
          });
        }
      }
      if (request.method === "GET" && pathname2 === "/game") {
        console.log("[Worker] Handling Game Page Request.");
        try {
          return await routePageRequest(request, env, session, user, nonce, tailwind_output_default);
        } catch (error) {
          console.error("[Worker] Error in routePageRequest:", error);
          return new Response("Game Page Error: " + error.message, {
            status: 500,
            headers: { "Content-Type": "text/plain" }
          });
        }
      }
      if (pathname2 === "/sw.js") {
        console.log("[Worker] Serving Service Worker");
        const swContent = `// Service Worker for HOPENGHU.CC
// Version: 1.0.0
const CACHE_NAME = 'hopenghu-v1';
const RUNTIME_CACHE = 'hopenghu-runtime-v1';

// \u5B89\u88DD Service Worker
self.addEventListener('install', (event) => {
  console.log('[Service Worker] Installing...');
  event.waitUntil(
    caches.open(CACHE_NAME)
      .then(() => {
        console.log('[Service Worker] Precaching complete');
        return self.skipWaiting(); // \u7ACB\u5373\u6FC0\u6D3B\u65B0\u7684 Service Worker
      })
      .catch((error) => {
        console.error('[Service Worker] Install failed:', error);
      })
  );
});

// \u6FC0\u6D3B Service Worker
self.addEventListener('activate', (event) => {
  console.log('[Service Worker] Activating...');
  event.waitUntil(
    caches.keys().then((cacheNames) => {
      return Promise.all(
        cacheNames.map((cacheName) => {
          // \u522A\u9664\u820A\u7684\u7DE9\u5B58
          if (cacheName !== CACHE_NAME && cacheName !== RUNTIME_CACHE) {
            console.log('[Service Worker] Deleting old cache:', cacheName);
            return caches.delete(cacheName);
          }
        })
      );
    })
    .then(() => {
      return self.clients.claim(); // \u7ACB\u5373\u63A7\u5236\u6240\u6709\u9801\u9762
    })
  );
});

// \u6514\u622A\u8ACB\u6C42
self.addEventListener('fetch', (event) => {
  const { request } = event;
  const url = new URL(request.url);

  // \u8DF3\u904E\u975E GET \u8ACB\u6C42
  if (request.method !== 'GET') {
    return;
  }

  // \u8DF3\u904E API \u8ACB\u6C42\uFF08\u9700\u8981\u5BE6\u6642\u6578\u64DA\uFF09
  if (url.pathname.startsWith('/api/')) {
    return;
  }

  // \u5141\u8A31\u7DE9\u5B58\u7684\u5916\u90E8\u8CC7\u6E90\uFF08Google Fonts\uFF09
  const allowedExternalOrigins = [
    'https://fonts.googleapis.com',
    'https://fonts.gstatic.com'
  ];
  
  const isAllowedExternal = allowedExternalOrigins.some(origin => url.origin === origin);
  
  // \u8DF3\u904E\u5176\u4ED6\u5916\u90E8\u8CC7\u6E90
  if (url.origin !== self.location.origin && !isAllowedExternal) {
    return;
  }

  event.respondWith(
    caches.match(request)
      .then((cachedResponse) => {
        // \u5982\u679C\u6709\u7DE9\u5B58\uFF0C\u8FD4\u56DE\u7DE9\u5B58
        if (cachedResponse) {
          console.log('[Service Worker] Serving from cache:', url.pathname);
          return cachedResponse;
        }

        // \u5426\u5247\u5F9E\u7DB2\u7D61\u7372\u53D6
        console.log('[Service Worker] Fetching from network:', url.pathname);
        return fetch(request)
          .then((response) => {
            // \u53EA\u7DE9\u5B58\u6210\u529F\u7684\u97FF\u61C9
            if (!response || response.status !== 200 || response.type !== 'basic') {
              return response;
            }

            // \u514B\u9686\u97FF\u61C9\uFF08\u56E0\u70BA\u97FF\u61C9\u53EA\u80FD\u4F7F\u7528\u4E00\u6B21\uFF09
            const responseToCache = response.clone();

            // \u5C07\u97FF\u61C9\u6DFB\u52A0\u5230\u7DE9\u5B58
            caches.open(RUNTIME_CACHE)
              .then((cache) => {
                cache.put(request, responseToCache);
              });

            return response;
          })
          .catch((error) => {
            // \u975C\u9ED8\u8655\u7406\u7DB2\u7D61\u932F\u8AA4\uFF08\u96E2\u7DDA\u6642\u6B63\u5E38\uFF09
            console.log('[Service Worker] Fetch failed (likely offline):', url.pathname);
            // \u5982\u679C\u662F\u9801\u9762\u8ACB\u6C42\u4E14\u5931\u6557\uFF0C\u8FD4\u56DE\u9996\u9801\u7DE9\u5B58
            if (request.headers.get('accept') && request.headers.get('accept').includes('text/html')) {
              const cachedHome = caches.match('/');
              if (cachedHome) {
                return cachedHome;
              }
            }
            // \u5C0D\u65BC\u5176\u4ED6\u8ACB\u6C42\uFF0C\u8FD4\u56DE\u7A7A\u97FF\u61C9\u800C\u4E0D\u662F\u62CB\u51FA\u932F\u8AA4
            return new Response('', { 
              status: 503, 
              statusText: 'Service Unavailable',
              headers: { 'Content-Type': 'text/plain' }
            });
          });
      })
  );
});`;
        return new Response(swContent, {
          headers: {
            "Content-Type": "application/javascript",
            "Cache-Control": "no-cache",
            "Service-Worker-Allowed": "/"
          }
        });
      }
      if (pathname2.startsWith("/ai-smart-itinerary-planner/")) {
        console.log("[Worker] Serving itinerary planner static file:", pathname2);
        try {
          const { getItineraryAsset: getItineraryAsset2 } = await Promise.resolve().then(() => (init_itinerary_assets(), itinerary_assets_exports));
          const relativePath = pathname2.replace("/ai-smart-itinerary-planner/", "");
          const content = getItineraryAsset2(relativePath);
          if (!content) {
            console.warn(`[Worker] Asset not found: ${relativePath}`);
            return new Response("File not found", {
              status: 404,
              headers: { "Content-Type": "text/plain" }
            });
          }
          let contentType = "text/plain";
          if (relativePath.endsWith(".js")) {
            contentType = "application/javascript";
          } else if (relativePath.endsWith(".css")) {
            contentType = "text/css";
          } else if (relativePath.endsWith(".html")) {
            contentType = "text/html";
          }
          return new Response(content, {
            headers: {
              "Content-Type": contentType,
              "Cache-Control": "public, max-age=31536000, immutable",
              "Access-Control-Allow-Origin": "*"
            }
          });
        } catch (error) {
          console.error("[Worker] Error serving itinerary asset:", error);
          return new Response("Internal server error", {
            status: 500,
            headers: { "Content-Type": "text/plain" }
          });
        }
      }
      if (pathname2.startsWith("/api/")) {
        console.log("[Worker] Handling API Request.");
        return await handleApiRequest(request, env, session, user, ctx);
      }
      if (request.method === "GET" && pathname2.startsWith("/api/locations/") && pathname2.endsWith("/details")) {
        console.log("[Worker] Handling GET /api/locations/:id/details");
        const locationId = pathname2.split("/")[3];
        if (!locationId) {
          console.error("[Worker] Missing location ID in details request path.");
          return new Response(JSON.stringify({ error: "Missing Location ID in request path." }), { status: 400, headers: { "Content-Type": "application/json" } });
        }
        try {
          const locationDetails = await locationService.getLocationById(locationId);
          if (!locationDetails) {
            console.warn(`[Worker] No details found for locationId: ${locationId}`);
            return new Response(JSON.stringify({ error: "Location details not found." }), { status: 404, headers: { "Content-Type": "application/json" } });
          }
          let userStatus = null;
          let interactionCounts = { visited: 0, want_to_visit: 0, want_to_revisit: 0 };
          if (user) {
            try {
              userStatus = await locationService.getUserLocationStatus(user.id, locationId);
              interactionCounts = await locationService.getLocationInteractionCounts(locationId);
            } catch (error) {
              console.error(`[Worker] Error fetching user status for locationId ${locationId}:`, error);
            }
          }
          const responseData = {
            ...locationDetails,
            userStatus,
            interactionCounts
          };
          console.log(`[Worker] Successfully fetched details for locationId: ${locationId}`, {
            hasUser: !!user,
            userStatus,
            interactionCounts
          });
          return new Response(JSON.stringify(responseData), { status: 200, headers: { "Content-Type": "application/json" } });
        } catch (error) {
          console.error(`[Worker] Error calling LocationService.getLocationById for locationId ${locationId}:`, error);
          return new Response(JSON.stringify({ error: "Internal server error fetching location details." }), { status: 500, headers: { "Content-Type": "application/json" } });
        }
      }
      if (request.method === "GET" && !pathname2.startsWith("/api/")) {
        console.log(`[Worker] Trying routePageRequest as fallback for: ${pathname2}`);
        try {
          return await routePageRequest(request, env, session, user, nonce, tailwind_output_default);
        } catch (error) {
          console.error("[Worker] Error in routePageRequest fallback:", error);
        }
      }
      console.log(`[Worker] Route not found: ${request.method} ${pathname2}`);
      return new Response("404 Page Not Found", { status: 404, headers: { "Content-Type": "text/plain" } });
    } catch (error) {
      console.error("[Worker] Unhandled Error in routing:", error);
      return new Response("Internal Server Error", {
        status: 500,
        headers: { "Content-Type": "text/plain" }
      });
    }
  }
};
export {
  worker_default as default
};
