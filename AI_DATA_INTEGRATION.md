# AI 資料整合改進說明

## 問題描述

AI 可以回答問題，但是：
1. 回答來源是大語言模型（GPT），而不是資料庫中的固定資訊
2. 沒有從新增的地點資料回答正確的回覆

## 已完成的改進

### 1. 改進地點查詢邏輯

**之前：**
- 簡單的 LIKE 查詢
- 只查詢基本欄位（名稱、地址、簡介）

**現在：**
- 更智能的查詢匹配（完全匹配、開頭匹配、包含匹配）
- 查詢完整的地點資訊（電話、網站、評分、營業狀態等）
- 使用 LocationService 獲取詳細資訊
- 按相關性排序結果

### 2. 改進系統提示詞（System Prompt）

**新增重要原則：**
- **優先使用資料庫中的資料**：當使用者詢問地點相關問題時，必須優先使用提供的資料庫地點資訊
- **準確性第一**：如果資料庫中有相關地點資訊，必須使用這些資訊，不要編造或猜測
- **誠實說明**：如果資料庫中沒有相關資訊，才可以使用一般知識，但要明確說明

### 3. 改進用戶提示詞（User Prompt）

**新增內容：**
- 明確標示「資料庫中的地點資訊（必須優先使用這些資訊）」
- 提供完整的地點資訊（名稱、地址、電話、網站、評分、營業狀態、簡介等）
- 明確指示 AI 必須使用資料庫資訊回答
- 區分資料庫資訊和一般知識

### 4. 查詢優化

**改進：**
- 清理查詢字串（移除問句詞彙、空格等）
- 多層級匹配（完全匹配 > 開頭匹配 > 包含匹配）
- 限制結果數量（10 個）
- 按相關性排序

## 測試方法

### 1. 測試地點查詢

**測試查詢：**
- "天后宮的資訊"
- "hasentoINN 的營業時間"
- "查詢 [地點名稱] 的地址"

**預期結果：**
- AI 應該使用資料庫中的地點資訊回答
- 回答應該包含：名稱、地址、電話、網站、評分等
- 回答應該明確標示這是資料庫中的資訊

### 2. 測試一般問題

**測試查詢：**
- "澎湖哪裡可以看夕陽？"
- "澎湖有什麼特色美食？"

**預期結果：**
- 如果資料庫中有相關地點，應該使用資料庫資訊
- 如果沒有，可以使用一般知識，但要明確說明

### 3. 檢查日誌

查看 Cloudflare Workers 日誌，應該看到：
```
[AIService] Searching locations for query: [清理後的查詢]
[AIService] Found locations: [數量]
```

## 資料庫欄位對應

AI 現在會查詢以下地點資訊：
- `name` - 地點名稱
- `address` - 地址
- `phone_number` - 電話
- `website` - 網站
- `google_rating` - Google 評分
- `google_user_ratings_total` - 評價數量
- `business_status` - 營業狀態
- `editorial_summary` - 簡介
- `google_place_id` - Google Place ID

## 未來改進建議

### 1. 更智能的地點識別

- 使用 NLP 技術識別查詢中的地點名稱
- 處理地點名稱的變體（例如：「天后宮」vs「澎湖天后宮」）

### 2. 營業時間查詢

- 如果資料庫中有營業時間資訊，優先使用
- 如果沒有，可以從 Google Places API 獲取

### 3. 距離計算

- 如果使用者提供位置，可以計算距離
- 提供路線建議

### 4. 使用者評價整合

- 整合使用者在地點上的評價和故事
- 提供更豐富的資訊

## 注意事項

1. **資料庫更新**：確保地點資料已正確存入資料庫
2. **查詢準確性**：地點名稱必須與資料庫中的名稱匹配（或部分匹配）
3. **資訊完整性**：如果資料庫中的資訊不完整，AI 可能會補充一般知識

## 除錯

如果 AI 仍然沒有使用資料庫資訊：

1. **檢查日誌**：
   - 查看 `[AIService] Searching locations for query:` 日誌
   - 查看 `[AIService] Found locations:` 日誌

2. **檢查資料庫**：
   - 確認地點已正確存入資料庫
   - 確認地點名稱與查詢匹配

3. **測試查詢**：
   - 直接查詢資料庫確認地點存在
   - 測試查詢字串是否正確匹配
