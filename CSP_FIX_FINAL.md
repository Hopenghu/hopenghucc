# CSP éŒ¯èª¤ä¿®å¾© - æœ€çµ‚ç‰ˆæœ¬

## âœ… å·²å®Œæˆçš„ä¿®å¾©

### 1. ç§»é™¤å…§è¯äº‹ä»¶è™•ç†å™¨ âœ…
- **æ–‡ä»¶**: `src/components/layout.js`
- **ä¿®å¾©**: ç§»é™¤ `onerror` å’Œ `onload` å±¬æ€§
- **æ›¿ä»£**: ä½¿ç”¨ JavaScript `addEventListener`
- **é©—è­‰**: âœ… å·²ç¢ºèªç„¡å…§è¯äº‹ä»¶è™•ç†å™¨

### 2. ç‚º importmap æ·»åŠ  nonce âœ…
- **æ–‡ä»¶**: `src/pages/ItineraryPlanner.js`
- **ä¿®å¾©**: `<script type="importmap" nonce="${nonce}">`
- **é©—è­‰**: âœ… å·²ç¢ºèªæœ‰ nonce

### 3. å°‡ importmap ç§»åˆ° head âœ…
- **æ–‡ä»¶**: `src/pages/ItineraryPlanner.js`
- **ä¿®å¾©**: é€šé `headScripts` åƒæ•¸å°‡ importmap æ”¾åœ¨ `<head>` ä¸­
- **é©—è­‰**: âœ… å·²ç¢ºèªåœ¨ head ä¸­

### 4. æ›´æ–° pageTemplate æ”¯æŒ headScripts âœ…
- **æ–‡ä»¶**: `src/components/layout.js`
- **ä¿®å¾©**: æ·»åŠ  `headScripts` åƒæ•¸
- **é©—è­‰**: âœ… å·²ç¢ºèªåŠŸèƒ½æ­£å¸¸

## ğŸš€ éƒ¨ç½²æ­¥é©Ÿ

### æ­¥é©Ÿ 1: æ¸…é™¤ç·©å­˜ä¸¦é‡æ–°æ§‹å»º
```bash
# æ¸…é™¤æ§‹å»ºæ–‡ä»¶
npm run clean

# é‡æ–°æ§‹å»ºæ‰€æœ‰å…§å®¹
npm run build:all
```

### æ­¥é©Ÿ 2: éƒ¨ç½²åˆ°ç”Ÿç”¢ç’°å¢ƒ
```bash
# éƒ¨ç½²
npm run deploy
```

### æ­¥é©Ÿ 3: é©—è­‰éƒ¨ç½²
1. è¨ªå• `https://www.hopenghu.cc/itinerary`
2. æ‰“é–‹é–‹ç™¼è€…å·¥å…· (F12)
3. æ¸…é™¤ç€è¦½å™¨ç·©å­˜ (Ctrl+Shift+R æˆ– Cmd+Shift+R)
4. æª¢æŸ¥ Console æ˜¯å¦é‚„æœ‰éŒ¯èª¤

## ğŸ” å¦‚æœéŒ¯èª¤ä»ç„¶å­˜åœ¨

### å¯èƒ½åŸå›  1: ç€è¦½å™¨ç·©å­˜
**è§£æ±ºæ–¹æ¡ˆ**:
1. **ç¡¬åˆ·æ–°**: `Ctrl+Shift+R` (Windows/Linux) æˆ– `Cmd+Shift+R` (Mac)
2. **æ¸…é™¤ç·©å­˜**: 
   - Chrome: è¨­ç½® > éš±ç§å’Œå®‰å…¨ > æ¸…é™¤ç€è¦½æ•¸æ“š > ç·©å­˜çš„åœ–ç‰‡å’Œæ–‡ä»¶
   - Firefox: è¨­ç½® > éš±ç§èˆ‡å®‰å…¨ > Cookie å’Œç¶²ç«™æ•¸æ“š > æ¸…é™¤æ•¸æ“š
3. **ç„¡ç—•æ¨¡å¼**: ä½¿ç”¨ç„¡ç—•/éš±ç§æ¨¡å¼æ¸¬è©¦

### å¯èƒ½åŸå›  2: Cloudflare ç·©å­˜
**è§£æ±ºæ–¹æ¡ˆ**:
1. åœ¨ Cloudflare Dashboard ä¸­æ¸…é™¤ç·©å­˜
2. æˆ–ç­‰å¾…ç·©å­˜è‡ªå‹•éæœŸï¼ˆé€šå¸¸å¹¾åˆ†é˜ï¼‰

### å¯èƒ½åŸå›  3: éŒ¯èª¤è¡Œè™Ÿå°æ‡‰å•é¡Œ
**èªªæ˜**: 
- éŒ¯èª¤è¡Œè™Ÿ `itinerary:37` å’Œ `itinerary:86` å¯èƒ½å°æ‡‰**æ¸²æŸ“å¾Œçš„ HTML**ï¼Œè€Œéæºä»£ç¢¼
- é€™äº›è¡Œè™Ÿæœƒå› ç‚º HTML çµæ§‹è®ŠåŒ–è€Œæ”¹è®Š

**æª¢æŸ¥æ–¹æ³•**:
1. åœ¨ç€è¦½å™¨ä¸­ï¼šå³éµ > "æŸ¥çœ‹é é¢æºä»£ç¢¼"
2. æª¢æŸ¥ç¬¬ 37 è¡Œå’Œç¬¬ 86 è¡Œçš„å¯¦éš›å…§å®¹
3. ç¢ºèªæ˜¯å¦æœ‰å•é¡Œ

## ğŸ“‹ é©—è­‰æ¸…å–®

### ä»£ç¢¼æª¢æŸ¥ âœ…
- [x] å·²ç§»é™¤æ‰€æœ‰å…§è¯äº‹ä»¶è™•ç†å™¨ (`onerror`, `onload`)
- [x] å·²ç‚º importmap æ·»åŠ  nonce
- [x] å·²å°‡ importmap ç§»åˆ° `<head>` ä¸­
- [x] æ‰€æœ‰ `<script>` æ¨™ç±¤éƒ½æœ‰ nonce
- [x] å·²æ›´æ–° pageTemplate æ”¯æŒ headScripts

### æ§‹å»ºæª¢æŸ¥
- [ ] å·²åŸ·è¡Œ `npm run build:all`
- [ ] æ§‹å»ºæˆåŠŸç„¡éŒ¯èª¤
- [ ] å·²åŸ·è¡Œ `npm run deploy`

### ç€è¦½å™¨æª¢æŸ¥
- [ ] å·²æ¸…é™¤ç€è¦½å™¨ç·©å­˜
- [ ] å·²ç¡¬åˆ·æ–°é é¢ (Ctrl+Shift+R)
- [ ] å·²åœ¨ç„¡ç—•æ¨¡å¼ä¸‹æ¸¬è©¦
- [ ] Console ä¸­ç„¡ CSP éŒ¯èª¤
- [ ] React æ¨¡çµ„æ­£å¸¸è¼‰å…¥
- [ ] è¡Œç¨‹è¦åŠƒå™¨æ­£å¸¸é‹è¡Œ

## ğŸ¯ é æœŸçµæœ

ä¿®å¾©å¾Œæ‡‰è©²ï¼š
- âœ… **ç„¡ CSP éŒ¯èª¤**: Console ä¸­ä¸æ‡‰è©²æœ‰ CSP ç›¸é—œéŒ¯èª¤
- âœ… **React æ­£å¸¸è¼‰å…¥**: æ¨¡çµ„è§£ææˆåŠŸ
- âœ… **åŠŸèƒ½æ­£å¸¸**: è¡Œç¨‹è¦åŠƒå™¨å¯ä»¥æ­£å¸¸ä½¿ç”¨
- âœ… **ç”¨æˆ¶é ­åƒæ­£å¸¸**: åœ–ç‰‡è¼‰å…¥å’ŒéŒ¯èª¤è™•ç†æ­£å¸¸

## ğŸ“ æŠ€è¡“èªªæ˜

### CSP å’Œ nonce çš„å·¥ä½œåŸç†

1. **nonce çš„ä½œç”¨**:
   - æä¾›æ›´åš´æ ¼çš„å®‰å…¨æ§åˆ¶
   - ç•¶ä½¿ç”¨ nonce æ™‚ï¼Œ`unsafe-inline` æœƒè¢«å¿½ç•¥
   - åªæœ‰å¸¶æœ‰æ­£ç¢º nonce çš„è…³æœ¬æ‰èƒ½åŸ·è¡Œ

2. **importmap çš„è¦æ±‚**:
   - æ‡‰è©²åœ¨ `<head>` ä¸­
   - æ‡‰è©²åœ¨ä»»ä½•ä½¿ç”¨å®ƒçš„ module script ä¹‹å‰
   - æ‡‰è©²æœ‰ nonceï¼ˆæŸäº›ç€è¦½å™¨è¦æ±‚ï¼‰

3. **å…§è¯äº‹ä»¶è™•ç†å™¨**:
   - å³ä½¿æœ‰ nonceï¼Œå…§è¯äº‹ä»¶è™•ç†å™¨ï¼ˆå¦‚ `onclick="..."`ï¼‰ä¹Ÿæœƒè¢«é˜»æ­¢
   - å¿…é ˆä½¿ç”¨ `addEventListener` æ›¿ä»£

## ğŸ”§ å¿«é€Ÿä¿®å¾©å‘½ä»¤

```bash
# å®Œæ•´æµç¨‹
npm run clean && npm run build:all && npm run deploy

# æª¢æŸ¥ä»£ç¢¼
grep -n "onerror\|onload" src/components/layout.js
grep -n "importmap" src/pages/ItineraryPlanner.js

# æª¢æŸ¥æ§‹å»ºç”¢ç‰©
grep -n "importmap" dist/worker.js | head -3
```

## âœ… ç¸½çµ

æ‰€æœ‰ä»£ç¢¼ä¿®å¾©å·²å®Œæˆï¼š
- âœ… ç§»é™¤å…§è¯äº‹ä»¶è™•ç†å™¨
- âœ… ç‚º importmap æ·»åŠ  nonce
- âœ… å°‡ importmap ç§»åˆ° head ä¸­
- âœ… æ›´æ–° pageTemplate æ”¯æŒ headScripts

**ä¸‹ä¸€æ­¥**: 
1. åŸ·è¡Œ `npm run build:all && npm run deploy`
2. æ¸…é™¤ç€è¦½å™¨ç·©å­˜
3. ç¡¬åˆ·æ–°é é¢ (Ctrl+Shift+R)
4. é©—è­‰éŒ¯èª¤æ˜¯å¦æ¶ˆå¤±

å¦‚æœéŒ¯èª¤ä»ç„¶å­˜åœ¨ï¼Œè«‹æä¾›ï¼š
- ç€è¦½å™¨é¡å‹å’Œç‰ˆæœ¬
- å®Œæ•´çš„ Console éŒ¯èª¤è¨Šæ¯
- HTML æºä»£ç¢¼çš„ç¬¬ 37 è¡Œå’Œç¬¬ 86 è¡Œå…§å®¹

