# 🤖 AI 對話功能整合指南

## 📋 已完成的功能

✅ **首頁浮動對話框** - 右下角固定按鈕，點擊展開對話介面  
✅ **基本查詢功能** - 可以查詢澎湖相關資訊  
✅ **資料庫整合** - 儲存對話記錄和學習資料  
✅ **OpenAI API 整合** - 使用 GPT-3.5-turbo 模型  
✅ **地點資料查詢** - 可以查詢建置的地點資料  

## 🚀 部署步驟

### 1. 執行資料庫遷移

```bash
# 執行本地遷移（開發環境）
npm run migrate

# 執行遠端遷移（生產環境）
npm run migrate:remote
```

這會創建以下資料表：
- `ai_conversations` - 儲存對話記錄
- `ai_knowledge_base` - 儲存學習資料
- `ai_feedback` - 儲存使用者反饋

### 2. 確認環境變數

確認 `wrangler.toml` 中已包含 OpenAI API Key：

```toml
[vars]
OPENAI_API_KEY = "sk-proj-..."
```

### 3. 建置和部署

```bash
# 建置專案
npm run build

# 部署到 Cloudflare Workers
npm run deploy
```

## 🎯 功能說明

### 未登入用戶
- ✅ 可以查詢資訊（地點、交通、天氣等）
- ✅ 可以瀏覽現有資訊
- ⚠️ 無法提供新資訊（需要登入）

### 已登入用戶
- ✅ 所有查詢功能
- ✅ 可以提供新資訊
- ✅ 可以修正或補充現有資訊
- ✅ 個人化推薦（未來功能）

## 📝 API 端點

### POST `/api/ai/query`
查詢 AI 助手

**請求：**
```json
{
  "message": "澎湖哪裡可以看夕陽？",
  "sessionId": "session_xxx" // 可選，未登入用戶需要
}
```

**回應：**
```json
{
  "success": true,
  "message": "澎湖有幾個很棒的看夕陽地點...",
  "sessionId": "session_xxx"
}
```

### POST `/api/ai/feedback`
提交反饋

**請求：**
```json
{
  "conversationId": "conv_xxx",
  "feedbackType": "helpful", // helpful, not_helpful, incorrect, suggestion
  "feedbackContent": "這個回答很有幫助"
}
```

### GET `/api/ai/history?sessionId=xxx`
查詢對話歷史

## 🔧 技術架構

### 資料流程
```
使用者輸入 → AI API → AIService → OpenAI API
                ↓
          LocationService (查詢地點資料)
                ↓
          知識庫搜尋
                ↓
          建構上下文
                ↓
          OpenAI 回應
                ↓
          儲存對話記錄
```

### 主要檔案
- `src/services/AIService.js` - AI 服務核心邏輯
- `src/api/ai.js` - AI API 端點處理
- `src/pages/Home.js` - 首頁（包含對話框 UI）
- `migrations/0026_add_ai_system.sql` - 資料庫遷移

## 🎨 UI 說明

### 浮動對話框
- **位置**：右下角固定
- **樣式**：藍色圓形按鈕，帶有對話圖示
- **互動**：點擊展開/收起對話介面

### 對話介面
- **標題列**：顯示 "澎湖 AI 助手"
- **訊息區域**：顯示對話歷史，自動滾動
- **輸入區域**：文字輸入框 + 發送按鈕
- **狀態提示**：顯示登入狀態

## 🔍 查詢範例

### 地點查詢
- "澎湖哪裡可以看夕陽？"
- "有哪些推薦的咖啡廳？"
- "從機場到市區怎麼走？"

### 資訊查詢
- "這個季節適合去哪些景點？"
- "澎湖有什麼特色美食？"
- "澎湖的天氣如何？"

### 地點資料查詢
- "查詢 [地點名稱] 的營業時間"
- "[地點名稱] 的地址是什麼？"
- "有哪些人來過 [地點名稱]？"

## 📊 未來擴展

### 第二階段（建議）
1. **學習機制**
   - 記錄常見問題
   - 優化回答品質
   - 自動更新知識庫

2. **資訊建置**
   - 引導使用者提供新資訊
   - 自動整理和儲存
   - 資訊驗證機制

3. **個人化**
   - 根據使用者足跡推薦
   - 記住使用者偏好
   - 個人化建議

### 第三階段（進階）
1. **多媒體支援**
   - 圖片上傳
   - 地圖整合
   - 語音輸入

2. **資訊驗證**
   - 多使用者確認
   - 管理員審核
   - 可信度評分

3. **進階推薦**
   - 機器學習推薦
   - 協同過濾
   - 情境感知推薦

## ⚠️ 注意事項

1. **API 成本**
   - 使用 GPT-3.5-turbo（成本較低）
   - 監控 API 使用量
   - 考慮快取常見問題

2. **回應時間**
   - OpenAI API 回應時間約 1-3 秒
   - 可以考慮加入載入動畫
   - 未來可以實作快取機制

3. **資料隱私**
   - 對話記錄儲存在資料庫
   - 未登入用戶使用 sessionId 追蹤
   - 已登入用戶關聯到 user_id

## 🐛 故障排除

### AI 無法回應
1. 檢查 OpenAI API Key 是否正確
2. 檢查網路連線
3. 查看 Cloudflare Workers 日誌

### 對話記錄未儲存
1. 確認資料庫遷移已執行
2. 檢查資料庫連線
3. 查看錯誤日誌

### 地點資料查詢失敗
1. 確認 LocationService 已初始化
2. 檢查地點資料是否存在
3. 查看 API 回應

## 📞 支援

如有問題，請查看：
- Cloudflare Workers 日誌
- 瀏覽器開發者工具 Console
- 資料庫查詢日誌

---

**最後更新：2025-01-19**  
**版本：1.0.0 (MVP)**
