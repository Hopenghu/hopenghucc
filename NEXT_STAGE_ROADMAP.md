# 下階段執行計劃

## 已完成的工作

### ✅ 階段 1：AI 問問題系統基礎架構

1. **資料庫擴展**
   - ✅ 擴展 users 表（使用者類型）
   - ✅ 擴展 locations 表（營業時間、商家類型）
   - ✅ 建立 merchant_products 表（商家產品資訊）
   - ✅ 建立 travel_memories 表（旅遊回憶）
   - ✅ 建立 location_distances 表（距離快取）
   - ✅ 建立 ai_conversation_states 表（對話狀態）
   - ✅ 建立 fixed_information 表（固定資訊記錄）

2. **核心服務**
   - ✅ AIQuestioningService（問問題邏輯）
   - ✅ DistanceService（距離計算）
   - ✅ 整合到 AIService

3. **AI 改進**
   - ✅ 改進提示詞（嚴格禁止編造地點）
   - ✅ 地理資訊驗證指示
   - ✅ 支援問問題流程

## 下階段要完成的事項

### 階段 2：完善問問題邏輯（優先）

#### 2.1 改進地點名稱匹配

**問題**：目前使用簡單的 LIKE 查詢，可能無法準確匹配

**改進方案**：
1. 使用更智能的地點名稱識別
2. 處理地點名稱的變體（例如：「天后宮」vs「澎湖天后宮」）
3. 當找不到地點時，詢問使用者是否要建立新地點

**實作**：
- 改進 `AIQuestioningService.getLocationContext()` 方法
- 加入模糊匹配和相似度計算
- 當找不到時，提供建立新地點的選項

#### 2.2 改進資訊提取

**問題**：目前使用簡單的正則表達式提取資訊

**改進方案**：
1. 使用 AI 協助提取結構化資訊
2. 更準確地識別價格、時間、日期等
3. 處理多種表達方式

**實作**：
- 改進 `extractStructuredInfo()` 方法
- 使用 GPT/Gemini 協助解析使用者回答
- 建立更完善的提取規則

#### 2.3 改進問問題流程

**問題**：目前流程較為固定，缺乏彈性

**改進方案**：
1. 允許使用者跳過問題
2. 允許使用者修改之前的回答
3. 根據使用者回答動態調整問題

**實作**：
- 加入「跳過」和「修改」指令處理
- 改進問題生成邏輯
- 加入進度指示

### 階段 3：整合固定資訊到 AI 回答（核心）

#### 3.1 查詢固定資訊

**功能**：當使用者詢問時，從資料庫查詢固定資訊

**實作**：
- 查詢 `merchant_products` 表（產品價格、消費時間）
- 查詢 `location_distances` 表（距離時間）
- 查詢 `locations.opening_hours`（營業時間）
- 整合到 AI 回答中

#### 3.2 距離查詢整合

**功能**：當使用者詢問距離時，自動計算並回答

**實作**：
- 改進地點識別邏輯
- 自動呼叫 Distance Matrix API
- 將結果整合到 AI 回答

**範例查詢**：
- "從天后宮到機場的距離"
- "從 A 到 B 要多久"
- "A 和 B 之間的距離"

#### 3.3 產品資訊查詢

**功能**：當使用者詢問商家產品時，從資料庫查詢

**實作**：
- 查詢 `merchant_products` 表
- 顯示產品名稱、價格、消費時間
- 整合到 AI 回答

**範例查詢**：
- "[商家名稱] 的產品有哪些？"
- "[產品名稱] 的價格是多少？"
- "[產品名稱] 需要多久時間？"

### 階段 4：前端改進（體驗）

#### 4.1 問問題 UI 改進

**功能**：顯示問問題的進度和狀態

**實作**：
- 顯示當前問題
- 顯示進度指示（例如：步驟 2/5）
- 提供「跳過」和「完成」按鈕

#### 4.2 結構化輸入

**功能**：對於固定資訊（價格、時間），提供結構化輸入

**實作**：
- 價格輸入：數字輸入框 + 單位選擇
- 時間輸入：時間選擇器或數字輸入
- 日期輸入：日期選擇器

### 階段 5：知識庫系統升級（未來）

#### 5.1 向量搜尋

**功能**：使用 embedding 進行語義搜尋

**實作**：
- 為知識庫項目建立 embedding
- 使用向量搜尋找到相關知識
- 整合到 AI 回答

#### 5.2 貢獻系統

**功能**：讓使用者可以貢獻和驗證知識

**實作**：
- 建立貢獻記錄
- 多人驗證機制
- 知識可信度評分

## 立即需要處理的問題

### 問題 1：前端 JavaScript 錯誤

**錯誤**：`Cannot access 'userMessage2' before initialization`

**可能原因**：
- 模板字串中的變數作用域問題
- 非同步操作導致的變數存取問題

**解決方案**：
1. 檢查前端程式碼中的變數宣告
2. 確保所有變數在使用前已初始化
3. 改進錯誤處理機制

### 問題 2：AI 回答錯誤的地理資訊

**錯誤**：推薦了「赤崁樓」在澎湖（實際在台南）

**已改進**：
- ✅ 加入嚴格的地理資訊驗證指示
- ✅ 禁止編造地點資訊
- ✅ 明確說明資料庫中沒有資訊時的回應

**需要持續監控**：
- 觀察 AI 回答是否仍有錯誤
- 收集錯誤案例並改進

## 測試計劃

### 測試 1：商家問問題流程

1. 登入並 claim 一個地點
2. 詢問：「我想提供商家資訊」
3. 按照 AI 的問題回答：
   - 商家類型
   - 營業時間
   - 產品名稱
   - 產品價格
   - 消費時間
4. 確認資訊是否正確儲存

### 測試 2：旅客問問題流程

1. 未登入或登入但未 claim 地點
2. 詢問：「我想分享回憶」
3. 按照 AI 的問題回答：
   - 地點名稱
   - 回憶內容
   - 同行人員
   - 造訪日期
   - 是否想再去
4. 確認回憶是否正確儲存

### 測試 3：距離查詢

1. 確保資料庫中有至少兩個地點
2. 詢問：「從 [地點A] 到 [地點B] 的距離」
3. 確認 AI 計算並回答距離和時間
4. 確認距離資訊是否快取

### 測試 4：固定資訊查詢

1. 先透過問問題流程建立商家產品資訊
2. 詢問：「[商家名稱] 的產品有哪些？」
3. 確認 AI 從資料庫查詢並回答
4. 詢問：「[產品名稱] 的價格是多少？」
5. 確認 AI 從資料庫查詢並回答

## 資料庫檢查清單

### 已建立的資料表

- ✅ `merchant_products` - 商家產品
- ✅ `travel_memories` - 旅遊回憶
- ✅ `location_distances` - 距離快取
- ✅ `ai_conversation_states` - 對話狀態
- ✅ `fixed_information` - 固定資訊記錄

### 已擴展的資料表

- ✅ `users` - 加入 user_type, is_merchant
- ✅ `locations` - 加入 opening_hours, business_type, is_merchant

### 資料庫設計確認

**沒有問題**：所有必要的欄位和資料表都已建立，支援：
- 商家固定資訊（產品、價格、時間、營業時間）
- 旅客感覺資訊（回憶、感受、未來計劃）
- 距離時間計算（整合 Google Maps API）
- 對話狀態追蹤（問問題進度）

## Google Maps API 確認

### 已確認
- ✅ Distance Matrix API 已啟用
- ✅ API Key 已配置
- ✅ 整合到 DistanceService

### API 使用方式

**端點**：`https://maps.googleapis.com/maps/api/distancematrix/json`

**參數**：
- `origins`: 起點座標（緯度,經度）
- `destinations`: 終點座標（緯度,經度）
- `mode`: 交通方式（driving, walking, bicycling, transit）
- `language`: 語言（zh-TW）
- `key`: API Key

**回應格式**：
```json
{
  "rows": [{
    "elements": [{
      "distance": { "text": "5.2 公里", "value": 5200 },
      "duration": { "text": "15 分鐘", "value": 900 },
      "status": "OK"
    }]
  }]
}
```

## 下一步行動

### 立即執行

1. **測試問問題系統**
   - 測試商家流程
   - 測試旅客流程
   - 測試距離查詢

2. **監控 AI 回答**
   - 檢查是否還有錯誤的地理資訊
   - 收集使用者反饋

3. **改進問問題邏輯**
   - 根據測試結果調整問題流程
   - 改進資訊提取準確性

### 短期（1-2 週）

1. **完善固定資訊查詢**
   - 實作產品資訊查詢
   - 實作營業時間查詢
   - 整合到 AI 回答

2. **改進地點名稱匹配**
   - 更智能的地點識別
   - 處理地點名稱變體

3. **前端 UI 改進**
   - 問問題進度指示
   - 結構化輸入

### 中期（1 個月）

1. **知識庫系統升級**
   - 向量搜尋
   - 貢獻系統
   - 驗證機制

2. **進階功能**
   - 圖片識別（Gemini）
   - 更智能的模型選擇
   - 個人化推薦

## 系統架構總結

```
使用者查詢
    ↓
AIService.handleQuery()
    ↓
AIQuestioningService.analyzeQuery()  ← 判斷是否需要問問題
    ↓
DistanceService (如果需要計算距離)
    ↓
AIQuestioningService.generateQuestion()  ← 生成問題
    ↓
AIQuestioningService.extractStructuredInfo()  ← 提取資訊
    ↓
儲存到資料庫
    ├── merchant_products (商家產品)
    ├── travel_memories (旅遊回憶)
    ├── location_distances (距離快取)
    └── fixed_information (固定資訊記錄)
    ↓
AI 回答（包含問題或資訊）
```

## 成功指標

1. **問問題流程完成率**：使用者完成問問題流程的比例
2. **資訊準確性**：收集到的固定資訊是否準確
3. **AI 回答準確性**：AI 是否正確使用資料庫資訊
4. **距離查詢成功率**：距離查詢的成功率
5. **使用者滿意度**：使用者對問問題流程的滿意度
